(function(glob){var version="0.3.4",has="hasOwnProperty",separator=/[\.\/]/,wildcard="*",fun=function(){},numsort=function(a,b){return a-b;},current_event,stop,events={n:{}},eve=function(name,scope){var e=events,oldstop=stop,args=Array.prototype.slice.call(arguments,2),listeners=eve.listeners(name),z=0,f=false,l,indexed=[],queue={},out=[],ce=current_event,errors=[];current_event=name;stop=0;for(var i=0,ii=listeners.length;i<ii;i++)if("zIndex"in listeners[i]){indexed.push(listeners[i].zIndex);if(listeners[i].zIndex<0){queue[listeners[i].zIndex]=listeners[i];}}
indexed.sort(numsort);while(indexed[z]<0){l=queue[indexed[z++]];out.push(l.apply(scope,args));if(stop){stop=oldstop;return out;}}
for(i=0;i<ii;i++){l=listeners[i];if("zIndex"in l){if(l.zIndex==indexed[z]){out.push(l.apply(scope,args));if(stop){break;}
do{z++;l=queue[indexed[z]];l&&out.push(l.apply(scope,args));if(stop){break;}}while(l)}else{queue[l.zIndex]=l;}}else{out.push(l.apply(scope,args));if(stop){break;}}}
stop=oldstop;current_event=ce;return out.length?out:null;};eve.listeners=function(name){var names=name.split(separator),e=events,item,items,k,i,ii,j,jj,nes,es=[e],out=[];for(i=0,ii=names.length;i<ii;i++){nes=[];for(j=0,jj=es.length;j<jj;j++){e=es[j].n;items=[e[names[i]],e[wildcard]];k=2;while(k--){item=items[k];if(item){nes.push(item);out=out.concat(item.f||[]);}}}
es=nes;}
return out;};eve.on=function(name,f){var names=name.split(separator),e=events;for(var i=0,ii=names.length;i<ii;i++){e=e.n;!e[names[i]]&&(e[names[i]]={n:{}});e=e[names[i]];}
e.f=e.f||[];for(i=0,ii=e.f.length;i<ii;i++)if(e.f[i]==f){return fun;}
e.f.push(f);return function(zIndex){if(+zIndex==+zIndex){f.zIndex=+zIndex;}};};eve.stop=function(){stop=1;};eve.nt=function(subname){if(subname){return new RegExp("(?:\\.|\\/|^)"+subname+"(?:\\.|\\/|$)").test(current_event);}
return current_event;};eve.off=eve.unbind=function(name,f){var names=name.split(separator),e,key,splice,i,ii,j,jj,cur=[events];for(i=0,ii=names.length;i<ii;i++){for(j=0;j<cur.length;j+=splice.length-2){splice=[j,1];e=cur[j].n;if(names[i]!=wildcard){if(e[names[i]]){splice.push(e[names[i]]);}}else{for(key in e)if(e[has](key)){splice.push(e[key]);}}
cur.splice.apply(cur,splice);}}
for(i=0,ii=cur.length;i<ii;i++){e=cur[i];while(e.n){if(f){if(e.f){for(j=0,jj=e.f.length;j<jj;j++)if(e.f[j]==f){e.f.splice(j,1);break;}
!e.f.length&&delete e.f;}
for(key in e.n)if(e.n[has](key)&&e.n[key].f){var funcs=e.n[key].f;for(j=0,jj=funcs.length;j<jj;j++)if(funcs[j]==f){funcs.splice(j,1);break;}
!funcs.length&&delete e.n[key].f;}}else{delete e.f;for(key in e.n)if(e.n[has](key)&&e.n[key].f){delete e.n[key].f;}}
e=e.n;}}};eve.once=function(name,f){var f2=function(){var res=f.apply(this,arguments);eve.unbind(name,f2);return res;};return eve.on(name,f2);};eve.version=version;eve.toString=function(){return"You are running Eve "+version;};(typeof module!="undefined"&&module.exports)?(module.exports=eve):(typeof define!="undefined"?(define("eve",[],function(){return eve;})):(glob.eve=eve));})(this);(function(){function R(first){if(R.is(first,"function")){return loaded?first():eve.on("DOMload",first);}else if(R.is(first,array)){return R._engine.create[apply](R,first.splice(0,3+R.is(first[0],nu))).add(first);}else{var args=Array.prototype.slice.call(arguments,0);if(R.is(args[args.length-1],"function")){var f=args.pop();return loaded?f.call(R._engine.create[apply](R,args)):eve.on("DOMload",function(){f.call(R._engine.create[apply](R,args));});}else{return R._engine.create[apply](R,arguments);}}}
R.version="2.0.2";R.eve=eve;var loaded,separator=/[, ]+/,elements={circle:1,rect:1,path:1,ellipse:1,text:1,image:1},formatrg=/\{(\d+)\}/g,proto="prototype",has="hasOwnProperty",g={doc:document,win:window},oldRaphael={was:Object.prototype[has].call(g.win,"Raphael"),is:g.win.Raphael},Paper=function(){this.ca=this.customAttributes={};},paperproto,appendChild="appendChild",apply="apply",concat="concat",supportsTouch="createTouch"in g.doc,E="",S=" ",Str=String,split="split",events="click dblclick mousedown mousemove mouseout mouseover mouseup touchstart touchmove touchend touchcancel"[split](S),touchMap={mousedown:"touchstart",mousemove:"touchmove",mouseup:"touchend"},lowerCase=Str.prototype.toLowerCase,math=Math,mmax=math.max,mmin=math.min,abs=math.abs,pow=math.pow,PI=math.PI,nu="number",string="string",array="array",toString="toString",fillString="fill",objectToString=Object.prototype.toString,paper={},push="push",ISURL=R._ISURL=/^url\(['"]?([^\)]+?)['"]?\)$/i,colourRegExp=/^\s*((#[a-f\d]{6})|(#[a-f\d]{3})|rgba?\(\s*([\d\.]+%?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+%?(?:\s*,\s*[\d\.]+%?)?)\s*\)|hsba?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\)|hsla?\(\s*([\d\.]+(?:deg|\xb0|%)?\s*,\s*[\d\.]+%?\s*,\s*[\d\.]+(?:%?\s*,\s*[\d\.]+)?)%?\s*\))\s*$/i,isnan={"NaN":1,"Infinity":1,"-Infinity":1},bezierrg=/^(?:cubic-)?bezier\(([^,]+),([^,]+),([^,]+),([^\)]+)\)/,round=math.round,setAttribute="setAttribute",toFloat=parseFloat,toInt=parseInt,upperCase=Str.prototype.toUpperCase,availableAttrs=R._availableAttrs={"arrow-end":"none","arrow-start":"none",blur:0,"clip-rect":"0 0 1e9 1e9",cursor:"default",cx:0,cy:0,fill:"#fff","fill-opacity":1,font:'10px "Arial"',"font-family":'"Arial"',"font-size":"10","font-style":"normal","font-weight":400,gradient:0,height:0,href:"http://raphaeljs.com/","letter-spacing":0,opacity:1,path:"M0,0",r:0,rx:0,ry:0,src:"",stroke:"#000","stroke-dasharray":"","stroke-linecap":"butt","stroke-linejoin":"butt","stroke-miterlimit":0,"stroke-opacity":1,"stroke-width":1,target:"_blank","text-anchor":"middle",title:"Raphael",transform:"",width:0,x:0,y:0},availableAnimAttrs=R._availableAnimAttrs={blur:nu,"clip-rect":"csv",cx:nu,cy:nu,fill:"colour","fill-opacity":nu,"font-size":nu,height:nu,opacity:nu,path:"path",r:nu,rx:nu,ry:nu,stroke:"colour","stroke-opacity":nu,"stroke-width":nu,transform:"transform",width:nu,x:nu,y:nu},whitespace=/[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]/g,commaSpaces=/[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/,hsrg={hs:1,rg:1},p2s=/,?([achlmqrstvxz]),?/gi,pathCommand=/([achlmrqstvz])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/ig,tCommand=/([rstm])[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029,]*((-?\d*\.?\d*(?:e[\-+]?\d+)?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*)+)/ig,pathValues=/(-?\d*\.?\d*(?:e[\-+]?\d+)?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,?[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*/ig,radial_gradient=R._radial_gradient=/^r(?:\(([^,]+?)[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*,[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029]*([^\)]+?)\))?/,eldata={},sortByKey=function(a,b){return a.key-b.key;},sortByNumber=function(a,b){return toFloat(a)-toFloat(b);},fun=function(){},pipe=function(x){return x;},rectPath=R._rectPath=function(x,y,w,h,r){if(r){return[["M",x+r,y],["l",w-r*2,0],["a",r,r,0,0,1,r,r],["l",0,h-r*2],["a",r,r,0,0,1,-r,r],["l",r*2-w,0],["a",r,r,0,0,1,-r,-r],["l",0,r*2-h],["a",r,r,0,0,1,r,-r],["z"]];}
return[["M",x,y],["l",w,0],["l",0,h],["l",-w,0],["z"]];},ellipsePath=function(x,y,rx,ry){if(ry==null){ry=rx;}
return[["M",x,y],["m",0,-ry],["a",rx,ry,0,1,1,0,2*ry],["a",rx,ry,0,1,1,0,-2*ry],["z"]];},getPath=R._getPath={path:function(el){return el.attr("path");},circle:function(el){var a=el.attrs;return ellipsePath(a.cx,a.cy,a.r);},ellipse:function(el){var a=el.attrs;return ellipsePath(a.cx,a.cy,a.rx,a.ry);},rect:function(el){var a=el.attrs;return rectPath(a.x,a.y,a.width,a.height,a.r);},image:function(el){var a=el.attrs;return rectPath(a.x,a.y,a.width,a.height);},text:function(el){var bbox=el._getBBox();return rectPath(bbox.x,bbox.y,bbox.width,bbox.height);}},mapPath=R.mapPath=function(path,matrix){if(!matrix){return path;}
var x,y,i,j,ii,jj,pathi;path=path2curve(path);for(i=0,ii=path.length;i<ii;i++){pathi=path[i];for(j=1,jj=pathi.length;j<jj;j+=2){x=matrix.x(pathi[j],pathi[j+1]);y=matrix.y(pathi[j],pathi[j+1]);pathi[j]=x;pathi[j+1]=y;}}
return path;};R._g=g;R.type=(g.win.SVGAngle||g.doc.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")?"SVG":"VML");if(R.type=="VML"){var d=g.doc.createElement("div"),b;d.innerHTML='<v:shape adj="1"/>';b=d.firstChild;b.style.behavior="url(#default#VML)";if(!(b&&typeof b.adj=="object")){return(R.type=E);}
d=null;}
R.svg=!(R.vml=R.type=="VML");R._Paper=Paper;R.fn=paperproto=Paper.prototype=R.prototype;R._id=0;R._oid=0;R.is=function(o,type){type=lowerCase.call(type);if(type=="finite"){return!isnan[has](+o);}
if(type=="array"){return o instanceof Array;}
return(type=="null"&&o===null)||(type==typeof o&&o!==null)||(type=="object"&&o===Object(o))||(type=="array"&&Array.isArray&&Array.isArray(o))||objectToString.call(o).slice(8,-1).toLowerCase()==type;};R.angle=function(x1,y1,x2,y2,x3,y3){if(x3==null){var x=x1-x2,y=y1-y2;if(!x&&!y){return 0;}
return(180+math.atan2(-y,-x)*180/PI+360)%360;}else{return R.angle(x1,y1,x3,y3)-R.angle(x2,y2,x3,y3);}};R.rad=function(deg){return deg%360*PI/180;};R.deg=function(rad){return rad*180/PI%360;};R.snapTo=function(values,value,tolerance){tolerance=R.is(tolerance,"finite")?tolerance:10;if(R.is(values,array)){var i=values.length;while(i--)if(abs(values[i]-value)<=tolerance){return values[i];}}else{values=+values;var rem=value%values;if(rem<tolerance){return value-rem;}
if(rem>values-tolerance){return value-rem+values;}}
return value;};var createUUID=R.createUUID=(function(uuidRegEx,uuidReplacer){return function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(uuidRegEx,uuidReplacer).toUpperCase();};})(/[xy]/g,function(c){var r=math.random()*16|0,v=c=="x"?r:(r&3|8);return v.toString(16);});R.setWindow=function(newwin){eve("setWindow",R,g.win,newwin);g.win=newwin;g.doc=g.win.document;if(R._engine.initWin){R._engine.initWin(g.win);}};var toHex=function(color){if(R.vml){var trim=/^\s+|\s+$/g;var bod;try{var docum=new ActiveXObject("htmlfile");docum.write("<body>");docum.close();bod=docum.body;}catch(e){bod=createPopup().document.body;}
var range=bod.createTextRange();toHex=cacher(function(color){try{bod.style.color=Str(color).replace(trim,E);var value=range.queryCommandValue("ForeColor");value=((value&255)<<16)|(value&65280)|((value&16711680)>>>16);return"#"+("000000"+value.toString(16)).slice(-6);}catch(e){return"none";}});}else{var i=g.doc.createElement("i");i.title="Rapha\xebl Colour Picker";i.style.display="none";g.doc.body.appendChild(i);toHex=cacher(function(color){i.style.color=color;return g.doc.defaultView.getComputedStyle(i,E).getPropertyValue("color");});}
return toHex(color);},hsbtoString=function(){return"hsb("+[this.h,this.s,this.b]+")";},hsltoString=function(){return"hsl("+[this.h,this.s,this.l]+")";},rgbtoString=function(){return this.hex;},prepareRGB=function(r,g,b){if(g==null&&R.is(r,"object")&&"r"in r&&"g"in r&&"b"in r){b=r.b;g=r.g;r=r.r;}
if(g==null&&R.is(r,string)){var clr=R.getRGB(r);r=clr.r;g=clr.g;b=clr.b;}
if(r>1||g>1||b>1){r/=255;g/=255;b/=255;}
return[r,g,b];},packageRGB=function(r,g,b,o){r*=255;g*=255;b*=255;var rgb={r:r,g:g,b:b,hex:R.rgb(r,g,b),toString:rgbtoString};R.is(o,"finite")&&(rgb.opacity=o);return rgb;};R.color=function(clr){var rgb;if(R.is(clr,"object")&&"h"in clr&&"s"in clr&&"b"in clr){rgb=R.hsb2rgb(clr);clr.r=rgb.r;clr.g=rgb.g;clr.b=rgb.b;clr.hex=rgb.hex;}else if(R.is(clr,"object")&&"h"in clr&&"s"in clr&&"l"in clr){rgb=R.hsl2rgb(clr);clr.r=rgb.r;clr.g=rgb.g;clr.b=rgb.b;clr.hex=rgb.hex;}else{if(R.is(clr,"string")){clr=R.getRGB(clr);}
if(R.is(clr,"object")&&"r"in clr&&"g"in clr&&"b"in clr){rgb=R.rgb2hsl(clr);clr.h=rgb.h;clr.s=rgb.s;clr.l=rgb.l;rgb=R.rgb2hsb(clr);clr.v=rgb.b;}else{clr={hex:"none"};clr.r=clr.g=clr.b=clr.h=clr.s=clr.v=clr.l=-1;}}
clr.toString=rgbtoString;return clr;};R.hsb2rgb=function(h,s,v,o){if(this.is(h,"object")&&"h"in h&&"s"in h&&"b"in h){v=h.b;s=h.s;h=h.h;o=h.o;}
h*=360;var R,G,B,X,C;h=(h%360)/60;C=v*s;X=C*(1-abs(h%2-1));R=G=B=v-C;h=~~h;R+=[C,X,0,0,X,C][h];G+=[X,C,C,X,0,0][h];B+=[0,0,X,C,C,X][h];return packageRGB(R,G,B,o);};R.hsl2rgb=function(h,s,l,o){if(this.is(h,"object")&&"h"in h&&"s"in h&&"l"in h){l=h.l;s=h.s;h=h.h;}
if(h>1||s>1||l>1){h/=360;s/=100;l/=100;}
h*=360;var R,G,B,X,C;h=(h%360)/60;C=2*s*(l<.5?l:1-l);X=C*(1-abs(h%2-1));R=G=B=l-C/2;h=~~h;R+=[C,X,0,0,X,C][h];G+=[X,C,C,X,0,0][h];B+=[0,0,X,C,C,X][h];return packageRGB(R,G,B,o);};R.rgb2hsb=function(r,g,b){b=prepareRGB(r,g,b);r=b[0];g=b[1];b=b[2];var H,S,V,C;V=mmax(r,g,b);C=V-mmin(r,g,b);H=(C==0?null:V==r?(g-b)/C:V==g?(b-r)/C+2:(r-g)/C+4);H=((H+360)%6)*60/360;S=C==0?0:C/V;return{h:H,s:S,b:V,toString:hsbtoString};};R.rgb2hsl=function(r,g,b){b=prepareRGB(r,g,b);r=b[0];g=b[1];b=b[2];var H,S,L,M,m,C;M=mmax(r,g,b);m=mmin(r,g,b);C=M-m;H=(C==0?null:M==r?(g-b)/C:M==g?(b-r)/C+2:(r-g)/C+4);H=((H+360)%6)*60/360;L=(M+m)/2;S=(C==0?0:L<.5?C/(2*L):C/(2-2*L));return{h:H,s:S,l:L,toString:hsltoString};};R._path2string=function(){return this.join(",").replace(p2s,"$1");};function repush(array,item){for(var i=0,ii=array.length;i<ii;i++)if(array[i]===item){return array.push(array.splice(i,1)[0]);}}
function cacher(f,scope,postprocessor){function newf(){var arg=Array.prototype.slice.call(arguments,0),args=arg.join("\u2400"),cache=newf.cache=newf.cache||{},count=newf.count=newf.count||[];if(cache[has](args)){repush(count,args);return postprocessor?postprocessor(cache[args]):cache[args];}
count.length>=1e3&&delete cache[count.shift()];count.push(args);cache[args]=f[apply](scope,arg);return postprocessor?postprocessor(cache[args]):cache[args];}
return newf;}
var preload=R._preload=function(src,f){var img=g.doc.createElement("img");img.style.cssText="position:absolute;left:-9999em;top:-9999em";img.onload=function(){f.call(this);this.onload=null;g.doc.body.removeChild(this);};img.onerror=function(){g.doc.body.removeChild(this);};g.doc.body.appendChild(img);img.src=src;};function clrToString(){return this.hex;}
R.getRGB=cacher(function(colour){if(!colour||!!((colour=Str(colour)).indexOf("-")+1)){return{r:-1,g:-1,b:-1,hex:"none",error:1,toString:clrToString};}
if(colour=="none"){return{r:-1,g:-1,b:-1,hex:"none",toString:clrToString};}
!(hsrg[has](colour.toLowerCase().substring(0,2))||colour.charAt()=="#")&&(colour=toHex(colour));var res,red,green,blue,opacity,t,values,rgb=colour.match(colourRegExp);if(rgb){if(rgb[2]){blue=toInt(rgb[2].substring(5),16);green=toInt(rgb[2].substring(3,5),16);red=toInt(rgb[2].substring(1,3),16);}
if(rgb[3]){blue=toInt((t=rgb[3].charAt(3))+t,16);green=toInt((t=rgb[3].charAt(2))+t,16);red=toInt((t=rgb[3].charAt(1))+t,16);}
if(rgb[4]){values=rgb[4][split](commaSpaces);red=toFloat(values[0]);values[0].slice(-1)=="%"&&(red*=2.55);green=toFloat(values[1]);values[1].slice(-1)=="%"&&(green*=2.55);blue=toFloat(values[2]);values[2].slice(-1)=="%"&&(blue*=2.55);rgb[1].toLowerCase().slice(0,4)=="rgba"&&(opacity=toFloat(values[3]));values[3]&&values[3].slice(-1)=="%"&&(opacity/=100);}
if(rgb[5]){values=rgb[5][split](commaSpaces);red=toFloat(values[0]);values[0].slice(-1)=="%"&&(red*=2.55);green=toFloat(values[1]);values[1].slice(-1)=="%"&&(green*=2.55);blue=toFloat(values[2]);values[2].slice(-1)=="%"&&(blue*=2.55);(values[0].slice(-3)=="deg"||values[0].slice(-1)=="\xb0")&&(red/=360);rgb[1].toLowerCase().slice(0,4)=="hsba"&&(opacity=toFloat(values[3]));values[3]&&values[3].slice(-1)=="%"&&(opacity/=100);return R.hsb2rgb(red,green,blue,opacity);}
if(rgb[6]){values=rgb[6][split](commaSpaces);red=toFloat(values[0]);values[0].slice(-1)=="%"&&(red*=2.55);green=toFloat(values[1]);values[1].slice(-1)=="%"&&(green*=2.55);blue=toFloat(values[2]);values[2].slice(-1)=="%"&&(blue*=2.55);(values[0].slice(-3)=="deg"||values[0].slice(-1)=="\xb0")&&(red/=360);rgb[1].toLowerCase().slice(0,4)=="hsla"&&(opacity=toFloat(values[3]));values[3]&&values[3].slice(-1)=="%"&&(opacity/=100);return R.hsl2rgb(red,green,blue,opacity);}
rgb={r:red,g:green,b:blue,toString:clrToString};rgb.hex="#"+(16777216|blue|(green<<8)|(red<<16)).toString(16).slice(1);R.is(opacity,"finite")&&(rgb.opacity=opacity);return rgb;}
return{r:-1,g:-1,b:-1,hex:"none",error:1,toString:clrToString};},R);R.hsb=cacher(function(h,s,b){return R.hsb2rgb(h,s,b).hex;});R.hsl=cacher(function(h,s,l){return R.hsl2rgb(h,s,l).hex;});R.rgb=cacher(function(r,g,b){return"#"+(16777216|b|(g<<8)|(r<<16)).toString(16).slice(1);});R.getColor=function(value){var start=this.getColor.start=this.getColor.start||{h:0,s:1,b:value||.75},rgb=this.hsb2rgb(start.h,start.s,start.b);start.h+=.075;if(start.h>1){start.h=0;start.s-=.2;start.s<=0&&(this.getColor.start={h:0,s:1,b:start.b});}
return rgb.hex;};R.getColor.reset=function(){delete this.start;};function catmullRom2bezier(crp,z){var d=[];for(var i=0,iLen=crp.length;iLen-2*!z>i;i+=2){var p=[{x:+crp[i-2],y:+crp[i-1]},{x:+crp[i],y:+crp[i+1]},{x:+crp[i+2],y:+crp[i+3]},{x:+crp[i+4],y:+crp[i+5]}];if(z){if(!i){p[0]={x:+crp[iLen-2],y:+crp[iLen-1]};}else if(iLen-4==i){p[3]={x:+crp[0],y:+crp[1]};}else if(iLen-2==i){p[2]={x:+crp[0],y:+crp[1]};p[3]={x:+crp[2],y:+crp[3]};}}else{if(iLen-4==i){p[3]=p[2];}else if(!i){p[0]={x:+crp[i],y:+crp[i+1]};}}
d.push(["C",(-p[0].x+6*p[1].x+p[2].x)/6,(-p[0].y+6*p[1].y+p[2].y)/6,(p[1].x+6*p[2].x-p[3].x)/6,(p[1].y+6*p[2].y-p[3].y)/6,p[2].x,p[2].y]);}
return d;}
R.parsePathString=cacher(function(pathString){if(!pathString){return null;}
var paramCounts={a:7,c:6,h:1,l:2,m:2,r:4,q:4,s:4,t:2,v:1,z:0},data=[];if(R.is(pathString,array)&&R.is(pathString[0],array)){data=pathClone(pathString);}
if(!data.length){Str(pathString).replace(pathCommand,function(a,b,c){var params=[],name=b.toLowerCase();c.replace(pathValues,function(a,b){b&&params.push(+b);});if(name=="m"&&params.length>2){data.push([b][concat](params.splice(0,2)));name="l";b=b=="m"?"l":"L";}
if(name=="r"){data.push([b][concat](params));}else while(params.length>=paramCounts[name]){data.push([b][concat](params.splice(0,paramCounts[name])));if(!paramCounts[name]){break;}}});}
data.toString=R._path2string;return data;});R.parseTransformString=cacher(function(TString){if(!TString){return null;}
var paramCounts={r:3,s:4,t:2,m:6},data=[];if(R.is(TString,array)&&R.is(TString[0],array)){data=pathClone(TString);}
if(!data.length){Str(TString).replace(tCommand,function(a,b,c){var params=[],name=lowerCase.call(b);c.replace(pathValues,function(a,b){b&&params.push(+b);});data.push([b][concat](params));});}
data.toString=R._path2string;return data;});R.findDotsAtSegment=function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t){var t1=1-t,t13=pow(t1,3),t12=pow(t1,2),t2=t*t,t3=t2*t,x=t13*p1x+t12*3*t*c1x+t1*3*t*t*c2x+t3*p2x,y=t13*p1y+t12*3*t*c1y+t1*3*t*t*c2y+t3*p2y,mx=p1x+2*t*(c1x-p1x)+t2*(c2x-2*c1x+p1x),my=p1y+2*t*(c1y-p1y)+t2*(c2y-2*c1y+p1y),nx=c1x+2*t*(c2x-c1x)+t2*(p2x-2*c2x+c1x),ny=c1y+2*t*(c2y-c1y)+t2*(p2y-2*c2y+c1y),ax=t1*p1x+t*c1x,ay=t1*p1y+t*c1y,cx=t1*c2x+t*p2x,cy=t1*c2y+t*p2y,alpha=(90-math.atan2(mx-nx,my-ny)*180/PI);(mx>nx||my<ny)&&(alpha+=180);return{x:x,y:y,m:{x:mx,y:my},n:{x:nx,y:ny},start:{x:ax,y:ay},end:{x:cx,y:cy},alpha:alpha};};R._removedFactory=function(methodname){return function(){throw new Error("Rapha\xebl: you are calling to method \u201c"+methodname+"\u201d of removed object");};};var pathDimensions=cacher(function(path){if(!path){return{x:0,y:0,width:0,height:0};}
path=path2curve(path);var x=0,y=0,X=[],Y=[],p;for(var i=0,ii=path.length;i<ii;i++){p=path[i];if(p[0]=="M"){x=p[1];y=p[2];X.push(x);Y.push(y);}else{var dim=curveDim(x,y,p[1],p[2],p[3],p[4],p[5],p[6]);X=X[concat](dim.min.x,dim.max.x);Y=Y[concat](dim.min.y,dim.max.y);x=p[5];y=p[6];}}
var xmin=mmin[apply](0,X),ymin=mmin[apply](0,Y);return{x:xmin,y:ymin,width:mmax[apply](0,X)-xmin,height:mmax[apply](0,Y)-ymin};},null,function(o){return{x:o.x,y:o.y,width:o.width,height:o.height};}),pathClone=function(pathArray){var res=[];if(!R.is(pathArray,array)||!R.is(pathArray&&pathArray[0],array)){pathArray=R.parsePathString(pathArray);}
for(var i=0,ii=pathArray.length;i<ii;i++){res[i]=[];for(var j=0,jj=pathArray[i].length;j<jj;j++){res[i][j]=pathArray[i][j];}}
res.toString=R._path2string;return res;},pathToRelative=R._pathToRelative=cacher(function(pathArray){if(!R.is(pathArray,array)||!R.is(pathArray&&pathArray[0],array)){pathArray=R.parsePathString(pathArray);}
var res=[],x=0,y=0,mx=0,my=0,start=0;if(pathArray[0][0]=="M"){x=pathArray[0][1];y=pathArray[0][2];mx=x;my=y;start++;res.push(["M",x,y]);}
for(var i=start,ii=pathArray.length;i<ii;i++){var r=res[i]=[],pa=pathArray[i];if(pa[0]!=lowerCase.call(pa[0])){r[0]=lowerCase.call(pa[0]);switch(r[0]){case"a":r[1]=pa[1];r[2]=pa[2];r[3]=pa[3];r[4]=pa[4];r[5]=pa[5];r[6]=+(pa[6]-x).toFixed(3);r[7]=+(pa[7]-y).toFixed(3);break;case"v":r[1]=+(pa[1]-y).toFixed(3);break;case"m":mx=pa[1];my=pa[2];default:for(var j=1,jj=pa.length;j<jj;j++){r[j]=+(pa[j]-((j%2)?x:y)).toFixed(3);}}}else{r=res[i]=[];if(pa[0]=="m"){mx=pa[1]+x;my=pa[2]+y;}
for(var k=0,kk=pa.length;k<kk;k++){res[i][k]=pa[k];}}
var len=res[i].length;switch(res[i][0]){case"z":x=mx;y=my;break;case"h":x+=+res[i][len-1];break;case"v":y+=+res[i][len-1];break;default:x+=+res[i][len-2];y+=+res[i][len-1];}}
res.toString=R._path2string;return res;},0,pathClone),pathToAbsolute=R._pathToAbsolute=cacher(function(pathArray){if(!R.is(pathArray,array)||!R.is(pathArray&&pathArray[0],array)){pathArray=R.parsePathString(pathArray);}
if(!pathArray||!pathArray.length){return[["M",0,0]];}
var res=[],x=0,y=0,mx=0,my=0,start=0;if(pathArray[0][0]=="M"){x=+pathArray[0][1];y=+pathArray[0][2];mx=x;my=y;start++;res[0]=["M",x,y];}
var crz=pathArray.length==3&&pathArray[0][0]=="M"&&pathArray[1][0].toUpperCase()=="R"&&pathArray[2][0].toUpperCase()=="Z";for(var r,pa,i=start,ii=pathArray.length;i<ii;i++){res.push(r=[]);pa=pathArray[i];if(pa[0]!=upperCase.call(pa[0])){r[0]=upperCase.call(pa[0]);switch(r[0]){case"A":r[1]=pa[1];r[2]=pa[2];r[3]=pa[3];r[4]=pa[4];r[5]=pa[5];r[6]=+(pa[6]+x);r[7]=+(pa[7]+y);break;case"V":r[1]=+pa[1]+y;break;case"H":r[1]=+pa[1]+x;break;case"R":var dots=[x,y][concat](pa.slice(1));for(var j=2,jj=dots.length;j<jj;j++){dots[j]=+dots[j]+x;dots[++j]=+dots[j]+y;}
res.pop();res=res[concat](catmullRom2bezier(dots,crz));break;case"M":mx=+pa[1]+x;my=+pa[2]+y;default:for(j=1,jj=pa.length;j<jj;j++){r[j]=+pa[j]+((j%2)?x:y);}}}else if(pa[0]=="R"){dots=[x,y][concat](pa.slice(1));res.pop();res=res[concat](catmullRom2bezier(dots,crz));r=["R"][concat](pa.slice(-2));}else{for(var k=0,kk=pa.length;k<kk;k++){r[k]=pa[k];}}
switch(r[0]){case"Z":x=mx;y=my;break;case"H":x=r[1];break;case"V":y=r[1];break;case"M":mx=r[r.length-2];my=r[r.length-1];default:x=r[r.length-2];y=r[r.length-1];}}
res.toString=R._path2string;return res;},null,pathClone),l2c=function(x1,y1,x2,y2){return[x1,y1,x2,y2,x2,y2];},q2c=function(x1,y1,ax,ay,x2,y2){var _13=1/3,_23=2/3;return[_13*x1+_23*ax,_13*y1+_23*ay,_13*x2+_23*ax,_13*y2+_23*ay,x2,y2];},a2c=function(x1,y1,rx,ry,angle,large_arc_flag,sweep_flag,x2,y2,recursive){var _120=PI*120/180,rad=PI/180*(+angle||0),res=[],xy,rotate=cacher(function(x,y,rad){var X=x*math.cos(rad)-y*math.sin(rad),Y=x*math.sin(rad)+y*math.cos(rad);return{x:X,y:Y};});if(!recursive){xy=rotate(x1,y1,-rad);x1=xy.x;y1=xy.y;xy=rotate(x2,y2,-rad);x2=xy.x;y2=xy.y;var cos=math.cos(PI/180*angle),sin=math.sin(PI/180*angle),x=(x1-x2)/2,y=(y1-y2)/2;var h=(x*x)/(rx*rx)+(y*y)/(ry*ry);if(h>1){h=math.sqrt(h);rx=h*rx;ry=h*ry;}
var rx2=rx*rx,ry2=ry*ry,k=(large_arc_flag==sweep_flag?-1:1)*math.sqrt(abs((rx2*ry2-rx2*y*y-ry2*x*x)/(rx2*y*y+ry2*x*x))),cx=k*rx*y/ry+(x1+x2)/2,cy=k*-ry*x/rx+(y1+y2)/2,f1=math.asin(((y1-cy)/ry).toFixed(9)),f2=math.asin(((y2-cy)/ry).toFixed(9));f1=x1<cx?PI-f1:f1;f2=x2<cx?PI-f2:f2;f1<0&&(f1=PI*2+f1);f2<0&&(f2=PI*2+f2);if(sweep_flag&&f1>f2){f1=f1-PI*2;}
if(!sweep_flag&&f2>f1){f2=f2-PI*2;}}else{f1=recursive[0];f2=recursive[1];cx=recursive[2];cy=recursive[3];}
var df=f2-f1;if(abs(df)>_120){var f2old=f2,x2old=x2,y2old=y2;f2=f1+_120*(sweep_flag&&f2>f1?1:-1);x2=cx+rx*math.cos(f2);y2=cy+ry*math.sin(f2);res=a2c(x2,y2,rx,ry,angle,0,sweep_flag,x2old,y2old,[f2,f2old,cx,cy]);}
df=f2-f1;var c1=math.cos(f1),s1=math.sin(f1),c2=math.cos(f2),s2=math.sin(f2),t=math.tan(df/4),hx=4/3*rx*t,hy=4/3*ry*t,m1=[x1,y1],m2=[x1+hx*s1,y1-hy*c1],m3=[x2+hx*s2,y2-hy*c2],m4=[x2,y2];m2[0]=2*m1[0]-m2[0];m2[1]=2*m1[1]-m2[1];if(recursive){return[m2,m3,m4][concat](res);}else{res=[m2,m3,m4][concat](res).join()[split](",");var newres=[];for(var i=0,ii=res.length;i<ii;i++){newres[i]=i%2?rotate(res[i-1],res[i],rad).y:rotate(res[i],res[i+1],rad).x;}
return newres;}},findDotAtSegment=function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t){var t1=1-t;return{x:pow(t1,3)*p1x+pow(t1,2)*3*t*c1x+t1*3*t*t*c2x+pow(t,3)*p2x,y:pow(t1,3)*p1y+pow(t1,2)*3*t*c1y+t1*3*t*t*c2y+pow(t,3)*p2y};},curveDim=cacher(function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y){var a=(c2x-2*c1x+p1x)-(p2x-2*c2x+c1x),b=2*(c1x-p1x)-2*(c2x-c1x),c=p1x-c1x,t1=(-b+math.sqrt(b*b-4*a*c))/2/a,t2=(-b-math.sqrt(b*b-4*a*c))/2/a,y=[p1y,p2y],x=[p1x,p2x],dot;abs(t1)>"1e12"&&(t1=.5);abs(t2)>"1e12"&&(t2=.5);if(t1>0&&t1<1){dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t1);x.push(dot.x);y.push(dot.y);}
if(t2>0&&t2<1){dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t2);x.push(dot.x);y.push(dot.y);}
a=(c2y-2*c1y+p1y)-(p2y-2*c2y+c1y);b=2*(c1y-p1y)-2*(c2y-c1y);c=p1y-c1y;t1=(-b+math.sqrt(b*b-4*a*c))/2/a;t2=(-b-math.sqrt(b*b-4*a*c))/2/a;abs(t1)>"1e12"&&(t1=.5);abs(t2)>"1e12"&&(t2=.5);if(t1>0&&t1<1){dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t1);x.push(dot.x);y.push(dot.y);}
if(t2>0&&t2<1){dot=findDotAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,t2);x.push(dot.x);y.push(dot.y);}
return{min:{x:mmin[apply](0,x),y:mmin[apply](0,y)},max:{x:mmax[apply](0,x),y:mmax[apply](0,y)}};}),path2curve=R._path2curve=cacher(function(path,path2){var p=pathToAbsolute(path),p2=path2&&pathToAbsolute(path2),attrs={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},attrs2={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},processPath=function(path,d){var nx,ny;if(!path){return["C",d.x,d.y,d.x,d.y,d.x,d.y];}
!(path[0]in{T:1,Q:1})&&(d.qx=d.qy=null);switch(path[0]){case"M":d.X=path[1];d.Y=path[2];break;case"A":path=["C"][concat](a2c[apply](0,[d.x,d.y][concat](path.slice(1))));break;case"S":nx=d.x+(d.x-(d.bx||d.x));ny=d.y+(d.y-(d.by||d.y));path=["C",nx,ny][concat](path.slice(1));break;case"T":d.qx=d.x+(d.x-(d.qx||d.x));d.qy=d.y+(d.y-(d.qy||d.y));path=["C"][concat](q2c(d.x,d.y,d.qx,d.qy,path[1],path[2]));break;case"Q":d.qx=path[1];d.qy=path[2];path=["C"][concat](q2c(d.x,d.y,path[1],path[2],path[3],path[4]));break;case"L":path=["C"][concat](l2c(d.x,d.y,path[1],path[2]));break;case"H":path=["C"][concat](l2c(d.x,d.y,path[1],d.y));break;case"V":path=["C"][concat](l2c(d.x,d.y,d.x,path[1]));break;case"Z":path=["C"][concat](l2c(d.x,d.y,d.X,d.Y));break;}
return path;},fixArc=function(pp,i){if(pp[i].length>7){pp[i].shift();var pi=pp[i];while(pi.length){pp.splice(i++,0,["C"][concat](pi.splice(0,6)));}
pp.splice(i,1);ii=mmax(p.length,p2&&p2.length||0);}},fixM=function(path1,path2,a1,a2,i){if(path1&&path2&&path1[i][0]=="M"&&path2[i][0]!="M"){path2.splice(i,0,["M",a2.x,a2.y]);a1.bx=0;a1.by=0;a1.x=path1[i][1];a1.y=path1[i][2];ii=mmax(p.length,p2&&p2.length||0);}};for(var i=0,ii=mmax(p.length,p2&&p2.length||0);i<ii;i++){p[i]=processPath(p[i],attrs);fixArc(p,i);p2&&(p2[i]=processPath(p2[i],attrs2));p2&&fixArc(p2,i);fixM(p,p2,attrs,attrs2,i);fixM(p2,p,attrs2,attrs,i);var seg=p[i],seg2=p2&&p2[i],seglen=seg.length,seg2len=p2&&seg2.length;attrs.x=seg[seglen-2];attrs.y=seg[seglen-1];attrs.bx=toFloat(seg[seglen-4])||attrs.x;attrs.by=toFloat(seg[seglen-3])||attrs.y;attrs2.bx=p2&&(toFloat(seg2[seg2len-4])||attrs2.x);attrs2.by=p2&&(toFloat(seg2[seg2len-3])||attrs2.y);attrs2.x=p2&&seg2[seg2len-2];attrs2.y=p2&&seg2[seg2len-1];}
return p2?[p,p2]:p;},null,pathClone),parseDots=R._parseDots=cacher(function(gradient){var dots=[];for(var i=0,ii=gradient.length;i<ii;i++){var dot={},par=gradient[i].match(/^([^:]*):?([\d\.]*)/);dot.color=R.getRGB(par[1]);if(dot.color.error){return null;}
dot.color=dot.color.hex;par[2]&&(dot.offset=par[2]+"%");dots.push(dot);}
for(i=1,ii=dots.length-1;i<ii;i++){if(!dots[i].offset){var start=toFloat(dots[i-1].offset||0),end=0;for(var j=i+1;j<ii;j++){if(dots[j].offset){end=dots[j].offset;break;}}
if(!end){end=100;j=ii;}
end=toFloat(end);var d=(end-start)/(j-i+1);for(;i<j;i++){start+=d;dots[i].offset=start+"%";}}}
return dots;}),tear=R._tear=function(el,paper){el==paper.top&&(paper.top=el.prev);el==paper.bottom&&(paper.bottom=el.next);el.next&&(el.next.prev=el.prev);el.prev&&(el.prev.next=el.next);},tofront=R._tofront=function(el,paper){if(paper.top===el){return;}
tear(el,paper);el.next=null;el.prev=paper.top;paper.top.next=el;paper.top=el;},toback=R._toback=function(el,paper){if(paper.bottom===el){return;}
tear(el,paper);el.next=paper.bottom;el.prev=null;paper.bottom.prev=el;paper.bottom=el;},insertafter=R._insertafter=function(el,el2,paper){tear(el,paper);el2==paper.top&&(paper.top=el);el2.next&&(el2.next.prev=el);el.next=el2.next;el.prev=el2;el2.next=el;},insertbefore=R._insertbefore=function(el,el2,paper){tear(el,paper);el2==paper.bottom&&(paper.bottom=el);el2.prev&&(el2.prev.next=el);el.prev=el2.prev;el2.prev=el;el.next=el2;},extractTransform=R._extractTransform=function(el,tstr){if(tstr==null){return el._.transform;}
tstr=Str(tstr).replace(/\.{3}|\u2026/g,el._.transform||E);var tdata=R.parseTransformString(tstr),deg=0,dx=0,dy=0,sx=1,sy=1,_=el._,m=new Matrix;_.transform=tdata||[];if(tdata){for(var i=0,ii=tdata.length;i<ii;i++){var t=tdata[i],tlen=t.length,command=Str(t[0]).toLowerCase(),absolute=t[0]!=command,inver=absolute?m.invert():0,x1,y1,x2,y2,bb;if(command=="t"&&tlen==3){if(absolute){x1=inver.x(0,0);y1=inver.y(0,0);x2=inver.x(t[1],t[2]);y2=inver.y(t[1],t[2]);m.translate(x2-x1,y2-y1);}else{m.translate(t[1],t[2]);}}else if(command=="r"){if(tlen==2){bb=bb||el.getBBox(1);m.rotate(t[1],bb.x+bb.width/2,bb.y+bb.height/2);deg+=t[1];}else if(tlen==4){if(absolute){x2=inver.x(t[2],t[3]);y2=inver.y(t[2],t[3]);m.rotate(t[1],x2,y2);}else{m.rotate(t[1],t[2],t[3]);}
deg+=t[1];}}else if(command=="s"){if(tlen==2||tlen==3){bb=bb||el.getBBox(1);m.scale(t[1],t[tlen-1],bb.x+bb.width/2,bb.y+bb.height/2);sx*=t[1];sy*=t[tlen-1];}else if(tlen==5){if(absolute){x2=inver.x(t[3],t[4]);y2=inver.y(t[3],t[4]);m.scale(t[1],t[2],x2,y2);}else{m.scale(t[1],t[2],t[3],t[4]);}
sx*=t[1];sy*=t[2];}}else if(command=="m"&&tlen==7){m.add(t[1],t[2],t[3],t[4],t[5],t[6]);}
_.dirtyT=1;el.matrix=m;}}
el.matrix=m;_.sx=sx;_.sy=sy;_.deg=deg;_.dx=dx=m.e;_.dy=dy=m.f;if(sx==1&&sy==1&&!deg&&_.bbox){_.bbox.x+=+dx;_.bbox.y+=+dy;}else{_.dirtyT=1;}},getEmpty=function(item){var l=item[0];switch(l.toLowerCase()){case"t":return[l,0,0];case"m":return[l,1,0,0,1,0,0];case"r":if(item.length==4){return[l,0,item[2],item[3]];}else{return[l,0];}
case"s":if(item.length==5){return[l,1,1,item[3],item[4]];}else if(item.length==3){return[l,1,1];}else{return[l,1];}}},equaliseTransform=R._equaliseTransform=function(t1,t2){t2=Str(t2).replace(/\.{3}|\u2026/g,t1);t1=R.parseTransformString(t1)||[];t2=R.parseTransformString(t2)||[];var maxlength=mmax(t1.length,t2.length),from=[],to=[],i=0,j,jj,tt1,tt2;for(;i<maxlength;i++){tt1=t1[i]||getEmpty(t2[i]);tt2=t2[i]||getEmpty(tt1);if((tt1[0]!=tt2[0])||(tt1[0].toLowerCase()=="r"&&(tt1[2]!=tt2[2]||tt1[3]!=tt2[3]))||(tt1[0].toLowerCase()=="s"&&(tt1[3]!=tt2[3]||tt1[4]!=tt2[4]))){return;}
from[i]=[];to[i]=[];for(j=0,jj=mmax(tt1.length,tt2.length);j<jj;j++){j in tt1&&(from[i][j]=tt1[j]);j in tt2&&(to[i][j]=tt2[j]);}}
return{from:from,to:to};};R._getContainer=function(x,y,w,h){var container;container=h==null&&!R.is(x,"object")?g.doc.getElementById(x):x;if(container==null){return;}
if(container.tagName){if(y==null){return{container:container,width:container.style.pixelWidth||container.offsetWidth,height:container.style.pixelHeight||container.offsetHeight};}else{return{container:container,width:y,height:w};}}
return{container:1,x:x,y:y,width:w,height:h};};R.pathToRelative=pathToRelative;R._engine={};R.path2curve=path2curve;R.matrix=function(a,b,c,d,e,f){return new Matrix(a,b,c,d,e,f);};function Matrix(a,b,c,d,e,f){if(a!=null){this.a=+a;this.b=+b;this.c=+c;this.d=+d;this.e=+e;this.f=+f;}else{this.a=1;this.b=0;this.c=0;this.d=1;this.e=0;this.f=0;}}
(function(matrixproto){matrixproto.add=function(a,b,c,d,e,f){var out=[[],[],[]],m=[[this.a,this.c,this.e],[this.b,this.d,this.f],[0,0,1]],matrix=[[a,c,e],[b,d,f],[0,0,1]],x,y,z,res;if(a&&a instanceof Matrix){matrix=[[a.a,a.c,a.e],[a.b,a.d,a.f],[0,0,1]];}
for(x=0;x<3;x++){for(y=0;y<3;y++){res=0;for(z=0;z<3;z++){res+=m[x][z]*matrix[z][y];}
out[x][y]=res;}}
this.a=out[0][0];this.b=out[1][0];this.c=out[0][1];this.d=out[1][1];this.e=out[0][2];this.f=out[1][2];};matrixproto.invert=function(){var me=this,x=me.a*me.d-me.b*me.c;return new Matrix(me.d/x,-me.b/x,-me.c/x,me.a/x,(me.c*me.f-me.d*me.e)/x,(me.b*me.e-me.a*me.f)/x);};matrixproto.clone=function(){return new Matrix(this.a,this.b,this.c,this.d,this.e,this.f);};matrixproto.translate=function(x,y){this.add(1,0,0,1,x,y);};matrixproto.scale=function(x,y,cx,cy){y==null&&(y=x);(cx||cy)&&this.add(1,0,0,1,cx,cy);this.add(x,0,0,y,0,0);(cx||cy)&&this.add(1,0,0,1,-cx,-cy);};matrixproto.rotate=function(a,x,y){a=R.rad(a);x=x||0;y=y||0;var cos=+math.cos(a).toFixed(9),sin=+math.sin(a).toFixed(9);this.add(cos,sin,-sin,cos,x,y);this.add(1,0,0,1,-x,-y);};matrixproto.x=function(x,y){return x*this.a+y*this.c+this.e;};matrixproto.y=function(x,y){return x*this.b+y*this.d+this.f;};matrixproto.get=function(i){return+this[Str.fromCharCode(97+i)].toFixed(4);};matrixproto.toString=function(){return R.svg?"matrix("+[this.get(0),this.get(1),this.get(2),this.get(3),this.get(4),this.get(5)].join()+")":[this.get(0),this.get(2),this.get(1),this.get(3),0,0].join();};matrixproto.toFilter=function(){return"progid:DXImageTransform.Microsoft.Matrix(M11="+this.get(0)+", M12="+this.get(2)+", M21="+this.get(1)+", M22="+this.get(3)+", Dx="+this.get(4)+", Dy="+this.get(5)+", sizingmethod='auto expand')";};matrixproto.offset=function(){return[this.e.toFixed(4),this.f.toFixed(4)];};function norm(a){return a[0]*a[0]+a[1]*a[1];}
function normalize(a){var mag=math.sqrt(norm(a));a[0]&&(a[0]/=mag);a[1]&&(a[1]/=mag);}
matrixproto.split=function(){var out={};out.dx=this.e;out.dy=this.f;var row=[[this.a,this.c],[this.b,this.d]];out.scalex=math.sqrt(norm(row[0]));normalize(row[0]);out.shear=row[0][0]*row[1][0]+row[0][1]*row[1][1];row[1]=[row[1][0]-row[0][0]*out.shear,row[1][1]-row[0][1]*out.shear];out.scaley=math.sqrt(norm(row[1]));normalize(row[1]);out.shear/=out.scaley;var sin=-row[0][1],cos=row[1][1];if(cos<0){out.rotate=R.deg(math.acos(cos));if(sin<0){out.rotate=360-out.rotate;}}else{out.rotate=R.deg(math.asin(sin));}
out.isSimple=!+out.shear.toFixed(9)&&(out.scalex.toFixed(9)==out.scaley.toFixed(9)||!out.rotate);out.isSuperSimple=!+out.shear.toFixed(9)&&out.scalex.toFixed(9)==out.scaley.toFixed(9)&&!out.rotate;out.noRotation=!+out.shear.toFixed(9)&&!out.rotate;return out;};matrixproto.toTransformString=function(shorter){var s=shorter||this[split]();if(s.isSimple){s.scalex=+s.scalex.toFixed(4);s.scaley=+s.scaley.toFixed(4);s.rotate=+s.rotate.toFixed(4);return(s.dx||s.dy?"t"+[s.dx,s.dy]:E)+
(s.scalex!=1||s.scaley!=1?"s"+[s.scalex,s.scaley,0,0]:E)+
(s.rotate?"r"+[s.rotate,0,0]:E);}else{return"m"+[this.get(0),this.get(1),this.get(2),this.get(3),this.get(4),this.get(5)];}};})(Matrix.prototype);var version=navigator.userAgent.match(/Version\/(.*?)\s/)||navigator.userAgent.match(/Chrome\/(\d+)/);if((navigator.vendor=="Apple Computer, Inc.")&&(version&&version[1]<4||navigator.platform.slice(0,2)=="iP")||(navigator.vendor=="Google Inc."&&version&&version[1]<8)){paperproto.safari=function(){var rect=this.rect(-99,-99,this.width+99,this.height+99).attr({stroke:"none"});setTimeout(function(){rect.remove();});};}else{paperproto.safari=fun;}
var preventDefault=function(){this.returnValue=false;},preventTouch=function(){return this.originalEvent.preventDefault();},stopPropagation=function(){this.cancelBubble=true;},stopTouch=function(){return this.originalEvent.stopPropagation();},addEvent=(function(){if(g.doc.addEventListener){return function(obj,type,fn,element){var realName=supportsTouch&&touchMap[type]?touchMap[type]:type,f=function(e){var scrollY=g.doc.documentElement.scrollTop||g.doc.body.scrollTop,scrollX=g.doc.documentElement.scrollLeft||g.doc.body.scrollLeft,x=e.clientX+scrollX,y=e.clientY+scrollY;if(supportsTouch&&touchMap[has](type)){for(var i=0,ii=e.targetTouches&&e.targetTouches.length;i<ii;i++){if(e.targetTouches[i].target==obj){var olde=e;e=e.targetTouches[i];e.originalEvent=olde;e.preventDefault=preventTouch;e.stopPropagation=stopTouch;break;}}}
return fn.call(element,e,x,y);};obj.addEventListener(realName,f,false);return function(){obj.removeEventListener(realName,f,false);return true;};};}else if(g.doc.attachEvent){return function(obj,type,fn,element){var f=function(e){e=e||g.win.event;var scrollY=g.doc.documentElement.scrollTop||g.doc.body.scrollTop,scrollX=g.doc.documentElement.scrollLeft||g.doc.body.scrollLeft,x=e.clientX+scrollX,y=e.clientY+scrollY;e.preventDefault=e.preventDefault||preventDefault;e.stopPropagation=e.stopPropagation||stopPropagation;return fn.call(element,e,x,y);};obj.attachEvent("on"+type,f);var detacher=function(){obj.detachEvent("on"+type,f);return true;};return detacher;};}})(),drag=[],dragMove=function(e){var x=e.clientX,y=e.clientY,scrollY=g.doc.documentElement.scrollTop||g.doc.body.scrollTop,scrollX=g.doc.documentElement.scrollLeft||g.doc.body.scrollLeft,dragi,j=drag.length;while(j--){dragi=drag[j];if(supportsTouch){var i=e.touches.length,touch;while(i--){touch=e.touches[i];if(touch.identifier==dragi.el._drag.id){x=touch.clientX;y=touch.clientY;(e.originalEvent?e.originalEvent:e).preventDefault();break;}}}else{e.preventDefault();}
var node=dragi.el.node,o,next=node.nextSibling,parent=node.parentNode,display=node.style.display;g.win.opera&&parent.removeChild(node);node.style.display="none";o=dragi.el.paper.getElementByPoint(x,y);node.style.display=display;g.win.opera&&(next?parent.insertBefore(node,next):parent.appendChild(node));o&&eve("drag.over."+dragi.el.id,dragi.el,o);x+=scrollX;y+=scrollY;eve("drag.move."+dragi.el.id,dragi.move_scope||dragi.el,x-dragi.el._drag.x,y-dragi.el._drag.y,x,y,e);}},dragUp=function(e){R.unmousemove(dragMove).unmouseup(dragUp);var i=drag.length,dragi;while(i--){dragi=drag[i];dragi.el._drag={};eve("drag.end."+dragi.el.id,dragi.end_scope||dragi.start_scope||dragi.move_scope||dragi.el,e);}
drag=[];},elproto=R.el={};for(var i=events.length;i--;){(function(eventName){R[eventName]=elproto[eventName]=function(fn,scope){if(R.is(fn,"function")){this.events=this.events||[];this.events.push({name:eventName,f:fn,unbind:addEvent(this.shape||this.node||g.doc,eventName,fn,scope||this)});}
return this;};R["un"+eventName]=elproto["un"+eventName]=function(fn){var events=this.events||[],l=events.length;while(l--)if(events[l].name==eventName&&events[l].f==fn){events[l].unbind();events.splice(l,1);!events.length&&delete this.events;return this;}
return this;};})(events[i]);}
elproto.data=function(key,value){var data=eldata[this.id]=eldata[this.id]||{};if(arguments.length==1){if(R.is(key,"object")){for(var i in key)if(key[has](i)){this.data(i,key[i]);}
return this;}
eve("data.get."+this.id,this,data[key],key);return data[key];}
data[key]=value;eve("data.set."+this.id,this,value,key);return this;};elproto.removeData=function(key){if(key==null){eldata[this.id]={};}else{eldata[this.id]&&delete eldata[this.id][key];}
return this;};elproto.hover=function(f_in,f_out,scope_in,scope_out){return this.mouseover(f_in,scope_in).mouseout(f_out,scope_out||scope_in);};elproto.unhover=function(f_in,f_out){return this.unmouseover(f_in).unmouseout(f_out);};var draggable=[];elproto.drag=function(onmove,onstart,onend,move_scope,start_scope,end_scope){function start(e){(e.originalEvent||e).preventDefault();var scrollY=g.doc.documentElement.scrollTop||g.doc.body.scrollTop,scrollX=g.doc.documentElement.scrollLeft||g.doc.body.scrollLeft;this._drag.x=e.clientX+scrollX;this._drag.y=e.clientY+scrollY;this._drag.id=e.identifier;!drag.length&&R.mousemove(dragMove).mouseup(dragUp);drag.push({el:this,move_scope:move_scope,start_scope:start_scope,end_scope:end_scope});onstart&&eve.on("drag.start."+this.id,onstart);onmove&&eve.on("drag.move."+this.id,onmove);onend&&eve.on("drag.end."+this.id,onend);eve("drag.start."+this.id,start_scope||move_scope||this,e.clientX+scrollX,e.clientY+scrollY,e);}
this._drag={};draggable.push({el:this,start:start});this.mousedown(start);return this;};elproto.onDragOver=function(f){f?eve.on("drag.over."+this.id,f):eve.unbind("drag.over."+this.id);};elproto.undrag=function(){var i=draggable.length;while(i--)if(draggable[i].el==this){this.unmousedown(draggable[i].start);draggable.splice(i,1);eve.unbind("drag.*."+this.id);}
!draggable.length&&R.unmousemove(dragMove).unmouseup(dragUp);};paperproto.circle=function(x,y,r){var out=R._engine.circle(this,x||0,y||0,r||0);this.__set__&&this.__set__.push(out);return out;};paperproto.rect=function(x,y,w,h,r){var out=R._engine.rect(this,x||0,y||0,w||0,h||0,r||0);this.__set__&&this.__set__.push(out);return out;};paperproto.ellipse=function(x,y,rx,ry){var out=R._engine.ellipse(this,x||0,y||0,rx||0,ry||0);this.__set__&&this.__set__.push(out);return out;};paperproto.path=function(pathString){pathString&&!R.is(pathString,string)&&!R.is(pathString[0],array)&&(pathString+=E);var out=R._engine.path(R.format[apply](R,arguments),this);this.__set__&&this.__set__.push(out);return out;};paperproto.image=function(src,x,y,w,h){var out=R._engine.image(this,src||"about:blank",x||0,y||0,w||0,h||0);this.__set__&&this.__set__.push(out);return out;};paperproto.text=function(x,y,text){var out=R._engine.text(this,x||0,y||0,Str(text));this.__set__&&this.__set__.push(out);return out;};paperproto.set=function(itemsArray){!R.is(itemsArray,"array")&&(itemsArray=Array.prototype.splice.call(arguments,0,arguments.length));var out=new Set(itemsArray);this.__set__&&this.__set__.push(out);return out;};paperproto.setStart=function(set){this.__set__=set||this.set();};paperproto.setFinish=function(set){var out=this.__set__;delete this.__set__;return out;};paperproto.setSize=function(width,height){return R._engine.setSize.call(this,width,height);};paperproto.setViewBox=function(x,y,w,h,fit){return R._engine.setViewBox.call(this,x,y,w,h,fit);};paperproto.top=paperproto.bottom=null;paperproto.raphael=R;var getOffset=function(elem){var box=elem.getBoundingClientRect(),doc=elem.ownerDocument,body=doc.body,docElem=doc.documentElement,clientTop=docElem.clientTop||body.clientTop||0,clientLeft=docElem.clientLeft||body.clientLeft||0,top=box.top+(g.win.pageYOffset||docElem.scrollTop||body.scrollTop)-clientTop,left=box.left+(g.win.pageXOffset||docElem.scrollLeft||body.scrollLeft)-clientLeft;return{y:top,x:left};};paperproto.getElementByPoint=function(x,y){var paper=this,svg=paper.canvas,target=g.doc.elementFromPoint(x,y);if(g.win.opera&&target.tagName=="svg"){var so=getOffset(svg),sr=svg.createSVGRect();sr.x=x-so.x;sr.y=y-so.y;sr.width=sr.height=1;var hits=svg.getIntersectionList(sr,null);if(hits.length){target=hits[hits.length-1];}}
if(!target){return null;}
while(target.parentNode&&target!=svg.parentNode&&!target.raphael){target=target.parentNode;}
target==paper.canvas.parentNode&&(target=svg);target=target&&target.raphael?paper.getById(target.raphaelid):null;return target;};paperproto.getById=function(id){var bot=this.bottom;while(bot){if(bot.id==id){return bot;}
bot=bot.next;}
return null;};paperproto.forEach=function(callback,thisArg){var bot=this.bottom;while(bot){if(callback.call(thisArg,bot)===false){return this;}
bot=bot.next;}
return this;};function x_y(){return this.x+S+this.y;}
function x_y_w_h(){return this.x+S+this.y+S+this.width+" \xd7 "+this.height;}
elproto.getBBox=function(isWithoutTransform){if(this.removed){return{};}
var _=this._;if(isWithoutTransform){if(_.dirty||!_.bboxwt){this.realPath=getPath[this.type](this);_.bboxwt=pathDimensions(this.realPath);_.bboxwt.toString=x_y_w_h;_.dirty=0;}
return _.bboxwt;}
if(_.dirty||_.dirtyT||!_.bbox){if(_.dirty||!this.realPath){_.bboxwt=0;this.realPath=getPath[this.type](this);}
_.bbox=pathDimensions(mapPath(this.realPath,this.matrix));_.bbox.toString=x_y_w_h;_.dirty=_.dirtyT=0;}
return _.bbox;};elproto.clone=function(){if(this.removed){return null;}
var out=this.paper[this.type]().attr(this.attr());this.__set__&&this.__set__.push(out);return out;};elproto.glow=function(glow){if(this.type=="text"){return null;}
glow=glow||{};var s={width:(glow.width||10)+(+this.attr("stroke-width")||1),fill:glow.fill||false,opacity:glow.opacity||.5,offsetx:glow.offsetx||0,offsety:glow.offsety||0,color:glow.color||"#000"},c=s.width/2,r=this.paper,out=r.set(),path=this.realPath||getPath[this.type](this);path=this.matrix?mapPath(path,this.matrix):path;for(var i=1;i<c+1;i++){out.push(r.path(path).attr({stroke:s.color,fill:s.fill?s.color:"none","stroke-linejoin":"round","stroke-linecap":"round","stroke-width":+(s.width/c*i).toFixed(3),opacity:+(s.opacity/c).toFixed(3)}));}
return out.insertBefore(this).translate(s.offsetx,s.offsety);};var curveslengths={},getPointAtSegmentLength=function(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,length){var len=0,precision=100,name=[p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y].join(),cache=curveslengths[name],old,dot;!cache&&(curveslengths[name]=cache={data:[]});cache.timer&&clearTimeout(cache.timer);cache.timer=setTimeout(function(){delete curveslengths[name];},2e3);if(length!=null&&!cache.precision){var total=getPointAtSegmentLength(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y);cache.precision=~~total*10;cache.data=[];}
precision=cache.precision||precision;for(var i=0;i<precision+1;i++){if(cache.data[i*precision]){dot=cache.data[i*precision];}else{dot=R.findDotsAtSegment(p1x,p1y,c1x,c1y,c2x,c2y,p2x,p2y,i/precision);cache.data[i*precision]=dot;}
i&&(len+=pow(pow(old.x-dot.x,2)+pow(old.y-dot.y,2),.5));if(length!=null&&len>=length){return dot;}
old=dot;}
if(length==null){return len;}},getLengthFactory=function(istotal,subpath){return function(path,length,onlystart){path=path2curve(path);var x,y,p,l,sp="",subpaths={},point,len=0;for(var i=0,ii=path.length;i<ii;i++){p=path[i];if(p[0]=="M"){x=+p[1];y=+p[2];}else{l=getPointAtSegmentLength(x,y,p[1],p[2],p[3],p[4],p[5],p[6]);if(len+l>length){if(subpath&&!subpaths.start){point=getPointAtSegmentLength(x,y,p[1],p[2],p[3],p[4],p[5],p[6],length-len);sp+=["C"+point.start.x,point.start.y,point.m.x,point.m.y,point.x,point.y];if(onlystart){return sp;}
subpaths.start=sp;sp=["M"+point.x,point.y+"C"+point.n.x,point.n.y,point.end.x,point.end.y,p[5],p[6]].join();len+=l;x=+p[5];y=+p[6];continue;}
if(!istotal&&!subpath){point=getPointAtSegmentLength(x,y,p[1],p[2],p[3],p[4],p[5],p[6],length-len);return{x:point.x,y:point.y,alpha:point.alpha};}}
len+=l;x=+p[5];y=+p[6];}
sp+=p.shift()+p;}
subpaths.end=sp;point=istotal?len:subpath?subpaths:R.findDotsAtSegment(x,y,p[0],p[1],p[2],p[3],p[4],p[5],1);point.alpha&&(point={x:point.x,y:point.y,alpha:point.alpha});return point;};};var getTotalLength=getLengthFactory(1),getPointAtLength=getLengthFactory(),getSubpathsAtLength=getLengthFactory(0,1);R.getTotalLength=getTotalLength;R.getPointAtLength=getPointAtLength;R.getSubpath=function(path,from,to){if(this.getTotalLength(path)-to<1e-6){return getSubpathsAtLength(path,from).end;}
var a=getSubpathsAtLength(path,to,1);return from?getSubpathsAtLength(a,from).end:a;};elproto.getTotalLength=function(){if(this.type!="path"){return;}
if(this.node.getTotalLength){return this.node.getTotalLength();}
return getTotalLength(this.attrs.path);};elproto.getPointAtLength=function(length){if(this.type!="path"){return;}
return getPointAtLength(this.attrs.path,length);};elproto.getSubpath=function(from,to){if(this.type!="path"){return;}
return R.getSubpath(this.attrs.path,from,to);};var ef=R.easing_formulas={linear:function(n){return n;},"<":function(n){return pow(n,1.7);},">":function(n){return pow(n,.48);},"<>":function(n){var q=.48-n/1.04,Q=math.sqrt(.1734+q*q),x=Q-q,X=pow(abs(x),1/3)*(x<0?-1:1),y=-Q-q,Y=pow(abs(y),1/3)*(y<0?-1:1),t=X+Y+.5;return(1-t)*3*t*t+t*t*t;},backIn:function(n){var s=1.70158;return n*n*((s+1)*n-s);},backOut:function(n){n=n-1;var s=1.70158;return n*n*((s+1)*n+s)+1;},elastic:function(n){if(n==!!n){return n;}
return pow(2,-10*n)*math.sin((n-.075)*(2*PI)/.3)+1;},bounce:function(n){var s=7.5625,p=2.75,l;if(n<(1/p)){l=s*n*n;}else{if(n<(2/p)){n-=(1.5/p);l=s*n*n+.75;}else{if(n<(2.5/p)){n-=(2.25/p);l=s*n*n+.9375;}else{n-=(2.625/p);l=s*n*n+.984375;}}}
return l;}};ef.easeIn=ef["ease-in"]=ef["<"];ef.easeOut=ef["ease-out"]=ef[">"];ef.easeInOut=ef["ease-in-out"]=ef["<>"];ef["back-in"]=ef.backIn;ef["back-out"]=ef.backOut;var animationElements=[],requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){setTimeout(callback,16);},animation=function(){var Now=+new Date,l=0;for(;l<animationElements.length;l++){var e=animationElements[l];if(e.el.removed||e.paused){continue;}
var time=Now-e.start,ms=e.ms,easing=e.easing,from=e.from,diff=e.diff,to=e.to,t=e.t,that=e.el,set={},now,init={},key;if(e.initstatus){time=(e.initstatus*e.anim.top-e.prev)/(e.percent-e.prev)*ms;e.status=e.initstatus;delete e.initstatus;e.stop&&animationElements.splice(l--,1);}else{e.status=(e.prev+(e.percent-e.prev)*(time/ms))/e.anim.top;}
if(time<0){continue;}
if(time<ms){var pos=easing(time/ms);for(var attr in from)if(from[has](attr)){switch(availableAnimAttrs[attr]){case nu:now=+from[attr]+pos*ms*diff[attr];break;case"colour":now="rgb("+[upto255(round(from[attr].r+pos*ms*diff[attr].r)),upto255(round(from[attr].g+pos*ms*diff[attr].g)),upto255(round(from[attr].b+pos*ms*diff[attr].b))].join(",")+")";break;case"path":now=[];for(var i=0,ii=from[attr].length;i<ii;i++){now[i]=[from[attr][i][0]];for(var j=1,jj=from[attr][i].length;j<jj;j++){now[i][j]=+from[attr][i][j]+pos*ms*diff[attr][i][j];}
now[i]=now[i].join(S);}
now=now.join(S);break;case"transform":if(diff[attr].real){now=[];for(i=0,ii=from[attr].length;i<ii;i++){now[i]=[from[attr][i][0]];for(j=1,jj=from[attr][i].length;j<jj;j++){now[i][j]=from[attr][i][j]+pos*ms*diff[attr][i][j];}}}else{var get=function(i){return+from[attr][i]+pos*ms*diff[attr][i];};now=[["m",get(0),get(1),get(2),get(3),get(4),get(5)]];}
break;case"csv":if(attr=="clip-rect"){now=[];i=4;while(i--){now[i]=+from[attr][i]+pos*ms*diff[attr][i];}}
break;default:var from2=[][concat](from[attr]);now=[];i=that.paper.customAttributes[attr].length;while(i--){now[i]=+from2[i]+pos*ms*diff[attr][i];}
break;}
set[attr]=now;}
that.attr(set);(function(id,that,anim){setTimeout(function(){eve("anim.frame."+id,that,anim);});})(that.id,that,e.anim);}else{(function(f,el,a){setTimeout(function(){eve("anim.frame."+el.id,el,a);eve("anim.finish."+el.id,el,a);R.is(f,"function")&&f.call(el);});})(e.callback,that,e.anim);that.attr(to);animationElements.splice(l--,1);if(e.repeat>1&&!e.next){for(key in to)if(to[has](key)){init[key]=e.totalOrigin[key];}
e.el.attr(init);runAnimation(e.anim,e.el,e.anim.percents[0],null,e.totalOrigin,e.repeat-1);}
if(e.next&&!e.stop){runAnimation(e.anim,e.el,e.next,null,e.totalOrigin,e.repeat);}}}
R.svg&&that&&that.paper&&that.paper.safari();animationElements.length&&requestAnimFrame(animation);},upto255=function(color){return color>255?255:color<0?0:color;};elproto.animateWith=function(el,anim,params,ms,easing,callback){var element=this;if(element.removed){callback&&callback.call(element);return element;}
var a=params instanceof Animation?params:R.animation(params,ms,easing,callback),x,y;runAnimation(a,element,a.percents[0],null,element.attr());for(var i=0,ii=animationElements.length;i<ii;i++){if(animationElements[i].anim==anim&&animationElements[i].el==el){animationElements[ii-1].start=animationElements[i].start;break;}}
return element;};function CubicBezierAtTime(t,p1x,p1y,p2x,p2y,duration){var cx=3*p1x,bx=3*(p2x-p1x)-cx,ax=1-cx-bx,cy=3*p1y,by=3*(p2y-p1y)-cy,ay=1-cy-by;function sampleCurveX(t){return((ax*t+bx)*t+cx)*t;}
function solve(x,epsilon){var t=solveCurveX(x,epsilon);return((ay*t+by)*t+cy)*t;}
function solveCurveX(x,epsilon){var t0,t1,t2,x2,d2,i;for(t2=x,i=0;i<8;i++){x2=sampleCurveX(t2)-x;if(abs(x2)<epsilon){return t2;}
d2=(3*ax*t2+2*bx)*t2+cx;if(abs(d2)<1e-6){break;}
t2=t2-x2/d2;}
t0=0;t1=1;t2=x;if(t2<t0){return t0;}
if(t2>t1){return t1;}
while(t0<t1){x2=sampleCurveX(t2);if(abs(x2-x)<epsilon){return t2;}
if(x>x2){t0=t2;}else{t1=t2;}
t2=(t1-t0)/2+t0;}
return t2;}
return solve(t,1/(200*duration));}
elproto.onAnimation=function(f){f?eve.on("anim.frame."+this.id,f):eve.unbind("anim.frame."+this.id);return this;};function Animation(anim,ms){var percents=[],newAnim={};this.ms=ms;this.times=1;if(anim){for(var attr in anim)if(anim[has](attr)){newAnim[toFloat(attr)]=anim[attr];percents.push(toFloat(attr));}
percents.sort(sortByNumber);}
this.anim=newAnim;this.top=percents[percents.length-1];this.percents=percents;}
Animation.prototype.delay=function(delay){var a=new Animation(this.anim,this.ms);a.times=this.times;a.del=+delay||0;return a;};Animation.prototype.repeat=function(times){var a=new Animation(this.anim,this.ms);a.del=this.del;a.times=math.floor(mmax(times,0))||1;return a;};function runAnimation(anim,element,percent,status,totalOrigin,times){percent=toFloat(percent);var params,isInAnim,isInAnimSet,percents=[],next,prev,timestamp,ms=anim.ms,from={},to={},diff={};if(status){for(i=0,ii=animationElements.length;i<ii;i++){var e=animationElements[i];if(e.el.id==element.id&&e.anim==anim){if(e.percent!=percent){animationElements.splice(i,1);isInAnimSet=1;}else{isInAnim=e;}
element.attr(e.totalOrigin);break;}}}else{status=+to;}
for(var i=0,ii=anim.percents.length;i<ii;i++){if(anim.percents[i]==percent||anim.percents[i]>status*anim.top){percent=anim.percents[i];prev=anim.percents[i-1]||0;ms=ms/anim.top*(percent-prev);next=anim.percents[i+1];params=anim.anim[percent];break;}else if(status){element.attr(anim.anim[anim.percents[i]]);}}
if(!params){return;}
if(!isInAnim){for(var attr in params)if(params[has](attr)){if(availableAnimAttrs[has](attr)||element.paper.customAttributes[has](attr)){from[attr]=element.attr(attr);(from[attr]==null)&&(from[attr]=availableAttrs[attr]);to[attr]=params[attr];switch(availableAnimAttrs[attr]){case nu:diff[attr]=(to[attr]-from[attr])/ms;break;case"colour":from[attr]=R.getRGB(from[attr]);var toColour=R.getRGB(to[attr]);diff[attr]={r:(toColour.r-from[attr].r)/ms,g:(toColour.g-from[attr].g)/ms,b:(toColour.b-from[attr].b)/ms};break;case"path":var pathes=path2curve(from[attr],to[attr]),toPath=pathes[1];from[attr]=pathes[0];diff[attr]=[];for(i=0,ii=from[attr].length;i<ii;i++){diff[attr][i]=[0];for(var j=1,jj=from[attr][i].length;j<jj;j++){diff[attr][i][j]=(toPath[i][j]-from[attr][i][j])/ms;}}
break;case"transform":var _=element._,eq=equaliseTransform(_[attr],to[attr]);if(eq){from[attr]=eq.from;to[attr]=eq.to;diff[attr]=[];diff[attr].real=true;for(i=0,ii=from[attr].length;i<ii;i++){diff[attr][i]=[from[attr][i][0]];for(j=1,jj=from[attr][i].length;j<jj;j++){diff[attr][i][j]=(to[attr][i][j]-from[attr][i][j])/ms;}}}else{var m=(element.matrix||new Matrix),to2={_:{transform:_.transform},getBBox:function(){return element.getBBox(1);}};from[attr]=[m.a,m.b,m.c,m.d,m.e,m.f];extractTransform(to2,to[attr]);to[attr]=to2._.transform;diff[attr]=[(to2.matrix.a-m.a)/ms,(to2.matrix.b-m.b)/ms,(to2.matrix.c-m.c)/ms,(to2.matrix.d-m.d)/ms,(to2.matrix.e-m.e)/ms,(to2.matrix.e-m.f)/ms];}
break;case"csv":var values=Str(params[attr])[split](separator),from2=Str(from[attr])[split](separator);if(attr=="clip-rect"){from[attr]=from2;diff[attr]=[];i=from2.length;while(i--){diff[attr][i]=(values[i]-from[attr][i])/ms;}}
to[attr]=values;break;default:values=[][concat](params[attr]);from2=[][concat](from[attr]);diff[attr]=[];i=element.paper.customAttributes[attr].length;while(i--){diff[attr][i]=((values[i]||0)-(from2[i]||0))/ms;}
break;}}}
var easing=params.easing,easyeasy=R.easing_formulas[easing];if(!easyeasy){easyeasy=Str(easing).match(bezierrg);if(easyeasy&&easyeasy.length==5){var curve=easyeasy;easyeasy=function(t){return CubicBezierAtTime(t,+curve[1],+curve[2],+curve[3],+curve[4],ms);};}else{easyeasy=pipe;}}
timestamp=params.start||anim.start||+new Date;e={anim:anim,percent:percent,timestamp:timestamp,start:timestamp+(anim.del||0),status:0,initstatus:status||0,stop:false,ms:ms,easing:easyeasy,from:from,diff:diff,to:to,el:element,callback:params.callback,prev:prev,next:next,repeat:times||anim.times,origin:element.attr(),totalOrigin:totalOrigin};animationElements.push(e);if(status&&!isInAnim&&!isInAnimSet){e.stop=true;e.start=new Date-ms*status;if(animationElements.length==1){return animation();}}
if(isInAnimSet){e.start=new Date-e.ms*status;}
animationElements.length==1&&requestAnimFrame(animation);}else{isInAnim.initstatus=status;isInAnim.start=new Date-isInAnim.ms*status;}
eve("anim.start."+element.id,element,anim);}
R.animation=function(params,ms,easing,callback){if(params instanceof Animation){return params;}
if(R.is(easing,"function")||!easing){callback=callback||easing||null;easing=null;}
params=Object(params);ms=+ms||0;var p={},json,attr;for(attr in params)if(params[has](attr)&&toFloat(attr)!=attr&&toFloat(attr)+"%"!=attr){json=true;p[attr]=params[attr];}
if(!json){return new Animation(params,ms);}else{easing&&(p.easing=easing);callback&&(p.callback=callback);return new Animation({100:p},ms);}};elproto.animate=function(params,ms,easing,callback){var element=this;if(element.removed){callback&&callback.call(element);return element;}
var anim=params instanceof Animation?params:R.animation(params,ms,easing,callback);runAnimation(anim,element,anim.percents[0],null,element.attr());return element;};elproto.setTime=function(anim,value){if(anim&&value!=null){this.status(anim,mmin(value,anim.ms)/anim.ms);}
return this;};elproto.status=function(anim,value){var out=[],i=0,len,e;if(value!=null){runAnimation(anim,this,-1,mmin(value,1));return this;}else{len=animationElements.length;for(;i<len;i++){e=animationElements[i];if(e.el.id==this.id&&(!anim||e.anim==anim)){if(anim){return e.status;}
out.push({anim:e.anim,status:e.status});}}
if(anim){return 0;}
return out;}};elproto.pause=function(anim){for(var i=0;i<animationElements.length;i++)if(animationElements[i].el.id==this.id&&(!anim||animationElements[i].anim==anim)){if(eve("anim.pause."+this.id,this,animationElements[i].anim)!==false){animationElements[i].paused=true;}}
return this;};elproto.resume=function(anim){for(var i=0;i<animationElements.length;i++)if(animationElements[i].el.id==this.id&&(!anim||animationElements[i].anim==anim)){var e=animationElements[i];if(eve("anim.resume."+this.id,this,e.anim)!==false){delete e.paused;this.status(e.anim,e.status);}}
return this;};elproto.stop=function(anim){for(var i=0;i<animationElements.length;i++)if(animationElements[i].el.id==this.id&&(!anim||animationElements[i].anim==anim)){if(eve("anim.stop."+this.id,this,animationElements[i].anim)!==false){animationElements.splice(i--,1);}}
return this;};elproto.toString=function(){return"Rapha\xebl\u2019s object";};var Set=function(items){this.items=[];this.length=0;this.type="set";if(items){for(var i=0,ii=items.length;i<ii;i++){if(items[i]&&(items[i].constructor==elproto.constructor||items[i].constructor==Set)){this[this.items.length]=this.items[this.items.length]=items[i];this.length++;}}}},setproto=Set.prototype;setproto.push=function(){var item,len;for(var i=0,ii=arguments.length;i<ii;i++){item=arguments[i];if(item&&(item.constructor==elproto.constructor||item.constructor==Set)){len=this.items.length;this[len]=this.items[len]=item;this.length++;}}
return this;};setproto.pop=function(){this.length&&delete this[this.length--];return this.items.pop();};setproto.forEach=function(callback,thisArg){for(var i=0,ii=this.items.length;i<ii;i++){if(callback.call(thisArg,this.items[i],i)===false){return this;}}
return this;};for(var method in elproto)if(elproto[has](method)){setproto[method]=(function(methodname){return function(){var arg=arguments;return this.forEach(function(el){el[methodname][apply](el,arg);});};})(method);}
setproto.attr=function(name,value){if(name&&R.is(name,array)&&R.is(name[0],"object")){for(var j=0,jj=name.length;j<jj;j++){this.items[j].attr(name[j]);}}else{for(var i=0,ii=this.items.length;i<ii;i++){this.items[i].attr(name,value);}}
return this;};setproto.clear=function(){while(this.length){this.pop();}};setproto.splice=function(index,count,insertion){index=index<0?mmax(this.length+index,0):index;count=mmax(0,mmin(this.length-index,count));var tail=[],todel=[],args=[],i;for(i=2;i<arguments.length;i++){args.push(arguments[i]);}
for(i=0;i<count;i++){todel.push(this[index+i]);}
for(;i<this.length-index;i++){tail.push(this[index+i]);}
var arglen=args.length;for(i=0;i<arglen+tail.length;i++){this.items[index+i]=this[index+i]=i<arglen?args[i]:tail[i-arglen];}
i=this.items.length=this.length-=count-arglen;while(this[i]){delete this[i++];}
return new Set(todel);};setproto.exclude=function(el){for(var i=0,ii=this.length;i<ii;i++)if(this[i]==el){this.splice(i,1);return true;}};setproto.animate=function(params,ms,easing,callback){(R.is(easing,"function")||!easing)&&(callback=easing||null);var len=this.items.length,i=len,item,set=this,collector;if(!len){return this;}
callback&&(collector=function(){!--len&&callback.call(set);});easing=R.is(easing,string)?easing:collector;var anim=R.animation(params,ms,easing,collector);item=this.items[--i].animate(anim);while(i--){this.items[i]&&!this.items[i].removed&&this.items[i].animateWith(item,anim,anim);}
return this;};setproto.insertAfter=function(el){var i=this.items.length;while(i--){this.items[i].insertAfter(el);}
return this;};setproto.getBBox=function(){var x=[],y=[],w=[],h=[];for(var i=this.items.length;i--;)if(!this.items[i].removed){var box=this.items[i].getBBox();x.push(box.x);y.push(box.y);w.push(box.x+box.width);h.push(box.y+box.height);}
x=mmin[apply](0,x);y=mmin[apply](0,y);return{x:x,y:y,width:mmax[apply](0,w)-x,height:mmax[apply](0,h)-y};};setproto.clone=function(s){s=new Set;for(var i=0,ii=this.items.length;i<ii;i++){s.push(this.items[i].clone());}
return s;};setproto.toString=function(){return"Rapha\xebl\u2018s set";};R.registerFont=function(font){if(!font.face){return font;}
this.fonts=this.fonts||{};var fontcopy={w:font.w,face:{},glyphs:{}},family=font.face["font-family"];for(var prop in font.face)if(font.face[has](prop)){fontcopy.face[prop]=font.face[prop];}
if(this.fonts[family]){this.fonts[family].push(fontcopy);}else{this.fonts[family]=[fontcopy];}
if(!font.svg){fontcopy.face["units-per-em"]=toInt(font.face["units-per-em"],10);for(var glyph in font.glyphs)if(font.glyphs[has](glyph)){var path=font.glyphs[glyph];fontcopy.glyphs[glyph]={w:path.w,k:{},d:path.d&&"M"+path.d.replace(/[mlcxtrv]/g,function(command){return{l:"L",c:"C",x:"z",t:"m",r:"l",v:"c"}[command]||"M";})+"z"};if(path.k){for(var k in path.k)if(path[has](k)){fontcopy.glyphs[glyph].k[k]=path.k[k];}}}}
return font;};paperproto.getFont=function(family,weight,style,stretch){stretch=stretch||"normal";style=style||"normal";weight=+weight||{normal:400,bold:700,lighter:300,bolder:800}[weight]||400;if(!R.fonts){return;}
var font=R.fonts[family];if(!font){var name=new RegExp("(^|\\s)"+family.replace(/[^\w\d\s+!~.:_-]/g,E)+"(\\s|$)","i");for(var fontName in R.fonts)if(R.fonts[has](fontName)){if(name.test(fontName)){font=R.fonts[fontName];break;}}}
var thefont;if(font){for(var i=0,ii=font.length;i<ii;i++){thefont=font[i];if(thefont.face["font-weight"]==weight&&(thefont.face["font-style"]==style||!thefont.face["font-style"])&&thefont.face["font-stretch"]==stretch){break;}}}
return thefont;};paperproto.print=function(x,y,string,font,size,origin,letter_spacing){origin=origin||"middle";letter_spacing=mmax(mmin(letter_spacing||0,1),-1);var out=this.set(),letters=Str(string)[split](E),shift=0,path=E,scale;R.is(font,string)&&(font=this.getFont(font));if(font){scale=(size||16)/font.face["units-per-em"];var bb=font.face.bbox[split](separator),top=+bb[0],height=+bb[1]+(origin=="baseline"?bb[3]-bb[1]+(+font.face.descent):(bb[3]-bb[1])/2);for(var i=0,ii=letters.length;i<ii;i++){var prev=i&&font.glyphs[letters[i-1]]||{},curr=font.glyphs[letters[i]];shift+=i?(prev.w||font.w)+(prev.k&&prev.k[letters[i]]||0)+(font.w*letter_spacing):0;curr&&curr.d&&out.push(this.path(curr.d).attr({fill:"#000",stroke:"none",transform:[["t",shift*scale,0]]}));}
out.transform(["...s",scale,scale,top,height,"t",(x-top)/scale,(y-height)/scale]);}
return out;};paperproto.add=function(json){if(R.is(json,"array")){var res=this.set(),i=0,ii=json.length,j;for(;i<ii;i++){j=json[i]||{};elements[has](j.type)&&res.push(this[j.type]().attr(j));}}
return res;};R.format=function(token,params){var args=R.is(params,array)?[0][concat](params):arguments;token&&R.is(token,string)&&args.length-1&&(token=token.replace(formatrg,function(str,i){return args[++i]==null?E:args[i];}));return token||E;};R.fullfill=(function(){var tokenRegex=/\{([^\}]+)\}/g,objNotationRegex=/(?:(?:^|\.)(.+?)(?=\[|\.|$|\()|\[('|")(.+?)\2\])(\(\))?/g,replacer=function(all,key,obj){var res=obj;key.replace(objNotationRegex,function(all,name,quote,quotedName,isFunc){name=name||quotedName;if(res){if(name in res){res=res[name];}
typeof res=="function"&&isFunc&&(res=res());}});res=(res==null||res==obj?all:res)+"";return res;};return function(str,obj){return String(str).replace(tokenRegex,function(all,key){return replacer(all,key,obj);});};})();R.ninja=function(){oldRaphael.was?(g.win.Raphael=oldRaphael.is):delete Raphael;return R;};R.st=setproto;(function(doc,loaded,f){if(doc.readyState==null&&doc.addEventListener){doc.addEventListener(loaded,f=function(){doc.removeEventListener(loaded,f,false);doc.readyState="complete";},false);doc.readyState="loading";}
function isLoaded(){(/in/).test(doc.readyState)?setTimeout(isLoaded,9):R.eve("DOMload");}
isLoaded();})(document,"DOMContentLoaded");oldRaphael.was?(g.win.Raphael=R):(Raphael=R);eve.on("DOMload",function(){loaded=true;});})();window.Raphael.svg&&function(R){var has="hasOwnProperty",Str=String,toFloat=parseFloat,toInt=parseInt,math=Math,mmax=math.max,abs=math.abs,pow=math.pow,separator=/[, ]+/,eve=R.eve,E="",S=" ";var xlink="http://www.w3.org/1999/xlink",markers={block:"M5,0 0,2.5 5,5z",classic:"M5,0 0,2.5 5,5 3.5,3 3.5,2z",diamond:"M2.5,0 5,2.5 2.5,5 0,2.5z",open:"M6,1 1,3.5 6,6",oval:"M2.5,0A2.5,2.5,0,0,1,2.5,5 2.5,2.5,0,0,1,2.5,0z"},markerCounter={};R.toString=function(){return"Your browser supports SVG.\nYou are running Rapha\xebl "+this.version;};var $=function(el,attr){if(attr){if(typeof el=="string"){el=$(el);}
for(var key in attr)if(attr[has](key)){if(key.substring(0,6)=="xlink:"){el.setAttributeNS(xlink,key.substring(6),Str(attr[key]));}else{el.setAttribute(key,Str(attr[key]));}}}else{el=R._g.doc.createElementNS("http://www.w3.org/2000/svg",el);el.style&&(el.style.webkitTapHighlightColor="rgba(0,0,0,0)");}
return el;},addGradientFill=function(element,gradient){var type="linear",id=element.id+gradient,fx=.5,fy=.5,o=element.node,SVG=element.paper,s=o.style,el=R._g.doc.getElementById(id);if(!el){gradient=Str(gradient).replace(R._radial_gradient,function(all,_fx,_fy){type="radial";if(_fx&&_fy){fx=toFloat(_fx);fy=toFloat(_fy);var dir=((fy>.5)*2-1);pow(fx-.5,2)+pow(fy-.5,2)>.25&&(fy=math.sqrt(.25-pow(fx-.5,2))*dir+.5)&&fy!=.5&&(fy=fy.toFixed(5)-1e-5*dir);}
return E;});gradient=gradient.split(/\s*\-\s*/);if(type=="linear"){var angle=gradient.shift();angle=-toFloat(angle);if(isNaN(angle)){return null;}
var vector=[0,0,math.cos(R.rad(angle)),math.sin(R.rad(angle))],max=1/(mmax(abs(vector[2]),abs(vector[3]))||1);vector[2]*=max;vector[3]*=max;if(vector[2]<0){vector[0]=-vector[2];vector[2]=0;}
if(vector[3]<0){vector[1]=-vector[3];vector[3]=0;}}
var dots=R._parseDots(gradient);if(!dots){return null;}
id=id.replace(/[\(\)\s,\xb0#]/g,"_");if(element.gradient&&id!=element.gradient.id){SVG.defs.removeChild(element.gradient);delete element.gradient;}
if(!element.gradient){el=$(type+"Gradient",{id:id});element.gradient=el;$(el,type=="radial"?{fx:fx,fy:fy}:{x1:vector[0],y1:vector[1],x2:vector[2],y2:vector[3],gradientTransform:element.matrix.invert()});SVG.defs.appendChild(el);for(var i=0,ii=dots.length;i<ii;i++){el.appendChild($("stop",{offset:dots[i].offset?dots[i].offset:i?"100%":"0%","stop-color":dots[i].color||"#fff"}));}}}
$(o,{fill:"url(#"+id+")",opacity:1,"fill-opacity":1});s.fill=E;s.opacity=1;s.fillOpacity=1;return 1;},updatePosition=function(o){var bbox=o.getBBox(1);$(o.pattern,{patternTransform:o.matrix.invert()+" translate("+bbox.x+","+bbox.y+")"});},addArrow=function(o,value,isEnd){if(o.type=="path"){var values=Str(value).toLowerCase().split("-"),p=o.paper,se=isEnd?"end":"start",node=o.node,attrs=o.attrs,stroke=attrs["stroke-width"],i=values.length,type="classic",from,to,dx,refX,attr,w=3,h=3,t=5;while(i--){switch(values[i]){case"block":case"classic":case"oval":case"diamond":case"open":case"none":type=values[i];break;case"wide":h=5;break;case"narrow":h=2;break;case"long":w=5;break;case"short":w=2;break;}}
if(type=="open"){w+=2;h+=2;t+=2;dx=1;refX=isEnd?4:1;attr={fill:"none",stroke:attrs.stroke};}else{refX=dx=w/2;attr={fill:attrs.stroke,stroke:"none"};}
if(o._.arrows){if(isEnd){o._.arrows.endPath&&markerCounter[o._.arrows.endPath]--;o._.arrows.endMarker&&markerCounter[o._.arrows.endMarker]--;}else{o._.arrows.startPath&&markerCounter[o._.arrows.startPath]--;o._.arrows.startMarker&&markerCounter[o._.arrows.startMarker]--;}}else{o._.arrows={};}
if(type!="none"){var pathId="raphael-marker-"+type,markerId="raphael-marker-"+se+type+w+h+o.id;if(!R._g.doc.getElementById(pathId)){p.defs.appendChild($($("path"),{"stroke-linecap":"round",d:markers[type],id:pathId}));markerCounter[pathId]=1;}else{markerCounter[pathId]++;}
var marker=R._g.doc.getElementById(markerId),use;if(!marker){marker=$($("marker"),{id:markerId,markerHeight:h,markerWidth:w,orient:"auto",refX:refX,refY:h/2});use=$($("use"),{"xlink:href":"#"+pathId,transform:(isEnd?"rotate(180 "+w/2+" "+h/2+") ":E)+"scale("+w/t+","+h/t+")","stroke-width":(1/((w/t+h/t)/2)).toFixed(4)});marker.appendChild(use);p.defs.appendChild(marker);markerCounter[markerId]=1;}else{markerCounter[markerId]++;use=marker.getElementsByTagName("use")[0];}
$(use,attr);var delta=dx*(type!="diamond"&&type!="oval");if(isEnd){from=o._.arrows.startdx*stroke||0;to=R.getTotalLength(attrs.path)-delta*stroke;}else{from=delta*stroke;to=R.getTotalLength(attrs.path)-(o._.arrows.enddx*stroke||0);}
attr={};attr["marker-"+se]="url(#"+markerId+")";if(to||from){attr.d=Raphael.getSubpath(attrs.path,from,to);}
$(node,attr);o._.arrows[se+"Path"]=pathId;o._.arrows[se+"Marker"]=markerId;o._.arrows[se+"dx"]=delta;o._.arrows[se+"Type"]=type;o._.arrows[se+"String"]=value;}else{if(isEnd){from=o._.arrows.startdx*stroke||0;to=R.getTotalLength(attrs.path)-from;}else{from=0;to=R.getTotalLength(attrs.path)-(o._.arrows.enddx*stroke||0);}
o._.arrows[se+"Path"]&&$(node,{d:Raphael.getSubpath(attrs.path,from,to)});delete o._.arrows[se+"Path"];delete o._.arrows[se+"Marker"];delete o._.arrows[se+"dx"];delete o._.arrows[se+"Type"];delete o._.arrows[se+"String"];}
for(attr in markerCounter)if(markerCounter[has](attr)&&!markerCounter[attr]){var item=R._g.doc.getElementById(attr);item&&item.parentNode.removeChild(item);}}},dasharray={"":[0],"none":[0],"-":[3,1],".":[1,1],"-.":[3,1,1,1],"-..":[3,1,1,1,1,1],". ":[1,3],"- ":[4,3],"--":[8,3],"- .":[4,3,1,3],"--.":[8,3,1,3],"--..":[8,3,1,3,1,3]},addDashes=function(o,value,params){value=dasharray[Str(value).toLowerCase()];if(value){var width=o.attrs["stroke-width"]||"1",butt={round:width,square:width,butt:0}[o.attrs["stroke-linecap"]||params["stroke-linecap"]]||0,dashes=[],i=value.length;while(i--){dashes[i]=value[i]*width+((i%2)?1:-1)*butt;}
$(o.node,{"stroke-dasharray":dashes.join(",")});}},setFillAndStroke=function(o,params){var node=o.node,attrs=o.attrs,vis=node.style.visibility;node.style.visibility="hidden";for(var att in params){if(params[has](att)){if(!R._availableAttrs[has](att)){continue;}
var value=params[att];attrs[att]=value;switch(att){case"blur":o.blur(value);break;case"href":case"title":case"target":var pn=node.parentNode;if(pn.tagName.toLowerCase()!="a"){var hl=$("a");pn.insertBefore(hl,node);hl.appendChild(node);pn=hl;}
if(att=="target"){pn.setAttributeNS(xlink,"show",value=="blank"?"new":value);}else{pn.setAttributeNS(xlink,att,value);}
break;case"cursor":node.style.cursor=value;break;case"transform":o.transform(value);break;case"arrow-start":addArrow(o,value);break;case"arrow-end":addArrow(o,value,1);break;case"clip-rect":var rect=Str(value).split(separator);if(rect.length==4){o.clip&&o.clip.parentNode.parentNode.removeChild(o.clip.parentNode);var el=$("clipPath"),rc=$("rect");el.id=R.createUUID();$(rc,{x:rect[0],y:rect[1],width:rect[2],height:rect[3]});el.appendChild(rc);o.paper.defs.appendChild(el);$(node,{"clip-path":"url(#"+el.id+")"});o.clip=rc;}
if(!value){var path=node.getAttribute("clip-path");if(path){var clip=R._g.doc.getElementById(path.replace(/(^url\(#|\)$)/g,E));clip&&clip.parentNode.removeChild(clip);$(node,{"clip-path":E});delete o.clip;}}
break;case"path":if(o.type=="path"){$(node,{d:value?attrs.path=R._pathToAbsolute(value):"M0,0"});o._.dirty=1;if(o._.arrows){"startString"in o._.arrows&&addArrow(o,o._.arrows.startString);"endString"in o._.arrows&&addArrow(o,o._.arrows.endString,1);}}
break;case"width":node.setAttribute(att,value);o._.dirty=1;if(attrs.fx){att="x";value=attrs.x;}else{break;}
case"x":if(attrs.fx){value=-attrs.x-(attrs.width||0);}
case"rx":if(att=="rx"&&o.type=="rect"){break;}
case"cx":node.setAttribute(att,value);o.pattern&&updatePosition(o);o._.dirty=1;break;case"height":node.setAttribute(att,value);o._.dirty=1;if(attrs.fy){att="y";value=attrs.y;}else{break;}
case"y":if(attrs.fy){value=-attrs.y-(attrs.height||0);}
case"ry":if(att=="ry"&&o.type=="rect"){break;}
case"cy":node.setAttribute(att,value);o.pattern&&updatePosition(o);o._.dirty=1;break;case"r":if(o.type=="rect"){$(node,{rx:value,ry:value});}else{node.setAttribute(att,value);}
o._.dirty=1;break;case"src":if(o.type=="image"){node.setAttributeNS(xlink,"href",value);}
break;case"stroke-width":if(o._.sx!=1||o._.sy!=1){value/=mmax(abs(o._.sx),abs(o._.sy))||1;}
if(o.paper._vbSize){value*=o.paper._vbSize;}
node.setAttribute(att,value);if(attrs["stroke-dasharray"]){addDashes(o,attrs["stroke-dasharray"],params);}
if(o._.arrows){"startString"in o._.arrows&&addArrow(o,o._.arrows.startString);"endString"in o._.arrows&&addArrow(o,o._.arrows.endString,1);}
break;case"stroke-dasharray":addDashes(o,value,params);break;case"fill":var isURL=Str(value).match(R._ISURL);if(isURL){el=$("pattern");var ig=$("image");el.id=R.createUUID();$(el,{x:0,y:0,patternUnits:"userSpaceOnUse",height:1,width:1});$(ig,{x:0,y:0,"xlink:href":isURL[1]});el.appendChild(ig);(function(el){R._preload(isURL[1],function(){var w=this.offsetWidth,h=this.offsetHeight;$(el,{width:w,height:h});$(ig,{width:w,height:h});o.paper.safari();});})(el);o.paper.defs.appendChild(el);$(node,{fill:"url(#"+el.id+")"});o.pattern=el;o.pattern&&updatePosition(o);break;}
var clr=R.getRGB(value);if(!clr.error){delete params.gradient;delete attrs.gradient;!R.is(attrs.opacity,"undefined")&&R.is(params.opacity,"undefined")&&$(node,{opacity:attrs.opacity});!R.is(attrs["fill-opacity"],"undefined")&&R.is(params["fill-opacity"],"undefined")&&$(node,{"fill-opacity":attrs["fill-opacity"]});}else if((o.type=="circle"||o.type=="ellipse"||Str(value).charAt()!="r")&&addGradientFill(o,value)){if("opacity"in attrs||"fill-opacity"in attrs){var gradient=R._g.doc.getElementById(node.getAttribute("fill").replace(/^url\(#|\)$/g,E));if(gradient){var stops=gradient.getElementsByTagName("stop");$(stops[stops.length-1],{"stop-opacity":("opacity"in attrs?attrs.opacity:1)*("fill-opacity"in attrs?attrs["fill-opacity"]:1)});}}
attrs.gradient=value;attrs.fill="none";break;}
clr[has]("opacity")&&$(node,{"fill-opacity":clr.opacity>1?clr.opacity/100:clr.opacity});case"stroke":clr=R.getRGB(value);node.setAttribute(att,clr.hex);att=="stroke"&&clr[has]("opacity")&&$(node,{"stroke-opacity":clr.opacity>1?clr.opacity/100:clr.opacity});if(att=="stroke"&&o._.arrows){"startString"in o._.arrows&&addArrow(o,o._.arrows.startString);"endString"in o._.arrows&&addArrow(o,o._.arrows.endString,1);}
break;case"gradient":(o.type=="circle"||o.type=="ellipse"||Str(value).charAt()!="r")&&addGradientFill(o,value);break;case"opacity":if(attrs.gradient&&!attrs[has]("stroke-opacity")){$(node,{"stroke-opacity":value>1?value/100:value});}
case"fill-opacity":if(attrs.gradient){gradient=R._g.doc.getElementById(node.getAttribute("fill").replace(/^url\(#|\)$/g,E));if(gradient){stops=gradient.getElementsByTagName("stop");$(stops[stops.length-1],{"stop-opacity":value});}
break;}
default:att=="font-size"&&(value=toInt(value,10)+"px");var cssrule=att.replace(/(\-.)/g,function(w){return w.substring(1).toUpperCase();});node.style[cssrule]=value;o._.dirty=1;node.setAttribute(att,value);break;}}}
tuneText(o,params);node.style.visibility=vis;},leading=1.2,tuneText=function(el,params){if(el.type!="text"||!(params[has]("text")||params[has]("font")||params[has]("font-size")||params[has]("x")||params[has]("y"))){return;}
var a=el.attrs,node=el.node,fontSize=node.firstChild?toInt(R._g.doc.defaultView.getComputedStyle(node.firstChild,E).getPropertyValue("font-size"),10):10;if(params[has]("text")){a.text=params.text;while(node.firstChild){node.removeChild(node.firstChild);}
var texts=Str(params.text).split("\n"),tspans=[],tspan;for(var i=0,ii=texts.length;i<ii;i++){tspan=$("tspan");i&&$(tspan,{dy:fontSize*leading,x:a.x});tspan.appendChild(R._g.doc.createTextNode(texts[i]));node.appendChild(tspan);tspans[i]=tspan;}}else{tspans=node.getElementsByTagName("tspan");for(i=0,ii=tspans.length;i<ii;i++)if(i){$(tspans[i],{dy:fontSize*leading,x:a.x});}else{$(tspans[0],{dy:0});}}
$(node,{x:a.x,y:a.y});el._.dirty=1;var bb=el._getBBox(),dif=a.y-(bb.y+bb.height/2);dif&&R.is(dif,"finite")&&$(tspans[0],{dy:dif});},Element=function(node,svg){var X=0,Y=0;this[0]=this.node=node;node.raphael=true;this.id=R._oid++;node.raphaelid=this.id;this.matrix=R.matrix();this.realPath=null;this.paper=svg;this.attrs=this.attrs||{};this._={transform:[],sx:1,sy:1,deg:0,dx:0,dy:0,dirty:1};!svg.bottom&&(svg.bottom=this);this.prev=svg.top;svg.top&&(svg.top.next=this);svg.top=this;this.next=null;},elproto=R.el;Element.prototype=elproto;elproto.constructor=Element;R._engine.path=function(pathString,SVG){var el=$("path");SVG.canvas&&SVG.canvas.appendChild(el);var p=new Element(el,SVG);p.type="path";setFillAndStroke(p,{fill:"none",stroke:"#000",path:pathString});return p;};elproto.rotate=function(deg,cx,cy){if(this.removed){return this;}
deg=Str(deg).split(separator);if(deg.length-1){cx=toFloat(deg[1]);cy=toFloat(deg[2]);}
deg=toFloat(deg[0]);(cy==null)&&(cx=cy);if(cx==null||cy==null){var bbox=this.getBBox(1);cx=bbox.x+bbox.width/2;cy=bbox.y+bbox.height/2;}
this.transform(this._.transform.concat([["r",deg,cx,cy]]));return this;};elproto.scale=function(sx,sy,cx,cy){if(this.removed){return this;}
sx=Str(sx).split(separator);if(sx.length-1){sy=toFloat(sx[1]);cx=toFloat(sx[2]);cy=toFloat(sx[3]);}
sx=toFloat(sx[0]);(sy==null)&&(sy=sx);(cy==null)&&(cx=cy);if(cx==null||cy==null){var bbox=this.getBBox(1);}
cx=cx==null?bbox.x+bbox.width/2:cx;cy=cy==null?bbox.y+bbox.height/2:cy;this.transform(this._.transform.concat([["s",sx,sy,cx,cy]]));return this;};elproto.translate=function(dx,dy){if(this.removed){return this;}
dx=Str(dx).split(separator);if(dx.length-1){dy=toFloat(dx[1]);}
dx=toFloat(dx[0])||0;dy=+dy||0;this.transform(this._.transform.concat([["t",dx,dy]]));return this;};elproto.transform=function(tstr){var _=this._;if(tstr==null){return _.transform;}
R._extractTransform(this,tstr);this.clip&&$(this.clip,{transform:this.matrix.invert()});this.pattern&&updatePosition(this);this.node&&$(this.node,{transform:this.matrix});if(_.sx!=1||_.sy!=1){var sw=this.attrs[has]("stroke-width")?this.attrs["stroke-width"]:1;this.attr({"stroke-width":sw});}
return this;};elproto.hide=function(){!this.removed&&this.paper.safari(this.node.style.display="none");return this;};elproto.show=function(){!this.removed&&this.paper.safari(this.node.style.display="");return this;};elproto.remove=function(){if(this.removed){return;}
var paper=this.paper;paper.__set__&&paper.__set__.exclude(this);eve.unbind("*.*."+this.id);if(this.gradient){paper.defs.removeChild(this.gradient);}
R._tear(this,paper);if(this.node.parentNode.tagName.toLowerCase()=="a"){this.node.parentNode.parentNode.removeChild(this.node.parentNode);}else{this.node.parentNode.removeChild(this.node);}
for(var i in this){this[i]=typeof this[i]=="function"?R._removedFactory(i):null;}
this.removed=true;};elproto._getBBox=function(){if(this.node.style.display=="none"){this.show();var hide=true;}
var bbox={};try{bbox=this.node.getBBox();}catch(e){}finally{bbox=bbox||{};}
hide&&this.hide();return bbox;};elproto.attr=function(name,value){if(this.removed){return this;}
if(name==null){var res={};for(var a in this.attrs)if(this.attrs[has](a)){res[a]=this.attrs[a];}
res.gradient&&res.fill=="none"&&(res.fill=res.gradient)&&delete res.gradient;res.transform=this._.transform;return res;}
if(value==null&&R.is(name,"string")){if(name=="fill"&&this.attrs.fill=="none"&&this.attrs.gradient){return this.attrs.gradient;}
if(name=="transform"){return this._.transform;}
var names=name.split(separator),out={};for(var i=0,ii=names.length;i<ii;i++){name=names[i];if(name in this.attrs){out[name]=this.attrs[name];}else if(R.is(this.paper.customAttributes[name],"function")){out[name]=this.paper.customAttributes[name].def;}else{out[name]=R._availableAttrs[name];}}
return ii-1?out:out[names[0]];}
if(value==null&&R.is(name,"array")){out={};for(i=0,ii=name.length;i<ii;i++){out[name[i]]=this.attr(name[i]);}
return out;}
if(value!=null){var params={};params[name]=value;}else if(name!=null&&R.is(name,"object")){params=name;}
for(var key in params){eve("attr."+key+"."+this.id,this,params[key]);}
for(key in this.paper.customAttributes)if(this.paper.customAttributes[has](key)&&params[has](key)&&R.is(this.paper.customAttributes[key],"function")){var par=this.paper.customAttributes[key].apply(this,[].concat(params[key]));this.attrs[key]=params[key];for(var subkey in par)if(par[has](subkey)){params[subkey]=par[subkey];}}
setFillAndStroke(this,params);return this;};elproto.toFront=function(){if(this.removed){return this;}
if(this.node.parentNode.tagName.toLowerCase()=="a"){this.node.parentNode.parentNode.appendChild(this.node.parentNode);}else{this.node.parentNode.appendChild(this.node);}
var svg=this.paper;svg.top!=this&&R._tofront(this,svg);return this;};elproto.toBack=function(){if(this.removed){return this;}
var parent=this.node.parentNode;if(parent.tagName.toLowerCase()=="a"){parent.parentNode.insertBefore(this.node.parentNode,this.node.parentNode.parentNode.firstChild);}else if(parent.firstChild!=this.node){parent.insertBefore(this.node,this.node.parentNode.firstChild);}
R._toback(this,this.paper);var svg=this.paper;return this;};elproto.insertAfter=function(element){if(this.removed){return this;}
var node=element.node||element[element.length-1].node;if(node.nextSibling){node.parentNode.insertBefore(this.node,node.nextSibling);}else{node.parentNode.appendChild(this.node);}
R._insertafter(this,element,this.paper);return this;};elproto.insertBefore=function(element){if(this.removed){return this;}
var node=element.node||element[0].node;node.parentNode.insertBefore(this.node,node);R._insertbefore(this,element,this.paper);return this;};elproto.blur=function(size){var t=this;if(+size!==0){var fltr=$("filter"),blur=$("feGaussianBlur");t.attrs.blur=size;fltr.id=R.createUUID();$(blur,{stdDeviation:+size||1.5});fltr.appendChild(blur);t.paper.defs.appendChild(fltr);t._blur=fltr;$(t.node,{filter:"url(#"+fltr.id+")"});}else{if(t._blur){t._blur.parentNode.removeChild(t._blur);delete t._blur;delete t.attrs.blur;}
t.node.removeAttribute("filter");}};R._engine.circle=function(svg,x,y,r){var el=$("circle");svg.canvas&&svg.canvas.appendChild(el);var res=new Element(el,svg);res.attrs={cx:x,cy:y,r:r,fill:"none",stroke:"#000"};res.type="circle";$(el,res.attrs);return res;};R._engine.rect=function(svg,x,y,w,h,r){var el=$("rect");svg.canvas&&svg.canvas.appendChild(el);var res=new Element(el,svg);res.attrs={x:x,y:y,width:w,height:h,r:r||0,rx:r||0,ry:r||0,fill:"none",stroke:"#000"};res.type="rect";$(el,res.attrs);return res;};R._engine.ellipse=function(svg,x,y,rx,ry){var el=$("ellipse");svg.canvas&&svg.canvas.appendChild(el);var res=new Element(el,svg);res.attrs={cx:x,cy:y,rx:rx,ry:ry,fill:"none",stroke:"#000"};res.type="ellipse";$(el,res.attrs);return res;};R._engine.image=function(svg,src,x,y,w,h){var el=$("image");$(el,{x:x,y:y,width:w,height:h,preserveAspectRatio:"none"});el.setAttributeNS(xlink,"href",src);svg.canvas&&svg.canvas.appendChild(el);var res=new Element(el,svg);res.attrs={x:x,y:y,width:w,height:h,src:src};res.type="image";return res;};R._engine.text=function(svg,x,y,text){var el=$("text");svg.canvas&&svg.canvas.appendChild(el);var res=new Element(el,svg);res.attrs={x:x,y:y,"text-anchor":"middle",text:text,font:R._availableAttrs.font,stroke:"none",fill:"#000"};res.type="text";setFillAndStroke(res,res.attrs);return res;};R._engine.setSize=function(width,height){this.width=width||this.width;this.height=height||this.height;this.canvas.setAttribute("width",this.width);this.canvas.setAttribute("height",this.height);if(this._viewBox){this.setViewBox.apply(this,this._viewBox);}
return this;};R._engine.create=function(){var con=R._getContainer.apply(0,arguments),container=con&&con.container,x=con.x,y=con.y,width=con.width,height=con.height;if(!container){throw new Error("SVG container not found.");}
var cnvs=$("svg"),css="overflow:hidden;",isFloating;x=x||0;y=y||0;width=width||512;height=height||342;$(cnvs,{height:height,version:1.1,width:width,xmlns:"http://www.w3.org/2000/svg"});if(container==1){cnvs.style.cssText=css+"position:absolute;left:"+x+"px;top:"+y+"px";R._g.doc.body.appendChild(cnvs);isFloating=1;}else{cnvs.style.cssText=css+"position:relative";if(container.firstChild){container.insertBefore(cnvs,container.firstChild);}else{container.appendChild(cnvs);}}
container=new R._Paper;container.width=width;container.height=height;container.canvas=cnvs;container.clear();container._left=container._top=0;isFloating&&(container.renderfix=function(){});container.renderfix();return container;};R._engine.setViewBox=function(x,y,w,h,fit){eve("setViewBox",this,this._viewBox,[x,y,w,h,fit]);var size=mmax(w/this.width,h/this.height),top=this.top,aspectRatio=fit?"meet":"xMinYMin",vb,sw;if(x==null){if(this._vbSize){size=1;}
delete this._vbSize;vb="0 0 "+this.width+S+this.height;}else{this._vbSize=size;vb=x+S+y+S+w+S+h;}
$(this.canvas,{viewBox:vb,preserveAspectRatio:aspectRatio});while(size&&top){sw="stroke-width"in top.attrs?top.attrs["stroke-width"]:1;top.attr({"stroke-width":sw});top._.dirty=1;top._.dirtyT=1;top=top.prev;}
this._viewBox=[x,y,w,h,!!fit];return this;};R.prototype.renderfix=function(){var cnvs=this.canvas,s=cnvs.style,pos;try{pos=cnvs.getScreenCTM()||cnvs.createSVGMatrix();}catch(e){pos=cnvs.createSVGMatrix();}
var left=-pos.e%1,top=-pos.f%1;if(left||top){if(left){this._left=(this._left+left)%1;s.left=this._left+"px";}
if(top){this._top=(this._top+top)%1;s.top=this._top+"px";}}};R.prototype.clear=function(){R.eve("clear",this);var c=this.canvas;while(c.firstChild){c.removeChild(c.firstChild);}
this.bottom=this.top=null;(this.desc=$("desc")).appendChild(R._g.doc.createTextNode("Created with Rapha\xebl "+R.version));c.appendChild(this.desc);c.appendChild(this.defs=$("defs"));};R.prototype.remove=function(){eve("remove",this);this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);for(var i in this){this[i]=typeof this[i]=="function"?R._removedFactory(i):null;}};var setproto=R.st;for(var method in elproto)if(elproto[has](method)&&!setproto[has](method)){setproto[method]=(function(methodname){return function(){var arg=arguments;return this.forEach(function(el){el[methodname].apply(el,arg);});};})(method);}}(window.Raphael);window.Raphael.vml&&function(R){var has="hasOwnProperty",Str=String,toFloat=parseFloat,math=Math,round=math.round,mmax=math.max,mmin=math.min,abs=math.abs,fillString="fill",separator=/[, ]+/,eve=R.eve,ms=" progid:DXImageTransform.Microsoft",S=" ",E="",map={M:"m",L:"l",C:"c",Z:"x",m:"t",l:"r",c:"v",z:"x"},bites=/([clmz]),?([^clmz]*)/gi,blurregexp=/ progid:\S+Blur\([^\)]+\)/g,val=/-?[^,\s-]+/g,cssDot="position:absolute;left:0;top:0;width:1px;height:1px",zoom=21600,pathTypes={path:1,rect:1,image:1},ovalTypes={circle:1,ellipse:1},path2vml=function(path){var total=/[ahqstv]/ig,command=R._pathToAbsolute;Str(path).match(total)&&(command=R._path2curve);total=/[clmz]/g;if(command==R._pathToAbsolute&&!Str(path).match(total)){var res=Str(path).replace(bites,function(all,command,args){var vals=[],isMove=command.toLowerCase()=="m",res=map[command];args.replace(val,function(value){if(isMove&&vals.length==2){res+=vals+map[command=="m"?"l":"L"];vals=[];}
vals.push(round(value*zoom));});return res+vals;});return res;}
var pa=command(path),p,r;res=[];for(var i=0,ii=pa.length;i<ii;i++){p=pa[i];r=pa[i][0].toLowerCase();r=="z"&&(r="x");for(var j=1,jj=p.length;j<jj;j++){r+=round(p[j]*zoom)+(j!=jj-1?",":E);}
res.push(r);}
return res.join(S);},compensation=function(deg,dx,dy){var m=R.matrix();m.rotate(-deg,.5,.5);return{dx:m.x(dx,dy),dy:m.y(dx,dy)};},setCoords=function(p,sx,sy,dx,dy,deg){var _=p._,m=p.matrix,fillpos=_.fillpos,o=p.node,s=o.style,y=1,flip="",dxdy,kx=zoom/sx,ky=zoom/sy;s.visibility="hidden";if(!sx||!sy){return;}
o.coordsize=abs(kx)+S+abs(ky);s.rotation=deg*(sx*sy<0?-1:1);if(deg){var c=compensation(deg,dx,dy);dx=c.dx;dy=c.dy;}
sx<0&&(flip+="x");sy<0&&(flip+=" y")&&(y=-1);s.flip=flip;o.coordorigin=(dx*-kx)+S+(dy*-ky);if(fillpos||_.fillsize){var fill=o.getElementsByTagName(fillString);fill=fill&&fill[0];o.removeChild(fill);if(fillpos){c=compensation(deg,m.x(fillpos[0],fillpos[1]),m.y(fillpos[0],fillpos[1]));fill.position=c.dx*y+S+c.dy*y;}
if(_.fillsize){fill.size=_.fillsize[0]*abs(sx)+S+_.fillsize[1]*abs(sy);}
o.appendChild(fill);}
s.visibility="visible";};R.toString=function(){return"Your browser doesn\u2019t support SVG. Falling down to VML.\nYou are running Rapha\xebl "+this.version;};var addArrow=function(o,value,isEnd){var values=Str(value).toLowerCase().split("-"),se=isEnd?"end":"start",i=values.length,type="classic",w="medium",h="medium";while(i--){switch(values[i]){case"block":case"classic":case"oval":case"diamond":case"open":case"none":type=values[i];break;case"wide":case"narrow":h=values[i];break;case"long":case"short":w=values[i];break;}}
var stroke=o.node.getElementsByTagName("stroke")[0];stroke[se+"arrow"]=type;stroke[se+"arrowlength"]=w;stroke[se+"arrowwidth"]=h;},setFillAndStroke=function(o,params){o.attrs=o.attrs||{};var node=o.node,a=o.attrs,s=node.style,xy,newpath=pathTypes[o.type]&&(params.x!=a.x||params.y!=a.y||params.width!=a.width||params.height!=a.height||params.cx!=a.cx||params.cy!=a.cy||params.rx!=a.rx||params.ry!=a.ry||params.r!=a.r),isOval=ovalTypes[o.type]&&(a.cx!=params.cx||a.cy!=params.cy||a.r!=params.r||a.rx!=params.rx||a.ry!=params.ry),res=o;for(var par in params)if(params[has](par)){a[par]=params[par];}
if(newpath){a.path=R._getPath[o.type](o);o._.dirty=1;}
params.href&&(node.href=params.href);params.title&&(node.title=params.title);params.target&&(node.target=params.target);params.cursor&&(s.cursor=params.cursor);"blur"in params&&o.blur(params.blur);if(params.path&&o.type=="path"||newpath){node.path=path2vml(~Str(a.path).toLowerCase().indexOf("r")?R._pathToAbsolute(a.path):a.path);if(o.type=="image"){o._.fillpos=[a.x,a.y];o._.fillsize=[a.width,a.height];setCoords(o,1,1,0,0,0);}}"transform"in params&&o.transform(params.transform);if(isOval){var cx=+a.cx,cy=+a.cy,rx=+a.rx||+a.r||0,ry=+a.ry||+a.r||0;node.path=R.format("ar{0},{1},{2},{3},{4},{1},{4},{1}x",round((cx-rx)*zoom),round((cy-ry)*zoom),round((cx+rx)*zoom),round((cy+ry)*zoom),round(cx*zoom));}
if("clip-rect"in params){var rect=Str(params["clip-rect"]).split(separator);if(rect.length==4){rect[2]=+rect[2]+(+rect[0]);rect[3]=+rect[3]+(+rect[1]);var div=node.clipRect||R._g.doc.createElement("div"),dstyle=div.style;dstyle.clip=R.format("rect({1}px {2}px {3}px {0}px)",rect);if(!node.clipRect){dstyle.position="absolute";dstyle.top=0;dstyle.left=0;dstyle.width=o.paper.width+"px";dstyle.height=o.paper.height+"px";node.parentNode.insertBefore(div,node);div.appendChild(node);node.clipRect=div;}}
if(!params["clip-rect"]){node.clipRect&&(node.clipRect.style.clip="auto");}}
if(o.textpath){var textpathStyle=o.textpath.style;params.font&&(textpathStyle.font=params.font);params["font-family"]&&(textpathStyle.fontFamily='"'+params["font-family"].split(",")[0].replace(/^['"]+|['"]+$/g,E)+'"');params["font-size"]&&(textpathStyle.fontSize=params["font-size"]);params["font-weight"]&&(textpathStyle.fontWeight=params["font-weight"]);params["font-style"]&&(textpathStyle.fontStyle=params["font-style"]);}
if("arrow-start"in params){addArrow(res,params["arrow-start"]);}
if("arrow-end"in params){addArrow(res,params["arrow-end"],1);}
if(params.opacity!=null||params["stroke-width"]!=null||params.fill!=null||params.src!=null||params.stroke!=null||params["stroke-width"]!=null||params["stroke-opacity"]!=null||params["fill-opacity"]!=null||params["stroke-dasharray"]!=null||params["stroke-miterlimit"]!=null||params["stroke-linejoin"]!=null||params["stroke-linecap"]!=null){var fill=node.getElementsByTagName(fillString),newfill=false;fill=fill&&fill[0];!fill&&(newfill=fill=createNode(fillString));if(o.type=="image"&&params.src){fill.src=params.src;}
params.fill&&(fill.on=true);if(fill.on==null||params.fill=="none"||params.fill===null){fill.on=false;}
if(fill.on&&params.fill){var isURL=Str(params.fill).match(R._ISURL);if(isURL){fill.parentNode==node&&node.removeChild(fill);fill.rotate=true;fill.src=isURL[1];fill.type="tile";var bbox=o.getBBox(1);fill.position=bbox.x+S+bbox.y;o._.fillpos=[bbox.x,bbox.y];R._preload(isURL[1],function(){o._.fillsize=[this.offsetWidth,this.offsetHeight];});}else{fill.color=R.getRGB(params.fill).hex;fill.src=E;fill.type="solid";if(R.getRGB(params.fill).error&&(res.type in{circle:1,ellipse:1}||Str(params.fill).charAt()!="r")&&addGradientFill(res,params.fill,fill)){a.fill="none";a.gradient=params.fill;fill.rotate=false;}}}
if("fill-opacity"in params||"opacity"in params){var opacity=((+a["fill-opacity"]+1||2)-1)*((+a.opacity+1||2)-1)*((+R.getRGB(params.fill).o+1||2)-1);opacity=mmin(mmax(opacity,0),1);fill.opacity=opacity;if(fill.src){fill.color="none";}}
node.appendChild(fill);var stroke=(node.getElementsByTagName("stroke")&&node.getElementsByTagName("stroke")[0]),newstroke=false;!stroke&&(newstroke=stroke=createNode("stroke"));if((params.stroke&&params.stroke!="none")||params["stroke-width"]||params["stroke-opacity"]!=null||params["stroke-dasharray"]||params["stroke-miterlimit"]||params["stroke-linejoin"]||params["stroke-linecap"]){stroke.on=true;}
(params.stroke=="none"||params.stroke===null||stroke.on==null||params.stroke==0||params["stroke-width"]==0)&&(stroke.on=false);var strokeColor=R.getRGB(params.stroke);stroke.on&&params.stroke&&(stroke.color=strokeColor.hex);opacity=((+a["stroke-opacity"]+1||2)-1)*((+a.opacity+1||2)-1)*((+strokeColor.o+1||2)-1);var width=(toFloat(params["stroke-width"])||1)*.75;opacity=mmin(mmax(opacity,0),1);params["stroke-width"]==null&&(width=a["stroke-width"]);params["stroke-width"]&&(stroke.weight=width);width&&width<1&&(opacity*=width)&&(stroke.weight=1);stroke.opacity=opacity;params["stroke-linejoin"]&&(stroke.joinstyle=params["stroke-linejoin"]||"miter");stroke.miterlimit=params["stroke-miterlimit"]||8;params["stroke-linecap"]&&(stroke.endcap=params["stroke-linecap"]=="butt"?"flat":params["stroke-linecap"]=="square"?"square":"round");if(params["stroke-dasharray"]){var dasharray={"-":"shortdash",".":"shortdot","-.":"shortdashdot","-..":"shortdashdotdot",". ":"dot","- ":"dash","--":"longdash","- .":"dashdot","--.":"longdashdot","--..":"longdashdotdot"};stroke.dashstyle=dasharray[has](params["stroke-dasharray"])?dasharray[params["stroke-dasharray"]]:E;}
newstroke&&node.appendChild(stroke);}
if(res.type=="text"){res.paper.canvas.style.display=E;var span=res.paper.span,m=100,fontSize=a.font&&a.font.match(/\d+(?:\.\d*)?(?=px)/);s=span.style;a.font&&(s.font=a.font);a["font-family"]&&(s.fontFamily=a["font-family"]);a["font-weight"]&&(s.fontWeight=a["font-weight"]);a["font-style"]&&(s.fontStyle=a["font-style"]);fontSize=toFloat(a["font-size"]||fontSize&&fontSize[0])||10;s.fontSize=fontSize*m+"px";res.textpath.string&&(span.innerHTML=Str(res.textpath.string).replace(/</g,"&#60;").replace(/&/g,"&#38;").replace(/\n/g,"<br>"));var brect=span.getBoundingClientRect();res.W=a.w=(brect.right-brect.left)/m;res.H=a.h=(brect.bottom-brect.top)/m;res.X=a.x;res.Y=a.y+res.H/2;("x"in params||"y"in params)&&(res.path.v=R.format("m{0},{1}l{2},{1}",round(a.x*zoom),round(a.y*zoom),round(a.x*zoom)+1));var dirtyattrs=["x","y","text","font","font-family","font-weight","font-style","font-size"];for(var d=0,dd=dirtyattrs.length;d<dd;d++)if(dirtyattrs[d]in params){res._.dirty=1;break;}
switch(a["text-anchor"]){case"start":res.textpath.style["v-text-align"]="left";res.bbx=res.W/2;break;case"end":res.textpath.style["v-text-align"]="right";res.bbx=-res.W/2;break;default:res.textpath.style["v-text-align"]="center";res.bbx=0;break;}
res.textpath.style["v-text-kern"]=true;}},addGradientFill=function(o,gradient,fill){o.attrs=o.attrs||{};var attrs=o.attrs,pow=Math.pow,opacity,oindex,type="linear",fxfy=".5 .5";o.attrs.gradient=gradient;gradient=Str(gradient).replace(R._radial_gradient,function(all,fx,fy){type="radial";if(fx&&fy){fx=toFloat(fx);fy=toFloat(fy);pow(fx-.5,2)+pow(fy-.5,2)>.25&&(fy=math.sqrt(.25-pow(fx-.5,2))*((fy>.5)*2-1)+.5);fxfy=fx+S+fy;}
return E;});gradient=gradient.split(/\s*\-\s*/);if(type=="linear"){var angle=gradient.shift();angle=-toFloat(angle);if(isNaN(angle)){return null;}}
var dots=R._parseDots(gradient);if(!dots){return null;}
o=o.shape||o.node;if(dots.length){o.removeChild(fill);fill.on=true;fill.method="none";fill.color=dots[0].color;fill.color2=dots[dots.length-1].color;var clrs=[];for(var i=0,ii=dots.length;i<ii;i++){dots[i].offset&&clrs.push(dots[i].offset+S+dots[i].color);}
fill.colors=clrs.length?clrs.join():"0% "+fill.color;if(type=="radial"){fill.type="gradientTitle";fill.focus="100%";fill.focussize="0 0";fill.focusposition=fxfy;fill.angle=0;}else{fill.type="gradient";fill.angle=(270-angle)%360;}
o.appendChild(fill);}
return 1;},Element=function(node,vml){this[0]=this.node=node;node.raphael=true;this.id=R._oid++;node.raphaelid=this.id;this.X=0;this.Y=0;this.attrs={};this.paper=vml;this.matrix=R.matrix();this._={transform:[],sx:1,sy:1,dx:0,dy:0,deg:0,dirty:1,dirtyT:1};!vml.bottom&&(vml.bottom=this);this.prev=vml.top;vml.top&&(vml.top.next=this);vml.top=this;this.next=null;};var elproto=R.el;Element.prototype=elproto;elproto.constructor=Element;elproto.transform=function(tstr){if(tstr==null){return this._.transform;}
var vbs=this.paper._viewBoxShift,vbt=vbs?"s"+[vbs.scale,vbs.scale]+"-1-1t"+[vbs.dx,vbs.dy]:E,oldt;if(vbs){oldt=tstr=Str(tstr).replace(/\.{3}|\u2026/g,this._.transform||E);}
R._extractTransform(this,vbt+tstr);var matrix=this.matrix.clone(),skew=this.skew,o=this.node,split,isGrad=~Str(this.attrs.fill).indexOf("-"),isPatt=!Str(this.attrs.fill).indexOf("url(");matrix.translate(-.5,-.5);if(isPatt||isGrad||this.type=="image"){skew.matrix="1 0 0 1";skew.offset="0 0";split=matrix.split();if((isGrad&&split.noRotation)||!split.isSimple){o.style.filter=matrix.toFilter();var bb=this.getBBox(),bbt=this.getBBox(1),dx=bb.x-bbt.x,dy=bb.y-bbt.y;o.coordorigin=(dx*-zoom)+S+(dy*-zoom);setCoords(this,1,1,dx,dy,0);}else{o.style.filter=E;setCoords(this,split.scalex,split.scaley,split.dx,split.dy,split.rotate);}}else{o.style.filter=E;skew.matrix=Str(matrix);skew.offset=matrix.offset();}
oldt&&(this._.transform=oldt);return this;};elproto.rotate=function(deg,cx,cy){if(this.removed){return this;}
if(deg==null){return;}
deg=Str(deg).split(separator);if(deg.length-1){cx=toFloat(deg[1]);cy=toFloat(deg[2]);}
deg=toFloat(deg[0]);(cy==null)&&(cx=cy);if(cx==null||cy==null){var bbox=this.getBBox(1);cx=bbox.x+bbox.width/2;cy=bbox.y+bbox.height/2;}
this._.dirtyT=1;this.transform(this._.transform.concat([["r",deg,cx,cy]]));return this;};elproto.translate=function(dx,dy){if(this.removed){return this;}
dx=Str(dx).split(separator);if(dx.length-1){dy=toFloat(dx[1]);}
dx=toFloat(dx[0])||0;dy=+dy||0;if(this._.bbox){this._.bbox.x+=dx;this._.bbox.y+=dy;}
this.transform(this._.transform.concat([["t",dx,dy]]));return this;};elproto.scale=function(sx,sy,cx,cy){if(this.removed){return this;}
sx=Str(sx).split(separator);if(sx.length-1){sy=toFloat(sx[1]);cx=toFloat(sx[2]);cy=toFloat(sx[3]);isNaN(cx)&&(cx=null);isNaN(cy)&&(cy=null);}
sx=toFloat(sx[0]);(sy==null)&&(sy=sx);(cy==null)&&(cx=cy);if(cx==null||cy==null){var bbox=this.getBBox(1);}
cx=cx==null?bbox.x+bbox.width/2:cx;cy=cy==null?bbox.y+bbox.height/2:cy;this.transform(this._.transform.concat([["s",sx,sy,cx,cy]]));this._.dirtyT=1;return this;};elproto.hide=function(){!this.removed&&(this.node.style.display="none");return this;};elproto.show=function(){!this.removed&&(this.node.style.display=E);return this;};elproto._getBBox=function(){if(this.removed){return{};}
return{x:this.X+(this.bbx||0)-this.W/2,y:this.Y-this.H,width:this.W,height:this.H};};elproto.remove=function(){if(this.removed){return;}
this.paper.__set__&&this.paper.__set__.exclude(this);R.eve.unbind("*.*."+this.id);R._tear(this,this.paper);this.node.parentNode.removeChild(this.node);this.shape&&this.shape.parentNode.removeChild(this.shape);for(var i in this){this[i]=typeof this[i]=="function"?R._removedFactory(i):null;}
this.removed=true;};elproto.attr=function(name,value){if(this.removed){return this;}
if(name==null){var res={};for(var a in this.attrs)if(this.attrs[has](a)){res[a]=this.attrs[a];}
res.gradient&&res.fill=="none"&&(res.fill=res.gradient)&&delete res.gradient;res.transform=this._.transform;return res;}
if(value==null&&R.is(name,"string")){if(name==fillString&&this.attrs.fill=="none"&&this.attrs.gradient){return this.attrs.gradient;}
var names=name.split(separator),out={};for(var i=0,ii=names.length;i<ii;i++){name=names[i];if(name in this.attrs){out[name]=this.attrs[name];}else if(R.is(this.paper.customAttributes[name],"function")){out[name]=this.paper.customAttributes[name].def;}else{out[name]=R._availableAttrs[name];}}
return ii-1?out:out[names[0]];}
if(this.attrs&&value==null&&R.is(name,"array")){out={};for(i=0,ii=name.length;i<ii;i++){out[name[i]]=this.attr(name[i]);}
return out;}
var params;if(value!=null){params={};params[name]=value;}
value==null&&R.is(name,"object")&&(params=name);for(var key in params){eve("attr."+key+"."+this.id,this,params[key]);}
if(params){for(key in this.paper.customAttributes)if(this.paper.customAttributes[has](key)&&params[has](key)&&R.is(this.paper.customAttributes[key],"function")){var par=this.paper.customAttributes[key].apply(this,[].concat(params[key]));this.attrs[key]=params[key];for(var subkey in par)if(par[has](subkey)){params[subkey]=par[subkey];}}
if(params.text&&this.type=="text"){this.textpath.string=params.text;}
setFillAndStroke(this,params);}
return this;};elproto.toFront=function(){!this.removed&&this.node.parentNode.appendChild(this.node);this.paper&&this.paper.top!=this&&R._tofront(this,this.paper);return this;};elproto.toBack=function(){if(this.removed){return this;}
if(this.node.parentNode.firstChild!=this.node){this.node.parentNode.insertBefore(this.node,this.node.parentNode.firstChild);R._toback(this,this.paper);}
return this;};elproto.insertAfter=function(element){if(this.removed){return this;}
if(element.constructor==R.st.constructor){element=element[element.length-1];}
if(element.node.nextSibling){element.node.parentNode.insertBefore(this.node,element.node.nextSibling);}else{element.node.parentNode.appendChild(this.node);}
R._insertafter(this,element,this.paper);return this;};elproto.insertBefore=function(element){if(this.removed){return this;}
if(element.constructor==R.st.constructor){element=element[0];}
element.node.parentNode.insertBefore(this.node,element.node);R._insertbefore(this,element,this.paper);return this;};elproto.blur=function(size){var s=this.node.runtimeStyle,f=s.filter;f=f.replace(blurregexp,E);if(+size!==0){this.attrs.blur=size;s.filter=f+S+ms+".Blur(pixelradius="+(+size||1.5)+")";s.margin=R.format("-{0}px 0 0 -{0}px",round(+size||1.5));}else{s.filter=f;s.margin=0;delete this.attrs.blur;}};R._engine.path=function(pathString,vml){var el=createNode("shape");el.style.cssText=cssDot;el.coordsize=zoom+S+zoom;el.coordorigin=vml.coordorigin;var p=new Element(el,vml),attr={fill:"none",stroke:"#000"};pathString&&(attr.path=pathString);p.type="path";p.path=[];p.Path=E;setFillAndStroke(p,attr);vml.canvas.appendChild(el);var skew=createNode("skew");skew.on=true;el.appendChild(skew);p.skew=skew;p.transform(E);return p;};R._engine.rect=function(vml,x,y,w,h,r){var path=R._rectPath(x,y,w,h,r),res=vml.path(path),a=res.attrs;res.X=a.x=x;res.Y=a.y=y;res.W=a.width=w;res.H=a.height=h;a.r=r;a.path=path;res.type="rect";return res;};R._engine.ellipse=function(vml,x,y,rx,ry){var res=vml.path(),a=res.attrs;res.X=x-rx;res.Y=y-ry;res.W=rx*2;res.H=ry*2;res.type="ellipse";setFillAndStroke(res,{cx:x,cy:y,rx:rx,ry:ry});return res;};R._engine.circle=function(vml,x,y,r){var res=vml.path(),a=res.attrs;res.X=x-r;res.Y=y-r;res.W=res.H=r*2;res.type="circle";setFillAndStroke(res,{cx:x,cy:y,r:r});return res;};R._engine.image=function(vml,src,x,y,w,h){var path=R._rectPath(x,y,w,h),res=vml.path(path).attr({stroke:"none"}),a=res.attrs,node=res.node,fill=node.getElementsByTagName(fillString)[0];a.src=src;res.X=a.x=x;res.Y=a.y=y;res.W=a.width=w;res.H=a.height=h;a.path=path;res.type="image";fill.parentNode==node&&node.removeChild(fill);fill.rotate=true;fill.src=src;fill.type="tile";res._.fillpos=[x,y];res._.fillsize=[w,h];node.appendChild(fill);setCoords(res,1,1,0,0,0);return res;};R._engine.text=function(vml,x,y,text){var el=createNode("shape"),path=createNode("path"),o=createNode("textpath");x=x||0;y=y||0;text=text||"";path.v=R.format("m{0},{1}l{2},{1}",round(x*zoom),round(y*zoom),round(x*zoom)+1);path.textpathok=true;o.string=Str(text);o.on=true;el.style.cssText=cssDot;el.coordsize=zoom+S+zoom;el.coordorigin="0 0";var p=new Element(el,vml),attr={fill:"#000",stroke:"none",font:R._availableAttrs.font,text:text};p.shape=el;p.path=path;p.textpath=o;p.type="text";p.attrs.text=Str(text);p.attrs.x=x;p.attrs.y=y;p.attrs.w=1;p.attrs.h=1;setFillAndStroke(p,attr);el.appendChild(o);el.appendChild(path);vml.canvas.appendChild(el);var skew=createNode("skew");skew.on=true;el.appendChild(skew);p.skew=skew;p.transform(E);return p;};R._engine.setSize=function(width,height){var cs=this.canvas.style;this.width=width;this.height=height;width==+width&&(width+="px");height==+height&&(height+="px");cs.width=width;cs.height=height;cs.clip="rect(0 "+width+" "+height+" 0)";if(this._viewBox){R._engine.setViewBox.apply(this,this._viewBox);}
return this;};R._engine.setViewBox=function(x,y,w,h,fit){R.eve("setViewBox",this,this._viewBox,[x,y,w,h,fit]);var width=this.width,height=this.height,size=1/mmax(w/width,h/height),H,W;if(fit){H=height/h;W=width/w;if(w*H<width){x-=(width-w*H)/2/H;}
if(h*W<height){y-=(height-h*W)/2/W;}}
this._viewBox=[x,y,w,h,!!fit];this._viewBoxShift={dx:-x,dy:-y,scale:size};this.forEach(function(el){el.transform("...");});return this;};var createNode;R._engine.initWin=function(win){var doc=win.document;doc.createStyleSheet().addRule(".rvml","behavior:url(#default#VML)");try{!doc.namespaces.rvml&&doc.namespaces.add("rvml","urn:schemas-microsoft-com:vml");createNode=function(tagName){return doc.createElement('<rvml:'+tagName+' class="rvml">');};}catch(e){createNode=function(tagName){return doc.createElement('<'+tagName+' xmlns="urn:schemas-microsoft.com:vml" class="rvml">');};}};R._engine.initWin(R._g.win);R._engine.create=function(){var con=R._getContainer.apply(0,arguments),container=con.container,height=con.height,s,width=con.width,x=con.x,y=con.y;if(!container){throw new Error("VML container not found.");}
var res=new R._Paper,c=res.canvas=R._g.doc.createElement("div"),cs=c.style;x=x||0;y=y||0;width=width||512;height=height||342;res.width=width;res.height=height;width==+width&&(width+="px");height==+height&&(height+="px");res.coordsize=zoom*1e3+S+zoom*1e3;res.coordorigin="0 0";res.span=R._g.doc.createElement("span");res.span.style.cssText="position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;";c.appendChild(res.span);cs.cssText=R.format("top:0;left:0;width:{0};height:{1};display:inline-block;position:relative;clip:rect(0 {0} {1} 0);overflow:hidden",width,height);if(container==1){R._g.doc.body.appendChild(c);cs.left=x+"px";cs.top=y+"px";cs.position="absolute";}else{if(container.firstChild){container.insertBefore(c,container.firstChild);}else{container.appendChild(c);}}
res.renderfix=function(){};return res;};R.prototype.clear=function(){R.eve("clear",this);this.canvas.innerHTML=E;this.span=R._g.doc.createElement("span");this.span.style.cssText="position:absolute;left:-9999em;top:-9999em;padding:0;margin:0;line-height:1;display:inline;";this.canvas.appendChild(this.span);this.bottom=this.top=null;};R.prototype.remove=function(){R.eve("remove",this);this.canvas.parentNode.removeChild(this.canvas);for(var i in this){this[i]=typeof this[i]=="function"?R._removedFactory(i):null;}
return true;};var setproto=R.st;for(var method in elproto)if(elproto[has](method)&&!setproto[has](method)){setproto[method]=(function(methodname){return function(){var arg=arguments;return this.forEach(function(el){el[methodname].apply(el,arg);});};})(method);}}(window.Raphael);;(function($){var types=['DOMMouseScroll','mousewheel'];if($.event.fixHooks){for(var i=types.length;i;){$.event.fixHooks[types[--i]]=$.event.mouseHooks;}}
$.event.special.mousewheel={setup:function(){if(this.addEventListener){for(var i=types.length;i;){this.addEventListener(types[--i],handler,false);}}else{this.onmousewheel=handler;}},teardown:function(){if(this.removeEventListener){for(var i=types.length;i;){this.removeEventListener(types[--i],handler,false);}}else{this.onmousewheel=null;}}};$.fn.extend({mousewheel:function(fn){return fn?this.bind("mousewheel",fn):this.trigger("mousewheel");},unmousewheel:function(fn){return this.unbind("mousewheel",fn);}});function handler(event){var orgEvent=event||window.event,args=[].slice.call(arguments,1),delta=0,returnValue=true,deltaX=0,deltaY=0;event=$.event.fix(orgEvent);event.type="mousewheel";if(orgEvent.wheelDelta){delta=orgEvent.wheelDelta/120;}
if(orgEvent.detail){delta=-orgEvent.detail/3;}
deltaY=delta;if(orgEvent.axis!==undefined&&orgEvent.axis===orgEvent.HORIZONTAL_AXIS){deltaY=0;deltaX=-1*delta;}
if(orgEvent.wheelDeltaY!==undefined){deltaY=orgEvent.wheelDeltaY/120;}
if(orgEvent.wheelDeltaX!==undefined){deltaX=-1*orgEvent.wheelDeltaX/120;}
args.unshift(event,delta,deltaX,deltaY);return($.event.dispatch||$.event.handle).apply(this,args);}})(jQuery);;(function(window){function Vec2(x,y){this.x=x;this.y=y;}
window.Vec2=Vec2;var rad2deg=57.29577951308232;var deg2rad=0.017453292519943295;var epsilon=0.0000001;Vec2.new_polar_deg=function(len,angle){var v=new Vec2(len,0);return v.rotate_deg(angle);};Vec2.new_polar=function(len,angle){var v=new Vec2(len,0);v.rotate(angle);return v;};Vec2.prototype.len=function(){return Math.sqrt(this.x*this.x+this.y*this.y);};Vec2.prototype.len_sq=function(){return this.x*this.x+this.y*this.y;};Vec2.prototype.dist=function(v){var dx=this.x-v.x;var dy=this.y-v.y;return Math.sqrt(dx*dx+dy*dy);};Vec2.prototype.dist_xy=function(x,y){var dx=this.x-x;var dy=this.y-y;return Math.sqrt(dx*dx+dy*dy);};Vec2.prototype.dist_sq=function(v){var dx=this.x-v.x;var dy=this.y-v.y;return dx*dx+dy*dy;};Vec2.prototype.dist_sq_xy=function(x,y){var dx=this.x-x;var dy=this.y-y;return dx*dx+dy*dy;};Vec2.prototype.dot=function(v){return this.x*v.x+this.y*v.y;};Vec2.prototype.dot_xy=function(x,y){return this.x*x+this.y*y;};Vec2.prototype.clone=function(){return new Vec2(this.x,this.y);};Vec2.prototype.add=function(v){return new Vec2(this.x+v.x,this.y+v.y);};Vec2.prototype.add_xy=function(x,y){return new Vec2(this.x+x,this.y+y);};Vec2.prototype.sub=function(v){return new Vec2(this.x-v.x,this.y-v.y);};Vec2.prototype.sub_xy=function(x,y){return new Vec2(this.x-x,this.y-y);};Vec2.prototype.mult=function(v){return new Vec2(this.x*v.x,this.y*v.y);};Vec2.prototype.mult_xy=function(x,y){return new Vec2(this.x*x,this.y*y);};Vec2.prototype.scale=function(f){return new Vec2(this.x*f,this.y*f);};Vec2.prototype.neg=function(f){return new Vec2(-this.x,-this.y);};Vec2.prototype.normalize=function(){var len=this.len();if(len==0){return new Vec2(0,1);}else if(len!=1){return this.scale(1.0/len);}
return new Vec2(this.x,this.y);};Vec2.prototype.set_len=function(l){return this.normalize().scale(l);};Vec2.prototype.project=function(v){return v.set_len(this.dot(v));};Vec2.prototype.toString=function(){var str="";str+="[";str+=this.x;str+=",";str+=this.y;str+="]";return str;};Vec2.prototype.rotate=function(rad){var c=Math.cos(rad);var s=Math.sin(rad);var px=this.x*c-this.y*s;var py=this.x*s+this.y*c;return new Vec2(px,py);};Vec2.prototype.rotate_deg=function(deg){return this.rotate(deg*deg2rad);};Vec2.prototype.lerp=function(v,alpha){var inv_alpha=1-alpha;return new Vec2(this.x*inv_alpha+v.x*alpha,this.y*inv_alpha+v.y*alpha);};Vec2.prototype.angle=function(){return Math.atan2(this.y,this.x);};Vec2.prototype.angle_deg=function(){return Math.atan2(this.y,this.x)*rad2deg;};Vec2.prototype.equals=function(v){if(Math.abs(this.x-v.x)>epsilon){return false;}else if(Math.abs(this.y-v.y)>epsilon){return false;}
return true;};Vec2.prototype.equals_xy=function(x,y){if(Math.abs(this.x-x)>epsilon){return false;}else if(Math.abs(this.y-y)>epsilon){return false;}
return true;};})(window);(function(window){function BEllipse(cx,cy,rx,ry){this.type='ellipse';this.x=cx-rx;this.y=cy-ry;this.sx=2*rx;this.sy=2*ry;this.hx=rx;this.hy=ry;this.cx=cx;this.cy=cy;this.mx=cx+rx;this.my=cy+ry;}
window.BEllipse=BEllipse;BEllipse.prototype.collide_segment=function(a,b){var collisions=[];if(a.equals(b)){return collisions;}
var c=new Vec2(this.cx,this.cy);a=a.sub(c).mult_xy(1/this.hx,1/this.hy);b=b.sub(c).mult_xy(1/this.hx,1/this.hy);if(a.len_sq()<1&&b.len_sq()<1){return collisions;}
var ab=b.sub(a);var A=(ab.x*ab.x+ab.y*ab.y);var B=2*(ab.x*a.x+ab.y*a.y);var C=a.x*a.x+a.y*a.y-1;var u=B*B-4*A*C;if(u<0){return collisions;}
u=Math.sqrt(u);var u1=(-B+u)/(2*A);var u2=(-B-u)/(2*A);if(u1>=0&&u1<=1){var pos=a.add(ab.scale(u1));collisions.push(pos);}
if(u1!=u2&&u2>=0&&u2<=1){var pos=a.add(ab.scale(u2));collisions.push(pos);}
for(var i=0;i<collisions.length;i++){collisions[i]=collisions[i].mult_xy(this.hx,this.hy);collisions[i]=collisions[i].add_xy(this.cx,this.cy);}
return collisions;};function BRect(x,y,sx,sy){this.type='rect';this.x=x;this.y=y;this.sx=sx;this.sy=sy;this.hx=sx/2;this.hy=sy/2;this.cx=x+this.hx;this.cy=y+this.hy;this.mx=x+sx;this.my=y+sy;}
window.BRect=BRect;BRect.new_centered=function(cx,cy,sx,sy){return new BRect(cx-sx/2,cy-sy/2,sx,sy);};function line_intersect(a,b,c,d){var f=((d.y-c.y)*(b.x-a.x)-(d.x-c.x)*(b.y-a.y));if(f==0){return null;}
f=1/f;var fab=((d.x-c.x)*(a.y-c.y)-(d.y-c.y)*(a.x-c.x))*f;if(fab<0||fab>1){return null;}
var fcd=((b.x-a.x)*(a.y-c.y)-(b.y-a.y)*(a.x-c.x))*f;if(fcd<0||fcd>1){return null;}
return new Vec2(a.x+fab*(b.x-a.x),a.y+fab*(b.y-a.y));}
BRect.prototype.collide_segment=function(a,b){var collisions=[];var corners=[new Vec2(this.x,this.y),new Vec2(this.x,this.my),new Vec2(this.mx,this.my),new Vec2(this.mx,this.y)];var pos=line_intersect(a,b,corners[0],corners[1]);if(pos)collisions.push(pos);pos=line_intersect(a,b,corners[1],corners[2]);if(pos)collisions.push(pos);pos=line_intersect(a,b,corners[2],corners[3]);if(pos)collisions.push(pos);pos=line_intersect(a,b,corners[3],corners[0]);if(pos)collisions.push(pos);return collisions;};BRect.prototype.contains_vec=function(vec){return(vec.x>=this.x&&vec.x<=this.mx&&vec.y>=this.y&&vec.y<=this.my);};BRect.prototype.contains_xy=function(x,y){return(x>=this.x&&x<=this.mx&&y>=this.y&&y<=this.my);};BEllipse.prototype.contains_vec=function(v){v=v.mult_xy(this.hx,this.hy);return v.len_sq()<=1;};BEllipse.prototype.contains_xy=function(x,y){return this.contains(new Vec2(x,y));};})(window);;(function(window){function EdgeEnd(pos_x,pos_y){this.x=pos_x;this.y=pos_y;this.get_pos=function(){return new Vec2(this.x,this.y);}}
function CloseButton(graph,entity,entity_type,pos_x,pos_y){var self=this;var visible=false;var close_button_radius=graph.style.close_button_radius||8;var close_circle=graph.r.circle(entity.get_pos().x+pos_x,entity.get_pos().y+pos_y,close_button_radius);close_circle.attr({'opacity':0,'fill':graph.style.close_button_color||"black",'cursor':'pointer','stroke':'none'});close_circle.transform(graph.get_transform());graph.set_scrolling(close_circle);var close_label=graph.r.text(entity.get_pos().x+pos_x,entity.get_pos().y+pos_y,"x");close_label.attr({'fill':graph.style.close_button_x_color||"white",'font-size':close_button_radius,'cursor':'pointer'});close_label.transform(graph.get_transform());graph.set_scrolling(close_label);var dummy_circle=graph.r.circle(entity.get_pos().x+pos_x,entity.get_pos().y+pos_y,close_button_radius);dummy_circle.attr({'opacity':1,'fill':'transparent','stroke':'none','cursor':'pointer'});dummy_circle.transform(graph.get_transform());graph.set_scrolling(dummy_circle);this.get_pos=function(){return entity.get_pos().add_xy(pos_x,pos_y);};this.update_pos=function(){var pos=self.get_pos();close_circle.attr({'cx':pos.x,'cy':pos.y});dummy_circle.attr({'cx':pos.x,'cy':pos.y});close_label.attr({'x':pos.x,'y':pos.y});};function hover_in(){if(!visible){return;}
close_circle.animate({'r':close_button_radius*1.5},300,'elastic');dummy_circle.animate({'r':close_button_radius*1.5},300,'elastic');}
function hover_out(){if(!visible){return;}
close_circle.animate({'r':close_button_radius},400,'linear');dummy_circle.animate({'r':close_button_radius},400,'linear');}
dummy_circle.hover(hover_in,hover_out);close_circle.hover(hover_in,hover_out);close_label.hover(hover_in,hover_out);function click_action(){if(!visible){return;}
close_circle.attr({'r':close_button_radius*2});dummy_circle.attr({'r':close_button_radius*2});close_circle.animate({'r':close_button_radius},400,'linear');dummy_circle.animate({'r':close_button_radius},400,'linear');if(entity_type=="node"){$.when(GraphNode.destruction_callback(entity)).done(function(){entity.remove();});}else if(entity_type=="edge"){$.when(GraphEdge.destruction_callback(entity)).done(function(){entity.remove();});}}
dummy_circle.click(click_action);close_circle.click(click_action);close_label.click(click_action);this.show=function(){if(!visible){close_circle.animate({'opacity':1},100,'linear');close_label.animate({'opacity':1},100,'linear');visible=true;}}
this.hide=function(){if(visible){close_circle.animate({'opacity':0},100,'linear');close_label.animate({'opacity':0},100,'linear');visible=false;}}
this.remove=function(){if(visible){visible=false;close_circle.animate({'opacity':0},100,'linear');close_label.animate({'opacity':0},100,'linear',self.remove);}else{close_circle.remove();close_label.remove();dummy_circle.remove();}}}
function Connector(graph,node,pos_x,pos_y){var visible=false;var conn_circle=graph.r.circle(node.get_pos().x+pos_x,node.get_pos().y+pos_y,4);conn_circle.attr({'opacity':0,'fill':graph.style.node_outline_color,'stroke':'none'});conn_circle.transform(graph.get_transform());graph.set_scrolling(conn_circle);var self=this;this.update_pos=function(){conn_circle.attr({'cx':node.get_pos().x+pos_x,'cy':node.get_pos().y+pos_y});};this.get_pos=function(){return new node.get_pos().add_xy(pos_x,pos_y);};this.remove=function(){conn_circle.remove();}
function hover_in(){if(!visible){return;}
conn_circle.animate({'r':8},300,'elastic');if(graph.creating_edge){graph.target_node=node;conn_circle.animate({'fill':graph.style.connector_active_color,'stroke':graph.style.node_outline_color,'stroke-width':graph.style.node_selected_width,},100,'linear');}}
function hover_out(){if(!visible){return;}
conn_circle.animate({'r':graph.style.connector_radius,'fill':graph.style.node_outline_color,'stroke':'none'},400,'linear');graph.target_node=null;}
conn_circle.hover(hover_in,hover_out);var drag_down=function(){if(!visible){return;}
self.ox=conn_circle.attr("cx");self.oy=conn_circle.attr("cy");self.edge_start=new EdgeEnd(self.ox,self.oy);self.edge_end=new EdgeEnd(self.ox,self.oy);self.edge_tmp=new GraphEdge(graph,'',self.edge_start,self.edge_end,true);graph.creating_edge=true;};var drag_move=function(dx,dy){if(!visible){return;}
self.edge_end.x=self.ox+dx;self.edge_end.y=self.oy+dy;self.edge_tmp.update();};var drag_up=function(){if(!visible){return;}
graph.creating_edge=false;self.edge_tmp.remove();if(graph.target_node){var edge_prop=GraphEdge.creation_callback(node,graph.target_node);if(edge_prop){var new_edge=new GraphEdge(graph,edge_prop.label,node,graph.target_node);GraphEdge.new_edge_callback(new_edge);}}};conn_circle.drag(drag_move,drag_down,drag_up);function show(){if(!visible){conn_circle.animate({'opacity':1},100,'linear');visible=true;}}
function hide(){if(visible){conn_circle.animate({'opacity':0},100,'linear');visible=false;}}
this.show=show;this.hide=hide;}
function Graph(r,style,viewport){var self=this;var nodes=[];var edges=[];var graph={};var links={};var uid=1;var selected_entity=null;self.creating_edge=false;self.target_node=null;self.r=r;self.style=style;var tr_x=0,tr_y=0;var background=r.rect(0,0,'100%','100%').attr({'fill':'white','stroke':'none','opacity':0,'cursor':'move'});this.get_transform=function(){return"T"+tr_x+","+tr_y};var translate_all=function(dx,dy){tr_x+=dx;tr_y+=dy;var tstr=self.get_transform();r.forEach(function(el){if(el!=background){el.transform(tstr);}});};var get_bounds=function(){var minx=Number.MAX_VALUE;var miny=Number.MAX_VALUE;var maxx=Number.MIN_VALUE;var maxy=Number.MIN_VALUE;for(var i=0;i<nodes.length;i++){var pos=nodes[i].get_pos();minx=Math.min(minx,pos.x);miny=Math.min(miny,pos.y);maxx=Math.max(maxx,pos.x);maxy=Math.max(maxy,pos.y);}
minx=minx-style.node_size_x/2+tr_x;miny=miny-style.node_size_y/2+tr_y;maxx=maxx+style.node_size_x/2+tr_x;maxy=maxy+style.node_size_y/2+tr_y;return{minx:minx,miny:miny,maxx:maxx,maxy:maxy};};var translation_respects_viewport=function(dx,dy,margin){if(!viewport){return true;}
margin=margin||0;var b=get_bounds();var width=viewport.offsetWidth;var height=viewport.offsetHeight;if((dy<0&&b.maxy+dy<margin)||(dy>0&&b.miny+dy>height-margin)||(dx<0&&b.maxx+dx<margin)||(dx>0&&b.minx+dx>width-margin)){return false;}
return true;}
this.set_scrolling=function(raph_element){$(raph_element.node).bind('mousewheel',function(event,delta){var dy=delta*20;if(translation_respects_viewport(0,dy,style.viewport_margin)){translate_all(0,dy);}});};var px,py;var bg_drag_down=function(){px=py=0;};var bg_drag_move=function(x,y){var dx=x-px;var dy=y-py;px=x;py=y;if(translation_respects_viewport(dx,dy,style.viewport_margin)){translate_all(dx,dy);}};var bg_drag_up=function(){};background.drag(bg_drag_move,bg_drag_down,bg_drag_up);this.set_scrolling(background);this.add_node=function(n){nodes.push(n);n.uid=uid++;};this.get_node_list=function(){return nodes;};this.add_edge=function(n1,n2,e){edges.push(e);e.uid=uid++;if(!graph[n1.uid])graph[n1.uid]={};if(!graph[n1.uid][n2.uid])graph[n1.uid][n2.uid]=[];if(!links[n1.uid])links[n1.uid]=[];if(!links[n2.uid])links[n2.uid]=[];graph[n1.uid][n2.uid].push(e);links[n1.uid].push(e);if(n1!=n2){links[n2.uid].push(e);}};this.remove_edge=function(edge){edges=_.without(edges,edge);var n1=edge.get_start();var n2=edge.get_end();links[n1.uid]=_.without(links[n1.uid],edge);links[n2.uid]=_.without(links[n2.uid],edge);graph[n1.uid][n2.uid]=_.without(graph[n1.uid][n2.uid],edge);if(selected_entity==edge){selected_entity=null;}};this.remove_node=function(node){var linked_edges=self.get_linked_edge_list(node);for(var i=0;i<linked_edges.length;i++){linked_edges[i].remove();}
nodes=_.without(nodes,node);if(selected_entity==node){selected_entity=null;}}
this.get_edge_list=function(n1,n2){var list=[];if(!graph[n1.uid])return list;if(!graph[n1.uid][n2.uid])return list;return graph[n1.uid][n2.uid];};this.get_linked_edge_list=function(n){if(!links[n.uid])return[];return links[n.uid];};this.get_edge_curvature=function(n1,n2,e){var el_12=this.get_edge_list(n1,n2);var c12=el_12.length;var el_21=this.get_edge_list(n2,n1);var c21=el_21.length;if(c12+c21==1){return 0;}else{var index=0;for(var i=0;i<c12;i++){if(el_12[i].uid<e.uid){index++;}}
if(c21==0){return index-(c12-1)/2.0;}else{return index+0.5;}}};this.get_loop_angle=function(n,e){var loop_list=this.get_edge_list(n,n);var slots=[];for(var angle=0;angle<360;angle+=45){slots.push(Vec2.new_polar_deg(1,angle));}
var links=this.get_linked_edge_list(n);for(var i=0;i<links.length;i++){var edge=links[i];if(!edge.is_loop||edge.is_loop()){continue;}
var end=edge.get_end();if(end==n){end=edge.get_start();}
var dir=end.get_pos().sub(n.get_pos()).normalize();for(var s=0;s<slots.length;s++){var score=slots[s].dot(dir);if(score<0){score=-0.2*Math.pow(score,2);}else{score=Math.pow(score,2);}
if(!slots[s].score){slots[s].score=score;}else{slots[s].score+=score;}}}
slots.sort(function(a,b){return a.score<b.score?-1:1;});var index=0;for(var i=0;i<links.length;i++){var edge=links[i];if(!edge.is_loop||!edge.is_loop()){continue;}
if(edge.uid<e.uid){index++;}}
index%=slots.length;return slots[index].angle_deg();}
this.select=function(entity){if(selected_entity){if(selected_entity==entity){return;}else{if(selected_entity.set_not_selected){selected_entity.set_not_selected();}
selected_entity=null;}}
selected_entity=entity;if(entity&&entity.set_selected){entity.set_selected();}};}
function GraphNode(graph,pos_x,pos_y,label,type,color){var self=this;var r=graph.r;var sy=graph.style.node_size_y;var sx=graph.style.node_size_x;var node_fig=null;var selected=false;this.connectors=[];this.close_button=null;this.uid=0;graph.add_node(this);if(type=='circle'){node_fig=r.ellipse(pos_x,pos_y,sx/2,sy/2);}else{node_fig=r.rect(pos_x-sx/2,pos_y-sy/2,sx,sy);}
node_fig.attr({'fill':color,'stroke':graph.style.node_outline_color,'stroke-width':graph.style.node_outline_width,'cursor':'pointer'});node_fig.transform(graph.get_transform());graph.set_scrolling(node_fig);var node_label=r.text(pos_x,pos_y,label);node_label.attr({'fill':graph.style.node_label_color,'font-size':graph.style.node_label_font_size,'cursor':'pointer'});node_label.transform(graph.get_transform());graph.set_scrolling(node_label);var update_linked_edges=function(){var edges=graph.get_linked_edge_list(self);for(var i=0;i<edges.length;i++){edges[i].update();}};var set_pos=function(pos){if(type=='circle'){node_fig.attr({'cx':pos.x,'cy':pos.y});}else{node_fig.attr({'x':pos.x-sx/2,'y':pos.y-sy/2});}
node_label.attr({'x':pos.x,'y':pos.y});for(var i=0;i<self.connectors.length;i++){self.connectors[i].update_pos();}
if(self.close_button){self.close_button.update_pos();}
update_linked_edges();};var get_fig=function(){return node_fig;};var get_pos=function(){if(type=='circle'){return new Vec2(node_fig.attr('cx'),node_fig.attr('cy'));}else{return new Vec2(node_fig.attr('x')+sx/2,node_fig.attr('y')+sy/2);}};var get_label=function(){return node_label.attr("text");};var set_label=function(text){node_label.attr({'text':text});};var get_bound=function(){if(type=='circle'){return new BEllipse(get_pos().x,get_pos().y,sx/2,sy/2);}else{return BRect.new_centered(get_pos().x,get_pos().y,sx,sy);}};var set_selected=function(){if(!selected){selected=true;node_fig.attr({'stroke':graph.style.node_selected_color,'stroke-width':graph.style.node_selected_width});if(!self.close_button){self.close_button=new CloseButton(graph,self,"node",sx/2,-sy/2);self.close_button.show();}
for(var i=0;i<self.connectors.length;i++){self.connectors[i].show();}}};var set_not_selected=function(){if(selected){node_fig.animate({'stroke':graph.style.node_outline_color,'stroke-width':graph.style.node_outline_width},100,'linear');if(self.close_button){self.close_button.remove();self.close_button=null;}
selected=false;}
for(var i=0;i<self.connectors.length;i++){self.connectors[i].hide();}};var remove=function(){if(self.close_button){self.close_button.remove();}
for(var i=0;i<self.connectors.length;i++){self.connectors[i].remove();}
graph.remove_node(self);node_fig.remove();node_label.remove();}
this.set_pos=set_pos;this.get_pos=get_pos;this.set_label=set_label;this.get_label=get_label;this.get_bound=get_bound;this.get_fig=get_fig;this.set_selected=set_selected;this.set_not_selected=set_not_selected;this.update_linked_edges=update_linked_edges;this.remove=remove;var click_action=function(){if(type=='circle'){node_fig.attr({'rx':sx/2+3,'ry':sy/2+3});node_fig.animate({'rx':sx/2,'ry':sy/2},500,'elastic');}else{var cx=get_pos().x;var cy=get_pos().y;node_fig.attr({'x':cx-(sx/2)-3,'y':cy-(sy/2)-3,'idth':sx+6,'height':sy+6});node_fig.animate({'x':cx-sx/2,'y':cy-sy/2,'idth':sx,'height':sy},500,'elastic');}
graph.select(self);};node_fig.click(click_action);node_label.click(click_action);var drag_down=function(){this.opos=get_pos();};var drag_move=function(dx,dy){var edges=graph.get_linked_edge_list(self);for(var i=0;i<edges.length;i++){edges[i].label_disable();}
if(self.close_button){self.close_button.hide();}
set_pos(this.opos.add_xy(dx,dy));};var drag_up=function(){var edges=graph.get_linked_edge_list(self);for(var i=0;i<edges.length;i++){edges[i].label_enable();}
if(self.close_button){self.close_button.show();}};node_fig.drag(drag_move,drag_down,drag_up);node_label.drag(drag_move,drag_down,drag_up);function hover_in(){if(graph.creating_edge){graph.target_node=self;}}
function hover_out(){graph.target_node=null;}
node_fig.hover(hover_in,hover_out);node_label.hover(hover_in,hover_out);function double_click(){GraphNode.double_click_callback(self);}
node_fig.dblclick(double_click);node_label.dblclick(double_click);this.connectors.push(new Connector(graph,this,-sx/2,0));this.connectors.push(new Connector(graph,this,sx/2,0));this.connectors.push(new Connector(graph,this,0,-sy/2));this.connectors.push(new Connector(graph,this,0,sy/2));this.close_button=new CloseButton(graph,this,"node",sx/2,-sy/2);}
GraphNode.double_click_callback=function(node){console.log("double click from node:",node);};GraphNode.destruction_callback=function(node){return true;};function GraphEdge(graph,label,start,end,tmp){var self=this;var r=graph.r;var curvature=0;var s,e;var mc;var mc1,mc2;var elfs=graph.style.edge_label_font_size||10;var label_enabled=true;this.uid=0;var edge_path="";var selected=false;if(!tmp){graph.add_edge(start,end,this);}
function get_label_pos(path){var cpos=path.getTotalLength()*0.5;var cindex=Math.abs(Math.floor(curvature));var mod=((cindex%3))*(elfs*3.1)-(elfs*0.5);var verticality=Math.abs(end.get_pos().sub(start.get_pos()).normalize().dot_xy(0,1));verticality=Math.max(verticality-0.5,0)*2;var lpos=path.getPointAtLength(cpos+mod*verticality);return new Vec2(lpos.x,lpos.y-elfs*(1-verticality));}
this.get_pos=function(){if(!edge){return start.get_pos().lerp(end.get_pos(),0.5);}
return get_label_pos(edge);}
function make_line(){return"M"+s.x+","+s.y+"L"+e.x+","+e.y;}
function make_curve(){return"M"+s.x+","+s.y+"Q"+mc.x+","+mc.y+" "+e.x+","+e.y;}
function make_loop(){return"M"+s.x+" "+s.y+"C"+mc1.x+" "+mc1.y+" "+mc2.x+" "+mc2.y+" "+e.x+" "+e.y;}
function update_curve(){if(start!=end){if(!tmp){curvature=graph.get_edge_curvature(start,end,self);}else{curvature=0;}
s=start.get_pos();e=end.get_pos();mc=s.lerp(e,0.5);var se=e.sub(s);se=se.normalize();se=se.rotate_deg(-90);se=se.scale(curvature*graph.style.edge_spacing);mc=mc.add(se);if(start.get_bound){var col=start.get_bound().collide_segment(s,mc);if(col.length>0){s=col[0];}}
if(end.get_bound){var col=end.get_bound().collide_segment(mc,e);if(col.length>0){e=col[0];}}
if(curvature!=0){edge_path=make_curve();}else{edge_path=make_line();}}else{var rad=graph.style.edge_loop_radius||100;s=start.get_pos();e=end.get_pos();var r=Vec2.new_polar_deg(rad,graph.get_loop_angle(start,self));mc=s.add(r);var p=r.rotate_deg(90);mc1=mc.add(p.set_len(rad*0.5));mc2=mc.add(p.set_len(-rad*0.5));if(start.get_bound){var col=start.get_bound().collide_segment(s,mc1);if(col.length>0){s=col[0];}
var col=start.get_bound().collide_segment(e,mc2);if(col.length>0){e=col[0];}}
edge_path=make_loop();}}
update_curve();var edge=r.path(edge_path).attr({'stroke':graph.style.edge_color,'stroke-width':graph.style.edge_width,'arrow-end':'block-wide-long','cursor':'pointer'}).insertBefore(graph.get_node_list()[0].get_fig());var labelpos=get_label_pos(edge);var edge_label=r.text(labelpos.x,labelpos.y-elfs,label).attr({'fill':graph.style.edge_label_color,'cursor':'pointer','font-size':elfs});edge.transform(graph.get_transform());graph.set_scrolling(edge);edge_label.transform(graph.get_transform());graph.set_scrolling(edge_label);if(!tmp){var edges_start=graph.get_linked_edge_list(start);var edges_end=graph.get_linked_edge_list(end);var edges=edges_start.length<edges_end.length?edges_start:edges_end;for(var i=0;i<edges.length;i++){if(edges[i]!=self){edges[i].update();}}}
function label_enable(){if(!label_enabled){label_enabled=true;edge_label.animate({'opacity':1},100,'linear');if(self.close_button){self.close_button.show();}
self.update();}}
function label_disable(){if(label_enabled){label_enabled=false;edge_label.animate({'opacity':0},100,'linear');if(self.close_button){self.close_button.hide();}}}
function update(){update_curve();edge.attr({'path':edge_path});if(label_enabled){var labelpos=get_label_pos(edge);edge_label.attr({'x':labelpos.x,'y':labelpos.y-14});}}
function remove(){edge.remove();edge_label.remove();if(!tmp){graph.remove_edge(self);}
if(start.update_linked_edges){start.update_linked_edges();}
if(start!=end&&end.update_linked_edges){end.update_linked_edges();}
if(self.close_button){self.close_button.remove();}}
this.set_selected=function(){if(!selected){selected=true;edge.attr({'stroke':graph.style.node_selected_color,'stroke-width':graph.style.node_selected_width});edge_label.attr({'fill':graph.style.node_selected_color});if(!self.close_button){self.close_button=new CloseButton(graph,self,"edge",0,30);self.close_button.show();}}};this.set_not_selected=function(){if(selected){selected=false;edge.animate({'stroke':graph.style.edge_color,'stroke-width':graph.style.edge_width},100,'linear');edge_label.animate({'fill':graph.style.edge_label_color},100,'linear');if(self.close_button){self.close_button.remove();self.close_button=null;}}};function click_action(){graph.select(self);}
edge.click(click_action);edge_label.click(click_action);function double_click_action(){GraphEdge.double_click_callback(self);}
edge.dblclick(double_click_action);edge_label.dblclick(double_click_action);this.label_enable=label_enable;this.label_disable=label_disable;this.update=update;this.remove=remove;this.is_loop=function(){return start==end;};this.get_start=function(){return start;};this.get_end=function(){return end;};}
GraphEdge.double_click_callback=function(edge){console.log("double click from edge:",edge);};GraphEdge.creation_callback=function(start,end){var edge_prop={};edge_prop.label='new edge!';return edge_prop;};GraphEdge.new_edge_callback=function(new_edge){};GraphEdge.destruction_callback=function(edge){return true;};function wordwrap(str,width){width=width||32;var cut=true;var brk='\n';if(!str){return str;}
var regex='.{1,'+width+'}(\\s|$)'+(cut?'|.{'+width+'}|.+$':'|\\S+?(\\s|$)');return str.match(new RegExp(regex,'g')).join(brk);}
window.CuteGraph=Graph;window.CuteNode=GraphNode;window.CuteEdge=GraphEdge;window.CuteGraph.wordwrap=wordwrap;})(window);;openerp.web_diagram=function(instance){var QWeb=instance.web.qweb,_t=instance.web._t,_lt=instance.web._lt;instance.web.views.add('diagram','instance.web.DiagramView');instance.web.DiagramView=instance.web.View.extend({display_name:_lt('Diagram'),view_type:'diagram',searchable:false,init:function(parent,dataset,view_id,options){var self=this;this._super(parent);this.set_default_options(options);this.view_manager=parent;this.dataset=dataset;this.model=this.dataset.model;this.view_id=view_id;this.domain=this.dataset._domain||[];this.context={};this.ids=this.dataset.ids;this.on('pager_action_executed',self,self.pager_action_trigger);},view_loading:function(r){return this.load_diagram(r);},toTitleCase:function(str){return str.replace(/\w\S*/g,function(txt){return txt.charAt(0).toUpperCase()+txt.substr(1).toLowerCase();});},load_diagram:function(result){var self=this;if(this.ids&&this.ids.length){this.id=this.ids[self.dataset.index||0];}
this.fields_view=result,this.view_id=this.fields_view.view_id,this.fields=this.fields_view.fields,this.nodes=this.fields_view.arch.children[0],this.connectors=this.fields_view.arch.children[1],this.node=this.nodes.attrs.object,this.connector=this.connectors.attrs.object;this.labels=_.filter(this.fields_view.arch.children,function(label){return label.tag=="label";});this.$el.html(QWeb.render("DiagramView",{'widget':self}));this.$el.addClass(this.fields_view.arch.attrs['class']);_.each(self.labels,function(label){html_label='<p style="padding: 4px;">'+label.attrs.string+"</p>";self.$el.find('.oe_diagram_header').append(html_label);})
this.init_pager();this.$el.find('#new_node.oe_diagram_button_new').click(function(){self.add_node();});if(this.id){self.get_diagram_info();}
this.trigger('diagram_view_loaded',result);},get_diagram_info:function(){var self=this;var params={'id':this.id,'model':this.model,'node':this.node,'connector':this.connector,'bgcolor':this.nodes.attrs.bgcolor,'shape':this.nodes.attrs.shape,'src_node':this.connectors.attrs.source,'des_node':this.connectors.attrs.destination,'label':this.connectors.attrs.label||false,'visible_nodes':[],'invisible_nodes':[],'node_fields':[],'connectors':[],'connectors_fields':[]};_.each(this.nodes.children,function(child){if(child.attrs.invisible=='1')
params['invisible_nodes'].push(child.attrs.name);else{params['visible_nodes'].push(child.attrs.name);params['node_fields'].push(self.fields[child.attrs.name]['string']||this.toTitleCase(child.attrs.name));}});_.each(this.connectors.children,function(conn){params['connectors_fields'].push(self.fields[conn.attrs.name]['string']||this.toTitleCase(conn.attrs.name));params['connectors'].push(conn.attrs.name);});this.rpc('/web_diagram/diagram/get_diagram_info',params).done(function(result){self.draw_diagram(result);});},on_diagram_loaded:function(record){var id_record=record['id'];if(id_record){this.id=id_record;this.get_diagram_info();this.do_push_state({id:id_record});}else{this.do_push_state({});}},do_load_state:function(state,warm){if(state&&state.id){if(!this.dataset.get_id_index(state.id)){this.dataset.ids.push(state.id);}
this.dataset.select_id(state.id);if(warm){this.do_show();}}},draw_diagram:function(result){var self=this;var res_nodes=result['nodes'];var res_edges=result['conn'];this.parent_field=result.parent_field;this.$el.find('h3.oe_diagram_title').text(result.name);var id_to_node={};var style={edge_color:"#A0A0A0",edge_label_color:"#555",edge_label_font_size:10,edge_width:2,edge_spacing:100,edge_loop_radius:100,node_label_color:"#333",node_label_font_size:12,node_outline_color:"#333",node_outline_width:1,node_selected_color:"#0097BE",node_selected_width:2,node_size_x:110,node_size_y:80,connector_active_color:"#FFF",connector_radius:4,close_button_radius:8,close_button_color:"#333",close_button_x_color:"#FFF",gray:"#DCDCDC",white:"#FFF",viewport_margin:50};var canvas=self.$el.find('div.oe_diagram_diagram').empty().get(0);var r=new Raphael(canvas,'100%','100%');var graph=new CuteGraph(r,style,canvas.parentNode);var confirm_dialog=$('#dialog').dialog({autoOpen:false,title:_t("Are you sure?")});_.each(res_nodes,function(node){var n=new CuteNode(graph,node.x+50,node.y+50,CuteGraph.wordwrap(node.name,14),node.shape==='rectangle'?'rect':'circle',node.color==='white'?style.white:style.gray);n.id=node.id;id_to_node[node.id]=n;});_.each(res_edges,function(edge){var e=new CuteEdge(graph,CuteGraph.wordwrap(edge.signal,32),id_to_node[edge.s_id],id_to_node[edge.d_id]||id_to_node[edge.s_id]);e.id=edge.id;});CuteNode.double_click_callback=function(cutenode){self.edit_node(cutenode.id);};var i=0;CuteNode.destruction_callback=function(cutenode){if(!confirm(_t("Deleting this node cannot be undone.\nIt will also delete all connected transitions.\n\nAre you sure ?"))){return $.Deferred().reject().promise();}
return new instance.web.DataSet(self,self.node).unlink([cutenode.id]);};CuteEdge.double_click_callback=function(cuteedge){self.edit_connector(cuteedge.id);};CuteEdge.creation_callback=function(node_start,node_end){return{label:_t("")};};CuteEdge.new_edge_callback=function(cuteedge){self.add_connector(cuteedge.get_start().id,cuteedge.get_end().id,cuteedge);};CuteEdge.destruction_callback=function(cuteedge){if(!confirm(_t("Deleting this transition cannot be undone.\n\nAre you sure ?"))){return $.Deferred().reject().promise();}
return new instance.web.DataSet(self,self.connector).unlink([cuteedge.id]);};},edit_node:function(node_id){var self=this;var title=_t('Activity');var pop=new instance.web.form.FormOpenPopup(self);pop.show_element(self.node,node_id,self.context||self.dataset.context,{title:_t("Open: ")+title});pop.on('write_completed',self,function(){self.dataset.read_index(_.keys(self.fields_view.fields)).then(self.on_diagram_loaded);});var form_fields=[self.parent_field];var form_controller=pop.view_form;form_controller.on("load_record",self,function(){_.each(form_fields,function(fld){if(!(fld in form_controller.fields)){return;}
var field=form_controller.fields[fld];field.$input.prop('disabled',true);field.$drop_down.unbind();});});},add_node:function(){var self=this;var title=_t('Activity');var pop=new instance.web.form.SelectCreatePopup(self);pop.select_element(self.node,{title:_t("Create:")+title,initial_view:'form',disable_multiple_selection:true},self.dataset.domain,self.context||self.dataset.context);pop.on("elements_selected",self,function(element_ids){self.dataset.read_index(_.keys(self.fields_view.fields)).then(self.on_diagram_loaded);});var form_controller=pop.view_form;var form_fields=[this.parent_field];form_controller.on("load_record",self,function(){_.each(form_fields,function(fld){if(!(fld in form_controller.fields)){return;}
var field=form_controller.fields[fld];field.set_value(self.id);field.dirty=true;});});},edit_connector:function(connector_id){var self=this;var title=_t('Transition');var pop=new instance.web.form.FormOpenPopup(self);pop.show_element(self.connector,parseInt(connector_id,10),self.context||self.dataset.context,{title:_t("Open: ")+title});pop.on('write_completed',self,function(){self.dataset.read_index(_.keys(self.fields_view.fields)).then(self.on_diagram_loaded);});},add_connector:function(node_source_id,node_dest_id,dummy_cuteedge){var self=this;var title=_t('Transition');var pop=new instance.web.form.SelectCreatePopup(self);pop.select_element(self.connector,{title:_t("Create:")+title,initial_view:'form',disable_multiple_selection:true},this.dataset.domain,this.context||this.dataset.context);pop.on("elements_selected",self,function(element_ids){self.dataset.read_index(_.keys(self.fields_view.fields)).then(self.on_diagram_loaded);});pop.$el.bind("dialogbeforeclose",function(){if(dummy_cuteedge){dummy_cuteedge.remove();}});var form_controller=pop.view_form;form_controller.on("load_record",self,function(){form_controller.fields[self.connectors.attrs.source].set_value(node_source_id);form_controller.fields[self.connectors.attrs.source].dirty=true;form_controller.fields[self.connectors.attrs.destination].set_value(node_dest_id);form_controller.fields[self.connectors.attrs.destination].dirty=true;});},do_hide:function(){if(this.$pager){this.$pager.hide();}
this._super();},init_pager:function(){var self=this;if(this.$pager)
this.$pager.remove();this.$pager=$(QWeb.render("DiagramView.pager",{'widget':self})).hide();if(this.options.$pager){this.$pager.appendTo(this.options.$pager);}else{this.$el.find('.oe_diagram_pager').replaceWith(this.$pager);}
this.$pager.on('click','a[data-pager-action]',function(){var action=$(this).data('pager-action');self.execute_pager_action(action);});this.do_update_pager();},pager_action_trigger:function(){var loaded=this.dataset.read_index(_.keys(this.fields_view.fields)).then(this.on_diagram_loaded);this.do_update_pager();return loaded;},execute_pager_action:function(action){switch(action){case'first':this.dataset.index=0;break;case'previous':this.dataset.previous();break;case'next':this.dataset.next();break;case'last':this.dataset.index=this.dataset.ids.length-1;break;}
this.trigger('pager_action_executed');},do_update_pager:function(hide_index){this.$pager.toggle(this.dataset.ids.length>1);if(hide_index){$(".oe_diagram_pager_state",this.$pager).html("");}else{$(".oe_diagram_pager_state",this.$pager).html(_.str.sprintf(_t("%d / %d"),this.dataset.index+1,this.dataset.ids.length));}},do_show:function(){this.do_push_state({});return $.when(this._super(),this.execute_pager_action('reload'));}});};;openerp.process=function(instance){var QWeb=instance.web.qweb,_t=instance.web._t;instance.web.ViewManager.include({start:function(){var self=this;var _super=this._super();this.process_help=this.action?this.action.help:'';if(this.action){this.process_model=this.action.res_model;}else{this.process_model=this.dataset.model;}
this.$el.on('click','.oe_process',function(ev){self.initialize_process_view(ev);});return _super;},initialize_process_view:function(ev){var self=this;this.record_id=false;if(this.active_view=='form'){this.record_id=this.views[this.active_view].controller.datarecord.id;}
this.process_get_object().then(function(process){if(process&&process.length){if(process.length>1){self.process_selection=process;}else{self.process_id=process[0][0],self.process_title=process[0][1];}}
return $.Deferred().resolve();}).then(function(){var def=$.Deferred();if(self.process_id){$.when(self.process_graph_get()).done(function(res){self.process_notes=res.notes;self.process_title=res.name;self.process_subflows=_(res.nodes).chain().filter(function(node){return node['subflow']!==false;}).uniq(false,function(node){return node['subflow'][0];}).value();self.process_related=res.related;def.resolve(res);});}else def.resolve();return def.promise();}).done(function(res){$.when(self.process_render_view()).done(function(){if(res){self.process_draw_graph(res);}});});},process_graph_get:function(){var self=this;var def=$.Deferred();this.process_id=parseInt(this.process_id,10);this.process_dataset.call("graph_get",[self.process_id,self.model||self.dataset.model,self.record_id,[80,80,150,100],self.session.user_context]).done(function(res){self.process_dataset.call("search_by_model",[self.model||self.dataset.model,self.session.user_context]).done(function(r){res['related']=r;def.resolve(res);});});return def.promise();},process_get_object:function(){var self=this,def=$.Deferred();if(this.process_id)
return def.resolve().promise();this.process_dataset=new instance.web.DataSet(self,"process.process",self.session.user_context);this.process_dataset.call("search_by_model",[self.process_model,self.session.user_context]).done(function(res){if(!res.length){self.process_model=false;self.process_get_object().done(def.resolve);}
else{def.resolve(res);}}).fail(def.reject);return def.promise();},process_render_view:function(){var self=this;this.$el.html(QWeb.render("process.ProcessView",this));this.$el.addClass('oe_view_process').css({'background-color':'#F0EEEE'});this.$el.find('#edit_process').click(function(){self.process_edit_view();});var $parent=this.getParent().$el;$parent.find('#change_process').click(function(){self.process_selection=false,self.process_id=$parent.find('#select_process').val(),self.process_title=$.trim($parent.find('#select_process option:selected').text());self.initialize_process_view();});this.$el.find(".process_subflow").click(function(){self.process_id=this.id;self.initialize_process_view();});},process_draw_graph:function(result){var self=this;var res_nodes=result['nodes'];var res_edges=result['transitions'];var id_to_node={};var canvas=$('div.process_canvas').empty().get(0);var style={edge_color:"#A0A0A0",edge_label_font_size:10,edge_width:2,edge_spacing:40,edge_loop_radius:200,node_label_color:"#333",node_label_font_size:12,node_outline_color:"#333",node_outline_width:1,node_outline_color:"#F5F5F5",node_outline_width:0,node_selected_width:0,node_size_x:150,node_size_y:100,gray:"#DCDCDC",white:"#FFF",viewport_margin:50};var r=new Raphael(canvas,'100%','100%');var graph=new CuteGraph(r,style,canvas.parentNode);var render_process=function(r,nodes){var image_node=nodes.kind=="subflow"?"node-subflow":"node";image_node=nodes.gray?image_node+"-gray":image_node;image_node=nodes.active?'node-current':image_node;var img_src='/process/static/src/img/'+image_node+'.png';var image=r['image'](img_src,nodes.x-25,nodes.y,150,100).attr({"cursor":"default"}).mousedown(function(){return false;});var process_node=r['rect'](nodes.x,nodes.y,150,150).attr({stroke:"none"});if(nodes.name.length>18){var text=nodes.name.substr(0,16)+'...'}
var node_text=r.text(nodes.x+60,nodes.y+10,(text||nodes.name.substr(0,18))).attr({"fill":"#fff","font-weight":"bold","cursor":"default","title":nodes.name});var new_notes=nodes.notes;if(nodes.notes.length>25){var to;var temp_str=new_notes='';var from=to=0;while(1){from=25;temp_str=nodes.notes.substr(to,25);if(temp_str.lastIndexOf(" ")<25&&temp_str.length>=25){from=temp_str.lastIndexOf(" ");}
new_notes+="\n"+nodes.notes.substr(to,from);if(new_notes.length>80){break;}
to+=from;}}
if(nodes.res)
new_notes=nodes.res.name+'\n'+new_notes;if(nodes.notes.length>60){var notes=new_notes.substring(0,60)+'..';}
r.text(nodes.x+60,nodes.y+30,(notes||new_notes)).attr({"title":nodes.notes,"cursor":"default"});r['image']('/web/static/src/img/icons/gtk-info.png',nodes.x,nodes.y+75,16,16).attr({"cursor":"pointer","title":"Help"}).click(function(){window.open(nodes.url||"http://doc.openerp.com/v6.1/index.php?model="+nodes.model);});if(nodes.menu){r['image']('/web/static/src/img/icons/gtk-jump-to.png',nodes.x+100,nodes.y+75,16,16).attr({"cursor":"pointer","title":nodes.menu.name}).click(function(){self.process_jump_to_view(nodes.res_model,nodes.menu.id);});}
var process_set=r.set().push(process_node);process_set.mousedown(function(){return false;});return process_set;}
_.each(res_nodes,function(node,id){node['res_model']=self.model,node['res_id']=false,node['color']='gray'
var n=new CuteNode(graph,node.x+50,node.y+50,CuteGraph.wordwrap("",14));n.id=id;id_to_node[id]=n;return render_process(r,node);});_.each(res_edges,function(edge){var e=new CuteEdge(graph,CuteGraph.wordwrap(" ",0),id_to_node[edge.source],id_to_node[edge.target]||id_to_node[edge.source]);e.id=edge.id;});},process_jump_to_view:function(model,id){var self=this;var dataset=new instance.web.DataSet(this,'ir.values',this.session.user_context);var action_manager=new instance.web.ActionManager(self);dataset.call('get',['action','tree_but_open',[['ir.ui.menu',id]],dataset.context]).done(function(res){var action=res[0][res[0].length-1];self.rpc("/web/action/load",{action_id:action.id,context:dataset.context}).done(function(result){action_manager.replace(self.$el);action_manager.do_action(result);})});},process_edit_view:function(){var self=this;var pop=new instance.web.form.FormOpenPopup(self);pop.show_element(self.process_dataset.model,self.process_id,self.context||self.dataset.context,{title:_t('Process')});var form_controller=pop.view_form;pop.on('write_completed',self,self.initialize_process_view);}});};;!function($){"use strict"
var toggle='[data-toggle="dropdown"]',Dropdown=function(element){var $el=$(element).on('click.dropdown.data-api',this.toggle)
$('html').on('click.dropdown.data-api',function(){$el.parent().removeClass('open')})}
Dropdown.prototype={constructor:Dropdown,toggle:function(e){var $this=$(this),selector=$this.attr('data-target'),$parent,isActive
if(!selector){selector=$this.attr('href')
selector=selector&&selector.replace(/.*(?=#[^\s]*$)/,'')}
$parent=$(selector)
$parent.length||($parent=$this.parent())
isActive=$parent.hasClass('open')
clearMenus()
!isActive&&$parent.toggleClass('open')
return false}}
function clearMenus(){$(toggle).parent().removeClass('open')}
$.fn.dropdown=function(option){return this.each(function(){var $this=$(this),data=$this.data('dropdown')
if(!data)$this.data('dropdown',(data=new Dropdown(this)))
if(typeof option=='string')data[option].call($this)})}
$.fn.dropdown.Constructor=Dropdown
$(function(){$('html').on('click.dropdown.data-api',clearMenus)
$('body').on('click.dropdown.data-api',toggle,Dropdown.prototype.toggle)})}(window.jQuery);;!function(name,context,definition){context[name]=definition(name,context);}('bean',this,function(name,context){var win=window,old=context[name],overOut=/over|out/,namespaceRegex=/[^\.]*(?=\..*)\.|.*/,nameRegex=/\..*/,addEvent='addEventListener',attachEvent='attachEvent',removeEvent='removeEventListener',detachEvent='detachEvent',doc=document||{},root=doc.documentElement||{},W3C_MODEL=root[addEvent],eventSupport=W3C_MODEL?addEvent:attachEvent,slice=Array.prototype.slice,mouseTypeRegex=/click|mouse|menu|drag|drop/i,touchTypeRegex=/^touch|^gesture/i,ONE={one:1},nativeEvents=(function(hash,events,i){for(i=0;i<events.length;i++)
hash[events[i]]=1
return hash})({},('click dblclick mouseup mousedown contextmenu '+'mousewheel DOMMouseScroll '+'mouseover mouseout mousemove selectstart selectend '+'keydown keypress keyup '+'orientationchange '+'focus blur change reset select submit '+'load unload beforeunload resize move DOMContentLoaded readystatechange '+'error abort scroll '+
(W3C_MODEL?'show '+'input invalid '+'touchstart touchmove touchend touchcancel '+'gesturestart gesturechange gestureend '+'message readystatechange pageshow pagehide popstate '+'hashchange offline online '+'afterprint beforeprint '+'dragstart dragenter dragover dragleave drag drop dragend '+'loadstart progress suspend emptied stalled loadmetadata '+'loadeddata canplay canplaythrough playing waiting seeking '+'seeked ended durationchange timeupdate play pause ratechange '+'volumechange cuechange '+'checking noupdate downloading cached updateready obsolete '+'':'')).split(' ')),customEvents=(function(){function isDescendant(parent,node){while((node=node.parentNode)!==null){if(node===parent)return true}
return false}
function check(event){var related=event.relatedTarget
if(!related)return related===null
return(related!==this&&related.prefix!=='xul'&&!/document/.test(this.toString())&&!isDescendant(this,related))}
return{mouseenter:{base:'mouseover',condition:check},mouseleave:{base:'mouseout',condition:check},mousewheel:{base:/Firefox/.test(navigator.userAgent)?'DOMMouseScroll':'mousewheel'}}})(),fixEvent=(function(){var commonProps='altKey attrChange attrName bubbles cancelable ctrlKey currentTarget detail eventPhase getModifierState isTrusted metaKey relatedNode relatedTarget shiftKey srcElement target timeStamp type view which'.split(' '),mouseProps=commonProps.concat('button buttons clientX clientY dataTransfer fromElement offsetX offsetY pageX pageY screenX screenY toElement'.split(' ')),keyProps=commonProps.concat('char charCode key keyCode'.split(' ')),touchProps=commonProps.concat('touches targetTouches changedTouches scale rotation'.split(' ')),preventDefault='preventDefault',createPreventDefault=function(event){return function(){if(event[preventDefault])
event[preventDefault]()
else
event.returnValue=false}},stopPropagation='stopPropagation',createStopPropagation=function(event){return function(){if(event[stopPropagation])
event[stopPropagation]()
else
event.cancelBubble=true}},createStop=function(synEvent){return function(){synEvent[preventDefault]()
synEvent[stopPropagation]()
synEvent.stopped=true}},copyProps=function(event,result,props){var i,p
for(i=props.length;i--;){p=props[i]
if(!(p in result)&&p in event)result[p]=event[p]}}
return function(event,isNative){var result={originalEvent:event,isNative:isNative}
if(!event)
return result
var props,type=event.type,target=event.target||event.srcElement
result[preventDefault]=createPreventDefault(event)
result[stopPropagation]=createStopPropagation(event)
result.stop=createStop(result)
result.target=target&&target.nodeType===3?target.parentNode:target
if(isNative){if(type.indexOf('key')!==-1){props=keyProps
result.keyCode=event.which||event.keyCode}else if(mouseTypeRegex.test(type)){props=mouseProps
result.rightClick=event.which===3||event.button===2
result.pos={x:0,y:0}
if(event.pageX||event.pageY){result.clientX=event.pageX
result.clientY=event.pageY}else if(event.clientX||event.clientY){result.clientX=event.clientX+doc.body.scrollLeft+root.scrollLeft
result.clientY=event.clientY+doc.body.scrollTop+root.scrollTop}
if(overOut.test(type))
result.relatedTarget=event.relatedTarget||event[(type==='mouseover'?'from':'to')+'Element']}else if(touchTypeRegex.test(type)){props=touchProps}
copyProps(event,result,props||commonProps)}
return result}})(),targetElement=function(element,isNative){return!W3C_MODEL&&!isNative&&(element===doc||element===win)?root:element},RegEntry=(function(){function entry(element,type,handler,original,namespaces){this.element=element
this.type=type
this.handler=handler
this.original=original
this.namespaces=namespaces
this.custom=customEvents[type]
this.isNative=nativeEvents[type]&&element[eventSupport]
this.eventType=W3C_MODEL||this.isNative?type:'propertychange'
this.customType=!W3C_MODEL&&!this.isNative&&type
this.target=targetElement(element,this.isNative)
this.eventSupport=this.target[eventSupport]}
entry.prototype={inNamespaces:function(checkNamespaces){var i,j
if(!checkNamespaces)
return true
if(!this.namespaces)
return false
for(i=checkNamespaces.length;i--;){for(j=this.namespaces.length;j--;){if(checkNamespaces[i]===this.namespaces[j])
return true}}
return false},matches:function(checkElement,checkOriginal,checkHandler){return this.element===checkElement&&(!checkOriginal||this.original===checkOriginal)&&(!checkHandler||this.handler===checkHandler)}}
return entry})(),registry=(function(){var map={},forAll=function(element,type,original,handler,fn){if(!type||type==='*'){for(var t in map){if(t.charAt(0)==='$')
forAll(element,t.substr(1),original,handler,fn)}}else{var i=0,l,list=map['$'+type],all=element==='*'
if(!list)
return
for(l=list.length;i<l;i++){if(all||list[i].matches(element,original,handler))
if(!fn(list[i],list,i,type))
return}}},has=function(element,type,original){var i,list=map['$'+type]
if(list){for(i=list.length;i--;){if(list[i].matches(element,original,null))
return true}}
return false},get=function(element,type,original){var entries=[]
forAll(element,type,original,null,function(entry){return entries.push(entry)})
return entries},put=function(entry){(map['$'+entry.type]||(map['$'+entry.type]=[])).push(entry)
return entry},del=function(entry){forAll(entry.element,entry.type,null,entry.handler,function(entry,list,i){list.splice(i,1)
if(list.length===0)
delete map['$'+entry.type]
return false})},entries=function(){var t,entries=[]
for(t in map){if(t.charAt(0)==='$')
entries=entries.concat(map[t])}
return entries}
return{has:has,get:get,put:put,del:del,entries:entries}})(),listener=W3C_MODEL?function(element,type,fn,add){element[add?addEvent:removeEvent](type,fn,false)}:function(element,type,fn,add,custom){if(custom&&add&&element['_on'+custom]===null)
element['_on'+custom]=0
element[add?attachEvent:detachEvent]('on'+type,fn)},nativeHandler=function(element,fn,args){return function(event){event=fixEvent(event||((this.ownerDocument||this.document||this).parentWindow||win).event,true)
return fn.apply(element,[event].concat(args))}},customHandler=function(element,fn,type,condition,args,isNative){return function(event){if(condition?condition.apply(this,arguments):W3C_MODEL?true:event&&event.propertyName==='_on'+type||!event){if(event)
event=fixEvent(event||((this.ownerDocument||this.document||this).parentWindow||win).event,isNative)
fn.apply(element,event&&(!args||args.length===0)?arguments:slice.call(arguments,event?0:1).concat(args))}}},once=function(rm,element,type,fn,originalFn){return function(){rm(element,type,originalFn)
fn.apply(this,arguments)}},removeListener=function(element,orgType,handler,namespaces){var i,l,entry,type=(orgType&&orgType.replace(nameRegex,'')),handlers=registry.get(element,type,handler)
for(i=0,l=handlers.length;i<l;i++){if(handlers[i].inNamespaces(namespaces)){if((entry=handlers[i]).eventSupport)
listener(entry.target,entry.eventType,entry.handler,false,entry.type)
registry.del(entry)}}},addListener=function(element,orgType,fn,originalFn,args){var entry,type=orgType.replace(nameRegex,''),namespaces=orgType.replace(namespaceRegex,'').split('.')
if(registry.has(element,type,fn))
return element
if(type==='unload')
fn=once(removeListener,element,type,fn,originalFn)
if(customEvents[type]){if(customEvents[type].condition)
fn=customHandler(element,fn,type,customEvents[type].condition,true)
type=customEvents[type].base||type}
entry=registry.put(new RegEntry(element,type,fn,originalFn,namespaces[0]&&namespaces))
entry.handler=entry.isNative?nativeHandler(element,entry.handler,args):customHandler(element,entry.handler,type,false,args,false)
if(entry.eventSupport)
listener(entry.target,entry.eventType,entry.handler,true,entry.customType)},del=function(selector,fn,$){return function(e){var target,i,array=typeof selector==='string'?$(selector,this):selector
for(target=e.target;target&&target!==this;target=target.parentNode){for(i=array.length;i--;){if(array[i]===target){return fn.apply(target,arguments)}}}}},remove=function(element,typeSpec,fn){var k,m,type,namespaces,i,rm=removeListener,isString=typeSpec&&typeof typeSpec==='string'
if(isString&&typeSpec.indexOf(' ')>0){typeSpec=typeSpec.split(' ')
for(i=typeSpec.length;i--;)
remove(element,typeSpec[i],fn)
return element}
type=isString&&typeSpec.replace(nameRegex,'')
if(type&&customEvents[type])
type=customEvents[type].type
if(!typeSpec||isString){if(namespaces=isString&&typeSpec.replace(namespaceRegex,''))
namespaces=namespaces.split('.')
rm(element,type,fn,namespaces)}else if(typeof typeSpec==='function'){rm(element,null,typeSpec)}else{for(k in typeSpec){if(typeSpec.hasOwnProperty(k))
remove(element,k,typeSpec[k])}}
return element},add=function(element,events,fn,delfn,$){var type,types,i,args,originalFn=fn,isDel=fn&&typeof fn==='string'
if(events&&!fn&&typeof events==='object'){for(type in events){if(events.hasOwnProperty(type))
add.apply(this,[element,type,events[type]])}}else{args=arguments.length>3?slice.call(arguments,3):[]
types=(isDel?fn:events).split(' ')
isDel&&(fn=del(events,(originalFn=delfn),$))&&(args=slice.call(args,1))
this===ONE&&(fn=once(remove,element,events,fn,originalFn))
for(i=types.length;i--;)addListener(element,types[i],fn,originalFn,args)}
return element},one=function(){return add.apply(ONE,arguments)},fireListener=W3C_MODEL?function(isNative,type,element){var evt=doc.createEvent(isNative?'HTMLEvents':'UIEvents')
evt[isNative?'initEvent':'initUIEvent'](type,true,true,win,1)
element.dispatchEvent(evt)}:function(isNative,type,element){element=targetElement(element,isNative)
isNative?element.fireEvent('on'+type,doc.createEventObject()):element['_on'+type]++},fire=function(element,type,args){var i,j,l,names,handlers,types=type.split(' ')
for(i=types.length;i--;){type=types[i].replace(nameRegex,'')
if(names=types[i].replace(namespaceRegex,''))
names=names.split('.')
if(!names&&!args&&element[eventSupport]){fireListener(nativeEvents[type],type,element)}else{handlers=registry.get(element,type)
args=[false].concat(args)
for(j=0,l=handlers.length;j<l;j++){if(handlers[j].inNamespaces(names))
handlers[j].handler.apply(element,args)}}}
return element},clone=function(element,from,type){var i=0,handlers=registry.get(from,type),l=handlers.length
for(;i<l;i++)
handlers[i].original&&add(element,handlers[i].type,handlers[i].original)
return element},bean={add:add,one:one,remove:remove,clone:clone,fire:fire,noConflict:function(){context[name]=old
return this}}
if(win[attachEvent]){var cleanup=function(){var i,entries=registry.entries()
for(i in entries){if(entries[i].type&&entries[i].type!=='unload')
remove(entries[i].element,entries[i].type)}
win[detachEvent]('onunload',cleanup)
win.CollectGarbage&&win.CollectGarbage()}
win[attachEvent]('onunload',cleanup)}
return bean});;(function(){var
global=this,previousFlotr=this.Flotr,Flotr;Flotr={_:_,bean:bean,isIphone:/iphone/i.test(navigator.userAgent),isIE:(navigator.appVersion.indexOf("MSIE")!=-1?parseFloat(navigator.appVersion.split("MSIE")[1]):false),graphTypes:{},plugins:{},addType:function(name,graphType){Flotr.graphTypes[name]=graphType;Flotr.defaultOptions[name]=graphType.options||{};Flotr.defaultOptions.defaultType=Flotr.defaultOptions.defaultType||name;},addPlugin:function(name,plugin){Flotr.plugins[name]=plugin;Flotr.defaultOptions[name]=plugin.options||{};},draw:function(el,data,options,GraphKlass){GraphKlass=GraphKlass||Flotr.Graph;return new GraphKlass(el,data,options);},merge:function(src,dest){var i,v,result=dest||{};for(i in src){v=src[i];if(v&&typeof(v)==='object'){if(v.constructor===Array){result[i]=this._.clone(v);}else if(v.constructor!==RegExp&&!this._.isElement(v)){result[i]=Flotr.merge(v,(dest?dest[i]:undefined));}else{result[i]=v;}}else{result[i]=v;}}
return result;},clone:function(object){return Flotr.merge(object,{});},getTickSize:function(noTicks,min,max,decimals){var delta=(max-min)/noTicks,magn=Flotr.getMagnitude(delta),tickSize=10,norm=delta/magn;if(norm<1.5)tickSize=1;else if(norm<2.25)tickSize=2;else if(norm<3)tickSize=((decimals===0)?2:2.5);else if(norm<7.5)tickSize=5;return tickSize*magn;},defaultTickFormatter:function(val,axisOpts){return val+'';},defaultTrackFormatter:function(obj){return'('+obj.x+', '+obj.y+')';},engineeringNotation:function(value,precision,base){var sizes=['Y','Z','E','P','T','G','M','k',''],fractionSizes=['y','z','a','f','p','n','','m',''],total=sizes.length;base=base||1000;precision=Math.pow(10,precision||2);if(value===0)return 0;if(value>1){while(total--&&(value>=base))value/=base;}
else{sizes=fractionSizes;total=sizes.length;while(total--&&(value<1))value*=base;}
return(Math.round(value*precision)/precision)+sizes[total];},getMagnitude:function(x){return Math.pow(10,Math.floor(Math.log(x)/Math.LN10));},toPixel:function(val){return Math.floor(val)+0.5;},toRad:function(angle){return-angle*(Math.PI/180);},floorInBase:function(n,base){return base*Math.floor(n/base);},drawText:function(ctx,text,x,y,style){if(!ctx.fillText){ctx.drawText(text,x,y,style);return;}
style=this._.extend({size:Flotr.defaultOptions.fontSize,color:'#000000',textAlign:'left',textBaseline:'bottom',weight:1,angle:0},style);ctx.save();ctx.translate(x,y);ctx.rotate(style.angle);ctx.fillStyle=style.color;ctx.font=(style.weight>1?"bold ":"")+(style.size*1.3)+"px sans-serif";ctx.textAlign=style.textAlign;ctx.textBaseline=style.textBaseline;ctx.fillText(text,0,0);ctx.restore();},getBestTextAlign:function(angle,style){style=style||{textAlign:'center',textBaseline:'middle'};angle+=Flotr.getTextAngleFromAlign(style);if(Math.abs(Math.cos(angle))>10e-3)
style.textAlign=(Math.cos(angle)>0?'right':'left');if(Math.abs(Math.sin(angle))>10e-3)
style.textBaseline=(Math.sin(angle)>0?'top':'bottom');return style;},alignTable:{'right middle':0,'right top':Math.PI/4,'center top':Math.PI/2,'left top':3*(Math.PI/4),'left middle':Math.PI,'left bottom':-3*(Math.PI/4),'center bottom':-Math.PI/2,'right bottom':-Math.PI/4,'center middle':0},getTextAngleFromAlign:function(style){return Flotr.alignTable[style.textAlign+' '+style.textBaseline]||0;},noConflict:function(){global.Flotr=previousFlotr;return this;}};global.Flotr=Flotr;})();;Flotr.defaultOptions={colors:['#00A8F0','#C0D800','#CB4B4B','#4DA74D','#9440ED'],ieBackgroundColor:'#FFFFFF',title:null,subtitle:null,shadowSize:4,defaultType:null,HtmlText:true,fontColor:'#545454',fontSize:7.5,resolution:1,parseFloat:true,xaxis:{ticks:null,minorTicks:null,showLabels:true,showMinorLabels:false,labelsAngle:0,title:null,titleAngle:0,noTicks:5,minorTickFreq:null,tickFormatter:Flotr.defaultTickFormatter,tickDecimals:null,min:null,max:null,autoscale:false,autoscaleMargin:0,color:null,mode:'normal',timeFormat:null,timeMode:'UTC',timeUnit:'millisecond',scaling:'linear',base:Math.E,titleAlign:'center',margin:true},x2axis:{},yaxis:{ticks:null,minorTicks:null,showLabels:true,showMinorLabels:false,labelsAngle:0,title:null,titleAngle:90,noTicks:5,minorTickFreq:null,tickFormatter:Flotr.defaultTickFormatter,tickDecimals:null,min:null,max:null,autoscale:false,autoscaleMargin:0,color:null,scaling:'linear',base:Math.E,titleAlign:'center',margin:true},y2axis:{titleAngle:270},grid:{color:'#545454',backgroundColor:null,backgroundImage:null,watermarkAlpha:0.4,tickColor:'#DDDDDD',labelMargin:3,verticalLines:true,minorVerticalLines:null,horizontalLines:true,minorHorizontalLines:null,outlineWidth:1,outline:'nsew',circular:false},mouse:{track:false,trackAll:false,position:'se',relative:false,trackFormatter:Flotr.defaultTrackFormatter,margin:5,lineColor:'#FF3F19',trackDecimals:1,sensibility:2,trackY:true,radius:3,fillColor:null,fillOpacity:0.4}};;(function(){var
_=Flotr._;function Color(r,g,b,a){this.rgba=['r','g','b','a'];var x=4;while(-1<--x){this[this.rgba[x]]=arguments[x]||((x==3)?1.0:0);}
this.normalize();}
var COLOR_NAMES={aqua:[0,255,255],azure:[240,255,255],beige:[245,245,220],black:[0,0,0],blue:[0,0,255],brown:[165,42,42],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgrey:[169,169,169],darkgreen:[0,100,0],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkviolet:[148,0,211],fuchsia:[255,0,255],gold:[255,215,0],green:[0,128,0],indigo:[75,0,130],khaki:[240,230,140],lightblue:[173,216,230],lightcyan:[224,255,255],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightyellow:[255,255,224],lime:[0,255,0],magenta:[255,0,255],maroon:[128,0,0],navy:[0,0,128],olive:[128,128,0],orange:[255,165,0],pink:[255,192,203],purple:[128,0,128],violet:[128,0,128],red:[255,0,0],silver:[192,192,192],white:[255,255,255],yellow:[255,255,0]};Color.prototype={scale:function(rf,gf,bf,af){var x=4;while(-1<--x){if(!_.isUndefined(arguments[x]))this[this.rgba[x]]*=arguments[x];}
return this.normalize();},alpha:function(alpha){if(!_.isUndefined(alpha)&&!_.isNull(alpha)){this.a=alpha;}
return this.normalize();},clone:function(){return new Color(this.r,this.b,this.g,this.a);},limit:function(val,minVal,maxVal){return Math.max(Math.min(val,maxVal),minVal);},normalize:function(){var limit=this.limit;this.r=limit(parseInt(this.r,10),0,255);this.g=limit(parseInt(this.g,10),0,255);this.b=limit(parseInt(this.b,10),0,255);this.a=limit(this.a,0,1);return this;},distance:function(color){if(!color)return;color=new Color.parse(color);var dist=0,x=3;while(-1<--x){dist+=Math.abs(this[this.rgba[x]]-color[this.rgba[x]]);}
return dist;},toString:function(){return(this.a>=1.0)?'rgb('+[this.r,this.g,this.b].join(',')+')':'rgba('+[this.r,this.g,this.b,this.a].join(',')+')';},contrast:function(){var
test=1-(0.299*this.r+0.587*this.g+0.114*this.b)/255;return(test<0.5?'#000000':'#ffffff');}};_.extend(Color,{parse:function(color){if(color instanceof Color)return color;var result;if((result=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(color)))
return new Color(parseInt(result[1],16),parseInt(result[2],16),parseInt(result[3],16));if((result=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(color)))
return new Color(parseInt(result[1],10),parseInt(result[2],10),parseInt(result[3],10));if((result=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(color)))
return new Color(parseInt(result[1]+result[1],16),parseInt(result[2]+result[2],16),parseInt(result[3]+result[3],16));if((result=/rgba\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]+(?:\.[0-9]+)?)\s*\)/.exec(color)))
return new Color(parseInt(result[1],10),parseInt(result[2],10),parseInt(result[3],10),parseFloat(result[4]));if((result=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(color)))
return new Color(parseFloat(result[1])*2.55,parseFloat(result[2])*2.55,parseFloat(result[3])*2.55);if((result=/rgba\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\s*\)/.exec(color)))
return new Color(parseFloat(result[1])*2.55,parseFloat(result[2])*2.55,parseFloat(result[3])*2.55,parseFloat(result[4]));var name=(color+'').replace(/^\s*([\S\s]*?)\s*$/,'$1').toLowerCase();if(name=='transparent'){return new Color(255,255,255,0);}
return(result=COLOR_NAMES[name])?new Color(result[0],result[1],result[2]):new Color(0,0,0,0);},processColor:function(color,options){var opacity=options.opacity;if(!color)return'rgba(0, 0, 0, 0)';if(color instanceof Color)return color.alpha(opacity).toString();if(_.isString(color))return Color.parse(color).alpha(opacity).toString();var grad=color.colors?color:{colors:color};if(!options.ctx){if(!_.isArray(grad.colors))return'rgba(0, 0, 0, 0)';return Color.parse(_.isArray(grad.colors[0])?grad.colors[0][1]:grad.colors[0]).alpha(opacity).toString();}
grad=_.extend({start:'top',end:'bottom'},grad);if(/top/i.test(grad.start))options.x1=0;if(/left/i.test(grad.start))options.y1=0;if(/bottom/i.test(grad.end))options.x2=0;if(/right/i.test(grad.end))options.y2=0;var i,c,stop,gradient=options.ctx.createLinearGradient(options.x1,options.y1,options.x2,options.y2);for(i=0;i<grad.colors.length;i++){c=grad.colors[i];if(_.isArray(c)){stop=c[0];c=c[1];}
else stop=i/(grad.colors.length-1);gradient.addColorStop(stop,Color.parse(c).alpha(opacity));}
return gradient;}});Flotr.Color=Color;})();;Flotr.Date={set:function(date,name,mode,value){mode=mode||'UTC';name='set'+(mode==='UTC'?'UTC':'')+name;date[name](value);},get:function(date,name,mode){mode=mode||'UTC';name='get'+(mode==='UTC'?'UTC':'')+name;return date[name]();},format:function(d,format,mode){if(!d)return;var
get=this.get,tokens={h:get(d,'Hours',mode).toString(),H:leftPad(get(d,'Hours',mode)),M:leftPad(get(d,'Minutes',mode)),S:leftPad(get(d,'Seconds',mode)),s:get(d,'Milliseconds',mode),d:get(d,'Date',mode).toString(),m:(get(d,'Month')+1).toString(),y:get(d,'FullYear').toString(),b:Flotr.Date.monthNames[get(d,'Month',mode)]};function leftPad(n){n+='';return n.length==1?"0"+n:n;}
var r=[],c,escape=false;for(var i=0;i<format.length;++i){c=format.charAt(i);if(escape){r.push(tokens[c]||c);escape=false;}
else if(c=="%")
escape=true;else
r.push(c);}
return r.join('');},getFormat:function(time,span){var tu=Flotr.Date.timeUnits;if(time<tu.second)return"%h:%M:%S.%s";else if(time<tu.minute)return"%h:%M:%S";else if(time<tu.day)return(span<2*tu.day)?"%h:%M":"%b %d %h:%M";else if(time<tu.month)return"%b %d";else if(time<tu.year)return(span<tu.year)?"%b":"%b %y";else return"%y";},formatter:function(v,axis){var
options=axis.options,scale=Flotr.Date.timeUnits[options.timeUnit],d=new Date(v*scale);if(axis.options.timeFormat)
return Flotr.Date.format(d,options.timeFormat,options.timeMode);var span=(axis.max-axis.min)*scale,t=axis.tickSize*Flotr.Date.timeUnits[axis.tickUnit];return Flotr.Date.format(d,Flotr.Date.getFormat(t,span),options.timeMode);},generator:function(axis){var
set=this.set,get=this.get,timeUnits=this.timeUnits,spec=this.spec,options=axis.options,mode=options.timeMode,scale=timeUnits[options.timeUnit],min=axis.min*scale,max=axis.max*scale,delta=(max-min)/options.noTicks,ticks=[],tickSize=axis.tickSize,tickUnit,formatter,i;formatter=(options.tickFormatter===Flotr.defaultTickFormatter?this.formatter:options.tickFormatter);for(i=0;i<spec.length-1;++i){var d=spec[i][0]*timeUnits[spec[i][1]];if(delta<(d+spec[i+1][0]*timeUnits[spec[i+1][1]])/2&&d>=tickSize)
break;}
tickSize=spec[i][0];tickUnit=spec[i][1];if(tickUnit=="year"){tickSize=Flotr.getTickSize(options.noTicks*timeUnits.year,min,max,0);if(tickSize==0.5){tickUnit="month";tickSize=6;}}
axis.tickUnit=tickUnit;axis.tickSize=tickSize;var
d=new Date(min);var step=tickSize*timeUnits[tickUnit];function setTick(name){set(d,name,mode,Flotr.floorInBase(get(d,name,mode),tickSize));}
switch(tickUnit){case"millisecond":setTick('Milliseconds');break;case"second":setTick('Seconds');break;case"minute":setTick('Minutes');break;case"hour":setTick('Hours');break;case"month":setTick('Month');break;case"year":setTick('FullYear');break;}
if(step>=timeUnits.second)set(d,'Milliseconds',mode,0);if(step>=timeUnits.minute)set(d,'Seconds',mode,0);if(step>=timeUnits.hour)set(d,'Minutes',mode,0);if(step>=timeUnits.day)set(d,'Hours',mode,0);if(step>=timeUnits.day*4)set(d,'Date',mode,1);if(step>=timeUnits.year)set(d,'Month',mode,0);var carry=0,v=NaN,prev;do{prev=v;v=d.getTime();ticks.push({v:v/scale,label:formatter(v/scale,axis)});if(tickUnit=="month"){if(tickSize<1){set(d,'Date',mode,1);var start=d.getTime();set(d,'Month',mode,get(d,'Month',mode)+1)
var end=d.getTime();d.setTime(v+carry*timeUnits.hour+(end-start)*tickSize);carry=get(d,'Hours',mode)
set(d,'Hours',mode,0);}
else
set(d,'Month',mode,get(d,'Month',mode)+tickSize);}
else if(tickUnit=="year"){set(d,'FullYear',mode,get(d,'FullYear',mode)+tickSize);}
else
d.setTime(v+step);}while(v<max&&v!=prev);return ticks;},timeUnits:{millisecond:1,second:1000,minute:1000*60,hour:1000*60*60,day:1000*60*60*24,month:1000*60*60*24*30,year:1000*60*60*24*365.2425},spec:[[1,"millisecond"],[20,"millisecond"],[50,"millisecond"],[100,"millisecond"],[200,"millisecond"],[500,"millisecond"],[1,"second"],[2,"second"],[5,"second"],[10,"second"],[30,"second"],[1,"minute"],[2,"minute"],[5,"minute"],[10,"minute"],[30,"minute"],[1,"hour"],[2,"hour"],[4,"hour"],[8,"hour"],[12,"hour"],[1,"day"],[2,"day"],[3,"day"],[0.25,"month"],[0.5,"month"],[1,"month"],[2,"month"],[3,"month"],[6,"month"],[1,"year"]],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]};;(function(){var _=Flotr._;Flotr.DOM={addClass:function(element,name){var classList=(element.className?element.className:'');if(_.include(classList.split(/\s+/g),name))return;element.className=(classList?classList+' ':'')+name;},create:function(tag){return document.createElement(tag);},node:function(html){var div=Flotr.DOM.create('div'),n;div.innerHTML=html;n=div.children[0];div.innerHTML='';return n;},empty:function(element){element.innerHTML='';},hide:function(element){Flotr.DOM.setStyles(element,{display:'none'});},insert:function(element,child){if(_.isString(child))
element.innerHTML+=child;else if(_.isElement(child))
element.appendChild(child);},opacity:function(element,opacity){element.style.opacity=opacity;},position:function(element,p){if(!element.offsetParent)
return{left:(element.offsetLeft||0),top:(element.offsetTop||0)};p=this.position(element.offsetParent);p.left+=element.offsetLeft;p.top+=element.offsetTop;return p;},removeClass:function(element,name){var classList=(element.className?element.className:'');element.className=_.filter(classList.split(/\s+/g),function(c){if(c!=name)return true;}).join(' ');},setStyles:function(element,o){_.each(o,function(value,key){element.style[key]=value;});},show:function(element){Flotr.DOM.setStyles(element,{display:''});},size:function(element){return{height:element.offsetHeight,width:element.offsetWidth};}};})();;(function(){var
F=Flotr,bean=F.bean;F.EventAdapter={observe:function(object,name,callback){bean.add(object,name,callback);return this;},fire:function(object,name,args){bean.fire(object,name,args);if(typeof(Prototype)!='undefined')
Event.fire(object,name,args);return this;},stopObserving:function(object,name,callback){bean.remove(object,name,callback);return this;},eventPointer:function(e){if(!F._.isUndefined(e.touches)&&e.touches.length>0){return{x:e.touches[0].pageX,y:e.touches[0].pageY};}else if(!F._.isUndefined(e.changedTouches)&&e.changedTouches.length>0){return{x:e.changedTouches[0].pageX,y:e.changedTouches[0].pageY};}else if(e.pageX||e.pageY){return{x:e.pageX,y:e.pageY};}else if(e.clientX||e.clientY){var
d=document,b=d.body,de=d.documentElement;return{x:e.clientX+b.scrollLeft+de.scrollLeft,y:e.clientY+b.scrollTop+de.scrollTop};}}};})();;(function(){var
F=Flotr,D=F.DOM,_=F._,Text=function(o){this.o=o;};Text.prototype={dimensions:function(text,canvasStyle,htmlStyle,className){if(!text)return{width:0,height:0};return(this.o.html)?this.html(text,this.o.element,htmlStyle,className):this.canvas(text,canvasStyle);},canvas:function(text,style){if(!this.o.textEnabled)return;style=style||{};var
metrics=this.measureText(text,style),width=metrics.width,height=style.size||F.defaultOptions.fontSize,angle=style.angle||0,cosAngle=Math.cos(angle),sinAngle=Math.sin(angle),widthPadding=2,heightPadding=6,bounds;bounds={width:Math.abs(cosAngle*width)+Math.abs(sinAngle*height)+widthPadding,height:Math.abs(sinAngle*width)+Math.abs(cosAngle*height)+heightPadding};return bounds;},html:function(text,element,style,className){var div=D.create('div');D.setStyles(div,{'position':'absolute','top':'-10000px'});D.insert(div,'<div style="'+style+'" class="'+className+' flotr-dummy-div">'+text+'</div>');D.insert(this.o.element,div);return D.size(div);},measureText:function(text,style){var
context=this.o.ctx,metrics;if(!context.fillText||(F.isIphone&&context.measure)){return{width:context.measure(text,style)};}
style=_.extend({size:F.defaultOptions.fontSize,weight:1,angle:0},style);context.save();context.font=(style.weight>1?"bold ":"")+(style.size*1.3)+"px sans-serif";metrics=context.measureText(text);context.restore();return metrics;}};Flotr.Text=Text;})();;(function(){var
D=Flotr.DOM,E=Flotr.EventAdapter,_=Flotr._,flotr=Flotr;Graph=function(el,data,options){this._setEl(el);this._initMembers();this._initPlugins();E.fire(this.el,'flotr:beforeinit',[this]);this.data=data;this.series=flotr.Series.getSeries(data);this._initOptions(options);this._initGraphTypes();this._initCanvas();this._text=new flotr.Text({element:this.el,ctx:this.ctx,html:this.options.HtmlText,textEnabled:this.textEnabled});E.fire(this.el,'flotr:afterconstruct',[this]);this._initEvents();this.findDataRanges();this.calculateSpacing();this.draw(_.bind(function(){E.fire(this.el,'flotr:afterinit',[this]);},this));};function observe(object,name,callback){E.observe.apply(this,arguments);this._handles.push(arguments);return this;}
Graph.prototype={destroy:function(){E.fire(this.el,'flotr:destroy');_.each(this._handles,function(handle){E.stopObserving.apply(this,handle);});this._handles=[];this.el.graph=null;},observe:observe,_observe:observe,processColor:function(color,options){var o={x1:0,y1:0,x2:this.plotWidth,y2:this.plotHeight,opacity:1,ctx:this.ctx};_.extend(o,options);return flotr.Color.processColor(color,o);},findDataRanges:function(){var a=this.axes,xaxis,yaxis,range;_.each(this.series,function(series){range=series.getRange();if(range){xaxis=series.xaxis;yaxis=series.yaxis;xaxis.datamin=Math.min(range.xmin,xaxis.datamin);xaxis.datamax=Math.max(range.xmax,xaxis.datamax);yaxis.datamin=Math.min(range.ymin,yaxis.datamin);yaxis.datamax=Math.max(range.ymax,yaxis.datamax);xaxis.used=(xaxis.used||range.xused);yaxis.used=(yaxis.used||range.yused);}},this);if(!a.x.used&&!a.x2.used)a.x.used=true;if(!a.y.used&&!a.y2.used)a.y.used=true;_.each(a,function(axis){axis.calculateRange();});var
types=_.keys(flotr.graphTypes),drawn=false;_.each(this.series,function(series){if(series.hide)return;_.each(types,function(type){if(series[type]&&series[type].show){this.extendRange(type,series);drawn=true;}},this);if(!drawn){this.extendRange(this.options.defaultType,series);}},this);},extendRange:function(type,series){if(this[type].extendRange)this[type].extendRange(series,series.data,series[type],this[type]);if(this[type].extendYRange)this[type].extendYRange(series.yaxis,series.data,series[type],this[type]);if(this[type].extendXRange)this[type].extendXRange(series.xaxis,series.data,series[type],this[type]);},calculateSpacing:function(){var a=this.axes,options=this.options,series=this.series,margin=options.grid.labelMargin,T=this._text,x=a.x,x2=a.x2,y=a.y,y2=a.y2,maxOutset=options.grid.outlineWidth,i,j,l,dim;_.each(a,function(axis){axis.calculateTicks();axis.calculateTextDimensions(T,options);});dim=T.dimensions(options.title,{size:options.fontSize*1.5},'font-size:1em;font-weight:bold;','flotr-title');this.titleHeight=dim.height;dim=T.dimensions(options.subtitle,{size:options.fontSize},'font-size:smaller;','flotr-subtitle');this.subtitleHeight=dim.height;for(j=0;j<options.length;++j){if(series[j].points.show){maxOutset=Math.max(maxOutset,series[j].points.radius+series[j].points.lineWidth/2);}}
var p=this.plotOffset;if(x.options.margin===false){p.bottom=0;p.top=0;}else{p.bottom+=(options.grid.circular?0:(x.used&&x.options.showLabels?(x.maxLabel.height+margin):0))+
(x.used&&x.options.title?(x.titleSize.height+margin):0)+maxOutset;p.top+=(options.grid.circular?0:(x2.used&&x2.options.showLabels?(x2.maxLabel.height+margin):0))+
(x2.used&&x2.options.title?(x2.titleSize.height+margin):0)+this.subtitleHeight+this.titleHeight+maxOutset;}
if(y.options.margin===false){p.left=0;p.right=0;}else{p.left+=(options.grid.circular?0:(y.used&&y.options.showLabels?(y.maxLabel.width+margin):0))+
(y.used&&y.options.title?(y.titleSize.width+margin):0)+maxOutset;p.right+=(options.grid.circular?0:(y2.used&&y2.options.showLabels?(y2.maxLabel.width+margin):0))+
(y2.used&&y2.options.title?(y2.titleSize.width+margin):0)+maxOutset;}
p.top=Math.floor(p.top);this.plotWidth=this.canvasWidth-p.left-p.right;this.plotHeight=this.canvasHeight-p.bottom-p.top;x.length=x2.length=this.plotWidth;y.length=y2.length=this.plotHeight;y.offset=y2.offset=this.plotHeight;x.setScale();x2.setScale();y.setScale();y2.setScale();},draw:function(after){var
context=this.ctx,i;E.fire(this.el,'flotr:beforedraw',[this.series,this]);if(this.series.length){context.save();context.translate(this.plotOffset.left,this.plotOffset.top);for(i=0;i<this.series.length;i++){if(!this.series[i].hide)this.drawSeries(this.series[i]);}
context.restore();this.clip();}
E.fire(this.el,'flotr:afterdraw',[this.series,this]);if(after)after();},drawSeries:function(series){function drawChart(series,typeKey){var options=this.getOptions(series,typeKey);this[typeKey].draw(options);}
var drawn=false;series=series||this.series;_.each(flotr.graphTypes,function(type,typeKey){if(series[typeKey]&&series[typeKey].show&&this[typeKey]){drawn=true;drawChart.call(this,series,typeKey);}},this);if(!drawn)drawChart.call(this,series,this.options.defaultType);},getOptions:function(series,typeKey){var
type=series[typeKey],graphType=this[typeKey],options={context:this.ctx,width:this.plotWidth,height:this.plotHeight,fontSize:this.options.fontSize,fontColor:this.options.fontColor,textEnabled:this.textEnabled,htmlText:this.options.HtmlText,text:this._text,element:this.el,data:series.data,color:series.color,shadowSize:series.shadowSize,xScale:_.bind(series.xaxis.d2p,series.xaxis),yScale:_.bind(series.yaxis.d2p,series.yaxis)};options=flotr.merge(type,options);options.fillStyle=this.processColor(type.fillColor||series.color,{opacity:type.fillOpacity});return options;},getEventPosition:function(e){var
d=document,b=d.body,de=d.documentElement,axes=this.axes,plotOffset=this.plotOffset,lastMousePos=this.lastMousePos,pointer=E.eventPointer(e),dx=pointer.x-lastMousePos.pageX,dy=pointer.y-lastMousePos.pageY,r,rx,ry;if('ontouchstart'in this.el){r=D.position(this.overlay);rx=pointer.x-r.left-plotOffset.left;ry=pointer.y-r.top-plotOffset.top;}else{r=this.overlay.getBoundingClientRect();rx=e.clientX-r.left-plotOffset.left-b.scrollLeft-de.scrollLeft;ry=e.clientY-r.top-plotOffset.top-b.scrollTop-de.scrollTop;}
return{x:axes.x.p2d(rx),x2:axes.x2.p2d(rx),y:axes.y.p2d(ry),y2:axes.y2.p2d(ry),relX:rx,relY:ry,dX:dx,dY:dy,absX:pointer.x,absY:pointer.y,pageX:pointer.x,pageY:pointer.y};},clickHandler:function(event){if(this.ignoreClick){this.ignoreClick=false;return this.ignoreClick;}
E.fire(this.el,'flotr:click',[this.getEventPosition(event),this]);},mouseMoveHandler:function(event){if(this.mouseDownMoveHandler)return;var pos=this.getEventPosition(event);E.fire(this.el,'flotr:mousemove',[event,pos,this]);this.lastMousePos=pos;},mouseDownHandler:function(event){if(this.mouseUpHandler)return;this.mouseUpHandler=_.bind(function(e){E.stopObserving(document,'mouseup',this.mouseUpHandler);E.stopObserving(document,'mousemove',this.mouseDownMoveHandler);this.mouseDownMoveHandler=null;this.mouseUpHandler=null;E.fire(this.el,'flotr:mouseup',[e,this]);},this);this.mouseDownMoveHandler=_.bind(function(e){var pos=this.getEventPosition(e);E.fire(this.el,'flotr:mousemove',[event,pos,this]);this.lastMousePos=pos;},this);E.observe(document,'mouseup',this.mouseUpHandler);E.observe(document,'mousemove',this.mouseDownMoveHandler);E.fire(this.el,'flotr:mousedown',[event,this]);this.ignoreClick=false;},drawTooltip:function(content,x,y,options){var mt=this.getMouseTrack(),style='opacity:0.7;background-color:#000;color:#fff;display:none;position:absolute;padding:2px 8px;-moz-border-radius:4px;border-radius:4px;white-space:nowrap;',p=options.position,m=options.margin,plotOffset=this.plotOffset;if(x!==null&&y!==null){if(!options.relative){if(p.charAt(0)=='n')style+='top:'+(m+plotOffset.top)+'px;bottom:auto;';else if(p.charAt(0)=='s')style+='bottom:'+(m+plotOffset.bottom)+'px;top:auto;';if(p.charAt(1)=='e')style+='right:'+(m+plotOffset.right)+'px;left:auto;';else if(p.charAt(1)=='w')style+='left:'+(m+plotOffset.left)+'px;right:auto;';}
else{if(p.charAt(0)=='n')style+='bottom:'+(m-plotOffset.top-y+this.canvasHeight)+'px;top:auto;';else if(p.charAt(0)=='s')style+='top:'+(m+plotOffset.top+y)+'px;bottom:auto;';if(p.charAt(1)=='e')style+='left:'+(m+plotOffset.left+x)+'px;right:auto;';else if(p.charAt(1)=='w')style+='right:'+(m-plotOffset.left-x+this.canvasWidth)+'px;left:auto;';}
mt.style.cssText=style;D.empty(mt);D.insert(mt,content);D.show(mt);}
else{D.hide(mt);}},clip:function(){var
ctx=this.ctx,o=this.plotOffset,w=this.canvasWidth,h=this.canvasHeight;if(flotr.isIE&&flotr.isIE<9){ctx.save();ctx.fillStyle=this.processColor(this.options.ieBackgroundColor);ctx.fillRect(0,0,w,o.top);ctx.fillRect(0,0,o.left,h);ctx.fillRect(0,h-o.bottom,w,o.bottom);ctx.fillRect(w-o.right,0,o.right,h);ctx.restore();}else{ctx.clearRect(0,0,w,o.top);ctx.clearRect(0,0,o.left,h);ctx.clearRect(0,h-o.bottom,w,o.bottom);ctx.clearRect(w-o.right,0,o.right,h);}},_initMembers:function(){this._handles=[];this.lastMousePos={pageX:null,pageY:null};this.plotOffset={left:0,right:0,top:0,bottom:0};this.ignoreClick=true;this.prevHit=null;},_initGraphTypes:function(){_.each(flotr.graphTypes,function(handler,graphType){this[graphType]=flotr.clone(handler);},this);},_initEvents:function(){var
el=this.el,touchendHandler,movement,touchend;if('ontouchstart'in el){touchendHandler=_.bind(function(e){touchend=true;E.stopObserving(document,'touchend',touchendHandler);E.fire(el,'flotr:mouseup',[event,this]);this.multitouches=null;if(!movement){this.clickHandler(e);}},this);this.observe(this.overlay,'touchstart',_.bind(function(e){movement=false;touchend=false;this.ignoreClick=false;if(e.touches&&e.touches.length>1){this.multitouches=e.touches;}
E.fire(el,'flotr:mousedown',[event,this]);this.observe(document,'touchend',touchendHandler);},this));this.observe(this.overlay,'touchmove',_.bind(function(e){var pos=this.getEventPosition(e);e.preventDefault();movement=true;if(this.multitouches||(e.touches&&e.touches.length>1)){this.multitouches=e.touches;}else{if(!touchend){E.fire(el,'flotr:mousemove',[event,pos,this]);}}
this.lastMousePos=pos;},this));}else{this.observe(this.overlay,'mousedown',_.bind(this.mouseDownHandler,this)).observe(el,'mousemove',_.bind(this.mouseMoveHandler,this)).observe(this.overlay,'click',_.bind(this.clickHandler,this)).observe(el,'mouseout',function(){E.fire(el,'flotr:mouseout');});}},_initCanvas:function(){var el=this.el,o=this.options,children=el.children,removedChildren=[],child,i,size,style;for(i=children.length;i--;){child=children[i];if(!this.canvas&&child.className==='flotr-canvas'){this.canvas=child;}else if(!this.overlay&&child.className==='flotr-overlay'){this.overlay=child;}else{removedChildren.push(child);}}
for(i=removedChildren.length;i--;){el.removeChild(removedChildren[i]);}
D.setStyles(el,{position:'relative'});size={};size.width=el.clientWidth;size.height=el.clientHeight;if(size.width<=0||size.height<=0||o.resolution<=0){throw'Invalid dimensions for plot, width = '+size.width+', height = '+size.height+', resolution = '+o.resolution;}
this.canvas=getCanvas(this.canvas,'canvas');this.overlay=getCanvas(this.overlay,'overlay');this.ctx=getContext(this.canvas);this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.octx=getContext(this.overlay);this.octx.clearRect(0,0,this.overlay.width,this.overlay.height);this.canvasHeight=size.height;this.canvasWidth=size.width;this.textEnabled=!!this.ctx.drawText||!!this.ctx.fillText;function getCanvas(canvas,name){if(!canvas){canvas=D.create('canvas');if(typeof FlashCanvas!="undefined"&&typeof canvas.getContext==='function'){FlashCanvas.initElement(canvas);}
canvas.className='flotr-'+name;canvas.style.cssText='position:absolute;left:0px;top:0px;';D.insert(el,canvas);}
_.each(size,function(size,attribute){D.show(canvas);if(name=='canvas'&&canvas.getAttribute(attribute)===size){return;}
canvas.setAttribute(attribute,size*o.resolution);canvas.style[attribute]=size+'px';});canvas.context_=null;return canvas;}
function getContext(canvas){if(window.G_vmlCanvasManager)window.G_vmlCanvasManager.initElement(canvas);var context=canvas.getContext('2d');if(!window.G_vmlCanvasManager)context.scale(o.resolution,o.resolution);return context;}},_initPlugins:function(){_.each(flotr.plugins,function(plugin,name){_.each(plugin.callbacks,function(fn,c){this.observe(this.el,c,_.bind(fn,this));},this);this[name]=flotr.clone(plugin);_.each(this[name],function(fn,p){if(_.isFunction(fn))
this[name][p]=_.bind(fn,this);},this);},this);},_initOptions:function(opts){var options=flotr.clone(flotr.defaultOptions);options.x2axis=_.extend(_.clone(options.xaxis),options.x2axis);options.y2axis=_.extend(_.clone(options.yaxis),options.y2axis);this.options=flotr.merge(opts||{},options);if(this.options.grid.minorVerticalLines===null&&this.options.xaxis.scaling==='logarithmic'){this.options.grid.minorVerticalLines=true;}
if(this.options.grid.minorHorizontalLines===null&&this.options.yaxis.scaling==='logarithmic'){this.options.grid.minorHorizontalLines=true;}
E.fire(this.el,'flotr:afterinitoptions',[this]);this.axes=flotr.Axis.getAxes(this.options);var assignedColors=[],colors=[],ln=this.series.length,neededColors=this.series.length,oc=this.options.colors,usedColors=[],variation=0,c,i,j,s;for(i=neededColors-1;i>-1;--i){c=this.series[i].color;if(c){--neededColors;if(_.isNumber(c))assignedColors.push(c);else usedColors.push(flotr.Color.parse(c));}}
for(i=assignedColors.length-1;i>-1;--i)
neededColors=Math.max(neededColors,assignedColors[i]+1);for(i=0;colors.length<neededColors;){c=(oc.length==i)?new flotr.Color(100,100,100):flotr.Color.parse(oc[i]);var sign=variation%2==1?-1:1,factor=1+sign*Math.ceil(variation/2)*0.2;c.scale(factor,factor,factor);colors.push(c);if(++i>=oc.length){i=0;++variation;}}
for(i=0,j=0;i<ln;++i){s=this.series[i];if(!s.color){s.color=colors[j++].toString();}else if(_.isNumber(s.color)){s.color=colors[s.color].toString();}
if(!s.xaxis)s.xaxis=this.axes.x;if(s.xaxis==1)s.xaxis=this.axes.x;else if(s.xaxis==2)s.xaxis=this.axes.x2;if(!s.yaxis)s.yaxis=this.axes.y;if(s.yaxis==1)s.yaxis=this.axes.y;else if(s.yaxis==2)s.yaxis=this.axes.y2;for(var t in flotr.graphTypes){s[t]=_.extend(_.clone(this.options[t]),s[t]);}
s.mouse=_.extend(_.clone(this.options.mouse),s.mouse);if(_.isUndefined(s.shadowSize))s.shadowSize=this.options.shadowSize;}},_setEl:function(el){if(!el)throw'The target container doesn\'t exist';else if(el.graph instanceof Graph)el.graph.destroy();else if(!el.clientWidth)throw'The target container must be visible';el.graph=this;this.el=el;}};Flotr.Graph=Graph;})();;(function(){var
_=Flotr._,LOGARITHMIC='logarithmic';function Axis(o){this.orientation=1;this.offset=0;this.datamin=Number.MAX_VALUE;this.datamax=-Number.MAX_VALUE;_.extend(this,o);this._setTranslations();}
Axis.prototype={setScale:function(){var length=this.length;if(this.options.scaling==LOGARITHMIC){this.scale=length/(log(this.max,this.options.base)-log(this.min,this.options.base));}else{this.scale=length/(this.max-this.min);}},calculateTicks:function(){var options=this.options;this.ticks=[];this.minorTicks=[];if(options.ticks){this._cleanUserTicks(options.ticks,this.ticks);this._cleanUserTicks(options.minorTicks||[],this.minorTicks);}
else{if(options.mode=='time'){this._calculateTimeTicks();}else if(options.scaling==='logarithmic'){this._calculateLogTicks();}else{this._calculateTicks();}}},calculateRange:function(){if(!this.used)return;var axis=this,o=axis.options,min=o.min!==null?o.min:axis.datamin,max=o.max!==null?o.max:axis.datamax,margin=o.autoscaleMargin;if(o.scaling=='logarithmic'){if(min<=0)min=axis.datamin;if(max<=0)max=min;}
if(max==min){var widen=max?0.01:1.00;if(o.min===null)min-=widen;if(o.max===null)max+=widen;}
if(o.scaling==='logarithmic'){if(min<0)min=max/o.base;var maxexp=Math.log(max);if(o.base!=Math.E)maxexp/=Math.log(o.base);maxexp=Math.ceil(maxexp);var minexp=Math.log(min);if(o.base!=Math.E)minexp/=Math.log(o.base);minexp=Math.ceil(minexp);axis.tickSize=Flotr.getTickSize(o.noTicks,minexp,maxexp,o.tickDecimals===null?0:o.tickDecimals);if(o.minorTickFreq===null){if(maxexp-minexp>10)
o.minorTickFreq=0;else if(maxexp-minexp>5)
o.minorTickFreq=2;else
o.minorTickFreq=5;}}else{axis.tickSize=Flotr.getTickSize(o.noTicks,min,max,o.tickDecimals);}
axis.min=min;axis.max=max;if(o.min===null&&o.autoscale){axis.min-=axis.tickSize*margin;if(axis.min<0&&axis.datamin>=0)axis.min=0;axis.min=axis.tickSize*Math.floor(axis.min/axis.tickSize);}
if(o.max===null&&o.autoscale){axis.max+=axis.tickSize*margin;if(axis.max>0&&axis.datamax<=0&&axis.datamax!=axis.datamin)axis.max=0;axis.max=axis.tickSize*Math.ceil(axis.max/axis.tickSize);}
if(axis.min==axis.max)axis.max=axis.min+1;},calculateTextDimensions:function(T,options){var maxLabel='',length,i;if(this.options.showLabels){for(i=0;i<this.ticks.length;++i){length=this.ticks[i].label.length;if(length>maxLabel.length){maxLabel=this.ticks[i].label;}}}
this.maxLabel=T.dimensions(maxLabel,{size:options.fontSize,angle:Flotr.toRad(this.options.labelsAngle)},'font-size:smaller;','flotr-grid-label');this.titleSize=T.dimensions(this.options.title,{size:options.fontSize*1.2,angle:Flotr.toRad(this.options.titleAngle)},'font-weight:bold;','flotr-axis-title');},_cleanUserTicks:function(ticks,axisTicks){var axis=this,options=this.options,v,i,label,tick;if(_.isFunction(ticks))ticks=ticks({min:axis.min,max:axis.max});for(i=0;i<ticks.length;++i){tick=ticks[i];if(typeof(tick)==='object'){v=tick[0];label=(tick.length>1)?tick[1]:options.tickFormatter(v,{min:axis.min,max:axis.max});}else{v=tick;label=options.tickFormatter(v,{min:this.min,max:this.max});}
axisTicks[i]={v:v,label:label};}},_calculateTimeTicks:function(){this.ticks=Flotr.Date.generator(this);},_calculateLogTicks:function(){var axis=this,o=axis.options,v,decadeStart;var max=Math.log(axis.max);if(o.base!=Math.E)max/=Math.log(o.base);max=Math.ceil(max);var min=Math.log(axis.min);if(o.base!=Math.E)min/=Math.log(o.base);min=Math.ceil(min);for(i=min;i<max;i+=axis.tickSize){decadeStart=(o.base==Math.E)?Math.exp(i):Math.pow(o.base,i);var decadeEnd=decadeStart*((o.base==Math.E)?Math.exp(axis.tickSize):Math.pow(o.base,axis.tickSize));var stepSize=(decadeEnd-decadeStart)/o.minorTickFreq;axis.ticks.push({v:decadeStart,label:o.tickFormatter(decadeStart,{min:axis.min,max:axis.max})});for(v=decadeStart+stepSize;v<decadeEnd;v+=stepSize)
axis.minorTicks.push({v:v,label:o.tickFormatter(v,{min:axis.min,max:axis.max})});}
decadeStart=(o.base==Math.E)?Math.exp(i):Math.pow(o.base,i);axis.ticks.push({v:decadeStart,label:o.tickFormatter(decadeStart,{min:axis.min,max:axis.max})});},_calculateTicks:function(){var axis=this,o=axis.options,tickSize=axis.tickSize,min=axis.min,max=axis.max,start=tickSize*Math.ceil(min/tickSize),decimals,minorTickSize,v,v2,i,j;if(o.minorTickFreq)
minorTickSize=tickSize/o.minorTickFreq;for(i=0;(v=v2=start+i*tickSize)<=max;++i){decimals=o.tickDecimals;if(decimals===null)decimals=1-Math.floor(Math.log(tickSize)/Math.LN10);if(decimals<0)decimals=0;v=v.toFixed(decimals);axis.ticks.push({v:v,label:o.tickFormatter(v,{min:axis.min,max:axis.max})});if(o.minorTickFreq){for(j=0;j<o.minorTickFreq&&(i*tickSize+j*minorTickSize)<max;++j){v=v2+j*minorTickSize;axis.minorTicks.push({v:v,label:o.tickFormatter(v,{min:axis.min,max:axis.max})});}}}},_setTranslations:function(logarithmic){this.d2p=(logarithmic?d2pLog:d2p);this.p2d=(logarithmic?p2dLog:p2d);}};_.extend(Axis,{getAxes:function(options){return{x:new Axis({options:options.xaxis,n:1,length:this.plotWidth}),x2:new Axis({options:options.x2axis,n:2,length:this.plotWidth}),y:new Axis({options:options.yaxis,n:1,length:this.plotHeight,offset:this.plotHeight,orientation:-1}),y2:new Axis({options:options.y2axis,n:2,length:this.plotHeight,offset:this.plotHeight,orientation:-1})};}});function d2p(dataValue){return this.offset+this.orientation*(dataValue-this.min)*this.scale;}
function p2d(pointValue){return(this.offset+this.orientation*pointValue)/this.scale+this.min;}
function d2pLog(dataValue){return this.offset+this.orientation*(log(dataValue,this.options.base)-log(this.min,this.options.base))*this.scale;}
function p2dLog(pointValue){return exp((this.offset+this.orientation*pointValue)/this.scale+log(this.min,this.options.base),this.options.base);}
function log(value,base){value=Math.log(Math.max(value,Number.MIN_VALUE));if(base!==Math.E)
value/=Math.log(base);return value;}
function exp(value,base){return(base===Math.E)?Math.exp(value):Math.pow(base,value);}
Flotr.Axis=Axis;})();;(function(){var
_=Flotr._;function Series(o){_.extend(this,o);}
Series.prototype={getRange:function(){var
data=this.data,length=data.length,xmin=Number.MAX_VALUE,ymin=Number.MAX_VALUE,xmax=-Number.MAX_VALUE,ymax=-Number.MAX_VALUE,xused=false,yused=false,x,y,i;if(length<0||this.hide)return false;for(i=0;i<length;i++){x=data[i][0];y=data[i][1];if(x<xmin){xmin=x;xused=true;}
if(x>xmax){xmax=x;xused=true;}
if(y<ymin){ymin=y;yused=true;}
if(y>ymax){ymax=y;yused=true;}}
return{xmin:xmin,xmax:xmax,ymin:ymin,ymax:ymax,xused:xused,yused:yused};}};_.extend(Series,{getSeries:function(data){return _.map(data,function(s){var series;if(s.data){series=new Series();_.extend(series,s);}else{series=new Series({data:s});}
return series;});}});Flotr.Series=Series;})();;Flotr.addType('lines',{options:{show:false,lineWidth:2,fill:false,fillBorder:false,fillColor:null,fillOpacity:0.4,steps:false,stacked:false},stack:{values:[]},draw:function(options){var
context=options.context,lineWidth=options.lineWidth,shadowSize=options.shadowSize,offset;context.save();context.lineJoin='round';if(shadowSize){context.lineWidth=shadowSize/2;offset=lineWidth/2+context.lineWidth/2;context.strokeStyle="rgba(0,0,0,0.1)";this.plot(options,offset+shadowSize/2,false);context.strokeStyle="rgba(0,0,0,0.2)";this.plot(options,offset,false);}
context.lineWidth=lineWidth;context.strokeStyle=options.color;this.plot(options,0,true);context.restore();},plot:function(options,shadowOffset,incStack){var
context=options.context,width=options.width,height=options.height,xScale=options.xScale,yScale=options.yScale,data=options.data,stack=options.stacked?this.stack:false,length=data.length-1,prevx=null,prevy=null,zero=yScale(0),x1,x2,y1,y2,stack1,stack2,i;if(length<1)return;context.beginPath();for(i=0;i<length;++i){if(data[i][1]===null||data[i+1][1]===null)continue;x1=xScale(data[i][0]);x2=xScale(data[i+1][0]);if(stack){stack1=stack.values[data[i][0]]||0;stack2=stack.values[data[i+1][0]]||stack.values[data[i][0]]||0;y1=yScale(data[i][1]+stack1);y2=yScale(data[i+1][1]+stack2);if(incStack){stack.values[data[i][0]]=data[i][1]+stack1;if(i==length-1)
stack.values[data[i+1][0]]=data[i+1][1]+stack2;}}
else{y1=yScale(data[i][1]);y2=yScale(data[i+1][1]);}
if((y1>height&&y2>height)||(y1<0&&y2<0)||(x1<0&&x2<0)||(x1>width&&x2>width))continue;if((prevx!=x1)||(prevy!=y1+shadowOffset))
context.moveTo(x1,y1+shadowOffset);prevx=x2;prevy=y2+shadowOffset;if(options.steps){context.lineTo(prevx+shadowOffset/2,y1+shadowOffset);context.lineTo(prevx+shadowOffset/2,prevy);}else{context.lineTo(prevx,prevy);}}
if(!options.fill||options.fill&&!options.fillBorder)context.stroke();if(!shadowOffset&&options.fill){x1=xScale(data[0][0]);context.fillStyle=options.fillStyle;context.lineTo(x2,zero);context.lineTo(x1,zero);context.lineTo(x1,yScale(data[0][1]));context.fill();if(options.fillBorder){context.stroke();}}
context.closePath();},extendYRange:function(axis,data,options,lines){var o=axis.options;if(options.stacked&&((!o.max&&o.max!==0)||(!o.min&&o.min!==0))){var
newmax=axis.max,newmin=axis.min,positiveSums=lines.positiveSums||{},negativeSums=lines.negativeSums||{},x,j;for(j=0;j<data.length;j++){x=data[j][0]+'';if(data[j][1]>0){positiveSums[x]=(positiveSums[x]||0)+data[j][1];newmax=Math.max(newmax,positiveSums[x]);}
else{negativeSums[x]=(negativeSums[x]||0)+data[j][1];newmin=Math.min(newmin,negativeSums[x]);}}
lines.negativeSums=negativeSums;lines.positiveSums=positiveSums;axis.max=newmax;axis.min=newmin;}
if(options.steps){this.hit=function(options){var
data=options.data,args=options.args,yScale=options.yScale,mouse=args[0],length=data.length,n=args[1],x=mouse.x,relY=mouse.relY,i;for(i=0;i<length-1;i++){if(x>=data[i][0]&&x<=data[i+1][0]){if(Math.abs(yScale(data[i][1])-relY)<8){n.x=data[i][0];n.y=data[i][1];n.index=i;n.seriesIndex=options.index;}
break;}}};this.drawHit=function(options){var
context=options.context,args=options.args,data=options.data,xScale=options.xScale,index=args.index,x=xScale(args.x),y=options.yScale(args.y),x2;if(data.length-1>index){x2=options.xScale(data[index+1][0]);context.save();context.strokeStyle=options.color;context.lineWidth=options.lineWidth;context.beginPath();context.moveTo(x,y);context.lineTo(x2,y);context.stroke();context.closePath();context.restore();}};this.clearHit=function(options){var
context=options.context,args=options.args,data=options.data,xScale=options.xScale,width=options.lineWidth,index=args.index,x=xScale(args.x),y=options.yScale(args.y),x2;if(data.length-1>index){x2=options.xScale(data[index+1][0]);context.clearRect(x-width,y-width,x2-x+2*width,2*width);}};}}});;Flotr.addType('bars',{options:{show:false,lineWidth:2,barWidth:1,fill:true,fillColor:null,fillOpacity:0.4,horizontal:false,stacked:false,centered:true,topPadding:0.1},stack:{positive:[],negative:[],_positive:[],_negative:[]},draw:function(options){var
context=options.context;context.save();context.lineJoin='miter';context.lineWidth=options.lineWidth;context.strokeStyle=options.color;if(options.fill)context.fillStyle=options.fillStyle;this.plot(options);context.restore();},plot:function(options){var
data=options.data,context=options.context,shadowSize=options.shadowSize,i,geometry,left,top,width,height;if(data.length<1)return;this.translate(context,options.horizontal);for(i=0;i<data.length;i++){geometry=this.getBarGeometry(data[i][0],data[i][1],options);if(geometry===null)continue;left=geometry.left;top=geometry.top;width=geometry.width;height=geometry.height;if(options.fill)context.fillRect(left,top,width,height);if(shadowSize){context.save();context.fillStyle='rgba(0,0,0,0.05)';context.fillRect(left+shadowSize,top+shadowSize,width,height);context.restore();}
if(options.lineWidth){context.strokeRect(left,top,width,height);}}},translate:function(context,horizontal){if(horizontal){context.rotate(-Math.PI/2);context.scale(-1,1);}},getBarGeometry:function(x,y,options){var
horizontal=options.horizontal,barWidth=options.barWidth,centered=options.centered,stack=options.stacked?this.stack:false,lineWidth=options.lineWidth,bisection=centered?barWidth/2:0,xScale=horizontal?options.yScale:options.xScale,yScale=horizontal?options.xScale:options.yScale,xValue=horizontal?y:x,yValue=horizontal?x:y,stackOffset=0,stackValue,left,right,top,bottom;if(stack){stackValue=yValue>0?stack.positive:stack.negative;stackOffset=stackValue[xValue]||stackOffset;stackValue[xValue]=stackOffset+yValue;}
left=xScale(xValue-bisection);right=xScale(xValue+barWidth-bisection);top=yScale(yValue+stackOffset);bottom=yScale(stackOffset);if(bottom<0)bottom=0;return(x===null||y===null)?null:{x:xValue,y:yValue,xScale:xScale,yScale:yScale,top:top,left:Math.min(left,right)-lineWidth/2,width:Math.abs(right-left)-lineWidth,height:bottom-top};},hit:function(options){var
data=options.data,args=options.args,mouse=args[0],n=args[1],x=mouse.x,y=mouse.y,hitGeometry=this.getBarGeometry(x,y,options),width=hitGeometry.width/2,left=hitGeometry.left,geometry,i;for(i=data.length;i--;){geometry=this.getBarGeometry(data[i][0],data[i][1],options);if(geometry.y>hitGeometry.y&&Math.abs(left-geometry.left)<width){n.x=data[i][0];n.y=data[i][1];n.index=i;n.seriesIndex=options.index;}}},drawHit:function(options){var
context=options.context,args=options.args,geometry=this.getBarGeometry(args.x,args.y,options),left=geometry.left,top=geometry.top,width=geometry.width,height=geometry.height;context.save();context.strokeStyle=options.color;context.lineWidth=options.lineWidth;this.translate(context,options.horizontal);context.beginPath();context.moveTo(left,top+height);context.lineTo(left,top);context.lineTo(left+width,top);context.lineTo(left+width,top+height);if(options.fill){context.fillStyle=options.fillStyle;context.fill();}
context.stroke();context.closePath();context.restore();},clearHit:function(options){var
context=options.context,args=options.args,geometry=this.getBarGeometry(args.x,args.y,options),left=geometry.left,width=geometry.width,top=geometry.top,height=geometry.height,lineWidth=2*options.lineWidth;context.save();this.translate(context,options.horizontal);context.clearRect(left-lineWidth,Math.min(top,top+height)-lineWidth,width+2*lineWidth,Math.abs(height)+2*lineWidth);context.restore();},extendXRange:function(axis,data,options,bars){this._extendRange(axis,data,options,bars);},extendYRange:function(axis,data,options,bars){this._extendRange(axis,data,options,bars);},_extendRange:function(axis,data,options,bars){var
max=axis.options.max;if(_.isNumber(max)||_.isString(max))return;var
newmin=axis.min,newmax=axis.max,horizontal=options.horizontal,orientation=axis.orientation,positiveSums=this.positiveSums||{},negativeSums=this.negativeSums||{},value,datum,index,j;if((orientation==1&&!horizontal)||(orientation==-1&&horizontal)){if(options.centered){newmax=Math.max(axis.datamax+options.barWidth,newmax);newmin=Math.min(axis.datamin-options.barWidth,newmin);}}
if(options.stacked&&((orientation==1&&horizontal)||(orientation==-1&&!horizontal))){for(j=data.length;j--;){value=data[j][(orientation==1?1:0)]+'';datum=data[j][(orientation==1?0:1)];if(datum>0){positiveSums[value]=(positiveSums[value]||0)+datum;newmax=Math.max(newmax,positiveSums[value]);}
else{negativeSums[value]=(negativeSums[value]||0)+datum;newmin=Math.min(newmin,negativeSums[value]);}}}
if((orientation==1&&horizontal)||(orientation==-1&&!horizontal)){if(options.topPadding&&(axis.max===axis.datamax||(options.stacked&&this.stackMax!==newmax))){newmax+=options.topPadding*(newmax-newmin);}}
this.stackMin=newmin;this.stackMax=newmax;this.negativeSums=negativeSums;this.positiveSums=positiveSums;axis.max=newmax;axis.min=newmin;}});;Flotr.addType('bubbles',{options:{show:false,lineWidth:2,fill:true,fillOpacity:0.4,baseRadius:2},draw:function(options){var
context=options.context,shadowSize=options.shadowSize;context.save();context.lineWidth=options.lineWidth;context.fillStyle='rgba(0,0,0,0.05)';context.strokeStyle='rgba(0,0,0,0.05)';this.plot(options,shadowSize/2);context.strokeStyle='rgba(0,0,0,0.1)';this.plot(options,shadowSize/4);context.strokeStyle=options.color;context.fillStyle=options.fillStyle;this.plot(options);context.restore();},plot:function(options,offset){var
data=options.data,context=options.context,geometry,i,x,y,z;offset=offset||0;for(i=0;i<data.length;++i){geometry=this.getGeometry(data[i],options);context.beginPath();context.arc(geometry.x+offset,geometry.y+offset,geometry.z,0,2*Math.PI,true);context.stroke();if(options.fill)context.fill();context.closePath();}},getGeometry:function(point,options){return{x:options.xScale(point[0]),y:options.yScale(point[1]),z:point[2]*options.baseRadius};},hit:function(options){var
data=options.data,args=options.args,mouse=args[0],n=args[1],x=mouse.x,y=mouse.y,geometry,dx,dy;for(i=data.length;i--;){geometry=this.getGeometry(data[i],options);dx=geometry.x-options.xScale(x);dy=geometry.y-options.yScale(y);if(Math.sqrt(dx*dx+dy*dy)<geometry.z){n.x=data[i][0];n.y=data[i][1];n.index=i;n.seriesIndex=options.index;}}},drawHit:function(options){var
context=options.context,geometry=this.getGeometry(options.data[options.args.index],options);context.save();context.lineWidth=options.lineWidth;context.fillStyle=options.fillStyle;context.strokeStyle=options.color;context.beginPath();context.arc(geometry.x,geometry.y,geometry.z,0,2*Math.PI,true);context.fill();context.stroke();context.closePath();context.restore();},clearHit:function(options){var
context=options.context,geometry=this.getGeometry(options.data[options.args.index],options),offset=geometry.z+options.lineWidth;context.save();context.clearRect(geometry.x-offset,geometry.y-offset,2*offset,2*offset);context.restore();}});;Flotr.addType('candles',{options:{show:false,lineWidth:1,wickLineWidth:1,candleWidth:0.6,fill:true,upFillColor:'#00A8F0',downFillColor:'#CB4B4B',fillOpacity:0.5,barcharts:false},draw:function(options){var
context=options.context;context.save();context.lineJoin='miter';context.lineCap='butt';context.lineWidth=options.wickLineWidth||options.lineWidth;this.plot(options);context.restore();},plot:function(options){var
data=options.data,context=options.context,xScale=options.xScale,yScale=options.yScale,width=options.candleWidth/2,shadowSize=options.shadowSize,lineWidth=options.lineWidth,wickLineWidth=options.wickLineWidth,pixelOffset=(wickLineWidth%2)/2,color,datum,x,y,open,high,low,close,left,right,bottom,top,bottom2,top2,i;if(data.length<1)return;for(i=0;i<data.length;i++){datum=data[i];x=datum[0];open=datum[1];high=datum[2];low=datum[3];close=datum[4];left=xScale(x-width);right=xScale(x+width);bottom=yScale(low);top=yScale(high);bottom2=yScale(Math.min(open,close));top2=yScale(Math.max(open,close));color=options[open>close?'downFillColor':'upFillColor'];if(options.fill&&!options.barcharts){context.fillStyle='rgba(0,0,0,0.05)';context.fillRect(left+shadowSize,top2+shadowSize,right-left,bottom2-top2);context.save();context.globalAlpha=options.fillOpacity;context.fillStyle=color;context.fillRect(left,top2+lineWidth,right-left,bottom2-top2);context.restore();}
if(lineWidth||wickLineWidth){x=Math.floor((left+right)/2)+pixelOffset;context.strokeStyle=color;context.beginPath();if(options.barcharts){context.moveTo(x,Math.floor(top+width));context.lineTo(x,Math.floor(bottom+width));y=Math.floor(open+width)+0.5;context.moveTo(Math.floor(left)+pixelOffset,y);context.lineTo(x,y);y=Math.floor(close+width)+0.5;context.moveTo(Math.floor(right)+pixelOffset,y);context.lineTo(x,y);}else{context.strokeRect(left,top2+lineWidth,right-left,bottom2-top2);context.moveTo(x,Math.floor(top2+lineWidth));context.lineTo(x,Math.floor(top+lineWidth));context.moveTo(x,Math.floor(bottom2+lineWidth));context.lineTo(x,Math.floor(bottom+lineWidth));}
context.closePath();context.stroke();}}},extendXRange:function(axis,data,options){if(axis.options.max===null){axis.max=Math.max(axis.datamax+0.5,axis.max);axis.min=Math.min(axis.datamin-0.5,axis.min);}}});;Flotr.addType('gantt',{options:{show:false,lineWidth:2,barWidth:1,fill:true,fillColor:null,fillOpacity:0.4,centered:true},draw:function(series){var ctx=this.ctx,bw=series.gantt.barWidth,lw=Math.min(series.gantt.lineWidth,bw);ctx.save();ctx.translate(this.plotOffset.left,this.plotOffset.top);ctx.lineJoin='miter';ctx.lineWidth=lw;ctx.strokeStyle=series.color;ctx.save();this.gantt.plotShadows(series,bw,0,series.gantt.fill);ctx.restore();if(series.gantt.fill){var color=series.gantt.fillColor||series.color;ctx.fillStyle=this.processColor(color,{opacity:series.gantt.fillOpacity});}
this.gantt.plot(series,bw,0,series.gantt.fill);ctx.restore();},plot:function(series,barWidth,offset,fill){var data=series.data;if(data.length<1)return;var xa=series.xaxis,ya=series.yaxis,ctx=this.ctx,i;for(i=0;i<data.length;i++){var y=data[i][0],s=data[i][1],d=data[i][2],drawLeft=true,drawTop=true,drawRight=true;if(s===null||d===null)continue;var left=s,right=s+d,bottom=y-(series.gantt.centered?barWidth/2:0),top=y+barWidth-(series.gantt.centered?barWidth/2:0);if(right<xa.min||left>xa.max||top<ya.min||bottom>ya.max)
continue;if(left<xa.min){left=xa.min;drawLeft=false;}
if(right>xa.max){right=xa.max;if(xa.lastSerie!=series)
drawTop=false;}
if(bottom<ya.min)
bottom=ya.min;if(top>ya.max){top=ya.max;if(ya.lastSerie!=series)
drawTop=false;}
if(fill){ctx.beginPath();ctx.moveTo(xa.d2p(left),ya.d2p(bottom)+offset);ctx.lineTo(xa.d2p(left),ya.d2p(top)+offset);ctx.lineTo(xa.d2p(right),ya.d2p(top)+offset);ctx.lineTo(xa.d2p(right),ya.d2p(bottom)+offset);ctx.fill();ctx.closePath();}
if(series.gantt.lineWidth&&(drawLeft||drawRight||drawTop)){ctx.beginPath();ctx.moveTo(xa.d2p(left),ya.d2p(bottom)+offset);ctx[drawLeft?'lineTo':'moveTo'](xa.d2p(left),ya.d2p(top)+offset);ctx[drawTop?'lineTo':'moveTo'](xa.d2p(right),ya.d2p(top)+offset);ctx[drawRight?'lineTo':'moveTo'](xa.d2p(right),ya.d2p(bottom)+offset);ctx.stroke();ctx.closePath();}}},plotShadows:function(series,barWidth,offset){var data=series.data;if(data.length<1)return;var i,y,s,d,xa=series.xaxis,ya=series.yaxis,ctx=this.ctx,sw=this.options.shadowSize;for(i=0;i<data.length;i++){y=data[i][0];s=data[i][1];d=data[i][2];if(s===null||d===null)continue;var left=s,right=s+d,bottom=y-(series.gantt.centered?barWidth/2:0),top=y+barWidth-(series.gantt.centered?barWidth/2:0);if(right<xa.min||left>xa.max||top<ya.min||bottom>ya.max)
continue;if(left<xa.min)left=xa.min;if(right>xa.max)right=xa.max;if(bottom<ya.min)bottom=ya.min;if(top>ya.max)top=ya.max;var width=xa.d2p(right)-xa.d2p(left)-((xa.d2p(right)+sw<=this.plotWidth)?0:sw);var height=ya.d2p(bottom)-ya.d2p(top)-((ya.d2p(bottom)+sw<=this.plotHeight)?0:sw);ctx.fillStyle='rgba(0,0,0,0.05)';ctx.fillRect(Math.min(xa.d2p(left)+sw,this.plotWidth),Math.min(ya.d2p(top)+sw,this.plotHeight),width,height);}},extendXRange:function(axis){if(axis.options.max===null){var newmin=axis.min,newmax=axis.max,i,j,x,s,g,stackedSumsPos={},stackedSumsNeg={},lastSerie=null;for(i=0;i<this.series.length;++i){s=this.series[i];g=s.gantt;if(g.show&&s.xaxis==axis){for(j=0;j<s.data.length;j++){if(g.show){y=s.data[j][0]+'';stackedSumsPos[y]=Math.max((stackedSumsPos[y]||0),s.data[j][1]+s.data[j][2]);lastSerie=s;}}
for(j in stackedSumsPos){newmax=Math.max(stackedSumsPos[j],newmax);}}}
axis.lastSerie=lastSerie;axis.max=newmax;axis.min=newmin;}},extendYRange:function(axis){if(axis.options.max===null){var newmax=Number.MIN_VALUE,newmin=Number.MAX_VALUE,i,j,s,g,stackedSumsPos={},stackedSumsNeg={},lastSerie=null;for(i=0;i<this.series.length;++i){s=this.series[i];g=s.gantt;if(g.show&&!s.hide&&s.yaxis==axis){var datamax=Number.MIN_VALUE,datamin=Number.MAX_VALUE;for(j=0;j<s.data.length;j++){datamax=Math.max(datamax,s.data[j][0]);datamin=Math.min(datamin,s.data[j][0]);}
if(g.centered){newmax=Math.max(datamax+0.5,newmax);newmin=Math.min(datamin-0.5,newmin);}
else{newmax=Math.max(datamax+1,newmax);newmin=Math.min(datamin,newmin);}
if(g.barWidth+datamax>newmax){newmax=axis.max+g.barWidth;}}}
axis.lastSerie=lastSerie;axis.max=newmax;axis.min=newmin;axis.tickSize=Flotr.getTickSize(axis.options.noTicks,newmin,newmax,axis.options.tickDecimals);}}});;(function(){Flotr.defaultMarkerFormatter=function(obj){return(Math.round(obj.y*100)/100)+'';};Flotr.addType('markers',{options:{show:false,lineWidth:1,color:'#000000',fill:false,fillColor:"#FFFFFF",fillOpacity:0.4,stroke:false,position:'ct',verticalMargin:0,labelFormatter:Flotr.defaultMarkerFormatter,fontSize:Flotr.defaultOptions.fontSize,stacked:false,stackingType:'b',horizontal:false},stack:{positive:[],negative:[],values:[]},draw:function(options){var
data=options.data,context=options.context,stack=options.stacked?options.stack:false,stackType=options.stackingType,stackOffsetNeg,stackOffsetPos,stackOffset,i,x,y,label;context.save();context.lineJoin='round';context.lineWidth=options.lineWidth;context.strokeStyle='rgba(0,0,0,0.5)';context.fillStyle=options.fillStyle;function stackPos(a,b){stackOffsetPos=stack.negative[a]||0;stackOffsetNeg=stack.positive[a]||0;if(b>0){stack.positive[a]=stackOffsetPos+b;return stackOffsetPos+b;}else{stack.negative[a]=stackOffsetNeg+b;return stackOffsetNeg+b;}}
for(i=0;i<data.length;++i){x=data[i][0];y=data[i][1];if(stack){if(stackType=='b'){if(options.horizontal)y=stackPos(y,x);else x=stackPos(x,y);}else if(stackType=='a'){stackOffset=stack.values[x]||0;stack.values[x]=stackOffset+y;y=stackOffset+y;}}
label=options.labelFormatter({x:x,y:y,index:i,data:data});this.plot(options.xScale(x),options.yScale(y),label,options);}
context.restore();},plot:function(x,y,label,options){var context=options.context;if(isImage(label)&&!label.complete){throw'Marker image not loaded.';}else{this._plot(x,y,label,options);}},_plot:function(x,y,label,options){var context=options.context,margin=2,left=x,top=y,dim;if(isImage(label))
dim={height:label.height,width:label.width};else
dim=options.text.canvas(label);dim.width=Math.floor(dim.width+margin*2);dim.height=Math.floor(dim.height+margin*2);if(options.position.indexOf('c')!=-1)left-=dim.width/2+margin;else if(options.position.indexOf('l')!=-1)left-=dim.width;if(options.position.indexOf('m')!=-1)top-=dim.height/2+margin;else if(options.position.indexOf('t')!=-1)top-=dim.height+options.verticalMargin;else top+=options.verticalMargin;left=Math.floor(left)+0.5;top=Math.floor(top)+0.5;if(options.fill)
context.fillRect(left,top,dim.width,dim.height);if(options.stroke)
context.strokeRect(left,top,dim.width,dim.height);if(isImage(label))
context.drawImage(label,left+margin,top+margin);else
Flotr.drawText(context,label,left+margin,top+margin,{textBaseline:'top',textAlign:'left',size:options.fontSize,color:options.color});}});function isImage(i){return typeof i==='object'&&i.constructor&&(Image?true:i.constructor===Image);}})();;(function(){var
_=Flotr._;Flotr.defaultPieLabelFormatter=function(total,value){return(100*value/total).toFixed(2)+'%';};Flotr.addType('pie',{options:{show:false,lineWidth:1,fill:true,fillColor:null,fillOpacity:0.6,explode:6,sizeRatio:0.6,startAngle:Math.PI/4,labelFormatter:Flotr.defaultPieLabelFormatter,pie3D:false,pie3DviewAngle:(Math.PI/2*0.8),pie3DspliceThickness:20},draw:function(options){var
data=options.data,context=options.context,canvas=context.canvas,lineWidth=options.lineWidth,shadowSize=options.shadowSize,sizeRatio=options.sizeRatio,height=options.height,width=options.width,explode=options.explode,color=options.color,fill=options.fill,fillStyle=options.fillStyle,radius=Math.min(canvas.width,canvas.height)*sizeRatio/2,value=data[0][1],html=[],vScale=1,measure=Math.PI*2*value/this.total,startAngle=this.startAngle||(2*Math.PI*options.startAngle),endAngle=startAngle+measure,bisection=startAngle+measure/2,label=options.labelFormatter(this.total,value),explodeCoeff=explode+radius+4,distX=Math.cos(bisection)*explodeCoeff,distY=Math.sin(bisection)*explodeCoeff,textAlign=distX<0?'right':'left',textBaseline=distY>0?'top':'bottom',style,x,y,distX,distY;context.save();context.translate(width/2,height/2);context.scale(1,vScale);x=Math.cos(bisection)*explode;y=Math.sin(bisection)*explode;if(shadowSize>0){this.plotSlice(x+shadowSize,y+shadowSize,radius,startAngle,endAngle,context);if(fill){context.fillStyle='rgba(0,0,0,0.1)';context.fill();}}
this.plotSlice(x,y,radius,startAngle,endAngle,context);if(fill){context.fillStyle=fillStyle;context.fill();}
context.lineWidth=lineWidth;context.strokeStyle=color;context.stroke();style={size:options.fontSize*1.2,color:options.fontColor,weight:1.5};if(label){if(options.htmlText||!options.textEnabled){divStyle='position:absolute;'+textBaseline+':'+(height/2+(textBaseline==='top'?distY:-distY))+'px;';divStyle+=textAlign+':'+(width/2+(textAlign==='right'?-distX:distX))+'px;';html.push('<div style="',divStyle,'" class="flotr-grid-label">',label,'</div>');}
else{style.textAlign=textAlign;style.textBaseline=textBaseline;Flotr.drawText(context,label,distX,distY,style);}}
if(options.htmlText||!options.textEnabled){var div=Flotr.DOM.node('<div style="color:'+options.fontColor+'" class="flotr-labels"></div>');Flotr.DOM.insert(div,html.join(''));Flotr.DOM.insert(options.element,div);}
context.restore();this.startAngle=endAngle;this.slices=this.slices||[];this.slices.push({radius:Math.min(canvas.width,canvas.height)*sizeRatio/2,x:x,y:y,explode:explode,start:startAngle,end:endAngle});},plotSlice:function(x,y,radius,startAngle,endAngle,context){context.beginPath();context.moveTo(x,y);context.arc(x,y,radius,startAngle,endAngle,false);context.lineTo(x,y);context.closePath();},hit:function(options){var
data=options.data[0],args=options.args,index=options.index,mouse=args[0],n=args[1],slice=this.slices[index],x=mouse.relX-options.width/2,y=mouse.relY-options.height/2,r=Math.sqrt(x*x+y*y),theta=Math.atan(y/x),circle=Math.PI*2,explode=slice.explode||options.explode,start=slice.start%circle,end=slice.end%circle;if(x<0){theta+=Math.PI;}else if(x>0&&y<0){theta+=circle;}
if(r<slice.radius+explode&&r>explode){if((start>end&&(theta<end||theta>start))||(theta>start&&theta<end)){n.x=data[0];n.y=data[1];n.sAngle=start;n.eAngle=end;n.index=0;n.seriesIndex=index;n.fraction=data[1]/this.total;}}},drawHit:function(options){var
context=options.context,slice=this.slices[options.args.seriesIndex];context.save();context.translate(options.width/2,options.height/2);this.plotSlice(slice.x,slice.y,slice.radius,slice.start,slice.end,context);context.stroke();context.restore();},clearHit:function(options){var
context=options.context,slice=this.slices[options.args.seriesIndex],padding=2*options.lineWidth,radius=slice.radius+padding;context.save();context.translate(options.width/2,options.height/2);context.clearRect(slice.x-radius,slice.y-radius,2*radius+padding,2*radius+padding);context.restore();},extendYRange:function(axis,data){this.total=(this.total||0)+data[0][1];}});})();;Flotr.addType('points',{options:{show:false,radius:3,lineWidth:2,fill:true,fillColor:'#FFFFFF',fillOpacity:0.4},draw:function(options){var
context=options.context,lineWidth=options.lineWidth,shadowSize=options.shadowSize;context.save();if(shadowSize>0){context.lineWidth=shadowSize/2;context.strokeStyle='rgba(0,0,0,0.1)';this.plot(options,shadowSize/2+context.lineWidth/2);context.strokeStyle='rgba(0,0,0,0.2)';this.plot(options,context.lineWidth/2);}
context.lineWidth=options.lineWidth;context.strokeStyle=options.color;context.fillStyle=options.fillColor||options.color;this.plot(options);context.restore();},plot:function(options,offset){var
data=options.data,context=options.context,xScale=options.xScale,yScale=options.yScale,i,x,y;for(i=data.length-1;i>-1;--i){y=data[i][1];if(y===null)continue;x=xScale(data[i][0]);y=yScale(y);if(x<0||x>options.width||y<0||y>options.height)continue;context.beginPath();if(offset){context.arc(x,y+offset,options.radius,0,Math.PI,false);}else{context.arc(x,y,options.radius,0,2*Math.PI,true);if(options.fill)context.fill();}
context.stroke();context.closePath();}}});;Flotr.addType('radar',{options:{show:false,lineWidth:2,fill:true,fillOpacity:0.4,radiusRatio:0.90},draw:function(options){var
context=options.context,shadowSize=options.shadowSize;context.save();context.translate(options.width/2,options.height/2);context.lineWidth=options.lineWidth;context.fillStyle='rgba(0,0,0,0.05)';context.strokeStyle='rgba(0,0,0,0.05)';this.plot(options,shadowSize/2);context.strokeStyle='rgba(0,0,0,0.1)';this.plot(options,shadowSize/4);context.strokeStyle=options.color;context.fillStyle=options.fillStyle;this.plot(options);context.restore();},plot:function(options,offset){var
data=options.data,context=options.context,radius=Math.min(options.height,options.width)*options.radiusRatio/2,step=2*Math.PI/data.length,angle=-Math.PI/2,i,ratio;offset=offset||0;context.beginPath();for(i=0;i<data.length;++i){ratio=data[i][1]/this.max;context[i===0?'moveTo':'lineTo'](Math.cos(i*step+angle)*radius*ratio+offset,Math.sin(i*step+angle)*radius*ratio+offset);}
context.closePath();if(options.fill)context.fill();context.stroke();},extendYRange:function(axis,data){this.max=Math.max(axis.max,this.max||-Number.MAX_VALUE);}});;Flotr.addType('timeline',{options:{show:false,lineWidth:1,barWidth:0.2,fill:true,fillColor:null,fillOpacity:0.4,centered:true},draw:function(options){var
context=options.context;context.save();context.lineJoin='miter';context.lineWidth=options.lineWidth;context.strokeStyle=options.color;context.fillStyle=options.fillStyle;this.plot(options);context.restore();},plot:function(options){var
data=options.data,context=options.context,xScale=options.xScale,yScale=options.yScale,barWidth=options.barWidth,lineWidth=options.lineWidth,i;Flotr._.each(data,function(timeline){var
x=timeline[0],y=timeline[1],w=timeline[2],h=barWidth,xt=Math.ceil(xScale(x)),wt=Math.ceil(xScale(x+w))-xt,yt=Math.round(yScale(y)),ht=Math.round(yScale(y-h))-yt,x0=xt-lineWidth/2,y0=Math.round(yt-ht/2)-lineWidth/2;context.strokeRect(x0,y0,wt,ht);context.fillRect(x0,y0,wt,ht);});},extendRange:function(series){var
data=series.data,xa=series.xaxis,ya=series.yaxis,w=series.timeline.barWidth;if(xa.options.min===null)
xa.min=xa.datamin-w/2;if(xa.options.max===null){var
max=xa.max;Flotr._.each(data,function(timeline){max=Math.max(max,timeline[0]+timeline[2]);},this);xa.max=max+w/2;}
if(ya.options.min===null)
ya.min=ya.datamin-w;if(ya.options.min===null)
ya.max=ya.datamax+w;}});;(function(){var D=Flotr.DOM;Flotr.addPlugin('crosshair',{options:{mode:null,color:'#FF0000',hideCursor:true},callbacks:{'flotr:mousemove':function(e,pos){if(this.options.crosshair.mode){this.crosshair.clearCrosshair();this.crosshair.drawCrosshair(pos);}}},drawCrosshair:function(pos){var octx=this.octx,options=this.options.crosshair,plotOffset=this.plotOffset,x=plotOffset.left+pos.relX+0.5,y=plotOffset.top+pos.relY+0.5;if(pos.relX<0||pos.relY<0||pos.relX>this.plotWidth||pos.relY>this.plotHeight){this.el.style.cursor=null;D.removeClass(this.el,'flotr-crosshair');return;}
if(options.hideCursor){this.el.style.cursor='none';D.addClass(this.el,'flotr-crosshair');}
octx.save();octx.strokeStyle=options.color;octx.lineWidth=1;octx.beginPath();if(options.mode.indexOf('x')!=-1){octx.moveTo(x,plotOffset.top);octx.lineTo(x,plotOffset.top+this.plotHeight);}
if(options.mode.indexOf('y')!=-1){octx.moveTo(plotOffset.left,y);octx.lineTo(plotOffset.left+this.plotWidth,y);}
octx.stroke();octx.restore();},clearCrosshair:function(){var
plotOffset=this.plotOffset,position=this.lastMousePos,context=this.octx;if(position){context.clearRect(position.relX+plotOffset.left,plotOffset.top,1,this.plotHeight+1);context.clearRect(plotOffset.left,position.relY+plotOffset.top,this.plotWidth+1,1);}}});})();;(function(){var
D=Flotr.DOM,_=Flotr._;function getImage(type,canvas,width,height){var
mime='image/'+type,data=canvas.toDataURL(mime),image=new Image();image.src=data;return image;}
Flotr.addPlugin('download',{saveImage:function(type,width,height,replaceCanvas){var image=null;if(Flotr.isIE&&Flotr.isIE<9){image='<html><body>'+this.canvas.firstChild.innerHTML+'</body></html>';return window.open().document.write(image);}
if(type!=='jpeg'&&type!=='png')return;image=getImage(type,this.canvas,width,height);if(_.isElement(image)&&replaceCanvas){this.download.restoreCanvas();D.hide(this.canvas);D.hide(this.overlay);D.setStyles({position:'absolute'});D.insert(this.el,image);this.saveImageElement=image;}else{return window.open(image.src);}},restoreCanvas:function(){D.show(this.canvas);D.show(this.overlay);if(this.saveImageElement)this.el.removeChild(this.saveImageElement);this.saveImageElement=null;}});})();;(function(){var E=Flotr.EventAdapter,_=Flotr._;Flotr.addPlugin('graphGrid',{callbacks:{'flotr:beforedraw':function(){this.graphGrid.drawGrid();},'flotr:afterdraw':function(){this.graphGrid.drawOutline();}},drawGrid:function(){var
ctx=this.ctx,options=this.options,grid=options.grid,verticalLines=grid.verticalLines,horizontalLines=grid.horizontalLines,minorVerticalLines=grid.minorVerticalLines,minorHorizontalLines=grid.minorHorizontalLines,plotHeight=this.plotHeight,plotWidth=this.plotWidth,a,v,i,j;if(verticalLines||minorVerticalLines||horizontalLines||minorHorizontalLines){E.fire(this.el,'flotr:beforegrid',[this.axes.x,this.axes.y,options,this]);}
ctx.save();ctx.lineWidth=1;ctx.strokeStyle=grid.tickColor;function circularHorizontalTicks(ticks){for(i=0;i<ticks.length;++i){var ratio=ticks[i].v/a.max;for(j=0;j<=sides;++j){ctx[j===0?'moveTo':'lineTo'](Math.cos(j*coeff+angle)*radius*ratio,Math.sin(j*coeff+angle)*radius*ratio);}}}
function drawGridLines(ticks,callback){_.each(_.pluck(ticks,'v'),function(v){if((v<=a.min||v>=a.max)||(v==a.min||v==a.max)&&grid.outlineWidth)
return;callback(Math.floor(a.d2p(v))+ctx.lineWidth/2);});}
function drawVerticalLines(x){ctx.moveTo(x,0);ctx.lineTo(x,plotHeight);}
function drawHorizontalLines(y){ctx.moveTo(0,y);ctx.lineTo(plotWidth,y);}
if(grid.circular){ctx.translate(this.plotOffset.left+plotWidth/2,this.plotOffset.top+plotHeight/2);var radius=Math.min(plotHeight,plotWidth)*options.radar.radiusRatio/2,sides=this.axes.x.ticks.length,coeff=2*(Math.PI/sides),angle=-Math.PI/2;ctx.beginPath();a=this.axes.y;if(horizontalLines){circularHorizontalTicks(a.ticks);}
if(minorHorizontalLines){circularHorizontalTicks(a.minorTicks);}
if(verticalLines){_.times(sides,function(i){ctx.moveTo(0,0);ctx.lineTo(Math.cos(i*coeff+angle)*radius,Math.sin(i*coeff+angle)*radius);});}
ctx.stroke();}
else{ctx.translate(this.plotOffset.left,this.plotOffset.top);if(grid.backgroundColor){ctx.fillStyle=this.processColor(grid.backgroundColor,{x1:0,y1:0,x2:plotWidth,y2:plotHeight});ctx.fillRect(0,0,plotWidth,plotHeight);}
ctx.beginPath();a=this.axes.x;if(verticalLines)drawGridLines(a.ticks,drawVerticalLines);if(minorVerticalLines)drawGridLines(a.minorTicks,drawVerticalLines);a=this.axes.y;if(horizontalLines)drawGridLines(a.ticks,drawHorizontalLines);if(minorHorizontalLines)drawGridLines(a.minorTicks,drawHorizontalLines);ctx.stroke();}
ctx.restore();if(verticalLines||minorVerticalLines||horizontalLines||minorHorizontalLines){E.fire(this.el,'flotr:aftergrid',[this.axes.x,this.axes.y,options,this]);}},drawOutline:function(){var
that=this,options=that.options,grid=options.grid,outline=grid.outline,ctx=that.ctx,backgroundImage=grid.backgroundImage,plotOffset=that.plotOffset,leftOffset=plotOffset.left,topOffset=plotOffset.top,plotWidth=that.plotWidth,plotHeight=that.plotHeight,v,img,src,left,top,globalAlpha;if(!grid.outlineWidth)return;ctx.save();if(grid.circular){ctx.translate(leftOffset+plotWidth/2,topOffset+plotHeight/2);var radius=Math.min(plotHeight,plotWidth)*options.radar.radiusRatio/2,sides=this.axes.x.ticks.length,coeff=2*(Math.PI/sides),angle=-Math.PI/2;ctx.beginPath();ctx.lineWidth=grid.outlineWidth;ctx.strokeStyle=grid.color;ctx.lineJoin='round';for(i=0;i<=sides;++i){ctx[i===0?'moveTo':'lineTo'](Math.cos(i*coeff+angle)*radius,Math.sin(i*coeff+angle)*radius);}
ctx.stroke();}
else{ctx.translate(leftOffset,topOffset);var lw=grid.outlineWidth,orig=0.5-lw+((lw+1)%2/2),lineTo='lineTo',moveTo='moveTo';ctx.lineWidth=lw;ctx.strokeStyle=grid.color;ctx.lineJoin='miter';ctx.beginPath();ctx.moveTo(orig,orig);plotWidth=plotWidth-(lw/2)%1;plotHeight=plotHeight+lw/2;ctx[outline.indexOf('n')!==-1?lineTo:moveTo](plotWidth,orig);ctx[outline.indexOf('e')!==-1?lineTo:moveTo](plotWidth,plotHeight);ctx[outline.indexOf('s')!==-1?lineTo:moveTo](orig,plotHeight);ctx[outline.indexOf('w')!==-1?lineTo:moveTo](orig,orig);ctx.stroke();ctx.closePath();}
ctx.restore();if(backgroundImage){src=backgroundImage.src||backgroundImage;left=(parseInt(backgroundImage.left,10)||0)+plotOffset.left;top=(parseInt(backgroundImage.top,10)||0)+plotOffset.top;img=new Image();img.onload=function(){ctx.save();if(backgroundImage.alpha)ctx.globalAlpha=backgroundImage.alpha;ctx.globalCompositeOperation='destination-over';ctx.drawImage(img,0,0,img.width,img.height,left,top,plotWidth,plotHeight);ctx.restore();};img.src=src;}}});})();;(function(){var
D=Flotr.DOM,_=Flotr._,flotr=Flotr,S_MOUSETRACK='opacity:0.7;background-color:#000;color:#fff;display:none;position:absolute;padding:2px 8px;-moz-border-radius:4px;border-radius:4px;white-space:nowrap;';Flotr.addPlugin('hit',{callbacks:{'flotr:mousemove':function(e,pos){this.hit.track(pos);},'flotr:click':function(pos){this.hit.track(pos);},'flotr:mouseout':function(){this.hit.clearHit();}},track:function(pos){if(this.options.mouse.track||_.any(this.series,function(s){return s.mouse&&s.mouse.track;})){this.hit.hit(pos);}},executeOnType:function(s,method,args){var
success=false,options;if(!_.isArray(s))s=[s];function e(s,index){_.each(_.keys(flotr.graphTypes),function(type){if(s[type]&&s[type].show&&this[type][method]){options=this.getOptions(s,type);options.fill=!!s.mouse.fillColor;options.fillStyle=this.processColor(s.mouse.fillColor||'#ffffff',{opacity:s.mouse.fillOpacity});options.color=s.mouse.lineColor;options.context=this.octx;options.index=index;if(args)options.args=args;this[type][method].call(this[type],options);success=true;}},this);}
_.each(s,e,this);return success;},drawHit:function(n){var octx=this.octx,s=n.series;if(s.mouse.lineColor){octx.save();octx.lineWidth=(s.points?s.points.lineWidth:1);octx.strokeStyle=s.mouse.lineColor;octx.fillStyle=this.processColor(s.mouse.fillColor||'#ffffff',{opacity:s.mouse.fillOpacity});octx.translate(this.plotOffset.left,this.plotOffset.top);if(!this.hit.executeOnType(s,'drawHit',n)){var xa=n.xaxis,ya=n.yaxis;octx.beginPath();octx.arc(xa.d2p(n.x),ya.d2p(n.y),s.points.radius||s.mouse.radius,0,2*Math.PI,true);octx.fill();octx.stroke();octx.closePath();}
octx.restore();}
this.prevHit=n;},clearHit:function(){var prev=this.prevHit,octx=this.octx,plotOffset=this.plotOffset;octx.save();octx.translate(plotOffset.left,plotOffset.top);if(prev){if(!this.hit.executeOnType(prev.series,'clearHit',this.prevHit)){var
s=prev.series,lw=(s.points?s.points.lineWidth:1);offset=(s.points.radius||s.mouse.radius)+lw;octx.clearRect(prev.xaxis.d2p(prev.x)-offset,prev.yaxis.d2p(prev.y)-offset,offset*2,offset*2);}
D.hide(this.mouseTrack);this.prevHit=null;}
octx.restore();},hit:function(mouse){var
options=this.options,prevHit=this.prevHit,closest,sensibility,dataIndex,seriesIndex,series,value,xaxis,yaxis;if(this.series.length===0)return;n={relX:mouse.relX,relY:mouse.relY,absX:mouse.absX,absY:mouse.absY};if(options.mouse.trackY&&!options.mouse.trackAll&&this.hit.executeOnType(this.series,'hit',[mouse,n]))
{if(!_.isUndefined(n.seriesIndex)){series=this.series[n.seriesIndex];n.series=series;n.mouse=series.mouse;n.xaxis=series.xaxis;n.yaxis=series.yaxis;}}else{closest=this.hit.closest(mouse);if(closest){closest=options.mouse.trackY?closest.point:closest.x;seriesIndex=closest.seriesIndex;series=this.series[seriesIndex];xaxis=series.xaxis;yaxis=series.yaxis;sensibility=2*series.mouse.sensibility;if
(options.mouse.trackAll||(closest.distanceX<sensibility/xaxis.scale&&(!options.mouse.trackY||closest.distanceY<sensibility/yaxis.scale)))
{n.series=series;n.xaxis=series.xaxis;n.yaxis=series.yaxis;n.mouse=series.mouse;n.x=closest.x;n.y=closest.y;n.dist=closest.distance;n.index=closest.dataIndex;n.seriesIndex=seriesIndex;}}}
if(!prevHit||(prevHit.index!==n.index||prevHit.seriesIndex!==n.seriesIndex)){this.hit.clearHit();if(n.series&&n.mouse&&n.mouse.track){this.hit.drawMouseTrack(n);this.hit.drawHit(n);Flotr.EventAdapter.fire(this.el,'flotr:hit',[n,this]);}}},closest:function(mouse){var
series=this.series,options=this.options,mouseX=mouse.x,mouseY=mouse.y,compare=Number.MAX_VALUE,compareX=Number.MAX_VALUE,closest={},closestX={},check=false,serie,data,distance,distanceX,distanceY,x,y,i,j;function setClosest(o){o.distance=distance;o.distanceX=distanceX;o.distanceY=distanceY;o.seriesIndex=i;o.dataIndex=j;o.x=x;o.y=y;}
for(i=0;i<series.length;i++){serie=series[i];data=serie.data;if(data.length)check=true;for(j=data.length;j--;){x=data[j][0];y=data[j][1];if(x===null||y===null)continue;if(x<serie.xaxis.min||x>serie.xaxis.max)continue;distanceX=Math.abs(x-mouseX);distanceY=Math.abs(y-mouseY);distance=distanceX*distanceX+distanceY*distanceY;if(distance<compare){compare=distance;setClosest(closest);}
if(distanceX<compareX){compareX=distanceX;setClosest(closestX);}}}
return check?{point:closest,x:closestX}:false;},drawMouseTrack:function(n){var
pos='',s=n.series,p=n.mouse.position,m=n.mouse.margin,elStyle=S_MOUSETRACK,mouseTrack=this.mouseTrack,plotOffset=this.plotOffset,left=plotOffset.left,right=plotOffset.right,bottom=plotOffset.bottom,top=plotOffset.top,decimals=n.mouse.trackDecimals,options=this.options;if(!mouseTrack){mouseTrack=D.node('<div class="flotr-mouse-value"></div>');this.mouseTrack=mouseTrack;D.insert(this.el,mouseTrack);}
if(!n.mouse.relative){if(p.charAt(0)=='n')pos+='top:'+(m+top)+'px;bottom:auto;';else if(p.charAt(0)=='s')pos+='bottom:'+(m+bottom)+'px;top:auto;';if(p.charAt(1)=='e')pos+='right:'+(m+right)+'px;left:auto;';else if(p.charAt(1)=='w')pos+='left:'+(m+left)+'px;right:auto;';}else if(s.bars.show){pos+='bottom:'+(m-top-n.yaxis.d2p(n.y/2)+this.canvasHeight)+'px;top:auto;';pos+='left:'+(m+left+n.xaxis.d2p(n.x-options.bars.barWidth/2))+'px;right:auto;';}else if(s.pie.show){var center={x:(this.plotWidth)/2,y:(this.plotHeight)/2},radius=(Math.min(this.canvasWidth,this.canvasHeight)*s.pie.sizeRatio)/2,bisection=n.sAngle<n.eAngle?(n.sAngle+n.eAngle)/2:(n.sAngle+n.eAngle+2*Math.PI)/2;pos+='bottom:'+(m-top-center.y-Math.sin(bisection)*radius/2+this.canvasHeight)+'px;top:auto;';pos+='left:'+(m+left+center.x+Math.cos(bisection)*radius/2)+'px;right:auto;';}else{if(p.charAt(0)=='n')pos+='bottom:'+(m-top-n.yaxis.d2p(n.y)+this.canvasHeight)+'px;top:auto;';else if(p.charAt(0)=='s')pos+='top:'+(m+top+n.yaxis.d2p(n.y))+'px;bottom:auto;';if(p.charAt(1)=='e')pos+='left:'+(m+left+n.xaxis.d2p(n.x))+'px;right:auto;';else if(p.charAt(1)=='w')pos+='right:'+(m-left-n.xaxis.d2p(n.x)+this.canvasWidth)+'px;left:auto;';}
elStyle+=pos;mouseTrack.style.cssText=elStyle;if(!decimals||decimals<0)decimals=0;mouseTrack.innerHTML=n.mouse.trackFormatter({x:n.x.toFixed(decimals),y:n.y.toFixed(decimals),series:n.series,index:n.index,nearest:n,fraction:n.fraction});D.show(mouseTrack);}});})();;(function(){function isLeftClick(e,type){return(e.which?(e.which===1):(e.button===0||e.button===1));}
function boundX(x,graph){return Math.min(Math.max(0,x),graph.plotWidth-1);}
function boundY(y,graph){return Math.min(Math.max(0,y),graph.plotHeight);}
var
D=Flotr.DOM,E=Flotr.EventAdapter,_=Flotr._;Flotr.addPlugin('selection',{options:{pinchOnly:null,mode:null,color:'#B6D9FF',fps:20},callbacks:{'flotr:mouseup':function(event){var
options=this.options.selection,selection=this.selection,pointer=this.getEventPosition(event);if(!options||!options.mode)return;if(selection.interval)clearInterval(selection.interval);if(this.multitouches){selection.updateSelection();}else
if(!options.pinchOnly){selection.setSelectionPos(selection.selection.second,pointer);}
selection.clearSelection();if(selection.selecting&&selection.selectionIsSane()){selection.drawSelection();selection.fireSelectEvent();this.ignoreClick=true;}},'flotr:mousedown':function(event){var
options=this.options.selection,selection=this.selection,pointer=this.getEventPosition(event);if(!options||!options.mode)return;if(!options.mode||(!isLeftClick(event)&&_.isUndefined(event.touches)))return;if(!options.pinchOnly)selection.setSelectionPos(selection.selection.first,pointer);if(selection.interval)clearInterval(selection.interval);this.lastMousePos.pageX=null;selection.selecting=false;selection.interval=setInterval(_.bind(selection.updateSelection,this),1000/options.fps);},'flotr:destroy':function(event){clearInterval(this.selection.interval);}},getArea:function(){var s=this.selection.selection,first=s.first,second=s.second;return{x1:Math.min(first.x,second.x),x2:Math.max(first.x,second.x),y1:Math.min(first.y,second.y),y2:Math.max(first.y,second.y)};},selection:{first:{x:-1,y:-1},second:{x:-1,y:-1}},prevSelection:null,interval:null,fireSelectEvent:function(name){var a=this.axes,s=this.selection.selection,x1,x2,y1,y2;name=name||'select';x1=a.x.p2d(s.first.x);x2=a.x.p2d(s.second.x);y1=a.y.p2d(s.first.y);y2=a.y.p2d(s.second.y);E.fire(this.el,'flotr:'+name,[{x1:Math.min(x1,x2),y1:Math.min(y1,y2),x2:Math.max(x1,x2),y2:Math.max(y1,y2),xfirst:x1,xsecond:x2,yfirst:y1,ysecond:y2},this]);},setSelection:function(area,preventEvent){var options=this.options,xa=this.axes.x,ya=this.axes.y,vertScale=ya.scale,hozScale=xa.scale,selX=options.selection.mode.indexOf('x')!=-1,selY=options.selection.mode.indexOf('y')!=-1,s=this.selection.selection;this.selection.clearSelection();s.first.y=boundY((selX&&!selY)?0:(ya.max-area.y1)*vertScale,this);s.second.y=boundY((selX&&!selY)?this.plotHeight-1:(ya.max-area.y2)*vertScale,this);s.first.x=boundX((selY&&!selX)?0:area.x1,this);s.second.x=boundX((selY&&!selX)?this.plotWidth:area.x2,this);this.selection.drawSelection();if(!preventEvent)
this.selection.fireSelectEvent();},setSelectionPos:function(pos,pointer){var mode=this.options.selection.mode,selection=this.selection.selection;if(mode.indexOf('x')==-1){pos.x=(pos==selection.first)?0:this.plotWidth;}else{pos.x=boundX(pointer.relX,this);}
if(mode.indexOf('y')==-1){pos.y=(pos==selection.first)?0:this.plotHeight-1;}else{pos.y=boundY(pointer.relY,this);}},drawSelection:function(){this.selection.fireSelectEvent('selecting');var s=this.selection.selection,octx=this.octx,options=this.options,plotOffset=this.plotOffset,prevSelection=this.selection.prevSelection;if(prevSelection&&s.first.x==prevSelection.first.x&&s.first.y==prevSelection.first.y&&s.second.x==prevSelection.second.x&&s.second.y==prevSelection.second.y){return;}
octx.save();octx.strokeStyle=this.processColor(options.selection.color,{opacity:0.8});octx.lineWidth=1;octx.lineJoin='miter';octx.fillStyle=this.processColor(options.selection.color,{opacity:0.4});this.selection.prevSelection={first:{x:s.first.x,y:s.first.y},second:{x:s.second.x,y:s.second.y}};var x=Math.min(s.first.x,s.second.x),y=Math.min(s.first.y,s.second.y),w=Math.abs(s.second.x-s.first.x),h=Math.abs(s.second.y-s.first.y);octx.fillRect(x+plotOffset.left+0.5,y+plotOffset.top+0.5,w,h);octx.strokeRect(x+plotOffset.left+0.5,y+plotOffset.top+0.5,w,h);octx.restore();},updateSelection:function(){if(!this.lastMousePos.pageX)return;this.selection.selecting=true;if(this.multitouches){this.selection.setSelectionPos(this.selection.selection.first,this.getEventPosition(this.multitouches[0]));this.selection.setSelectionPos(this.selection.selection.second,this.getEventPosition(this.multitouches[1]));}else
if(this.options.selection.pinchOnly){return;}else{this.selection.setSelectionPos(this.selection.selection.second,this.lastMousePos);}
this.selection.clearSelection();if(this.selection.selectionIsSane()){this.selection.drawSelection();}},clearSelection:function(){if(!this.selection.prevSelection)return;var prevSelection=this.selection.prevSelection,lw=1,plotOffset=this.plotOffset,x=Math.min(prevSelection.first.x,prevSelection.second.x),y=Math.min(prevSelection.first.y,prevSelection.second.y),w=Math.abs(prevSelection.second.x-prevSelection.first.x),h=Math.abs(prevSelection.second.y-prevSelection.first.y);this.octx.clearRect(x+plotOffset.left-lw+0.5,y+plotOffset.top-lw,w+2*lw+0.5,h+2*lw+0.5);this.selection.prevSelection=null;},selectionIsSane:function(){var s=this.selection.selection;return Math.abs(s.second.x-s.first.x)>=5||Math.abs(s.second.y-s.first.y)>=5;}});})();;(function(){var D=Flotr.DOM;Flotr.addPlugin('labels',{callbacks:{'flotr:afterdraw':function(){this.labels.draw();}},draw:function(){var
axis,tick,left,top,xBoxWidth,radius,sides,coeff,angle,div,i,html='',noLabels=0,options=this.options,ctx=this.ctx,a=this.axes,style={size:options.fontSize};for(i=0;i<a.x.ticks.length;++i){if(a.x.ticks[i].label){++noLabels;}}
xBoxWidth=this.plotWidth/noLabels;if(options.grid.circular){ctx.save();ctx.translate(this.plotOffset.left+this.plotWidth/2,this.plotOffset.top+this.plotHeight/2);radius=this.plotHeight*options.radar.radiusRatio/2+options.fontSize;sides=this.axes.x.ticks.length;coeff=2*(Math.PI/sides);angle=-Math.PI/2;drawLabelCircular(this,a.x,false);drawLabelCircular(this,a.x,true);drawLabelCircular(this,a.y,false);drawLabelCircular(this,a.y,true);ctx.restore();}
if(!options.HtmlText&&this.textEnabled){drawLabelNoHtmlText(this,a.x,'center','top');drawLabelNoHtmlText(this,a.x2,'center','bottom');drawLabelNoHtmlText(this,a.y,'right','middle');drawLabelNoHtmlText(this,a.y2,'left','middle');}else if((a.x.options.showLabels||a.x2.options.showLabels||a.y.options.showLabels||a.y2.options.showLabels)&&!options.grid.circular){html='';drawLabelHtml(this,a.x);drawLabelHtml(this,a.x2);drawLabelHtml(this,a.y);drawLabelHtml(this,a.y2);ctx.stroke();ctx.restore();div=D.create('div');D.setStyles(div,{fontSize:'smaller',color:options.grid.color});div.className='flotr-labels';D.insert(this.el,div);D.insert(div,html);}
function drawLabelCircular(graph,axis,minorTicks){var
ticks=minorTicks?axis.minorTicks:axis.ticks,isX=axis.orientation===1,isFirst=axis.n===1,style,offset;style={color:axis.options.color||options.grid.color,angle:Flotr.toRad(axis.options.labelsAngle),textBaseline:'middle'};for(i=0;i<ticks.length&&(minorTicks?axis.options.showMinorLabels:axis.options.showLabels);++i){tick=ticks[i];tick.label+='';if(!tick.label||!tick.label.length){continue;}
x=Math.cos(i*coeff+angle)*radius;y=Math.sin(i*coeff+angle)*radius;style.textAlign=isX?(Math.abs(x)<0.1?'center':(x<0?'right':'left')):'left';Flotr.drawText(ctx,tick.label,isX?x:3,isX?y:-(axis.ticks[i].v/axis.max)*(radius-options.fontSize),style);}}
function drawLabelNoHtmlText(graph,axis,textAlign,textBaseline){var
isX=axis.orientation===1,isFirst=axis.n===1,style,offset;style={color:axis.options.color||options.grid.color,textAlign:textAlign,textBaseline:textBaseline,angle:Flotr.toRad(axis.options.labelsAngle)};style=Flotr.getBestTextAlign(style.angle,style);for(i=0;i<axis.ticks.length&&continueShowingLabels(axis);++i){tick=axis.ticks[i];if(!tick.label||!tick.label.length){continue;}
offset=axis.d2p(tick.v);if(offset<0||offset>(isX?graph.plotWidth:graph.plotHeight)){continue;}
Flotr.drawText(ctx,tick.label,leftOffset(graph,isX,isFirst,offset),topOffset(graph,isX,isFirst,offset),style);if(!isX&&!isFirst){ctx.save();ctx.strokeStyle=style.color;ctx.beginPath();ctx.moveTo(graph.plotOffset.left+graph.plotWidth-8,graph.plotOffset.top+axis.d2p(tick.v));ctx.lineTo(graph.plotOffset.left+graph.plotWidth,graph.plotOffset.top+axis.d2p(tick.v));ctx.stroke();ctx.restore();}}
function continueShowingLabels(axis){return axis.options.showLabels&&axis.used;}
function leftOffset(graph,isX,isFirst,offset){return graph.plotOffset.left+
(isX?offset:(isFirst?-options.grid.labelMargin:options.grid.labelMargin+graph.plotWidth));}
function topOffset(graph,isX,isFirst,offset){return graph.plotOffset.top+
(isX?options.grid.labelMargin:offset)+
((isX&&isFirst)?graph.plotHeight:0);}}
function drawLabelHtml(graph,axis){var
isX=axis.orientation===1,isFirst=axis.n===1,name='',left,style,top,offset=graph.plotOffset;if(!isX&&!isFirst){ctx.save();ctx.strokeStyle=axis.options.color||options.grid.color;ctx.beginPath();}
if(axis.options.showLabels&&(isFirst?true:axis.used)){for(i=0;i<axis.ticks.length;++i){tick=axis.ticks[i];if(!tick.label||!tick.label.length||((isX?offset.left:offset.top)+axis.d2p(tick.v)<0)||((isX?offset.left:offset.top)+axis.d2p(tick.v)>(isX?graph.canvasWidth:graph.canvasHeight))){continue;}
top=offset.top+
(isX?((isFirst?1:-1)*(graph.plotHeight+options.grid.labelMargin)):axis.d2p(tick.v)-axis.maxLabel.height/2);left=isX?(offset.left+axis.d2p(tick.v)-xBoxWidth/2):0;name='';if(i===0){name=' first';}else if(i===axis.ticks.length-1){name=' last';}
name+=isX?' flotr-grid-label-x':' flotr-grid-label-y';html+=['<div style="position:absolute; text-align:'+(isX?'center':'right')+'; ','top:'+top+'px; ',((!isX&&!isFirst)?'right:':'left:')+left+'px; ','width:'+(isX?xBoxWidth:((isFirst?offset.left:offset.right)-options.grid.labelMargin))+'px; ',axis.options.color?('color:'+axis.options.color+'; '):' ','" class="flotr-grid-label'+name+'">'+tick.label+'</div>'].join(' ');if(!isX&&!isFirst){ctx.moveTo(offset.left+graph.plotWidth-8,offset.top+axis.d2p(tick.v));ctx.lineTo(offset.left+graph.plotWidth,offset.top+axis.d2p(tick.v));}}}}}});})();;(function(){var
D=Flotr.DOM,_=Flotr._;Flotr.addPlugin('legend',{options:{show:true,noColumns:1,labelFormatter:function(v){return v;},labelBoxBorderColor:'#CCCCCC',labelBoxWidth:14,labelBoxHeight:10,labelBoxMargin:5,labelBoxOpacity:0.4,container:null,position:'nw',margin:5,backgroundColor:null,backgroundOpacity:0.85},callbacks:{'flotr:afterinit':function(){this.legend.insertLegend();}},insertLegend:function(){if(!this.options.legend.show)
return;var series=this.series,plotOffset=this.plotOffset,options=this.options,legend=options.legend,fragments=[],rowStarted=false,ctx=this.ctx,itemCount=_.filter(series,function(s){return(s.label&&!s.hide);}).length,p=legend.position,m=legend.margin,i,label,color;if(itemCount){if(!options.HtmlText&&this.textEnabled&&!legend.container){var style={size:options.fontSize*1.1,color:options.grid.color};var lbw=legend.labelBoxWidth,lbh=legend.labelBoxHeight,lbm=legend.labelBoxMargin,offsetX=plotOffset.left+m,offsetY=plotOffset.top+m;var labelMaxWidth=0;for(i=series.length-1;i>-1;--i){if(!series[i].label||series[i].hide)continue;label=legend.labelFormatter(series[i].label);labelMaxWidth=Math.max(labelMaxWidth,this._text.measureText(label,style).width);}
var legendWidth=Math.round(lbw+lbm*3+labelMaxWidth),legendHeight=Math.round(itemCount*(lbm+lbh)+lbm);if(p.charAt(0)=='s')offsetY=plotOffset.top+this.plotHeight-(m+legendHeight);if(p.charAt(1)=='e')offsetX=plotOffset.left+this.plotWidth-(m+legendWidth);color=this.processColor(legend.backgroundColor||'rgb(240,240,240)',{opacity:legend.backgroundOpacity||0.1});ctx.fillStyle=color;ctx.fillRect(offsetX,offsetY,legendWidth,legendHeight);ctx.strokeStyle=legend.labelBoxBorderColor;ctx.strokeRect(Flotr.toPixel(offsetX),Flotr.toPixel(offsetY),legendWidth,legendHeight);var x=offsetX+lbm;var y=offsetY+lbm;for(i=0;i<series.length;i++){if(!series[i].label||series[i].hide)continue;label=legend.labelFormatter(series[i].label);ctx.fillStyle=series[i].color;ctx.fillRect(x,y,lbw-1,lbh-1);ctx.strokeStyle=legend.labelBoxBorderColor;ctx.lineWidth=1;ctx.strokeRect(Math.ceil(x)-1.5,Math.ceil(y)-1.5,lbw+2,lbh+2);Flotr.drawText(ctx,label,x+lbw+lbm,y+lbh,style);y+=lbh+lbm;}}
else{for(i=0;i<series.length;++i){if(!series[i].label||series[i].hide)continue;if(i%legend.noColumns===0){fragments.push(rowStarted?'</tr><tr>':'<tr>');rowStarted=true;}
var s=series[i],boxWidth=legend.labelBoxWidth,boxHeight=legend.labelBoxHeight,opacityValue=(s.bars?s.bars.fillOpacity:legend.labelBoxOpacity),opacity='opacity:'+opacityValue+';filter:alpha(opacity='+opacityValue*100+');';label=legend.labelFormatter(s.label);color='background-color:'+((s.bars&&s.bars.show&&s.bars.fillColor&&s.bars.fill)?s.bars.fillColor:s.color)+';';fragments.push('<td class="flotr-legend-color-box">','<div style="border:1px solid ',legend.labelBoxBorderColor,';padding:1px">','<div style="width:',(boxWidth-1),'px;height:',(boxHeight-1),'px;border:1px solid ',series[i].color,'">','<div style="width:',boxWidth,'px;height:',boxHeight,'px;','opacity:.4;',color,'"></div>','</div>','</div>','</td>','<td class="flotr-legend-label">',label,'</td>');}
if(rowStarted)fragments.push('</tr>');if(fragments.length>0){var table='<table style="font-size:smaller;color:'+options.grid.color+'">'+fragments.join('')+'</table>';if(legend.container){D.insert(legend.container,table);}
else{var styles={position:'absolute','z-index':2};if(p.charAt(0)=='n'){styles.top=(m+plotOffset.top)+'px';styles.bottom='auto';}
else if(p.charAt(0)=='s'){styles.bottom=(m+plotOffset.bottom)+'px';styles.top='auto';}
if(p.charAt(1)=='e'){styles.right=(m+plotOffset.right)+'px';styles.left='auto';}
else if(p.charAt(1)=='w'){styles.left=(m+plotOffset.left)+'px';styles.right='auto';}
var div=D.create('div'),size;div.className='flotr-legend';D.setStyles(div,styles);D.insert(div,table);D.insert(this.el,div);if(!legend.backgroundOpacity)
return;var c=legend.backgroundColor||options.grid.backgroundColor||'#ffffff';_.extend(styles,D.size(div),{'backgroundColor':c,'z-index':1});styles.width+='px';styles.height+='px';div=D.create('div');div.className='flotr-legend-bg';D.setStyles(div,styles);D.opacity(div,legend.backgroundOpacity);D.insert(div,' ');D.insert(this.el,div);}}}}}});})();;(function(){function getRowLabel(value){if(this.options.spreadsheet.tickFormatter){return this.options.spreadsheet.tickFormatter(value);}
else{var t=_.find(this.axes.x.ticks,function(t){return t.v==value;});if(t){return t.label;}
return value;}}
var
D=Flotr.DOM,_=Flotr._;Flotr.addPlugin('spreadsheet',{options:{show:false,tabGraphLabel:'Graph',tabDataLabel:'Data',toolbarDownload:'Download CSV',toolbarSelectAll:'Select all',csvFileSeparator:',',decimalSeparator:'.',tickFormatter:null,initialTab:'graph'},callbacks:{'flotr:afterconstruct':function(){if(!this.options.spreadsheet.show)return;var ss=this.spreadsheet,container=D.node('<div class="flotr-tabs-group" style="position:absolute;left:0px;width:'+this.canvasWidth+'px"></div>'),graph=D.node('<div style="float:left" class="flotr-tab selected">'+this.options.spreadsheet.tabGraphLabel+'</div>'),data=D.node('<div style="float:left" class="flotr-tab">'+this.options.spreadsheet.tabDataLabel+'</div>'),offset;ss.tabsContainer=container;ss.tabs={graph:graph,data:data};D.insert(container,graph);D.insert(container,data);D.insert(this.el,container);offset=D.size(data).height+2;this.plotOffset.bottom+=offset;D.setStyles(container,{top:this.canvasHeight-offset+'px'});this.observe(graph,'click',function(){ss.showTab('graph');}).observe(data,'click',function(){ss.showTab('data');});if(this.options.spreadsheet.initialTab!=='graph'){ss.showTab(this.options.spreadsheet.initialTab);}}},loadDataGrid:function(){if(this.seriesData)return this.seriesData;var s=this.series,rows={};_.each(s,function(serie,i){_.each(serie.data,function(v){var x=v[0],y=v[1],r=rows[x];if(r){r[i+1]=y;}else{var newRow=[];newRow[0]=x;newRow[i+1]=y;rows[x]=newRow;}});});this.seriesData=_.sortBy(rows,function(row,x){return parseInt(x,10);});return this.seriesData;},constructDataGrid:function(){if(this.spreadsheet.datagrid)return this.spreadsheet.datagrid;var s=this.series,datagrid=this.spreadsheet.loadDataGrid(),colgroup=['<colgroup><col />'],buttonDownload,buttonSelect,t;var html=['<table class="flotr-datagrid"><tr class="first-row">'];html.push('<th>&nbsp;</th>');_.each(s,function(serie,i){html.push('<th scope="col">'+(serie.label||String.fromCharCode(65+i))+'</th>');colgroup.push('<col />');});html.push('</tr>');_.each(datagrid,function(row){html.push('<tr>');_.times(s.length+1,function(i){var tag='td',value=row[i],content=(!_.isUndefined(value)?Math.round(value*100000)/100000:'');if(i===0){tag='th';var label=getRowLabel.call(this,content);if(label)content=label;}
html.push('<'+tag+(tag=='th'?' scope="row"':'')+'>'+content+'</'+tag+'>');},this);html.push('</tr>');},this);colgroup.push('</colgroup>');t=D.node(html.join(''));buttonDownload=D.node('<button type="button" class="flotr-datagrid-toolbar-button">'+
this.options.spreadsheet.toolbarDownload+'</button>');buttonSelect=D.node('<button type="button" class="flotr-datagrid-toolbar-button">'+
this.options.spreadsheet.toolbarSelectAll+'</button>');this.observe(buttonDownload,'click',_.bind(this.spreadsheet.downloadCSV,this)).observe(buttonSelect,'click',_.bind(this.spreadsheet.selectAllData,this));var toolbar=D.node('<div class="flotr-datagrid-toolbar"></div>');D.insert(toolbar,buttonDownload);D.insert(toolbar,buttonSelect);var containerHeight=this.canvasHeight-D.size(this.spreadsheet.tabsContainer).height-2,container=D.node('<div class="flotr-datagrid-container" style="position:absolute;left:0px;top:0px;width:'+
this.canvasWidth+'px;height:'+containerHeight+'px;overflow:auto;z-index:10"></div>');D.insert(container,toolbar);D.insert(container,t);D.insert(this.el,container);this.spreadsheet.datagrid=t;this.spreadsheet.container=container;return t;},showTab:function(tabName){if(this.spreadsheet.activeTab===tabName){return;}
switch(tabName){case'graph':D.hide(this.spreadsheet.container);D.removeClass(this.spreadsheet.tabs.data,'selected');D.addClass(this.spreadsheet.tabs.graph,'selected');break;case'data':if(!this.spreadsheet.datagrid)
this.spreadsheet.constructDataGrid();D.show(this.spreadsheet.container);D.addClass(this.spreadsheet.tabs.data,'selected');D.removeClass(this.spreadsheet.tabs.graph,'selected');break;default:throw'Illegal tab name: '+tabName;}
this.spreadsheet.activeTab=tabName;},selectAllData:function(){if(this.spreadsheet.tabs){var selection,range,doc,win,node=this.spreadsheet.constructDataGrid();this.spreadsheet.showTab('data');setTimeout(function(){if((doc=node.ownerDocument)&&(win=doc.defaultView)&&win.getSelection&&doc.createRange&&(selection=window.getSelection())&&selection.removeAllRanges){range=doc.createRange();range.selectNode(node);selection.removeAllRanges();selection.addRange(range);}
else if(document.body&&document.body.createTextRange&&(range=document.body.createTextRange())){range.moveToElementText(node);range.select();}},0);return true;}
else return false;},downloadCSV:function(){var csv='',series=this.series,options=this.options,dg=this.spreadsheet.loadDataGrid(),separator=encodeURIComponent(options.spreadsheet.csvFileSeparator);if(options.spreadsheet.decimalSeparator===options.spreadsheet.csvFileSeparator){throw"The decimal separator is the same as the column separator ("+options.spreadsheet.decimalSeparator+")";}
_.each(series,function(serie,i){csv+=separator+'"'+(serie.label||String.fromCharCode(65+i)).replace(/\"/g,'\\"')+'"';});csv+="%0D%0A";csv+=_.reduce(dg,function(memo,row){var rowLabel=getRowLabel.call(this,row[0])||'';rowLabel='"'+(rowLabel+'').replace(/\"/g,'\\"')+'"';var numbers=row.slice(1).join(separator);if(options.spreadsheet.decimalSeparator!=='.'){numbers=numbers.replace(/\./g,options.spreadsheet.decimalSeparator);}
return memo+rowLabel+separator+numbers+"%0D%0A";},'',this);if(Flotr.isIE&&Flotr.isIE<9){csv=csv.replace(new RegExp(separator,'g'),decodeURIComponent(separator)).replace(/%0A/g,'\n').replace(/%0D/g,'\r');window.open().document.write(csv);}
else window.open('data:text/csv,'+csv);}});})();;(function(){var D=Flotr.DOM;Flotr.addPlugin('titles',{callbacks:{'flotr:afterdraw':function(){this.titles.drawTitles();}},drawTitles:function(){var html,options=this.options,margin=options.grid.labelMargin,ctx=this.ctx,a=this.axes;if(!options.HtmlText&&this.textEnabled){var style={size:options.fontSize,color:options.grid.color,textAlign:'center'};if(options.subtitle){Flotr.drawText(ctx,options.subtitle,this.plotOffset.left+this.plotWidth/2,this.titleHeight+this.subtitleHeight-2,style);}
style.weight=1.5;style.size*=1.5;if(options.title){Flotr.drawText(ctx,options.title,this.plotOffset.left+this.plotWidth/2,this.titleHeight-2,style);}
style.weight=1.8;style.size*=0.8;if(a.x.options.title&&a.x.used){style.textAlign=a.x.options.titleAlign||'center';style.textBaseline='top';style.angle=Flotr.toRad(a.x.options.titleAngle);style=Flotr.getBestTextAlign(style.angle,style);Flotr.drawText(ctx,a.x.options.title,this.plotOffset.left+this.plotWidth/2,this.plotOffset.top+a.x.maxLabel.height+this.plotHeight+2*margin,style);}
if(a.x2.options.title&&a.x2.used){style.textAlign=a.x2.options.titleAlign||'center';style.textBaseline='bottom';style.angle=Flotr.toRad(a.x2.options.titleAngle);style=Flotr.getBestTextAlign(style.angle,style);Flotr.drawText(ctx,a.x2.options.title,this.plotOffset.left+this.plotWidth/2,this.plotOffset.top-a.x2.maxLabel.height-2*margin,style);}
if(a.y.options.title&&a.y.used){style.textAlign=a.y.options.titleAlign||'right';style.textBaseline='middle';style.angle=Flotr.toRad(a.y.options.titleAngle);style=Flotr.getBestTextAlign(style.angle,style);Flotr.drawText(ctx,a.y.options.title,this.plotOffset.left-a.y.maxLabel.width-2*margin,this.plotOffset.top+this.plotHeight/2,style);}
if(a.y2.options.title&&a.y2.used){style.textAlign=a.y2.options.titleAlign||'left';style.textBaseline='middle';style.angle=Flotr.toRad(a.y2.options.titleAngle);style=Flotr.getBestTextAlign(style.angle,style);Flotr.drawText(ctx,a.y2.options.title,this.plotOffset.left+this.plotWidth+a.y2.maxLabel.width+2*margin,this.plotOffset.top+this.plotHeight/2,style);}}
else{html=[];if(options.title)
html.push('<div style="position:absolute;top:0;left:',this.plotOffset.left,'px;font-size:1em;font-weight:bold;text-align:center;width:',this.plotWidth,'px;" class="flotr-title">',options.title,'</div>');if(options.subtitle)
html.push('<div style="position:absolute;top:',this.titleHeight,'px;left:',this.plotOffset.left,'px;font-size:smaller;text-align:center;width:',this.plotWidth,'px;" class="flotr-subtitle">',options.subtitle,'</div>');html.push('</div>');html.push('<div class="flotr-axis-title" style="font-weight:bold;">');if(a.x.options.title&&a.x.used)
html.push('<div style="position:absolute;top:',(this.plotOffset.top+this.plotHeight+options.grid.labelMargin+a.x.titleSize.height),'px;left:',this.plotOffset.left,'px;width:',this.plotWidth,'px;text-align:center;" class="flotr-axis-title">',a.x.options.title,'</div>');if(a.x2.options.title&&a.x2.used)
html.push('<div style="position:absolute;top:0;left:',this.plotOffset.left,'px;width:',this.plotWidth,'px;text-align:center;" class="flotr-axis-title">',a.x2.options.title,'</div>');if(a.y.options.title&&a.y.used)
html.push('<div style="position:absolute;top:',(this.plotOffset.top+this.plotHeight/2-a.y.titleSize.height/2),'px;left:0;text-align:right;" class="flotr-axis-title">',a.y.options.title,'</div>');if(a.y2.options.title&&a.y2.used)
html.push('<div style="position:absolute;top:',(this.plotOffset.top+this.plotHeight/2-a.y.titleSize.height/2),'px;right:0;text-align:right;" class="flotr-axis-title">',a.y2.options.title,'</div>');html=html.join('');var div=D.create('div');D.setStyles({color:options.grid.color});div.className='flotr-titles';D.insert(this.el,div);D.insert(div,html);}}});})();;openerp.web_graph=function(instance){var _lt=instance.web._lt;var filter_values=function(o){var out={};for(var k in o){if(!o.hasOwnProperty(k)||o[k]===undefined){continue;}
out[k]=o[k];}
return out;};instance.web.views.add('graph','instance.web_graph.GraphView');instance.web_graph.GraphView=instance.web.View.extend({template:"GraphView",display_name:_lt('Graph'),view_type:"graph",init:function(parent,dataset,view_id,options){var self=this;this._super(parent);this.set_default_options(options);this.dataset=dataset;this.view_id=view_id;this.mode="bar";this.orientation=false;this.stacked=true;this.spreadsheet=false;this.forcehtml=false;this.legend="top";this.domain=[];this.context={};this.group_by=[];this.graph=null;},view_loading:function(r){return this.load_graph(r);},destroy:function(){if(this.graph){this.graph.destroy();}
this._super();},load_graph:function(fields_view_get){var self=this;this.fields_view=fields_view_get;this.$el.addClass(this.fields_view.arch.attrs['class']);this.mode=this.fields_view.arch.attrs.type||'bar';this.orientation=this.fields_view.arch.attrs.orientation=='horizontal';var width=this.$el.parent().width();this.$el.css("width",width);this.container=this.$el.find("#editor-render-body").css({width:width,height:Math.min(500,width*0.8)})[0];var graph_render=this.proxy('graph_render');this.$el.on('click','.oe_graph_options a',function(evt){var $el=$(evt.target);self.graph_render({data:filter_values({mode:$el.data('mode'),legend:$el.data('legend'),orientation:$el.data('orientation'),stacked:$el.data('stacked')})});});this.$el.find("#graph_show_data").click(function(){self.spreadsheet=!self.spreadsheet;self.graph_render();});this.$el.find("#graph_switch").click(function(){if(self.mode!='radar'){self.orientation=!self.orientation;}
self.graph_render();});this.$el.find("#graph_download").click(function(){if(self.legend=="top"){self.legend="inside";}
self.forcehtml=true;self.graph_get_data().done(function(result){self.graph_render_all(result).download.saveImage('png');}).always(function(){self.forcehtml=false;});});this.trigger('graph_view_loaded',fields_view_get);},get_format:function(options){options=options||{};var legend={show:this.legend!='no',};switch(this.legend){case'top':legend.noColumns=4;legend.container=this.$el.find("div.graph_header_legend")[0];break;case'inside':legend.position='nw';legend.backgroundColor='#D2E8FF';break;}
return _.extend({legend:legend,mouse:{track:true,relative:true},spreadsheet:{show:this.spreadsheet,initialTab:"data"},HtmlText:(options.xaxis&&options.xaxis.labelsAngle)?false:!this.forcehtml,},options);},make_graph:function(mode,container,data){if(mode==='area'){mode='line';}
var format=this.get_format(this['options_'+mode](data));return Flotr.draw(container,data.data,format);},options_bar:function(data){var min=_(data.data).chain().map(function(record){if(record.data.length>0){return _.min(record.data,function(item){return item[1];})[1];}}).min().value();return{bars:{show:true,stacked:this.stacked,horizontal:this.orientation,barWidth:0.7,lineWidth:1},grid:{verticalLines:this.orientation,horizontalLines:!this.orientation,outline:"sw",},yaxis:{ticks:this.orientation?data.ticks:false,min:!this.orientation?(min<0?min:0):null},xaxis:{labelsAngle:45,ticks:this.orientation?false:data.ticks,min:this.orientation?(min<0?min:0):null}};},options_pie:function(data){return{pie:{show:true},grid:{verticalLines:false,horizontalLines:false,outline:"",},xaxis:{showLabels:false},yaxis:{showLabels:false},};},options_radar:function(data){return{radar:{show:true,stacked:this.stacked},grid:{circular:true,minorHorizontalLines:true},xaxis:{ticks:data.ticks},};},options_line:function(data){return{lines:{show:true,},points:{show:true,},grid:{verticalLines:this.orientation,horizontalLines:!this.orientation,outline:"sw",},yaxis:{ticks:this.orientation?data.ticks:false},xaxis:{labelsAngle:45,ticks:this.orientation?false:data.ticks}};},graph_get_data:function(){var model=this.dataset.model,domain=new instance.web.CompoundDomain(this.domain||[]),context=new instance.web.CompoundContext(this.context||{}),group_by=this.group_by||[],view_id=this.view_id||false,mode=this.mode||'bar',orientation=this.orientation||false,stacked=this.stacked||false;var obj=new instance.web.Model(model);var view_get;var fields;var result=[];var ticks={};return obj.call("fields_view_get",[view_id,'graph']).then(function(tmp){view_get=tmp;fields=view_get['fields'];var toload=_.select(group_by,function(x){return fields[x]===undefined});if(toload.length>=1)
return obj.call("fields_get",[toload,context]);else
return $.when([]);}).then(function(fields_to_add){_.extend(fields,fields_to_add);var tree=$($.parseXML(view_get['arch']));var pos=0;var xaxis=_.clone(group_by||[]);var yaxis=[];tree.find("field").each(function(){var field=$(this);if(!field.attr("name"))
return;if((group_by.length==0)&&((!pos)||instance.web.py_eval(field.attr('group')||"false"))){xaxis.push(field.attr('name'));}
if(pos&&!instance.web.py_eval(field.attr('group')||"false")){yaxis.push(field.attr('name'));}
pos+=1;});if(xaxis.length===0)
throw new Error("No field for the X axis!");if(yaxis.length===0)
throw new Error("No field for the Y axis!");function _convert_key(field,data){if(fields[field]['type']==='many2one')
data=data&&data[0];return data;}
function _convert(field,data,tick){tick=tick===undefined?true:false;try{data=instance.web.format_value(data,fields[field]);}catch(e){data=""+data;}
if(tick){if(ticks[data]===undefined)
ticks[data]=_.size(ticks);return ticks[data];}
return data||0;}
function _orientation(x,y){if(!orientation)
return[x,y]
return[y,x]}
if(mode==="pie"){return obj.call("read_group",[domain,yaxis.concat([xaxis[0]]),[xaxis[0]]],{context:context}).then(function(res){_.each(res,function(record){result.push({'data':[[_convert(xaxis[0],record[xaxis[0]]),record[yaxis[0]]]],'label':_convert(xaxis[0],record[xaxis[0]],false)});});});}else if((!stacked)||(xaxis.length<2)){var defs=[];_.each(xaxis,function(x){defs.push(obj.call("read_group",[domain,yaxis.concat([x]),[x]],{context:context}).then(function(res){return[x,res];}));});return $.when.apply($,defs).then(function(){_.each(_.toArray(arguments),function(res){var x=res[0];res=res[1];result.push({'data':_.map(res,function(record){return _orientation(_convert(x,record[x]),record[yaxis[0]]||0);}),'label':fields[x]['string']});});});}else{xaxis.reverse();return obj.call("read_group",[domain,yaxis.concat(xaxis.slice(0,1)),xaxis.slice(0,1)],{context:context}).then(function(axis){var defs=[];_.each(axis,function(x){var key=x[xaxis[0]]
defs.push(obj.call("read_group",[domain,yaxis.concat(xaxis.slice(1,2)),xaxis.slice(1,2)],{context:context}).then(function(res){return[x,key,res];}));});return $.when.apply($,defs).then(function(){_.each(_.toArray(arguments),function(res){var x=res[0];var key=res[1];res=res[2];result.push({'data':_.map(res,function(record){return _orientation(_convert(xaxis[1],record[xaxis[1]]),record[yaxis[0]]||0);}),'label':_convert(xaxis[0],key,false)})});});});}}).then(function(){var res={'data':result,'ticks':_.map(ticks,function(el,key){return[el,key]})};return res;});},graph_render:function(options){options=options||{};_.extend(this,options.data);return this.graph_get_data().done(this.proxy('graph_render_all'));},graph_render_all:function(data){var i;if(this.mode=='area'){for(i=0;i<data.data.length;i++){data.data[i].lines={fill:true}}}
if(this.graph){this.graph.destroy();}
this.$el.find(".graph_header_legend").children().remove();this.graph=this.make_graph(this.mode,this.container,data);this.$el.find("a").removeClass("active");var $active=this.$el.find('a[data-mode='+this.mode+']');if($active.length>1){$active=$active.filter('[data-stacked='+this.stacked+']');}
$active=$active.add(this.$el.find('a:not([data-mode])[data-legend='+this.legend+']'));$active.addClass('active');if(this.spreadsheet){this.$el.find("#graph_show_data").addClass("active");}
return this.graph;},do_search:function(domain,context,group_by){this.domain=domain;this.context=context;this.group_by=group_by;this.graph_render();},do_show:function(){this.do_push_state({});return this._super();},});};;openerp.web_view_editor=function(instance){var _t=instance.web._t;var QWeb=instance.web.qweb;instance.web.ViewManagerAction.include({on_debug_changed:function(evt){var val=$(evt.currentTarget).find('option:selected').val(),current_view=this.views[this.active_view].controller;if(val==="manage_views"){if(current_view.fields_view&&current_view.fields_view.arch){var view_editor=new instance.web_view_editor.ViewEditor(current_view,current_view.$el,this.dataset,current_view.fields_view.arch);view_editor.start();}else{this.do_warn(_t("Manage Views"),_t("Could not find current view declaration"));}
evt.currentTarget.selectedIndex=0;}else{return this._super.apply(this,arguments);}}});instance.web_view_editor.ViewEditor=instance.web.Widget.extend({init:function(parent,element_id,dataset,view,options){this._super(parent);this.parent=parent;this.dataset=new instance.web.DataSetSearch(this,'ir.ui.view',null,null),this.model=dataset.model;this.xml_element_id=0;this.property=instance.web_view_editor.ViewEditor.property_widget;this.one_object=false;},start:function(){this.init_view_editor();},init_view_editor:function(){var self=this,action_title=_.str.sprintf(_t("Manage Views (%s)"),this.model);var action={name:action_title,context:this.session.user_context,domain:[["model","=",this.model]],res_model:'ir.ui.view',views:[[false,'list']],type:'ir.actions.act_window',target:"current",limit:this.dataset.limit||80,auto_search:true,flags:{sidebar:false,deletable:false,views_switcher:false,action_buttons:false,search_view:false,pager:false,radio:true,select_view_id:self.parent.fields_view.view_id}};this.view_edit_dialog=new instance.web.Dialog(this,{title:action_title,width:850,buttons:[{text:_t("Create"),click:function(){self.on_create_view();}},{text:_t("Edit"),click:function(){self.xml_element_id=0;self.get_arch();}},{text:_t("Remove"),click:function(){self.do_delete_view();}},{text:_t("Close"),click:function(){self.view_edit_dialog.close();window.location.reload();}}]}).open();this.view_edit_dialog.on("closing",this,function(){window.location.reload();});this.main_view_id=this.parent.fields_view.view_id;this.action_manager=new instance.web.ActionManager(this);this.action_manager.appendTo(this.view_edit_dialog.$el);$.when(this.action_manager.do_action(action)).done(function(){var viewmanager=self.action_manager.inner_widget;var controller=viewmanager.views[viewmanager.active_view].controller;controller.on('view_loaded',self,function(){$(controller.groups).bind({'selected':function(e,ids,records){self.main_view_id=ids[0];}});});});},on_create_view:function(){var self=this;this.create_view_dialog=new instance.web.Dialog(this,{title:_.str.sprintf(_t("Create a view (%s)"),self.model),buttons:[{text:_t("Save"),click:function(){var view_values={};var warn=false;_.each(self.create_view_widget,function(widget){if(widget.is_invalid){warn=true;return false;}
if(widget.dirty&&!widget.is_invalid){view_values[widget.name]=widget.get_value();}});if(warn){self.on_valid_create_view(self.create_view_widget);}else{$.when(self.do_save_view(view_values)).done(function(){self.create_view_dialog.close();var controller=self.action_manager.inner_widget.views[self.action_manager.inner_widget.active_view].controller;controller.reload_content();});}}},{text:_t("Cancel"),click:function(){self.create_view_dialog.close();}}]}).open();var view_widget=[{'name':'view_name','string':'View Name','type':'char','required':true,'value':this.model+'.custom_'+Math.round(Math.random()*1000)},{'name':'view_type','string':'View Type','type':'selection','required':true,'value':'Form','selection':[['',''],['tree','Tree'],['form','Form'],['graph','Graph'],['calendar','Calender']]},{'name':'proirity','string':'Priority','type':'float','required':true,'value':'16'}];this.create_view_dialog.$el.append('<table id="create_view"  style="width:400px" class="oe_form"></table>');this.create_view_widget=[];_.each(view_widget,function(widget){var type_widget=new(self.property.get_any([widget.type]))(self.create_view_dialog,widget);self.create_view_dialog.$el.find('table[id=create_view]').append('<tr><td width="100px" align="right">'+widget.string+':</td>'+type_widget.render()+'</tr>');var value=null;if(widget.value){value=widget.value;type_widget.dirty=true;}
type_widget.start();type_widget.set_value(value);self.create_view_widget.push(type_widget);});},do_save_view:function(values){def=$.Deferred();var field_dataset=new instance.web.DataSetSearch(this,this.model,null,null);var model_dataset=new instance.web.DataSetSearch(this,'ir.model',null,null);var view_string="",field_name=false,self=this;field_dataset.call('fields_get',[]).done(function(fields){_.each(['name','x_name'],function(value){if(_.include(_.keys(fields),value)){field_name=value;return false;}});if(field_name){model_dataset.read_slice(['name','field_id'],{"domain":[['model','=',self.model]]}).done(function(records){if(records){view_string=records[0].name;}
var arch=_.str.sprintf("<?xml version='1.0'?>\n<%s string='%s'>\n\t<field name='%s'/>\n</%s>",values.view_type,view_string,field_name,values.view_type);var vals={'model':self.model,'name':values.view_name,'priority':values.priority,'type':values.view_type,'arch':arch};def=self.dataset.create(vals);});}});return def.promise();},on_valid_create_view:function(widgets){var msg="<ul>";_.each(widgets,function(widget){if(widget.is_invalid){msg+="<li>"+widget.name+"</li>";}});msg+="</ul>";this.do_warn(_t("The following fields are invalid :"),msg);},add_node_name:function(node){if(node.tagName.toLowerCase()=="button"||node.tagName.toLowerCase()=="field"){return(node.getAttribute('name'))?_.str.sprintf("<%s name='%s'>",node.tagName.toLowerCase(),node.getAttribute('name')):_.str.sprintf("<%s>",node.tagName.toLowerCase());}else if(node.tagName.toLowerCase()=="group"){return(node.getAttribute('string'))?_.str.sprintf("<%s>",node.getAttribute('string')):_.str.sprintf("<%s>",node.tagName.toLowerCase());}else{return(node.getAttribute('string'))?_.str.sprintf("<%s string='%s'>",node.tagName.toLowerCase(),node.getAttribute('string')):_.str.sprintf("<%s>",node.tagName.toLowerCase());}},do_delete_view:function(){var self=this;if(confirm(_t("Do you really want to remove this view?"))){var controller=this.action_manager.inner_widget.views[this.action_manager.inner_widget.active_view].controller;this.dataset.unlink([this.main_view_id]).done(function(){controller.reload_content();self.main_view_id=self.parent.fields_view.view_id;});}},create_View_Node:function(node){ViewNode={'level':($(node).parents()).length+1,'id':this.xml_element_id+=1,'att_list':[],'name':this.add_node_name(node),'child_id':[]};ViewNode.att_list.push(node.tagName.toLowerCase());_.each(node.attributes,function(att){ViewNode.att_list.push([att.nodeName,att.nodeValue]);});return ViewNode;},append_child_object:function(main_object,parent_id,child_obj_list){var self=this;if(main_object.id==parent_id){main_object.child_id=child_obj_list;return main_object;}else{_.each(main_object.child_id,function(child_object){self.append_child_object(child_object,parent_id,child_obj_list);});}},convert_arch_to_obj:function(xml_Node,main_object,parent_id){var self=this;var child_obj_list=[];_.each(xml_Node,function(element){child_obj_list.push(self.create_View_Node(element));});this.append_child_object(main_object,parent_id,child_obj_list);var obj_xml_list=_.zip(xml_Node,child_obj_list);_.each(obj_xml_list,function(node){var children=_.filter(node[0].childNodes,function(child){return child.nodeType==1;});if(children){self.convert_arch_to_obj(children,main_object,node[1].id);}});return main_object;},parse_xml:function(arch,view_id){main_object={'level':0,'id':this.xml_element_id+=1,'att_list':[],'name':_.str.sprintf("<view view_id = %s>",view_id),'child_id':[]};var xml_arch=QWeb.load_xml(arch);return[this.convert_arch_to_obj(xml_arch.childNodes,main_object,this.xml_element_id)];},get_arch:function(){var self=this;var view_arch_list=[];this.dataset.read_ids([parseInt(self.main_view_id)],['arch','type','priority']).done(function(arch){if(arch.length){var arch_object=self.parse_xml(arch[0].arch,self.main_view_id);self.main_view_type=arch[0].type=='tree'?'list':arch[0].type;view_arch_list.push({"view_id":self.main_view_id,"arch":arch[0].arch,"priority":arch[0].priority});self.dataset.read_slice([],{domain:[['inherit_id','=',parseInt(self.main_view_id)]]}).done(function(result){_.each(result,function(res){view_arch_list.push({"view_id":res.id,"arch":res.arch,"priority":res.priority});self.inherit_view(arch_object,res);});return self.edit_view({"main_object":arch_object,"parent_child_id":self.parent_child_list(arch_object,[]),"arch":view_arch_list});});}else{self.do_warn(_t("Please select view in list :"));}});},parent_child_list:function(one_object,parent_list){var self=this;_.each(one_object,function(element){if(element.child_id.length!=0){parent_list.push({"key":element.id,"value":_.pluck(element.child_id,'id')});self.parent_child_list(element.child_id,parent_list);}});return parent_list;},inherit_view:function(arch_object,result){var self=this,xml_list=[],xml_arch=QWeb.load_xml(result.arch);if(xml_arch.childNodes[0].tagName=="data"){xml_list=_.filter(xml_arch.childNodes[0].childNodes,function(child){return child.nodeType==1;});}else{xml_list.push(xml_arch.childNodes[0]);}
_.each(xml_list,function(xml){var expr_to_list=[],xpath_arch_object=self.parse_xml(QWeb.tools.xml_node_to_string(xml),result.id);if(xml.tagName=="xpath"){var part_expr=_.without(xml.getAttribute('expr').split("/"),"");_.each(part_expr,function(part){expr_to_list.push(_.without($.trim(part.replace(/[^a-zA-Z 0-9 _]+/g,'!')).split("!"),""));});}else{var temp=_.reject(xpath_arch_object[0].child_id[0].att_list,function(list){return list instanceof Array?_.include(list,"position"):false;});expr_to_list=[_.flatten(temp)];}
self.inherit_apply(expr_to_list,arch_object,xpath_arch_object);});},inherit_apply:function(expr_list,arch_object,xpath_arch_object){var self=this;if(xpath_arch_object.length){var check=expr_list[0],obj=false;switch(check.length){case 2:if(parseInt(check[1])){var temp_list=_.select(arch_object,function(element){return _.include(_.flatten(element.att_list),check[0]);});obj=arch_object[_.indexOf(arch_object,temp_list[parseInt(check[1])-1])];}else{obj=_.detect(arch_object,function(element){return _.include(_.flatten(element.att_list),check[0]);});}
break;case 3:obj=_.detect(arch_object,function(element){if((_.intersection(_.flatten(element.att_list),_.uniq(check))).length==_.uniq(check).length){return element;}});break;case 1:var temp_list=_.select(arch_object,function(element){return _.include(_.flatten(element.att_list),check[0]);});if(temp_list.length!=0){expr_list.length==1?obj=temp_list[0]:expr_list.shift();}
break;}
if(obj){expr_list.shift();if(expr_list.length){self.inherit_apply(expr_list,obj.child_id,xpath_arch_object);}else{self.increase_level(xpath_arch_object[0],obj.level+1);obj.child_id.push(xpath_arch_object[0]);xpath_arch_object.pop();}}else{_.each(arch_object,function(element){self.inherit_apply(expr_list,element.child_id,xpath_arch_object);});}}},increase_level:function(val,level){var self=this;val.level=level;_.each(val.child_id,function(val,key){self.increase_level(val,level+1);});},do_select_row:function(row_id){this.edit_xml_dialog.$el.find("tr[id^='viewedit-']").removeClass('ui-selected');this.edit_xml_dialog.$el.find("tr[id=viewedit-"+row_id+"]").addClass('ui-selected');},do_parent_img_hide_show:function(img){if(_.str.include($(img).attr('src'),'/web/static/src/img/collapse.gif')){$(img).attr('src','/web/static/src/img/expand.gif');this.on_expand(img);}else{$(img).attr('src','/web/static/src/img/collapse.gif');this.on_collapse(img);}},edit_view:function(one_object){var self=this;this.one_object=one_object;this.edit_xml_dialog=new instance.web.Dialog(this,{title:_.str.sprintf(_t("View Editor %d - %s"),self.main_view_id,self.model),height:'90%',buttons:[{text:_t("Inherited View"),click:function(){var selected_row=self.edit_xml_dialog.$el.find('.ui-selected');if(selected_row.length){if(selected_row.find('a').text().search("field")!=-1){if(confirm(_t("Do you really wants to create an inherited view here?"))){self.inherited_view(selected_row);}}else{alert(_t("Can't Update View"));}}else{alert(_t("Select an element"));}}},{text:_t("Preview"),click:function(){var action={context:self.session.user_context,res_model:self.model,views:[[self.main_view_id,self.main_view_type]],type:'ir.actions.act_window',target:"new",auto_search:true,flags:{sidebar:false,views_switcher:false,action_buttons:false}};var action_manager=new instance.web.ActionManager(self);action_manager.do_action(action);}},{text:_t("Close"),click:function(){self.action_manager.inner_widget.views[self.action_manager.inner_widget.active_view].controller.reload_content();self.edit_xml_dialog.close();}}]}).open();var no_property_att=[];_.each(_PROPERTIES,function(val,key){if(!val.length)no_property_att.push(key);});this.edit_xml_dialog.$el.html(QWeb.render('view_editor',{'data':one_object['main_object'],'no_properties':no_property_att}));this.edit_xml_dialog.$el.find("tr[id^='viewedit-']").click(function(){self.do_select_row(this.id.split('-')[1]);});this.edit_xml_dialog.$el.find("img[id^='parentimg-']").click(function(){self.do_parent_img_hide_show(this);});this.edit_xml_dialog.$el.find("img[id^='side-']").click(function(){self.on_select_img(this);});},inherited_view:function(selected_row){var self=this;var row_id=parseInt((selected_row.attr('id')).split('-')[1]);var obj=self.get_object_by_id(row_id,self.one_object['main_object'],[])[0];var view_name=this.model+'.inherit_'+Math.round(Math.random()*1000);var view_find=selected_row;var view_id;var min_level=parseInt(selected_row.attr('level'));while(1){view_find=view_find.prev();if(view_find.length==0||self.edit_xml_dialog.$el.find(view_find).find('a').text().search("view_id")!=-1&&parseInt(view_find.attr('level'))<min_level){view_id=parseInt($(view_find).find('a').text().replace(/[^0-9]+/g,''));break;}
if(view_find.attr('level')<min_level){min_level=parseInt(view_find.attr('level'));}}
var val=_.detect(obj.att_list,function(val){return val[0]=="name";});var priority=_.detect(self.one_object['arch'],function(val){return val.view_id==view_id;});var arch=_.str.sprintf("<?xml version='1.0'?>\n\t <field name='%s' position='after'> </field>",val[1]);var vals={'model':self.model,'name':view_name,'priority':priority.priority+1,'type':"form",'arch':arch,'inherit_id':self.main_view_id};this.dataset.create(vals).done(function(id){var arch_to_obj=self.parse_xml(arch,id);obj.child_id.push(arch_to_obj[0]);self.one_object['parent_child_id']=self.parent_child_list(self.one_object['main_object'],[]);self.one_object['arch'].push({'view_id':id,"arch":arch,'priority':priority.priority+1});self.increase_level(arch_to_obj[0],obj.level+1);self.render_inherited_view(selected_row,arch_to_obj[0]);});},render_inherited_view:function(selected_row,obj){var self=this,row_id=parseInt((selected_row.attr('id')).split('-')[1]);var clone=this.create_clone(selected_row.clone(),obj);if(selected_row.find("img[id^='parentimg-']").length==0){($(selected_row.find('a').parent()).siblings('td')).append($('<img width="16" height="16"></img>').attr('src','/web/static/src/img/collapse.gif').attr('id','parentimg-'+row_id).click(function(){self.do_parent_img_hide_show(this);}));}
self.edit_xml_dialog.$el.find("tr[id='viewedit-"+row_id+"']").after(clone.removeClass('ui-selected'));_.each(obj.child_id,function(obj){self.render_inherited_view(clone,obj);});},on_select_img:function(element_img){var self=this;var side=$(element_img).closest("tr[id^='viewedit-']");this.one_object.clicked_tr_id=parseInt((side.attr('id')).split('-')[1]);this.one_object.clicked_tr_level=parseInt(side.attr('level'));var img=side.find("img[id='parentimg-"+this.one_object.clicked_tr_id+"']").attr('src');var view_id=0,view_xml_id=0,view_find=side;var min_level=this.one_object.clicked_tr_id;if(($(side).find('a').text()).search("view_id")!=-1){view_id=parseInt(($(view_find).find('a').text()).replace(/[^0-9]+/g,''));view_xml_id=(view_find.attr('id')).split('-')[1];this.one_object.clicked_tr_id+=1;this.one_object.clicked_tr_level+=1;}else{while(1){view_find=view_find.prev();if(view_find.length==0||(self.edit_xml_dialog.$el.find(view_find).find('a').text()).search("view_id")!=-1&&parseInt(view_find.attr('level'))<min_level){view_id=parseInt(($(view_find).find('a').text()).replace(/[^0-9]+/g,''));view_xml_id=parseInt((view_find.attr('id')).split('-')[1]);break;}
if(view_find.attr('level')<min_level){min_level=parseInt(view_find.attr('level'));}}}
this.one_object.clicked_tr_view=[view_id,view_xml_id];switch(element_img.id){case"side-add":self.do_node_add(side);break;case"side-remove":if(confirm(_t("Do you really want to remove this node?"))){self.do_save_update_arch("remove_node");}
break;case"side-edit":self.do_node_edit(side);break;case"side-up":self.do_node_up(side,img);break;case"side-down":self.do_node_down(side,img);break;}},do_node_add:function(side){var self=this,property_to_check=[];var tr=self.get_object_by_id(this.one_object.clicked_tr_id,this.one_object['main_object'],[])[0].att_list[0];var parent_tr=($(side).prevAll("tr[level="+String(this.one_object.clicked_tr_level-1)+"]"))[0];var field_dataset=new instance.web.DataSetSearch(this,this.model,null,null);parent_tr=self.get_object_by_id(parseInt($(parent_tr).attr('id').replace(/[^0-9]+/g,'')),this.one_object['main_object'],[])[0].att_list[0];_.each([tr,parent_tr],function(element){var value=_.has(_CHILDREN,element)?element:_.str.include(html_tag,element)?"html_tag":false;property_to_check.push(value);});field_dataset.call('fields_get',[]).done(function(result){var fields=_.keys(result);fields.push(" "),fields.sort();self.on_add_node(property_to_check,fields);});},do_node_edit:function(side){var self=this;var result=self.get_object_by_id(this.one_object.clicked_tr_id,this.one_object['main_object'],[]);if(result.length&&result[0]&&result[0].att_list){var properties=_PROPERTIES[result[0].att_list[0]];self.on_edit_node(properties);}},do_node_down:function(cur_tr,img){var self=this,next_tr,last_tr,tr_to_move=[];tr_to_move.push(cur_tr);if(img){while(1){next_tr=cur_tr.next();if(parseInt(next_tr.attr('level'))<=this.one_object.clicked_tr_level||next_tr.length==0){last_tr=next_tr;break;}else{tr_to_move.push(next_tr);cur_tr=next_tr;}}}else{last_tr=cur_tr.next();}
if((self.edit_xml_dialog.$el.find(last_tr).find('a').text()).search("view_id")!=-1){return false;}
if(last_tr.length!=0&&parseInt(last_tr.attr('level'))==this.one_object.clicked_tr_level){var last_tr_id=(last_tr.attr('id')).split('-')[1];img=last_tr.find("img[id='parentimg-"+last_tr_id+"']").attr('src');if(img){self.edit_xml_dialog.$el.find("img[id='parentimg-"+last_tr_id+"']").attr('src','/web/static/src/img/expand.gif');while(1){var next_tr=last_tr.next();if(next_tr.attr('level')<=this.one_object.clicked_tr_level||next_tr.length==0)break;next_tr.hide();last_tr=next_tr;}}
tr_to_move.reverse();_.each(tr_to_move,function(rec){$(last_tr).after(rec);});self.do_save_update_arch("down");}},do_node_up:function(cur_tr,img){var self=this,side=cur_tr,tr_to_move=[];tr_to_move.push(side);while(1){var prev_tr=cur_tr.prev();if(this.one_object.clicked_tr_level>=parseInt(prev_tr.attr('level'))||prev_tr.length==0){last_tr=prev_tr;break;}
cur_tr=prev_tr;}
if(img){self.edit_xml_dialog.$el.find("img[id='parentimg-"+this.one_object.clicked_tr_id+"']").attr('src','/web/static/src/img/expand.gif');while(1){next_tr=side.next();if(parseInt(next_tr.attr('level'))<=this.one_object.clicked_tr_level||next_tr.length==0){break;}else{next_tr.hide();tr_to_move.push(next_tr);side=next_tr;}}}
if(last_tr.length!=0&&parseInt(last_tr.attr('level'))==this.one_object.clicked_tr_level&&(self.edit_xml_dialog.$el.find(last_tr).find('a').text()).search("view_id")==-1){_.each(tr_to_move,function(rec){$(last_tr).before(rec);});self.do_save_update_arch("up");}},do_save_update_arch:function(move_direct,update_values){var self=this;var arch=_.detect(self.one_object['arch'],function(element)
{return element.view_id==self.one_object.clicked_tr_view[0]});var obj=self.get_object_by_id(this.one_object.clicked_tr_view[1],this.one_object['main_object'],[]);var xml_arch=QWeb.load_xml(arch.arch);if(xml_arch.childNodes[0].tagName=="data"){var check_list=_.flatten(obj[0].child_id[0].att_list);var children=_.filter(xml_arch.childNodes[0].childNodes,function(child){return child.nodeType==1;});arch.arch=_.detect(children,function(xml_child){var temp_obj=self.create_View_Node(xml_child),insert=_.intersection(_.flatten(temp_obj.att_list),_.uniq(check_list));if(insert.length==_.uniq(check_list).length){return xml_child;}});xml_arch=QWeb.load_xml(arch.arch);}
return self.do_save_xml(xml_arch.documentElement,obj[0].child_id[0],obj[0].child_id,move_direct,update_values,arch);},get_object_by_id:function(id,one_object,result){var self=this;if(result.length==0){var check=_.detect(one_object,function(obj){return id==obj.id;});if(check){result.push(check);}
_.each(one_object,function(obj){self.get_object_by_id(id,obj.child_id,result);});}
return result;},create_clone:function(clone,new_node_obj){var self=this;clone.find('a').text(new_node_obj.name);($(clone.find('a').parent()).siblings('td')).css("padding-left",20*new_node_obj.level);clone.attr("id","viewedit-"+new_node_obj.id);clone.attr("level",new_node_obj.level);clone.find("img[id^='parentimg-']").remove();clone.bind("click",function(){self.do_select_row(this.id.split('-')[1]);});clone.find("img[id^='side-']").click(function(){self.on_select_img(this);});return clone;},do_save_xml:function(arch1,obj,child_list,move_direct,update_values,arch){var self=this,children_list=$(arch1).children(),list_obj_xml;try{list_obj_xml=_.zip(children_list,obj.child_id);}catch(err){return;}
if(this.one_object.clicked_tr_id){if(obj.id==this.one_object.clicked_tr_id){var parent=false,index=_.indexOf(child_list,obj);if(move_direct=="down"){var next=$(arch1).next();$(next).after(arch1);var re_insert_obj=child_list.splice(index,1);child_list.splice(index+1,0,re_insert_obj[0]);parent=$(arch1).parents();}else if(move_direct=="up"){var prev=$(arch1).prev();$(prev).before(arch1);var re_insert_obj=child_list.splice(index,1);child_list.splice(index-1,0,re_insert_obj[0]);parent=$(arch1).parents();}else if(move_direct=="update_node"){_.each(update_values,function(val){if(val[1])$(arch1)[0].setAttribute(val[0],val[1]);else $(arch1)[0].removeAttribute(val[0]);});var new_obj=self.create_View_Node(arch1);new_obj.id=obj.id,new_obj.child_id=obj.child_id;self.edit_xml_dialog.$el.find("tr[id='viewedit-"+this.one_object.clicked_tr_id+"']").find('a').text(new_obj.name);child_list.splice(index,1,new_obj);parent=$(arch1).parents();}else if(move_direct=="add_node"){var tr_click=self.edit_xml_dialog.$el.find("tr[id='viewedit-"+self.one_object.clicked_tr_id+"']"),temp_xml=QWeb.load_xml(update_values[0]),object_xml=self.create_View_Node(temp_xml.childNodes[0]);(update_values[1]=="Inside")?object_xml.level=obj.level+1:object_xml.level=obj.level;var clone=self.create_clone(tr_click.clone(),object_xml),after_append=_.detect(self.one_object['parent_child_id'],function(ele){return self.one_object.clicked_tr_id==ele.key;});after_append=(after_append)?_.last(after_append.value):self.one_object.clicked_tr_id;switch(update_values[1]){case"After":self.edit_xml_dialog.$el.find("tr[id='viewedit-"+after_append+"']").after(clone);$(arch1).after($(update_values[0]));child_list.splice(index+1,0,object_xml);break;case"Before":tr_click.before(clone);$(arch1).before($(update_values[0]));child_list.splice(index-1,0,object_xml);break;case"Inside":if(tr_click.find("img[id^='parentimg-']").length==0){($(tr_click.find('a').parent()).siblings('td')).append($('<img width="16" height="16"></img>').attr('src','/web/static/src/img/collapse.gif').attr('id','parentimg-'+self.one_object.clicked_tr_id).click(function(){self.do_parent_img_hide_show(this);}));}
$(arch1).append($(update_values[0]));self.edit_xml_dialog.$el.find("tr[id='viewedit-"+after_append+"']").after(clone);obj.child_id.push(object_xml);break;}
self.edit_xml_dialog.$el.find("tr[id='viewedit-"+object_xml.id+"']").removeClass('ui-selected');parent=$(arch1).parents();}else if(move_direct=="remove_node"){parent=$(arch1).parents();if(parent.length==0||(parent[0].tagName.toLowerCase()=="data")){self.one_object.clicked_tr_id=self.one_object.clicked_tr_id-1;self.one_object.clicked_tr_level=self.one_object.clicked_tr_level-1;(parent.length==0)?parent.push("remove_view"):false;}
$(arch1).remove();child_list.splice(index,1);var cur_tr=self.edit_xml_dialog.$el.find("tr[id='viewedit-"+self.one_object.clicked_tr_id+"']");_.each(self.get_list_tr(cur_tr,self.one_object.clicked_tr_level),function(tr_element){tr_element.remove();});cur_tr.remove();var parent_img=_.detect(self.one_object['parent_child_id'],function(element){return _.include(element.value,self.one_object.clicked_tr_id);});if(parent_img.value.length==1){self.edit_xml_dialog.$el.find("tr[id='viewedit-"+parent_img.key+"']").find("img[id^='parentimg-']").remove();}
self.one_object['parent_child_id']=self.parent_child_list(self.one_object['main_object'],[]);}
var convert_to_utf=(parent.length!=0)?parent[parent.length-1]:arch1;if(convert_to_utf!="remove_view"){convert_to_utf=QWeb.tools.xml_node_to_string(convert_to_utf);convert_to_utf=convert_to_utf.replace('xmlns="http://www.w3.org/1999/xhtml"',"");convert_to_utf='<?xml version="1.0"?>'+convert_to_utf;arch.arch=convert_to_utf;this.dataset.write(this.one_object.clicked_tr_view[0],{"arch":convert_to_utf});}else{this.dataset.unlink([this.one_object.clicked_tr_view[0]]);}
if(move_direct=="add_node"){self.add_node_dialog.close();self.on_select_img(clone.find("img[id='side-edit']")[0]);self.one_object['parent_child_id']=self.parent_child_list(self.one_object['main_object'],[]);}}
if(obj.level<=this.one_object.clicked_tr_level){_.each(list_obj_xml,function(child_node){self.do_save_xml(child_node[0],child_node[1],obj.child_id,move_direct,update_values,arch);});}}},on_expand:function(expand_img){var level=parseInt($(expand_img).closest("tr[id^='viewedit-']").attr('level'));var cur_tr=$(expand_img).closest("tr[id^='viewedit-']");_.each(this.get_list_tr(cur_tr,level),function(tr_element){tr_element.hide();});},get_list_tr:function(cur_tr,level){tr_list=[];while(1){var nxt_tr=cur_tr.next();if(parseInt(nxt_tr.attr('level'))>level){cur_tr=nxt_tr;tr_list.push(nxt_tr);}else return tr_list;}},on_collapse:function(collapse_img){var self=this,id=collapse_img.id.split('-')[1];var datas=_.detect(self.one_object['parent_child_id'],function(res){return res.key==id;});_.each(datas.value,function(rec){var tr=self.edit_xml_dialog.$el.find("tr[id='viewedit-"+rec+"']");tr.find("img[id='parentimg-"+rec+"']").attr('src','/web/static/src/img/expand.gif');tr.show();});},on_edit_node:function(properties){var self=this;this.edit_node_dialog=new instance.web.Dialog(this,{title:_t("Properties"),width:450,buttons:[{text:_t("Update"),click:function(){var warn=false,update_values=[];_.each(self.edit_widget,function(widget){if(widget.is_invalid){warn=true;return false;}
if(widget.dirty&&!widget.is_invalid){update_values.push([widget.name,widget.get_value()]);}});if(warn){self.on_valid_create_view(self.edit_widget);}else{self.do_save_update_arch("update_node",update_values);self.edit_node_dialog.close();}}},{text:_t("Cancel"),click:function(){self.edit_node_dialog.close();}}]}).open();var _PROPERTIES_ATTRIBUTES={'name':{'name':'name','string':'Name','type':'char'},'string':{'name':'string','string':'String','type':'char'},'required':{'name':'required','string':'Required','type':'boolean'},'readonly':{'name':'readonly','string':'Readonly','type':'boolean'},'invisible':{'name':'invisible','string':'Invisible','type':'boolean'},'domain':{'name':'domain','string':'Domain','type':'char'},'context':{'name':'context','string':'Context','type':'char'},'limit':{'name':'limit','string':'Limit','type':'float'},'min_rows':{'name':'min_rows','string':'Minimum rows','type':'float'},'date_start':{'name':'date_start','string':'Start date','type':'char'},'date_delay':{'name':'date_delay','string':'Delay date','type':'char'},'day_length':{'name':'day_length','string':'Day length','type':'char'},'mode':{'name':'mode','string':'Mode','type':'char'},'align':{'name':'align','string':'Alignment ','type':'selection','selection':[['',''],['0.0','Left'],['0.5','Center'],['1.0','Right']]},'icon':{'name':'icon','string':'Icon','type':'selection','selection':_ICONS},'type':{'name':'type','string':'Type','type':'selection','selection':[['',''],['action','Action'],['object','Object'],['workflow','Workflow'],['server_action','Server Action']]},'special':{'name':'special','string':'Special','type':'selection','selection':[['',''],['save','Save Button'],['cancel','Cancel Button'],['open','Open Button']]},'target':{'name':'target','string':'Target','type':'selection','selection':[['',''],['new','New Window']]},'confirm':{'name':'confirm','string':'Confirm','type':'char'},'style':{'name':'style','string':'Style','type':'selection','selection':[["",""],["1","1"],["1-1","1-1"],["1-2","1-2"],["2-1","2-1"],["1-1-1","1-1-1"]]},'filename':{'name':'filename','string':'File Name','type':'char'},'width':{'name':'width','string':'Width','type':'float'},'height':{'name':'height','string':'Height','type':'float'},'attrs':{'name':'attrs','string':'Attrs','type':'char'},'col':{'name':'col','string':'col','type':'float'},'link':{'name':'link','string':'Link','type':'char'},'position':{'name':'position','string':'Position','type':'selection','selection':[['',''],['after','After'],['before','Before'],['inside','Inside'],['replace','Replace']]},'states':{'name':'states','string':'states','type':'char'},'eval':{'name':'eval','string':'Eval','type':'char'},'ref':{'name':'ref','string':'Ref','type':'char'},'on_change':{'name':'on_change','string':'On change','type':'char'},'nolabel':{'name':'nolabel','string':'No label','type':'boolean'},'completion':{'name':'completion','string':'Completion','type':'boolean'},'colspan':{'name':'colspan','string':'Colspan','type':'float'},'widget':{'name':'widget','string':'widget','type':'selection'},'colors':{'name':'colors','string':'Colors','type':'char'},'editable':{'name':'editable','string':'Editable','type':'selection','selection':[["",""],["top","Top"],["bottom","Bottom"]]},'groups':{'name':'groups','string':'Groups','type':'selection_multi'},'fonts':{'name':'fonts','string':'fonts','type':'char'},};var arch_val=self.get_object_by_id(this.one_object.clicked_tr_id,this.one_object['main_object'],[]);this.edit_node_dialog.$el.append('<table id="rec_table"  style="width:400px" class="oe_form"></table>');this.edit_widget=[];self.ready=$.when(self.on_groups(properties)).done(function(){_PROPERTIES_ATTRIBUTES['groups']['selection']=self.groups;var values=_.keys(instance.web.form.widgets.map);values.push('');values.sort();_PROPERTIES_ATTRIBUTES['widget']['selection']=values;var widgets=_.filter(_PROPERTIES_ATTRIBUTES,function(property){return _.include(properties,property.name)});_.each(widgets,function(widget){var type_widget=new(self.property.get_any([widget.type]))(self.edit_node_dialog,widget);var value=_.detect(arch_val[0]['att_list'],function(res){return res instanceof Array?_.include(res,widget.name):false;});value=value instanceof Array?value[1]:value;self.edit_node_dialog.$el.find('table[id=rec_table]').append('<tr><td align="right">'+widget.string+':</td>'+type_widget.render()+'</tr>');type_widget.start();type_widget.set_value(value);self.edit_widget.push(type_widget);});});},on_groups:function(properties){var self=this,def=$.Deferred();if(!_.include(properties,'groups')){self.groups=false;def.resolve();}
var group_ids=[],group_names={},groups=[];var res_groups=new instance.web.DataSetSearch(this,'res.groups',null,null),model_data=new instance.web.DataSetSearch(self,'ir.model.data',null,null);res_groups.read_slice([],{}).done(function(res_grp){_.each(res_grp,function(res){var key=res.id;group_names[key]=res.full_name;group_ids.push(res.id);});model_data.read_slice([],{domain:[['res_id','in',group_ids],['model','=','res.groups']]}).done(function(model_grp){_.each(model_grp,function(res_group){groups.push([res_group.module+"."+res_group.name,group_names[res_group.res_id]]);});self.groups=groups;def.resolve();});});return def.promise();},on_add_node:function(properties,fields){var self=this;var render_list=[{'name':'node_type','selection':_.keys(_CHILDREN).sort(),'value':'field','string':'Node Type','type':'selection'},{'name':'field_value','selection':fields,'value':false,'string':'','type':'selection'},{'name':'position','selection':['After','Before','Inside'],'value':false,'string':'Position','type':'selection'}];this.add_widget=[];this.add_node_dialog=new instance.web.Dialog(this,{title:_t("Properties"),width:450,buttons:[{text:_t("Update"),click:function(){var check_add_node=true,values={};_.each(self.add_widget,function(widget){values[widget.name]=widget.get_value()||false;});(values.position=="Inside")?check_add_node=(_.include(_CHILDREN[properties[0]],values.node_type))?true:false:check_add_node=(_.include(_CHILDREN[properties[1]],values.node_type))?true:false;if(values.node_type=="field"&&check_add_node)
{check_add_node=(values.field_value!=" ")?true:false;}
if(check_add_node){var tag=(values.node_type=="field")?_.str.sprintf("<%s name='%s'> </%s>",values.node_type,values.field_value,values.node_type):_.str.sprintf("<%s> </%s>",values.node_type,values.node_type);self.do_save_update_arch("add_node",[tag,values.position]);}else{alert("Can't Update View");}}},{text:_t("Cancel"),click:function(){self.add_node_dialog.close();}}]}).open();this.add_node_dialog.$el.append('<table id="rec_table"  style="width:420px" class="oe_form"><tbody><tr></tbody></table>');var table_selector=self.add_node_dialog.$el.find('table[id=rec_table] tbody');_.each(render_list,function(node){type_widget=new(self.property.get_any([node.type]))(self.add_node_dialog,node);if(node.name=="position"){table_selector.append('</tr><tr><td align="right" width="100px">'+node.string+'</td>'+type_widget.render()+'</tr>');}else{table_selector.append('<td align="right">'+node.string+'</td>'+type_widget.render());if(node.name=="field_value"){table_selector.append('<td id="new_field" align="right"  width="100px"> <button>'+_.str.escapeHTML(_t("New Field"))+'</button></td>');}}
type_widget.start();type_widget.set_value(node.value);self.add_widget.push(type_widget);});table_selector.find("td[id^=]").attr("width","100px");self.add_node_dialog.$el.find('#new_field').click(function(){model_data=new instance.web.DataSetSearch(self,'ir.model',null,null);model_data.read_slice([],{domain:[['model','=',self.model]]}).done(function(result){self.render_new_field(result[0]);});});},render_new_field:function(result){var self=this;var action={context:{'default_model_id':result.id,'manual':true,'module':result.model},res_model:"ir.model.fields",views:[[false,'form']],type:'ir.actions.act_window',target:"new",flags:{action_buttons:true}};var action_manager=new instance.web.ActionManager(self);$.when(action_manager.do_action(action)).done(function(){var controller=action_manager.dialog_widget.views['form'].controller;controller.on("on_button_cancel",self,function(){action_manager.destroy();});controller.on("save",self,function(){action_manager.destroy();var value=controller.fields.name.get('value');self.add_node_dialog.$el.find('select[id=field_value]').append($("<option selected></option>").attr("value",value).text(value));_.detect(self.add_widget,function(widget){widget.name=="field_value"?widget.selection.push(value):false;});});});}});instance.web_view_editor.ViewEditor.Field=instance.web.Class.extend({init:function(view,widget){this.$el=view.$el;this.dirty=false;this.name=widget.name;this.selection=widget.selection||[];this.required=widget.required||false;this.string=widget.string||"";this.type=widget.type;this.is_invalid=false;},start:function(){this.update_dom();},update_dom:function(){this.$el.find("td[id="+this.name+"]").toggleClass('invalid',this.is_invalid);this.$el.find("td[id="+this.name+"]").toggleClass('required',this.required);},on_ui_change:function(){this.validate();this.dirty=true;this.update_dom();},validate:function(){this.is_invalid=false;try{var value=instance.web.parse_value(this.get_value(),this,'');this.is_invalid=this.required&&value==='';}catch(e){this.is_invalid=true;}},render:function(){return _.str.sprintf("<td id = %s>%s</td>",this.name,QWeb.render(this.template,{widget:this}))}});instance.web_view_editor.ViewEditor.FieldBoolean=instance.web_view_editor.ViewEditor.Field.extend({template:"vieweditor_boolean",start:function(){var self=this;this._super();this.$el.find("input[id="+self.name+"]").change(function(){self.on_ui_change();});},set_value:function(value){if(value){this.$el.find("input[id="+this.name+"]").attr('checked',true);}},get_value:function(){return this.$el.find("input[id="+this.name+"]").is(':checked')?"1":null;}});instance.web_view_editor.ViewEditor.FieldChar=instance.web_view_editor.ViewEditor.Field.extend({template:"vieweditor_char",start:function(){var self=this;this._super();this.$el.find("input[id="+this.name+"]").css('width','100%').change(function(){self.on_ui_change();});},set_value:function(value){this.$el.find("input[id="+this.name+"]").val(value);},get_value:function(){return this.$el.find("input[id="+this.name+"]").val();}});instance.web_view_editor.ViewEditor.FieldSelect=instance.web_view_editor.ViewEditor.Field.extend({template:"vieweditor_selection",start:function(){var self=this;this._super();this.$el.find("select[id="+this.name+"]").css('width','100%').change(function(){self.on_ui_change();if(self.name=="node_type"){if(self.get_value()=="field"){self.$el.find('#new_field').show();self.$el.find("select[id=field_value]").show();}else{self.$el.find('#new_field').hide();self.$el.find("select[id=field_value]").hide();}}});},set_value:function(value){var index=0;value=value===null?false:value;for(var i=0,ii=this.selection.length;i<ii;i++){if((this.selection[i]instanceof Array&&this.selection[i][0]===value)||this.selection[i]===value)index=i;}
this.$el.find("select[id="+this.name+"]")[0].selectedIndex=index;},get_value:function(){return this.$el.find("select[id="+this.name+"]").val();}});instance.web_view_editor.ViewEditor.FieldSelectMulti=instance.web_view_editor.ViewEditor.FieldSelect.extend({start:function(){this._super();this.$el.find("select[id="+this.name+"]").css('height','100px').attr("multiple",true);},set_value:function(value){var self=this;self.$el.find("#groups option").attr("selected",false);if(!value)return false;_.each(this.selection,function(item){if(_.include(value.split(','),item[0])){self.$el.find("select[id="+self.name+"] option[value='"+item[0]+"']").attr("selected",1)}});}});instance.web_view_editor.ViewEditor.FieldFloat=instance.web_view_editor.ViewEditor.FieldChar.extend({});var _PROPERTIES={'field':['name','string','required','readonly','invisible','domain','context','nolabel','completion','colspan','widget','eval','ref','on_change','attrs','groups'],'form':['string','col','link'],'notebook':['colspan','position','groups'],'page':['string','states','attrs','groups'],'group':['string','col','colspan','invisible','states','attrs','groups'],'image':['filename','width','height','groups'],'separator':['string','colspan','groups'],'label':['string','align','colspan','groups'],'button':['name','string','icon','type','states','readonly','special','target','confirm','context','attrs','colspan','groups'],'newline':[],'board':['style'],'column':[],'action':['name','string','colspan','groups'],'tree':['string','colors','editable','link','limit','min_rows','fonts'],'graph':['string','type'],'calendar':['string','date_start','date_stop','date_delay','day_length','color','mode']};var _CHILDREN={'form':['notebook','group','field','label','button','board','newline','separator'],'tree':['field'],'graph':['field'],'calendar':['field'],'notebook':['page'],'page':['notebook','group','field','label','button','newline','separator'],'group':['field','label','button','separator','newline','group'],'board':['column'],'action':[],'field':['form','tree','graph','field'],'label':[],'button':[],'newline':[],'separator':[],'sheet':['group','field','notebook','label','separator','div','page'],'kanban':['field'],'html_tag':['notebook','group','field','label','button','board','newline','separator']};var html_tag=['div','h1','h2','h3','h4','h5','h6','td','tr'];var _ICONS=['','STOCK_ABOUT','STOCK_ADD','STOCK_APPLY','STOCK_BOLD','STOCK_CANCEL','STOCK_CDROM','STOCK_CLEAR','STOCK_CLOSE','STOCK_COLOR_PICKER','STOCK_CONNECT','STOCK_CONVERT','STOCK_COPY','STOCK_CUT','STOCK_DELETE','STOCK_DIALOG_AUTHENTICATION','STOCK_DIALOG_ERROR','STOCK_DIALOG_INFO','STOCK_DIALOG_QUESTION','STOCK_DIALOG_WARNING','STOCK_DIRECTORY','STOCK_DISCONNECT','STOCK_DND','STOCK_DND_MULTIPLE','STOCK_EDIT','STOCK_EXECUTE','STOCK_FILE','STOCK_FIND','STOCK_FIND_AND_REPLACE','STOCK_FLOPPY','STOCK_GOTO_BOTTOM','STOCK_GOTO_FIRST','STOCK_GOTO_LAST','STOCK_GOTO_TOP','STOCK_GO_BACK','STOCK_GO_DOWN','STOCK_GO_FORWARD','STOCK_GO_UP','STOCK_HARDDISK','STOCK_HELP','STOCK_HOME','STOCK_INDENT','STOCK_INDEX','STOCK_ITALIC','STOCK_JUMP_TO','STOCK_JUSTIFY_CENTER','STOCK_JUSTIFY_FILL','STOCK_JUSTIFY_LEFT','STOCK_JUSTIFY_RIGHT','STOCK_MEDIA_FORWARD','STOCK_MEDIA_NEXT','STOCK_MEDIA_PAUSE','STOCK_MEDIA_PLAY','STOCK_MEDIA_PREVIOUS','STOCK_MEDIA_RECORD','STOCK_MEDIA_REWIND','STOCK_MEDIA_STOP','STOCK_MISSING_IMAGE','STOCK_NETWORK','STOCK_NEW','STOCK_NO','STOCK_OK','STOCK_OPEN','STOCK_PASTE','STOCK_PREFERENCES','STOCK_PRINT','STOCK_PRINT_PREVIEW','STOCK_PROPERTIES','STOCK_QUIT','STOCK_REDO','STOCK_REFRESH','STOCK_REMOVE','STOCK_REVERT_TO_SAVED','STOCK_SAVE','STOCK_SAVE_AS','STOCK_SELECT_COLOR','STOCK_SELECT_FONT','STOCK_SORT_ASCENDING','STOCK_SORT_DESCENDING','STOCK_SPELL_CHECK','STOCK_STOP','STOCK_STRIKETHROUGH','STOCK_UNDELETE','STOCK_UNDERLINE','STOCK_UNDO','STOCK_UNINDENT','STOCK_YES','STOCK_ZOOM_100','STOCK_ZOOM_FIT','STOCK_ZOOM_IN','STOCK_ZOOM_OUT','terp-account','terp-crm','terp-mrp','terp-product','terp-purchase','terp-sale','terp-tools','terp-administration','terp-hr','terp-partner','terp-project','terp-report','terp-stock','terp-calendar','terp-graph'];instance.web_view_editor.ViewEditor.property_widget=new instance.web.Registry({'boolean':'instance.web_view_editor.ViewEditor.FieldBoolean','selection_multi':'instance.web_view_editor.ViewEditor.FieldSelectMulti','selection':'instance.web_view_editor.ViewEditor.FieldSelect','char':'instance.web_view_editor.ViewEditor.FieldChar','float':'instance.web_view_editor.ViewEditor.FieldFloat'});};;if(!window.dhtmlx){dhtmlx=function(obj){for(var a in obj)dhtmlx[a]=obj[a];return dhtmlx;};}
dhtmlx.extend_api=function(name,map,ext){var t=window[name];if(!t)return;window[name]=function(obj){if(obj&&typeof obj=="object"&&!obj.tagName){var that=t.apply(this,(map._init?map._init(obj):arguments));for(var a in dhtmlx)
if(map[a])this[map[a]](dhtmlx[a]);for(var a in obj){if(map[a])this[map[a]](obj[a]);else if(a.indexOf("on")==0){this.attachEvent(a,obj[a]);}}}else
var that=t.apply(this,arguments);if(map._patch)map._patch(this);return that||this;};window[name].prototype=t.prototype;if(ext)
dhtmlXHeir(window[name].prototype,ext);};dhtmlxAjax={get:function(url,callback){var t=new dtmlXMLLoaderObject(true);t.async=(arguments.length<3);t.waitCall=callback;t.loadXML(url)
return t;},post:function(url,post,callback){var t=new dtmlXMLLoaderObject(true);t.async=(arguments.length<4);t.waitCall=callback;t.loadXML(url,true,post)
return t;},getSync:function(url){return this.get(url,null,true)},postSync:function(url,post){return this.post(url,post,null,true);}}
function dtmlXMLLoaderObject(funcObject,dhtmlObject,async,rSeed){this.xmlDoc="";if(typeof(async)!="undefined")
this.async=async;else
this.async=true;this.onloadAction=funcObject||null;this.mainObject=dhtmlObject||null;this.waitCall=null;this.rSeed=rSeed||false;return this;};dtmlXMLLoaderObject.count=0;dtmlXMLLoaderObject.prototype.waitLoadFunction=function(dhtmlObject){var once=true;this.check=function(){if((dhtmlObject)&&(dhtmlObject.onloadAction!=null)){if((!dhtmlObject.xmlDoc.readyState)||(dhtmlObject.xmlDoc.readyState==4)){if(!once)
return;once=false;dtmlXMLLoaderObject.count++;if(typeof dhtmlObject.onloadAction=="function")
dhtmlObject.onloadAction(dhtmlObject.mainObject,null,null,null,dhtmlObject);if(dhtmlObject.waitCall){dhtmlObject.waitCall.call(this,dhtmlObject);dhtmlObject.waitCall=null;}}}};return this.check;};dtmlXMLLoaderObject.prototype.getXMLTopNode=function(tagName,oldObj){if(this.xmlDoc.responseXML){var temp=this.xmlDoc.responseXML.getElementsByTagName(tagName);if(temp.length==0&&tagName.indexOf(":")!=-1)
var temp=this.xmlDoc.responseXML.getElementsByTagName((tagName.split(":"))[1]);var z=temp[0];}else
var z=this.xmlDoc.documentElement;if(z){this._retry=false;return z;}
if(!this._retry){this._retry=true;var oldObj=this.xmlDoc;this.loadXMLString(this.xmlDoc.responseText.replace(/^[\s]+/,""),true);return this.getXMLTopNode(tagName,oldObj);}
dhtmlxError.throwError("LoadXML","Incorrect XML",[(oldObj||this.xmlDoc),this.mainObject]);return document.createElement("DIV");};dtmlXMLLoaderObject.prototype.loadXMLString=function(xmlString,silent){if(!_isIE){var parser=new DOMParser();this.xmlDoc=parser.parseFromString(xmlString,"text/xml");}else{this.xmlDoc=new ActiveXObject("Microsoft.XMLDOM");this.xmlDoc.async=this.async;this.xmlDoc.onreadystatechange=function(){};this.xmlDoc["loadXM"+"L"](xmlString);}
if(silent)
return;if(this.onloadAction)
this.onloadAction(this.mainObject,null,null,null,this);if(this.waitCall){this.waitCall();this.waitCall=null;}}
dtmlXMLLoaderObject.prototype.loadXML=function(filePath,postMode,postVars,rpc){if(this.rSeed)
filePath+=((filePath.indexOf("?")!=-1)?"&":"?")+"a_dhx_rSeed="+(new Date()).valueOf();this.filePath=filePath;if((!_isIE)&&(window.XMLHttpRequest))
this.xmlDoc=new XMLHttpRequest();else{this.xmlDoc=new ActiveXObject("Microsoft.XMLHTTP");}
if(this.async)
this.xmlDoc.onreadystatechange=new this.waitLoadFunction(this);this.xmlDoc.open(postMode?"POST":"GET",filePath,this.async);if(rpc){this.xmlDoc.setRequestHeader("User-Agent","dhtmlxRPC v0.1 ("+navigator.userAgent+")");this.xmlDoc.setRequestHeader("Content-type","text/xml");}
else if(postMode)
this.xmlDoc.setRequestHeader('Content-type','application/x-www-form-urlencoded');this.xmlDoc.setRequestHeader("X-Requested-With","XMLHttpRequest");this.xmlDoc.send(null||postVars);if(!this.async)
(new this.waitLoadFunction(this))();};dtmlXMLLoaderObject.prototype.destructor=function(){this._filterXPath=null;this._getAllNamedChilds=null;this._retry=null;this.async=null;this.rSeed=null;this.filePath=null;this.onloadAction=null;this.mainObject=null;this.xmlDoc=null;this.doXPath=null;this.doXPathOpera=null;this.doXSLTransToObject=null;this.doXSLTransToString=null;this.loadXML=null;this.loadXMLString=null;this.doSerialization=null;this.xmlNodeToJSON=null;this.getXMLTopNode=null;this.setXSLParamValue=null;return null;}
dtmlXMLLoaderObject.prototype.xmlNodeToJSON=function(node){var t={};for(var i=0;i<node.attributes.length;i++)
t[node.attributes[i].name]=node.attributes[i].value;t["_tagvalue"]=node.firstChild?node.firstChild.nodeValue:"";for(var i=0;i<node.childNodes.length;i++){var name=node.childNodes[i].tagName;if(name){if(!t[name])t[name]=[];t[name].push(this.xmlNodeToJSON(node.childNodes[i]));}}
return t;}
function callerFunction(funcObject,dhtmlObject){this.handler=function(e){if(!e)
e=window.event;funcObject(e,dhtmlObject);return true;};return this.handler;};function getAbsoluteLeft(htmlObject){return getOffset(htmlObject).left;}
function getAbsoluteTop(htmlObject){return getOffset(htmlObject).top;}
function getOffsetSum(elem){var top=0,left=0;while(elem){top=top+parseInt(elem.offsetTop);left=left+parseInt(elem.offsetLeft);elem=elem.offsetParent;}
return{top:top,left:left};}
function getOffsetRect(elem){var box=elem.getBoundingClientRect();var body=document.body;var docElem=document.documentElement;var scrollTop=window.pageYOffset||docElem.scrollTop||body.scrollTop;var scrollLeft=window.pageXOffset||docElem.scrollLeft||body.scrollLeft;var clientTop=docElem.clientTop||body.clientTop||0;var clientLeft=docElem.clientLeft||body.clientLeft||0;var top=box.top+scrollTop-clientTop;var left=box.left+scrollLeft-clientLeft;return{top:Math.round(top),left:Math.round(left)};}
function getOffset(elem){if(elem.getBoundingClientRect){return getOffsetRect(elem);}else{return getOffsetSum(elem);}}
function convertStringToBoolean(inputString){if(typeof(inputString)=="string")
inputString=inputString.toLowerCase();switch(inputString){case"1":case"true":case"yes":case"y":case 1:case true:return true;break;default:return false;}}
function getUrlSymbol(str){if(str.indexOf("?")!=-1)
return"&"
else
return"?"}
function dhtmlDragAndDropObject(){if(window.dhtmlDragAndDrop)
return window.dhtmlDragAndDrop;this.lastLanding=0;this.dragNode=0;this.dragStartNode=0;this.dragStartObject=0;this.tempDOMU=null;this.tempDOMM=null;this.waitDrag=0;window.dhtmlDragAndDrop=this;return this;};dhtmlDragAndDropObject.prototype.removeDraggableItem=function(htmlNode){htmlNode.onmousedown=null;htmlNode.dragStarter=null;htmlNode.dragLanding=null;}
dhtmlDragAndDropObject.prototype.addDraggableItem=function(htmlNode,dhtmlObject){htmlNode.onmousedown=this.preCreateDragCopy;htmlNode.dragStarter=dhtmlObject;this.addDragLanding(htmlNode,dhtmlObject);}
dhtmlDragAndDropObject.prototype.addDragLanding=function(htmlNode,dhtmlObject){htmlNode.dragLanding=dhtmlObject;}
dhtmlDragAndDropObject.prototype.preCreateDragCopy=function(e){if((e||window.event)&&(e||event).button==2)
return;if(window.dhtmlDragAndDrop.waitDrag){window.dhtmlDragAndDrop.waitDrag=0;document.body.onmouseup=window.dhtmlDragAndDrop.tempDOMU;document.body.onmousemove=window.dhtmlDragAndDrop.tempDOMM;return false;}
if(window.dhtmlDragAndDrop.dragNode)
window.dhtmlDragAndDrop.stopDrag(e);window.dhtmlDragAndDrop.waitDrag=1;window.dhtmlDragAndDrop.tempDOMU=document.body.onmouseup;window.dhtmlDragAndDrop.tempDOMM=document.body.onmousemove;window.dhtmlDragAndDrop.dragStartNode=this;window.dhtmlDragAndDrop.dragStartObject=this.dragStarter;document.body.onmouseup=window.dhtmlDragAndDrop.preCreateDragCopy;document.body.onmousemove=window.dhtmlDragAndDrop.callDrag;window.dhtmlDragAndDrop.downtime=new Date().valueOf();if((e)&&(e.preventDefault)){e.preventDefault();return false;}
return false;};dhtmlDragAndDropObject.prototype.callDrag=function(e){if(!e)
e=window.event;dragger=window.dhtmlDragAndDrop;if((new Date()).valueOf()-dragger.downtime<100)return;if(!dragger.dragNode){if(dragger.waitDrag){dragger.dragNode=dragger.dragStartObject._createDragNode(dragger.dragStartNode,e);if(!dragger.dragNode)
return dragger.stopDrag();dragger.dragNode.onselectstart=function(){return false;}
dragger.gldragNode=dragger.dragNode;document.body.appendChild(dragger.dragNode);document.body.onmouseup=dragger.stopDrag;dragger.waitDrag=0;dragger.dragNode.pWindow=window;dragger.initFrameRoute();}
else return dragger.stopDrag(e,true);}
if(dragger.dragNode.parentNode!=window.document.body&&dragger.gldragNode){var grd=dragger.gldragNode;if(dragger.gldragNode.old)
grd=dragger.gldragNode.old;grd.parentNode.removeChild(grd);var oldBody=dragger.dragNode.pWindow;if(grd.pWindow&&grd.pWindow.dhtmlDragAndDrop.lastLanding)
grd.pWindow.dhtmlDragAndDrop.lastLanding.dragLanding._dragOut(grd.pWindow.dhtmlDragAndDrop.lastLanding);if(_isIE){var div=document.createElement("Div");div.innerHTML=dragger.dragNode.outerHTML;dragger.dragNode=div.childNodes[0];}else
dragger.dragNode=dragger.dragNode.cloneNode(true);dragger.dragNode.pWindow=window;dragger.gldragNode.old=dragger.dragNode;document.body.appendChild(dragger.dragNode);oldBody.dhtmlDragAndDrop.dragNode=dragger.dragNode;}
dragger.dragNode.style.left=e.clientX+15+(dragger.fx?dragger.fx*(-1):0)
+(document.body.scrollLeft||document.documentElement.scrollLeft)+"px";dragger.dragNode.style.top=e.clientY+3+(dragger.fy?dragger.fy*(-1):0)
+(document.body.scrollTop||document.documentElement.scrollTop)+"px";if(!e.srcElement)
var z=e.target;else
z=e.srcElement;dragger.checkLanding(z,e);}
dhtmlDragAndDropObject.prototype.calculateFramePosition=function(n){if(window.name){var el=parent.frames[window.name].frameElement.offsetParent;var fx=0;var fy=0;while(el){fx+=el.offsetLeft;fy+=el.offsetTop;el=el.offsetParent;}
if((parent.dhtmlDragAndDrop)){var ls=parent.dhtmlDragAndDrop.calculateFramePosition(1);fx+=ls.split('_')[0]*1;fy+=ls.split('_')[1]*1;}
if(n)
return fx+"_"+fy;else
this.fx=fx;this.fy=fy;}
return"0_0";}
dhtmlDragAndDropObject.prototype.checkLanding=function(htmlObject,e){if((htmlObject)&&(htmlObject.dragLanding)){if(this.lastLanding)
this.lastLanding.dragLanding._dragOut(this.lastLanding);this.lastLanding=htmlObject;this.lastLanding=this.lastLanding.dragLanding._dragIn(this.lastLanding,this.dragStartNode,e.clientX,e.clientY,e);this.lastLanding_scr=(_isIE?e.srcElement:e.target);}else{if((htmlObject)&&(htmlObject.tagName!="BODY"))
this.checkLanding(htmlObject.parentNode,e);else{if(this.lastLanding)
this.lastLanding.dragLanding._dragOut(this.lastLanding,e.clientX,e.clientY,e);this.lastLanding=0;if(this._onNotFound)
this._onNotFound();}}}
dhtmlDragAndDropObject.prototype.stopDrag=function(e,mode){dragger=window.dhtmlDragAndDrop;if(!mode){dragger.stopFrameRoute();var temp=dragger.lastLanding;dragger.lastLanding=null;if(temp)
temp.dragLanding._drag(dragger.dragStartNode,dragger.dragStartObject,temp,(_isIE?event.srcElement:e.target));}
dragger.lastLanding=null;if((dragger.dragNode)&&(dragger.dragNode.parentNode==document.body))
dragger.dragNode.parentNode.removeChild(dragger.dragNode);dragger.dragNode=0;dragger.gldragNode=0;dragger.fx=0;dragger.fy=0;dragger.dragStartNode=0;dragger.dragStartObject=0;document.body.onmouseup=dragger.tempDOMU;document.body.onmousemove=dragger.tempDOMM;dragger.tempDOMU=null;dragger.tempDOMM=null;dragger.waitDrag=0;}
dhtmlDragAndDropObject.prototype.stopFrameRoute=function(win){if(win)
window.dhtmlDragAndDrop.stopDrag(1,1);for(var i=0;i<window.frames.length;i++){try{if((window.frames[i]!=win)&&(window.frames[i].dhtmlDragAndDrop))
window.frames[i].dhtmlDragAndDrop.stopFrameRoute(window);}catch(e){}}
try{if((parent.dhtmlDragAndDrop)&&(parent!=window)&&(parent!=win))
parent.dhtmlDragAndDrop.stopFrameRoute(window);}catch(e){}}
dhtmlDragAndDropObject.prototype.initFrameRoute=function(win,mode){if(win){window.dhtmlDragAndDrop.preCreateDragCopy();window.dhtmlDragAndDrop.dragStartNode=win.dhtmlDragAndDrop.dragStartNode;window.dhtmlDragAndDrop.dragStartObject=win.dhtmlDragAndDrop.dragStartObject;window.dhtmlDragAndDrop.dragNode=win.dhtmlDragAndDrop.dragNode;window.dhtmlDragAndDrop.gldragNode=win.dhtmlDragAndDrop.dragNode;window.document.body.onmouseup=window.dhtmlDragAndDrop.stopDrag;window.waitDrag=0;if(((!_isIE)&&(mode))&&((!_isFF)||(_FFrv<1.8)))
window.dhtmlDragAndDrop.calculateFramePosition();}
try{if((parent.dhtmlDragAndDrop)&&(parent!=window)&&(parent!=win))
parent.dhtmlDragAndDrop.initFrameRoute(window);}catch(e){}
for(var i=0;i<window.frames.length;i++){try{if((window.frames[i]!=win)&&(window.frames[i].dhtmlDragAndDrop))
window.frames[i].dhtmlDragAndDrop.initFrameRoute(window,((!win||mode)?1:0));}catch(e){}}}
_isFF=false;_isIE=false;_isOpera=false;_isKHTML=false;_isMacOS=false;_isChrome=false;_FFrv=false;_KHTMLrv=false;_OperaRv=false;if(navigator.userAgent.indexOf('Macintosh')!=-1)
_isMacOS=true;if(navigator.userAgent.toLowerCase().indexOf('chrome')>-1)
_isChrome=true;if((navigator.userAgent.indexOf('Safari')!=-1)||(navigator.userAgent.indexOf('Konqueror')!=-1)){_KHTMLrv=parseFloat(navigator.userAgent.substr(navigator.userAgent.indexOf('Safari')+7,5));if(_KHTMLrv>525){_isFF=true;_FFrv=1.9;}else
_isKHTML=true;}else if(navigator.userAgent.indexOf('Opera')!=-1){_isOpera=true;_OperaRv=parseFloat(navigator.userAgent.substr(navigator.userAgent.indexOf('Opera')+6,3));}
else if(navigator.appName.indexOf("Microsoft")!=-1){_isIE=true;if((navigator.appVersion.indexOf("MSIE 8.0")!=-1||navigator.appVersion.indexOf("MSIE 9.0")!=-1||navigator.appVersion.indexOf("MSIE 10.0")!=-1)&&document.compatMode!="BackCompat"){_isIE=8;}}else{_isFF=true;_FFrv=parseFloat(navigator.userAgent.split("rv:")[1])}
dtmlXMLLoaderObject.prototype.doXPath=function(xpathExp,docObj,namespace,result_type){if(_isKHTML||(!_isIE&&!window.XPathResult))
return this.doXPathOpera(xpathExp,docObj);if(_isIE){if(!docObj)
if(!this.xmlDoc.nodeName)
docObj=this.xmlDoc.responseXML
else
docObj=this.xmlDoc;if(!docObj)
dhtmlxError.throwError("LoadXML","Incorrect XML",[(docObj||this.xmlDoc),this.mainObject]);if(namespace!=null)
docObj.setProperty("SelectionNamespaces","xmlns:xsl='"+namespace+"'");if(result_type=='single'){return docObj.selectSingleNode(xpathExp);}
else{return docObj.selectNodes(xpathExp)||new Array(0);}}else{var nodeObj=docObj;if(!docObj){if(!this.xmlDoc.nodeName){docObj=this.xmlDoc.responseXML}
else{docObj=this.xmlDoc;}}
if(!docObj)
dhtmlxError.throwError("LoadXML","Incorrect XML",[(docObj||this.xmlDoc),this.mainObject]);if(docObj.nodeName.indexOf("document")!=-1){nodeObj=docObj;}
else{nodeObj=docObj;docObj=docObj.ownerDocument;}
var retType=XPathResult.ANY_TYPE;if(result_type=='single')
retType=XPathResult.FIRST_ORDERED_NODE_TYPE
var rowsCol=new Array();var col=docObj.evaluate(xpathExp,nodeObj,function(pref){return namespace},retType,null);if(retType==XPathResult.FIRST_ORDERED_NODE_TYPE){return col.singleNodeValue;}
var thisColMemb=col.iterateNext();while(thisColMemb){rowsCol[rowsCol.length]=thisColMemb;thisColMemb=col.iterateNext();}
return rowsCol;}}
function _dhtmlxError(type,name,params){if(!this.catches)
this.catches=new Array();return this;}
_dhtmlxError.prototype.catchError=function(type,func_name){this.catches[type]=func_name;}
_dhtmlxError.prototype.throwError=function(type,name,params){if(this.catches[type])
return this.catches[type](type,name,params);if(this.catches["ALL"])
return this.catches["ALL"](type,name,params);alert("Error type: "+arguments[0]+"\nDescription: "+arguments[1]);return null;}
window.dhtmlxError=new _dhtmlxError();dtmlXMLLoaderObject.prototype.doXPathOpera=function(xpathExp,docObj){var z=xpathExp.replace(/[\/]+/gi,"/").split('/');var obj=null;var i=1;if(!z.length)
return[];if(z[0]==".")
obj=[docObj];else if(z[0]==""){obj=(this.xmlDoc.responseXML||this.xmlDoc).getElementsByTagName(z[i].replace(/\[[^\]]*\]/g,""));i++;}else
return[];for(i;i<z.length;i++)obj=this._getAllNamedChilds(obj,z[i]);if(z[i-1].indexOf("[")!=-1)
obj=this._filterXPath(obj,z[i-1]);return obj;}
dtmlXMLLoaderObject.prototype._filterXPath=function(a,b){var c=new Array();var b=b.replace(/[^\[]*\[\@/g,"").replace(/[\[\]\@]*/g,"");for(var i=0;i<a.length;i++)
if(a[i].getAttribute(b))
c[c.length]=a[i];return c;}
dtmlXMLLoaderObject.prototype._getAllNamedChilds=function(a,b){var c=new Array();if(_isKHTML)
b=b.toUpperCase();for(var i=0;i<a.length;i++)for(var j=0;j<a[i].childNodes.length;j++){if(_isKHTML){if(a[i].childNodes[j].tagName&&a[i].childNodes[j].tagName.toUpperCase()==b)
c[c.length]=a[i].childNodes[j];}
else if(a[i].childNodes[j].tagName==b)
c[c.length]=a[i].childNodes[j];}
return c;}
function dhtmlXHeir(a,b){for(var c in b)
if(typeof(b[c])=="function")
a[c]=b[c];return a;}
function dhtmlxEvent(el,event,handler){if(el.addEventListener)
el.addEventListener(event,handler,false);else if(el.attachEvent)
el.attachEvent("on"+event,handler);}
dtmlXMLLoaderObject.prototype.xslDoc=null;dtmlXMLLoaderObject.prototype.setXSLParamValue=function(paramName,paramValue,xslDoc){if(!xslDoc)
xslDoc=this.xslDoc
if(xslDoc.responseXML)
xslDoc=xslDoc.responseXML;var item=this.doXPath("/xsl:stylesheet/xsl:variable[@name='"+paramName+"']",xslDoc,"http:/\/www.w3.org/1999/XSL/Transform","single");if(item!=null)
item.firstChild.nodeValue=paramValue}
dtmlXMLLoaderObject.prototype.doXSLTransToObject=function(xslDoc,xmlDoc){if(!xslDoc)
xslDoc=this.xslDoc;if(xslDoc.responseXML)
xslDoc=xslDoc.responseXML
if(!xmlDoc)
xmlDoc=this.xmlDoc;if(xmlDoc.responseXML)
xmlDoc=xmlDoc.responseXML
if(!_isIE){if(!this.XSLProcessor){this.XSLProcessor=new XSLTProcessor();this.XSLProcessor.importStylesheet(xslDoc);}
var result=this.XSLProcessor.transformToDocument(xmlDoc);}else{var result=new ActiveXObject("Msxml2.DOMDocument.3.0");try{xmlDoc.transformNodeToObject(xslDoc,result);}catch(e){result=xmlDoc.transformNode(xslDoc);}}
return result;}
dtmlXMLLoaderObject.prototype.doXSLTransToString=function(xslDoc,xmlDoc){var res=this.doXSLTransToObject(xslDoc,xmlDoc);if(typeof(res)=="string")
return res;return this.doSerialization(res);}
dtmlXMLLoaderObject.prototype.doSerialization=function(xmlDoc){if(!xmlDoc)
xmlDoc=this.xmlDoc;if(xmlDoc.responseXML)
xmlDoc=xmlDoc.responseXML
if(!_isIE){var xmlSerializer=new XMLSerializer();return xmlSerializer.serializeToString(xmlDoc);}else
return xmlDoc.xml;}
dhtmlxEventable=function(obj){obj.attachEvent=function(name,catcher,callObj){name='ev_'+name.toLowerCase();if(!this[name])
this[name]=new this.eventCatcher(callObj||this);return(name+':'+this[name].addEvent(catcher));}
obj.callEvent=function(name,arg0){name='ev_'+name.toLowerCase();if(this[name])
return this[name].apply(this,arg0);return true;}
obj.checkEvent=function(name){return(!!this['ev_'+name.toLowerCase()])}
obj.eventCatcher=function(obj){var dhx_catch=[];var z=function(){var res=true;for(var i=0;i<dhx_catch.length;i++){if(dhx_catch[i]!=null){var zr=dhx_catch[i].apply(obj,arguments);res=res&&zr;}}
return res;}
z.addEvent=function(ev){if(typeof(ev)!="function")
ev=eval(ev);if(ev)
return dhx_catch.push(ev)-1;return false;}
z.removeEvent=function(id){dhx_catch[id]=null;}
return z;}
obj.detachEvent=function(id){if(id!=false){var list=id.split(':');this[list[0]].removeEvent(list[1]);}}
obj.detachAllEvents=function(){for(var name in this){if(name.indexOf("ev_")==0)
delete this[name];}}
obj=null;};if(!window.dhtmlx)
window.dhtmlx={};(function(){var _dhx_msg_cfg=null;function callback(config,result){var usercall=config.callback;modality(false);config.box.parentNode.removeChild(config.box);_dhx_msg_cfg=config.box=null;if(usercall)
usercall(result);}
function modal_key(e){if(_dhx_msg_cfg){e=e||event;var code=e.which||event.keyCode;if(dhtmlx.message.keyboard){if(code==13||code==32)
callback(_dhx_msg_cfg,true);if(code==27)
callback(_dhx_msg_cfg,false);}
if(e.preventDefault)
e.preventDefault();return!(e.cancelBubble=true);}}
if(document.attachEvent)
document.attachEvent("onkeydown",modal_key);else
document.addEventListener("keydown",modal_key,true);function modality(mode){if(!modality.cover){modality.cover=document.createElement("DIV");modality.cover.onkeydown=modal_key;modality.cover.className="dhx_modal_cover";document.body.appendChild(modality.cover);}
var height=document.body.scrollHeight;modality.cover.style.display=mode?"inline-block":"none";}
function button(text,result){var button_css="dhtmlx_"+text.toLowerCase().replace(/ /g,"_")+"_button";return"<div class='dhtmlx_popup_button "+button_css+"' result='"+result+"' ><div>"+text+"</div></div>";}
function info(text){if(!t.area){t.area=document.createElement("DIV");t.area.className="dhtmlx_message_area";t.area.style[t.position]="5px";document.body.appendChild(t.area);}
t.hide(text.id);var message=document.createElement("DIV");message.innerHTML="<div>"+text.text+"</div>";message.className="dhtmlx-info dhtmlx-"+text.type;message.onclick=function(){t.hide(text.id);text=null;};if(t.position=="bottom"&&t.area.firstChild)
t.area.insertBefore(message,t.area.firstChild);else
t.area.appendChild(message);if(text.expire>0)
t.timers[text.id]=window.setTimeout(function(){t.hide(text.id);},text.expire);t.pull[text.id]=message;message=null;return text.id;}
function _boxStructure(config,ok,cancel){var box=document.createElement("DIV");box.className=" dhtmlx_modal_box dhtmlx-"+config.type;box.setAttribute("dhxbox",1);var inner='';if(config.width)
box.style.width=config.width;if(config.height)
box.style.height=config.height;if(config.title)
inner+='<div class="dhtmlx_popup_title">'+config.title+'</div>';inner+='<div class="dhtmlx_popup_text"><span>'+(config.content?'':config.text)+'</span></div><div  class="dhtmlx_popup_controls">';if(ok)
inner+=button(config.ok||"OK",true);if(cancel)
inner+=button(config.cancel||"Cancel",false);if(config.buttons){for(var i=0;i<config.buttons.length;i++)
inner+=button(config.buttons[i],i);}
inner+='</div>';box.innerHTML=inner;if(config.content){var node=config.content;if(typeof node=="string")
node=document.getElementById(node);if(node.style.display=='none')
node.style.display="";box.childNodes[config.title?1:0].appendChild(node);}
box.onclick=function(e){e=e||event;var source=e.target||e.srcElement;if(!source.className)source=source.parentNode;if(source.className.split(" ")[0]=="dhtmlx_popup_button"){result=source.getAttribute("result");result=(result=="true")||(result=="false"?false:result);callback(config,result);}};config.box=box;if(ok||cancel)
_dhx_msg_cfg=config;return box;}
function _createBox(config,ok,cancel){var box=config.tagName?config:_boxStructure(config,ok,cancel);if(!config.hidden)
modality(true);document.body.appendChild(box);var x=Math.abs(Math.floor(((window.innerWidth||document.documentElement.offsetWidth)-box.offsetWidth)/2));var y=Math.abs(Math.floor(((window.innerHeight||document.documentElement.offsetHeight)-box.offsetHeight)/2));if(config.position=="top")
box.style.top="-3px";else
box.style.top=y+'px';box.style.left=x+'px';box.onkeydown=modal_key;box.focus();if(config.hidden)
dhtmlx.modalbox.hide(box);return box;}
function alertPopup(config){return _createBox(config,true,false);}
function confirmPopup(config){return _createBox(config,true,true);}
function boxPopup(config){return _createBox(config);}
function box_params(text,type,callback){if(typeof text!="object"){if(typeof type=="function"){callback=type;type="";}
text={text:text,type:type,callback:callback};}
return text;}
function params(text,type,expire,id){if(typeof text!="object")
text={text:text,type:type,expire:expire,id:id};text.id=text.id||t.uid();text.expire=text.expire||t.expire;return text;}
dhtmlx.alert=function(){text=box_params.apply(this,arguments);text.type=text.type||"confirm";return alertPopup(text);};dhtmlx.confirm=function(){text=box_params.apply(this,arguments);text.type=text.type||"alert";return confirmPopup(text);};dhtmlx.modalbox=function(){text=box_params.apply(this,arguments);text.type=text.type||"alert";return boxPopup(text);};dhtmlx.modalbox.hide=function(node){while(node&&node.getAttribute&&!node.getAttribute("dhxbox"))
node=node.parentNode;if(node){node.parentNode.removeChild(node);modality(false);}};var t=dhtmlx.message=function(text,type,expire,id){text=params.apply(this,arguments);text.type=text.type||"info";var subtype=text.type.split("-")[0];switch(subtype){case"alert":return alertPopup(text);case"confirm":return confirmPopup(text);case"modalbox":return boxPopup(text);default:return info(text);break;}};t.seed=(new Date()).valueOf();t.uid=function(){return t.seed++;};t.expire=4000;t.keyboard=true;t.position="top";t.pull={};t.timers={};t.hideAll=function(){for(var key in t.pull)
t.hide(key);};t.hide=function(id){var obj=t.pull[id];if(obj&&obj.parentNode){window.setTimeout(function(){obj.parentNode.removeChild(obj);obj=null;},2000);obj.className+=" hidden";if(t.timers[id])
window.clearTimeout(t.timers[id]);delete t.pull[id];}};})();function dataProcessor(serverProcessorURL){this.serverProcessor=serverProcessorURL;this.action_param="!nativeeditor_status";this.object=null;this.updatedRows=[];this.autoUpdate=true;this.updateMode="cell";this._tMode="GET";this.post_delim="_";this._waitMode=0;this._in_progress={};this._invalid={};this.mandatoryFields=[];this.messages=[];this.styles={updated:"font-weight:bold;",inserted:"font-weight:bold;",deleted:"text-decoration : line-through;",invalid:"background-color:FFE0E0;",invalid_cell:"border-bottom:2px solid red;",error:"color:red;",clear:"font-weight:normal;text-decoration:none;"};this.enableUTFencoding(true);dhtmlxEventable(this);return this;}
dataProcessor.prototype={setTransactionMode:function(mode,total){this._tMode=mode;this._tSend=total;},escape:function(data){if(this._utf)
return encodeURIComponent(data);else
return escape(data);},enableUTFencoding:function(mode){this._utf=convertStringToBoolean(mode);},setDataColumns:function(val){this._columns=(typeof val=="string")?val.split(","):val;},getSyncState:function(){return!this.updatedRows.length;},enableDataNames:function(mode){this._endnm=convertStringToBoolean(mode);},enablePartialDataSend:function(mode){this._changed=convertStringToBoolean(mode);},setUpdateMode:function(mode,dnd){this.autoUpdate=(mode=="cell");this.updateMode=mode;this.dnd=dnd;},ignore:function(code,master){this._silent_mode=true;code.call(master||window);this._silent_mode=false;},setUpdated:function(rowId,state,mode){if(this._silent_mode)return;var ind=this.findRow(rowId);mode=mode||"updated";var existing=this.obj.getUserData(rowId,this.action_param);if(existing&&mode=="updated")mode=existing;if(state){this.set_invalid(rowId,false);this.updatedRows[ind]=rowId;this.obj.setUserData(rowId,this.action_param,mode);if(this._in_progress[rowId])
this._in_progress[rowId]="wait";}else{if(!this.is_invalid(rowId)){this.updatedRows.splice(ind,1);this.obj.setUserData(rowId,this.action_param,"");}}
if(!state)
this._clearUpdateFlag(rowId);this.markRow(rowId,state,mode);if(state&&this.autoUpdate)this.sendData(rowId);},_clearUpdateFlag:function(id){},markRow:function(id,state,mode){var str="";var invalid=this.is_invalid(id);if(invalid){str=this.styles[invalid];state=true;}
if(this.callEvent("onRowMark",[id,state,mode,invalid])){str=this.styles[state?mode:"clear"]+str;this.obj[this._methods[0]](id,str);if(invalid&&invalid.details){str+=this.styles[invalid+"_cell"];for(var i=0;i<invalid.details.length;i++)
if(invalid.details[i])
this.obj[this._methods[1]](id,i,str);}}},getState:function(id){return this.obj.getUserData(id,this.action_param);},is_invalid:function(id){return this._invalid[id];},set_invalid:function(id,mode,details){if(details)mode={value:mode,details:details,toString:function(){return this.value.toString();}};this._invalid[id]=mode;},checkBeforeUpdate:function(rowId){return true;},sendData:function(rowId){if(this._waitMode&&(this.obj.mytype=="tree"||this.obj._h2))return;if(this.obj.editStop)this.obj.editStop();if(typeof rowId=="undefined"||this._tSend)return this.sendAllData();if(this._in_progress[rowId])return false;this.messages=[];if(!this.checkBeforeUpdate(rowId)&&this.callEvent("onValidatationError",[rowId,this.messages]))return false;this._beforeSendData(this._getRowData(rowId),rowId);},_beforeSendData:function(data,rowId){if(!this.callEvent("onBeforeUpdate",[rowId,this.getState(rowId),data]))return false;this._sendData(data,rowId);},serialize:function(data,id){if(typeof data=="string")
return data;if(typeof id!="undefined")
return this.serialize_one(data,"");else{var stack=[];var keys=[];for(var key in data)
if(data.hasOwnProperty(key)){stack.push(this.serialize_one(data[key],key+this.post_delim));keys.push(key);}
stack.push("ids="+this.escape(keys.join(",")));if(dhtmlx.security_key)
stack.push("dhx_security="+dhtmlx.security_key);return stack.join("&");}},serialize_one:function(data,pref){if(typeof data=="string")
return data;var stack=[];for(var key in data)
if(data.hasOwnProperty(key))
stack.push(this.escape((pref||"")+key)+"="+this.escape(data[key]));return stack.join("&");},_sendData:function(a1,rowId){if(!a1)return;if(!this.callEvent("onBeforeDataSending",rowId?[rowId,this.getState(rowId),a1]:[null,null,a1]))return false;if(rowId)
this._in_progress[rowId]=(new Date()).valueOf();var a2=new dtmlXMLLoaderObject(this.afterUpdate,this,true);var a3=this.serverProcessor+(this._user?(getUrlSymbol(this.serverProcessor)+["dhx_user="+this._user,"dhx_version="+this.obj.getUserData(0,"version")].join("&")):"");if(this._tMode!="POST")
a2.loadXML(a3+((a3.indexOf("?")!=-1)?"&":"?")+this.serialize(a1,rowId));else
a2.loadXML(a3,true,this.serialize(a1,rowId));this._waitMode++;},sendAllData:function(){if(!this.updatedRows.length)return;this.messages=[];var valid=true;for(var i=0;i<this.updatedRows.length;i++)
valid&=this.checkBeforeUpdate(this.updatedRows[i]);if(!valid&&!this.callEvent("onValidatationError",["",this.messages]))return false;if(this._tSend)
this._sendData(this._getAllData());else
for(var i=0;i<this.updatedRows.length;i++)
if(!this._in_progress[this.updatedRows[i]]){if(this.is_invalid(this.updatedRows[i]))continue;this._beforeSendData(this._getRowData(this.updatedRows[i]),this.updatedRows[i]);if(this._waitMode&&(this.obj.mytype=="tree"||this.obj._h2))return;}},_getAllData:function(rowId){var out={};var has_one=false;for(var i=0;i<this.updatedRows.length;i++){var id=this.updatedRows[i];if(this._in_progress[id]||this.is_invalid(id))continue;if(!this.callEvent("onBeforeUpdate",[id,this.getState(id)]))continue;out[id]=this._getRowData(id,id+this.post_delim);has_one=true;this._in_progress[id]=(new Date()).valueOf();}
return has_one?out:null;},setVerificator:function(ind,verifFunction){this.mandatoryFields[ind]=verifFunction||(function(value){return(value!="");});},clearVerificator:function(ind){this.mandatoryFields[ind]=false;},findRow:function(pattern){var i=0;for(i=0;i<this.updatedRows.length;i++)
if(pattern==this.updatedRows[i])break;return i;},defineAction:function(name,handler){if(!this._uActions)this._uActions=[];this._uActions[name]=handler;},afterUpdateCallback:function(sid,tid,action,btag){var marker=sid;var correct=(action!="error"&&action!="invalid");if(!correct)this.set_invalid(sid,action);if((this._uActions)&&(this._uActions[action])&&(!this._uActions[action](btag)))
return(delete this._in_progress[marker]);if(this._in_progress[marker]!="wait")
this.setUpdated(sid,false);var soid=sid;switch(action){case"update":case"updated":case"inserted":case"insert":if(tid!=sid){this.obj[this._methods[2]](sid,tid);sid=tid;}
break;case"delete":case"deleted":this.obj.setUserData(sid,this.action_param,"true_deleted");this.obj[this._methods[3]](sid);delete this._in_progress[marker];return this.callEvent("onAfterUpdate",[sid,action,tid,btag]);break;}
if(this._in_progress[marker]!="wait"){if(correct)this.obj.setUserData(sid,this.action_param,'');delete this._in_progress[marker];}else{delete this._in_progress[marker];this.setUpdated(tid,true,this.obj.getUserData(sid,this.action_param));}
this.callEvent("onAfterUpdate",[sid,action,tid,btag]);},afterUpdate:function(that,b,c,d,xml){xml.getXMLTopNode("data");if(!xml.xmlDoc.responseXML)return;var atag=xml.doXPath("//data/action");for(var i=0;i<atag.length;i++){var btag=atag[i];var action=btag.getAttribute("type");var sid=btag.getAttribute("sid");var tid=btag.getAttribute("tid");that.afterUpdateCallback(sid,tid,action,btag);}
that.finalizeUpdate();},finalizeUpdate:function(){if(this._waitMode)this._waitMode--;if((this.obj.mytype=="tree"||this.obj._h2)&&this.updatedRows.length)
this.sendData();this.callEvent("onAfterUpdateFinish",[]);if(!this.updatedRows.length)
this.callEvent("onFullSync",[]);},init:function(anObj){this.obj=anObj;if(this.obj._dp_init)
this.obj._dp_init(this);},setOnAfterUpdate:function(ev){this.attachEvent("onAfterUpdate",ev);},enableDebug:function(mode){},setOnBeforeUpdateHandler:function(func){this.attachEvent("onBeforeDataSending",func);},setAutoUpdate:function(interval,user){interval=interval||2000;this._user=user||(new Date()).valueOf();this._need_update=false;this._loader=null;this._update_busy=false;this.attachEvent("onAfterUpdate",function(sid,action,tid,xml_node){this.afterAutoUpdate(sid,action,tid,xml_node);});this.attachEvent("onFullSync",function(){this.fullSync();});var self=this;window.setInterval(function(){self.loadUpdate();},interval);},afterAutoUpdate:function(sid,action,tid,xml_node){if(action=='collision'){this._need_update=true;return false;}else{return true;}},fullSync:function(){if(this._need_update==true){this._need_update=false;this.loadUpdate();}
return true;},getUpdates:function(url,callback){if(this._update_busy)
return false;else
this._update_busy=true;this._loader=this._loader||new dtmlXMLLoaderObject(true);this._loader.async=true;this._loader.waitCall=callback;this._loader.loadXML(url);},_v:function(node){if(node.firstChild)return node.firstChild.nodeValue;return"";},_a:function(arr){var res=[];for(var i=0;i<arr.length;i++){res[i]=this._v(arr[i]);};return res;},loadUpdate:function(){var self=this;var version=this.obj.getUserData(0,"version");var url=this.serverProcessor+getUrlSymbol(this.serverProcessor)+["dhx_user="+this._user,"dhx_version="+version].join("&");url=url.replace("editing=true&","");this.getUpdates(url,function(){var vers=self._loader.doXPath("//userdata");self.obj.setUserData(0,"version",self._v(vers[0]));var upds=self._loader.doXPath("//update");if(upds.length){self._silent_mode=true;for(var i=0;i<upds.length;i++){var status=upds[i].getAttribute('status');var id=upds[i].getAttribute('id');var parent=upds[i].getAttribute('parent');switch(status){case'inserted':self.callEvent("insertCallback",[upds[i],id,parent]);break;case'updated':self.callEvent("updateCallback",[upds[i],id,parent]);break;case'deleted':self.callEvent("deleteCallback",[upds[i],id,parent]);break;}}
self._silent_mode=false;}
self._update_busy=false;self=null;});}};if(window.dhtmlXGridObject){dhtmlXGridObject.prototype._init_point_connector=dhtmlXGridObject.prototype._init_point;dhtmlXGridObject.prototype._init_point=function(){var clear_url=function(url){url=url.replace(/(\?|\&)connector[^\f]*/g,"");return url+(url.indexOf("?")!=-1?"&":"?")+"connector=true"+(this.hdr.rows.length>0?"&dhx_no_header=1":"");};var combine_urls=function(url){return clear_url.call(this,url)+(this._connector_sorting||"")+(this._connector_filter||"");};var sorting_url=function(url,ind,dir){this._connector_sorting="&dhx_sort["+ind+"]="+dir;return combine_urls.call(this,url);};var filtering_url=function(url,inds,vals){for(var i=0;i<inds.length;i++)
inds[i]="dhx_filter["+inds[i]+"]="+encodeURIComponent(vals[i]);this._connector_filter="&"+inds.join("&");return combine_urls.call(this,url);};this.attachEvent("onCollectValues",function(ind){if(this._con_f_used[ind]){if(typeof(this._con_f_used[ind])=="object")
return this._con_f_used[ind];else
return false;}
return true;});this.attachEvent("onDynXLS",function(){this.xmlFileUrl=combine_urls.call(this,this.xmlFileUrl);return true;});this.attachEvent("onBeforeSorting",function(ind,type,dir){if(type=="connector"){var self=this;this.clearAndLoad(sorting_url.call(this,this.xmlFileUrl,ind,dir),function(){self.setSortImgState(true,ind,dir);});return false;}
return true;});this.attachEvent("onFilterStart",function(a,b){if(this._con_f_used.length){this.clearAndLoad(filtering_url.call(this,this.xmlFileUrl,a,b));return false;}
return true;});this.attachEvent("onXLE",function(a,b,c,xml){if(!xml)return;});if(this._init_point_connector)this._init_point_connector();};dhtmlXGridObject.prototype._con_f_used=[];dhtmlXGridObject.prototype._in_header_connector_text_filter=function(t,i){if(!this._con_f_used[i])
this._con_f_used[i]=1;return this._in_header_text_filter(t,i);};dhtmlXGridObject.prototype._in_header_connector_select_filter=function(t,i){if(!this._con_f_used[i])
this._con_f_used[i]=2;return this._in_header_select_filter(t,i);};dhtmlXGridObject.prototype.load_connector=dhtmlXGridObject.prototype.load;dhtmlXGridObject.prototype.load=function(url,call,type){if(!this._colls_loaded&&this.cellType){var ar=[];for(var i=0;i<this.cellType.length;i++)
if(this.cellType[i].indexOf("co")==0||this._con_f_used[i]==2)ar.push(i);if(ar.length)
arguments[0]+=(arguments[0].indexOf("?")!=-1?"&":"?")+"connector=true&dhx_colls="+ar.join(",");}
return this.load_connector.apply(this,arguments);};dhtmlXGridObject.prototype._parseHead_connector=dhtmlXGridObject.prototype._parseHead;dhtmlXGridObject.prototype._parseHead=function(url,call,type){this._parseHead_connector.apply(this,arguments);if(!this._colls_loaded){var cols=this.xmlLoader.doXPath("./coll_options",arguments[0]);for(var i=0;i<cols.length;i++){var f=cols[i].getAttribute("for");var v=[];var combo=null;if(this.cellType[f]=="combo")
combo=this.getColumnCombo(f);if(this.cellType[f].indexOf("co")==0)
combo=this.getCombo(f);var os=this.xmlLoader.doXPath("./item",cols[i]);for(var j=0;j<os.length;j++){var val=os[j].getAttribute("value");if(combo){var lab=os[j].getAttribute("label")||val;if(combo.addOption)
combo.addOption([[val,lab]]);else
combo.put(val,lab);v[v.length]=lab;}else
v[v.length]=val;}
if(this._con_f_used[f*1])
this._con_f_used[f*1]=v;}
this._colls_loaded=true;}};}
if(window.dataProcessor){dataProcessor.prototype.init_original=dataProcessor.prototype.init;dataProcessor.prototype.init=function(obj){this.init_original(obj);obj._dataprocessor=this;this.setTransactionMode("POST",true);this.serverProcessor+=(this.serverProcessor.indexOf("?")!=-1?"&":"?")+"editing=true";};}
dhtmlxError.catchError("LoadXML",function(a,b,c){if(c[0].status!=0){alert(c[0].responseText);}});window.dhtmlXScheduler=window.scheduler={version:"3.5.0"};dhtmlxEventable(scheduler);scheduler.init=function(id,date,mode){date=date||(new Date());mode=mode||"week";scheduler.date.init();this._obj=(typeof id=="string")?document.getElementById(id):id;this._els=[];this._scroll=true;this._quirks=(_isIE&&document.compatMode=="BackCompat");this._quirks7=(_isIE&&navigator.appVersion.indexOf("MSIE 8")==-1);this.get_elements();this.init_templates();this.set_actions();dhtmlxEvent(window,"resize",function(){window.clearTimeout(scheduler._resize_timer);scheduler._resize_timer=window.setTimeout(function(){if(scheduler.callEvent("onSchedulerResize",[])){scheduler.update_view();scheduler.callEvent("onAfterSchedulerResize",[]);}},100);});this.set_sizes();scheduler.callEvent('onSchedulerReady',[]);this.setCurrentView(date,mode);};scheduler.xy={nav_height:22,min_event_height:40,scale_width:50,bar_height:20,scroll_width:18,scale_height:20,month_scale_height:20,menu_width:25,margin_top:0,margin_left:0,editor_width:140,lightbox_additional_height:50};scheduler.keys={edit_save:13,edit_cancel:27};scheduler.set_sizes=function(){var w=this._x=this._obj.clientWidth-this.xy.margin_left;var h=this._y=this._obj.clientHeight-this.xy.margin_top;var scale_x=this._table_view?0:(this.xy.scale_width+this.xy.scroll_width);var scale_s=this._table_view?-1:this.xy.scale_width;this.set_xy(this._els["dhx_cal_navline"][0],w,this.xy.nav_height,0,0);this.set_xy(this._els["dhx_cal_header"][0],w-scale_x,this.xy.scale_height,scale_s,this.xy.nav_height+(this._quirks?-1:1));var actual_height=this._els["dhx_cal_navline"][0].offsetHeight;if(actual_height>0)this.xy.nav_height=actual_height;var data_y=this.xy.scale_height+this.xy.nav_height+(this._quirks?-2:0);this.set_xy(this._els["dhx_cal_data"][0],w,h-(data_y+2),0,data_y+2);};scheduler.set_xy=function(node,w,h,x,y){node.style.width=Math.max(0,w)+"px";node.style.height=Math.max(0,h)+"px";if(arguments.length>3){node.style.left=x+"px";node.style.top=y+"px";}};scheduler.get_elements=function(){var els=this._obj.getElementsByTagName("DIV");for(var i=0;i<els.length;i++){var name=els[i].className;if(name)name=name.split(" ")[0];if(!this._els[name])this._els[name]=[];this._els[name].push(els[i]);var t=scheduler.locale.labels[els[i].getAttribute("name")||name];if(t)els[i].innerHTML=t;}};scheduler.set_actions=function(){for(var a in this._els)
if(this._click[a])
for(var i=0;i<this._els[a].length;i++)
this._els[a][i].onclick=scheduler._click[a];this._obj.onselectstart=function(e){return false;};this._obj.onmousemove=function(e){scheduler._on_mouse_move(e||event);};this._obj.onmousedown=function(e){scheduler._on_mouse_down(e||event);};this._obj.onmouseup=function(e){scheduler._on_mouse_up(e||event);};this._obj.ondblclick=function(e){scheduler._on_dbl_click(e||event);};this._obj.oncontextmenu=function(e){var ev=e||event;var src=ev.target||ev.srcElement;var returnValue=scheduler.callEvent("onContextMenu",[scheduler._locate_event(src),ev]);return returnValue;};};scheduler.select=function(id){if(this._select_id==id)return;this.editStop(false);this.unselect();this._select_id=id;this.updateEvent(id);};scheduler.unselect=function(id){if(id&&id!=this._select_id)return;var t=this._select_id;this._select_id=null;if(t)this.updateEvent(t);};scheduler.getState=function(){return{mode:this._mode,date:this._date,min_date:this._min_date,max_date:this._max_date,editor_id:this._edit_id,lightbox_id:this._lightbox_id,new_event:this._new_event,select_id:this._select_id,expanded:this.expanded,drag_id:this._drag_id,drag_mode:this._drag_mode};};scheduler._click={dhx_cal_data:function(e){var trg=e?e.target:event.srcElement;var id=scheduler._locate_event(trg);e=e||event;if(!id){scheduler.callEvent("onEmptyClick",[scheduler.getActionData(e).date,e]);}else{if(!scheduler.callEvent("onClick",[id,e])||scheduler.config.readonly)return;}
if(id&&scheduler.config.select){scheduler.select(id);var mask=trg.className;if(mask.indexOf("_icon")!=-1)
scheduler._click.buttons[mask.split(" ")[1].replace("icon_","")](id);}else
scheduler._close_not_saved();},dhx_cal_prev_button:function(){scheduler._click.dhx_cal_next_button(0,-1);},dhx_cal_next_button:function(dummy,step){scheduler.setCurrentView(scheduler.date.add(scheduler.date[scheduler._mode+"_start"](scheduler._date),(step||1),scheduler._mode));},dhx_cal_today_button:function(){scheduler.setCurrentView(new Date());},dhx_cal_tab:function(){var name=this.getAttribute("name");var mode=name.substring(0,name.search("_tab"));scheduler.setCurrentView(scheduler._date,mode);},buttons:{"delete":function(id){var c=scheduler.locale.labels.confirm_deleting;scheduler._dhtmlx_confirm(c,scheduler.locale.labels.title_confirm_deleting,function(){scheduler.deleteEvent(id)});},edit:function(id){scheduler.edit(id);},save:function(id){scheduler.editStop(true);},details:function(id){scheduler.showLightbox(id);},cancel:function(id){scheduler.editStop(false);}}};scheduler._dhtmlx_confirm=function(message,title,callback){if(!message)
return callback();var opts={text:message};if(title)
opts.title=title;if(callback){opts.callback=function(result){if(result)
callback();};}
dhtmlx.confirm(opts);};scheduler.addEventNow=function(start,end,e){var base={};if(start&&start.constructor.toString().match(/object/i)!==null){base=start;start=null;}
var d=(this.config.event_duration||this.config.time_step)*60000;if(!start)start=Math.round((new Date()).valueOf()/d)*d;var start_date=new Date(start);if(!end){var start_hour=this.config.first_hour;if(start_hour>start_date.getHours()){start_date.setHours(start_hour);start=start_date.valueOf();}
end=start.valueOf()+d;}
var end_date=new Date(end);if(start_date.valueOf()==end_date.valueOf())
end_date.setTime(end_date.valueOf()+d);base.start_date=base.start_date||start_date;base.end_date=base.end_date||end_date;base.text=base.text||this.locale.labels.new_event;base.id=this._drag_id=this.uid();this._drag_mode="new-size";this._loading=true;this.addEvent(base);this.callEvent("onEventCreated",[this._drag_id,e]);this._loading=false;this._drag_event={};this._on_mouse_up(e);};scheduler._on_dbl_click=function(e,src){src=src||(e.target||e.srcElement);if(this.config.readonly)return;var name=src.className.split(" ")[0];switch(name){case"dhx_scale_holder":case"dhx_scale_holder_now":case"dhx_month_body":case"dhx_wa_day_data":case"dhx_marked_timespan":if(!scheduler.config.dblclick_create)break;this.addEventNow(this.getActionData(e).date,null,e);break;case"dhx_cal_event":case"dhx_wa_ev_body":case"dhx_agenda_line":case"dhx_grid_event":case"dhx_cal_event_line":case"dhx_cal_event_clear":var id=this._locate_event(src);if(!this.callEvent("onDblClick",[id,e]))return;if(this.config.details_on_dblclick||this._table_view||!this.getEvent(id)._timed||!this.config.select)
this.showLightbox(id);else
this.edit(id);break;case"dhx_time_block":case"dhx_cal_container":return;break;default:var t=this["dblclick_"+name];if(t){t.call(this,e);}
else{if(src.parentNode&&src!=this)
return scheduler._on_dbl_click(e,src.parentNode);}
break;}};scheduler._mouse_coords=function(ev){var pos;var b=document.body;var d=document.documentElement;if(ev.pageX||ev.pageY)
pos={x:ev.pageX,y:ev.pageY};else pos={x:ev.clientX+(b.scrollLeft||d.scrollLeft||0)-b.clientLeft,y:ev.clientY+(b.scrollTop||d.scrollTop||0)-b.clientTop};pos.x-=getAbsoluteLeft(this._obj)+(this._table_view?0:this.xy.scale_width);pos.y-=getAbsoluteTop(this._obj)+this.xy.nav_height+(this._dy_shift||0)+this.xy.scale_height-this._els["dhx_cal_data"][0].scrollTop;pos.ev=ev;var handler=this["mouse_"+this._mode];if(handler)
return handler.call(this,pos);if(!this._table_view){pos.x=Math.min(this._cols.length-1,Math.max(0,Math.ceil(pos.x/this._cols[0])-1));pos.y=Math.max(0,Math.ceil(pos.y*60/(this.config.time_step*this.config.hour_size_px))-1)+this.config.first_hour*(60/this.config.time_step);}else{if(!this._cols||!this._colsS)
return pos;var dy=0;for(dy=1;dy<this._colsS.heights.length;dy++)
if(this._colsS.heights[dy]>pos.y)break;pos.y=Math.ceil((Math.max(0,pos.x/this._cols[0])+Math.max(0,dy-1)*7)*24*60/this.config.time_step);if(scheduler._drag_mode||this._mode=="month")
pos.y=(Math.max(0,Math.ceil(pos.x/this._cols[0])-1)+Math.max(0,dy-1)*7)*24*60/this.config.time_step;pos.x=0;}
return pos;};scheduler._close_not_saved=function(){if(new Date().valueOf()-(scheduler._new_event||0)>500&&scheduler._edit_id){var c=scheduler.locale.labels.confirm_closing;scheduler._dhtmlx_confirm(c,scheduler.locale.labels.title_confirm_closing,function(){scheduler.editStop(scheduler.config.positive_closing);});}};scheduler._correct_shift=function(start,back){return start-=((new Date(scheduler._min_date)).getTimezoneOffset()-(new Date(start)).getTimezoneOffset())*60000*(back?-1:1);};scheduler._on_mouse_move=function(e){if(this._drag_mode){var pos=this._mouse_coords(e);if(!this._drag_pos||pos.custom||this._drag_pos.x!=pos.x||this._drag_pos.y!=pos.y){var start,end;if(this._edit_id!=this._drag_id)
this._close_not_saved();this._drag_pos=pos;if(this._drag_mode=="create"){this._close_not_saved();this._loading=true;start=this._get_date_from_pos(pos).valueOf();var res=this.callEvent("onBeforeEventCreated",[e]);if(!res)
return;if(!this._drag_start){this._drag_start=start;return;}
end=start;if(end==this._drag_start)return;this._drag_id=this.uid();this.addEvent(new Date(this._drag_start),new Date(end),this.locale.labels.new_event,this._drag_id,pos.fields);this.callEvent("onEventCreated",[this._drag_id,e]);this._loading=false;this._drag_mode="new-size";}
var ev=this.getEvent(this._drag_id);if(this._drag_mode=="move"){start=this._min_date.valueOf()+(pos.y*this.config.time_step+pos.x*24*60)*60000;if(!pos.custom&&this._table_view)start+=this.date.time_part(ev.start_date)*1000;start=this._correct_shift(start);end=ev.end_date.valueOf()-(ev.start_date.valueOf()-start);}else{start=ev.start_date.valueOf();end=ev.end_date.valueOf();if(this._table_view){var resize_date=this._min_date.valueOf()+pos.y*this.config.time_step*60000+(pos.custom?0:24*60*60000);if(this._mode=="month")
resize_date=this._correct_shift(resize_date,false);if(pos.resize_from_start)
start=resize_date;else
end=resize_date;}else{end=this.date.date_part(new Date(ev.end_date)).valueOf()+pos.y*this.config.time_step*60000;this._els["dhx_cal_data"][0].style.cursor="s-resize";if(this._mode=="week"||this._mode=="day")
end=this._correct_shift(end);}
if(this._drag_mode=="new-size"){if(end<=this._drag_start){var shift=pos.shift||((this._table_view&&!pos.custom)?24*60*60000:0);start=end-(pos.shift?0:shift);end=this._drag_start+(shift||(this.config.time_step*60000));}else{start=this._drag_start;}}else{if(end<=start)
end=start+this.config.time_step*60000;}}
var new_end=new Date(end-1);var new_start=new Date(start);if(this._table_view||(new_end.getDate()==new_start.getDate()&&new_end.getHours()<this.config.last_hour)||scheduler._allow_dnd){ev.start_date=new_start;ev.end_date=new Date(end);if(this.config.update_render){var sx=scheduler._els["dhx_cal_data"][0].scrollTop;this.update_view();scheduler._els["dhx_cal_data"][0].scrollTop=sx;}else
this.updateEvent(this._drag_id);}
if(this._table_view){this.for_rendered(this._drag_id,function(r){r.className+=" dhx_in_move";});}}}else{if(scheduler.checkEvent("onMouseMove")){var id=this._locate_event(e.target||e.srcElement);this.callEvent("onMouseMove",[id,e]);}}};scheduler._on_mouse_down=function(e,src){if(this.config.readonly||this._drag_mode)return;src=src||(e.target||e.srcElement);var classname=src.className&&src.className.split(" ")[0];switch(classname){case"dhx_cal_event_line":case"dhx_cal_event_clear":if(this._table_view)
this._drag_mode="move";break;case"dhx_event_move":case"dhx_wa_ev_body":this._drag_mode="move";break;case"dhx_event_resize":this._drag_mode="resize";break;case"dhx_scale_holder":case"dhx_scale_holder_now":case"dhx_month_body":case"dhx_matrix_cell":case"dhx_marked_timespan":this._drag_mode="create";this.unselect(this._select_id);break;case"":if(src.parentNode)
return scheduler._on_mouse_down(e,src.parentNode);default:if(scheduler.checkEvent("onMouseDown")&&scheduler.callEvent("onMouseDown",[classname])){if(src.parentNode&&src!=this){return scheduler._on_mouse_down(e,src.parentNode);}}
this._drag_mode=null;this._drag_id=null;break;}
if(this._drag_mode){var id=this._locate_event(src);if(!this.config["drag_"+this._drag_mode]||!this.callEvent("onBeforeDrag",[id,this._drag_mode,e]))
this._drag_mode=this._drag_id=0;else{this._drag_id=id;this._drag_event=scheduler._lame_clone(this.getEvent(this._drag_id)||{});}}
this._drag_start=null;};scheduler._on_mouse_up=function(e){if(this._drag_mode&&this._drag_id){this._els["dhx_cal_data"][0].style.cursor="default";var ev=this.getEvent(this._drag_id);if(this._drag_event._dhx_changed||!this._drag_event.start_date||ev.start_date.valueOf()!=this._drag_event.start_date.valueOf()||ev.end_date.valueOf()!=this._drag_event.end_date.valueOf()){var is_new=(this._drag_mode=="new-size");if(!this.callEvent("onBeforeEventChanged",[ev,e,is_new,this._drag_event])){if(is_new)
this.deleteEvent(ev.id,true);else{this._drag_event._dhx_changed=false;scheduler._lame_copy(ev,this._drag_event);this.updateEvent(ev.id);}}else{var drag_id=this._drag_id;this._drag_id=this._drag_mode=null;if(is_new&&this.config.edit_on_create){this.unselect();this._new_event=new Date();if(this._table_view||this.config.details_on_create||!this.config.select){return this.showLightbox(drag_id);}
this._drag_pos=true;this._select_id=this._edit_id=drag_id;}else{if(!this._new_event)
this.callEvent(is_new?"onEventAdded":"onEventChanged",[drag_id,this.getEvent(drag_id)]);}}}
if(this._drag_pos)this.render_view_data();}
this._drag_id=null;this._drag_mode=null;this._drag_pos=null;};scheduler.update_view=function(){this._reset_scale();if(this._load_mode&&this._load())return this._render_wait=true;this.render_view_data();};scheduler.updateView=function(date,mode){date=date||this._date;mode=mode||this._mode;var dhx_cal_data='dhx_cal_data';if(!this._mode)
this._obj.className+=" dhx_scheduler_"+mode;else{this._obj.className=this._obj.className.replace("dhx_scheduler_"+this._mode,"dhx_scheduler_"+mode);}
var prev_scroll=(this._mode==mode&&this.config.preserve_scroll)?this._els[dhx_cal_data][0].scrollTop:false;if(this[this._mode+"_view"]&&mode&&this._mode!=mode)
this[this._mode+"_view"](false);this._close_not_saved();var dhx_multi_day='dhx_multi_day';if(this._els[dhx_multi_day]){this._els[dhx_multi_day][0].parentNode.removeChild(this._els[dhx_multi_day][0]);this._els[dhx_multi_day]=null;}
this._mode=mode;this._date=date;this._table_view=(this._mode=="month");var tabs=this._els["dhx_cal_tab"];for(var i=0;i<tabs.length;i++){var name=tabs[i].className;name=name.replace(/ active/g,"");if(tabs[i].getAttribute("name")==this._mode+"_tab")
name=name+" active";tabs[i].className=name;}
var view=this[this._mode+"_view"];view?view(true):this.update_view();if(typeof prev_scroll=="number")
this._els[dhx_cal_data][0].scrollTop=prev_scroll;};scheduler.setCurrentView=function(date,mode){if(!this.callEvent("onBeforeViewChange",[this._mode,this._date,mode,date]))return;this.updateView(date,mode);this.callEvent("onViewChange",[this._mode,this._date]);};scheduler._render_x_header=function(i,left,d,h){var head=document.createElement("DIV");head.className="dhx_scale_bar";this.set_xy(head,this._cols[i]-1,this.xy.scale_height-2,left,0);head.innerHTML=this.templates[this._mode+"_scale_date"](d,this._mode);h.appendChild(head);};scheduler._reset_scale=function(){if(!this.templates[this._mode+"_date"])return;var h=this._els["dhx_cal_header"][0];var b=this._els["dhx_cal_data"][0];var c=this.config;h.innerHTML="";b.scrollTop=0;b.innerHTML="";var str=((c.readonly||(!c.drag_resize))?" dhx_resize_denied":"")+((c.readonly||(!c.drag_move))?" dhx_move_denied":"");if(str)b.className="dhx_cal_data"+str;this._scales={};this._cols=[];this._colsS={height:0};this._dy_shift=0;this.set_sizes();var summ=parseInt(h.style.width,10);var left=0;var d,dd,sd,today;dd=this.date[this._mode+"_start"](new Date(this._date.valueOf()));d=sd=this._table_view?scheduler.date.week_start(dd):dd;today=this.date.date_part(new Date());var ed=scheduler.date.add(dd,1,this._mode);var count=7;if(!this._table_view){var count_n=this.date["get_"+this._mode+"_end"];if(count_n)ed=count_n(dd);count=Math.round((ed.valueOf()-dd.valueOf())/(1000*60*60*24));}
this._min_date=d;this._els["dhx_cal_date"][0].innerHTML=this.templates[this._mode+"_date"](dd,ed,this._mode);for(var i=0;i<count;i++){this._cols[i]=Math.floor(summ/(count-i));this._render_x_header(i,left,d,h);if(!this._table_view){var scales=document.createElement("DIV");var cls="dhx_scale_holder";if(d.valueOf()==today.valueOf())cls="dhx_scale_holder_now";scales.className=cls+" "+this.templates.week_date_class(d,today);this.set_xy(scales,this._cols[i]-1,c.hour_size_px*(c.last_hour-c.first_hour),left+this.xy.scale_width+1,0);b.appendChild(scales);this.callEvent("onScaleAdd",[scales,d]);}
d=this.date.add(d,1,"day");summ-=this._cols[i];left+=this._cols[i];this._colsS[i]=(this._cols[i-1]||0)+(this._colsS[i-1]||(this._table_view?0:this.xy.scale_width+2));this._colsS['col_length']=count+1;}
this._max_date=d;this._colsS[count]=this._cols[count-1]+this._colsS[count-1];if(this._table_view)
this._reset_month_scale(b,dd,sd);else{this._reset_hours_scale(b,dd,sd);if(c.multi_day){var dhx_multi_day='dhx_multi_day';if(this._els[dhx_multi_day]){this._els[dhx_multi_day][0].parentNode.removeChild(this._els[dhx_multi_day][0]);this._els[dhx_multi_day]=null;}
var navline=this._els["dhx_cal_navline"][0];var top=navline.offsetHeight+this._els["dhx_cal_header"][0].offsetHeight+1;var c1=document.createElement("DIV");c1.className=dhx_multi_day;c1.style.visibility="hidden";this.set_xy(c1,this._colsS[this._colsS.col_length-1]+this.xy.scroll_width,0,0,top);b.parentNode.insertBefore(c1,b);var c2=c1.cloneNode(true);c2.className=dhx_multi_day+"_icon";c2.style.visibility="hidden";this.set_xy(c2,this.xy.scale_width,0,0,top);c1.appendChild(c2);this._els[dhx_multi_day]=[c1,c2];this._els[dhx_multi_day][0].onclick=this._click.dhx_cal_data;}}};scheduler._reset_hours_scale=function(b,dd,sd){var c=document.createElement("DIV");c.className="dhx_scale_holder";var date=new Date(1980,1,1,this.config.first_hour,0,0);for(var i=this.config.first_hour*1;i<this.config.last_hour;i++){var cc=document.createElement("DIV");cc.className="dhx_scale_hour";cc.style.height=this.config.hour_size_px-(this._quirks?0:1)+"px";cc.style.width=this.xy.scale_width+"px";cc.innerHTML=scheduler.templates.hour_scale(date);c.appendChild(cc);date=this.date.add(date,1,"hour");}
b.appendChild(c);if(this.config.scroll_hour)
b.scrollTop=this.config.hour_size_px*(this.config.scroll_hour-this.config.first_hour);};scheduler._reset_month_scale=function(b,dd,sd){var ed=scheduler.date.add(dd,1,"month");var cd=new Date();this.date.date_part(cd);this.date.date_part(sd);var rows=Math.ceil(Math.round((ed.valueOf()-sd.valueOf())/(60*60*24*1000))/7);var tdcss=[];var height=(Math.floor(b.clientHeight/rows)-22);this._colsS.height=height+22;var h=this._colsS.heights=[];for(var i=0;i<=7;i++)
tdcss[i]=" style='height:"+height+"px; width:"+((this._cols[i]||0)-1)+"px;' ";var cellheight=0;this._min_date=sd;var html="<table cellpadding='0' cellspacing='0'>";var rendered_dates=[];for(var i=0;i<rows;i++){html+="<tr>";for(var j=0;j<7;j++){html+="<td";var cls="";if(sd<dd)
cls='dhx_before';else if(sd>=ed)
cls='dhx_after';else if(sd.valueOf()==cd.valueOf())
cls='dhx_now';html+=" class='"+cls+" "+this.templates.month_date_class(sd,cd)+"' ";html+="><div class='dhx_month_head'>"+this.templates.month_day(sd)+"</div><div class='dhx_month_body' "+tdcss[j]+"></div></td>";rendered_dates.push(sd);sd=this.date.add(sd,1,"day");}
html+="</tr>";h[i]=cellheight;cellheight+=this._colsS.height;}
html+="</table>";this._max_date=sd;b.innerHTML=html;this._scales={};var divs=b.getElementsByTagName('div');for(var i=0;i<rendered_dates.length;i++){var div=divs[(i*2)+1];var date=rendered_dates[i];this._scales[+date]=div;}
for(var i=0;i<rendered_dates.length;i++){var date=rendered_dates[i];this.callEvent("onScaleAdd",[this._scales[+date],date]);}
return sd;};scheduler.getLabel=function(property,key){var sections=this.config.lightbox.sections;for(var i=0;i<sections.length;i++){if(sections[i].map_to==property){var options=sections[i].options;for(var j=0;j<options.length;j++){if(options[j].key==key){return options[j].label;}}}}
return"";};scheduler.updateCollection=function(list_name,collection){var list=scheduler.serverList(list_name);if(!list)return false;list.splice(0,list.length);list.push.apply(list,collection||[]);scheduler.callEvent("onOptionsLoad",[]);scheduler.resetLightbox();return true;};scheduler._lame_clone=function(object,cache){var i,t,result;cache=cache||[];for(i=0;i<cache.length;i+=2)
if(object===cache[i])
return cache[i+1];if(object&&typeof object=="object"){result={};t=[Array,Date,Number,String,Boolean];for(i=0;i<t.length;i++){if(object instanceof t[i])
result=i?new t[i](object):new t[i]();}
cache.push(object,result);for(i in object){if(Object.prototype.hasOwnProperty.apply(object,[i]))
result[i]=scheduler._lame_clone(object[i],cache)}}
return result||object;};scheduler._lame_copy=function(target,source){for(var key in source){if(source.hasOwnProperty(key)){target[key]=source[key];}}
return target;};scheduler._get_date_from_pos=function(pos){var start=this._min_date.valueOf()+(pos.y*this.config.time_step+(this._table_view?0:pos.x)*24*60)*60000;return new Date(this._correct_shift(start));};scheduler.getActionData=function(n_ev){var pos=this._mouse_coords(n_ev);return{date:this._get_date_from_pos(pos),section:pos.section};};scheduler.date={init:function(){var s=scheduler.locale.date.month_short;var t=scheduler.locale.date.month_short_hash={};for(var i=0;i<s.length;i++)
t[s[i]]=i;var s=scheduler.locale.date.month_full;var t=scheduler.locale.date.month_full_hash={};for(var i=0;i<s.length;i++)
t[s[i]]=i;},date_part:function(date){date.setHours(0);date.setMinutes(0);date.setSeconds(0);date.setMilliseconds(0);if(date.getHours()!=0)
date.setTime(date.getTime()+60*60*1000*(24-date.getHours()));return date;},time_part:function(date){return(date.valueOf()/1000-date.getTimezoneOffset()*60)%86400;},week_start:function(date){var shift=date.getDay();if(scheduler.config.start_on_monday){if(shift===0)shift=6;else shift--;}
return this.date_part(this.add(date,-1*shift,"day"));},month_start:function(date){date.setDate(1);return this.date_part(date);},year_start:function(date){date.setMonth(0);return this.month_start(date);},day_start:function(date){return this.date_part(date);},add:function(date,inc,mode){var ndate=new Date(date.valueOf());switch(mode){case"week":inc*=7;case"day":ndate.setDate(ndate.getDate()+inc);if(!date.getHours()&&ndate.getHours())
ndate.setTime(ndate.getTime()+60*60*1000*(24-ndate.getHours()));break;case"month":var new_month=ndate.getMonth()+inc;var t_ndate=new Date(ndate);ndate.setMonth(new_month);if(ndate.getMonth()!=new_month&&ndate.getMonth()!=(new_month%12)){t_ndate.setDate(1);t_ndate.setMonth(new_month);t_ndate.setDate(new Date(t_ndate.getFullYear(),new_month+1,0).getDate());ndate=t_ndate;}
break;case"year":ndate.setYear(ndate.getFullYear()+inc);break;case"hour":ndate.setHours(ndate.getHours()+inc);break;case"minute":ndate.setMinutes(ndate.getMinutes()+inc);break;default:return scheduler.date["add_"+mode](date,inc,mode);}
return ndate;},to_fixed:function(num){if(num<10)return"0"+num;return num;},copy:function(date){return new Date(date.valueOf());},date_to_str:function(format,utc){format=format.replace(/%[a-zA-Z]/g,function(a){switch(a){case"%d":return"\"+scheduler.date.to_fixed(date.getDate())+\"";case"%m":return"\"+scheduler.date.to_fixed((date.getMonth()+1))+\"";case"%j":return"\"+date.getDate()+\"";case"%n":return"\"+(date.getMonth()+1)+\"";case"%y":return"\"+scheduler.date.to_fixed(date.getFullYear()%100)+\"";case"%Y":return"\"+date.getFullYear()+\"";case"%D":return"\"+scheduler.locale.date.day_short[date.getDay()]+\"";case"%l":return"\"+scheduler.locale.date.day_full[date.getDay()]+\"";case"%M":return"\"+scheduler.locale.date.month_short[date.getMonth()]+\"";case"%F":return"\"+scheduler.locale.date.month_full[date.getMonth()]+\"";case"%h":return"\"+scheduler.date.to_fixed((date.getHours()+11)%12+1)+\"";case"%g":return"\"+((date.getHours()+11)%12+1)+\"";case"%G":return"\"+date.getHours()+\"";case"%H":return"\"+scheduler.date.to_fixed(date.getHours())+\"";case"%i":return"\"+scheduler.date.to_fixed(date.getMinutes())+\"";case"%a":return"\"+(date.getHours()>11?\"pm\":\"am\")+\"";case"%A":return"\"+(date.getHours()>11?\"PM\":\"AM\")+\"";case"%s":return"\"+scheduler.date.to_fixed(date.getSeconds())+\"";case"%W":return"\"+scheduler.date.to_fixed(scheduler.date.getISOWeek(date))+\"";default:return a;}});if(utc)format=format.replace(/date\.get/g,"date.getUTC");return new Function("date","return \""+format+"\";");},str_to_date:function(format,utc){var splt="var temp=date.match(/[a-zA-Z]+|[0-9]+/g);";var mask=format.match(/%[a-zA-Z]/g);for(var i=0;i<mask.length;i++){switch(mask[i]){case"%j":case"%d":splt+="set[2]=temp["+i+"]||1;";break;case"%n":case"%m":splt+="set[1]=(temp["+i+"]||1)-1;";break;case"%y":splt+="set[0]=temp["+i+"]*1+(temp["+i+"]>50?1900:2000);";break;case"%g":case"%G":case"%h":case"%H":splt+="set[3]=temp["+i+"]||0;";break;case"%i":splt+="set[4]=temp["+i+"]||0;";break;case"%Y":splt+="set[0]=temp["+i+"]||0;";break;case"%a":case"%A":splt+="set[3]=set[3]%12+((temp["+i+"]||'').toLowerCase()=='am'?0:12);";break;case"%s":splt+="set[5]=temp["+i+"]||0;";break;case"%M":splt+="set[1]=scheduler.locale.date.month_short_hash[temp["+i+"]]||0;";break;case"%F":splt+="set[1]=scheduler.locale.date.month_full_hash[temp["+i+"]]||0;";break;default:break;}}
var code="set[0],set[1],set[2],set[3],set[4],set[5]";if(utc)code=" Date.UTC("+code+")";return new Function("date","var set=[0,0,1,0,0,0]; "+splt+" return new Date("+code+");");},getISOWeek:function(ndate){if(!ndate)return false;var nday=ndate.getDay();if(nday===0){nday=7;}
var first_thursday=new Date(ndate.valueOf());first_thursday.setDate(ndate.getDate()+(4-nday));var year_number=first_thursday.getFullYear();var ordinal_date=Math.round((first_thursday.getTime()-new Date(year_number,0,1).getTime())/86400000);var week_number=1+Math.floor(ordinal_date/7);return week_number;},getUTCISOWeek:function(ndate){return this.getISOWeek(ndate);},convert_to_utc:function(date){return new Date(date.getUTCFullYear(),date.getUTCMonth(),date.getUTCDate(),date.getUTCHours(),date.getUTCMinutes(),date.getUTCSeconds());}};scheduler.locale={date:{month_full:["January","February","March","April","May","June","July","August","September","October","November","December"],month_short:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],day_full:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],day_short:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},labels:{dhx_cal_today_button:"Today",day_tab:"Day",week_tab:"Week",month_tab:"Month",new_event:"New event",icon_save:"Save",icon_cancel:"Cancel",icon_details:"Details",icon_edit:"Edit",icon_delete:"Delete",confirm_closing:"",confirm_deleting:"Event will be deleted permanently, are you sure?",section_description:"Description",section_time:"Time period",full_day:"Full day",confirm_recurring:"Do you want to edit the whole set of repeated events?",section_recurring:"Repeat event",button_recurring:"Disabled",button_recurring_open:"Enabled",button_edit_series:"Edit series",button_edit_occurrence:"Edit occurrence",agenda_tab:"Agenda",date:"Date",description:"Description",year_tab:"Year",week_agenda_tab:"Agenda",grid_tab:"Grid"}};scheduler.config={default_date:"%j %M %Y",month_date:"%F %Y",load_date:"%Y-%m-%d",week_date:"%l",day_date:"%D, %F %j",hour_date:"%H:%i",month_day:"%d",xml_date:"%m/%d/%Y %H:%i",api_date:"%d-%m-%Y %H:%i",hour_size_px:42,time_step:5,start_on_monday:1,first_hour:0,last_hour:24,readonly:false,drag_resize:1,drag_move:1,drag_create:1,dblclick_create:1,edit_on_create:1,details_on_create:0,click_form_details:0,cascade_event_display:false,cascade_event_count:4,cascade_event_margin:30,drag_lightbox:true,preserve_scroll:true,select:true,server_utc:false,positive_closing:false,icons_edit:["icon_save","icon_cancel"],icons_select:["icon_details","icon_edit","icon_delete"],buttons_left:["dhx_save_btn","dhx_cancel_btn"],buttons_right:["dhx_delete_btn"],lightbox:{sections:[{name:"description",height:200,map_to:"text",type:"textarea",focus:true},{name:"time",height:72,type:"time",map_to:"auto"}]},highlight_displayed_event:true,displayed_event_color:"#ffc5ab",displayed_event_text_color:"#7e2727"};scheduler.templates={};scheduler.init_templates=function(){var labels=scheduler.locale.labels;labels.dhx_save_btn=labels.icon_save;labels.dhx_cancel_btn=labels.icon_cancel;labels.dhx_delete_btn=labels.icon_delete;var d=scheduler.date.date_to_str;var c=scheduler.config;var f=function(a,b){for(var c in b)
if(!a[c])a[c]=b[c];};f(scheduler.templates,{day_date:d(c.default_date),month_date:d(c.month_date),week_date:function(d1,d2){return scheduler.templates.day_date(d1)+" &ndash; "+scheduler.templates.day_date(scheduler.date.add(d2,-1,"day"));},day_scale_date:d(c.default_date),month_scale_date:d(c.week_date),week_scale_date:d(c.day_date),hour_scale:d(c.hour_date),time_picker:d(c.hour_date),event_date:d(c.hour_date),month_day:d(c.month_day),xml_date:scheduler.date.str_to_date(c.xml_date,c.server_utc),load_format:d(c.load_date,c.server_utc),xml_format:d(c.xml_date,c.server_utc),api_date:scheduler.date.str_to_date(c.api_date),event_header:function(start,end,ev){return scheduler.templates.event_date(start)+" - "+scheduler.templates.event_date(end);},event_text:function(start,end,ev){return ev.text;},event_class:function(start,end,ev){return"";},month_date_class:function(d){return"";},week_date_class:function(d){return"";},event_bar_date:function(start,end,ev){return scheduler.templates.event_date(start)+" ";},event_bar_text:function(start,end,ev){return ev.text;}});this.callEvent("onTemplatesReady",[]);};scheduler.uid=function(){if(!this._seed)this._seed=(new Date).valueOf();return this._seed++;};scheduler._events={};scheduler.clearAll=function(){this._events={};this._loaded={};this.clear_view();};scheduler.addEvent=function(start_date,end_date,text,id,extra_data){if(!arguments.length)
return this.addEventNow();var ev=start_date;if(arguments.length!=1){ev=extra_data||{};ev.start_date=start_date;ev.end_date=end_date;ev.text=text;ev.id=id;}
ev.id=ev.id||scheduler.uid();ev.text=ev.text||"";if(typeof ev.start_date=="string")ev.start_date=this.templates.api_date(ev.start_date);if(typeof ev.end_date=="string")ev.end_date=this.templates.api_date(ev.end_date);var d=(this.config.event_duration||this.config.time_step)*60000;if(ev.start_date.valueOf()==ev.end_date.valueOf())
ev.end_date.setTime(ev.end_date.valueOf()+d);ev._timed=this.is_one_day_event(ev);var is_new=!this._events[ev.id];this._events[ev.id]=ev;this.event_updated(ev);if(!this._loading)
this.callEvent(is_new?"onEventAdded":"onEventChanged",[ev.id,ev]);return ev.id;};scheduler.deleteEvent=function(id,silent){var ev=this._events[id];if(!silent&&(!this.callEvent("onBeforeEventDelete",[id,ev])||!this.callEvent("onConfirmedBeforeEventDelete",[id,ev])))
return;if(ev){delete this._events[id];this.unselect(id);this.event_updated(ev);}
this.callEvent("onEventDeleted",[id,ev]);};scheduler.getEvent=function(id){return this._events[id];};scheduler.setEvent=function(id,hash){this._events[id]=hash;};scheduler.for_rendered=function(id,method){for(var i=this._rendered.length-1;i>=0;i--)
if(this._rendered[i].getAttribute("event_id")==id)
method(this._rendered[i],i);};scheduler.changeEventId=function(id,new_id){if(id==new_id)return;var ev=this._events[id];if(ev){ev.id=new_id;this._events[new_id]=ev;delete this._events[id];}
this.for_rendered(id,function(r){r.setAttribute("event_id",new_id);});if(this._select_id==id)this._select_id=new_id;if(this._edit_id==id)this._edit_id=new_id;this.callEvent("onEventIdChange",[id,new_id]);};(function(){var attrs=["text","Text","start_date","StartDate","end_date","EndDate"];var create_getter=function(name){return function(id){return(scheduler.getEvent(id))[name];};};var create_setter=function(name){return function(id,value){var ev=scheduler.getEvent(id);ev[name]=value;ev._changed=true;ev._timed=this.is_one_day_event(ev);scheduler.event_updated(ev,true);};};for(var i=0;i<attrs.length;i+=2){scheduler["getEvent"+attrs[i+1]]=create_getter(attrs[i]);scheduler["setEvent"+attrs[i+1]]=create_setter(attrs[i]);}})();scheduler.event_updated=function(ev,force){if(this.is_visible_events(ev))
this.render_view_data();else
this.clear_event(ev.id);};scheduler.is_visible_events=function(ev){return(ev.start_date<this._max_date&&this._min_date<ev.end_date);};scheduler.is_one_day_event=function(ev){var delta=ev.end_date.getDate()-ev.start_date.getDate();if(!delta)
return ev.start_date.getMonth()==ev.end_date.getMonth()&&ev.start_date.getFullYear()==ev.end_date.getFullYear();else{if(delta<0)delta=Math.ceil((ev.end_date.valueOf()-ev.start_date.valueOf())/(24*60*60*1000));return(delta==1&&!ev.end_date.getHours()&&!ev.end_date.getMinutes()&&(ev.start_date.getHours()||ev.start_date.getMinutes()));}};scheduler.get_visible_events=function(only_timed){var stack=[];for(var id in this._events)
if(this.is_visible_events(this._events[id]))
if(!only_timed||this._events[id]._timed)
if(this.filter_event(id,this._events[id]))
stack.push(this._events[id]);return stack;};scheduler.filter_event=function(id,ev){var filter=this["filter_"+this._mode];return(filter)?filter(id,ev):true;};scheduler.render_view_data=function(evs,hold){if(!evs){if(this._not_render){this._render_wait=true;return;}
this._render_wait=false;this.clear_view();evs=this.get_visible_events(!(this._table_view||this.config.multi_day));}
if(this.config.multi_day&&!this._table_view){var tvs=[];var tvd=[];for(var i=0;i<evs.length;i++){if(evs[i]._timed)
tvs.push(evs[i]);else
tvd.push(evs[i]);}
this._rendered_location=this._els['dhx_multi_day'][0];this._table_view=true;this.render_data(tvd,hold);this._table_view=false;this._rendered_location=this._els['dhx_cal_data'][0];this._table_view=false;this.render_data(tvs,hold);}else{this._rendered_location=this._els['dhx_cal_data'][0];this.render_data(evs,hold);}};scheduler.render_data=function(evs,hold){evs=this._pre_render_events(evs,hold);for(var i=0;i<evs.length;i++)
if(this._table_view)
this.render_event_bar(evs[i]);else
this.render_event(evs[i]);};scheduler._pre_render_events=function(evs,hold){var hb=this.xy.bar_height;var h_old=this._colsS.heights;var h=this._colsS.heights=[0,0,0,0,0,0,0];var data=this._els["dhx_cal_data"][0];if(!this._table_view)
evs=this._pre_render_events_line(evs,hold);else
evs=this._pre_render_events_table(evs,hold);if(this._table_view){if(hold)
this._colsS.heights=h_old;else{var evl=data.firstChild;if(evl.rows){for(var i=0;i<evl.rows.length;i++){h[i]++;if((h[i])*hb>this._colsS.height-22){var cells=evl.rows[i].cells;for(var j=0;j<cells.length;j++){cells[j].childNodes[1].style.height=h[i]*hb+"px";}
h[i]=(h[i-1]||0)+cells[0].offsetHeight;}
h[i]=(h[i-1]||0)+evl.rows[i].cells[0].offsetHeight;}
h.unshift(0);if(evl.parentNode.offsetHeight<evl.parentNode.scrollHeight&&!evl._h_fix){for(var i=0;i<evl.rows.length;i++){var cell=evl.rows[i].cells[6].childNodes[0];var w=cell.offsetWidth-scheduler.xy.scroll_width+"px";cell.style.width=w;cell.nextSibling.style.width=w;}
evl._h_fix=true;}}else{if(!evs.length&&this._els["dhx_multi_day"][0].style.visibility=="visible")
h[0]=-1;if(evs.length||h[0]==-1){var childs=evl.parentNode.childNodes;var dh=((h[0]+1)*hb+1)+"px";data.style.top=(this._els["dhx_cal_navline"][0].offsetHeight+this._els["dhx_cal_header"][0].offsetHeight+parseInt(dh,10))+'px';data.style.height=(this._obj.offsetHeight-parseInt(data.style.top,10)-(this.xy.margin_top||0))+'px';var last=this._els["dhx_multi_day"][0];last.style.height=dh;last.style.visibility=(h[0]==-1?"hidden":"visible");last=this._els["dhx_multi_day"][1];last.style.height=dh;last.style.visibility=(h[0]==-1?"hidden":"visible");last.className=h[0]?"dhx_multi_day_icon":"dhx_multi_day_icon_small";this._dy_shift=(h[0]+1)*hb;h[0]=0;}}}}
return evs;};scheduler._get_event_sday=function(ev){return Math.floor((ev.start_date.valueOf()-this._min_date.valueOf())/(24*60*60*1000));};scheduler._get_event_mapped_end_date=function(ev){var end_date=ev.end_date;if(this.config.separate_short_events){var ev_duration=(ev.end_date-ev.start_date)/60000;if(ev_duration<this._min_mapped_duration){end_date=this.date.add(end_date,this._min_mapped_duration-ev_duration,"minute");}}
return end_date;};scheduler._pre_render_events_line=function(evs,hold){evs.sort(function(a,b){if(a.start_date.valueOf()==b.start_date.valueOf())
return a.id>b.id?1:-1;return a.start_date>b.start_date?1:-1;});var days=[];var evs_originals=[];this._min_mapped_duration=Math.ceil(this.xy.min_event_height*60/this.config.hour_size_px);for(var i=0;i<evs.length;i++){var ev=evs[i];var sd=ev.start_date;var ed=ev.end_date;var sh=sd.getHours();var eh=ed.getHours();ev._sday=this._get_event_sday(ev);if(!days[ev._sday])days[ev._sday]=[];if(!hold){ev._inner=false;var stack=days[ev._sday];while(stack.length){var t_ev=stack[stack.length-1];var t_end_date=this._get_event_mapped_end_date(t_ev);if(t_end_date.valueOf()<=ev.start_date.valueOf()){stack.splice(stack.length-1,1);}else{break;}}
var sorderSet=false;for(var j=0;j<stack.length;j++){var t_ev=stack[j];var t_end_date=this._get_event_mapped_end_date(t_ev);if(t_end_date.valueOf()<=ev.start_date.valueOf()){sorderSet=true;ev._sorder=t_ev._sorder;stack.splice(j,1);ev._inner=true;break;}}
if(stack.length)
stack[stack.length-1]._inner=true;if(!sorderSet){if(stack.length){if(stack.length<=stack[stack.length-1]._sorder){if(!stack[stack.length-1]._sorder)
ev._sorder=0;else
for(j=0;j<stack.length;j++){var _is_sorder=false;for(var k=0;k<stack.length;k++){if(stack[k]._sorder==j){_is_sorder=true;break;}}
if(!_is_sorder){ev._sorder=j;break;}}
ev._inner=true;}else{var _max_sorder=stack[0]._sorder;for(j=1;j<stack.length;j++){if(stack[j]._sorder>_max_sorder)
_max_sorder=stack[j]._sorder;}
ev._sorder=_max_sorder+1;ev._inner=false;}}else
ev._sorder=0;}
stack.push(ev);if(stack.length>(stack.max_count||0)){stack.max_count=stack.length;ev._count=stack.length;}else{ev._count=(ev._count)?ev._count:1;}}
if(sh<this.config.first_hour||eh>=this.config.last_hour){evs_originals.push(ev);evs[i]=ev=this._copy_event(ev);if(sh<this.config.first_hour){ev.start_date.setHours(this.config.first_hour);ev.start_date.setMinutes(0);}
if(eh>=this.config.last_hour){ev.end_date.setMinutes(0);ev.end_date.setHours(this.config.last_hour);}
if(ev.start_date>ev.end_date||sh==this.config.last_hour){evs.splice(i,1);i--;continue;}}}
if(!hold){for(var i=0;i<evs.length;i++){evs[i]._count=days[evs[i]._sday].max_count;}
for(var i=0;i<evs_originals.length;i++)
evs_originals[i]._count=days[evs_originals[i]._sday].max_count;}
return evs;};scheduler._time_order=function(evs){evs.sort(function(a,b){if(a.start_date.valueOf()==b.start_date.valueOf()){if(a._timed&&!b._timed)return 1;if(!a._timed&&b._timed)return-1;return a.id>b.id?1:-1;}
return a.start_date>b.start_date?1:-1;});};scheduler._pre_render_events_table=function(evs,hold){this._time_order(evs);var out=[];var weeks=[[],[],[],[],[],[],[]];var max=this._colsS.heights;var start_date;var cols=this._cols.length;var chunks_info={};for(var i=0;i<evs.length;i++){var ev=evs[i];var id=ev.id;if(!chunks_info[id]){chunks_info[id]={first_chunk:true,last_chunk:true};}
var chunk_info=chunks_info[id];var sd=(start_date||ev.start_date);var ed=ev.end_date;if(sd<this._min_date){chunk_info.first_chunk=false;sd=this._min_date;}
if(ed>this._max_date){chunk_info.last_chunk=false;ed=this._max_date;}
var locate_s=this.locate_holder_day(sd,false,ev);ev._sday=locate_s%cols;var locate_e=this.locate_holder_day(ed,true,ev)||cols;ev._eday=(locate_e%cols)||cols;ev._length=locate_e-locate_s;ev._sweek=Math.floor((this._correct_shift(sd.valueOf(),1)-this._min_date.valueOf())/(60*60*1000*24*cols));var stack=weeks[ev._sweek];var stack_line;for(stack_line=0;stack_line<stack.length;stack_line++)
if(stack[stack_line]._eday<=ev._sday)
break;if(!ev._sorder||!hold){ev._sorder=stack_line;}
if(ev._sday+ev._length<=cols){start_date=null;out.push(ev);stack[stack_line]=ev;max[ev._sweek]=stack.length-1;ev._first_chunk=chunk_info.first_chunk;ev._last_chunk=chunk_info.last_chunk;}else{var copy=this._copy_event(ev);copy.id=ev.id;copy._length=cols-ev._sday;copy._eday=cols;copy._sday=ev._sday;copy._sweek=ev._sweek;copy._sorder=ev._sorder;copy.end_date=this.date.add(sd,copy._length,"day");copy._first_chunk=chunk_info.first_chunk;if(chunk_info.first_chunk){chunk_info.first_chunk=false;}
out.push(copy);stack[stack_line]=copy;start_date=copy.end_date;max[ev._sweek]=stack.length-1;i--;continue;}}
return out;};scheduler._copy_dummy=function(){var a=new Date(this.start_date);var b=new Date(this.end_date);this.start_date=a;this.end_date=b;};scheduler._copy_event=function(ev){this._copy_dummy.prototype=ev;return new this._copy_dummy();};scheduler._rendered=[];scheduler.clear_view=function(){for(var i=0;i<this._rendered.length;i++){var obj=this._rendered[i];if(obj.parentNode)obj.parentNode.removeChild(obj);}
this._rendered=[];};scheduler.updateEvent=function(id){var ev=this.getEvent(id);this.clear_event(id);if(ev&&this.is_visible_events(ev)&&this.filter_event(id,ev)&&(this._table_view||this.config.multi_day||ev._timed)){if(this.config.update_render)
this.render_view_data();else
this.render_view_data([ev],true);}};scheduler.clear_event=function(id){this.for_rendered(id,function(node,i){if(node.parentNode)
node.parentNode.removeChild(node);scheduler._rendered.splice(i,1);});};scheduler.render_event=function(ev){var menu=scheduler.xy.menu_width;if(ev._sday<0)return;var parent=scheduler.locate_holder(ev._sday);if(!parent)return;var sm=ev.start_date.getHours()*60+ev.start_date.getMinutes();var em=(ev.end_date.getHours()*60+ev.end_date.getMinutes())||(scheduler.config.last_hour*60);var ev_count=ev._count||1;var ev_sorder=ev._sorder||0;var top=(Math.round((sm*60*1000-this.config.first_hour*60*60*1000)*this.config.hour_size_px/(60*60*1000)))%(this.config.hour_size_px*24);var height=Math.max(scheduler.xy.min_event_height,(em-sm)*this.config.hour_size_px/60);var width=Math.floor((parent.clientWidth-menu)/ev_count);var left=ev_sorder*width+1;if(!ev._inner)width=width*(ev_count-ev_sorder);if(this.config.cascade_event_display){var limit=this.config.cascade_event_count;var margin=this.config.cascade_event_margin;left=ev_sorder%limit*margin;var right=(ev._inner)?(ev_count-ev_sorder-1)%limit*margin/2:0;width=Math.floor(parent.clientWidth-menu-left-right);}
var d=this._render_v_bar(ev.id,menu+left,top,width,height,ev._text_style,scheduler.templates.event_header(ev.start_date,ev.end_date,ev),scheduler.templates.event_text(ev.start_date,ev.end_date,ev));this._rendered.push(d);parent.appendChild(d);left=left+parseInt(parent.style.left,10)+menu;if(this._edit_id==ev.id){d.style.zIndex=1;width=Math.max(width-4,scheduler.xy.editor_width);d=document.createElement("DIV");d.setAttribute("event_id",ev.id);this.set_xy(d,width,height-20,left,top+14);d.className="dhx_cal_editor";var d2=document.createElement("DIV");this.set_xy(d2,width-6,height-26);d2.style.cssText+=";margin:2px 2px 2px 2px;overflow:hidden;";d.appendChild(d2);this._els["dhx_cal_data"][0].appendChild(d);this._rendered.push(d);d2.innerHTML="<textarea class='dhx_cal_editor'>"+ev.text+"</textarea>";if(this._quirks7)d2.firstChild.style.height=height-12+"px";this._editor=d2.firstChild;this._editor.onkeydown=function(e){if((e||event).shiftKey)return true;var code=(e||event).keyCode;if(code==scheduler.keys.edit_save)scheduler.editStop(true);if(code==scheduler.keys.edit_cancel)scheduler.editStop(false);};this._editor.onselectstart=function(e){return(e||event).cancelBubble=true;};d2.firstChild.focus();this._els["dhx_cal_data"][0].scrollLeft=0;d2.firstChild.select();}
if(this.xy.menu_width!==0&&this._select_id==ev.id){if(this.config.cascade_event_display&&this._drag_mode)
d.style.zIndex=1;var icons=this.config["icons_"+((this._edit_id==ev.id)?"edit":"select")];var icons_str="";var bg_color=(ev.color?("background-color: "+ev.color+";"):"");var color=(ev.textColor?("color: "+ev.textColor+";"):"");for(var i=0;i<icons.length;i++)
icons_str+="<div class='dhx_menu_icon "+icons[i]+"' style='"+bg_color+""+color+"' title='"+this.locale.labels[icons[i]]+"'></div>";var obj=this._render_v_bar(ev.id,left-menu+1,top,menu,icons.length*20+26-2,"","<div style='"+bg_color+""+color+"' class='dhx_menu_head'></div>",icons_str,true);obj.style.left=left-menu+1;this._els["dhx_cal_data"][0].appendChild(obj);this._rendered.push(obj);}};scheduler._render_v_bar=function(id,x,y,w,h,style,contentA,contentB,bottom){var d=document.createElement("DIV");var ev=this.getEvent(id);var cs=(bottom)?"dhx_cal_event dhx_cal_select_menu":"dhx_cal_event";var cse=scheduler.templates.event_class(ev.start_date,ev.end_date,ev);if(cse)cs=cs+" "+cse;var bg_color=(ev.color?("background:"+ev.color+";"):"");var color=(ev.textColor?("color:"+ev.textColor+";"):"");var html='<div event_id="'+id+'" class="'+cs+'" style="position:absolute; top:'+y+'px; left:'+x+'px; width:'+(w-4)+'px; height:'+h+'px;'+(style||"")+'"></div>';d.innerHTML=html;var container=d.cloneNode(true).firstChild;if(scheduler.renderEvent&&!bottom&&scheduler.renderEvent(container,ev)){return container;}else{container=d.firstChild;var inner_html='<div class="dhx_event_move dhx_header" style=" width:'+(w-6)+'px;'+bg_color+'" >&nbsp;</div>';inner_html+='<div class="dhx_event_move dhx_title" style="'+bg_color+''+color+'">'+contentA+'</div>';inner_html+='<div class="dhx_body" style=" width:'+(w-(this._quirks?4:14))+'px; height:'+(h-(this._quirks?20:30)+1)+'px;'+bg_color+''+color+'">'+contentB+'</div>';var footer_class="dhx_event_resize dhx_footer";if(bottom)
footer_class="dhx_resize_denied "+footer_class;inner_html+='<div class="'+footer_class+'" style=" width:'+(w-8)+'px;'+(bottom?' margin-top:-1px;':'')+''+bg_color+''+color+'" ></div>';container.innerHTML=inner_html;}
return container;};scheduler.locate_holder=function(day){if(this._mode=="day")return this._els["dhx_cal_data"][0].firstChild;return this._els["dhx_cal_data"][0].childNodes[day];};scheduler.locate_holder_day=function(date,past){var day=Math.floor((this._correct_shift(date,1)-this._min_date)/(60*60*24*1000));if(past&&this.date.time_part(date))day++;return day;};scheduler.render_event_bar=function(ev){var parent=this._rendered_location;var x=this._colsS[ev._sday];var x2=this._colsS[ev._eday];if(x2==x)x2=this._colsS[ev._eday+1];var hb=this.xy.bar_height;var y=this._colsS.heights[ev._sweek]+(this._colsS.height?(this.xy.month_scale_height+2):2)+(ev._sorder*hb);var d=document.createElement("DIV");var cs="dhx_cal_event_clear";if(!ev._timed){cs="dhx_cal_event_line";if(ev.hasOwnProperty("_first_chunk")&&ev._first_chunk)
cs+=" dhx_cal_event_line_start";if(ev.hasOwnProperty("_last_chunk")&&ev._last_chunk)
cs+=" dhx_cal_event_line_end";}
var cse=scheduler.templates.event_class(ev.start_date,ev.end_date,ev);if(cse)cs=cs+" "+cse;var bg_color=(ev.color?("background:"+ev.color+";"):"");var color=(ev.textColor?("color:"+ev.textColor+";"):"");var html='<div event_id="'+ev.id+'" class="'+cs+'" style="position:absolute; top:'+y+'px; left:'+x+'px; width:'+(x2-x-15)+'px;'+color+''+bg_color+''+(ev._text_style||"")+'">';ev=scheduler.getEvent(ev.id);if(ev._timed)
html+=scheduler.templates.event_bar_date(ev.start_date,ev.end_date,ev);html+=scheduler.templates.event_bar_text(ev.start_date,ev.end_date,ev)+'</div>';html+='</div>';d.innerHTML=html;this._rendered.push(d.firstChild);parent.appendChild(d.firstChild);};scheduler._locate_event=function(node){var id=null;while(node&&!id&&node.getAttribute){id=node.getAttribute("event_id");node=node.parentNode;}
return id;};scheduler.edit=function(id){if(this._edit_id==id)return;this.editStop(false,id);this._edit_id=id;this.updateEvent(id);};scheduler.editStop=function(mode,id){if(id&&this._edit_id==id)return;var ev=this.getEvent(this._edit_id);if(ev){if(mode)ev.text=this._editor.value;this._edit_id=null;this._editor=null;this.updateEvent(ev.id);this._edit_stop_event(ev,mode);}};scheduler._edit_stop_event=function(ev,mode){if(this._new_event){if(!mode){if(ev)
this.deleteEvent(ev.id,true);}else{this.callEvent("onEventAdded",[ev.id,ev]);}
this._new_event=null;}else{if(mode)
this.callEvent("onEventChanged",[ev.id,ev]);}};scheduler.getEvents=function(from,to){var result=[];for(var a in this._events){var ev=this._events[a];if(ev&&((!from&&!to)||(ev.start_date<to&&ev.end_date>from)))
result.push(ev);}
return result;};scheduler.getRenderedEvent=function(id){if(!id)
return;var rendered_events=scheduler._rendered;for(var i=0;i<rendered_events.length;i++){var rendered_event=rendered_events[i];if(rendered_event.getAttribute("event_id")==id){return rendered_event;}}
return null;};scheduler.showEvent=function(id,mode){var ev=(typeof id=="number"||typeof id=="string")?scheduler.getEvent(id):id;mode=mode||scheduler._mode;if(!ev||(this.checkEvent("onBeforeEventDisplay")&&!this.callEvent("onBeforeEventDisplay",[ev,mode])))
return;var scroll_hour=scheduler.config.scroll_hour;scheduler.config.scroll_hour=ev.start_date.getHours();var preserve_scroll=scheduler.config.preserve_scroll;scheduler.config.preserve_scroll=false;var original_color=ev.color;var original_text_color=ev.textColor;if(scheduler.config.highlight_displayed_event){ev.color=scheduler.config.displayed_event_color;ev.textColor=scheduler.config.displayed_event_text_color;}
scheduler.setCurrentView(new Date(ev.start_date),mode);ev.color=original_color;ev.textColor=original_text_color;scheduler.config.scroll_hour=scroll_hour;scheduler.config.preserve_scroll=preserve_scroll;if(scheduler.matrix&&scheduler.matrix[mode]){scheduler._els["dhx_cal_data"][0].scrollTop=getAbsoluteTop(scheduler.getRenderedEvent(ev.id));}
scheduler.callEvent("onAfterEventDisplay",[ev,mode]);};scheduler._loaded={};scheduler._load=function(url,from){url=url||this._load_url;url+=(url.indexOf("?")==-1?"?":"&")+"timeshift="+(new Date()).getTimezoneOffset();if(this.config.prevent_cache)url+="&uid="+this.uid();var to;from=from||this._date;if(this._load_mode){var lf=this.templates.load_format;from=this.date[this._load_mode+"_start"](new Date(from.valueOf()));while(from>this._min_date)from=this.date.add(from,-1,this._load_mode);to=from;var cache_line=true;while(to<this._max_date){to=this.date.add(to,1,this._load_mode);if(this._loaded[lf(from)]&&cache_line)
from=this.date.add(from,1,this._load_mode);else cache_line=false;}
var temp_to=to;do{to=temp_to;temp_to=this.date.add(to,-1,this._load_mode);}while(temp_to>from&&this._loaded[lf(temp_to)]);if(to<=from)
return false;dhtmlxAjax.get(url+"&from="+lf(from)+"&to="+lf(to),function(l){scheduler.on_load(l);});while(from<to){this._loaded[lf(from)]=true;from=this.date.add(from,1,this._load_mode);}}else
dhtmlxAjax.get(url,function(l){scheduler.on_load(l);});this.callEvent("onXLS",[]);return true;};scheduler.on_load=function(loader){var evs;if(this._process)
evs=this[this._process].parse(loader.xmlDoc.responseText);else
evs=this._magic_parser(loader);scheduler._process_loading(evs);this.callEvent("onXLE",[]);};scheduler._process_loading=function(evs){this._loading=true;this._not_render=true;for(var i=0;i<evs.length;i++){if(!this.callEvent("onEventLoading",[evs[i]]))continue;this.addEvent(evs[i]);}
this._not_render=false;if(this._render_wait)this.render_view_data();this._loading=false;if(this._after_call)this._after_call();this._after_call=null;};scheduler.json={};scheduler.json.parse=function(data){if(typeof data=="string"){scheduler._temp=eval("("+data+")");data=(scheduler._temp)?scheduler._temp.data||scheduler._temp:[];}
if(data.dhx_security)
dhtmlx.security_key=data.dhx_security;var collections=(scheduler._temp&&scheduler._temp.collections)?scheduler._temp.collections:{};var collections_loaded=false;for(var key in collections){if(collections.hasOwnProperty(key)){collections_loaded=true;var collection=collections[key];var arr=scheduler.serverList[key];if(!arr)continue;arr.splice(0,arr.length);for(var j=0;j<collection.length;j++){var option=collection[j];var obj={key:option.value,label:option.label};for(var option_key in option){if(option.hasOwnProperty(option_key)){if(option_key=="value"||option_key=="label")
continue;obj[option_key]=option[option_key];}}
arr.push(obj);}}}
if(collections_loaded)
scheduler.callEvent("onOptionsLoad",[]);var evs=[];for(var i=0;i<data.length;i++){data[i].start_date=scheduler.templates.xml_date(data[i].start_date);data[i].end_date=scheduler.templates.xml_date(data[i].end_date);evs.push(data[i]);}
return evs;};scheduler.parse=function(data,type){this._process=type;this.on_load({xmlDoc:{responseText:data}});};scheduler.load=function(url,call){if(typeof call=="string"){this._process=call;call=arguments[2];}
this._load_url=url;this._after_call=call;this._load(url,this._date);};scheduler.setLoadMode=function(mode){if(mode=="all")mode="";this._load_mode=mode;};scheduler.refresh=function(refresh_all){alert("not implemented");};scheduler.serverList=function(name,array){if(array){return this.serverList[name]=array.slice(0);}
return this.serverList[name]=(this.serverList[name]||[]);};scheduler._userdata={};scheduler._magic_parser=function(loader){var xml;if(!loader.getXMLTopNode){var xml_string=loader.xmlDoc.responseText;loader=new dtmlXMLLoaderObject(function(){});loader.loadXMLString(xml_string);}
xml=loader.getXMLTopNode("data");if(xml.tagName!="data")return[];var skey=xml.getAttribute("dhx_security");if(skey)
dhtmlx.security_key=skey;var opts=loader.doXPath("//coll_options");for(var i=0;i<opts.length;i++){var bind=opts[i].getAttribute("for");var arr=this.serverList[bind];if(!arr)continue;arr.splice(0,arr.length);var itms=loader.doXPath(".//item",opts[i]);for(var j=0;j<itms.length;j++){var itm=itms[j];var attrs=itm.attributes;var obj={key:itms[j].getAttribute("value"),label:itms[j].getAttribute("label")};for(var k=0;k<attrs.length;k++){var attr=attrs[k];if(attr.nodeName=="value"||attr.nodeName=="label")
continue;obj[attr.nodeName]=attr.nodeValue;}
arr.push(obj);}}
if(opts.length)
scheduler.callEvent("onOptionsLoad",[]);var ud=loader.doXPath("//userdata");for(var i=0;i<ud.length;i++){var udx=this.xmlNodeToJSON(ud[i]);this._userdata[udx.name]=udx.text;}
var evs=[];xml=loader.doXPath("//event");for(var i=0;i<xml.length;i++){evs[i]=this.xmlNodeToJSON(xml[i]);evs[i].text=evs[i].text||evs[i]._tagvalue;evs[i].start_date=this.templates.xml_date(evs[i].start_date);evs[i].end_date=this.templates.xml_date(evs[i].end_date);}
return evs;};scheduler.xmlNodeToJSON=function(node){var t={};for(var i=0;i<node.attributes.length;i++)
t[node.attributes[i].name]=node.attributes[i].value;for(var i=0;i<node.childNodes.length;i++){var child=node.childNodes[i];if(child.nodeType==1)
t[child.tagName]=child.firstChild?child.firstChild.nodeValue:"";}
if(!t.text)t.text=node.firstChild?node.firstChild.nodeValue:"";return t;};scheduler.attachEvent("onXLS",function(){if(this.config.show_loading===true){var t;t=this.config.show_loading=document.createElement("DIV");t.className='dhx_loading';t.style.left=Math.round((this._x-128)/2)+"px";t.style.top=Math.round((this._y-15)/2)+"px";this._obj.appendChild(t);}});scheduler.attachEvent("onXLE",function(){var t;if(t=this.config.show_loading)
if(typeof t=="object"){this._obj.removeChild(t);this.config.show_loading=true;}});scheduler.ical={parse:function(str){var data=str.match(RegExp(this.c_start+"[^\f]*"+this.c_end,""));if(!data.length)return;data[0]=data[0].replace(/[\r\n]+(?=[a-z \t])/g," ");data[0]=data[0].replace(/\;[^:\r\n]*/g,"");var incoming=[];var match;var event_r=RegExp("(?:"+this.e_start+")([^\f]*?)(?:"+this.e_end+")","g");while(match=event_r.exec(data)){var e={};var param;var param_r=/[^\r\n]+[\r\n]+/g;while(param=param_r.exec(match[1]))
this.parse_param(param.toString(),e);if(e.uid&&!e.id)e.id=e.uid;incoming.push(e);}
return incoming;},parse_param:function(str,obj){var d=str.indexOf(":");if(d==-1)return;var name=str.substr(0,d).toLowerCase();var value=str.substr(d+1).replace(/\\\,/g,",").replace(/[\r\n]+$/,"");if(name=="summary")
name="text";else if(name=="dtstart"){name="start_date";value=this.parse_date(value,0,0);}
else if(name=="dtend"){name="end_date";value=this.parse_date(value,0,0);}
obj[name]=value;},parse_date:function(value,dh,dm){var t=value.split("T");if(t[1]){dh=t[1].substr(0,2);dm=t[1].substr(2,2);}
var dy=t[0].substr(0,4);var dn=parseInt(t[0].substr(4,2),10)-1;var dd=t[0].substr(6,2);if(scheduler.config.server_utc&&!t[1]){return new Date(Date.UTC(dy,dn,dd,dh,dm));}
return new Date(dy,dn,dd,dh,dm);},c_start:"BEGIN:VCALENDAR",e_start:"BEGIN:VEVENT",e_end:"END:VEVENT",c_end:"END:VCALENDAR"};scheduler.lightbox={};scheduler.formSection=function(name){var config=this.config.lightbox.sections;var i=0;for(i;i<config.length;i++)
if(config[i].name==name)
break;var section=config[i];if(!scheduler._lightbox)
scheduler.getLightbox();var header=document.getElementById(section.id);var node=header.nextSibling;var result={section:section,header:header,node:node,getValue:function(ev){return scheduler.form_blocks[section.type].get_value(node,(ev||{}),section);},setValue:function(value,ev){return scheduler.form_blocks[section.type].set_value(node,value,(ev||{}),section);}};var handler=scheduler.lightbox["get_"+section.type+"_control"];return handler?handler(result):result;};scheduler.lightbox.get_template_control=function(result){result.control=result.node;return result;};scheduler.lightbox.get_select_control=function(result){result.control=result.node.getElementsByTagName('select')[0];return result;};scheduler.lightbox.get_textarea_control=function(result){result.control=result.node.getElementsByTagName('textarea')[0];return result;};scheduler.lightbox.get_time_control=function(result){result.control=result.node.getElementsByTagName('select');return result;};scheduler.form_blocks={template:{render:function(sns){var height=(sns.height||"30")+"px";return"<div class='dhx_cal_ltext dhx_cal_template' style='height:"+height+";'></div>";},set_value:function(node,value,ev,config){node.innerHTML=value||"";},get_value:function(node,ev,config){return node.innerHTML||"";},focus:function(node){}},textarea:{render:function(sns){var height=(sns.height||"130")+"px";return"<div class='dhx_cal_ltext' style='height:"+height+";'><textarea></textarea></div>";},set_value:function(node,value,ev){node.firstChild.value=value||"";},get_value:function(node,ev){return node.firstChild.value;},focus:function(node){var a=node.firstChild;a.select();a.focus();}},select:{render:function(sns){var height=(sns.height||"23")+"px";var html="<div class='dhx_cal_ltext' style='height:"+height+";'><select style='width:100%;'>";for(var i=0;i<sns.options.length;i++)
html+="<option value='"+sns.options[i].key+"'>"+sns.options[i].label+"</option>";html+="</select></div>";return html;},set_value:function(node,value,ev,sns){var select=node.firstChild;if(!select._dhx_onchange&&sns.onchange){select.onchange=sns.onchange;select._dhx_onchange=true;}
if(typeof value=="undefined")
value=(select.options[0]||{}).value;select.value=value||"";},get_value:function(node,ev){return node.firstChild.value;},focus:function(node){var a=node.firstChild;if(a.select)a.select();a.focus();}},time:{render:function(sns){var cfg=scheduler.config;var dt=this.date.date_part(new Date());var last=24*60,first=0;if(scheduler.config.limit_time_select){last=60*cfg.last_hour+1;first=60*cfg.first_hour;dt.setHours(cfg.first_hour);}
var html="<select>";var i=first;var tdate=dt.getDate();sns._time_values=[];while(i<last){var time=this.templates.time_picker(dt);html+="<option value='"+i+"'>"+time+"</option>";sns._time_values.push(i);dt.setTime(dt.valueOf()+this.config.time_step*60*1000);var diff=(dt.getDate()!=tdate)?1:0;i=diff*24*60+dt.getHours()*60+dt.getMinutes();}
html+="</select> <select>";for(var i=1;i<32;i++)
html+="<option value='"+i+"'>"+i+"</option>";html+="</select> <select>";for(var i=0;i<12;i++)
html+="<option value='"+i+"'>"+this.locale.date.month_full[i]+"</option>";html+="</select> <select>";dt=dt.getFullYear()-5;for(var i=0;i<10;i++)
html+="<option value='"+(dt+i)+"'>"+(dt+i)+"</option>";html+="</select> ";return"<div style='height:30px;padding-top:0px;font-size:inherit;' class='dhx_section_time'>"+html+"<span style='font-weight:normal; font-size:10pt;'> &nbsp;&ndash;&nbsp; </span>"+html+"</div>";},set_value:function(node,value,ev,config){var cfg=scheduler.config;var s=node.getElementsByTagName("select");if(cfg.full_day){if(!node._full_day){var html="<label class='dhx_fullday'><input type='checkbox' name='full_day' value='true'> "+scheduler.locale.labels.full_day+"&nbsp;</label></input>";if(!scheduler.config.wide_form)
html=node.previousSibling.innerHTML+html;node.previousSibling.innerHTML=html;node._full_day=true;}
var input=node.previousSibling.getElementsByTagName("input")[0];input.checked=(scheduler.date.time_part(ev.start_date)===0&&scheduler.date.time_part(ev.end_date)===0);s[0].disabled=input.checked;s[s.length/2].disabled=input.checked;input.onclick=function(){if(input.checked){var obj={};scheduler.form_blocks.time.get_value(node,obj);var start_date=scheduler.date.date_part(obj.start_date);var end_date=scheduler.date.date_part(obj.end_date);if(+end_date==+start_date||(+end_date>=+start_date&&(ev.end_date.getHours()!=0||ev.end_date.getMinutes()!=0)))
end_date=scheduler.date.add(end_date,1,"day");}
s[0].disabled=input.checked;s[s.length/2].disabled=input.checked;_fill_lightbox_select(s,0,start_date||ev.start_date);_fill_lightbox_select(s,4,end_date||ev.end_date);};}
if(cfg.auto_end_date&&cfg.event_duration){function _update_lightbox_select(){var start_date=new Date(s[3].value,s[2].value,s[1].value,0,s[0].value);var end_date=new Date(start_date.getTime()+(scheduler.config.event_duration*60*1000));_fill_lightbox_select(s,4,end_date);}
for(var i=0;i<4;i++){s[i].onchange=_update_lightbox_select;}}
function _fill_lightbox_select(s,i,d){var time_values=config._time_values;var direct_value=d.getHours()*60+d.getMinutes();var fixed_value=direct_value;var value_found=false;for(var k=0;k<time_values.length;k++){var t_v=time_values[k];if(t_v===direct_value){value_found=true;break;}
if(t_v<direct_value)
fixed_value=t_v;}
s[i+0].value=(value_found)?direct_value:fixed_value;s[i+1].value=d.getDate();s[i+2].value=d.getMonth();s[i+3].value=d.getFullYear();}
_fill_lightbox_select(s,0,ev.start_date);_fill_lightbox_select(s,4,ev.end_date);},get_value:function(node,ev){s=node.getElementsByTagName("select");ev.start_date=new Date(s[3].value,s[2].value,s[1].value,0,s[0].value);ev.end_date=new Date(s[7].value,s[6].value,s[5].value,0,s[4].value);if(ev.end_date<=ev.start_date)
ev.end_date=scheduler.date.add(ev.start_date,scheduler.config.time_step,"minute");return{start_date:new Date(ev.start_date),end_date:new Date(ev.end_date)};},focus:function(node){node.getElementsByTagName("select")[0].focus();}}};scheduler.showCover=function(box){if(box){box.style.display="block";var scroll_top=window.pageYOffset||document.body.scrollTop||document.documentElement.scrollTop;var scroll_left=window.pageXOffset||document.body.scrollLeft||document.documentElement.scrollLeft;var view_height=window.innerHeight||document.documentElement.clientHeight;if(scroll_top)
box.style.top=Math.round(scroll_top+Math.max((view_height-box.offsetHeight)/2,0))+"px";else
box.style.top=Math.round(Math.max(((view_height-box.offsetHeight)/2),0)+9)+"px";if(document.documentElement.scrollWidth>document.body.offsetWidth)
box.style.left=Math.round(scroll_left+(document.body.offsetWidth-box.offsetWidth)/2)+"px";else
box.style.left=Math.round((document.body.offsetWidth-box.offsetWidth)/2)+"px";}
this.show_cover();};scheduler.showLightbox=function(id){if(!id)return;if(!this.callEvent("onBeforeLightbox",[id])){if(this._new_event)
this._new_event=null;return;}
var box=this.getLightbox();this.showCover(box);this._fill_lightbox(id,box);this.callEvent("onLightbox",[id]);};scheduler._fill_lightbox=function(id,box){var ev=this.getEvent(id);var s=box.getElementsByTagName("span");if(scheduler.templates.lightbox_header){s[1].innerHTML="";s[2].innerHTML=scheduler.templates.lightbox_header(ev.start_date,ev.end_date,ev);}else{s[1].innerHTML=this.templates.event_header(ev.start_date,ev.end_date,ev);s[2].innerHTML=(this.templates.event_bar_text(ev.start_date,ev.end_date,ev)||"").substr(0,70);}
var sns=this.config.lightbox.sections;for(var i=0;i<sns.length;i++){var current_sns=sns[i];var node=document.getElementById(current_sns.id).nextSibling;var block=this.form_blocks[current_sns.type];var value=(ev[current_sns.map_to]!==undefined)?ev[current_sns.map_to]:current_sns.default_value;block.set_value.call(this,node,value,ev,current_sns);if(sns[i].focus)
block.focus.call(this,node);}
scheduler._lightbox_id=id;};scheduler._lightbox_out=function(ev){var sns=this.config.lightbox.sections;for(var i=0;i<sns.length;i++){var node=document.getElementById(sns[i].id);node=(node?node.nextSibling:node);var block=this.form_blocks[sns[i].type];var res=block.get_value.call(this,node,ev,sns[i]);if(sns[i].map_to!="auto")
ev[sns[i].map_to]=res;}
return ev;};scheduler._empty_lightbox=function(data){var id=scheduler._lightbox_id;var ev=this.getEvent(id);var box=this.getLightbox();this._lame_copy(ev,data);ev._timed=this.is_one_day_event(ev);this.setEvent(ev.id,ev);this._edit_stop_event(ev,true);this.render_view_data();};scheduler.hide_lightbox=function(id){this.hideCover(this.getLightbox());this._lightbox_id=null;this.callEvent("onAfterLightbox",[]);};scheduler.hideCover=function(box){if(box)box.style.display="none";this.hide_cover();};scheduler.hide_cover=function(){if(this._cover)
this._cover.parentNode.removeChild(this._cover);this._cover=null;};scheduler.show_cover=function(){this._cover=document.createElement("DIV");this._cover.className="dhx_cal_cover";var _document_height=((document.height!==undefined)?document.height:document.body.offsetHeight);var _scroll_height=((document.documentElement)?document.documentElement.scrollHeight:0);this._cover.style.height=Math.max(_document_height,_scroll_height)+'px';document.body.appendChild(this._cover);};scheduler.save_lightbox=function(){var data=this._lightbox_out({},this._lame_copy(this.getEvent(this._lightbox_id)));if(this.checkEvent("onEventSave")&&!this.callEvent("onEventSave",[this._lightbox_id,data,this._new_event]))
return;this._empty_lightbox(data);this.hide_lightbox();};scheduler.startLightbox=function(id,box){this._lightbox_id=id;this._lightbox=box;this.showCover(box);};scheduler.endLightbox=function(mode,box){this._edit_stop_event(scheduler.getEvent(this._lightbox_id),mode);if(mode)
scheduler.render_view_data();this.hideCover(box);this._lightbox_id=null;};scheduler.resetLightbox=function(){if(scheduler._lightbox)
scheduler._lightbox.parentNode.removeChild(scheduler._lightbox);scheduler._lightbox=null;};scheduler.cancel_lightbox=function(){this.callEvent("onEventCancel",[this._lightbox_id,this._new_event]);this.endLightbox(false);this.hide_lightbox();};scheduler._init_lightbox_events=function(){this.getLightbox().onclick=function(e){var src=e?e.target:event.srcElement;if(!src.className)src=src.previousSibling;if(src&&src.className)
switch(src.className){case"dhx_save_btn":scheduler.save_lightbox();break;case"dhx_delete_btn":var c=scheduler.locale.labels.confirm_deleting;scheduler._dhtmlx_confirm(c,scheduler.locale.labels.title_confirm_deleting,function(){scheduler.deleteEvent(scheduler._lightbox_id);scheduler._new_event=null;scheduler.hide_lightbox();});break;case"dhx_cancel_btn":scheduler.cancel_lightbox();break;default:if(src.getAttribute("dhx_button")){scheduler.callEvent("onLightboxButton",[src.className,src,e]);}else{var index,block,sec;if(src.className.indexOf("dhx_custom_button")!=-1){if(src.className.indexOf("dhx_custom_button_")!=-1){index=src.parentNode.getAttribute("index");sec=src.parentNode.parentNode;}else{index=src.getAttribute("index");sec=src.parentNode;src=src.firstChild;}}
if(index){block=scheduler.form_blocks[scheduler.config.lightbox.sections[index].type];block.button_click(index,src,sec,sec.nextSibling);}}
break;}};this.getLightbox().onkeydown=function(e){switch((e||event).keyCode){case scheduler.keys.edit_save:if((e||event).shiftKey)return;scheduler.save_lightbox();break;case scheduler.keys.edit_cancel:scheduler.cancel_lightbox();break;default:break;}};};scheduler.setLightboxSize=function(){var d=this._lightbox;if(!d)return;var con=d.childNodes[1];con.style.height="0px";con.style.height=con.scrollHeight+"px";d.style.height=con.scrollHeight+scheduler.xy.lightbox_additional_height+"px";con.style.height=con.scrollHeight+"px";};scheduler._init_dnd_events=function(){dhtmlxEvent(document.body,"mousemove",scheduler._move_while_dnd);dhtmlxEvent(document.body,"mouseup",scheduler._finish_dnd);scheduler._init_dnd_events=function(){};};scheduler._move_while_dnd=function(e){if(scheduler._dnd_start_lb){if(!document.dhx_unselectable){document.body.className+=" dhx_unselectable";document.dhx_unselectable=true;}
var lb=scheduler.getLightbox();var now=(e&&e.target)?[e.pageX,e.pageY]:[event.clientX,event.clientY];lb.style.top=scheduler._lb_start[1]+now[1]-scheduler._dnd_start_lb[1]+"px";lb.style.left=scheduler._lb_start[0]+now[0]-scheduler._dnd_start_lb[0]+"px";}};scheduler._ready_to_dnd=function(e){var lb=scheduler.getLightbox();scheduler._lb_start=[parseInt(lb.style.left,10),parseInt(lb.style.top,10)];scheduler._dnd_start_lb=(e&&e.target)?[e.pageX,e.pageY]:[event.clientX,event.clientY];};scheduler._finish_dnd=function(){if(scheduler._lb_start){scheduler._lb_start=scheduler._dnd_start_lb=false;document.body.className=document.body.className.replace(" dhx_unselectable","");document.dhx_unselectable=false;}};scheduler.getLightbox=function(){if(!this._lightbox){var d=document.createElement("DIV");d.className="dhx_cal_light";if(scheduler.config.wide_form)
d.className+=" dhx_cal_light_wide";if(scheduler.form_blocks.recurring)
d.className+=" dhx_cal_light_rec";if(/msie|MSIE 6/.test(navigator.userAgent))
d.className+=" dhx_ie6";d.style.visibility="hidden";var html=this._lightbox_template;var buttons=this.config.buttons_left;for(var i=0;i<buttons.length;i++)
html+="<div class='dhx_btn_set dhx_left_btn_set "+buttons[i]+"_set'><div dhx_button='1' class='"+buttons[i]+"'></div><div>"+scheduler.locale.labels[buttons[i]]+"</div></div>";buttons=this.config.buttons_right;for(var i=0;i<buttons.length;i++)
html+="<div class='dhx_btn_set dhx_right_btn_set "+buttons[i]+"_set' style='float:right;'><div dhx_button='1' class='"+buttons[i]+"'></div><div>"+scheduler.locale.labels[buttons[i]]+"</div></div>";html+="</div>";d.innerHTML=html;if(scheduler.config.drag_lightbox){d.firstChild.onmousedown=scheduler._ready_to_dnd;d.firstChild.onselectstart=function(){return false;};d.firstChild.style.cursor="pointer";scheduler._init_dnd_events();}
document.body.insertBefore(d,document.body.firstChild);this._lightbox=d;var sns=this.config.lightbox.sections;html="";for(var i=0;i<sns.length;i++){var block=this.form_blocks[sns[i].type];if(!block)continue;sns[i].id="area_"+this.uid();var button="";if(sns[i].button){button="<div class='dhx_custom_button' index='"+i+"'><div class='dhx_custom_button_"+sns[i].button+"'></div><div>"+this.locale.labels["button_"+sns[i].button]+"</div></div>";}
if(this.config.wide_form){html+="<div class='dhx_wrap_section'>";}
html+="<div id='"+sns[i].id+"' class='dhx_cal_lsection'>"+button+this.locale.labels["section_"+sns[i].name]+"</div>"+block.render.call(this,sns[i]);html+="</div>"}
var ds=d.getElementsByTagName("div");for(var i=0;i<ds.length;i++){var t_ds=ds[i];if(t_ds.className=="dhx_cal_larea"){t_ds.innerHTML=html;break;}}
this.setLightboxSize();this._init_lightbox_events(this);d.style.display="none";d.style.visibility="visible";}
return this._lightbox;};scheduler._lightbox_template="<div class='dhx_cal_ltitle'><span class='dhx_mark'>&nbsp;</span><span class='dhx_time'></span><span class='dhx_title'></span></div><div class='dhx_cal_larea'></div>";scheduler._dp_init=function(dp){dp._methods=["setEventTextStyle","","changeEventId","deleteEvent"];this.attachEvent("onEventAdded",function(id){if(!this._loading&&this.validId(id))
dp.setUpdated(id,true,"inserted");});this.attachEvent("onConfirmedBeforeEventDelete",function(id){if(!this.validId(id))return;var z=dp.getState(id);if(z=="inserted"||this._new_event){dp.setUpdated(id,false);return true;}
if(z=="deleted")return false;if(z=="true_deleted")return true;dp.setUpdated(id,true,"deleted");return false;});this.attachEvent("onEventChanged",function(id){if(!this._loading&&this.validId(id))
dp.setUpdated(id,true,"updated");});dp._getRowData=function(id,pref){var ev=this.obj.getEvent(id);var data={};for(var a in ev){if(a.indexOf("_")==0)continue;if(ev[a]&&ev[a].getUTCFullYear)
data[a]=this.obj.templates.xml_format(ev[a]);else
data[a]=ev[a];}
return data;};dp._clearUpdateFlag=function(){};dp.attachEvent("insertCallback",scheduler._update_callback);dp.attachEvent("updateCallback",scheduler._update_callback);dp.attachEvent("deleteCallback",function(upd,id){this.obj.setUserData(id,this.action_param,"true_deleted");this.obj.deleteEvent(id);});};scheduler.setUserData=function(id,name,value){if(id)
this.getEvent(id)[name]=value;else
this._userdata[name]=value;};scheduler.getUserData=function(id,name){return id?this.getEvent(id)[name]:this._userdata[name];};scheduler.setEventTextStyle=function(id,style){this.for_rendered(id,function(r){r.style.cssText+=";"+style;});var ev=this.getEvent(id);ev["_text_style"]=style;this.event_updated(ev);};scheduler.validId=function(id){return true;};scheduler._update_callback=function(upd,id){var data=scheduler.xmlNodeToJSON(upd.firstChild);data.text=data.text||data._tagvalue;data.start_date=scheduler.templates.xml_date(data.start_date);data.end_date=scheduler.templates.xml_date(data.end_date);scheduler.addEvent(data);};;scheduler.templates.calendar_month=scheduler.date.date_to_str("%F %Y");scheduler.templates.calendar_scale_date=scheduler.date.date_to_str("%D");scheduler.templates.calendar_date=scheduler.date.date_to_str("%d");scheduler.config.minicalendar={mark_events:true};scheduler._synced_minicalendars=[];scheduler.renderCalendar=function(obj,_prev,is_refresh){var cal=null;var date=obj.date||(new Date());if(typeof date=="string")
date=this.templates.api_date(date);if(!_prev){var cont=obj.container;var pos=obj.position;if(typeof cont=="string")
cont=document.getElementById(cont);if(typeof pos=="string")
pos=document.getElementById(pos);if(pos&&(typeof pos.left=="undefined")){var tpos=getOffset(pos);pos={top:tpos.top+pos.offsetHeight,left:tpos.left};}
if(!cont)
cont=scheduler._get_def_cont(pos);cal=this._render_calendar(cont,date,obj);cal.onclick=function(e){e=e||event;var src=e.target||e.srcElement;if(src.className.indexOf("dhx_month_head")!=-1){var pname=src.parentNode.className;if(pname.indexOf("dhx_after")==-1&&pname.indexOf("dhx_before")==-1){var newdate=scheduler.templates.xml_date(this.getAttribute("date"));newdate.setDate(parseInt(src.innerHTML,10));scheduler.unmarkCalendar(this);scheduler.markCalendar(this,newdate,"dhx_calendar_click");this._last_date=newdate;if(this.conf.handler)this.conf.handler.call(scheduler,newdate,this);}}};}else{cal=this._render_calendar(_prev.parentNode,date,obj,_prev);scheduler.unmarkCalendar(cal);}
if(scheduler.config.minicalendar.mark_events){var start=scheduler.date.month_start(date);var end=scheduler.date.add(start,1,"month");var evs=this.getEvents(start,end);var filter=this["filter_"+this._mode];for(var i=0;i<evs.length;i++){var ev=evs[i];if(filter&&!filter(ev.id,ev))
continue;var d=ev.start_date;if(d.valueOf()<start.valueOf())
d=start;d=scheduler.date.date_part(new Date(d.valueOf()));while(d<ev.end_date){this.markCalendar(cal,d,"dhx_year_event");d=this.date.add(d,1,"day");if(d.valueOf()>=end.valueOf())
break;}}}
this._markCalendarCurrentDate(cal);cal.conf=obj;if(obj.sync&&!is_refresh)
this._synced_minicalendars.push(cal);return cal;};scheduler._get_def_cont=function(pos){if(!this._def_count){this._def_count=document.createElement("DIV");this._def_count.className="dhx_minical_popup";this._def_count.onclick=function(e){(e||event).cancelBubble=true;};document.body.appendChild(this._def_count);}
this._def_count.style.left=pos.left+"px";this._def_count.style.top=pos.top+"px";this._def_count._created=new Date();return this._def_count;};scheduler._locateCalendar=function(cal,date){var table=cal.childNodes[2].childNodes[0];if(typeof date=="string")
date=scheduler.templates.api_date(date);var d=cal.week_start+date.getDate()-1;return table.rows[Math.floor(d/7)].cells[d%7].firstChild;};scheduler.markCalendar=function(cal,date,css){this._locateCalendar(cal,date).className+=" "+css;};scheduler.unmarkCalendar=function(cal,date,css){date=date||cal._last_date;css=css||"dhx_calendar_click";if(!date)return;var el=this._locateCalendar(cal,date);el.className=(el.className||"").replace(RegExp(css,"g"));};scheduler._week_template=function(width){var summ=(width||250);var left=0;var week_template=document.createElement("div");var dummy_date=this.date.week_start(new Date());for(var i=0;i<7;i++){this._cols[i]=Math.floor(summ/(7-i));this._render_x_header(i,left,dummy_date,week_template);dummy_date=this.date.add(dummy_date,1,"day");summ-=this._cols[i];left+=this._cols[i];}
week_template.lastChild.className+=" dhx_scale_bar_last";return week_template;};scheduler.updateCalendar=function(obj,sd){obj.conf.date=sd;this.renderCalendar(obj.conf,obj,true);};scheduler._mini_cal_arrows=["&nbsp","&nbsp"];scheduler._render_calendar=function(obj,sd,conf,previous){var ts=scheduler.templates;var temp=this._cols;this._cols=[];var temp2=this._mode;this._mode="calendar";var temp3=this._colsS;this._colsS={height:0};var temp4=new Date(this._min_date);var temp5=new Date(this._max_date);var temp6=new Date(scheduler._date);var temp7=ts.month_day;ts.month_day=ts.calendar_date;sd=this.date.month_start(sd);var week_template=this._week_template(obj.offsetWidth-1);var d;if(previous)
d=previous;else{d=document.createElement("DIV");d.className="dhx_cal_container dhx_mini_calendar";}
d.setAttribute("date",this.templates.xml_format(sd));d.innerHTML="<div class='dhx_year_month'></div><div class='dhx_year_week'>"+week_template.innerHTML+"</div><div class='dhx_year_body'></div>";d.childNodes[0].innerHTML=this.templates.calendar_month(sd);if(conf.navigation){var move_minicalendar_date=function(calendar,diff){var date=scheduler.date.add(calendar._date,diff,"month");scheduler.updateCalendar(calendar,date);if(scheduler._date.getMonth()==calendar._date.getMonth()&&scheduler._date.getFullYear()==calendar._date.getFullYear()){scheduler._markCalendarCurrentDate(calendar);}};var css_classnames=["dhx_cal_prev_button","dhx_cal_next_button"];var css_texts=["left:1px;top:2px;position:absolute;","left:auto; right:1px;top:2px;position:absolute;"];var diffs=[-1,1];var handler=function(diff){return function(){if(conf.sync){var calendars=scheduler._synced_minicalendars;for(var k=0;k<calendars.length;k++){move_minicalendar_date(calendars[k],diff);}}else{move_minicalendar_date(d,diff);}}};for(var j=0;j<2;j++){var arrow=document.createElement("DIV");arrow.className=css_classnames[j];arrow.style.cssText=css_texts[j];arrow.innerHTML=this._mini_cal_arrows[j];d.firstChild.appendChild(arrow);arrow.onclick=handler(diffs[j])}}
d._date=new Date(sd);d.week_start=(sd.getDay()-(this.config.start_on_monday?1:0)+7)%7;var dd=this.date.week_start(sd);this._reset_month_scale(d.childNodes[2],sd,dd);var r=d.childNodes[2].firstChild.rows;for(var k=r.length;k<6;k++){var last_row=r[r.length-1];r[0].parentNode.appendChild(last_row.cloneNode(true));var last_day_number=parseInt(last_row.childNodes[last_row.childNodes.length-1].childNodes[0].innerHTML);last_day_number=(last_day_number<10)?last_day_number:0;for(var ri=0;ri<r[k].childNodes.length;ri++){r[k].childNodes[ri].className="dhx_after";r[k].childNodes[ri].childNodes[0].innerHTML=scheduler.date.to_fixed(++last_day_number);}}
if(!previous)
obj.appendChild(d);d.childNodes[1].style.height=(d.childNodes[1].childNodes[0].offsetHeight-1)+"px";this._cols=temp;this._mode=temp2;this._colsS=temp3;this._min_date=temp4;this._max_date=temp5;scheduler._date=temp6;ts.month_day=temp7;return d;};scheduler.destroyCalendar=function(cal,force){if(!cal&&this._def_count&&this._def_count.firstChild){if(force||(new Date()).valueOf()-this._def_count._created.valueOf()>500)
cal=this._def_count.firstChild;}
if(!cal)return;cal.onclick=null;cal.innerHTML="";if(cal.parentNode)
cal.parentNode.removeChild(cal);if(this._def_count)
this._def_count.style.top="-1000px";};scheduler.isCalendarVisible=function(){if(this._def_count&&parseInt(this._def_count.style.top,10)>0)
return this._def_count;return false;};scheduler.attachEvent("onTemplatesReady",function(){dhtmlxEvent(document.body,"click",function(){scheduler.destroyCalendar();});});scheduler.templates.calendar_time=scheduler.date.date_to_str("%d-%m-%Y");scheduler.form_blocks.calendar_time={render:function(){var html="<input class='dhx_readonly' type='text' readonly='true'>";var cfg=scheduler.config;var dt=this.date.date_part(new Date());var last=24*60,first=0;if(cfg.limit_time_select){first=60*cfg.first_hour;last=60*cfg.last_hour+1;}
dt.setHours(first/60);html+=" <select>";for(var i=first;i<last;i+=this.config.time_step*1){var time=this.templates.time_picker(dt);html+="<option value='"+i+"'>"+time+"</option>";dt=this.date.add(dt,this.config.time_step,"minute");}
html+="</select>";var full_day=scheduler.config.full_day;return"<div style='height:30px;padding-top:0; font-size:inherit;' class='dhx_section_time'>"+html+"<span style='font-weight:normal; font-size:10pt;'> &nbsp;&ndash;&nbsp; </span>"+html+"</div>";},set_value:function(node,value,ev){var inputs=node.getElementsByTagName("input");var selects=node.getElementsByTagName("select");var _init_once=function(inp,date,number){inp.onclick=function(){scheduler.destroyCalendar(null,true);scheduler.renderCalendar({position:inp,date:new Date(this._date),navigation:true,handler:function(new_date){inp.value=scheduler.templates.calendar_time(new_date);inp._date=new Date(new_date);scheduler.destroyCalendar();if(scheduler.config.event_duration&&scheduler.config.auto_end_date&&number==0){_update_minical_select();}}});};};if(scheduler.config.full_day){if(!node._full_day){var html="<label class='dhx_fullday'><input type='checkbox' name='full_day' value='true'> "+scheduler.locale.labels.full_day+"&nbsp;</label></input>";if(!scheduler.config.wide_form)
html=node.previousSibling.innerHTML+html;node.previousSibling.innerHTML=html;node._full_day=true;}
var input=node.previousSibling.getElementsByTagName("input")[0];var isFulldayEvent=(scheduler.date.time_part(ev.start_date)==0&&scheduler.date.time_part(ev.end_date)==0);input.checked=isFulldayEvent;selects[0].disabled=input.checked;selects[1].disabled=input.checked;input.onclick=function(){if(input.checked==true){var obj={};scheduler.form_blocks.calendar_time.get_value(node,obj);var start_date=scheduler.date.date_part(obj.start_date);var end_date=scheduler.date.date_part(obj.end_date);if(+end_date==+start_date||(+end_date>=+start_date&&(ev.end_date.getHours()!=0||ev.end_date.getMinutes()!=0)))
end_date=scheduler.date.add(end_date,1,"day");}
var start=start_date||ev.start_date;var end=end_date||ev.end_date;_attach_action(inputs[0],start);_attach_action(inputs[1],end);selects[0].value=start.getHours()*60+start.getMinutes();selects[1].value=end.getHours()*60+end.getMinutes();selects[0].disabled=input.checked;selects[1].disabled=input.checked;};}
if(scheduler.config.event_duration&&scheduler.config.auto_end_date){function _update_minical_select(){start_date=scheduler.date.add(inputs[0]._date,selects[0].value,"minute");end_date=new Date(start_date.getTime()+(scheduler.config.event_duration*60*1000));inputs[1].value=scheduler.templates.calendar_time(end_date);inputs[1]._date=scheduler.date.date_part(new Date(end_date));selects[1].value=end_date.getHours()*60+end_date.getMinutes();}
selects[0].onchange=_update_minical_select;}
function _attach_action(inp,date,number){_init_once(inp,date,number);inp.value=scheduler.templates.calendar_time(date);inp._date=scheduler.date.date_part(new Date(date));}
_attach_action(inputs[0],ev.start_date,0);_attach_action(inputs[1],ev.end_date,1);_init_once=function(){};selects[0].value=ev.start_date.getHours()*60+ev.start_date.getMinutes();selects[1].value=ev.end_date.getHours()*60+ev.end_date.getMinutes();},get_value:function(node,ev){var inputs=node.getElementsByTagName("input");var selects=node.getElementsByTagName("select");ev.start_date=scheduler.date.add(inputs[0]._date,selects[0].value,"minute");ev.end_date=scheduler.date.add(inputs[1]._date,selects[1].value,"minute");if(ev.end_date<=ev.start_date)
ev.end_date=scheduler.date.add(ev.start_date,scheduler.config.time_step,"minute");},focus:function(node){}};scheduler.linkCalendar=function(calendar,datediff){var action=function(){var date=scheduler._date;var dateNew=new Date(date.valueOf());if(datediff)dateNew=datediff(dateNew);dateNew.setDate(1);scheduler.updateCalendar(calendar,dateNew);return true;};scheduler.attachEvent("onViewChange",action);scheduler.attachEvent("onXLE",action);scheduler.attachEvent("onEventAdded",action);scheduler.attachEvent("onEventChanged",action);scheduler.attachEvent("onAfterEventDelete",action);action();};scheduler._markCalendarCurrentDate=function(calendar){var date=scheduler._date;var mode=scheduler._mode;var month_start=scheduler.date.month_start(new Date(calendar._date));var month_end=scheduler.date.add(month_start,1,"month");if(mode=='day'||(this._props&&!!this._props[mode])){if(month_start.valueOf()<=date.valueOf()&&month_end>date){scheduler.markCalendar(calendar,date,"dhx_calendar_click");}}else if(mode=='week'){var dateNew=scheduler.date.week_start(new Date(date.valueOf()));for(var i=0;i<7;i++){if(month_start.valueOf()<=dateNew.valueOf()&&month_end>dateNew)
scheduler.markCalendar(calendar,dateNew,"dhx_calendar_click");dateNew=scheduler.date.add(dateNew,1,"day");}}};scheduler.attachEvent("onEventCancel",function(){scheduler.destroyCalendar(null,true);});;(function(){if(this.scheduler){var old_scheduler_dblclick=scheduler._on_dbl_click;scheduler._on_dbl_click=function(e,src){if(src&&!src.className){return;}else{old_scheduler_dblclick.apply(this,arguments);}};}}());openerp.web_calendar=function(instance){var _t=instance.web._t,_lt=instance.web._lt;var QWeb=instance.web.qweb;instance.web.views.add('calendar','instance.web_calendar.CalendarView');instance.web_calendar.CalendarView=instance.web.View.extend({template:"CalendarView",display_name:_lt('Calendar'),init:function(parent,dataset,view_id,options){var self=this;this._super(parent);this.ready=$.Deferred();this.set_default_options(options);this.dataset=dataset;this.model=dataset.model;this.fields_view={};this.view_id=view_id;this.view_type='calendar';this.has_been_loaded=$.Deferred();this.dataset_events=[];this.COLOR_PALETTE=['#f57900','#cc0000','#d400a8','#75507b','#3465a4','#73d216','#c17d11','#edd400','#fcaf3e','#ef2929','#ff00c9','#ad7fa8','#729fcf','#8ae234','#e9b96e','#fce94f','#ff8e00','#ff0000','#b0008c','#9000ff','#0078ff','#00ff00','#e6ff00','#ffff00','#905000','#9b0000','#840067','#510090','#0000c9','#009b00','#9abe00','#ffc900'];this.color_map={};this.last_search=[];this.range_start=null;this.range_stop=null;this.update_range_dates(Date.today());this.selected_filters=[];},view_loading:function(r){return this.load_calendar(r);},destroy:function(){scheduler.clearAll();this._super();},load_calendar:function(data){this.fields_view=data;this.$el.addClass(this.fields_view.arch.attrs['class']);this.calendar_fields={};this.ids=this.dataset.ids;this.color_values=[];this.info_fields=[];this.name=this.fields_view.name||this.fields_view.arch.attrs.string;this.view_id=this.fields_view.view_id;this.mode=this.fields_view.arch.attrs.mode;this.date_start=this.fields_view.arch.attrs.date_start;this.date_delay=this.fields_view.arch.attrs.date_delay;this.date_stop=this.fields_view.arch.attrs.date_stop;this.day_length=this.fields_view.arch.attrs.day_length||8;this.color_field=this.fields_view.arch.attrs.color;this.color_string=this.fields_view.fields[this.color_field]?this.fields_view.fields[this.color_field].string:_t("Filter");if(this.color_field&&this.selected_filters.length===0){var default_filter;if((default_filter=this.dataset.context['calendar_default_'+this.color_field])){this.selected_filters.push(default_filter+'');}}
this.fields=this.fields_view.fields;if(!this.date_start){throw new Error(_t("Calendar view has not defined 'date_start' attribute."));}
this.calendar_fields.date_start={'name':this.date_start,'kind':this.fields[this.date_start].type};if(this.date_delay){if(this.fields[this.date_delay].type!='float'){throw new Error(_t("Calendar view has a 'date_delay' type != float"));}
this.calendar_fields.date_delay={'name':this.date_delay,'kind':this.fields[this.date_delay].type};}
if(this.date_stop){this.calendar_fields.date_stop={'name':this.date_stop,'kind':this.fields[this.date_stop].type};}
for(var fld=0;fld<this.fields_view.arch.children.length;fld++){this.info_fields.push(this.fields_view.arch.children[fld].attrs.name);}
this.init_scheduler();if(!this.sidebar&&this.options.$sidebar){this.sidebar=new instance.web_calendar.Sidebar(this);this.has_been_loaded.then(this.sidebar.appendTo(this.$el.find('.oe_calendar_sidebar_container')));}
this.trigger('calendar_view_loaded',data);return this.has_been_loaded.resolve();},init_scheduler:function(){var self=this;scheduler.clearAll();if(this.fields[this.date_start]['type']=='time'){scheduler.config.xml_date="%H:%M:%S";}else{scheduler.config.xml_date="%Y-%m-%d %H:%i";}
scheduler.config.api_date="%Y-%m-%d %H:%i";scheduler.config.multi_day=true;scheduler.config.start_on_monday=Date.CultureInfo.firstDayOfWeek!==0;scheduler.config.time_step=30;scheduler.config.scroll_hour=8;scheduler.config.drag_resize=true;scheduler.config.drag_create=true;scheduler.config.mark_now=true;scheduler.config.day_date='%l %j';scheduler.config.details_on_create=false;scheduler.locale={date:{month_full:Date.CultureInfo.monthNames,month_short:Date.CultureInfo.abbreviatedMonthNames,day_full:Date.CultureInfo.dayNames,day_short:Date.CultureInfo.abbreviatedDayNames},labels:{dhx_cal_today_button:_t("Today"),day_tab:_t("Day"),week_tab:_t("Week"),month_tab:_t("Month"),new_event:_t("New event"),icon_save:_t("Save"),icon_cancel:_t("Cancel"),icon_details:_t("Details"),icon_edit:_t("Edit"),icon_delete:_t("Delete"),confirm_closing:"",confirm_deleting:_t("Event will be deleted permanently, are you sure?"),section_description:_t("Description"),section_time:_t("Time period"),full_day:_t("Full day"),confirm_recurring:_t("Do you want to edit the whole set of repeated events?"),section_recurring:_t("Repeat event"),button_recurring:_t("Disabled"),button_recurring_open:_t("Enabled"),agenda_tab:_t("Agenda"),date:_t("Date"),description:_t("Description"),year_tab:_t("Year"),week_agenda_tab:_t("Agenda")}};scheduler.init(this.$el.find('.oe_calendar')[0],null,this.mode||'month');scheduler.detachAllEvents();scheduler.attachEvent('onViewChange',this.proxy('view_changed'));scheduler.attachEvent('onEventChanged',this.proxy('quick_save'));scheduler.attachEvent('onEventDeleted',this.proxy('delete_event'));scheduler.attachEvent('onEventAdded',function(event_id,event_obj){var fn=event_obj._force_slow_create?'slow_create':'quick_create';self[fn].apply(self,arguments);});scheduler.attachEvent('onClick',function(event_id,mouse_event){if(!self.$el.find('.dhx_cal_editor').length&&self.current_mode()==='month'){self.open_event(event_id);}else{return true;}});scheduler.attachEvent('onDblClick',function(event_id,mouse_event){if(!self.$el.find('.dhx_cal_editor').length){self.open_event(event_id);}});scheduler.attachEvent('onEmptyClick',function(start_date,mouse_event){scheduler._loading=false;if(!self.$el.find('.dhx_cal_editor').length){var end_date=new Date(start_date);end_date.addHours(1);scheduler.addEvent({start_date:start_date,end_date:end_date,_force_slow_create:true,});}});scheduler.attachEvent("onBeforeLightbox",function(event_id){var index=self.dataset.get_id_index(event_id);if(index!==null){self.open_event(self.dataset.ids[index]);}else{self.slow_create(event_id,scheduler.getEvent(event_id));}
return false;});this.refresh_scheduler();this.$el.find(".dhx_cal_navline").removeAttr('style');instance.web.bus.on('resize',this,function(){self.$el.find(".dhx_cal_navline").removeAttr('style');});},view_changed:function(mode,date){this.$el.find('.oe_calendar').removeClass('oe_cal_day oe_cal_week oe_cal_month').addClass('oe_cal_'+mode);if(!date.between(this.range_start,this.range_stop)){this.update_range_dates(date);this.ranged_search();}
this.ready.resolve();},update_range_dates:function(date){this.range_start=date.clone().moveToFirstDayOfMonth();this.range_stop=this.range_start.clone().addMonths(1).addSeconds(-1);},refresh_scheduler:function(){scheduler.setCurrentView(scheduler._date);},reload_event:function(id){this.dataset.read_ids([id],_.keys(this.fields)).done(this.proxy('events_loaded'));},get_color:function(key){if(this.color_map[key]){return this.color_map[key];}
var index=_.keys(this.color_map).length%this.COLOR_PALETTE.length;var color=this.COLOR_PALETTE[index];this.color_map[key]=color;return color;},events_loaded:function(events,fn_filter,no_filter_reload){var self=this;var res_events=[],sidebar_items={};for(var e=0;e<events.length;e++){var evt=events[e];if(!evt[this.date_start]){break;}
if(this.color_field){var filter=evt[this.color_field];if(filter){var filter_value=(typeof filter==='object')?filter[0]:filter;if(typeof(fn_filter)==='function'&&!fn_filter(filter_value)){continue;}
var filter_item={value:filter_value,label:(typeof filter==='object')?filter[1]:filter,color:this.get_color(filter_value)};if(!sidebar_items[filter_value]){sidebar_items[filter_value]=filter_item;}
evt.color=filter_item.color;evt.textColor='#ffffff';}else{evt.textColor='#000000';}}
if(this.fields[this.date_start]['type']=='date'){evt[this.date_start]=instance.web.auto_str_to_date(evt[this.date_start]).set({hour:9}).toString('yyyy-MM-dd HH:mm:ss');}
if(this.date_stop&&evt[this.date_stop]&&this.fields[this.date_stop]['type']=='date'){evt[this.date_stop]=instance.web.auto_str_to_date(evt[this.date_stop]).set({hour:17}).toString('yyyy-MM-dd HH:mm:ss');}
res_events.push(this.convert_event(evt));}
scheduler.parse(res_events,'json');this.refresh_scheduler();if(!no_filter_reload&&this.sidebar){this.sidebar.filter.events_loaded(sidebar_items);}},convert_event:function(evt){var date_start=instance.web.str_to_datetime(evt[this.date_start]),date_stop=this.date_stop?instance.web.str_to_datetime(evt[this.date_stop]):null,date_delay=evt[this.date_delay]||1.0,res_text='';if(this.info_fields){res_text=_.map(this.info_fields,function(fld){if(evt[fld]instanceof Array)
return evt[fld][1];return evt[fld];});}
if(!date_stop&&date_delay){date_stop=date_start.clone().addHours(date_delay);}
var r={'start_date':date_start.toString('yyyy-MM-dd HH:mm:ss'),'end_date':date_stop.toString('yyyy-MM-dd HH:mm:ss'),'text':res_text.join(', '),'id':evt.id};if(evt.color){r.color=evt.color;}
if(evt.textColor){r.textColor=evt.textColor;}
return r;},get_event_data:function(event_obj){var data={name:event_obj.text};data[this.date_start]=instance.web.datetime_to_str(event_obj.start_date);if(this.date_stop){data[this.date_stop]=instance.web.datetime_to_str(event_obj.end_date);}
if(this.date_delay){var diff_seconds=Math.round((event_obj.end_date.getTime()-event_obj.start_date.getTime())/1000);data[this.date_delay]=diff_seconds/3600;}
return data;},do_search:function(domain,context,group_by){this.last_search=arguments;this.ranged_search();},ranged_search:function(){var self=this;scheduler.clearAll();$.when(this.has_been_loaded,this.ready).done(function(){self.dataset.read_slice(_.keys(self.fields),{offset:0,domain:self.get_range_domain(),context:self.last_search[1]}).done(function(events){self.dataset_events=events;self.events_loaded(events);});});},get_range_domain:function(){var format=instance.web.date_to_str,domain=this.last_search[0].slice(0);domain.unshift([this.date_start,'>=',format(this.range_start.clone().addDays(-6))]);domain.unshift([this.date_start,'<=',format(this.range_stop.clone().addDays(6))]);return domain;},do_show:function(){var self=this;$.when(this.has_been_loaded).done(function(){self.$el.show();self.do_push_state({});});},get_selected_ids:function(){return[];},current_mode:function(){return scheduler.getState().mode;},quick_save:function(event_id,event_obj){var self=this;var data=this.get_event_data(event_obj);delete(data.name);var index=this.dataset.get_id_index(event_id);if(index!==null){event_id=this.dataset.ids[index];this.dataset.write(event_id,data,{});}},quick_create:function(event_id,event_obj){var self=this;var data=this.get_event_data(event_obj);this.dataset.create(data).done(function(r){var id=r;self.dataset.ids.push(id);scheduler.changeEventId(event_id,id);self.reload_event(id);}).fail(function(r,event){event.preventDefault();self.slow_create(event_id,event_obj);});},get_form_popup_infos:function(){var parent=this.getParent();var infos={view_id:false,title:this.name,};if(parent instanceof instance.web.ViewManager){infos.view_id=parent.get_view_id('form');if(parent instanceof instance.web.ViewManagerAction&&parent.action&&parent.action.name){infos.title=parent.action.name;}}
return infos;},slow_create:function(event_id,event_obj){var self=this;if(this.current_mode()==='month'){event_obj['start_date'].addHours(8);if(event_obj._length===1){event_obj['end_date']=new Date(event_obj['start_date']);event_obj['end_date'].addHours(1);}else{event_obj['end_date'].addHours(-4);}}
var defaults={};_.each(this.get_event_data(event_obj),function(val,field_name){defaults['default_'+field_name]=val;});var something_saved=false;var pop=new instance.web.form.FormOpenPopup(this);var pop_infos=this.get_form_popup_infos();pop.show_element(this.dataset.model,null,this.dataset.get_context(defaults),{title:_.str.sprintf(_t("Create: %s"),pop_infos.title),disable_multiple_selection:true,view_id:pop_infos.view_id,});pop.on('closed',self,function(){if(!something_saved){scheduler.deleteEvent(event_id);}});pop.on('create_completed',self,function(id){something_saved=true;self.dataset.ids.push(id);scheduler.changeEventId(event_id,id);self.reload_event(id);});},open_event:function(event_id){var self=this;var index=this.dataset.get_id_index(event_id);if(index===null){var event_obj=scheduler.getEvent(event_id);scheduler.deleteEvent(event_id);scheduler.addEvent({start_date:event_obj.start_date,end_date:event_obj.end_date,text:event_obj.text,_force_slow_create:true,});}else{var pop=new instance.web.form.FormOpenPopup(this);var pop_infos=this.get_form_popup_infos();var id_from_dataset=this.dataset.ids[index];pop.show_element(this.dataset.model,id_from_dataset,this.dataset.get_context(),{title:_.str.sprintf(_t("Edit: %s"),pop_infos.title),view_id:pop_infos.view_id,});pop.on('write_completed',self,function(){self.reload_event(id_from_dataset);});}},delete_event:function(event_id,event_obj){var self=this;var index=this.dataset.get_id_index(event_id);if(index!==null){this.dataset.unlink(event_id);}},});instance.web_calendar.Sidebar=instance.web.Widget.extend({template:'CalendarView.sidebar',start:function(){this._super();this.mini_calendar=scheduler.renderCalendar({container:this.$el.find('.oe_calendar_mini')[0],navigation:true,date:scheduler._date,handler:function(date,calendar){scheduler.setCurrentView(date,'day');}});scheduler.linkCalendar(this.mini_calendar);this.filter=new instance.web_calendar.SidebarFilter(this,this.getParent());this.filter.appendTo(this.$el.find('.oe_calendar_filter'));}});instance.web_calendar.SidebarFilter=instance.web.Widget.extend({events:{'change input:checkbox':'filter_click'},init:function(parent,view){this._super(parent);this.view=view;},events_loaded:function(filters){var selected_filters=this.view.selected_filters.slice(0);this.$el.html(QWeb.render('CalendarView.sidebar.responsible',{filters:filters}));this.$('div.oe_calendar_responsible input').each(function(){if(_.indexOf(selected_filters,$(this).val())>-1){$(this).click();}});},filter_click:function(e){var self=this,responsibles=[],$e=$(e.target);this.view.selected_filters=[];this.$('div.oe_calendar_responsible input:checked').each(function(){responsibles.push($(this).val());self.view.selected_filters.push($(this).val());});scheduler.clearAll();if(responsibles.length){this.view.events_loaded(this.view.dataset_events,function(filter_value){return _.indexOf(responsibles,filter_value.toString())>-1;},true);}else{this.view.events_loaded(this.view.dataset_events,false,true);}}});};;openerp.base=function(instance){instance.base.apps_remote=null;instance.base.apps_client=null;var _t=instance.web._t;instance.base.Apps=instance.web.Widget.extend({template:'EmptyComponent',remote_action_id:'loempia.action_embed',failback_action_id:'base.open_module_tree',init:function(parent,action){this._super(parent,action);var options=action.params||{};if(options.apps_user){sessionStorage.setItem('apps.login',options.apps_user);}
if(options.apps_access_token){sessionStorage.setItem('apps.access_token',options.apps_access_token);}
this.params=options;},get_client:function(){var check_client_available=function(client){var d=$.Deferred();var i=new Image();i.onerror=function(){d.reject(client);};i.onload=function(){client.session.session_bind(client.origin).then(function(){client.authenticate().then(function(){d.resolve(client);},function(){if(client.login==='anonymous'){d.reject(client);}else{sessionStorage.removeItem('apps.login');sessionStorage.removeItem('apps.access_token');client.bind_crendentials(client.dbname,'anonymous','anonymous');client.authenticate().then(function(){d.resolve(client);},function(){d.reject(client);});}});});};i.src=_.str.sprintf('%s/web/static/src/img/sep-a.gif',client.origin);return d.promise();};if(instance.base.apps_client){return check_client_available(instance.base.apps_client);}else{var ICP=new instance.web.Model('ir.config_parameter');return ICP.call('get_param',['apps.server','https://apps.openerp.com/apps']).then(function(u){var link=$(_.str.sprintf('<a href="%s"></a>',u))[0];var host=_.str.sprintf('%s//%s',link.protocol,link.host);var dbname=link.pathname;if(dbname[0]==='/'){dbname=dbname.substr(1);}
var login=(sessionStorage?sessionStorage.getItem('apps.login'):null)||'anonymous';var passwd=(sessionStorage?sessionStorage.getItem('apps.access_token'):null)||'anonymous';if(_.isNull(instance.base.apps_remote)){instance.base.apps_remote=new openerp.init();}
var client=new instance.base.apps_remote.web.EmbeddedClient(null,host,dbname,login,passwd);instance.base.apps_client=client;return check_client_available(client);});}},destroy:function(){if(instance.base.apps_client){instance.base.apps_client.destroy();}
return this._super();},start:function(){var self=this;return self.get_client().done(function(client){client.replace(self.$el).done(function(){client.$el.removeClass('openerp');client.do_action(self.remote_action_id);});}).fail(function(client){self.do_warn(_t('OpenERP Apps Unreachable'),_t('Showing locally available modules'),true);self.rpc('/web/action/load',{action_id:self.failback_action_id}).done(function(action){self.do_action(action);instance.webclient.menu.open_action(action.id);});});},});instance.base.AppsUpdates=instance.base.Apps.extend({remote_action_id:'loempia.action_embed_updates'});instance.web.client_actions.add("apps","instance.base.Apps");instance.web.client_actions.add("apps.updates","instance.base.AppsUpdates");};;openerp.web_kanban=function(instance){var _t=instance.web._t,_lt=instance.web._lt;var QWeb=instance.web.qweb;instance.web.views.add('kanban','instance.web_kanban.KanbanView');instance.web_kanban.KanbanView=instance.web.View.extend({template:"KanbanView",display_name:_lt('Kanban'),default_nr_columns:1,view_type:"kanban",quick_create_class:"instance.web_kanban.QuickCreate",number_of_color_schemes:10,init:function(parent,dataset,view_id,options){this._super(parent,dataset,view_id,options);var self=this;_.defaults(this.options,{"quick_creatable":true,"creatable":true,"create_text":undefined,"read_only_mode":false,"confirm_on_delete":true,});this.fields_view={};this.fields_keys=[];this.group_by=null;this.group_by_field={};this.grouped_by_m2o=false;this.many2manys=[];this.state={groups:{},records:{}};this.groups=[];this.aggregates={};this.group_operators=['avg','max','min','sum','count'];this.qweb=new QWeb2.Engine();this.qweb.debug=instance.session.debug;this.qweb.default_dict=_.clone(QWeb.default_dict);this.has_been_loaded=$.Deferred();this.search_domain=this.search_context=this.search_group_by=null;this.currently_dragging={};this.limit=options.limit||40;this.add_group_mutex=new $.Mutex();},view_loading:function(r){return this.load_kanban(r);},start:function(){var self=this;this._super.apply(this,arguments);this.$el.on('click','.oe_kanban_dummy_cell',function(){if(self.$buttons){self.$buttons.find('.oe_kanban_add_column').openerpBounce();}});},destroy:function(){this._super.apply(this,arguments);$('html').off('click.kanban');},load_kanban:function(data){this.fields_view=data;this.$el.addClass(this.fields_view.arch.attrs['class']);this.$buttons=$(QWeb.render("KanbanView.buttons",{'widget':this}));if(this.options.$buttons){this.$buttons.appendTo(this.options.$buttons);}else{this.$el.find('.oe_kanban_buttons').replaceWith(this.$buttons);}
this.$buttons.on('click','button.oe_kanban_button_new',this.do_add_record).on('click','.oe_kanban_add_column',this.do_add_group);this.$groups=this.$el.find('.oe_kanban_groups tr');this.fields_keys=_.keys(this.fields_view.fields);this.add_qweb_template();this.has_been_loaded.resolve();this.trigger('kanban_view_loaded',data);return $.when();},_is_quick_create_enabled:function(){if(!this.options.quick_creatable||!this.is_action_enabled('create'))
return false;if(this.fields_view.arch.attrs.quick_create!==undefined)
return JSON.parse(this.fields_view.arch.attrs.quick_create);return!!this.group_by;},is_action_enabled:function(action){if(action==='create'&&!this.options.creatable)
return false;return this._super(action);},add_qweb_template:function(){for(var i=0,ii=this.fields_view.arch.children.length;i<ii;i++){var child=this.fields_view.arch.children[i];if(child.tag==="templates"){this.transform_qweb_template(child);this.qweb.add_template(instance.web.json_node_to_xml(child));break;}else if(child.tag==='field'){this.extract_aggregates(child);}}},extract_aggregates:function(node){for(var j=0,jj=this.group_operators.length;j<jj;j++){if(node.attrs[this.group_operators[j]]){this.aggregates[node.attrs.name]=node.attrs[this.group_operators[j]];break;}}},transform_qweb_template:function(node){var qweb_add_if=function(node,condition){if(node.attrs[QWeb.prefix+'-if']){condition=_.str.sprintf("(%s) and (%s)",node.attrs[QWeb.prefix+'-if'],condition);}
node.attrs[QWeb.prefix+'-if']=condition;};if(node.tag&&node.attrs.modifiers){var modifiers=JSON.parse(node.attrs.modifiers||'{}');if(modifiers.invisible){qweb_add_if(node,_.str.sprintf("!kanban_compute_domain(%s)",JSON.stringify(modifiers.invisible)));}}
switch(node.tag){case'field':if(this.fields_view.fields[node.attrs.name].type==='many2many'){if(_.indexOf(this.many2manys,node.attrs.name)<0){this.many2manys.push(node.attrs.name);}
node.tag='div';node.attrs['class']=(node.attrs['class']||'')+' oe_form_field oe_tags';}else{node.tag=QWeb.prefix;node.attrs[QWeb.prefix+'-esc']='record.'+node.attrs['name']+'.value';}
break;case'button':case'a':var type=node.attrs.type||'';if(_.indexOf('action,object,edit,open,delete'.split(','),type)!==-1){_.each(node.attrs,function(v,k){if(_.indexOf('icon,type,name,args,string,context,states,kanban_states'.split(','),k)!=-1){node.attrs['data-'+k]=v;delete(node.attrs[k]);}});if(node.attrs['data-string']){node.attrs.title=node.attrs['data-string'];}
if(node.attrs['data-icon']){node.children=[{tag:'img',attrs:{src:instance.session.prefix+'/web/static/src/img/icons/'+node.attrs['data-icon']+'.png',width:'16',height:'16'}}];}
if(node.tag=='a'){node.attrs.href='#';}else{node.attrs.type='button';}
node.attrs['class']=(node.attrs['class']||'')+' oe_kanban_action oe_kanban_action_'+node.tag;}
break;}
if(node.children){for(var i=0,ii=node.children.length;i<ii;i++){this.transform_qweb_template(node.children[i]);}}},do_add_record:function(){this.dataset.index=null;this.do_switch_view('form');},do_add_group:function(){var self=this;self.do_action({name:_t("Add column"),res_model:self.group_by_field.relation,views:[[false,'form']],type:'ir.actions.act_window',target:"new",context:self.dataset.get_context(),flags:{action_buttons:true,}});var am=instance.webclient.action_manager;var form=am.dialog_widget.views.form.controller;form.on("on_button_cancel",am.dialog,am.dialog.close);form.on('record_created',self,function(r){(new instance.web.DataSet(self,self.group_by_field.relation)).name_get([r]).done(function(new_record){am.dialog.close();var domain=self.dataset.domain.slice(0);domain.push([self.group_by,'=',new_record[0][0]]);var dataset=new instance.web.DataSetSearch(self,self.dataset.model,self.dataset.get_context(),domain);var datagroup={get:function(key){return this[key];},value:new_record[0],length:0,aggregates:{},};var new_group=new instance.web_kanban.KanbanGroup(self,[],datagroup,dataset);self.do_add_groups([new_group]).done(function(){$(window).scrollTo(self.groups.slice(-1)[0].$el,{axis:'x'});});});});},do_search:function(domain,context,group_by){var self=this;this.$el.find('.oe_view_nocontent').remove();this.search_domain=domain;this.search_context=context;this.search_group_by=group_by;return $.when(this.has_been_loaded).then(function(){self.group_by=group_by.length?group_by[0]:self.fields_view.arch.attrs.default_group_by;self.group_by_field=self.fields_view.fields[self.group_by]||{};self.grouped_by_m2o=(self.group_by_field.type==='many2one');self.$buttons.find('.oe_alternative').toggle(self.grouped_by_m2o);self.$el.toggleClass('oe_kanban_grouped_by_m2o',self.grouped_by_m2o);var grouping_fields=self.group_by?[self.group_by].concat(_.keys(self.aggregates)):undefined;var grouping=new instance.web.Model(self.dataset.model,context,domain).query().group_by(grouping_fields);return $.when(grouping).done(function(groups){if(groups){self.do_process_groups(groups);}else{self.do_process_dataset();}});});},do_process_groups:function(groups){var self=this;this.$el.removeClass('oe_kanban_ungrouped').addClass('oe_kanban_grouped');this.add_group_mutex.exec(function(){self.do_clear_groups();self.dataset.ids=[];if(!groups.length){self.no_result();return false;}
var remaining=groups.length-1,groups_array=[];return $.when.apply(null,_.map(groups,function(group,index){var dataset=new instance.web.DataSetSearch(self,self.dataset.model,new instance.web.CompoundContext(self.dataset.get_context(),group.model.context()),group.model.domain());return dataset.read_slice(self.fields_keys.concat(['__last_update']),{'limit':self.limit}).then(function(records){self.dataset.ids.push.apply(self.dataset.ids,dataset.ids);groups_array[index]=new instance.web_kanban.KanbanGroup(self,records,group,dataset);if(!remaining--){self.dataset.index=self.dataset.size()?0:null;return self.do_add_groups(groups_array);}});}));});},do_process_dataset:function(){var self=this;this.$el.removeClass('oe_kanban_grouped').addClass('oe_kanban_ungrouped');this.add_group_mutex.exec(function(){var def=$.Deferred();self.do_clear_groups();self.dataset.read_slice(self.fields_keys.concat(['__last_update']),{'limit':self.limit}).done(function(records){var kgroup=new instance.web_kanban.KanbanGroup(self,records,null,self.dataset);self.do_add_groups([kgroup]).done(function(){if(_.isEmpty(records)){self.no_result();}
def.resolve();});}).done(null,function(){def.reject();});return def;});},do_reload:function(){this.do_search(this.search_domain,this.search_context,this.search_group_by);},do_clear_groups:function(){var groups=this.groups.slice(0);this.groups=[];_.each(groups,function(group){group.destroy();});},do_add_groups:function(groups){var self=this;var $parent=this.$el.parent();this.$el.detach();_.each(groups,function(group){self.groups[group.undefined_title?'unshift':'push'](group);});var $last_td=self.$el.find('.oe_kanban_groups_headers td:last');var groups_started=_.map(this.groups,function(group){if(!group.is_started){return group.insertBefore($last_td);}});return $.when.apply(null,groups_started).done(function(){self.on_groups_started();self.$el.appendTo($parent);_.each(self.groups,function(group){group.compute_cards_auto_height();});});},on_groups_started:function(){var self=this;if(this.group_by){var $columns=this.$el.find('.oe_kanban_column .oe_kanban_column_cards');$columns.sortable({handle:'.oe_kanban_draghandle',start:function(event,ui){self.currently_dragging.index=ui.item.parent().children('.oe_kanban_record').index(ui.item);self.currently_dragging.group=ui.item.parents('.oe_kanban_column:first').data('widget');ui.item.find('*').on('click.prevent',function(ev){return false;});ui.placeholder.height(ui.item.height());},revert:150,stop:function(event,ui){var record=ui.item.data('widget');var old_index=self.currently_dragging.index;var new_index=ui.item.parent().children('.oe_kanban_record').index(ui.item);var old_group=self.currently_dragging.group;var new_group=ui.item.parents('.oe_kanban_column:first').data('widget');if(!(old_group.title===new_group.title&&old_group.value===new_group.value&&old_index==new_index)){self.on_record_moved(record,old_group,old_index,new_group,new_index);}
setTimeout(function(){ui.item.find('*').off('click.prevent');},0);},scroll:false});$columns.sortable({connectWith:$columns});var start_index;if(this.grouped_by_m2o){this.$('.oe_kanban_groups_headers').sortable({items:'.oe_kanban_group_header',helper:'clone',axis:'x',opacity:0.5,scroll:false,start:function(event,ui){start_index=ui.item.index();self.$('.oe_kanban_record, .oe_kanban_quick_create').css({visibility:'hidden'});},stop:function(event,ui){var stop_index=ui.item.index();if(start_index!==stop_index){var $start_column=$('.oe_kanban_groups_records .oe_kanban_column').eq(start_index);var $stop_column=$('.oe_kanban_groups_records .oe_kanban_column').eq(stop_index);var method=(start_index>stop_index)?'insertBefore':'insertAfter';$start_column[method]($stop_column);var tmp_group=self.groups.splice(start_index,1)[0];self.groups.splice(stop_index,0,tmp_group);var new_sequence=_.pluck(self.groups,'value');(new instance.web.DataSet(self,self.group_by_field.relation)).resequence(new_sequence).done(function(r){if(r===false){console.error("Kanban: could not resequence model '%s'. Probably no 'sequence' field.",self.group_by_field.relation);}});}
self.$('.oe_kanban_record, .oe_kanban_quick_create').css({visibility:'visible'});}});}}else{this.$el.find('.oe_kanban_draghandle').removeClass('oe_kanban_draghandle');}
this.postprocess_m2m_tags();},on_record_moved:function(record,old_group,old_index,new_group,new_index){var self=this;$.fn.tipsy.clear();$(old_group.$el).add(new_group.$el).find('.oe_kanban_aggregates, .oe_kanban_group_length').hide();if(old_group===new_group){new_group.records.splice(old_index,1);new_group.records.splice(new_index,0,record);new_group.do_save_sequences();}else{old_group.records.splice(old_index,1);new_group.records.splice(new_index,0,record);record.group=new_group;var data={};data[this.group_by]=new_group.value;this.dataset.write(record.id,data,{}).done(function(){record.do_reload();new_group.do_save_sequences();}).fail(function(error,evt){evt.preventDefault();alert(_t("An error has occured while moving the record to this group: ")+data.fault_code);self.do_reload();});}},do_show:function(){if(this.$buttons){this.$buttons.show();}
this.do_push_state({});return this._super();},do_hide:function(){if(this.$buttons){this.$buttons.hide();}
return this._super();},open_record:function(id,editable){if(this.dataset.select_id(id)){this.do_switch_view('form',null,{mode:editable?"edit":undefined});}else{this.do_warn("Kanban: could not find id#"+id);}},no_result:function(){if(this.groups.group_by||!this.options.action||!this.options.action.help){return;}
this.$el.find('.oe_view_nocontent').remove();this.$el.prepend($('<div class="oe_view_nocontent">').html(this.options.action.help));var create_nocontent=this.$buttons;this.$el.find('.oe_view_nocontent').click(function(){create_nocontent.openerpBounce();});},postprocess_m2m_tags:function(){var self=this;if(!this.many2manys.length){return;}
var relations={};this.groups.forEach(function(group){group.records.forEach(function(record){self.many2manys.forEach(function(name){var field=record.record[name];var $el=record.$('.oe_form_field.oe_tags[name='+name+']').empty();if(!relations[field.relation]){relations[field.relation]={ids:[],elements:{}};}
var rel=relations[field.relation];field.raw_value.forEach(function(id){rel.ids.push(id);if(!rel.elements[id]){rel.elements[id]=[];}
rel.elements[id].push($el[0]);});});});});_.each(relations,function(rel,rel_name){var dataset=new instance.web.DataSetSearch(self,rel_name,self.dataset.get_context());dataset.name_get(_.uniq(rel.ids)).done(function(result){result.forEach(function(nameget){$(rel.elements[nameget[0]]).append('<span class="oe_tag">'+_.str.escapeHTML(nameget[1])+'</span>');});});});}});function get_class(name){return new instance.web.Registry({'tmp':name}).get_object("tmp");}
instance.web_kanban.KanbanGroup=instance.web.Widget.extend({template:'KanbanView.group_header',init:function(parent,records,group,dataset){var self=this;this._super(parent);this.$has_been_started=$.Deferred();this.view=parent;this.group=group;this.dataset=dataset;this.dataset_offset=0;this.aggregates={};this.value=this.title=null;if(this.group){this.value=group.get('value');this.title=group.get('value');if(this.value instanceof Array){this.title=this.value[1];this.value=this.value[0];}
var field=this.view.group_by_field;if(!_.isEmpty(field)){try{this.title=instance.web.format_value(group.get('value'),field,false);}catch(e){}}
_.each(this.view.aggregates,function(value,key){self.aggregates[value]=group.get('aggregates')[key];});}
if(this.title===false){this.title=_t('Undefined');this.undefined_title=true;}
var key=this.view.group_by+'-'+this.value;if(!this.view.state.groups[key]){this.view.state.groups[key]={folded:group?group.get('folded'):false};}
this.state=this.view.state.groups[key];this.$records=null;this.records=[];this.$has_been_started.done(function(){self.do_add_records(records);});},start:function(){var self=this,def=this._super();if(!self.view.group_by){self.$el.addClass("oe_kanban_no_group");self.quick=new(get_class(self.view.quick_create_class))(this,self.dataset,{},false).on('added',self,self.proxy('quick_created'));self.quick.replace($(".oe_kanban_no_group_qc_placeholder"));}
this.$records=$(QWeb.render('KanbanView.group_records_container',{widget:this}));this.$records.insertBefore(this.view.$el.find('.oe_kanban_groups_records td:last'));this.$el.on('click','.oe_kanban_group_dropdown li a',function(ev){var fn='do_action_'+$(ev.target).data().action;if(typeof(self[fn])==='function'){self[fn]($(ev.target));}});this.$el.find('.oe_kanban_add').click(function(){if(self.quick){return self.quick.trigger('close');}
var ctx={};ctx['default_'+self.view.group_by]=self.value;self.quick=new(get_class(self.view.quick_create_class))(this,self.dataset,ctx,true).on('added',self,self.proxy('quick_created')).on('close',self,function(){this.quick.destroy();delete this.quick;});self.quick.appendTo($(".oe_kanban_group_list_header",self.$records));self.quick.focus();});this.$records.on('click','.oe_kanban_show_more',this.do_show_more);if(this.state.folded){this.do_toggle_fold();}
this.$el.data('widget',this);this.$records.data('widget',this);this.$has_been_started.resolve();var add_btn=this.$el.find('.oe_kanban_add');add_btn.tipsy({delayIn:500,delayOut:1000});this.$records.find(".oe_kanban_column_cards").click(function(ev){if(ev.target==ev.currentTarget){if(!self.state.folded){add_btn.openerpBounce();}}});this.is_started=true;return def;},compute_cards_auto_height:function(){if(!this.view.group_by){var min_height=0;var els=[];_.each(this.records,function(r){var $e=r.$el.children(':first:not(.oe_kanban_no_auto_height)').css('min-height',0);if($e.length){els.push($e[0]);min_height=Math.max(min_height,$e.outerHeight());}});$(els).css('min-height',min_height);}},destroy:function(){this._super();if(this.$records){this.$records.remove();}},do_show_more:function(evt){var self=this;var ids=self.view.dataset.ids.splice(0);return this.dataset.read_slice(this.view.fields_keys.concat(['__last_update']),{'limit':self.view.limit,'offset':self.dataset_offset+=self.view.limit}).then(function(records){self.view.dataset.ids=ids.concat(self.dataset.ids);self.do_add_records(records);self.compute_cards_auto_height();self.view.postprocess_m2m_tags();return records;});},do_add_records:function(records,prepend){var self=this;var $list_header=this.$records.find('.oe_kanban_group_list_header');var $show_more=this.$records.find('.oe_kanban_show_more');var $cards=this.$records.find('.oe_kanban_column_cards');_.each(records,function(record){var rec=new instance.web_kanban.KanbanRecord(self,record);if(!prepend){rec.appendTo($cards);self.records.push(rec);}else{rec.prependTo($cards);self.records.unshift(rec);}});if($show_more.length){var size=this.dataset.size();$show_more.toggle(this.records.length<size).find('.oe_kanban_remaining').text(size-this.records.length);}},remove_record:function(id,remove_from_dataset){for(var i=0;i<this.records.length;i++){if(this.records[i]['id']===id){this.records.splice(i,1);i--;}}},do_toggle_fold:function(compute_width){this.$el.add(this.$records).toggleClass('oe_kanban_group_folded');this.state.folded=this.$el.is('.oe_kanban_group_folded');this.$("ul.oe_kanban_group_dropdown li a[data-action=toggle_fold]").text((this.state.folded)?_t("Unfold"):_t("Fold"));},do_action_toggle_fold:function(){this.do_toggle_fold();},do_action_edit:function(){var self=this;self.do_action({res_id:this.value,name:_t("Edit column"),res_model:self.view.group_by_field.relation,views:[[false,'form']],type:'ir.actions.act_window',target:"new",flags:{action_buttons:true,}});var am=instance.webclient.action_manager;var form=am.dialog_widget.views.form.controller;form.on("on_button_cancel",am.dialog,am.dialog.close);form.on('record_saved',self,function(){am.dialog.close();self.view.do_reload();});},do_action_delete:function(){var self=this;if(confirm(_t("Are you sure to remove this column ?"))){(new instance.web.DataSet(self,self.view.group_by_field.relation)).unlink([self.value]).done(function(r){self.view.do_reload();});}},do_save_sequences:function(){var self=this;if(_.indexOf(this.view.fields_keys,'sequence')>-1){var new_sequence=_.pluck(this.records,'id');self.view.dataset.resequence(new_sequence);}},quick_created:function(record){var id=record,self=this;this.dataset.read_ids([id],this.view.fields_keys).done(function(records){self.view.dataset.ids.push(id);self.do_add_records(records,true);});}});instance.web_kanban.KanbanRecord=instance.web.Widget.extend({template:'KanbanView.record',init:function(parent,record){this._super(parent);this.group=parent;this.view=parent.view;this.id=null;this.set_record(record);if(!this.view.state.records[this.id]){this.view.state.records[this.id]={folded:false};}
this.state=this.view.state.records[this.id];},set_record:function(record){var self=this;this.id=record.id;this.values={};_.each(record,function(v,k){self.values[k]={value:v};});this.record=this.transform_record(record);},start:function(){this._super();this.$el.data('widget',this);this.bind_events();},transform_record:function(record){var self=this,new_record={};_.each(record,function(value,name){var r=_.clone(self.view.fields_view.fields[name]||{});if((r.type==='date'||r.type==='datetime')&&value){r.raw_value=instance.web.auto_str_to_date(value);}else{r.raw_value=value;}
r.value=instance.web.format_value(value,r);new_record[name]=r;});return new_record;},renderElement:function(){this.qweb_context={instance:instance,record:this.record,widget:this,read_only_mode:this.view.options.read_only_mode,};for(var p in this){if(_.str.startsWith(p,'kanban_')){this.qweb_context[p]=_.bind(this[p],this);}}
var $el=instance.web.qweb.render(this.template,{'widget':this,'content':this.view.qweb.render('kanban-box',this.qweb_context)});this.replaceElement($el);},bind_events:function(){var self=this;this.setup_color_picker();this.$el.find('[tooltip]').tipsy({delayIn:500,delayOut:0,fade:true,title:function(){var template=$(this).attr('tooltip');if(!self.view.qweb.has_template(template)){return false;}
return self.view.qweb.render(template,self.qweb_context);},gravity:'s',html:true,opacity:0.8,trigger:'hover'});if(!this.$el.find('.oe_kanban_draghandle').length){this.$el.children(':first').toggleClass('oe_kanban_draghandle',this.view.is_action_enabled('edit'));}
this.$el.find('.oe_kanban_action').click(function(ev){ev.preventDefault();var $action=$(this),type=$action.data('type')||'button',method='do_action_'+(type==='action'?'object':type);if((type==='edit'||type==='delete')&&!self.view.is_action_enabled(type)){self.view.open_record(self.id,true);}else if(_.str.startsWith(type,'switch_')){self.view.do_switch_view(type.substr(7));}else if(typeof self[method]==='function'){self[method]($action);}else{self.do_warn("Kanban: no action for type : "+type);}});if(this.$el.find('.oe_kanban_global_click,.oe_kanban_global_click_edit').length){this.$el.on('click',function(ev){if(!ev.isTrigger&&!$._data(ev.target,'events')){var trigger=true;var elem=ev.target;var ischild=true;var children=[];while(elem){var events=$._data(elem,'events');if(elem==ev.currentTarget){ischild=false;}
if(ischild){children.push(elem);if(events&&events.click){trigger=false;}}
if(trigger&&events&&events.click){_.each(events.click,function(click_event){if(click_event.selector){_.each(children,function(child){if($(child).is(click_event.selector)){trigger=false;}});}});}
elem=elem.parentElement;}
if(trigger){self.on_card_clicked(ev);}}});}},on_card_clicked:function(ev){if(this.$el.find('.oe_kanban_global_click_edit').size()>0)
this.do_action_edit();else
this.do_action_open();},setup_color_picker:function(){var self=this;var $el=this.$el.find('ul.oe_kanban_colorpicker');if($el.length){$el.html(QWeb.render('KanbanColorPicker',{widget:this}));$el.on('click','a',function(ev){ev.preventDefault();var color_field=$(this).parents('.oe_kanban_colorpicker').first().data('field')||'color';var data={};data[color_field]=$(this).data('color');self.view.dataset.write(self.id,data,{}).done(function(){self.record[color_field]=$(this).data('color');self.do_reload();});});}},do_action_delete:function($action){var self=this;function do_it(){return $.when(self.view.dataset.unlink([self.id])).done(function(){self.group.remove_record(self.id);self.destroy();});}
if(this.view.options.confirm_on_delete){if(confirm(_t("Are you sure you want to delete this record ?"))){return do_it();}}else
return do_it();},do_action_edit:function($action){this.view.open_record(this.id,true);},do_action_open:function($action){this.view.open_record(this.id);},do_action_object:function($action){var button_attrs=$action.data();this.view.do_execute_action(button_attrs,this.view.dataset,this.id,this.do_reload);},do_reload:function(){var self=this;this.view.dataset.read_ids([this.id],this.view.fields_keys.concat(['__last_update'])).done(function(records){if(records.length){self.set_record(records[0]);self.renderElement();self.$el.data('widget',self);self.bind_events();self.group.compute_cards_auto_height();self.view.postprocess_m2m_tags();}else{self.destroy();}});},kanban_getcolor:function(variable){var index=0;switch(typeof(variable)){case'string':for(var i=0,ii=variable.length;i<ii;i++){index+=variable.charCodeAt(i);}
break;case'number':index=Math.round(variable);break;default:return'';}
var color=(index%this.view.number_of_color_schemes);return color;},kanban_color:function(variable){var color=this.kanban_getcolor(variable);return color===''?'':'oe_kanban_color_'+color;},kanban_gravatar:function(email,size){size=size||22;email=_.str.trim(email||'').toLowerCase();var default_=_.str.isBlank(email)?'mm':'identicon';var email_md5=$.md5(email);return'http://www.gravatar.com/avatar/'+email_md5+'.png?s='+size+'&d='+default_;},kanban_image:function(model,field,id,cache,options){options=options||{};var url;if(this.record[field]&&this.record[field].value&&!instance.web.form.is_bin_size(this.record[field].value)){url='data:image/png;base64,'+this.record[field].value;}else if(this.record[field]&&!this.record[field].value){url="/web/static/src/img/placeholder.png";}else{id=JSON.stringify(id);if(options.preview_image)
field=options.preview_image;url=this.session.url('/web/binary/image',{model:model,field:field,id:id});if(cache!==undefined){url+='&cache='+parseInt(cache,10);}}
return url;},kanban_text_ellipsis:function(s,size){size=size||160;if(!s){return'';}else if(s.length<=size){return s;}else{return s.substr(0,size)+'...';}},kanban_compute_domain:function(domain){return instance.web.form.compute_domain(domain,this.values);}});instance.web_kanban.QuickCreate=instance.web.Widget.extend({template:'KanbanView.quick_create',init:function(parent,dataset,context,buttons){this._super(parent);this._dataset=dataset;this._buttons=buttons||false;this._context=context||{};},start:function(){var self=this;self.$input=this.$el.find('input');self.$input.keyup(function(event){if(event.keyCode==13){self.quick_add();}});$(".oe_kanban_quick_create_add",this.$el).click(function(){self.quick_add();self.focus();});$(".oe_kanban_quick_create_close",this.$el).click(function(ev){ev.preventDefault();self.trigger('close');});self.$input.keyup(function(e){if(e.keyCode==27&&self._buttons){self.trigger('close');}});},focus:function(){this.$el.find('input').focus();},quick_add:function(){var self=this;var val=this.$input.val();if(/^\s*$/.test(val)){return;}
this._dataset.call('name_create',[val,new instance.web.CompoundContext(this._dataset.get_context(),this._context)]).then(function(record){self.$input.val("");self.trigger('added',record[0]);},function(error,event){event.preventDefault();return self.slow_create();});},slow_create:function(){var self=this;var pop=new instance.web.form.SelectCreatePopup(this);pop.select_element(self._dataset.model,{title:_t("Create: ")+(this.string||this.name),initial_view:"form",disable_multiple_selection:true},[],{"default_name":self.$input.val()});pop.on("elements_selected",self,function(element_ids){self.$input.val("");self.trigger('added',element_ids[0]);});}});};;openerp.auth_oauth=function(instance){var QWeb=instance.web.qweb;instance.web.Login.include({start:function(parent,params){var self=this;var d=this._super.apply(this,arguments);this.$el.on('click','a.zocial',this.on_oauth_sign_in);this.oauth_providers=[];if(this.params.oauth_error===1){this.do_warn("Sign up error.","Sign up is not allowed on this database.");}else if(this.params.oauth_error===2){this.do_warn("Authentication error","");}
return d.done(this.do_oauth_load).fail(function(){self.do_oauth_load([]);});},on_db_loaded:function(result){this._super.apply(this,arguments);this.$("form [name=db]").change(this.do_oauth_load);},do_oauth_load:function(){var db=this.$("form [name=db]").val();if(db){this.rpc("/auth_oauth/list_providers",{dbname:db}).done(this.on_oauth_loaded);}},on_oauth_loaded:function(result){this.oauth_providers=result;var params=$.deparam($.param.querystring());if(this.oauth_providers.length===1&&params.type==='signup'){this.do_oauth_sign_in(this.oauth_providers[0]);}else{this.$('.oe_oauth_provider_login_button').remove();var buttons=QWeb.render("auth_oauth.Login.button",{"widget":this});this.$(".oe_login_pane form ul").after(buttons);}},on_oauth_sign_in:function(ev){ev.preventDefault();var index=$(ev.target).data('index');var provider=this.oauth_providers[index];return this.do_oauth_sign_in(provider);},do_oauth_sign_in:function(provider){var return_url=_.str.sprintf('%s//%s/auth_oauth/signin',location.protocol,location.host);if(instance.session.debug){return_url+='?debug';}
var state=this._oauth_state(provider);var params={response_type:'token',client_id:provider.client_id,redirect_uri:return_url,scope:provider.scope,state:JSON.stringify(state),};var url=provider.auth_endpoint+'?'+$.param(params);window.location=url;},_oauth_state:function(provider){var dbname=this.$("form [name=db]").val();return{d:dbname,p:provider.id,};},});};;(function($){$.expander={version:'1.4.2',defaults:{slicePoint:100,preserveWords:true,widow:4,expandText:'read more',expandPrefix:'&hellip; ',expandAfterSummary:false,summaryClass:'summary',detailClass:'details',moreClass:'read-more',lessClass:'read-less',collapseTimer:0,expandEffect:'fadeIn',expandSpeed:250,collapseEffect:'fadeOut',collapseSpeed:200,userCollapse:true,userCollapseText:'read less',userCollapsePrefix:' ',onSlice:null,beforeExpand:null,afterExpand:null,onCollapse:null}};$.fn.expander=function(options){var meth='init';if(typeof options=='string'){meth=options;options={};}
var opts=$.extend({},$.expander.defaults,options),rSelfClose=/^<(?:area|br|col|embed|hr|img|input|link|meta|param).*>$/i,rAmpWordEnd=opts.wordEnd||/(&(?:[^;]+;)?|[a-zA-Z\u00C0-\u0100]+)$/,rOpenCloseTag=/<\/?(\w+)[^>]*>/g,rOpenTag=/<(\w+)[^>]*>/g,rCloseTag=/<\/(\w+)>/g,rLastCloseTag=/(<\/[^>]+>)\s*$/,rTagPlus=/^<[^>]+>.?/,delayedCollapse;var methods={init:function(){this.each(function(){var i,l,tmp,newChar,summTagless,summOpens,summCloses,lastCloseTag,detailText,detailTagless,$thisDetails,$readMore,openTagsForDetails=[],closeTagsForsummaryText=[],defined={},thisEl=this,$this=$(this),$summEl=$([]),o=$.meta?$.extend({},opts,$this.data()):opts,hasDetails=!!$this.find('.'+o.detailClass).length,hasBlocks=!!$this.find('*').filter(function(){var display=$(this).css('display');return(/^block|table|list/).test(display);}).length,el=hasBlocks?'div':'span',detailSelector=el+'.'+o.detailClass,moreSelector='span.'+o.moreClass,expandSpeed=o.expandSpeed||0,allHtml=$.trim($this.html()),allText=$.trim($this.text()),summaryText=allHtml.slice(0,o.slicePoint);if($.data(this,'expander')){return;}
$.data(this,'expander',true);$.each(['onSlice','beforeExpand','afterExpand','onCollapse'],function(index,val){defined[val]=$.isFunction(o[val]);});summaryText=backup(summaryText);summTagless=summaryText.replace(rOpenCloseTag,'').length;while(summTagless<o.slicePoint){newChar=allHtml.charAt(summaryText.length);if(newChar=='<'){newChar=allHtml.slice(summaryText.length).match(rTagPlus)[0];}
summaryText+=newChar;summTagless++;}
summaryText=backup(summaryText,o.preserveWords);summOpens=summaryText.match(rOpenTag)||[];summCloses=summaryText.match(rCloseTag)||[];tmp=[];$.each(summOpens,function(index,val){if(!rSelfClose.test(val)){tmp.push(val);}});summOpens=tmp;l=summCloses.length;for(i=0;i<l;i++){summCloses[i]=summCloses[i].replace(rCloseTag,'$1');}
$.each(summOpens,function(index,val){var thisTagName=val.replace(rOpenTag,'$1');var closePosition=$.inArray(thisTagName,summCloses);if(closePosition===-1){openTagsForDetails.push(val);closeTagsForsummaryText.push('</'+thisTagName+'>');}else{summCloses.splice(closePosition,1);}});closeTagsForsummaryText.reverse();if(!hasDetails){detailText=allHtml.slice(summaryText.length);detailTagless=$.trim(detailText.replace(rOpenCloseTag,''));if(detailTagless===''||detailTagless.split(/\s+/).length<o.widow){return;}
lastCloseTag=closeTagsForsummaryText.pop()||'';summaryText+=closeTagsForsummaryText.join('');detailText=openTagsForDetails.join('')+detailText;}else{detailText=$this.find(detailSelector).remove().html();summaryText=$this.html();allHtml=summaryText+detailText;lastCloseTag='';}
o.moreLabel=$this.find(moreSelector).length?'':buildMoreLabel(o);if(hasBlocks){detailText=allHtml;}
summaryText+=lastCloseTag;o.summary=summaryText;o.details=detailText;o.lastCloseTag=lastCloseTag;if(defined.onSlice){tmp=o.onSlice.call(thisEl,o);o=tmp&&tmp.details?tmp:o;}
var html=buildHTML(o,hasBlocks);$this.html(html);$thisDetails=$this.find(detailSelector);$readMore=$this.find(moreSelector);$thisDetails.hide();$readMore.find('a').unbind('click.expander').bind('click.expander',expand);$summEl=$this.find('div.'+o.summaryClass);if(o.userCollapse&&!$this.find('span.'+o.lessClass).length){$this.find(detailSelector).append('<span class="'+o.lessClass+'">'+o.userCollapsePrefix+'<a href="#">'+o.userCollapseText+'</a></span>');}
$this.find('span.'+o.lessClass+' a').unbind('click.expander').bind('click.expander',function(event){event.preventDefault();clearTimeout(delayedCollapse);var $detailsCollapsed=$(this).closest(detailSelector);reCollapse(o,$detailsCollapsed);if(defined.onCollapse){o.onCollapse.call(thisEl,true);}});function expand(event){event.preventDefault();$readMore.hide();$summEl.hide();if(defined.beforeExpand){o.beforeExpand.call(thisEl);}
$thisDetails.stop(false,true)[o.expandEffect](expandSpeed,function(){$thisDetails.css({zoom:''});if(defined.afterExpand){o.afterExpand.call(thisEl);}
delayCollapse(o,$thisDetails,thisEl);});}});},destroy:function(){if(!this.data('expander')){return;}
this.removeData('expander');this.each(function(){var $this=$(this),o=$.meta?$.extend({},opts,$this.data()):opts,details=$this.find('.'+o.detailClass).contents();$this.find('.'+o.moreClass).remove();$this.find('.'+o.summaryClass).remove();$this.find('.'+o.detailClass).after(details).remove();$this.find('.'+o.lessClass).remove();});}};if(methods[meth]){methods[meth].call(this);}
function buildHTML(o,blocks){var el='span',summary=o.summary;if(blocks){el='div';if(rLastCloseTag.test(summary)&&!o.expandAfterSummary){summary=summary.replace(rLastCloseTag,o.moreLabel+'$1');}else{summary+=o.moreLabel;}
summary='<div class="'+o.summaryClass+'">'+summary+'</div>';}else{summary+=o.moreLabel;}
return[summary,'<',el+' class="'+o.detailClass+'"','>',o.details,'</'+el+'>'].join('');}
function buildMoreLabel(o){var ret='<span class="'+o.moreClass+'">'+o.expandPrefix;ret+='<a href="#">'+o.expandText+'</a></span>';return ret;}
function backup(txt,preserveWords){if(txt.lastIndexOf('<')>txt.lastIndexOf('>')){txt=txt.slice(0,txt.lastIndexOf('<'));}
if(preserveWords){txt=txt.replace(rAmpWordEnd,'');}
return $.trim(txt);}
function reCollapse(o,el){el.stop(true,true)[o.collapseEffect](o.collapseSpeed,function(){var prevMore=el.prev('span.'+o.moreClass).show();if(!prevMore.length){el.parent().children('div.'+o.summaryClass).show().find('span.'+o.moreClass).show();}});}
function delayCollapse(option,$collapseEl,thisEl){if(option.collapseTimer){delayedCollapse=setTimeout(function(){reCollapse(option,$collapseEl);if($.isFunction(option.onCollapse)){option.onCollapse.call(thisEl,false);}},option.collapseTimer);}}
return this;};$.fn.expander.defaults=$.expander.defaults;})(jQuery);;openerp.mail=function(session){var _t=session.web._t,_lt=session.web._lt;var mail=session.mail={};openerp_mail_followers(session,mail);openerp_FieldMany2ManyTagsEmail(session);mail.ChatterUtils={get_image:function(session,model,field,id,resize){var r=resize?encodeURIComponent(resize):'';id=id||'';return session.url('/web/binary/image',{model:model,field:field,id:id,resize:r});},get_attachment_url:function(session,message_id,attachment_id){return session.url('/mail/download_attachment',{'model':'mail.message','id':message_id,'method':'download_attachment','attachment_id':attachment_id});},do_replace_expressions:function(string){var icon_list=['al','pinky']
var regex_login=new RegExp(/(^|\s):((\w)*)/g);var regex_res=regex_login.exec(string);while(regex_res!=null){var icon_name=regex_res[2];if(_.include(icon_list,icon_name))
string=string.replace(regex_res[0],regex_res[1]+'<img src="/mail/static/src/img/_'+icon_name+'.png" width="22px" height="22px" alt="'+icon_name+'"/>');regex_res=regex_login.exec(string);}
return string;},get_text2html:function(text){return text.replace(/[\n\r]/g,'<br/>').replace(/((?:https?|ftp):\/\/[\S]+)/g,'<a href="$1">$1</a> ')},expand_domain:function(domain){var new_domain=[];var nb_and=-1;for(var k=domain.length-1;k>=0;k--){if(typeof domain[k]!='array'&&typeof domain[k]!='object'){nb_and-=2;continue;}
nb_and+=1;}
for(var k=0;k<nb_and;k++){domain.unshift('&');}
return domain;},breakword:function(str){var out='';if(!str){return str;}
for(var i=0,len=str.length;i<len;i++){out+=_.str.escapeHTML(str[i])+'&#8203;';}
return out;},filetype:function(url){var url=url&&url.filename||url;var tokens=typeof url=='string'?url.split('.'):[];if(tokens.length<=1){return'unknown';}
var extension=tokens[tokens.length-1];if(extension.length===0){return'unknown';}else{extension=extension.toLowerCase();}
var filetypes={'webimage':['png','jpg','jpeg','jpe','gif'],'image':['tif','tiff','tga','bmp','xcf','psd','ppm','pbm','pgm','pnm','mng','xbm','ico','icon','exr','webp','psp','pgf','xcf','jp2','jpx','dng','djvu','dds'],'vector':['ai','svg','eps','vml','cdr','xar','cgm','odg','sxd'],'print':['dvi','pdf','ps'],'document':['doc','docx','odm','odt'],'presentation':['key','keynote','odp','pps','ppt'],'font':['otf','ttf','woff','eot'],'archive':['zip','7z','ace','apk','bzip2','cab','deb','dmg','gzip','jar','rar','tar','gz','pak','pk3','pk4','lzip','lz','rpm'],'certificate':['cer','key','pfx','p12','pem','crl','der','crt','csr'],'audio':['aiff','wav','mp3','ogg','flac','wma','mp2','aac','m4a','ra','mid','midi'],'video':['asf','avi','flv','mkv','m4v','mpeg','mpg','mpe','wmv','mp4','ogm'],'text':['txt','rtf','ass'],'html':['html','xhtml','xml','htm','css'],'disk':['iso','nrg','img','ccd','sub','cdi','cue','mds','mdx'],'script':['py','js','c','cc','cpp','cs','h','java','bat','sh','d','rb','pl','as','cmd','coffee','m','r','vbs','lisp'],'spreadsheet':['123','csv','ods','numbers','sxc','xls','vc','xlsx'],'binary':['exe','com','bin','app'],};for(filetype in filetypes){var ext_list=filetypes[filetype];for(var i=0,len=ext_list.length;i<len;i++){if(extension===ext_list[i]){return filetype;}}}
return'unknown';},};mail.MessageCommon=session.web.Widget.extend({init:function(parent,datasets,options){this._super(parent,options);this.options=datasets.options||options||{};this.domain=datasets.domain||options.domain||[];this.context=_.extend({default_model:false,default_res_id:0,default_parent_id:false},options.context||{});this.id=datasets.id||false,this.last_id=this.id,this.model=datasets.model||this.context.default_model||false,this.res_id=datasets.res_id||this.context.default_res_id||false,this.parent_id=datasets.parent_id||false,this.type=datasets.type||false,this.is_author=datasets.is_author||false,this.is_private=datasets.is_private||false,this.subject=datasets.subject||false,this.name=datasets.name||false,this.record_name=datasets.record_name||false,this.body=datasets.body||'',this.vote_nb=datasets.vote_nb||0,this.has_voted=datasets.has_voted||false,this.is_favorite=datasets.is_favorite||false,this.thread_level=datasets.thread_level||0,this.to_read=datasets.to_read||false,this.author_id=datasets.author_id||false,this.attachment_ids=datasets.attachment_ids||[],this.partner_ids=datasets.partner_ids||[];this.date=datasets.date;this.format_data();this.show_record_name=this.options.show_record_name&&this.record_name&&!this.thread_level&&this.model!='res.partner';this.options.show_read=false;this.options.show_unread=false;if(this.options.show_read_unread_button){if(this.options.read_action=='read')this.options.show_read=true;else if(this.options.read_action=='unread')this.options.show_unread=true;else{this.options.show_read=this.to_read;this.options.show_unread=!this.to_read;}
this.options.rerender=true;this.options.toggle_read=true;}
this.parent_thread=typeof parent.on_message_detroy=='function'?parent:this.options.root_thread;this.thread=false;},format_data:function(){this.date=this.date?session.web.str_to_datetime(this.date):false;if(this.date&&new Date().getTime()-this.date.getTime()<7*24*60*60*1000){this.timerelative=$.timeago(this.date);}
if(this.type=='email'&&(!this.author_id||!this.author_id[0])){this.avatar=('/mail/static/src/img/email_icon.png');}else if(this.author_id&&this.template!='mail.compose_message'){this.avatar=mail.ChatterUtils.get_image(this.session,'res.partner','image_small',this.author_id[0]);}else{this.avatar=mail.ChatterUtils.get_image(this.session,'res.users','image_small',this.session.uid);}
if(this.author_id&&this.author_id[1]){var email=this.author_id[1].match(/(.*)<(.*@.*)>/);if(!email){this.author_id.push(_.str.escapeHTML(this.author_id[1]),'',this.author_id[1]);}else{this.author_id.push(_.str.escapeHTML(email[0]),_.str.trim(email[1]),email[2]);}}},display_attachments:function(){for(var l in this.attachment_ids){var attach=this.attachment_ids[l];if(!attach.formating){attach.url=mail.ChatterUtils.get_attachment_url(this.session,this.id,attach.id);attach.filetype=mail.ChatterUtils.filetype(attach.filename||attach.name);attach.name=mail.ChatterUtils.breakword(attach.name||attach.filename);attach.formating=true;}}
this.$(".oe_msg_attachment_list").html(session.web.qweb.render('mail.thread.message.attachments',{'widget':this}));},attachments_resize_image:function(id,resize){return mail.ChatterUtils.get_image(this.session,'ir.attachment','datas',id,resize);},get_child_ids:function(){return _.map(this.get_childs(),function(val){return val.id;});},get_childs:function(nb_thread_level){var res=[];if(arguments[1]&&this.id)res.push(this);if((isNaN(nb_thread_level)||nb_thread_level>0)&&this.thread){_(this.thread.messages).each(function(val,key){res=res.concat(val.get_childs((isNaN(nb_thread_level)?undefined:nb_thread_level-1),true));});}
return res;},browse_message:function(options){if(!options._go_thread_wall){options._go_thread_wall=true;for(var i in this.options.root_thread.messages){var res=this.options.root_thread.messages[i].browse_message(options);if(res)return res;}}
if(this.id==options.id)
return this;for(var i in this.thread.messages){if(this.thread.messages[i].thread){var res=this.thread.messages[i].browse_message(options);if(res)return res;}}
return false;},destroy:function(){this._super();this.parent_thread.on_message_detroy(this);}});mail.ThreadComposeMessage=mail.MessageCommon.extend({template:'mail.compose_message',init:function(parent,datasets,options){this._super(parent,datasets,options);this.show_compact_message=false;this.show_delete_attachment=true;this.emails_from=[];this.partners_from=[];},start:function(){this._super.apply(this,arguments);this.ds_attachment=new session.web.DataSetSearch(this,'ir.attachment');this.fileupload_id=_.uniqueId('oe_fileupload_temp');$(window).on(this.fileupload_id,this.on_attachment_loaded);this.display_attachments();this.bind_events();},on_attachment_change:function(event){event.stopPropagation();var self=this;var $target=$(event.target);if($target.val()!==''){var filename=$target.val().replace(/.*[\\\/]/,'');var attachments=[];for(var i in this.attachment_ids){if((this.attachment_ids[i].filename||this.attachment_ids[i].name)==filename){if(this.attachment_ids[i].upload){return false;}
this.ds_attachment.unlink([this.attachment_ids[i].id]);}else{attachments.push(this.attachment_ids[i]);}}
this.attachment_ids=attachments;this.$('form.oe_form_binary_form').submit();this.$(".oe_attachment_file").hide();this.attachment_ids.push({'id':0,'name':filename,'filename':filename,'url':'','upload':true});this.display_attachments();}},on_attachment_loaded:function(event,result){if(result.erorr||!result.id){this.do_warn(session.web.qweb.render('mail.error_upload'),result.error);this.attachment_ids=_.filter(this.attachment_ids,function(val){return!val.upload;});}else{for(var i in this.attachment_ids){if(this.attachment_ids[i].filename==result.filename&&this.attachment_ids[i].upload){this.attachment_ids[i]={'id':result.id,'name':result.name,'filename':result.filename,'url':mail.ChatterUtils.get_attachment_url(this.session,this.id,result.id)};}}}
this.display_attachments();var $input=this.$('input.oe_form_binary_file');$input.after($input.clone(true)).remove();this.$(".oe_attachment_file").show();},on_attachment_delete:function(event){event.stopPropagation();var attachment_id=$(event.target).data("id");if(attachment_id){var attachments=[];for(var i in this.attachment_ids){if(attachment_id!=this.attachment_ids[i].id){attachments.push(this.attachment_ids[i]);}
else{this.ds_attachment.unlink([attachment_id]);}}
this.attachment_ids=attachments;this.display_attachments();}},bind_events:function(){var self=this;this.$('.oe_compact').on('click',_.bind(this.on_compose_expandable,this));this.$('input.oe_form_binary_file').on('change',_.bind(this.on_attachment_change,this));this.$('.oe_cancel').on('click',_.bind(this.on_cancel,this));this.$('.oe_post').on('click',_.bind(this.on_message_post,this));this.$('.oe_full').on('click',_.bind(this.on_compose_fullmail,this,this.id?'reply':'comment'));this.$('.oe_msg_left, .oe_msg_center').on('mousedown',_.bind(function(){this.stay_open=true;},this));this.$('.oe_msg_left, .oe_msg_content').on('mouseup',_.bind(function(){this.$('textarea').focus();},this));var ev_stay={};ev_stay.mouseup=ev_stay.keydown=ev_stay.focus=function(){self.stay_open=false;};this.$('textarea').on(ev_stay);this.$('textarea').autosize();this.$('textarea').on('blur',_.bind(this.on_compose_expandable,this));this.$(".oe_msg_attachment_list").on('click','.oe_delete',this.on_attachment_delete);this.$(".oe_emails_from").on('change','input',this.on_checked_email_from);this.$(".oe_partners_from").on('change','input',this.on_checked_partner_from);},on_compose_fullmail:function(default_composition_mode){var self=this;if(!this.do_check_attachment_upload()){return false;}
this.check_recipient_partners().done(function(partner_ids){var context={'default_composition_mode':default_composition_mode,'default_parent_id':self.id,'default_body':mail.ChatterUtils.get_text2html(self.$el?(self.$el.find('textarea:not(.oe_compact)').val()||''):''),'default_attachment_ids':self.attachment_ids,'default_partner_ids':partner_ids,};if(default_composition_mode!='reply'&&self.context.default_model&&self.context.default_res_id){context.default_model=self.context.default_model;context.default_res_id=self.context.default_res_id;}
var action={type:'ir.actions.act_window',res_model:'mail.compose.message',view_mode:'form',view_type:'form',views:[[false,'form']],target:'new',context:context,};self.do_action(action);self.on_cancel();});},reinit:function(){var $render=$(session.web.qweb.render('mail.compose_message',{'widget':this}));$render.insertAfter(this.$el.last());this.$el.remove();this.$el=$render;this.display_attachments();this.bind_events();},on_cancel:function(event){if(event)event.stopPropagation();this.attachment_ids=[];this.stay_open=false;this.show_composer=false;this.reinit();},do_check_attachment_upload:function(){if(_.find(this.attachment_ids,function(file){return file.upload;})){this.do_warn(session.web.qweb.render('mail.error_upload'),session.web.qweb.render('mail.error_upload_please_wait'));return false;}else{return true;}},check_recipient_partners:function(){var self=this;var partners_from=[];var emails=[];_.each(this.emails_from,function(email_from){if(email_from[1]&&!_.find(emails,function(email){return email==email_from[0][4];})){emails.push(email_from[0][1]);}});var deferred_check=$.Deferred();if(emails.length==0){return deferred_check.resolve(partners_from);}
self.parent_thread.ds_thread._model.call('message_create_partners_from_emails',[emails]).then(function(partners){partners_from=_.clone(partners.partner_ids);var deferreds=[];_.each(partners.new_partner_ids,function(id){var deferred=$.Deferred()
deferreds.push(deferred);var pop=new session.web.form.FormOpenPopup(this);pop.show_element('res.partner',id,{'force_email':true,'ref':"compound_context",},{title:_t("Please complete partner's informations"),});pop.on('closed',self,function(){deferred.resolve();});partners_from.push(id);});$.when.apply($,deferreds).then(function(){deferred_check.resolve(partners_from);});});return deferred_check;},on_message_post:function(event){var self=this;if(this.do_check_attachment_upload()&&(this.attachment_ids.length||this.$('textarea').val().match(/\S+/))){this.check_recipient_partners().done(function(partner_ids){self.do_send_message_post(partner_ids);});}},do_send_message_post:function(partner_ids){var self=this;this.parent_thread.ds_thread._model.call('message_post_user_api',[this.context.default_res_id],{'body':this.$('textarea').val(),'subject':false,'parent_id':this.context.default_parent_id,'attachment_ids':_.map(this.attachment_ids,function(file){return file.id;}),'partner_ids':partner_ids,'context':this.parent_thread.context,}).done(function(message_id){var thread=self.parent_thread;var root=thread==self.options.root_thread;if(self.options.display_indented_thread<self.thread_level&&thread.parent_message){var thread=thread.parent_message.parent_thread;}
thread.message_fetch([["id","=",message_id]],false,[message_id],function(arg,data){var message=thread.create_message_object(data[0]);thread.insert_message(message,root?undefined:self.$el,root);});self.on_cancel();});},on_compose_expandable:function(event){this.get_emails_from();if((!this.stay_open||(event&&event.type=='click'))&&(!this.show_composer||!this.$('textarea:not(.oe_compact)').val().match(/\S+/)&&!this.attachment_ids.length)){this.show_composer=!this.show_composer||this.stay_open;this.reinit();}
if(!this.stay_open&&this.show_composer&&(!event||event.type!='blur')){this.$('textarea:not(.oe_compact):first').focus();}
return true;},do_hide_compact:function(){this.show_compact_message=false;if(!this.show_composer){this.reinit();}},do_show_compact:function(){this.show_compact_message=true;if(!this.show_composer){this.reinit();}},get_emails_from:function(){var self=this;var messages=[];if(this.parent_thread.parent_message){var message=this.parent_thread.parent_message;var parent_message=message.parent_id?message.parent_thread.parent_message:message;var messages=[parent_message].concat(parent_message.get_childs());}else if(this.options.emails_from_on_composer){_.each(this.options.root_thread.messages,function(msg){messages.push(msg);messages.concat(msg.get_childs());});}
_.each(messages,function(thread){if(thread.author_id&&!thread.author_id[0]&&!_.find(self.emails_from,function(from){return from[0][4]==thread.author_id[4];})){self.emails_from.push([thread.author_id,true]);}});return self.emails_from;},on_checked_email_from:function(event){var $input=$(event.target);var email=$input.attr("data");_.each(this.emails_from,function(email_from){if(email_from[0][4]==email){email_from[1]=$input.is(":checked");}});},});mail.ThreadExpandable=mail.MessageCommon.extend({template:'mail.thread.expandable',init:function(parent,datasets,options){this._super(parent,datasets,options);this.type='expandable';this.max_limit=datasets.max_limit;this.nb_messages=datasets.nb_messages;this.flag_used=false;},start:function(){this._super.apply(this,arguments);this.bind_events();},reinit:function(){var $render=$(session.web.qweb.render('mail.thread.expandable',{'widget':this}));this.$el.replaceWith($render);this.$el=$render;this.bind_events();},bind_events:function(){this.$('.oe_msg_more_message').on('click',this.on_expandable);},animated_destroy:function(fadeTime){var self=this;this.$el.fadeOut(fadeTime,function(){self.destroy();});},on_expandable:function(event){if(event)event.stopPropagation();if(this.flag_used){return false}
this.flag_used=true;var self=this;self.parent_thread.message_fetch(this.domain,this.context,false,function(arg,data){if(self.options.root_thread==self.parent_thread){data.reverse();}
self.id=false;self.parent_thread.switch_new_message(data,self.$el);self.animated_destroy(200);});return false;},});mail.ThreadMessage=mail.MessageCommon.extend({template:'mail.thread.message',start:function(){this._super.apply(this,arguments);this.expender();this.bind_events();if(this.thread_level<this.options.display_indented_thread){this.create_thread();}
this.display_attachments();this.ds_notification=new session.web.DataSetSearch(this,'mail.notification');this.ds_message=new session.web.DataSetSearch(this,'mail.message');},bind_events:function(){var self=this;this.$('.oe_read').on('click',this.on_message_read);this.$('.oe_unread').on('click',this.on_message_unread);this.$('.oe_msg_delete').on('click',this.on_message_delete);this.$('.oe_reply').on('click',this.on_message_reply);this.$('.oe_star').on('click',this.on_star);this.$('.oe_msg_vote').on('click',this.on_vote);},on_message_reply:function(event){event.stopPropagation();this.create_thread();this.thread.on_compose_message(event);return false;},expender:function(){this.$('.oe_msg_body:first').expander({slicePoint:this.options.truncate_limit,expandText:'read more',userCollapseText:'read less',detailClass:'oe_msg_tail',moreClass:'oe_mail_expand',lessClass:'oe_mail_reduce',});},create_thread:function(){if(this.thread){return false;}
this.thread=new mail.Thread(this,this,{'domain':this.domain,'context':{'default_model':this.model,'default_res_id':this.res_id,'default_parent_id':this.id},'options':this.options});this.thread.insertAfter(this.$el);},animated_destroy:function(fadeTime){var self=this;this.$el.fadeOut(fadeTime,function(){self.parent_thread.message_to_expandable(self);});if(this.thread){this.thread.$el.fadeOut(fadeTime);}},on_message_delete:function(event){event.stopPropagation();if(!confirm(_t("Do you really want to delete this message?"))){return false;}
this.animated_destroy(150);var ids=[this.id].concat(this.get_child_ids());this.ds_message.unlink(ids);return false;},check_for_rerender:function(){var self=this;var messages=[this].concat(this.get_childs());var message_ids=_.map(messages,function(msg){return msg.id;});var domain=mail.ChatterUtils.expand_domain(this.options.root_thread.domain).concat([["id","in",message_ids]]);return this.parent_thread.ds_message.call('message_read',[undefined,domain,[],!!this.parent_thread.options.display_indented_thread,this.context,this.parent_thread.id]).then(function(records){_.map(messages,function(msg){if(!_.find(records,function(record){return record.id==msg.id;})){msg.animated_destroy(150);}else{msg.renderElement();msg.start();}
if(self.options.root_thread.__parentedParent.__parentedParent.do_reload_menu_emails){self.options.root_thread.__parentedParent.__parentedParent.do_reload_menu_emails();}});});},on_message_read:function(event){event.stopPropagation();this.on_message_read_unread(true);return false;},on_message_unread:function(event){event.stopPropagation();this.on_message_read_unread(false);return false;},on_message_read_unread:function(read_value){var self=this;var messages=[this].concat(this.get_childs());if(this.options.view_inbox&&read_value){var messages=_.filter(messages,function(val){return!val.is_favorite&&val.id;});if(!messages.length){this.check_for_rerender();return false;}}
var message_ids=_.map(messages,function(val){return val.id;});this.ds_message.call('set_message_read',[message_ids,read_value,true,this.context]).then(function(){_.each(messages,function(msg){msg.to_read=!read_value;if(msg.options.toggle_read){msg.options.show_read=msg.to_read;msg.options.show_unread=!msg.to_read;}});self.check_for_rerender();});return false;},on_vote:function(event){event.stopPropagation();this.ds_message.call('vote_toggle',[[this.id]]).then(_.bind(function(vote){this.has_voted=vote;this.vote_nb+=this.has_voted?1:-1;this.display_vote();},this));return false;},display_vote:function(){var vote_element=session.web.qweb.render('mail.thread.message.vote',{'widget':this});this.$(".oe_msg_footer:first .oe_mail_vote_count").remove();this.$(".oe_msg_footer:first .oe_msg_vote").replaceWith(vote_element);this.$('.oe_msg_vote').on('click',this.on_vote);},on_star:function(event){event.stopPropagation();var self=this;var button=self.$('.oe_star:first');this.ds_message.call('set_message_starred',[[self.id],!self.is_favorite,true]).then(function(star){self.is_favorite=star;if(self.is_favorite){button.addClass('oe_starred');}else{button.removeClass('oe_starred');}
if(self.options.view_inbox&&self.is_favorite){self.on_message_read_unread(true);}else{self.check_for_rerender();}});return false;},});mail.Thread=session.web.Widget.extend({template:'mail.thread',init:function(parent,datasets,options){var self=this;this._super(parent,options);this.domain=options.domain||[];this.context=_.extend(options.context||{});this.options=options.options;this.options.root_thread=(options.options.root_thread!=undefined?options.options.root_thread:this);this.options.show_compose_message=this.options.show_compose_message&&!this.thread_level;this.parent_message=parent.thread!=undefined?parent:false;this.id=datasets.id||false;this.last_id=datasets.last_id||false;this.parent_id=datasets.parent_id||false;this.is_private=datasets.is_private||false;this.author_id=datasets.author_id||false;this.thread_level=(datasets.thread_level+1)||0;datasets.partner_ids=datasets.partner_ids||[];if(datasets.author_id&&!_.contains(datasets.partner_ids,datasets.author_id)&&datasets.author_id[0]){datasets.partner_ids.push(datasets.author_id);}
this.partner_ids=datasets.partner_ids;this.messages=[];this.options.flat_mode=!!(this.options.display_indented_thread>this.thread_level?this.options.display_indented_thread-this.thread_level:0);this.compose_message=false;this.ds_thread=new session.web.DataSetSearch(this,this.context.default_model||'mail.thread');this.ds_message=new session.web.DataSetSearch(this,'mail.message');this.render_mutex=new $.Mutex();},start:function(){this._super.apply(this,arguments);this.bind_events();},instantiate_compose_message:function(){if(!this.compose_message){this.compose_message=new mail.ThreadComposeMessage(this,this,{'context':this.options.compose_as_todo&&!this.thread_level?_.extend(this.context,{'default_starred':true}):this.context,'options':this.options,});if(!this.thread_level||this.thread_level>this.options.display_indented_thread){this.compose_message.insertBefore(this.$el);}else{this.compose_message.prependTo(this.$el);}}},on_scroll:function(){var expandables=_.each(_.filter(this.messages,function(val){return val.max_limit&&!val.parent_id;}),function(val){var pos=val.$el.position();if(pos.top){var bottom=$(window).scrollTop()+$(window).height()+200;if(bottom>pos.top){val.on_expandable();}}});},bind_events:function(){var self=this;self.$('.oe_mail_list_recipients .oe_more').on('click',self.on_show_recipients);self.$('.oe_mail_compose_textarea .oe_more_hidden').on('click',self.on_hide_recipients);},on_show_recipients:function(){var p=$(this).parent();p.find('.oe_more_hidden, .oe_hidden').show();p.find('.oe_more').hide();return false;},on_hide_recipients:function(){var p=$(this).parent();p.find('.oe_more_hidden, .oe_hidden').hide();p.find('.oe_more').show();return false;},get_child_ids:function(){return _.map(this.get_childs(),function(val){return val.id;});},get_childs:function(nb_thread_level){var res=[];if(arguments[1])res.push(this);if(isNaN(nb_thread_level)||nb_thread_level>0){_(this.messages).each(function(val,key){if(val.thread){res=res.concat(val.thread.get_childs((isNaN(nb_thread_level)?undefined:nb_thread_level-1),true));}});}
return res;},browse_thread:function(options){if(!options._go_thread_wall){options._go_thread_wall=true;return this.options.root_thread.browse_thread(options);}
if(this.id==options.id){return this;}
if(options.id){for(var i in this.messages){if(this.messages[i].thread){var res=this.messages[i].thread.browse_thread({'id':options.id,'_go_thread_wall':true});if(res)return res;}}}
if(options.default_return_top_thread){return this;}
return false;},browse_message:function(options){if(this.options.root_thread.messages[0])
return this.options.root_thread.messages[0].browse_message(options);},on_compose_message:function(event){this.instantiate_compose_message();this.compose_message.on_compose_expandable(event);return false;},no_message:function(){var no_message=$(session.web.qweb.render('mail.wall_no_message',{}));if(this.options.help){no_message.html(this.options.help);}
no_message.appendTo(this.$el);},message_fetch:function(replace_domain,replace_context,ids,callback){return this.ds_message.call('message_read',[ids==false?undefined:ids,(replace_domain?replace_domain:this.domain),(this.id?[this.id].concat(this.get_child_ids()):this.get_child_ids()),this.options.flat_mode,(replace_context?replace_context:this.context),this.context.default_parent_id||undefined]).done(callback?_.bind(callback,this,arguments):this.proxy('switch_new_message')).done(this.proxy('message_fetch_set_read'));},message_fetch_set_read:function(message_list){if(!this.context.mail_read_set_read)return;this.render_mutex.exec(_.bind(function(){msg_ids=_.pluck(message_list,'id');return this.ds_message.call('set_message_read',[msg_ids,true,false,this.context]);},this));},create_message_object:function(data){var self=this;var data=_.extend(data,{'thread_level':data.thread_level?data.thread_level:self.thread_level});data.options=_.extend(self.options,data.options);if(data.type=='expandable'){var message=new mail.ThreadExpandable(self,data,{'context':{'default_model':data.model||self.context.default_model,'default_res_id':data.res_id||self.context.default_res_id,'default_parent_id':self.id,}});}else{data.record_name=(data.record_name!=''&&data.record_name)||(self.parent_message&&self.parent_message.record_name);var message=new mail.ThreadMessage(self,data,{'context':{'default_model':data.model,'default_res_id':data.res_id,'default_parent_id':data.id,}});}
for(var i in self.messages){if(message.id&&self.messages[i]&&self.messages[i].id==message.id){self.messages[i].destroy();}}
self.messages.push(message);return message;},insert_message:function(message,dom_insert_after,prepend){var self=this;if(this.options.show_compact_message>this.thread_level){this.instantiate_compose_message();this.compose_message.do_show_compact();}
this.$('.oe_view_nocontent').remove();if(dom_insert_after){message.insertAfter(dom_insert_after);}else if(prepend){message.prependTo(self.$el);}else{message.appendTo(self.$el);}
message.$el.hide().fadeIn(500);return message},switch_new_message:function(records,dom_insert_after){var self=this;_(records).each(function(record){var thread=self.browse_thread({'id':record.parent_id,'default_return_top_thread':true});var message=thread.create_message_object(record);thread.insert_message(message,typeof dom_insert_after=='object'?dom_insert_after:false);});if(!records.length&&this.options.root_thread==this){this.no_message();}},on_message_detroy:function(message){this.messages=_.filter(this.messages,function(val){return!val.isDestroyed();});if(this.options.root_thread==this&&!this.messages.length){this.no_message();}
return false;},message_to_expandable:function(message){if(!this.thread_level||message.isDestroyed()){message.destroy();return false;}
var messages=_.sortBy(this.messages,function(val){return val.id;});var it=_.indexOf(messages,message);var msg_up=message.$el.prev('.oe_msg');var msg_down=message.$el.next('.oe_msg');var msg_up=msg_up.hasClass('oe_msg_expandable')?_.find(this.messages,function(val){return val.$el[0]==msg_up[0];}):false;var msg_down=msg_down.hasClass('oe_msg_expandable')?_.find(this.messages,function(val){return val.$el[0]==msg_down[0];}):false;var message_dom=[["id","=",message.id]];if(msg_up&&msg_up.type=="expandable"&&msg_down&&msg_down.type=="expandable"){msg_up.domain=mail.ChatterUtils.expand_domain(msg_up.domain);msg_down.domain=mail.ChatterUtils.expand_domain(msg_down.domain);msg_down.domain=['|','|'].concat(msg_up.domain).concat(message_dom).concat(msg_down.domain);if(!msg_down.max_limit){msg_down.nb_messages+=1+msg_up.nb_messages;}
msg_up.$el.remove();msg_up.destroy();msg_down.reinit();}else if(msg_up&&msg_up.type=="expandable"){msg_up.domain=mail.ChatterUtils.expand_domain(msg_up.domain);msg_up.domain=['|'].concat(msg_up.domain).concat(message_dom);msg_up.nb_messages++;msg_up.reinit();}else if(msg_down&&msg_down.type=="expandable"){msg_down.domain=mail.ChatterUtils.expand_domain(msg_down.domain);msg_down.domain=['|'].concat(msg_down.domain).concat(message_dom);if(!msg_down.max_limit){msg_down.nb_messages++;}
msg_down.reinit();}else{var expandable=new mail.ThreadExpandable(this,{'model':message.model,'parent_id':message.parent_id,'nb_messages':1,'thread_level':message.thread_level,'parent_id':message.parent_id,'domain':message_dom,'options':message.options,},{'context':{'default_model':message.model||this.context.default_model,'default_res_id':message.res_id||this.context.default_res_id,'default_parent_id':this.id,}});this.messages.push(expandable);expandable.insertAfter(message.$el);}
message.destroy();return true;},});session.web.client_actions.add('mail.Widget','session.mail.Widget');mail.Widget=session.web.Widget.extend({template:'mail.Root',init:function(parent,action){this._super(parent,action);var self=this;this.action=_.clone(action);this.domain=this.action.domain||this.action.params.domain||[];this.context=this.action.context||this.action.params.context||{};this.action.params=_.extend({'display_indented_thread':-1,'show_reply_button':false,'show_read_unread_button':false,'truncate_limit':250,'show_record_name':false,'show_compose_message':false,'show_compact_message':false,'compose_placeholder':false,'show_link':true,'view_inbox':false,'message_ids':undefined,'compose_as_todo':false,'readonly':false,'emails_from_on_composer':true,},this.action.params);this.action.params.help=this.action.help||false;},start:function(options){this._super.apply(this,arguments);this.message_render();this.bind_events();},message_render:function(search){this.thread=new mail.Thread(this,{},{'domain':this.domain,'context':this.context,'options':this.action.params,});this.thread.appendTo(this.$el);if(this.action.params.show_compose_message){this.thread.instantiate_compose_message();this.thread.compose_message.do_show_compact();}
this.thread.message_fetch(null,null,this.action.params.message_ids);},bind_events:function(){$(document).scroll(_.bind(this.thread.on_scroll,this.thread));$(window).resize(_.bind(this.thread.on_scroll,this.thread));this.$el.resize(_.bind(this.thread.on_scroll,this.thread));window.setTimeout(_.bind(this.thread.on_scroll,this.thread),500);},});session.web.form.widgets.add('mail_thread','openerp.mail.RecordThread');mail.RecordThread=session.web.form.AbstractField.extend({template:'mail.record_thread',init:function(parent,node){this._super.apply(this,arguments);this.node=_.clone(node);this.node.params=_.extend({'display_indented_thread':-1,'show_reply_button':false,'show_read_unread_button':true,'read_action':'unread','show_record_name':false,'show_compact_message':1,},this.node.params);if(this.node.attrs.placeholder){this.node.params.compose_placeholder=this.node.attrs.placeholder;}
if(this.node.attrs.readonly){this.node.params.readonly=this.node.attrs.readonly;}
this.domain=this.node.params&&this.node.params.domain||[];if(!this.__parentedParent.is_action_enabled('edit')){this.node.params.show_link=false;}},start:function(){this._super.apply(this,arguments);this.view.on("change:actual_mode",this,this._check_visibility);this._check_visibility();},_check_visibility:function(){this.$el.toggle(this.view.get("actual_mode")!=="create");},render_value:function(){var self=this;if(!this.view.datarecord.id||session.web.BufferedDataSet.virtual_id_regex.test(this.view.datarecord.id)){this.$('oe_mail_thread').hide();return;}
this.node.params=_.extend(this.node.params,{'message_ids':this.get_value(),'show_compose_message':this.view.is_action_enabled('edit'),});this.node.context={'mail_read_set_read':true,'default_res_id':this.view.datarecord.id||false,'default_model':this.view.model||false,};if(this.root){$('<span class="oe_mail-placeholder"/>').insertAfter(this.root.$el);this.root.destroy();}
this.root=new mail.Widget(this,_.extend(this.node,{'domain':(this.domain||[]).concat([['model','=',this.view.model],['res_id','=',this.view.datarecord.id]]),}));return this.root.replace(this.$('.oe_mail-placeholder'));},});session.web.client_actions.add('mail.wall','session.mail.Wall');mail.Wall=session.web.Widget.extend({template:'mail.wall',init:function(parent,action){this._super(parent,action);this.action=_.clone(action);this.domain=this.action.params.domain||this.action.domain||[];this.context=_.extend(this.action.params.context||{},this.action.context||{});this.defaults={};for(var key in this.context){if(key.match(/^search_default_/)){this.defaults[key.replace(/^search_default_/,'')]=this.context[key];}}
this.action.params=_.extend({'display_indented_thread':1,'show_reply_button':true,'show_read_unread_button':true,'show_compose_message':true,'show_record_name':true,'show_compact_message':this.action.params.view_mailbox?false:1,'view_inbox':false,'emails_from_on_composer':false,},this.action.params);},start:function(){this._super.apply(this);this.bind_events();var searchview_loaded=this.load_searchview(this.defaults);if(!this.searchview.has_defaults){this.message_render();}},do_reload_menu_emails:function(){var menu=this.__parentedParent.__parentedParent.menu;},load_searchview:function(defaults){var self=this;var ds_msg=new session.web.DataSetSearch(this,'mail.message');this.searchview=new session.web.SearchView(this,ds_msg,false,defaults||{},false);this.searchview.appendTo(this.$('.oe_view_manager_view_search')).then(function(){self.searchview.on('search_data',self,self.do_searchview_search);});if(this.searchview.has_defaults){this.searchview.ready.then(this.searchview.do_search);}
return this.searchview},do_searchview_search:function(domains,contexts,groupbys){var self=this;session.web.pyeval.eval_domains_and_contexts({domains:domains||[],contexts:contexts||[],group_by_seq:groupbys||[]}).then(function(results){if(self.root){$('<span class="oe_mail-placeholder"/>').insertAfter(self.root.$el);self.root.destroy();}
return self.message_render(results);});},message_render:function(search){var domain=this.domain.concat(search&&search['domain']?search['domain']:[]);var context=_.extend(this.context,search&&search['context']?search['context']:{});this.root=new mail.Widget(this,_.extend(this.action,{'domain':domain,'context':context,}));return this.root.replace(this.$('.oe_mail-placeholder'));},bind_events:function(){var self=this;this.$(".oe_write_full").click(function(event){event.stopPropagation();var action={type:'ir.actions.act_window',res_model:'mail.compose.message',view_mode:'form',view_type:'form',action_from:'mail.ThreadComposeMessage',views:[[false,'form']],target:'new',context:{},};session.client.action_manager.do_action(action);});this.$(".oe_write_onwall").click(function(){self.root.thread.on_compose_message();});}});session.web.ComposeMessageTopButton=session.web.Widget.extend({template:'mail.ComposeMessageTopButton',start:function(){this.$('button').on('click',this.on_compose_message);this._super();},on_compose_message:function(event){event.stopPropagation();var action={type:'ir.actions.act_window',res_model:'mail.compose.message',view_mode:'form',view_type:'form',views:[[false,'form']],target:'new',context:{},};session.client.action_manager.do_action(action);},});session.web.UserMenu.include({do_update:function(){var self=this;this._super.apply(this,arguments);this.update_promise.then(function(){var mail_button=new session.web.ComposeMessageTopButton();mail_button.appendTo(session.webclient.$el.find('.oe_systray'));});},});};;openerp_mail_followers=function(session,mail){var _t=session.web._t,_lt=session.web._lt;var mail_followers=session.mail_followers={};session.web.form.widgets.add('mail_followers','openerp.mail_followers.Followers');mail_followers.Followers=session.web.form.AbstractField.extend({template:'mail.followers',init:function(){this._super.apply(this,arguments);this.image=this.node.attrs.image||'image_small';this.comment=this.node.attrs.help||false;this.displayed_limit=this.node.attrs.displayed_nb||10;this.displayed_nb=this.displayed_limit;this.ds_model=new session.web.DataSetSearch(this,this.view.model);this.ds_follow=new session.web.DataSetSearch(this,this.field.relation);this.ds_users=new session.web.DataSetSearch(this,'res.users');this.value=[];this.followers=[];this.view_is_editable=this.__parentedParent.is_action_enabled('edit');},start:function(){this.view.on("change:actual_mode",this,this.on_check_visibility_mode);this.on_check_visibility_mode();this.reinit();this.bind_events();this._super();},on_check_visibility_mode:function(){this.set({"force_invisible":this.view.get("actual_mode")=="create"});},set_value:function(_value){this.value=_value;this._super(_value);},reinit:function(){this.message_is_follower==undefined;this.display_buttons();},bind_events:function(){var self=this;this.$('.oe_follower').on('click',function(event){if($(this).hasClass('oe_notfollow'))
self.do_follow();else
self.do_unfollow();});this.$el.on('click','.oe_subtype_list input',self.do_update_subscription);this.$('.oe_invite').on('click',self.on_invite_follower);this.$el.on('click','.oe_remove_follower',self.on_remove_follower);this.$el.on('click','.oe_show_more',self.on_show_more_followers)},on_invite_follower:function(event){var self=this;var action={type:'ir.actions.act_window',res_model:'mail.wizard.invite',view_mode:'form',view_type:'form',views:[[false,'form']],target:'new',context:{'default_res_model':this.view.dataset.model,'default_res_id':this.view.datarecord.id,},}
this.do_action(action,{on_close:function(){self.read_value();},});},on_show_more_followers:function(event){this.displayed_nb+=this.displayed_limit;this.display_followers(false);},on_remove_follower:function(event){var partner_id=$(event.target).data('id');var context=new session.web.CompoundContext(this.build_context(),{});return this.ds_model.call('message_unsubscribe',[[this.view.datarecord.id],[partner_id],context]).then(this.proxy('read_value'));},read_value:function(){var self=this;this.displayed_nb=this.displayed_limit;return this.ds_model.read_ids([this.view.datarecord.id],['message_follower_ids']).then(function(results){self.value=results[0].message_follower_ids;self.render_value();});},render_value:function(){this.reinit();return this.fetch_followers(this.value);},fetch_followers:function(value_){this.value=value_||{};return this.ds_follow.call('read',[this.value,['name','user_ids']]).then(this.proxy('display_followers'),this.proxy('fetch_generic')).then(this.proxy('display_buttons')).then(this.proxy('fetch_subtypes'));},fetch_generic:function(error,event){var self=this;event.preventDefault();return this.ds_users.call('read',[this.session.uid,['partner_id']]).then(function(results){var pid=results['partner_id'][0];self.message_is_follower=(_.indexOf(self.value,pid)!=-1);}).then(self.proxy('display_generic'));},_format_followers:function(count){function _t(str){return str;}
var str='';if(count<=0){str=_t('No followers');}else if(count===1){str=_t('One follower');}else{str=''+count+' '+_t('followers');}
return str;},display_generic:function(){var self=this;var node_user_list=this.$('.oe_follower_list').empty();this.$('.oe_follower_title').html(this._format_followers(this.value.length));},display_followers:function(records){var self=this;this.followers=records||this.followers;this.message_is_follower=this.set_is_follower(this.followers);var node_user_list=this.$('.oe_follower_list').empty();this.$('.oe_follower_title').html(this._format_followers(this.followers.length));var truncated=this.followers.slice(0,this.displayed_nb);_(truncated).each(function(record){record.avatar_url=mail.ChatterUtils.get_image(self.session,'res.partner','image_small',record.id);$(session.web.qweb.render('mail.followers.partner',{'record':record,'widget':self})).appendTo(node_user_list);});if(truncated.length<this.followers.length){$(session.web.qweb.render('mail.followers.show_more',{'number':(this.followers.length-truncated.length)})).appendTo(node_user_list);}},set_is_follower:function(records){var user_ids=_.pluck(_.pluck(records,'user_ids'),0);return _.indexOf(user_ids,this.session.uid)!=-1;},display_buttons:function(){if(this.message_is_follower){this.$('button.oe_follower').removeClass('oe_notfollow').addClass('oe_following');}
else{this.$('button.oe_follower').removeClass('oe_following').addClass('oe_notfollow');}
if(this.view.is_action_enabled('edit'))
this.$('span.oe_mail_invite_wrapper').hide();else
this.$('span.oe_mail_invite_wrapper').show();},fetch_subtypes:function(){var self=this;var subtype_list_ul=this.$('.oe_subtype_list').empty();if(!this.message_is_follower)return;var id=this.view.datarecord.id;this.ds_model.call('message_get_subscription_data',[[id],new session.web.CompoundContext(this.build_context(),{})]).then(function(data){self.display_subtypes(data,id);});},display_subtypes:function(data,id){var self=this;var subtype_list_ul=this.$('.oe_subtype_list');var records=[];var nb_subtype=0;subtype_list_ul.empty();if(data[id]){records=data[id].message_subtype_data;}
_(records).each(function(record){nb_subtype++;});if(nb_subtype>1){this.$('hr').show();_(records).each(function(record,record_name){record.name=record_name;record.followed=record.followed||undefined;$(session.web.qweb.render('mail.followers.subtype',{'record':record})).appendTo(self.$('.oe_subtype_list'));});}else{this.$('hr').hide();}},do_follow:function(){var context=new session.web.CompoundContext(this.build_context(),{});this.ds_model.call('message_subscribe_users',[[this.view.datarecord.id],[this.session.uid],undefined,context]).then(this.proxy('read_value'));_.each(this.$('.oe_subtype_list input'),function(record){$(record).attr('checked','checked');});},do_unfollow:function(){_(this.$('.oe_msg_subtype_check')).each(function(record){$(record).attr('checked',false);});var context=new session.web.CompoundContext(this.build_context(),{});return this.ds_model.call('message_unsubscribe_users',[[this.view.datarecord.id],[this.session.uid],context]).then(this.proxy('read_value'));},do_update_subscription:function(event){var self=this;var checklist=new Array();_(this.$('.oe_actions input[type="checkbox"]')).each(function(record){if($(record).is(':checked')){checklist.push(parseInt($(record).data('id')));}});if(!checklist.length){this.do_unfollow();}else{var context=new session.web.CompoundContext(this.build_context(),{});return this.ds_model.call('message_subscribe_users',[[this.view.datarecord.id],[this.session.uid],checklist,context]).then(this.proxy('read_value'));}},});};;openerp_FieldMany2ManyTagsEmail=function(instance){var _t=instance.web._t;instance.web.form.FieldMany2ManyTagsEmail=instance.web.form.FieldMany2ManyTags.extend({start:function(){this.values=[];this.values_checking=[];this.on("change:value",this,this.on_change_value_check);this.trigger("change:value");this._super.apply(this,arguments);},on_change_value_check:function(){this.values=_.uniq(this.values);var values_removed=_.difference(this.values,this.get('value'));if(values_removed.length){this.values=_.difference(this.values,values_removed);this.set({'value':this.values});return false;}
var not_checked=_.difference(this.get('value'),this.values,this.values_checking);if(not_checked.length){this.values_checking=this.values_checking.concat(not_checked);this._check_email_popup(not_checked);}},_check_email_popup:function(ids){var self=this;new instance.web.Model('res.partner').call("search",[[["id","in",ids],["email","=",false],["notification_email_send","in",['all','comment']]]],{context:this.build_context()}).then(function(record_ids){var valid_partner=_.difference(ids,record_ids);self.values=self.values.concat(valid_partner);self.values_checking=_.difference(self.values_checking,valid_partner);_.each(record_ids,function(id){var pop=new instance.web.form.FormOpenPopup(self);pop.show_element('res.partner',id,self.build_context(),{title:_t("Please complete partner's informations and Email"),});pop.on('write_completed',self,function(){this.values.push(id);this.values_checking=_.without(this.values_checking,id);this.set({'value':this.values});});pop.on('closed',self,function(){this.values_checking=_.without(this.values_checking,id);this.set({'value':this.values});});});});},});instance.web.form.widgets=instance.web.form.widgets.extend({'many2many_tags_email':'instance.web.form.FieldMany2ManyTagsEmail',});};;openerp.auth_signup=function(instance){instance.auth_signup=instance.auth_signup||{};var _t=instance.web._t;instance.web.Login.include({start:function(){var self=this;var d=this._super();d.done(function(){self.$(".oe_signup_show").hide();self.$('a.oe_signup_signup').click(function(ev){if(ev){ev.preventDefault();}
self.$el.addClass("oe_login_signup");self.$(".oe_signup_show").show();self.$(".oe_signup_hide").hide();return false;});self.$('a.oe_signup_back').click(function(ev){if(ev){ev.preventDefault();}
self.$el.removeClass("oe_login_signup");self.$(".oe_signup_show").hide();self.$(".oe_signup_hide").show();delete self.params.token;return false;});var dblist=self.db_list||[];var dbname=self.params.db||(dblist.length===1?dblist[0]:null);if(self.params.error_message){self.show_error(self.params.error_message);delete self.params.error_message;}
if(dbname&&self.params.token){self.rpc("/auth_signup/retrieve",{dbname:dbname,token:self.params.token}).done(self.on_token_loaded).fail(self.on_token_failed)}
if(dbname&&self.params.login){self.$("form input[name=login]").val(self.params.login);}
self.$('a.oe_signup_reset_password').click(self.do_reset_password);self.$('a.oe_signup_signup').hide();self.$('a.oe_signup_reset_password').hide();if(dbname){self.rpc("/auth_signup/get_config",{dbname:dbname}).done(function(result){if(result.signup){self.$('a.oe_signup_signup').show();}
if(result.reset_password){self.$('a.oe_signup_reset_password').show();}});}});return d;},on_token_loaded:function(result){this.selected_db=result.db;this.on_db_loaded([result.db]);if(result.token){this.$el.addClass("oe_login_signup");self.$(".oe_signup_show").show();self.$(".oe_signup_hide").hide();this.$("form input[name=name]").val(result.name).attr("readonly","readonly");if(result.login){this.$("form input[name=login]").val(result.login).attr("readonly","readonly");}else{this.$("form input[name=login]").val(result.email);}}else{delete this.params.token;this.$("form input[name=login]").val(result.login||"");}},on_token_failed:function(result,ev){if(ev){ev.preventDefault();}
this.show_error(_t("Invalid signup token"));delete this.params.db;delete this.params.token;},on_submit:function(ev){if(ev){ev.preventDefault();}
if(this.$el.hasClass("oe_login_signup")){var db=this.$("form [name=db]").val();var name=this.$("form input[name=name]").val();var login=this.$("form input[name=login]").val();var password=this.$("form input[name=password]").val();var confirm_password=this.$("form input[name=confirm_password]").val();if(!db){this.do_warn(_t("Login"),_t("No database selected !"));return false;}else if(!name){this.do_warn(_t("Login"),_t("Please enter a name."));return false;}else if(!login){this.do_warn(_t("Login"),_t("Please enter a username."));return false;}else if(!password||!confirm_password){this.do_warn(_t("Login"),_t("Please enter a password and confirm it."));return false;}else if(password!==confirm_password){this.do_warn(_t("Login"),_t("Passwords do not match; please retype them."));return false;}
var params={dbname:db,token:this.params.token||"",name:name,login:login,password:password,};var self=this,super_=this._super;this.rpc('/auth_signup/signup',params).done(function(result){if(result.error){self.show_error(result.error);}else{super_.apply(self,[ev]);}});}else{this._super(ev);}},do_reset_password:function(ev){if(ev){ev.preventDefault();}
var db=this.$("form [name=db]").val();var login=this.$("form input[name=login]").val();if(!db){this.do_warn(_t("Login"),_t("No database selected !"));return false;}else if(!login){this.do_warn(_t("Login"),_t("Please enter a username or email address."))
return false;}
var params={dbname:db,login:login,};var url="/auth_signup/reset_password?"+$.param(params);window.location=url;},});};;openerp.auth_oauth_signup=function(instance){instance.web.Login.include({_oauth_state:function(provider){var state=this._super.apply(this,arguments);if(this.params.token){state.t=this.params.token;}
return state;},});};;openerp.web_tests=function(instance){instance.web.client_actions.add('buncha-forms','instance.web_tests.BunchaForms');instance.web_tests={};instance.web_tests.BunchaForms=instance.web.Widget.extend({init:function(parent){this._super(parent);this.dataset=new instance.web.DataSetSearch(this,'test.listview.relations');this.form=new instance.web.FormView(this,this.dataset,false,{action_buttons:false,pager:false});this.form.registry=instance.web.form.readonly;},render:function(){return'<div class="oe_bunchaforms"></div>';},start:function(){$.when(this.dataset.read_slice(),this.form.appendTo(this.$el)).done(this.on_everything_loaded);},on_everything_loaded:function(slice){var records=slice[0].records;if(!records.length){this.form.trigger("load_record",{});return;}
this.form.trigger("load_record",records[0]);_(records.slice(1)).each(function(record,index){this.dataset.index=index+1;this.form.reposition($('<div>').appendTo(this.$el));this.form.trigger("load_record",record);},this);}});};;openerp.document=function(instance){_t=instance.web._t;instance.web.Sidebar.include({init:function(){this._super.apply(this,arguments);this.sections.splice(1,0,{'name':'files','label':_t('Attachment(s)'),});this.items['files']=[];},on_attachments_loaded:function(attachments){var self=this;_.chain(attachments.reverse()).groupBy(function(attachment){return attachment.name}).each(function(attachment){if(attachment.length>1)
_.map(attachment,function(attachment,i){attachment.name=_.str.sprintf(_t("%s (%s)"),attachment.name,i+1)})})
self._super(attachments);},});};;openerp.share=function(session){var _t=session.web._t;var has_action_id=false;function launch_wizard(self,view,user_type,invite){var action=view.getParent().action;var Share=new session.web.DataSet(self,'share.wizard',view.dataset.get_context());var domain=new session.web.CompoundDomain(view.dataset.domain);if(view.fields_view.type=='form'){domain=new session.web.CompoundDomain(domain,[['id','=',view.datarecord.id]]);}
if(view.fields_view.type=='form')rec_name=view.datarecord.name;else rec_name='';session.web.pyeval.eval_domains_and_contexts({domains:[domain],contexts:[view.dataset.context]}).done(function(result){Share.create({name:action.name,record_name:rec_name,domain:result.domain,action_id:action.id,user_type:user_type||'embedded',view_type:view.fields_view.type,invite:invite||false,}).done(function(share_id){var step1=Share.call('go_step_1',[[share_id]]).done(function(result){var action=result;self.do_action(action);});});});}
function has_share(yes,no){if(!session.session.share_flag){session.session.share_flag=$.Deferred(function(){var func=new session.web.Model("share.wizard").get_func("has_share");func(session.session.uid).then(function(res){if(res){session.session.share_flag.resolve();}else{session.session.share_flag.reject();}});});}
session.session.share_flag.done(yes).fail(no);}
session.web.Sidebar=session.web.Sidebar.extend({start:function(){var self=this;this._super(this);has_share(function(){self.add_items('other',[{label:_t('Share'),callback:self.on_click_share,classname:'oe_share'},{label:_t('Embed'),callback:self.on_click_share_link,classname:'oe_share'},]);});},on_click_share:function(item){var view=this.getParent()
launch_wizard(this,view,'emails',false);},on_click_share_link:function(item){var view=this.getParent()
launch_wizard(this,view,'embedded',false);},});session.mail.RecordThread.include({start:function(){start_res=this._super.apply(this,arguments);if(has_action_id){this.$el.find('button.oe_share_invite').show();}
return start_res;}});session.web.ViewManagerAction.include({start:function(){var self=this;this.check_if_action_is_defined();has_share(function(){self.$el.delegate('button.oe_share_invite','click',self.on_click_share_invite);});return this._super.apply(this,arguments);},check_if_action_is_defined:function(){if(this.action&&this.action.id){has_action_id=true;}
else{has_action_id=false;}},on_click_share_invite:function(e){e.preventDefault();launch_wizard(this,this.views[this.active_view].controller,'emails',true);},});};;openerp.portal_anonymous=function(instance){instance.web.Session.include({load_translations:function(){var self=this;var browser_lang=(navigator.language||navigator.userLanguage).replace('-','_');if(this.username==='anonymous'&&this.user_context.lang.indexOf(browser_lang)===-1){return(new instance.web.Model('res.lang')).query(['code','iso_code']).filter([['code','like',browser_lang.substring(0,2).toLowerCase()]]).all().then(function(langs){if(langs.length>0){var l=_.filter(langs,function(lang){return lang.code===browser_lang||lang.iso_code===browser_lang;});if(!_.isEmpty(l)){self.user_context.lang=l[0].code;}else{l=_.filter(langs,function(lang){return lang.iso_code===_.pluck(langs,'iso_code').sort(function(a,b){return a.length-b.length;})[0];});self.user_context.lang=l[0].code;}}
return self.rpc('/web/webclient/translations',{mods:self.module_list,lang:self.user_context.lang}).done(function(trans){instance.web._t.database.set_bundle(trans);});});}
return this._super();},});instance.web.Login.include({start:function(){var self=this;return $.when(this._super()).then(function(){var params=$.deparam($.param.querystring());var dblist=self.db_list||[];if(!self.session.session_is_valid()&&dblist.length===1&&(!params.token||!params.login)){self.remember_credentials=false;return self.do_login(dblist[0],'anonymous','anonymous');}});},});instance.web.UserMenu.include({init:function(parent){this._super(parent);if(this.session.username=='anonymous'){this.template='UserMenu.portal_anonymous';this.do_update=function(){};}},start:function(){var self=this;this._super.apply(this,arguments);this.$el.find('a.login').click(function(){var p=self.getParent();var am=p.action_manager;p.$el.find('.oe_leftbar').hide();am.do_action({type:'ir.actions.client',tag:'login',target:'current',params:{login_successful:function(){am.do_action("reload");}}});});}});instance.web.WebClient.include({check_timezone:function(){if(this.session.username!=='anonymous'){return this._super.apply(this,arguments);}
return false;},});};;var _gaq=_gaq||[];openerp.web_analytics=function(instance){(function(){var ga=document.createElement('script');ga.type='text/javascript';ga.async=true;ga.src=('https:'===document.location.protocol?'https://ssl':'http://www')+'.google-analytics.com/ga.js';var s=document.getElementsByTagName('script')[0];s.parentNode.insertBefore(ga,s);})();instance.web_analytics.Tracker=instance.web.Class.extend({init:function(webclient){var self=this;self.initialized=$.Deferred();_gaq.push(['_setAccount','UA-7333765-1']);_gaq.push(['_setDomainName','.openerp.com']);self.initialize_custom(webclient).then(function(){webclient.on('state_pushed',self,self.on_state_pushed);self.include_tracker();});},_get_user_type:function(){return'Local User';},_get_user_access_level:function(){if(!instance.session.session_is_valid()){return"Unauthenticated User";}
if(instance.session.uid===1){return'Admin User';}
if(instance.session.username.indexOf('@')!==-1){return'Portal User';}
if(instance.session.username==='anonymous'){return'Anonymous User';}
return'Normal User';},initialize_custom:function(){var self=this;instance.session.rpc("/web/webclient/version_info",{}).done(function(res){_gaq.push(['_setCustomVar',5,'Version',res.server_version,3]);self._push_customvars();self.initialized.resolve(self);});return self.initialized;},_push_customvars:function(){var self=this;_gaq.push(['_setCustomVar',4,'User Access Level',self._get_user_access_level(),1]);_gaq.push(['_setCustomVar',1,'User Type Conversion',self._get_user_type(),2]);},_push_pageview:function(url){_gaq.push(['_trackPageview',url]);},_push_event:function(options){_gaq.push(['_trackEvent',options.category,options.action,options.label,options.value,options.noninteraction]);},_push_ecommerce:function(trans_data,item_list){_gaq.push(['_addTrans',trans_data.order_id,trans_data.store_name,trans_data.total,trans_data.tax,trans_data.shipping,trans_data.city,trans_data.state,trans_data.country,]);_.each(item_list,function(item){_gaq.push(['_addItem',item.order_id,item.sku,item.name,item.category,item.price,item.quantity,]);});_gaq.push(['_trackTrans']);},on_state_pushed:function(state){if(state.model&&state.view_type){var url=instance.web_analytics.generateUrl({'model':state.model,'view_type':state.view_type});this._push_event({'category':state.model,'action':state.view_type,'label':url,});this._push_pageview(url);}},include_tracker:function(){var t=this;instance.web.FormView.include({init:function(parent,dataset,view_id,options){this._super.apply(this,arguments);var self=this;this.on('record_created',self,function(r){var url=instance.web_analytics.generateUrl({'model':self.model,'view_type':'form'});t._push_event({'category':self.model,'action':'create','label':url,'noninteraction':true,});});this.on('record_saved',self,function(r){var url=instance.web_analytics.generateUrl({'model':self.model,'view_type':'form'});t._push_event({'category':self.model,'action':'save','label':url,'noninteraction':true,});});}});instance.web.ActionManager.include({ir_actions_client:function(action,options){var url=instance.web_analytics.generateUrl({'action':action.tag});t._push_event({'category':action.type,'action':action.tag,'label':url,});t._push_pageview(url);return this._super.apply(this,arguments);},});instance.web.View.include({do_execute_action:function(action_data,dataset,record_id,on_closed){var category=this.model||dataset.model||'';var action;if(action_data.name&&_.isNaN(action_data.name-0)){action=action_data.name;}else{action=action_data.string||action_data.special||'';}
var url=instance.web_analytics.generateUrl({'model':category,'view_type':this.view_type});t._push_event({'category':category,'action':action,'label':url,'noninteraction':true,});return this._super.apply(this,arguments);},});instance.web.CrashManager.include({show_error:function(error){var hash=window.location.hash;var params=$.deparam(hash.substr(hash.indexOf('#')+1));var options={};if(params.model&&params.view_type){options={'model':params.model,'view_type':params.view_type};}else{options={'action':params.action};}
var url=instance.web_analytics.generateUrl(options);t._push_event({'category':options.model||"ir.actions.client",'action':"error "+(error.code?error.message+error.data.fault_code:error.type+error.data.debug),'label':url,'noninteraction':true,});this._super.apply(this,arguments);},});},});instance.web_analytics.generateUrl=function(options){var url='';var keys=_.keys(options);keys=_.sortBy(keys,function(i){return i;});_.each(keys,function(key){url+='/'+key+'/'+options[key];});return url;};instance.web_analytics.setupTracker=function(wc){return wc.tracker.initialized;};instance.web.Client.include({bind_events:function(){this._super.apply(this,arguments);this.tracker=new instance.web_analytics.Tracker(this);},});instance.web.Session.include({session_authenticate:function(){return $.when(this._super.apply(this,arguments)).then(function(){if(instance.client&&instance.client.tracker){instance.client.tracker._push_customvars();}});},});};;openerp.loempia=function(instance){instance.loempia={embed:{}};instance.web.client_actions.add("loempia.embed","instance.loempia.embed.Embed");instance.web.client_actions.add("loempia.embed.updates","instance.loempia.embed.Updates");instance.loempia.embed.get_version_info=function(){var self=instance.loempia.embed;var i0=openerp.instances.instance0;if(_.isUndefined(self._version_info)){return i0.session.rpc("/web/webclient/version_info",{}).then(function(version_info){self._version_info=version_info;return self._version_info;});}else{return $.Deferred().resolve(self._version_info).promise();}};instance.loempia.embed.get_local_modules=function(){var self=instance.loempia.embed;var i0=openerp.instances.instance0;if(_.isEmpty(self._local_modules)){return self.get_version_info().then(function(version_info){var M=new i0.web.Model('ir.module.module');var server_version=version_info.server_version.split('-')[0];self._local_modules={openerp:{name:'openerp',installed_version:server_version,latest_version:server_version,state:'installed'}};return M.query(['name','installed_version','latest_version','state']).all().then(function(result){_.each(result,function(m){if(m.name!='base'){self._local_modules[m.name]=m;}});return self._local_modules;});});}else{return $.Deferred().resolve(self._local_modules).promise();}};instance.loempia.embed.get_dbuuid=function(){var self=instance.loempia.embed;var i0=openerp.instances.instance0;if(_.isUndefined(self._dbuuid)){var P=new i0.web.Model('ir.config_parameter');return P.call('get_param',['database.uuid']).then(function(dbuuid){self._dbuuid=dbuuid;return dbuuid;});}else{return $.Deferred().resolve(self._dbuuid).promise();}};instance.loempia.embed.download=function(modules){var do_download=function(){var i0=openerp.instances.instance0;var e=instance.loempia.embed;i0.web.blockUI();$.when(e.get_version_info(),e.get_local_modules(),e.get_dbuuid()).done(function(){var data={module_names:modules,serie:e._version_info.server_serie,local_modules:e._local_modules,dbuuid:e._dbuuid};instance.session.rpc('/loempia/embed/download_urls',data).done(function(urls){e._local_modules=null;_.each(urls,function(u,m){if(u!==''){urls[m]=instance.session.origin+u;}});var M=new i0.web.Model('ir.module.module');var context={};M.call_button('install_from_urls',[urls,context]).always(function(){i0.web.unblockUI();}).done(function(action){if(!action){action={type:'ir.actions.client',tag:'home',params:{wait:true,},};}
i0.webclient.action_manager.do_action(action);});});});};if(instance.session.username!=='anonymous'){do_download();return;}
var IMD=new instance.web.Model('ir.model.data');return IMD.call('get_object_reference',['auth_oauth','provider_openerp']).then(function(ref){var Providers=new instance.web.Model('auth.oauth.provider');return Providers.call('read',[ref[1],['client_id','scope','auth_endpoint']]).then(function(provider){var e=instance.loempia.embed;return e.get_dbuuid().then(function(dbuuid){var i0=openerp.instances.instance0;var state={'h':i0.session.prefix,'m':modules.join(','),'d':instance.session.db,'p':provider.id};var ret=instance.session.prefix+'/loempia/embed/signin';if(i0.session.debug){ret+='?debug';}
var params={response_type:'token',client_id:dbuuid,redirect_uri:ret,scope:'userinfo apps',state:JSON.stringify(state)};if(i0.session.debug){params.debug=true;}
var url=provider.auth_endpoint+'?'+$.param(params);window.location=url;});});});};instance.loempia.embed.update_needaction_count=function(count){var self=instance.loempia.embed;var i0=openerp.instances.instance0;var get_upd_menu_id=function(){if(_.isUndefined(self._upd_menu_id)){var IMD=new i0.web.Model('ir.model.data');return IMD.call('get_object_reference',['base','menu_module_updates']).then(function(r){var mid=r[1];if(r[0]!=='ir.ui.menu'){mid=null;}
self._upd_menu_id=mid;return mid;});}else{return $.Deferred().resolve(self._upd_menu_id).promise();}};$.when(get_upd_menu_id()).done(function(menu_id){if(_.isNull(menu_id)){return;}
var $menu=i0.client.menu.$secondary_menus.find(_.str.sprintf('a[data-menu=%s]',menu_id));if($menu.length===0){return;}
if(_.isUndefined(count)){count=0;}
var needupdate=$menu.find('div.oe_menu_counter');if(needupdate&&needupdate.length!==0){if(count>0){needupdate.text(count);}else{needupdate.remove();}}else if(count>0){$menu.append(i0.web.qweb.render("Menu.needaction_counter",{widget:{needaction_counter:count}}));}});};instance.loempia.embed.get_updates=function(fields){var self=instance.loempia.embed;return self.get_local_modules().then(function(lm){var installed=_.filter(lm,function(m){return m.state==='installed';});var M=new instance.web.Model('loempia.module');var domain=[['name','in',_.pluck(installed,'name')]];fields=_.union(['name','version'],fields||[]);return M.query(fields).filter(domain).all().then(function(records){var result={};_.each(records,function(record){var localmod=lm[record.name];if(localmod&&localmod.installed_version!==record.version){result[record.name]={local:localmod,remote:record};}});return result;});});};instance.loempia.embed.update_needaction=function(){var self=instance.loempia.embed;self.get_updates().done(function(updates){var count=_.keys(updates).length;self.update_needaction_count(count);});};instance.loempia.embed.Embed=instance.web.Widget.extend({template:'EmptyComponent',start:function(){var self=this;var i0=openerp.instances.instance0;var e=instance.loempia.embed;instance.client.tracker._push_pageview('/stats/apps_embed');var current_action=i0.client.action_manager.inner_action;if(!current_action||current_action.tag!=='apps'){if(window.console){console.error('Invalid current_action, skipping start');}
return $.when();}
self.params=current_action.params||{};return e.get_version_info().done(function(version_info){if(self.params.error){if(window.console){console.error(self.params.error);}
i0.client.crashmanager.show_warning({type:i0.web._t("Error"),message:self.params.error,});}else if(self.params.modules){var modules=self.params.modules;if(_.isString(modules)){modules=modules.split(',');}
e.download(modules);}else{i0.web.blockUI();self.do_action({type:'ir.actions.act_window',name:'OpenERP Apps',res_model:'loempia.module',views:[[false,'kanban'],[false,'list'],[false,'form']],context:{openerp_serie:version_info.server_serie,search_default_app:true},domain:[['serie_id.name','=',version_info.server_serie],['category_id','!=','Technical Settings']],flags:{action_buttons:false,sidebar:false,},embedded:true},{clear_breadcrumbs:true}).always(function(){i0.web.unblockUI();}).done(function(){if(instance.session.username==='anonymous'){$('.oe_searchview_custom:has(>form)').remove();}else{$('#oe_searchview_custom_public, #oe_searchview_custom_public + label').remove();}
e.update_needaction();});}});},});instance.web_kanban.KanbanView.include({start:function(){if(this.dataset.model=='loempia.module'){this.local_modules={};this.embedded=this.getParent().action.embedded;if(this.embedded){var self=this,e=instance.loempia.embed,_super=this._super,args=arguments;return e.get_local_modules().then(function(lm){self.local_modules=lm;return _super.apply(self,args);});}}
return this._super.apply(this,arguments);}});instance.web_kanban.KanbanRecord.include({bind_events:function(){var self=this;this.$('.oe_loempia_details button[name=install]').click(function(){var local_mod=self.view.local_modules[self.record.name.raw_value];if(_.isUndefined(local_mod)||self.record.version.raw_value!=local_mod.installed_version){var e=instance.loempia.embed;e.download([self.record.name.raw_value]);}else{var i0=openerp.instances.instance0;var M=new i0.web.Model('ir.module.module');var context={};M.call_button('button_immediate_install',[[local_mod.id],context]).done(function(action){if(!action){action={type:'ir.actions.client',tag:'home',params:{wait:true,},};}
i0.webclient.action_manager.do_action(action);});}});return this._super.apply(this,arguments);}});instance.loempia.embed.Updates=instance.web.Widget.extend({template:'loempia.updates',appendTo:function(){var self=this,_super=this._super,args=arguments,e=instance.loempia.embed,fields=['name','version','shortdesc','release_date','changelog'];return e.get_updates(fields).then(function(updates){e.update_needaction();self.updates=updates;return _super.apply(self,args);});},start:function(){this.$('button[name=update]').click(function(){var modules=$(this).data('modules').split(',');var e=instance.loempia.embed;e.download(modules);});return this._super();},image_link:function(record){var url=instance.session.prefix+'/web/binary/image?session_id='+this.session.session_id+'&model=loempia.module&id='+record.id+'&field=icon_image&t='+(new Date().getTime());return url;},0:0});};;dhtmlxAjax={get:function(url,callback){var t=new dtmlXMLLoaderObject(true);t.async=(arguments.length<3);t.waitCall=callback;t.loadXML(url)
return t;},post:function(url,post,callback){var t=new dtmlXMLLoaderObject(true);t.async=(arguments.length<4);t.waitCall=callback;t.loadXML(url,true,post)
return t;},getSync:function(url){return this.get(url,null,true)},postSync:function(url,post){return this.post(url,post,null,true);}}
function dtmlXMLLoaderObject(funcObject,dhtmlObject,async,rSeed){this.xmlDoc="";if(typeof(async)!="undefined")
this.async=async;else
this.async=true;this.onloadAction=funcObject||null;this.mainObject=dhtmlObject||null;this.waitCall=null;this.rSeed=rSeed||false;return this;};dtmlXMLLoaderObject.prototype.waitLoadFunction=function(dhtmlObject){var once=true;this.check=function(){if((dhtmlObject)&&(dhtmlObject.onloadAction!=null)){if((!dhtmlObject.xmlDoc.readyState)||(dhtmlObject.xmlDoc.readyState==4)){if(!once)
return;once=false;if(typeof dhtmlObject.onloadAction=="function")
dhtmlObject.onloadAction(dhtmlObject.mainObject,null,null,null,dhtmlObject);if(dhtmlObject.waitCall){dhtmlObject.waitCall.call(this,dhtmlObject);dhtmlObject.waitCall=null;}}}};return this.check;};dtmlXMLLoaderObject.prototype.getXMLTopNode=function(tagName,oldObj){if(this.xmlDoc.responseXML){var temp=this.xmlDoc.responseXML.getElementsByTagName(tagName);if(temp.length==0&&tagName.indexOf(":")!=-1)
var temp=this.xmlDoc.responseXML.getElementsByTagName((tagName.split(":"))[1]);var z=temp[0];}else
var z=this.xmlDoc.documentElement;if(z){this._retry=false;return z;}
if((_isIE)&&(!this._retry)){var xmlString=this.xmlDoc.responseText;var oldObj=this.xmlDoc;this._retry=true;this.xmlDoc=new ActiveXObject("Microsoft.XMLDOM");this.xmlDoc.async=false;this.xmlDoc["loadXM"+"L"](xmlString);return this.getXMLTopNode(tagName,oldObj);}
dhtmlxError.throwError("LoadXML","Incorrect XML",[(oldObj||this.xmlDoc),this.mainObject]);return document.createElement("DIV");};dtmlXMLLoaderObject.prototype.loadXMLString=function(xmlString){{try{var parser=new DOMParser();this.xmlDoc=parser.parseFromString(xmlString,"text/xml");}
catch(e){this.xmlDoc=new ActiveXObject("Microsoft.XMLDOM");this.xmlDoc.async=this.async;this.xmlDoc["loadXM"+"L"](xmlString);}}
this.onloadAction(this.mainObject,null,null,null,this);if(this.waitCall){this.waitCall();this.waitCall=null;}}
dtmlXMLLoaderObject.prototype.loadXML=function(filePath,postMode,postVars,rpc){if(this.rSeed)
filePath+=((filePath.indexOf("?")!=-1)?"&":"?")+"a_dhx_rSeed="+(new Date()).valueOf();this.filePath=filePath;if((!_isIE)&&(window.XMLHttpRequest))
this.xmlDoc=new XMLHttpRequest();else{if(document.implementation&&document.implementation.createDocument){this.xmlDoc=document.implementation.createDocument("","",null);this.xmlDoc.onload=new this.waitLoadFunction(this);this.xmlDoc.load(filePath);return;}else
this.xmlDoc=new ActiveXObject("Microsoft.XMLHTTP");}
if(this.async)
this.xmlDoc.onreadystatechange=new this.waitLoadFunction(this);this.xmlDoc.open(postMode?"POST":"GET",filePath,this.async);if(rpc){this.xmlDoc.setRequestHeader("User-Agent","dhtmlxRPC v0.1 ("+navigator.userAgent+")");this.xmlDoc.setRequestHeader("Content-type","text/xml");}
else if(postMode)
this.xmlDoc.setRequestHeader('Content-type','application/x-www-form-urlencoded');this.xmlDoc.setRequestHeader("X-Requested-With","XMLHttpRequest");this.xmlDoc.send(null||postVars);if(!this.async)
(new this.waitLoadFunction(this))();};dtmlXMLLoaderObject.prototype.destructor=function(){this._filterXPath=null;this._getAllNamedChilds=null;this._retry=null;this.async=null;this.rSeed=null;this.filePath=null;this.onloadAction=null;this.mainObject=null;this.xmlDoc=null;this.doXPath=null;this.doXPathOpera=null;this.doXSLTransToObject=null;this.doXSLTransToString=null;this.loadXML=null;this.loadXMLString=null;this.doSerialization=null;this.xmlNodeToJSON=null;this.getXMLTopNode=null;this.setXSLParamValue=null;return null;}
dtmlXMLLoaderObject.prototype.xmlNodeToJSON=function(node){var t={};for(var i=0;i<node.attributes.length;i++)
t[node.attributes[i].name]=node.attributes[i].value;t["_tagvalue"]=node.firstChild?node.firstChild.nodeValue:"";for(var i=0;i<node.childNodes.length;i++){var name=node.childNodes[i].tagName;if(name){if(!t[name])t[name]=[];t[name].push(this.xmlNodeToJSON(node.childNodes[i]));}}
return t;}
function callerFunction(funcObject,dhtmlObject){this.handler=function(e){if(!e)
e=window.event;funcObject(e,dhtmlObject);return true;};return this.handler;};function getAbsoluteLeft(htmlObject){return getOffset(htmlObject).left;}
function getAbsoluteTop(htmlObject){return getOffset(htmlObject).top;}
function getOffsetSum(elem){var top=0,left=0;while(elem){top=top+parseInt(elem.offsetTop);left=left+parseInt(elem.offsetLeft);elem=elem.offsetParent;}
return{top:top,left:left};}
function getOffsetRect(elem){var box=elem.getBoundingClientRect();var body=document.body;var docElem=document.documentElement;var scrollTop=window.pageYOffset||docElem.scrollTop||body.scrollTop;var scrollLeft=window.pageXOffset||docElem.scrollLeft||body.scrollLeft;var clientTop=docElem.clientTop||body.clientTop||0;var clientLeft=docElem.clientLeft||body.clientLeft||0;var top=box.top+scrollTop-clientTop;var left=box.left+scrollLeft-clientLeft;return{top:Math.round(top),left:Math.round(left)};}
function getOffset(elem){if(elem.getBoundingClientRect){return getOffsetRect(elem);}else{return getOffsetSum(elem);}}
function convertStringToBoolean(inputString){if(typeof(inputString)=="string")
inputString=inputString.toLowerCase();switch(inputString){case"1":case"true":case"yes":case"y":case 1:case true:return true;break;default:return false;}}
function getUrlSymbol(str){if(str.indexOf("?")!=-1)
return"&"
else
return"?"}
function dhtmlDragAndDropObject(){if(window.dhtmlDragAndDrop)
return window.dhtmlDragAndDrop;this.lastLanding=0;this.dragNode=0;this.dragStartNode=0;this.dragStartObject=0;this.tempDOMU=null;this.tempDOMM=null;this.waitDrag=0;window.dhtmlDragAndDrop=this;return this;};dhtmlDragAndDropObject.prototype.removeDraggableItem=function(htmlNode){htmlNode.onmousedown=null;htmlNode.dragStarter=null;htmlNode.dragLanding=null;}
dhtmlDragAndDropObject.prototype.addDraggableItem=function(htmlNode,dhtmlObject){htmlNode.onmousedown=this.preCreateDragCopy;htmlNode.dragStarter=dhtmlObject;this.addDragLanding(htmlNode,dhtmlObject);}
dhtmlDragAndDropObject.prototype.addDragLanding=function(htmlNode,dhtmlObject){htmlNode.dragLanding=dhtmlObject;}
dhtmlDragAndDropObject.prototype.preCreateDragCopy=function(e){if((e||window.event)&&(e||event).button==2)
return;if(window.dhtmlDragAndDrop.waitDrag){window.dhtmlDragAndDrop.waitDrag=0;document.body.onmouseup=window.dhtmlDragAndDrop.tempDOMU;document.body.onmousemove=window.dhtmlDragAndDrop.tempDOMM;return false;}
window.dhtmlDragAndDrop.waitDrag=1;window.dhtmlDragAndDrop.tempDOMU=document.body.onmouseup;window.dhtmlDragAndDrop.tempDOMM=document.body.onmousemove;window.dhtmlDragAndDrop.dragStartNode=this;window.dhtmlDragAndDrop.dragStartObject=this.dragStarter;document.body.onmouseup=window.dhtmlDragAndDrop.preCreateDragCopy;document.body.onmousemove=window.dhtmlDragAndDrop.callDrag;window.dhtmlDragAndDrop.downtime=new Date().valueOf();if((e)&&(e.preventDefault)){e.preventDefault();return false;}
return false;};dhtmlDragAndDropObject.prototype.callDrag=function(e){if(!e)
e=window.event;dragger=window.dhtmlDragAndDrop;if((new Date()).valueOf()-dragger.downtime<100)return;if((e.button==0)&&(_isIE))
return dragger.stopDrag();if(!dragger.dragNode&&dragger.waitDrag){dragger.dragNode=dragger.dragStartObject._createDragNode(dragger.dragStartNode,e);if(!dragger.dragNode)
return dragger.stopDrag();dragger.dragNode.onselectstart=function(){return false;}
dragger.gldragNode=dragger.dragNode;document.body.appendChild(dragger.dragNode);document.body.onmouseup=dragger.stopDrag;dragger.waitDrag=0;dragger.dragNode.pWindow=window;dragger.initFrameRoute();}
if(dragger.dragNode.parentNode!=window.document.body){var grd=dragger.gldragNode;if(dragger.gldragNode.old)
grd=dragger.gldragNode.old;grd.parentNode.removeChild(grd);var oldBody=dragger.dragNode.pWindow;if(grd.pWindow&&grd.pWindow.dhtmlDragAndDrop.lastLanding)
grd.pWindow.dhtmlDragAndDrop.lastLanding.dragLanding._dragOut(grd.pWindow.dhtmlDragAndDrop.lastLanding);if(_isIE){var div=document.createElement("Div");div.innerHTML=dragger.dragNode.outerHTML;dragger.dragNode=div.childNodes[0];}else
dragger.dragNode=dragger.dragNode.cloneNode(true);dragger.dragNode.pWindow=window;dragger.gldragNode.old=dragger.dragNode;document.body.appendChild(dragger.dragNode);oldBody.dhtmlDragAndDrop.dragNode=dragger.dragNode;}
dragger.dragNode.style.left=e.clientX+15+(dragger.fx?dragger.fx*(-1):0)
+(document.body.scrollLeft||document.documentElement.scrollLeft)+"px";dragger.dragNode.style.top=e.clientY+3+(dragger.fy?dragger.fy*(-1):0)
+(document.body.scrollTop||document.documentElement.scrollTop)+"px";if(!e.srcElement)
var z=e.target;else
z=e.srcElement;dragger.checkLanding(z,e);}
dhtmlDragAndDropObject.prototype.calculateFramePosition=function(n){if(window.name){var el=parent.frames[window.name].frameElement.offsetParent;var fx=0;var fy=0;while(el){fx+=el.offsetLeft;fy+=el.offsetTop;el=el.offsetParent;}
if((parent.dhtmlDragAndDrop)){var ls=parent.dhtmlDragAndDrop.calculateFramePosition(1);fx+=ls.split('_')[0]*1;fy+=ls.split('_')[1]*1;}
if(n)
return fx+"_"+fy;else
this.fx=fx;this.fy=fy;}
return"0_0";}
dhtmlDragAndDropObject.prototype.checkLanding=function(htmlObject,e){if((htmlObject)&&(htmlObject.dragLanding)){if(this.lastLanding)
this.lastLanding.dragLanding._dragOut(this.lastLanding);this.lastLanding=htmlObject;this.lastLanding=this.lastLanding.dragLanding._dragIn(this.lastLanding,this.dragStartNode,e.clientX,e.clientY,e);this.lastLanding_scr=(_isIE?e.srcElement:e.target);}else{if((htmlObject)&&(htmlObject.tagName!="BODY"))
this.checkLanding(htmlObject.parentNode,e);else{if(this.lastLanding)
this.lastLanding.dragLanding._dragOut(this.lastLanding,e.clientX,e.clientY,e);this.lastLanding=0;if(this._onNotFound)
this._onNotFound();}}}
dhtmlDragAndDropObject.prototype.stopDrag=function(e,mode){dragger=window.dhtmlDragAndDrop;if(!mode){dragger.stopFrameRoute();var temp=dragger.lastLanding;dragger.lastLanding=null;if(temp)
temp.dragLanding._drag(dragger.dragStartNode,dragger.dragStartObject,temp,(_isIE?event.srcElement:e.target));}
dragger.lastLanding=null;if((dragger.dragNode)&&(dragger.dragNode.parentNode==document.body))
dragger.dragNode.parentNode.removeChild(dragger.dragNode);dragger.dragNode=0;dragger.gldragNode=0;dragger.fx=0;dragger.fy=0;dragger.dragStartNode=0;dragger.dragStartObject=0;document.body.onmouseup=dragger.tempDOMU;document.body.onmousemove=dragger.tempDOMM;dragger.tempDOMU=null;dragger.tempDOMM=null;dragger.waitDrag=0;}
dhtmlDragAndDropObject.prototype.stopFrameRoute=function(win){if(win)
window.dhtmlDragAndDrop.stopDrag(1,1);for(var i=0;i<window.frames.length;i++){try{if((window.frames[i]!=win)&&(window.frames[i].dhtmlDragAndDrop))
window.frames[i].dhtmlDragAndDrop.stopFrameRoute(window);}catch(e){}}
try{if((parent.dhtmlDragAndDrop)&&(parent!=window)&&(parent!=win))
parent.dhtmlDragAndDrop.stopFrameRoute(window);}catch(e){}}
dhtmlDragAndDropObject.prototype.initFrameRoute=function(win,mode){if(win){window.dhtmlDragAndDrop.preCreateDragCopy();window.dhtmlDragAndDrop.dragStartNode=win.dhtmlDragAndDrop.dragStartNode;window.dhtmlDragAndDrop.dragStartObject=win.dhtmlDragAndDrop.dragStartObject;window.dhtmlDragAndDrop.dragNode=win.dhtmlDragAndDrop.dragNode;window.dhtmlDragAndDrop.gldragNode=win.dhtmlDragAndDrop.dragNode;window.document.body.onmouseup=window.dhtmlDragAndDrop.stopDrag;window.waitDrag=0;if(((!_isIE)&&(mode))&&((!_isFF)||(_FFrv<1.8)))
window.dhtmlDragAndDrop.calculateFramePosition();}
try{if((parent.dhtmlDragAndDrop)&&(parent!=window)&&(parent!=win))
parent.dhtmlDragAndDrop.initFrameRoute(window);}catch(e){}
for(var i=0;i<window.frames.length;i++){try{if((window.frames[i]!=win)&&(window.frames[i].dhtmlDragAndDrop))
window.frames[i].dhtmlDragAndDrop.initFrameRoute(window,((!win||mode)?1:0));}catch(e){}}}
var _isFF=false;var _isIE=false;var _isOpera=false;var _isKHTML=false;var _isMacOS=false;var _isChrome=false;if(navigator.userAgent.indexOf('Macintosh')!=-1)
_isMacOS=true;if(navigator.userAgent.toLowerCase().indexOf('chrome')>-1)
_isChrome=true;if((navigator.userAgent.indexOf('Safari')!=-1)||(navigator.userAgent.indexOf('Konqueror')!=-1)){var _KHTMLrv=parseFloat(navigator.userAgent.substr(navigator.userAgent.indexOf('Safari')+7,5));if(_KHTMLrv>525){_isFF=true;var _FFrv=1.9;}else
_isKHTML=true;}else if(navigator.userAgent.indexOf('Opera')!=-1){_isOpera=true;_OperaRv=parseFloat(navigator.userAgent.substr(navigator.userAgent.indexOf('Opera')+6,3));}
else if(navigator.appName.indexOf("Microsoft")!=-1){_isIE=true;if(navigator.appVersion.indexOf("MSIE 8.0")!=-1&&document.compatMode!="BackCompat")_isIE=8;}else{_isFF=true;var _FFrv=parseFloat(navigator.userAgent.split("rv:")[1])}
dtmlXMLLoaderObject.prototype.doXPath=function(xpathExp,docObj,namespace,result_type){if(_isKHTML||(!_isIE&&!window.XPathResult))
return this.doXPathOpera(xpathExp,docObj);if(_isIE){if(!docObj)
if(!this.xmlDoc.nodeName)
docObj=this.xmlDoc.responseXML
else
docObj=this.xmlDoc;if(!docObj)
dhtmlxError.throwError("LoadXML","Incorrect XML",[(docObj||this.xmlDoc),this.mainObject]);if(namespace!=null)
docObj.setProperty("SelectionNamespaces","xmlns:xsl='"+namespace+"'");if(result_type=='single'){return docObj.selectSingleNode(xpathExp);}
else{return docObj.selectNodes(xpathExp)||new Array(0);}}else{var nodeObj=docObj;if(!docObj){if(!this.xmlDoc.nodeName){docObj=this.xmlDoc.responseXML}
else{docObj=this.xmlDoc;}}
if(!docObj)
dhtmlxError.throwError("LoadXML","Incorrect XML",[(docObj||this.xmlDoc),this.mainObject]);if(docObj.nodeName.indexOf("document")!=-1){nodeObj=docObj;}
else{nodeObj=docObj;docObj=docObj.ownerDocument;}
var retType=XPathResult.ANY_TYPE;if(result_type=='single')
retType=XPathResult.FIRST_ORDERED_NODE_TYPE
var rowsCol=new Array();var col=docObj.evaluate(xpathExp,nodeObj,function(pref){return namespace},retType,null);if(retType==XPathResult.FIRST_ORDERED_NODE_TYPE){return col.singleNodeValue;}
var thisColMemb=col.iterateNext();while(thisColMemb){rowsCol[rowsCol.length]=thisColMemb;thisColMemb=col.iterateNext();}
return rowsCol;}}
function _dhtmlxError(type,name,params){if(!this.catches)
this.catches=new Array();return this;}
_dhtmlxError.prototype.catchError=function(type,func_name){this.catches[type]=func_name;}
_dhtmlxError.prototype.throwError=function(type,name,params){if(this.catches[type])
return this.catches[type](type,name,params);if(this.catches["ALL"])
return this.catches["ALL"](type,name,params);alert("Error type: "+arguments[0]+"\nDescription: "+arguments[1]);return null;}
window.dhtmlxError=new _dhtmlxError();dtmlXMLLoaderObject.prototype.doXPathOpera=function(xpathExp,docObj){var z=xpathExp.replace(/[\/]+/gi,"/").split('/');var obj=null;var i=1;if(!z.length)
return[];if(z[0]==".")
obj=[docObj];else if(z[0]==""){obj=(this.xmlDoc.responseXML||this.xmlDoc).getElementsByTagName(z[i].replace(/\[[^\]]*\]/g,""));i++;}else
return[];for(i;i<z.length;i++)obj=this._getAllNamedChilds(obj,z[i]);if(z[i-1].indexOf("[")!=-1)
obj=this._filterXPath(obj,z[i-1]);return obj;}
dtmlXMLLoaderObject.prototype._filterXPath=function(a,b){var c=new Array();var b=b.replace(/[^\[]*\[\@/g,"").replace(/[\[\]\@]*/g,"");for(var i=0;i<a.length;i++)
if(a[i].getAttribute(b))
c[c.length]=a[i];return c;}
dtmlXMLLoaderObject.prototype._getAllNamedChilds=function(a,b){var c=new Array();if(_isKHTML)
b=b.toUpperCase();for(var i=0;i<a.length;i++)for(var j=0;j<a[i].childNodes.length;j++){if(_isKHTML){if(a[i].childNodes[j].tagName&&a[i].childNodes[j].tagName.toUpperCase()==b)
c[c.length]=a[i].childNodes[j];}
else if(a[i].childNodes[j].tagName==b)
c[c.length]=a[i].childNodes[j];}
return c;}
function dhtmlXHeir(a,b){for(var c in b)
if(typeof(b[c])=="function")
a[c]=b[c];return a;}
function dhtmlxEvent(el,event,handler){if(el.addEventListener)
el.addEventListener(event,handler,false);else if(el.attachEvent)
el.attachEvent("on"+event,handler);}
dtmlXMLLoaderObject.prototype.xslDoc=null;dtmlXMLLoaderObject.prototype.setXSLParamValue=function(paramName,paramValue,xslDoc){if(!xslDoc)
xslDoc=this.xslDoc
if(xslDoc.responseXML)
xslDoc=xslDoc.responseXML;var item=this.doXPath("/xsl:stylesheet/xsl:variable[@name='"+paramName+"']",xslDoc,"http:/\/www.w3.org/1999/XSL/Transform","single");if(item!=null)
item.firstChild.nodeValue=paramValue}
dtmlXMLLoaderObject.prototype.doXSLTransToObject=function(xslDoc,xmlDoc){if(!xslDoc)
xslDoc=this.xslDoc;if(xslDoc.responseXML)
xslDoc=xslDoc.responseXML
if(!xmlDoc)
xmlDoc=this.xmlDoc;if(xmlDoc.responseXML)
xmlDoc=xmlDoc.responseXML
if(!_isIE){if(!this.XSLProcessor){this.XSLProcessor=new XSLTProcessor();this.XSLProcessor.importStylesheet(xslDoc);}
var result=this.XSLProcessor.transformToDocument(xmlDoc);}else{var result=new ActiveXObject("Msxml2.DOMDocument.3.0");try{xmlDoc.transformNodeToObject(xslDoc,result);}catch(e){result=xmlDoc.transformNode(xslDoc);}}
return result;}
dtmlXMLLoaderObject.prototype.doXSLTransToString=function(xslDoc,xmlDoc){var res=this.doXSLTransToObject(xslDoc,xmlDoc);if(typeof(res)=="string")
return res;return this.doSerialization(res);}
dtmlXMLLoaderObject.prototype.doSerialization=function(xmlDoc){if(!xmlDoc)
xmlDoc=this.xmlDoc;if(xmlDoc.responseXML)
xmlDoc=xmlDoc.responseXML
if(!_isIE){var xmlSerializer=new XMLSerializer();return xmlSerializer.serializeToString(xmlDoc);}else
return xmlDoc.xml;}
dhtmlxEventable=function(obj){obj.attachEvent=function(name,catcher,callObj){name='ev_'+name.toLowerCase();if(!this[name])
this[name]=new this.eventCatcher(callObj||this);return(name+':'+this[name].addEvent(catcher));}
obj.callEvent=function(name,arg0){name='ev_'+name.toLowerCase();if(this[name])
return this[name].apply(this,arg0);return true;}
obj.checkEvent=function(name){return(!!this['ev_'+name.toLowerCase()])}
obj.eventCatcher=function(obj){var dhx_catch=[];var z=function(){var res=true;for(var i=0;i<dhx_catch.length;i++){if(dhx_catch[i]!=null){var zr=dhx_catch[i].apply(obj,arguments);res=res&&zr;}}
return res;}
z.addEvent=function(ev){if(typeof(ev)!="function")
ev=eval(ev);if(ev)
return dhx_catch.push(ev)-1;return false;}
z.removeEvent=function(id){dhx_catch[id]=null;}
return z;}
obj.detachEvent=function(id){if(id!=false){var list=id.split(':');this[list[0]].removeEvent(list[1]);}}
obj.detachAllEvents=function(){for(var name in this){if(name.indexOf("ev_")==0)
delete this[name];}}};function GanttProjectInfo(id,name,startDate)
{this.Id=id;this.Name=name;this.StartDate=startDate;this.ParentTasks=[];}
GanttProjectInfo.prototype.deleteTask=function(id)
{var task=this.getTaskById(id);if(task){if(!task.ParentTask){for(var i=0;i<this.ParentTasks.length;i++){if(this.ParentTasks[i].Id==id){if(this.ParentTasks[i].nextParentTask){if(this.ParentTasks[i].previousParentTask){this.ParentTasks[i].previousParentTask.nextParentTask=this.ParentTasks[i].nextParentTask;this.ParentTasks[i].nextParentTask.previousParentTask=this.ParentTasks[i].previousParentTask;}else{this.ParentTasks[i].nextParentTask.previousParentTask=null;}}else{if(this.ParentTasks[i].previousParentTask){this.ParentTasks[i].previousParentTask.nextParentTask=null;}}
this.ParentTasks[i]=null;this.ParentTasks.splice(i,1);break;}}}else
{var parentTask=task.ParentTask;for(var i=0;i<parentTask.ChildTasks.length;i++){if(parentTask.ChildTasks[i].Id==id){if(parentTask.ChildTasks[i].nextChildTask){if(parentTask.ChildTasks[i].previousChildTask){parentTask.ChildTasks[i].previousChildTask.nextChildTask=parentTask.ChildTasks[i].nextChildTask;parentTask.ChildTasks[i].nextChildTask.previousChildTask=parentTask.ChildTasks[i].previousChildTask;}else{parentTask.ChildTasks[i].nextChildTask.previousChildTask=null;}}else{if(parentTask.ChildTasks[i].previousChildTask){parentTask.ChildTasks[i].previousChildTask.nextChildTask=null;}}
parentTask.ChildTasks[i]=null;parentTask.ChildTasks.splice(i,1);break;}}}}};GanttProjectInfo.prototype.addTask=function(task)
{this.ParentTasks.push(task);task.setProject(this);};GanttProjectInfo.prototype.getTaskById=function(id)
{for(var j=0;j<this.ParentTasks.length;j++)
{var task=this.getTaskByIdInTree(this.ParentTasks[j],id);if(task)return task;}
return null;};GanttProjectInfo.prototype.getTaskByIdInTree=function(parentTask,id)
{if(parentTask.Id==id)
{return parentTask;}else
{for(var i=0;i<parentTask.ChildTasks.length;i++){if(parentTask.ChildTasks[i].Id==id)
{return parentTask.ChildTasks[i];}
if(parentTask.ChildTasks[i].ChildTasks.length>0)
{if(parentTask.ChildTasks[i].ChildTasks.length>0)
{var cTask=this.getTaskByIdInTree(parentTask.ChildTasks[i],id);if(cTask)return cTask;}}}}
return null;};function GanttTaskInfo(id,name,est,duration,percentCompleted,predecessorTaskId)
{this.Id=id;this.Name=name;this.EST=est;this.Duration=duration;this.PercentCompleted=percentCompleted;this.PredecessorTaskId=predecessorTaskId;this.ChildTasks=[];this.ChildPredTasks=[];this.ParentTask=null;this.PredecessorTask=null;this.Project=null;this.nextChildTask=null;this.previousChildTask=null;this.nextParentTask=null;this.previousParentTask=null;}
GanttTaskInfo.prototype.addChildTask=function(task)
{this.ChildTasks.push(task);task.ParentTask=this;};GanttTaskInfo.prototype.setProject=function(project)
{this.Project=project;for(var j=0;j<this.ChildTasks.length;j++)
{this.ChildTasks[j].setProject(project);}};function GanttTask(taskInfo,project,chart)
{this.isTask=true;this.Chart=chart;this.Project=project;this.TaskInfo=taskInfo;this.checkMove=false;this.checkResize=false;this.moveChild=false;this.maxPosXMove=-1;this.minPosXMove=-1;this.maxWidthResize=-1;this.minWidthResize=-1;this.posX=0;this.posY=0;this.MouseX=0;this.taskItemWidth=0;this.isHide=false;this._heightHideTasks=0;this._isOpen=true;this.descrTask=null;this.cTaskItem=null;this.cTaskNameItem=null;this.parentTask=null;this.predTask=null;this.childTask=[];this.childPredTask=[];this.nextChildTask=null;this.previousChildTask=null;this.nextParentTask=null;this.previousParentTask=null;}
function GanttProject(Chart,projectInfo)
{this.isProject=true;this.nextProject=null;this.previousProject=null;this.arrTasks=[];this.Project=projectInfo;this.Chart=Chart;this.percentCompleted=0;this.Duration=0;this.descrProject=null;this.projectItem=null;this.projectNameItem=null;this.posY=0;this.posX=0;}
GanttProject.prototype.checkWidthProjectNameItem=function()
{if(this.projectNameItem.offsetWidth+this.projectNameItem.offsetLeft>this.Chart.maxWidthPanelNames)
{var width=this.projectNameItem.offsetWidth+this.projectNameItem.offsetLeft-this.Chart.maxWidthPanelNames;var countChar=Math.round(width/(this.projectNameItem.offsetWidth/this.projectNameItem.firstChild.length));var pName=this.Project.Name.substring(0,this.projectNameItem.firstChild.length-countChar-3);pName+="...";this.projectNameItem.innerHTML=pName;}};GanttProject.prototype.create=function()
{var containerTasks=this.Chart.oData.firstChild;this.posX=(this.Project.StartDate-this.Chart.startDate)/(60*60*1000)*this.Chart.hourInPixels;if(this.previousProject)
{if(this.previousProject.arrTasks.length>0){var lastChildTask=this.Chart.getLastChildTask(this.previousProject.arrTasks[this.previousProject.arrTasks.length-1]);this.posY=parseInt(lastChildTask.cTaskItem[0].style.top)+this.Chart.heightTaskItem+11;}else{this.posY=parseInt(this.previousProject.projectItem[0].style.top)+this.Chart.heightTaskItem+11;}}else{this.posY=6;}
if(this.Chart._showTreePanel){var containerNames=this.Chart.panelNames.firstChild;this.projectNameItem=this.createProjectNameItem();containerNames.appendChild(this.projectNameItem);this.checkWidthProjectNameItem();}
this.projectItem=[this.createProjectItem(),[]];containerTasks.appendChild(this.projectItem[0]);if(this.Chart.isShowDescProject){containerTasks.appendChild(this.createDescrProject());}
this.addDayInPanelTime();};function GanttChart()
{this.Error=new GanttError();this.dhtmlXMLSenderObject=new dhtmlXMLSenderObject(this);this.heightTaskItem=12;this.dayInPixels=24;this.hoursInDay=8;this._showTreePanel=true;this._showTooltip=true;this.isShowDescTask=false;this.isShowDescProject=false;this.isShowNewProject=true;this.isEditable=false;this.isShowConMenu=false;this.correctError=false;this.maxWidthPanelNames=150;this.minWorkLength=8;this.paramShowTask=[];this.paramShowProject=[];this.savePath=null;this.loadPath=null;this.divTimeInfo=null;this.divInfo=null;this.panelNames=null;this.panelTime=null;this.oData=null;this.content=null;this.panelErrors=null;this.contextMenu=null;this.hourInPixelsWork=this.dayInPixels/this.hoursInDay;this.hourInPixels=this.dayInPixels/24;this.countDays=0;this.startDate=null;this.initialPos=0;this.contentHeight=0;this.contentWidth=0;this._oDataHeight=0;this.Project=[];this.arrProjects=[];this.xmlLoader=null;this._isIE=false;this._isFF=false;this._isOpera=false;this._isMove=false;this._isResize=false;this._isError=false;this.imgs="codebase/imgs/";this.stylePath="codebase/dhtmlxgantt.css";this.shortMonthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];this.monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];this._useShortMonthNames=true;dhtmlxEventable(this);}
GanttChart.prototype.setImagePath=function(newPath)
{this.imgs=newPath;};GanttChart.prototype.setStylePath=function(newPath)
{this.stylePath=newPath;};GanttChart.prototype.setSavePath=function(newPath)
{this.savePath=newPath;};GanttChart.prototype.setLoadPath=function(newPath)
{this.loadPath=newPath;};GanttChart.prototype.setCorrectError=function(isCorrectError)
{this.correctError=isCorrectError;};GanttChart.prototype.showDescTask=function(isShowDescTask,param)
{this.isShowDescTask=isShowDescTask;var arrValues=new Array(5);if(this.isShowDescTask)
{if(param){var arrParam=param.split(",");for(var i=0;i<arrParam.length;i++){var k=this.getParamShowTask(arrParam[i]);arrValues[k]=1;}}else{arrValues[this.getParamShowTask('')]=1;}
this.paramShowTask=this.getValueShowTask(arrValues);}};GanttChart.prototype.showDescProject=function(isShowDescProject,param)
{this.isShowDescProject=isShowDescProject;var arrValues=new Array(4);if(this.isShowDescProject)
{if(param){var arrParam=param.split(",");for(var i=0;i<arrParam.length;i++){var k=this.getParamShowProject(arrParam[i]);arrValues[k]=1;}}else{arrValues[this.getParamShowProject('')]=1;}
this.paramShowProject=this.getValueShowProject(arrValues);}};GanttChart.prototype.showContextMenu=function(show)
{this.isShowConMenu=show;};GanttChart.prototype.setContextMenu=function(menu)
{this.showContextMenu(true);this.contextMenu=menu;};GanttChart.prototype.showNewProject=function(show)
{this.isShowNewProject=show;};GanttChart.prototype.getParamShowTask=function(param)
{switch(param){case'n':return 0;break;case'd':return 1;break;case'e':return 2;break;case'p':return 3;break;case's-f':return 4;break;default:return 0;break;}};GanttChart.prototype.getParamShowProject=function(param)
{switch(param){case'n':return 0;break;case'd':return 1;break;case's':return 2;break;case'p':return 3;break;default:return 0;break;}};GanttChart.prototype.getValueShowTask=function(param)
{var arrValues=[];for(var i=0;i<param.length;i++){if(param[i])
{switch(i){case 0:arrValues.push('Name');break;case 1:arrValues.push('Duration');break;case 2:arrValues.push('EST');break;case 3:arrValues.push('PercentComplete');break;case 4:arrValues.push('S-F');break;default:break;}}}
return arrValues;};GanttChart.prototype.getValueShowProject=function(param)
{var arrValues=[];for(var i=0;i<param.length;i++){if(param[i])
{switch(i){case 0:arrValues.push('Name');break;case 1:arrValues.push('Duration');break;case 2:arrValues.push('StartDate');break;case 3:arrValues.push('PercentComplete');break;default:break;}}}
return arrValues;};GanttChart.prototype.setEditable=function(isEditable)
{this.isEditable=isEditable;};GanttChart.prototype.showTreePanel=function(show)
{this._showTreePanel=show;};GanttChart.prototype.showTooltip=function(show)
{this._showTooltip=show;};GanttChart.prototype.getProjectById=function(id)
{for(var i=0;i<this.arrProjects.length;i++){if(this.arrProjects[i].Project.Id==id)
{return this.arrProjects[i];}}
return null;};GanttChart.prototype.getBrowserType=function()
{if(navigator.appName.indexOf('Explorer')!=-1)
{this._isIE=true;}else if(navigator.userAgent.indexOf('Mozilla')!=-1)
{this._isFF=true;}else if(navigator.userAgent.indexOf('Opera')!=-1)
{this._isOpera=true;}};GanttChart.prototype.addProject=function(projectInfo)
{this.Project.push(projectInfo);};GanttProject.prototype.deleteTask=function(id)
{var task=this.getTaskById(id);if(task){this.deleteChildTask(task);}else{this.Chart.Error.throwError("DATA_INSERT_ERROR",30,[id]);}};GanttChart.prototype.deleteProject=function(id)
{var project=this.getProjectById(id);if(project)
{if(project.arrTasks.length>0)
{while(project.arrTasks.length>0){project.deleteChildTask(project.arrTasks[0]);}}
if(project.nextProject)project.shiftNextProject(project,-23);for(var i=0;i<this.Project.length;i++){if(this.Project[i].Id==project.Project.Id){this.Project.splice(i,1);}}
if((project.previousProject)&&(project.nextProject))
{var previousProject=project.previousProject;previousProject.nextProject=project.nextProject;}
if((project.previousProject)&&!(project.nextProject))
{var previousProject=project.previousProject;previousProject.nextProject=null;}
if(!(project.previousProject)&&(project.nextProject))
{var nextProject=project.nextProject;nextProject.previousProject=null;}
for(var i=0;i<this.arrProjects.length;i++){if(this.arrProjects[i].Project.Id==id)
{this.arrProjects.splice(i,1);}}
project.projectItem[0].parentNode.removeChild(project.projectItem[0]);if(this.isShowDescProject){project.descrProject.parentNode.removeChild(project.descrProject);}
if(this._showTreePanel){project.projectNameItem.parentNode.removeChild(project.projectNameItem);}
this._oDataHeight-=11+this.heightTaskItem;if(this.Project.length==0)
{if(this.isShowNewProject)
{var d=new Date(this.startDate);var t=new Date(d.setDate(d.getDate()+1));var pi=new GanttProjectInfo(1,"New project",t);this.Project.push(pi);var project=new GanttProject(this,pi);project.create();this.arrProjects.push(project);this._oDataHeight+=11+this.heightTaskItem;}}}else{this.Error.throwError("DATA_INSERT_ERROR",31,[id]);}};GanttProject.prototype.setName=function(name)
{if((name!="")&&(name!=null)){this.Project.Name=name;if(this.Chart._showTreePanel)
{this.projectNameItem.innerHTML=name;this.projectNameItem.title=name;this.checkWidthProjectNameItem();}
if(this.Chart.isShowDescProject)this.descrProject.innerHTML=this.getDescStr();this.addDayInPanelTime();}};GanttProject.prototype.setPercentCompleted=function(percentCompleted)
{percentCompleted=parseInt(percentCompleted);if(isNaN(percentCompleted))
{this.Chart.Error.throwError("DATA_INSERT_ERROR",6,null);return false;}
if(percentCompleted>100)
{this.Chart.Error.throwError("DATA_INSERT_ERROR",7,null);return false;}else if(percentCompleted<0)
{this.Chart.Error.throwError("DATA_INSERT_ERROR",8,null);return false;}
if((percentCompleted>0)&&(percentCompleted<100)&&(this.percentCompleted>0)&&(this.percentCompleted<100))
{this.projectItem[0].firstChild.rows[0].cells[0].width=parseInt(percentCompleted)+"%";this.projectItem[0].firstChild.rows[0].cells[0].firstChild.style.width=(percentCompleted*this.Duration*this.Chart.hourInPixelsWork)/100+"px";this.projectItem[0].firstChild.rows[0].cells[1].width=(100-parseInt(percentCompleted))+"%";this.projectItem[0].firstChild.rows[0].cells[1].firstChild.style.width=((100-percentCompleted)*this.Duration*this.Chart.hourInPixelsWork)/100+"px";}else if(((percentCompleted==0)||(percentCompleted==100))&&(this.percentCompleted>0)&&(this.percentCompleted<100))
{if(percentCompleted==0)
{this.projectItem[0].firstChild.rows[0].cells[0].parentNode.removeChild(this.projectItem[0].firstChild.rows[0].cells[0]);this.projectItem[0].firstChild.rows[0].cells[0].width=100+"%";this.projectItem[0].firstChild.rows[0].cells[0].firstChild.style.width=this.Duration*this.Chart.hourInPixelsWork+"px";}else if(percentCompleted==100)
{this.projectItem[0].firstChild.rows[0].cells[1].parentNode.removeChild(this.projectItem[0].firstChild.rows[0].cells[1]);this.projectItem[0].firstChild.rows[0].cells[0].width=100+"%";this.projectItem[0].firstChild.rows[0].cells[0].firstChild.style.width=this.Duration*this.Chart.hourInPixelsWork+"px";}}else if(((percentCompleted==0)||(percentCompleted==100))&&((this.percentCompleted==0)||(this.percentCompleted==100)))
{if((percentCompleted==0)&&(this.percentCompleted==100))
{this.projectItem[0].firstChild.rows[0].cells[0].firstChild.src=this.Chart.imgs+"progress_bg.png";}else if((percentCompleted==100)&&(this.percentCompleted==0))
{this.projectItem[0].firstChild.rows[0].cells[0].firstChild.src=this.Chart.imgs+"parentnode_filled.png";}}else if(((percentCompleted>0)||(percentCompleted<100))&&((this.percentCompleted==0)||(this.percentCompleted==100)))
{this.projectItem[0].firstChild.rows[0].cells[0].parentNode.removeChild(this.projectItem[0].firstChild.rows[0].cells[0]);var cellprojectItem=document.createElement("TD");this.projectItem[0].firstChild.rows[0].appendChild(cellprojectItem);cellprojectItem.width=percentCompleted+"%";var imgPr=document.createElement("img");imgPr.style.width=(percentCompleted*this.Duration*this.Chart.hourInPixelsWork)/100+"px";imgPr.style.height=this.Chart.heightTaskItem+"px";cellprojectItem.appendChild(imgPr);imgPr.src=this.Chart.imgs+"parentnode_filled.png";cellprojectItem=document.createElement("TD");this.projectItem[0].firstChild.rows[0].appendChild(cellprojectItem);cellprojectItem.width=(100-percentCompleted)+"%";imgPr=document.createElement("img");imgPr.style.width=((100-percentCompleted)*this.Duration*this.Chart.hourInPixelsWork)/100+"px";imgPr.style.height=this.Chart.heightTaskItem+"px";cellprojectItem.appendChild(imgPr);imgPr.src=this.Chart.imgs+"progress_bg.png";}else if(this.percentCompleted==-1)
{if(percentCompleted==100)
{this.projectItem[0].firstChild.rows[0].cells[0].firstChild.src=this.Chart.imgs+"parentnode_filled.png";}else if(percentCompleted<100&&percentCompleted>0)
{this.projectItem[0].firstChild.rows[0].cells[0].parentNode.removeChild(this.projectItem[0].firstChild.rows[0].cells[0]);var cellprojectItem=document.createElement("TD");this.projectItem[0].firstChild.rows[0].appendChild(cellprojectItem);cellprojectItem.width=percentCompleted+"%";var imgPr=document.createElement("img");imgPr.style.width=(percentCompleted*this.Duration*this.Chart.hourInPixelsWork)/100+"px";imgPr.style.height=this.Chart.heightTaskItem+"px";cellprojectItem.appendChild(imgPr);imgPr.src=this.Chart.imgs+"parentnode_filled.png";cellprojectItem=document.createElement("TD");this.projectItem[0].firstChild.rows[0].appendChild(cellprojectItem);cellprojectItem.width=(100-percentCompleted)+"%";imgPr=document.createElement("img");imgPr.style.width=((100-percentCompleted)*this.Duration*this.Chart.hourInPixelsWork)/100+"px";imgPr.style.height=this.Chart.heightTaskItem+"px";cellprojectItem.appendChild(imgPr);imgPr.src=this.Chart.imgs+"progress_bg.png";}}
this.percentCompleted=percentCompleted;if(this.Chart.isShowDescProject)this.descrProject.innerHTML=this.getDescStr();return true;};GanttProject.prototype.deleteChildTask=function(task)
{if(task)
{if(task.cTaskItem[0].style.display=="none"){this.Chart.openTree(task.parentTask);}
if(task.childPredTask.length>0){for(var i=0;i<task.childPredTask.length;i++)
{for(var t=0;t<task.childPredTask[i].cTaskItem[1].length;t++){task.childPredTask[i].cTaskItem[1][t].parentNode.removeChild(task.childPredTask[i].cTaskItem[1][t]);}
task.childPredTask[i].cTaskItem[1]=[];task.childPredTask[i].predTask=null;}}
if(task.childTask.length>0){while(task.childTask.length>0){this.deleteChildTask(task.childTask[0]);}}
if(task.cTaskItem[0].style.display!="none")task.shiftCurrentTasks(task,-23);this.Project.deleteTask(task.TaskInfo.Id);if(task.cTaskItem[0]){task.cTaskItem[0].parentNode.removeChild(task.cTaskItem[0]);}
if(this.Chart.isShowDescTask){task.descrTask.parentNode.removeChild(task.descrTask);}
if(task.cTaskItem[1].length>0){for(var j=0;j<task.cTaskItem[1].length;j++){task.cTaskItem[1][j].parentNode.removeChild(task.cTaskItem[1][j]);}}
if(task.cTaskNameItem[0]){task.cTaskNameItem[0].parentNode.removeChild(task.cTaskNameItem[0]);}
if(task.cTaskNameItem[1]){for(var j=0;j<task.cTaskNameItem[1].length;j++){task.cTaskNameItem[1][j].parentNode.removeChild(task.cTaskNameItem[1][j]);}}
if(task.cTaskNameItem[2]){task.cTaskNameItem[2].parentNode.removeChild(task.cTaskNameItem[2]);}
if(task.parentTask)
{if(task.previousChildTask){if(task.nextChildTask){task.previousChildTask.nextChildTask=task.nextChildTask;}else{task.previousChildTask.nextChildTask=null;}}
var parentTask=task.parentTask;for(var i=0;i<parentTask.childTask.length;i++)
{if(parentTask.childTask[i].TaskInfo.Id==task.TaskInfo.Id){parentTask.childTask[i]=null;parentTask.childTask.splice(i,1);break;}}
if(parentTask.childTask.length==0){if(parentTask.cTaskNameItem[2]){parentTask.cTaskNameItem[2].parentNode.removeChild(parentTask.cTaskNameItem[2]);parentTask.cTaskNameItem[2]=null;}}}else
{if(task.previousParentTask)
{if(task.nextParentTask){task.previousParentTask.nextParentTask=task.nextParentTask;}else{task.previousParentTask.nextParentTask=null;}}
var project=task.Project;for(var i=0;i<project.arrTasks.length;i++){if(project.arrTasks[i].TaskInfo.Id==task.TaskInfo.Id){project.arrTasks.splice(i,1);}}}
if(task.predTask){var predTask=task.predTask;for(var i=0;i<predTask.childPredTask.length;i++){if(predTask.childPredTask[i].TaskInfo.Id==task.TaskInfo.Id){predTask.childPredTask[i]=null;predTask.childPredTask.splice(i,1);}}}
if(task.Project.arrTasks.length!=0){task.Project.shiftProjectItem();}
else{task.Project.projectItem[0].style.display="none";if(this.Chart.isShowDescProject)this.hideDescrProject();}
this.Chart._oDataHeight-=11+this.Chart.heightTaskItem;}};GanttProject.prototype.insertTask=function(id,name,EST,Duration,PercentCompleted,predecessorTaskId,parentTaskId)
{var task=null;var _task=null;if(this.Project.getTaskById(id)){this.Chart.Error.throwError("DATA_INSERT_ERROR",22,[id]);return false;}
if((!Duration)||(Duration<this.Chart.minWorkLength)){Duration=this.Chart.minWorkLength;}
if((!name)||(name=="")){name=id;}
if((!PercentCompleted)||(PercentCompleted=="")){PercentCompleted=0;}else{PercentCompleted=parseInt(PercentCompleted);if(PercentCompleted<0||PercentCompleted>100){this.Chart.Error.throwError("DATA_INSERT_ERROR",35,null);return false;}}
var sortRequired=false;if((parentTaskId)&&(parentTaskId!="")){var parentTask=this.Project.getTaskById(parentTaskId);if(!parentTask){this.Chart.Error.throwError("DATA_INSERT_ERROR",21,[parentTaskId]);return false;}
EST=EST||parentTask.EST;if(EST<parentTask.EST){this.Chart.Error.throwError("DATA_INSERT_ERROR",20,[id,parentTaskId]);return false;}
task=new GanttTaskInfo(id,name,EST,Duration,PercentCompleted,predecessorTaskId);if(!this.Chart.checkPosParentTask(parentTask,task)){this.Chart.Error.throwError("DATA_INSERT_ERROR",19,[parentTaskId,id]);return false;}
task.ParentTask=parentTask;var _parentTask=this.getTaskById(parentTask.Id);var isHide=false;if(_parentTask.cTaskItem[0].style.display=="none"){isHide=true;}else if(_parentTask.cTaskNameItem[2]){if(!_parentTask._isOpen){isHide=true;}}
if(isHide){if(_parentTask.childTask.length==0){this.Chart.openTree(_parentTask.parentTask);}else{this.Chart.openTree(_parentTask);}}
if(predecessorTaskId!="")
{var predTask=this.Project.getTaskById(predecessorTaskId);if(!predTask){this.Chart.Error.throwError("DATA_INSERT_ERROR",27,[predecessorTaskId]);return false;}
if(predTask.ParentTask){if(predTask.ParentTask.Id!=task.ParentTask.Id){this.Chart.Error.throwError("DATA_INSERT_ERROR",32,[predTask.Id,task.Id]);return false;}}else{this.Chart.Error.throwError("DATA_INSERT_ERROR",32,[predTask.Id,task.Id]);return false;}
if(!this.Chart.checkPosPredecessorTask(predTask,task)){this.Chart.correctPosPredecessorTask(predTask,task);}
task.PredecessorTask=predTask;}
var isAdd=false;if(sortRequired)for(var i=0;i<parentTask.ChildTasks.length;i++){if(task.EST<parentTask.ChildTasks[i].EST)
{parentTask.ChildTasks.splice(i,0,task);if(i>0){parentTask.ChildTasks[i-1].nextChildTask=parentTask.ChildTasks[i];parentTask.ChildTasks[i].previousChildTask=parentTask.ChildTasks[i-1];}
if(parentTask.ChildTasks[i+1]){parentTask.ChildTasks[i+1].previousChildTask=parentTask.ChildTasks[i];parentTask.ChildTasks[i].nextChildTask=parentTask.ChildTasks[i+1];}
isAdd=true;break;}}
if(!isAdd){if(parentTask.ChildTasks.length>0){parentTask.ChildTasks[parentTask.ChildTasks.length-1].nextChildTask=task;task.previousChildTask=parentTask.ChildTasks[parentTask.ChildTasks.length-1];}
parentTask.ChildTasks.push(task);}
if(parentTask.ChildTasks.length==1){_parentTask.cTaskNameItem[2]=_parentTask.createTreeImg();}
_task=new GanttTask(task,this,this.Chart);_task.create();if(task.nextChildTask)_task.nextChildTask=_task.Project.getTaskById(task.nextChildTask.Id);_task.addDayInPanelTime();_task.shiftCurrentTasks(_task,23);}else
{EST=EST||this.Project.StartDate;task=new GanttTaskInfo(id,name,EST,Duration,PercentCompleted,predecessorTaskId);if(task.EST<=this.Chart.startDate){this.Chart.Error.throwError("DATA_INSERT_ERROR",18,[task.Id]);return false;}
if(predecessorTaskId!=""){var predTask=this.Project.getTaskById(predecessorTaskId);if(!predTask){this.Chart.Error.throwError("DATA_INSERT_ERROR",27,[predecessorTaskId]);return false;}
if(!this.Chart.checkPosPredecessorTask(predTask,task)){this.Chart.correctPosPredecessorTask(predTask,task);}
if(predTask.ParentTask){this.Chart.Error.throwError("DATA_INSERT_ERROR",15,[task.Id,predTask.Id]);return false;}
task.PredecessorTask=predTask;}
var isAdd=false;if(sortRequired)for(var i=0;i<this.Project.ParentTasks.length;i++){if(EST<this.Project.ParentTasks[i].EST)
{this.Project.ParentTasks.splice(i,0,task);if(i>0){this.Project.ParentTasks[i-1].nextParentTask=task;task.previousParentTask=this.Project.ParentTasks[i-1];}
if(this.Project.ParentTasks[i+1]){this.Project.ParentTasks[i+1].previousParentTask=task;task.nextParentTask=this.Project.ParentTasks[i+1];}
isAdd=true;break;}}
if(!isAdd){if(this.Project.ParentTasks.length>0){this.Project.ParentTasks[this.Project.ParentTasks.length-1].nextParentTask=task;task.previousParentTask=this.Project.ParentTasks[this.Project.ParentTasks.length-1];}
this.Project.ParentTasks.push(task);}
_task=new GanttTask(task,this,this.Chart);_task.create();if(task.nextParentTask)_task.nextParentTask=_task.Project.getTaskById(task.nextParentTask.Id);_task.addDayInPanelTime();this.arrTasks.push(_task);_task.shiftCurrentTasks(_task,23);this.projectItem[0].style.display="inline";this.setPercentCompleted(this.getPercentCompleted());this.shiftProjectItem();if(this.Chart.isShowDescProject){this.showDescrProject();}}
this.Chart.checkHeighPanelTasks();return _task;};GanttChart.prototype.checkPosPredecessorTask=function(predTask,task)
{var widthPred=this.getWidthOnDuration(predTask.Duration);var posPred=this.getPosOnDate(predTask.EST);var posChild=this.getPosOnDate(task.EST);return(widthPred+posPred)<=posChild;};GanttChart.prototype.correctPosPredecessorTask=function(predTask,ctask,ctaskObj)
{var newDate=new Date(predTask.EST);newDate.setHours(newDate.getHours()+(predTask.Duration/this.hoursInDay*24));if(newDate.getHours()>0){newDate.setHours(0);newDate.setDate(newDate.getDate()+1);}
if(ctaskObj)ctaskObj.setEST(newDate,true);else ctask.EST=newDate;if(ctask.ParentTask)
{if(!this.checkPosParentTask(ctask.ParentTask,ctask))
{var newDate2=new Date(ctask.ParentTask.EST);newDate2.setHours(newDate2.getHours()+(ctask.ParentTask.Duration/this.hoursInDay*24));ctask.Duration=parseInt((parseInt((newDate2-ctask.EST)/(1000*60*60)))*this.hoursInDay/24);}}};GanttChart.prototype.correctPosParentTask=function(parentTask,ctask)
{if(!ctask.PredecessorTask)
{if(parentTask.EST>ctask.EST){ctask.EST=new Date(parentTask.EST);}
if(!this.checkPosParentTask(parentTask,ctask)){ctask.Duration=parentTask.Duration;}}else
{this.correctPosPredecessorTask(ctask.PredecessorTask,ctask);}};GanttChart.prototype.checkPosParentTaskInTree=function(parentTask)
{var isError=false;for(var t=0;t<parentTask.ChildTasks.length;t++)
{if(!this.checkPosParentTask(parentTask,parentTask.ChildTasks[t]))
{if(!this.correctError){this.Error.throwError("DATA_ERROR",28,[parentTask.Id,parentTask.ChildTasks[t].Id]);return true;}else{this.correctPosParentTask(parentTask,parentTask.ChildTasks[t]);}}
if(parentTask.EST>parentTask.ChildTasks[t].EST)
{if(!this.correctError){this.Error.throwError("DATA_ERROR",33,[parentTask.Id,parentTask.ChildTasks[t].Id]);return true;}else{this.correctPosParentTask(parentTask,parentTask.ChildTasks[t]);}}
if(parentTask.ChildTasks[t].ChildTasks.length>0)
{isError=this.checkPosParentTaskInTree(parentTask.ChildTasks[t]);}}
return isError;};GanttChart.prototype.setPredTask=function(project)
{var isError=false;for(var k=0;k<project.ParentTasks.length;k++){if(!this.isEmpty(project.ParentTasks[k].PredecessorTaskId))
{project.ParentTasks[k].PredecessorTask=project.getTaskById(project.ParentTasks[k].PredecessorTaskId);if(!project.ParentTasks[k].PredecessorTask){if(!this.correctError){this.Error.throwError("DATA_ERROR",27,[project.ParentTasks[k].PredecessorTaskId]);return true;}}
project.ParentTasks[k].PredecessorTask.ChildPredTasks.push(project.ParentTasks[k]);}
if(project.ParentTasks[k].PredecessorTask)
{if(!this.checkPosPredecessorTask(project.ParentTasks[k].PredecessorTask,project.ParentTasks[k])){if(!this.correctError){this.Error.throwError("DATA_ERROR",26,[project.ParentTasks[k].PredecessorTask.Id,project.ParentTasks[k].Id]);return true;}else{this.correctPosPredecessorTask(project.ParentTasks[k].PredecessorTask,project.ParentTasks[k]);}}}
isError=this.setPredTaskInTree(project.ParentTasks[k]);if(isError)return isError;}
return isError;};GanttChart.prototype.setPredTaskInTree=function(parentTask)
{var isError=false;for(var t=0;t<parentTask.ChildTasks.length;t++)
{if(!this.isEmpty(parentTask.ChildTasks[t].PredecessorTaskId))
{parentTask.ChildTasks[t].PredecessorTask=parentTask.Project.getTaskById(parentTask.ChildTasks[t].PredecessorTaskId);if(!parentTask.ChildTasks[t].PredecessorTask)
{if(!this.correctError){this.Error.throwError("DATA_ERROR",27,[parentTask.ChildTasks[t].PredecessorTaskId]);return true;}}
if(!this.checkPosPredecessorTask(parentTask.ChildTasks[t].PredecessorTask,parentTask.ChildTasks[t]))
{if(!this.correctError){this.Error.throwError("DATA_ERROR",26,[parentTask.ChildTasks[t].PredecessorTask.Id,parentTask.ChildTasks[t].Id]);return true;}else{this.correctPosPredecessorTask(parentTask.ChildTasks[t].PredecessorTask,parentTask.ChildTasks[t]);}}
parentTask.ChildTasks[t].PredecessorTask.ChildPredTasks.push(parentTask.ChildTasks[t]);}
if(parentTask.ChildTasks[t].ChildTasks.length>0)
{isError=this.setPredTaskInTree(parentTask.ChildTasks[t]);}}
return isError;};GanttChart.prototype.checkPosParentTask=function(parentTask,task)
{var widthParent=this.getWidthOnDuration(parentTask.Duration);var posParent=this.getPosOnDate(parentTask.EST);var posChild=this.getPosOnDate(task.EST);var widthChild=this.getWidthOnDuration(task.Duration);return(widthParent+posParent)>=(posChild+widthChild);};GanttChart.prototype.insertProject=function(id,name,startDate)
{if(this._isError)
{this.clearData();this.clearItems();this.hidePanelErrors();this._isError=false;}
if(this.startDate>=startDate){this.Error.throwError("DATA_INSERT_ERROR",14,null);return false;}
if(this.getProjectById(id)){this.Error.throwError("DATA_INSERT_ERROR",23,[id]);return false;}
this.checkHeighPanelTasks();var project=new GanttProjectInfo(id,name,startDate);this.Project.push(project);var _project=new GanttProject(this,project);for(var i=0;i<this.arrProjects.length;i++){if(startDate<this.arrProjects[i].Project.StartDate){this.arrProjects.splice(i,0,_project);if(i>0){_project.previousProject=this.arrProjects[i-1];this.arrProjects[i-1].nextProject=_project;}
if(i+1<=this.arrProjects.length){_project.nextProject=this.arrProjects[i+1];this.arrProjects[i+1].previousProject=_project;_project.shiftNextProject(_project,23);}
_project.create();if(this.isShowDescProject){_project.hideDescrProject();}
return _project;}}
if(this.arrProjects.length>0){this.arrProjects[this.arrProjects.length-1].nextProject=_project;_project.previousProject=this.arrProjects[this.arrProjects.length-1];}
this.arrProjects.push(_project);_project.create();if(this.isShowDescProject){_project.hideDescrProject();}
return _project;};GanttChart.prototype._showContextMenu=function(event,obj)
{if(this.contextMenu.isDhtmlxMenuObject){var res=this.callEvent("onBeforeContextMenu",[this.contextMenu,obj]);if(res===false)return;var x,y;if(_isIE){var dEl0=window.document.documentElement,dEl1=window.document.body,corrector=new Array((dEl0.scrollLeft||dEl1.scrollLeft),(dEl0.scrollTop||dEl1.scrollTop));x=event.clientX+corrector[0];y=event.clientY+corrector[1];}else{x=event.pageX;y=event.pageY;}
this.contextMenu.showContextMenu(x-1,y-1);}else{var elem=event.srcElement||event.target;this.contextMenu.showContextMenu(elem.style.left,elem.style.top,obj);}};GanttChart.prototype.openTree=function(parentTask)
{var lastParentTask=this.getLastCloseParent(parentTask);if(parentTask.TaskInfo.Id!=lastParentTask.TaskInfo.Id){this.openNode(lastParentTask);this.openTree(parentTask);}else{this.openNode(lastParentTask);}};GanttChart.prototype.openNode=function(parentTask)
{if(!parentTask._isOpen)
{parentTask.cTaskNameItem[2].src=this.imgs+"minus.gif";parentTask._isOpen=true;parentTask.shiftCurrentTasks(parentTask,parentTask._heightHideTasks);parentTask.showChildTasks(parentTask,parentTask._isOpen);parentTask._heightHideTasks=0;}};GanttChart.prototype.getLastCloseParent=function(task)
{if(task.parentTask)
{if((!task.parentTask._isOpen)||(task.parentTask.cTaskNameItem[2].style.display=="none")){return this.getLastCloseParent(task.parentTask);}else{return task;}}else{return task;}};GanttTask.prototype.setPredecessor=function(predecessorTaskId)
{if(predecessorTaskId=="")this.clearPredTask();else
{var task=this.TaskInfo;if(task.Id==predecessorTaskId){this.Chart.Error.throwError("DATA_INSERT_ERROR",36);return false;}
var predTaskObj=this.Project.getTaskById(predecessorTaskId);if(!predTaskObj){this.Chart.Error.throwError("DATA_INSERT_ERROR",27,[predecessorTaskId]);return false;}
var predTask=predTaskObj.TaskInfo;var a1=predTask.ParentTask==null,a2=task.ParentTask==null;if(a1&&!a2||!a1&&a2||!a1&&!a2&&(predTask.ParentTask.Id!=task.ParentTask.Id)){this.Chart.Error.throwError("DATA_INSERT_ERROR",32,[predTask.Id,task.Id]);return false;}
this.clearPredTask();if(!this.Chart.checkPosPredecessorTask(predTask,task)){this.Chart.correctPosPredecessorTask(predTask,task,this);}
task.PredecessorTaskId=predecessorTaskId;task.PredecessorTask=predTask;this.predTask=predTaskObj;predTaskObj.childPredTask.push(this);this.cTaskItem[1]=this.createConnectingLinesDS();}
return true;};GanttTask.prototype.clearPredTask=function(){if(this.predTask){var ch=this.predTask.childPredTask;for(var i=0;i<ch.length;i++){if(ch[i]==this){ch.splice(i,1);break;}}
for(var i=0;i<this.cTaskItem[1].length;i++){this.cTaskItem[1][i].parentNode.removeChild(this.cTaskItem[1][i]);}
this.cTaskItem[1]=[];this.TaskInfo.PredecessorTaskId=null;this.TaskInfo.PredecessorTask=null;this.predTask=null;}};GanttTask.prototype.setEST=function(est,shiftChild)
{this.moveChild=shiftChild;this.getMoveInfo();var pos=this.Chart.getPosOnDate(est);if((parseInt(this.cTaskItem[0].firstChild.firstChild.width)+pos>this.maxPosXMove)&&(this.maxPosXMove!=-1))
{this.Chart.Error.throwError("DATA_INSERT_ERROR",12,[this.TaskInfo.Id]);this.maxPosXMove=-1;this.minPosXMove=-1;return false;}
if(pos<this.minPosXMove)
{this.Chart.Error.throwError("DATA_INSERT_ERROR",11,[this.TaskInfo.Id]);this.maxPosXMove=-1;this.minPosXMove=-1;return false;}
this.cTaskItem[0].style.left=pos;var width=pos-this.posX;this.moveCurrentTaskItem(width,shiftChild);this.Project.shiftProjectItem();if(this.Chart.isShowDescTask)this.descrTask.innerHTML=this.getDescStr();this.addDayInPanelTime();this.posX=0;this.maxPosXMove=-1;this.minPosXMove=-1;return true;};GanttTask.prototype.setDuration=function(duration)
{this.getResizeInfo();var width=this.Chart.getWidthOnDuration(duration);if((width>this.maxWidthResize)&&(this.maxWidthResize!=-1))
{this.Chart.Error.throwError("DATA_INSERT_ERROR",10,[this.TaskInfo.Id]);return false;}else if(width<this.minWidthResize)
{this.Chart.Error.throwError("DATA_INSERT_ERROR",9,[this.TaskInfo.Id]);return false;}else{this.taskItemWidth=parseInt(this.cTaskItem[0].firstChild.firstChild.width);this.resizeTaskItem(width);this.endResizeItem();if(this.Chart.isShowDescTask)this.descrTask.innerHTML=this.getDescStr();return true;}};GanttTask.prototype.setPercentCompleted=function(percentCompleted)
{percentCompleted=parseInt(percentCompleted);if(isNaN(percentCompleted))
{this.Chart.Error.throwError("DATA_INSERT_ERROR",6,null);return false;}
if(percentCompleted>100)
{this.Chart.Error.throwError("DATA_INSERT_ERROR",7,null);return false;}
if(percentCompleted<0)
{this.Chart.Error.throwError("DATA_INSERT_ERROR",8,null);return false;}
if((percentCompleted!=0)&&(percentCompleted!=100))
{if((this.TaskInfo.PercentCompleted!=0)&&(this.TaskInfo.PercentCompleted!=100))
{this.cTaskItem[0].childNodes[0].firstChild.rows[0].cells[0].width=percentCompleted+"%";this.cTaskItem[0].childNodes[0].firstChild.rows[0].cells[1].width=100-percentCompleted+"%";}else if((this.TaskInfo.PercentCompleted==0)||(this.TaskInfo.PercentCompleted==100))
{this.cTaskItem[0].childNodes[0].firstChild.rows[0].cells[0].parentNode.removeChild(this.cTaskItem[0].childNodes[0].firstChild.rows[0].cells[0]);var cellTblTask=document.createElement("td");this.cTaskItem[0].childNodes[0].firstChild.rows[0].appendChild(cellTblTask);cellTblTask.height=this.Chart.heightTaskItem+"px";cellTblTask.width=percentCompleted+"%";var imgPrF=document.createElement("img");imgPrF.style.width=(percentCompleted*this.TaskInfo.Duration*this.Chart.hourInPixelsWork)/100+"px";imgPrF.style.height=this.Chart.heightTaskItem+"px";cellTblTask.appendChild(imgPrF);imgPrF.src=this.Chart.imgs+"progress_filled.png";cellTblTask=document.createElement("td");this.cTaskItem[0].childNodes[0].firstChild.rows[0].appendChild(cellTblTask);cellTblTask.height=this.Chart.heightTaskItem+"px";cellTblTask.width=(100-percentCompleted)+"%";imgPrF=document.createElement("img");imgPrF.style.width=((100-percentCompleted)*this.TaskInfo.Duration*this.Chart.hourInPixelsWork)/100+"px";imgPrF.style.height=this.Chart.heightTaskItem+"px";cellTblTask.appendChild(imgPrF);imgPrF.src=this.Chart.imgs+"progress_bg.png";}}else if(percentCompleted==0)
{if((this.TaskInfo.PercentCompleted!=0)&&(this.TaskInfo.PercentCompleted!=100))
{this.cTaskItem[0].childNodes[0].firstChild.rows[0].cells[0].parentNode.removeChild(this.cTaskItem[0].childNodes[0].firstChild.rows[0].cells[0]);this.cTaskItem[0].childNodes[0].firstChild.rows[0].cells[0].width=100+"%";}else
{this.cTaskItem[0].childNodes[0].firstChild.rows[0].cells[0].firstChild.src=this.Chart.imgs+"progress_bg.png";}}else if(percentCompleted==100)
{if((this.TaskInfo.PercentCompleted!=0)&&(this.TaskInfo.PercentCompleted!=100))
{this.cTaskItem[0].childNodes[0].firstChild.rows[0].cells[1].parentNode.removeChild(this.cTaskItem[0].childNodes[0].firstChild.rows[0].cells[1]);this.cTaskItem[0].childNodes[0].firstChild.rows[0].cells[0].width=100+"%";}else
{this.cTaskItem[0].childNodes[0].firstChild.rows[0].cells[0].firstChild.src=this.Chart.imgs+"progress_filled.png";}}
this.TaskInfo.PercentCompleted=percentCompleted;this.taskItemWidth=parseInt(this.cTaskItem[0].firstChild.firstChild.width);this.resizeTaskItem(this.taskItemWidth);this.endResizeItem();if(this.Chart.isShowDescTask)this.descrTask.innerHTML=this.getDescStr();return true;};GanttTask.prototype.setName=function(name)
{if((name!="")&&(name!=null)){this.TaskInfo.Name=name;if(this.Chart._showTreePanel)
{this.cTaskNameItem[0].innerHTML=name;this.cTaskNameItem[0].title=name;this.checkWidthTaskNameItem();}
if(this.Chart.isShowDescTask)this.descrTask.innerHTML=this.getDescStr();this.addDayInPanelTime();}};GanttChart.prototype.getProjectInfoById=function(id)
{for(var i=0;i<this.Project.length;i++)
{if(this.Project[i].Id==id)
{return this.Project[i];}}
return null;};GanttChart.prototype.loadData=function(content,isFile,isLocal)
{this.clearData();if((isFile==null)||(isFile=='undefined'))
{isFile=false;}
if((isLocal==null)||(isLocal=='undefined'))
{isLocal=false;}
this.loadXML(content,isFile,isLocal);this.Project.sort(this.sort_byStartDate);this.startDate=this.getStartDate();this.clearItems();for(var i=0;i<this.Project.length;i++)
{for(var k=0;k<this.Project[i].ParentTasks.length;k++)
{if((this.Project[i].ParentTasks[k].EST!=null)&&(this.Project[i].ParentTasks[k].EST!='')){this.setESTChild(this.Project[i].ParentTasks[k]);}
else{this.Error.throwError("DATA_ERROR",25,[this.Project[i].ParentTasks[k].Id]);return;}
if(this.setPredTask(this.Project[i]))return;}
for(var k=0;k<this.Project[i].ParentTasks.length;k++){if(this.Project[i].ParentTasks[k].EST<this.Project[i].StartDate){this.Error.throwError("DATA_ERROR",24,[this.Project[i].ParentTasks[k].Id,this.Project[i].Id]);return;}
if(this.checkPosParentTaskInTree(this.Project[i].ParentTasks[k]))return;}
this.sortTasksByEST(this.Project[i]);}
for(var i=0;i<this.Project.length;i++)
{var project=new GanttProject(this,this.Project[i]);if(this.arrProjects.length>0)
{var previousProject=this.arrProjects[this.arrProjects.length-1];project.previousProject=previousProject;previousProject.nextProject=project;}
project.create();this.checkHeighPanelTasks();this.arrProjects.push(project);this.createTasks(project);}};GanttChart.prototype.clearAll=function()
{this._oDataHeight=0;this.startDate=null;this._isError=false;this.hidePanelErrors();this.clearData();this.clearItems();};GanttChart.prototype.clearData=function()
{this._oDataHeight=0;this.startDate=null;this._isError=false;this.hidePanelErrors();this.Project=[];this.arrProjects=[];};GanttChart.prototype.clearItems=function()
{this.oData.removeChild(this.oData.firstChild);this.oData.appendChild(this.createPanelTasks());this.oData.firstChild.appendChild(this.divInfo);this.oData.firstChild.appendChild(this.panelErrors);if(this._showTreePanel)
{this.panelNames.removeChild(this.panelNames.firstChild);this.panelNames.appendChild(this.createPanelNamesTasks());}
this.panelTime.removeChild(this.panelTime.firstChild);this.panelTime.appendChild(this.createPanelTime());};GanttChart.prototype.loadXML=function(content,isFile,isLocal)
{if(isFile&&(content==null||content==""))
{this.Error.throwError("DATA_SEND_ERROR",4,null);return;}
this.xmlLoader=new dtmlXMLLoaderObject(null,this,false);try
{if(!isFile)
try{this.xmlLoader.loadXMLString(content);}catch(e){this.Error.throwError("DATA_LOAD_ERROR",37,[content]);}else
if(!isLocal)
{this.xmlLoader.loadXML(this.loadPath+"?path="+content+"&rnd="+(new Date()-0),false);}else
{this.xmlLoader.loadXML(content+"?rnd="+(new Date()-0),false);}
this.doLoadDetails(isLocal);}catch(e)
{this.Error.throwError("DATA_LOAD_ERROR",5,[content]);}};GanttChart.prototype.doLoadDetails=function(isLocal)
{switch(this.xmlLoader.xmlDoc.status){case 0:if(!isLocal)
{this.Error.throwError("DATA_LOAD_ERROR",1,null);return;}
break;case 404:if(!isLocal)
{this.Error.throwError("DATA_LOAD_ERROR",5,[this.loadPath]);}else
{this.Error.throwError("DATA_LOAD_ERROR",5,[this.xmlLoader.filePath])}
return;break;case 500:this.Error.throwError("DATA_LOAD_ERROR",2,null);return;break;default:break;}
var name=null;var id=null;var est=null;var duration=null;var percentCompleted=null;var predecessorTaskId=null;var projectArr=this.xmlLoader.doXPath("//project");for(var j=0;j<projectArr.length;j++)
{var startDateTemp=projectArr[j].getAttribute("startdate");var startDate=startDateTemp.split(",");var project=new GanttProjectInfo(projectArr[j].getAttribute("id"),projectArr[j].getAttribute("name"),new Date(startDate[0],(parseInt(startDate[1])-1),startDate[2]));var taskArr=this.xmlLoader.doXPath("./task",projectArr[j]);for(var i=0;i<taskArr.length;i++){id=taskArr[i].getAttribute("id");name=(this.xmlLoader.doXPath("./name",taskArr[i])[0].firstChild==null)?"":this.xmlLoader.doXPath("./name",taskArr[i])[0].firstChild.nodeValue;var estTemp=(this.xmlLoader.doXPath("./est",taskArr[i])[0].firstChild==null)?"":this.xmlLoader.doXPath("./est",taskArr[i])[0].firstChild.nodeValue;est=estTemp.split(",");duration=(this.xmlLoader.doXPath("./duration",taskArr[i])[0].firstChild==null)?"":this.xmlLoader.doXPath("./duration",taskArr[i])[0].firstChild.nodeValue;percentCompleted=(this.xmlLoader.doXPath("./percentcompleted",taskArr[i])[0].firstChild==null)?"":this.xmlLoader.doXPath("./percentcompleted",taskArr[i])[0].firstChild.nodeValue;predecessorTaskId=(this.xmlLoader.doXPath("./predecessortasks",taskArr[i])[0].firstChild==null)?"":this.xmlLoader.doXPath("./predecessortasks",taskArr[i])[0].firstChild.nodeValue;var task=new GanttTaskInfo(id,name,new Date(est[0],(parseInt(est[1])-1),est[2]),duration,percentCompleted,predecessorTaskId);var childTasksNode=this.xmlLoader.doXPath("./childtasks",taskArr[i]);var childTasksArr=this.xmlLoader.doXPath("./task",childTasksNode[0]);if(childTasksArr.length!=0)this.readChildTasksXML(task,childTasksArr);project.addTask(task);}
this.addProject(project);}};GanttChart.prototype.readChildTasksXML=function(parentTask,childTasksArrXML)
{var name=null;var id=null;var est=null;var duration=null;var percentCompleted=null;var predecessorTaskId=null;for(var i=0;i<childTasksArrXML.length;i++)
{id=childTasksArrXML[i].getAttribute("id");name=(this.xmlLoader.doXPath("./name",childTasksArrXML[i])[0].firstChild==null)?"":this.xmlLoader.doXPath("./name",childTasksArrXML[i])[0].firstChild.nodeValue;var estTemp=(this.xmlLoader.doXPath("./est",childTasksArrXML[i])[0].firstChild==null)?"":this.xmlLoader.doXPath("./est",childTasksArrXML[i])[0].firstChild.nodeValue;est=estTemp.split(",");duration=(this.xmlLoader.doXPath("./duration",childTasksArrXML[i])[0].firstChild==null)?"":this.xmlLoader.doXPath("./duration",childTasksArrXML[i])[0].firstChild.nodeValue;percentCompleted=(this.xmlLoader.doXPath("./percentcompleted",childTasksArrXML[i])[0].firstChild==null)?"":this.xmlLoader.doXPath("./percentcompleted",childTasksArrXML[i])[0].firstChild.nodeValue;predecessorTaskId=(this.xmlLoader.doXPath("./predecessortasks",childTasksArrXML[i])[0].firstChild==null)?"":this.xmlLoader.doXPath("./predecessortasks",childTasksArrXML[i])[0].firstChild.nodeValue;var task=new GanttTaskInfo(id,name,new Date(est[0],(parseInt(est[1])-1),est[2]),duration,percentCompleted,predecessorTaskId);task.ParentTask=parentTask;parentTask.addChildTask(task);var childTasksNode=this.xmlLoader.doXPath("./childtasks",childTasksArrXML[i]);var childTasksArr=this.xmlLoader.doXPath("./task",childTasksNode[0]);if(childTasksArr.length!=0)
{this.readChildTasksXML(task,childTasksArr);}}};GanttChart.prototype.getXML=function()
{var strXML="<projects>";for(var i=0;i<this.Project.length;i++)
{strXML+="<project id ='"+this.Project[i].Id+"' name= '"+this.Project[i].Name+"' startdate = '"+this.Project[i].StartDate.getFullYear()+","+(this.Project[i].StartDate.getMonth()+1)+","+this.Project[i].StartDate.getDate()+"'>";for(var j=0;j<this.Project[i].ParentTasks.length;j++)
{strXML+="<task id ='"+this.Project[i].ParentTasks[j].Id+"'>";strXML+="<name>"+this.Project[i].ParentTasks[j].Name+"</name>";strXML+="<est>"+this.Project[i].ParentTasks[j].EST.getFullYear()+","+(this.Project[i].ParentTasks[j].EST.getMonth()+1)+","+this.Project[i].ParentTasks[j].EST.getDate()+"</est>";strXML+="<duration>"+this.Project[i].ParentTasks[j].Duration+"</duration>";strXML+="<percentcompleted>"+this.Project[i].ParentTasks[j].PercentCompleted+"</percentcompleted>";strXML+="<predecessortasks>"+this.Project[i].ParentTasks[j].PredecessorTaskId+"</predecessortasks>";strXML+="<childtasks>";strXML+=this.createChildTasksXML(this.Project[i].ParentTasks[j].ChildTasks);strXML+="</childtasks>";strXML+="</task>";}
strXML+="</project>";}
strXML+="</projects>";return strXML;};GanttChart.prototype.createChildTasksXML=function(childTasks)
{var strXML="";for(var n=0;n<childTasks.length;n++)
{strXML+="<task id='"+childTasks[n].Id+"'>";strXML+="<name>"+childTasks[n].Name+"</name>";strXML+="<est>"+childTasks[n].EST.getFullYear()+","+(childTasks[n].EST.getMonth()+1)+","+childTasks[n].EST.getDate()+"</est>";strXML+="<duration>"+childTasks[n].Duration+"</duration>";strXML+="<percentcompleted>"+childTasks[n].PercentCompleted+"</percentcompleted>";strXML+="<predecessortasks>"+childTasks[n].PredecessorTaskId+"</predecessortasks>";if(childTasks[n].ChildTasks)
{strXML+="<childtasks>";strXML+=this.createChildTasksXML(childTasks[n].ChildTasks);strXML+="</childtasks>";}
strXML+="</task>";}
return strXML;};GanttChart.prototype.sort_byEST=function(a,b)
{if(a.EST<b.EST)return-1;if(a.EST>b.EST)return 1;return 0;};GanttChart.prototype.sort_byStartDate=function(a,b)
{if(a["StartDate"]<b["StartDate"])return-1;if(a["StartDate"]>b["StartDate"])return 1;return 0;};GanttChart.prototype.setESTChild=function(parentTask)
{for(var t=0;t<parentTask.ChildTasks.length;t++)
{if((parentTask.ChildTasks[t].EST==null)||(parentTask.ChildTasks[t].EST==""))
{parentTask.ChildTasks[t].EST=parentTask.EST;}
if(parentTask.ChildTasks[t].ChildTasks.length!=0)this.setESTChild(parentTask.ChildTasks[t]);}};GanttChart.prototype.createPanelTasks=function()
{var divTasks=document.createElement("div");divTasks.className="taskPanel";divTasks.style.cssText="position:relative;";divTasks.style.height=this.contentHeight-63+"px";var w=this.startDate?(this.startDate.getDay()-1):((new Date(0)).getDay()-1);if(w==-1)w=6;divTasks.style.background="url("+this.imgs+"bg_week.png) -"+(w*24)+"px 0px";this.panelTasks=divTasks;return divTasks;};GanttChart.prototype.createPanelNamesTasks=function()
{var divListNames=document.createElement("div");divListNames.innerHTML="&nbsp;";divListNames.style.cssText="position:relative;background:url("+this.imgs+"bg.png)";divListNames.style.height=this.contentHeight-63+"px";divListNames.style.width=this.maxWidthPanelNames+"px";return divListNames;};GanttChart.prototype.createPopUpInfo=function()
{var divTaskInfo=document.createElement("div");divTaskInfo.style.cssText='display: none;';var tblTaskInfo=document.createElement("table");tblTaskInfo.style.cssText="position:absolute;top:0px;left:0px";tblTaskInfo.className="poPupInfo";divTaskInfo.appendChild(tblTaskInfo);var rowTaskInfo=tblTaskInfo.insertRow(tblTaskInfo.rows.length);var cellTaskInfo=document.createElement("td");rowTaskInfo.appendChild(cellTaskInfo);this.divInfo=divTaskInfo;return divTaskInfo;};GanttChart.prototype.createPopUpTimeInfo=function()
{var divTimeInfo=document.createElement("div");divTimeInfo.style.display="none";var tblTimeInfo=document.createElement("table");tblTimeInfo.className="poPupTime";divTimeInfo.appendChild(tblTimeInfo);var rowTimeInfo=tblTimeInfo.insertRow(tblTimeInfo.rows.length);var cellTimeInfo=document.createElement("td");cellTimeInfo.align="center";rowTimeInfo.appendChild(cellTimeInfo);return divTimeInfo;};GanttChart.prototype.createPanelTime=function()
{var panelTime=document.createElement("div");panelTime.style.position="relative";var tblTime=document.createElement("table");panelTime.appendChild(tblTime);tblTime.cellPadding="0px";tblTime.border="0px";tblTime.cellSpacing="0px";tblTime.bgColor="#FFFFFF";tblTime.style.marginTop="0px";var monthRow=tblTime.insertRow(tblTime.rows.length);var newRow=tblTime.insertRow(tblTime.rows.length);for(var i=0;i<this.countDays;i++)
{this.addPointInTimePanel(newRow,panelTime);this.addDayInPanelTime(newRow);}
return panelTime;};GanttChart.prototype.addPointInTimePanel=function(row,panelTime)
{var leftLine=document.createElement("div");leftLine.style.cssText="position:absolute;left:"+(row.cells.length*this.dayInPixels)+"px;top:20px;height:20px;width:1px;font-size:1px;margin-left:0px;margin-right:0px;margin-top:0px;margin-bottom:0px;background:#f1f3f1;";panelTime.appendChild(leftLine);};GanttChart.prototype._calculateMonthColSpan=function(date,maxLen){var m1=date.getMonth();for(var i=1;i<=maxLen;i++){date.setDate(date.getDate()+1);var m2=date.getMonth();if(m2!=m1)return i;}
return maxLen;};GanttChart.prototype.getMonthScaleLabel=function(date){return(this._useShortMonthNames?this.shortMonthNames:this.monthNames)[date.getMonth()]+" '"+(""+date.getFullYear()).substring(2);};GanttChart.prototype.useShortMonthNames=function(flag){this._useShortMonthNames=flag;};GanttChart.prototype.setShortMonthNames=function(names){this.shortMonthNames=names;};GanttChart.prototype.setMonthNames=function(names){this.monthNames=names;};GanttChart.prototype.addDayInPanelTime=function(row)
{var self=this,idx=row.cells.length,date=new Date(this.startDate);var newCell=row.insertCell(idx);newCell.style.height="20px";newCell.style.width=this.dayInPixels+"px";newCell.className="dayNumber";date.setDate(date.getDate()+parseInt(idx));var day=date.getDate()
newCell.innerHTML=day;newCell.setAttribute("idx",idx);var monthRow=row.parentNode.parentNode.rows[0];if(idx==0||day==1){var newCell2=monthRow.insertCell(monthRow.cells.length);newCell2.className="monthName";newCell2.style.height="20px";if(monthRow.cells.length%2==0)newCell2.style.backgroundColor="#f7f8f7";newCell2.colSpan=this._calculateMonthColSpan(new Date(date),Math.max(1,this.countDays-idx));newCell2.innerHTML=this.getMonthScaleLabel(date);}else{var n=monthRow.cells.length,cs=0;for(var i=0;i<n;i++){cs+=monthRow.cells[i].colSpan;}
if(idx>=cs)monthRow.cells[n-1].colSpan+=1;}
var w=date.getDay();if(w==0||w==6)newCell.style.backgroundColor="#f7f8f7";};GanttChart.prototype.incHeightPanelTasks=function(height)
{var containerTasks=this.oData.firstChild;containerTasks.style.height=parseInt(containerTasks.style.height)+height+"px";};GanttChart.prototype.incHeightPanelNames=function(height)
{var containerNames=this.panelNames.firstChild;containerNames.style.height=parseInt(containerNames.style.height)+height+"px";};GanttChart.prototype.checkHeighPanelTasks=function()
{this._oDataHeight+=11+this.heightTaskItem;if((parseInt(this.oData.firstChild.style.height)<=this._oDataHeight)){this.incHeightPanelTasks(this.heightTaskItem+11);if(this._showTreePanel)this.incHeightPanelNames(this.heightTaskItem+11);}};GanttChart.prototype.sortTasksByEST=function(project)
{project.ParentTasks.sort(this.sort_byEST);for(var i=0;i<project.ParentTasks.length;i++)
{project.ParentTasks[i]=this.sortChildTasks(project.ParentTasks[i]);}};GanttChart.prototype.sortChildTasks=function(parenttask)
{parenttask.ChildTasks.sort(this.sort_byEST);for(var i=0;i<parenttask.ChildTasks.length;i++)
{if(parenttask.ChildTasks[i].ChildTasks.length>0)this.sortChildTasks(parenttask.ChildTasks[i]);}
return parenttask;};GanttChart.prototype.errorDataHandler=function(type,descr,params)
{if(!this._isError)
{this.clearData();this.showPanelErrors();this._isError=true;}
this.addErrorInPanelErrors(type,descr);};GanttChart.prototype.createPanelErrors=function()
{var tbl=document.createElement("table");tbl.width="100%";tbl.style.display="none";tbl.className="panelErrors";this.panelErrors=tbl;return tbl;};GanttChart.prototype.showPanelErrors=function()
{this.panelErrors.style.display="inline";};GanttChart.prototype.hidePanelErrors=function()
{for(var i=0;i<this.panelErrors.rows.length;i++){this.panelErrors.rows[i].parentNode.removeChild(this.panelErrors.rows[i]);}
this.panelErrors.style.display="none";};GanttChart.prototype.addErrorInPanelErrors=function(type,descr)
{var row=this.panelErrors.insertRow(this.panelErrors.rows.length);var cell=document.createElement("td");cell.style.height="20px";cell.style.width="100px";cell.innerHTML=type;row.appendChild(cell);cell=document.createElement("td");row.appendChild(cell);cell.innerHTML=descr;};GanttChart.prototype.errorSendDataHandler=function(type,descr,params)
{alert(descr);};GanttChart.prototype.errorLoadDataHandler=function(type,descr,params)
{alert(descr);};GanttChart.prototype.errorAPIHandler=function(type,descr,params)
{alert(descr);};GanttChart.prototype.saveData=function(fileName)
{try{if(!this.dhtmlXMLSenderObject.isProcessed)
{this.dhtmlXMLSenderObject.sendData(fileName,this.savePath,this.getXML());}}catch(e){this.Error.throwError("DATA_SEND_ERROR",e,null);}};GanttChart.prototype.create=function(divId)
{var self=this;var content=document.getElementById(divId);this.content=content;this.getBrowserType();if(this._isIE){document.body.attachEvent('onselectstart',function(){window.event.returnValue=false;});document.body.attachEvent('onkeydown',function(){if(event.keyCode==65&&event.ctrlKey)window.event.returnValue=false;});}else{content.addEventListener('mousedown',function(e){e.preventDefault();},true);document.addEventListener('keydown',function(e){if(e.keyCode==65&&e.ctrlKey)e.preventDefault();},true);}
this.Error.catchError("DATA_ERROR",function(type,descr,params){self.errorDataHandler(type,descr,params)});this.Error.catchError("DATA_SEND_ERROR",function(type,descr,params){self.errorSendDataHandler(type,descr,params)});this.Error.catchError("DATA_INSERT_ERROR",function(type,descr,params){self.errorAPIHandler(type,descr,params)});this.Error.catchError("DATA_LOAD_ERROR",function(type,descr,params){self.errorLoadDataHandler(type,descr,params)});var tableControl=document.createElement("table");tableControl.cellPadding="0";tableControl.cellSpacing="0";tableControl.style.cssText="width: 100%; position: relative;";var newRowTblControl=tableControl.insertRow(tableControl.rows.length);var newCellTblControl;this.contentHeight=content.offsetHeight;this.contentWidth=content.offsetWidth;content.appendChild(tableControl);this.countDays=this.getCountDays();this.Project.sort(this.sort_byStartDate);this.startDate=this.getStartDate();this.panelTime=document.createElement("div");this.panelTime.appendChild(this.createPanelTime());this.panelTime.style.cssText="position:relative;overflow:hidden;height:40px;top:0px;left:1px";this.oData=document.createElement("div");this.oData.appendChild(this.createPanelTasks());this.oData.style.cssText="position:relative;overflow:scroll;height:"+(this.contentHeight-40)+"px;border-left:#f1f3f1 1px solid";this.oData.firstChild.appendChild(this.createPanelErrors());if(this._showTreePanel)
{this.panelNames=document.createElement("div");newCellTblControl=document.createElement("td");newCellTblControl.vAlign="top";this.panelNames.appendChild(this.createPanelNamesTasks());this.panelNames.style.cssText="position:relative;top:40px;overflow:hidden;border-left:#f1f3f1 1px solid;border-bottom:#f1f3f1 1px solid";newCellTblControl.appendChild(this.panelNames);newRowTblControl.appendChild(newCellTblControl);}
newCellTblControl=document.createElement("td");var divCell=document.createElement("div");divCell.style.cssText="position: relative;";divCell.appendChild(this.panelTime);divCell.appendChild(this.oData);newCellTblControl.appendChild(divCell);newRowTblControl.appendChild(newCellTblControl);if(this._showTreePanel){this.panelNames.style.height=(this.contentHeight-56)+"px";this.panelNames.style.width=this.maxWidthPanelNames+"px";this.oData.style.width=(this.contentWidth-this.maxWidthPanelNames)+"px";this.panelTasks.style.width=this.dayInPixels*this.countDays+"px";this.panelTime.style.width=(this.contentWidth-this.maxWidthPanelNames-0*18)+"px";this.panelTime.firstChild.style.width=this.dayInPixels*this.countDays+"px";if(this.isShowConMenu&&this.contextMenu==null)this.contextMenu=new contextMenu(this);}else{this.oData.style.width=this.contentWidth+"px";this.panelTime.style.width=(this.contentWidth-16)+"px";}
if(this._isOpera){this.oData.onmousewheel=function(){return false;}}
this.oData.onscroll=function(){self.panelTime.scrollLeft=this.scrollLeft;if(self.panelNames){self.panelNames.scrollTop=this.scrollTop;if(self.isShowConMenu)self.contextMenu.hideContextMenu();}};this.divTimeInfo=this.createPopUpTimeInfo();divCell.appendChild(this.divTimeInfo);this.oData.firstChild.appendChild(this.createPopUpInfo());for(var i=0;i<this.Project.length;i++)
{for(var k=0;k<this.Project[i].ParentTasks.length;k++)
{if(this.isEmpty(this.Project[i].ParentTasks[k].EST)){this.Project[i].ParentTasks[k].EST=this.Project[i].StartDate;}
this.setESTChild(this.Project[i].ParentTasks[k]);if(this.setPredTask(this.Project[i]))return;}
for(var k=0;k<this.Project[i].ParentTasks.length;k++){if(this.Project[i].ParentTasks[k].EST<this.Project[i].StartDate){if(!this.correctError){this.Error.throwError("DATA_ERROR",24,[this.Project[i].ParentTasks[k].Id,this.Project[i].Id]);return;}else{this.Project[i].ParentTasks[k].EST=this.Project[i].StartDate;}}
if(this.checkPosParentTaskInTree(this.Project[i].ParentTasks[k]))return;}
this.sortTasksByEST(this.Project[i]);}
for(var i=0;i<this.Project.length;i++)
{var project=new GanttProject(this,this.Project[i]);if(this.arrProjects.length>0)
{var previousProject=this.arrProjects[this.arrProjects.length-1];project.previousProject=previousProject;previousProject.nextProject=project;}
project.create();this.checkHeighPanelTasks();this.arrProjects.push(project);this.createTasks(project);}
return this;};GanttChart.prototype.isEmpty=function(value)
{return(value==null||value=='');};GanttChart.prototype.getPrintableHTML=function()
{var w=parseInt(this.oData.firstChild.style.width)-parseInt(this.oData.style.width);var h=parseInt(this.panelTasks.style.height)-parseInt(this.panelTasks.parentNode.style.height);this.oData.setAttribute("id","ganttPrint02");this.panelNames.setAttribute("id","ganttPrint03");var res='<html><head><link type="text/css" rel="stylesheet" href="'+this.stylePath+'"><scr'+'ipt>onload=function(){var w='+w+',h='+h+',c1=document.getElementById("ganttPrint01"),c2=document.getElementById("ganttPrint02"),c3=document.getElementById("ganttPrint03");'+'c2.style.width=parseInt(c2.style.width)+w+"px";c2.previousSibling.style.width=c2.style.width;c1.style.width=parseInt(c1.style.width)+w+"px";c2.style.height=parseInt(c2.style.height)+h+"px";'+'c2.style.overflow="hidden";c3.style.height=c3.firstChild.style.height;c1.style.height=parseInt(c1.style.height)+h+"px";}</scr'+'ipt></head>'+'<body><div id="ganttPrint01" style="'+this.content.style.cssText+'">'+this.content.innerHTML+'</div></body></html>';this.oData.setAttribute("id",null);this.panelNames.setAttribute("id",null);return res;};GanttChart.prototype.printToWindow=function(message)
{var o=window.open();o.document.write(this.getPrintableHTML());o.document.close();if(message!==null){o.alert(message?message:"Use browser's menu \"File->Print preview\" to setup page layout.");}};GanttChart.prototype.getStartDate=function()
{for(var i=0;i<this.Project.length;i++){if(this.startDate){if(this.Project[i].StartDate<this.startDate){this.startDate=new Date(this.Project[i].StartDate);}}
else{this.startDate=new Date(this.Project[i].StartDate);}}
this.initialPos=24*this.hourInPixels;if(this.startDate){return new Date(this.startDate.setHours(this.startDate.getHours()-24));}
else{return new Date();}};GanttChart.prototype.getCountDays=function()
{if(this._showTreePanel){return parseInt((this.contentWidth-this.maxWidthPanelNames)/(this.hourInPixels*24));}else{return parseInt((this.contentWidth)/(this.hourInPixels*24));}};GanttChart.prototype.createTasks=function(project)
{for(var j=0;j<project.Project.ParentTasks.length;j++)
{if(j>0)
{project.Project.ParentTasks[j-1].nextParentTask=project.Project.ParentTasks[j];project.Project.ParentTasks[j].previousParentTask=project.Project.ParentTasks[j-1];}
var task=new GanttTask(project.Project.ParentTasks[j],project,this);project.arrTasks.push(task);task.create();this.checkHeighPanelTasks();if(project.Project.ParentTasks[j].ChildTasks.length>0)
{this.createChildItemControls(project.Project.ParentTasks[j].ChildTasks,project);}}};GanttChart.prototype.createChildItemControls=function(arrChildTasks,project)
{for(var i=0;i<arrChildTasks.length;i++){if(i>0)
{arrChildTasks[i].previousChildTask=arrChildTasks[i-1];arrChildTasks[i-1].nextChildTask=arrChildTasks[i];}
var task=new GanttTask(arrChildTasks[i],project,this);task.create();this.checkHeighPanelTasks();if(arrChildTasks[i].ChildTasks.length>0)
{this.createChildItemControls(arrChildTasks[i].ChildTasks,project);}}};GanttTask.prototype.getPopUpInfo=function(object,event)
{var posY=object.offsetTop+this.Chart.heightTaskItem+6;var posX=object.offsetLeft+((event.layerX==null)?event.offsetX:event.layerX);var tblInfo=this.Chart.divInfo.lastChild;tblInfo.rows[0].cells[0].innerHTML="<div style='font-family: Arial, Helvetica, Sans-serif; font-size: 12px; font-weight: bold; color: #688060; margin: 0 0 4px 0;'>"+this.TaskInfo.Name+"</div>";tblInfo.rows[0].cells[0].innerHTML+="<span class='st'>EST:&nbsp;</span><span class='ut'>"+this.TaskInfo.EST.getDate()+"."+(this.TaskInfo.EST.getMonth()+1)+"."+this.TaskInfo.EST.getFullYear()+"</span><br/>";tblInfo.rows[0].cells[0].innerHTML+="<span class='st'>Duration:&nbsp;</span><span class='ut'>"+this.TaskInfo.Duration+" hours </span><br/>";if(this.predTask)
{tblInfo.rows[0].cells[0].innerHTML+="<span class='st'>Predecessor Task:&nbsp;</span>";tblInfo.rows[0].cells[0].innerHTML+="<span class='lt'>*"+this.TaskInfo.PredecessorTask.Name+"</span>";}
if(this.TaskInfo.ChildTasks.length!=0){tblInfo.rows[0].cells[0].innerHTML+="<span class='st'>Child Tasks:&nbsp;</span>";for(var i=0;i<this.TaskInfo.ChildTasks.length;i++)
{tblInfo.rows[0].cells[0].innerHTML+=(i==this.TaskInfo.ChildTasks.length-1)?("<span class='lt'>*"+this.TaskInfo.ChildTasks[i].Name+"</span>"):("<span class='lt'>*"+this.TaskInfo.ChildTasks[i].Name+"</span>");}}
if(this.TaskInfo.ParentTask){tblInfo.rows[0].cells[0].innerHTML+="<span class='st'>Parent Task:&nbsp;</span>";tblInfo.rows[0].cells[0].innerHTML+="<span class='lt'>*"+this.TaskInfo.ParentTask.Name+"</span>";}
this.Chart.divInfo.style.cssText="z-index:2;position: absolute;display: inline;";if(posY+this.Chart.divInfo.lastChild.offsetHeight+10>this.Chart.oData.offsetHeight+this.Chart.oData.scrollTop){this.Chart.divInfo.style.top=(posY-this.Chart.divInfo.lastChild.offsetHeight-10-this.Chart.heightTaskItem)+"px";}
else{this.Chart.divInfo.style.top=posY+"px";}
if(this.Chart.divInfo.lastChild.offsetWidth+posX+10>this.Chart.oData.offsetWidth+this.Chart.oData.scrollLeft){this.Chart.divInfo.style.left=posX-(this.Chart.divInfo.lastChild.offsetWidth+posX+20-(this.Chart.oData.offsetWidth+this.Chart.oData.scrollLeft))+"px";}else{this.Chart.divInfo.style.left=posX+"px";}};GanttTask.prototype.closePopUpInfo=function()
{this.Chart.divInfo.style.display="none";};GanttTask.prototype.createConnectingLinesPN=function()
{var arrConnectingLinesNames=[];return arrConnectingLinesNames;};GanttTask.prototype.createConnectingLinesDS=function()
{var oData=this.Chart.oData.firstChild;var arrLines=[];var arrowImg=new Image();arrowImg.src=this.Chart.imgs+"arr.gif";var lineVerticalRight=document.createElement("div");var lineHorizontal=document.createElement("div");var posXPredecessorTask=parseInt(this.predTask.cTaskItem[0].style.left);var posYPredecessorTask=parseInt(this.predTask.cTaskItem[0].style.top);var posXChildTask=parseInt(this.cTaskItem[0].style.left);var posYChildTask=this.posY+2;var widthChildTask=parseInt(this.predTask.cTaskItem[0].firstChild.firstChild.width);var widthPredecessorTask=parseInt(this.predTask.cTaskItem[0].firstChild.firstChild.width);if(posYPredecessorTask<posYChildTask)
{lineVerticalRight.style.cssText="border-width: 0px 0px 0px 1px; border-style: solid; border-color: #4A8F43;margin: 0px; padding: 0px;z-index:0;font-size: 1px;position: absolute;"+"height:"+(posYChildTask-this.Chart.heightTaskItem/2-posYPredecessorTask-3)+"px;width:"+1+"px;left:"+(posXPredecessorTask+widthPredecessorTask-20)+"px;top:"+(posYPredecessorTask+this.Chart.heightTaskItem)+"px;";lineHorizontal.style.cssText="height:1px;border-color: #4A8F43;border-style: solid;border-width: 1px 0px 0px 0px;margin: 0px; padding: 0px;z-index:0;position: absolute;"+"width:"+(15+(posXChildTask-(widthPredecessorTask+posXPredecessorTask)))+"px;left:"+(posXPredecessorTask+widthPredecessorTask-20)+"px;top:"+(posYChildTask+2)+"px;";arrowImg.style.cssText="margin: 0px; padding: 0px;width:7px;height:14px;position: absolute;left:"+(posXChildTask-7)+"px;top:"+(posYChildTask-1)+"px;";}else{lineVerticalRight.style.cssText="border-width: 0px 0px 0px 1px; border-style: solid; border-color: #4A8F43;margin: 0px; padding: 0px;z-index:0;font-size: 1px;position: absolute;"+"height:"+(posYPredecessorTask+2-posYChildTask)+"px;width:"+1+"px;left:"+(posXPredecessorTask+widthPredecessorTask-20)+"px;top:"+(posYChildTask+2)+"px;";lineHorizontal.style.cssText="height:1px;border-color: #4A8F43;border-style: solid;border-width: 1px 0px 0px 0px;margin: 0px; padding: 0px;z-index:0;position: absolute;"+"width:"+(15+(posXChildTask-(widthPredecessorTask+posXPredecessorTask)))+"px;left:"+(posXPredecessorTask+widthPredecessorTask-20)+"px;top:"+(posYChildTask+2)+"px;";arrowImg.style.cssText="margin: 0px; padding: 0px;width:7px;height:14px;position: absolute;left:"+(posXChildTask-7)+"px;top:"+(posYChildTask-1)+"px;";}
oData.appendChild(lineVerticalRight);oData.appendChild(lineHorizontal);oData.appendChild(arrowImg);arrLines.push(lineVerticalRight);arrLines.push(arrowImg);arrLines.push(lineHorizontal);return arrLines;};GanttTask.prototype.showChildTasks=function(task,isOpen)
{if(isOpen)
{for(var i=0;i<task.childTask.length;i++)
{if(task.childTask[i].cTaskItem[0].style.display=="none"){task.childTask[i].cTaskItem[0].style.display="inline";task.childTask[i].cTaskNameItem[0].style.display="inline";if(this.Chart.isShowDescTask){task.childTask[i].showDescTask();}
task.isHide=false;if(task.childTask[i].cTaskNameItem[2]){task.childTask[i].cTaskNameItem[2].style.display="inline";isOpen=task.childTask[i]._isOpen;}
for(var k=0;k<task.childTask[i].cTaskItem[1].length;k++){task.childTask[i].cTaskItem[1][k].style.display="inline";}
for(var k=0;k<task.childTask[i].cTaskNameItem[1].length;k++){task.childTask[i].cTaskNameItem[1][k].style.display="inline";}
this._heightHideTasks+=this.Chart.heightTaskItem+11;if(task.childTask[i].childTask.length>0){this.showChildTasks(task.childTask[i],isOpen);}}}}};GanttTask.prototype.hideChildTasks=function(task)
{for(var i=0;i<task.childTask.length;i++)
{if(task.childTask[i].cTaskItem[0].style.display!="none")
{task.childTask[i].cTaskItem[0].style.display="none";task.childTask[i].cTaskNameItem[0].style.display="none";if(this.Chart.isShowDescTask){task.childTask[i].hideDescTask();}
task.isHide=true;if(task.childTask[i].cTaskNameItem[2]){task.childTask[i].cTaskNameItem[2].style.display="none";}
for(var k=0;k<task.childTask[i].cTaskItem[1].length;k++){task.childTask[i].cTaskItem[1][k].style.display="none";}
for(var k=0;k<task.childTask[i].cTaskNameItem[1].length;k++){task.childTask[i].cTaskNameItem[1][k].style.display="none";}
this._heightHideTasks+=this.Chart.heightTaskItem+11;if(task.childTask[i].childTask.length>0){this.hideChildTasks(task.childTask[i]);}}}};GanttTask.prototype.shiftCurrentTasks=function(task,height)
{this.shiftNextTask(this,height);task.Project.shiftNextProject(task.Project,height);};GanttProject.prototype.shiftNextProject=function(project,height)
{if(project.nextProject){project.nextProject.shiftProject(height);this.shiftNextProject(project.nextProject,height);}};GanttProject.prototype.shiftProject=function(height)
{this.projectItem[0].style.top=parseInt(this.projectItem[0].style.top)+height+"px";if(this.Chart.isShowDescProject){this.descrProject.style.top=parseInt(this.descrProject.style.top)+height+"px";}
if(this.Chart._showTreePanel){this.projectNameItem.style.top=parseInt(this.projectNameItem.style.top)+height+"px";}
if(this.arrTasks.length>0)
this.shiftNextParentTask(this.arrTasks[0],height);};GanttProject.prototype.shiftTask=function(task,height)
{if(this.Chart._showTreePanel){task.cTaskNameItem[0].style.top=parseInt(task.cTaskNameItem[0].style.top)+height+"px";if(task.cTaskNameItem[2]){task.cTaskNameItem[2].style.top=parseInt(task.cTaskNameItem[2].style.top)+height+"px";}
if(task.parentTask&&task.cTaskNameItem[1][0])
{task.cTaskNameItem[1][0].style.top=parseInt(task.cTaskNameItem[1][0].style.top)+height+"px";task.cTaskNameItem[1][1].style.top=parseInt(task.cTaskNameItem[1][1].style.top)+height+"px";}}
task.cTaskItem[0].style.top=parseInt(task.cTaskItem[0].style.top)+height+"px";if(this.Chart.isShowDescTask){task.descrTask.style.top=parseInt(task.descrTask.style.top)+height+"px";}
if(task.cTaskItem[1][0])
{task.cTaskItem[1][0].style.top=parseInt(task.cTaskItem[1][0].style.top)+height+"px";task.cTaskItem[1][1].style.top=parseInt(task.cTaskItem[1][1].style.top)+height+"px";task.cTaskItem[1][2].style.top=parseInt(task.cTaskItem[1][2].style.top)+height+"px";}};GanttProject.prototype.shiftNextParentTask=function(task,height)
{this.shiftTask(task,height);this.shiftChildTasks(task,height);if(task.nextParentTask){this.shiftNextParentTask(task.nextParentTask,height);}};GanttProject.prototype.shiftChildTasks=function(task,height)
{for(var i=0;i<task.childTask.length;i++)
{this.shiftTask(task.childTask[i],height);if(task.childTask[i].childTask.length>0){this.shiftChildTasks(task.childTask[i],height);}}};GanttTask.prototype.shiftTask=function(task,height)
{if(this.Chart._showTreePanel){task.cTaskNameItem[0].style.top=parseInt(task.cTaskNameItem[0].style.top)+height+"px";if(task.cTaskNameItem[2]){task.cTaskNameItem[2].style.top=parseInt(task.cTaskNameItem[2].style.top)+height+"px";}
if(task.parentTask)
{if(task.cTaskNameItem[1].length>0)if((parseInt(this.cTaskNameItem[0].style.top)>parseInt(task.parentTask.cTaskNameItem[0].style.top))&&(task.cTaskNameItem[1][0].style.display!="none")){task.cTaskNameItem[1][0].style.height=parseInt(task.cTaskNameItem[1][0].style.height)+height+"px";}else{task.cTaskNameItem[1][0].style.top=parseInt(task.cTaskNameItem[1][0].style.top)+height+"px";}
if(task.cTaskNameItem[1].length>1)task.cTaskNameItem[1][1].style.top=parseInt(task.cTaskNameItem[1][1].style.top)+height+"px";}}
task.cTaskItem[0].style.top=parseInt(task.cTaskItem[0].style.top)+height+"px";if(this.Chart.isShowDescTask){task.descrTask.style.top=parseInt(task.descrTask.style.top)+height+"px";}
if(task.predTask)
{if(task.cTaskItem[1].length>0)if(((parseInt(this.cTaskItem[0].style.top)>parseInt(task.predTask.cTaskItem[0].style.top))||(this.cTaskItem[0].id==task.predTask.TaskInfo.Id))&&task.cTaskItem[1][0].style.display!="none"){task.cTaskItem[1][0].style.height=parseInt(task.cTaskItem[1][0].style.height)+height+"px";}else{task.cTaskItem[1][0].style.top=parseInt(task.cTaskItem[1][0].style.top)+height+"px";}
if(task.cTaskItem[1].length>2){task.cTaskItem[1][1].style.top=parseInt(task.cTaskItem[1][1].style.top)+height+"px";task.cTaskItem[1][2].style.top=parseInt(task.cTaskItem[1][2].style.top)+height+"px";}}};GanttTask.prototype.shiftNextTask=function(task,height)
{if(task.nextChildTask){this.shiftTask(task.nextChildTask,height);this.shiftChildTask(task.nextChildTask,height);this.shiftNextTask(task.nextChildTask,height);}else if(task.parentTask){this.shiftNextTask(task.parentTask,height);}else if(task.nextParentTask){this.shiftTask(task.nextParentTask,height);this.shiftChildTask(task.nextParentTask,height);this.shiftNextTask(task.nextParentTask,height);}};GanttTask.prototype.shiftChildTask=function(task,height)
{for(var i=0;i<task.childTask.length;i++)
{this.shiftTask(task.childTask[i],height);if(task.childTask[i].childTask.length>0){this.shiftChildTask(task.childTask[i],height);}}};GanttChart.prototype.getPosOnDate=function(est)
{return(est-this.startDate)/(60*60*1000)*this.hourInPixels;};GanttChart.prototype.getWidthOnDuration=function(duration)
{return Math.round(this.hourInPixelsWork*duration);};GanttTask.prototype.endMove=function()
{var width=parseInt(this.cTaskItem[0].style.left)-this.posX;var est=this.getDateOnPosition(parseInt(this.cTaskItem[0].style.left));est=this.checkPos(est);this.wasMoved=this.TaskInfo.EST.valueOf()!=est.valueOf();if(this.checkMove){width=this.Chart.getPosOnDate(est)-this.posX;this.moveCurrentTaskItem(width,this.moveChild);this.Project.shiftProjectItem();}
this.checkMove=false;this.posX=0;this.maxPosXMove=-1;this.minPosXMove=-1;this.cTaskItem[0].childNodes[1].firstChild.rows[0].cells[0].innerHTML="";if(this.Chart._isFF)document.body.style.cursor="";if(this.Chart._isIE)this.cTaskItem[0].childNodes[2].childNodes[0].style.cursor="";};GanttTask.prototype.checkPos=function(est)
{var h=est.getHours();if(h>=12)
{est.setDate(est.getDate()+1);est.setHours(0);if((parseInt(this.cTaskItem[0].firstChild.firstChild.width)+this.Chart.getPosOnDate(est)>this.maxPosXMove)&&(this.maxPosXMove!=-1))
{est.setDate(est.getDate()-1);est.setHours(0);}}else if((h<12)&&(h!=0))
{est.setHours(0);if((this.Chart.getPosOnDate(est)<this.minPosXMove))
{est.setDate(est.getDate()+1);}}
this.cTaskItem[0].style.left=this.Chart.getPosOnDate(est)+"px";return est;};GanttTask.prototype.getMaxPosPredChildTaskItem=function()
{var posPredChildTaskItem=0;var nextPosPredChildTaskItem=0;for(var i=0;i<this.childPredTask.length;i++)
{nextPosPredChildTaskItem=this.getMaxPosPredChildTaskItemInTree(this.childPredTask[i]);if(nextPosPredChildTaskItem>posPredChildTaskItem)
{posPredChildTaskItem=nextPosPredChildTaskItem;}}
return posPredChildTaskItem;};GanttTask.prototype.getMaxPosPredChildTaskItemInTree=function(task)
{var currentPos=parseInt(task.cTaskItem[0].firstChild.firstChild.width)+parseInt(task.cTaskItem[0].style.left);var posPredChildTaskItem=0;var nextPosPredChildTaskItem=0;for(var i=0;i<task.childPredTask.length;i++)
{nextPosPredChildTaskItem=this.getMaxPosPredChildTaskItemInTree(task.childPredTask[i]);if(nextPosPredChildTaskItem>posPredChildTaskItem)
{posPredChildTaskItem=nextPosPredChildTaskItem;}}
if(posPredChildTaskItem>currentPos)
{return posPredChildTaskItem;}
else
{return currentPos;}};GanttProject.prototype.getTaskById=function(id)
{for(var i=0;i<this.arrTasks.length;i++)
{var task=this.searchTaskInTree(this.arrTasks[i],id);if(task)return task;}
return null;};GanttProject.prototype.searchTaskInTree=function(task,id)
{if(task.TaskInfo.Id==id)
{return task;}else
{for(var i=0;i<task.childTask.length;i++)
{if(task.childTask[i].TaskInfo.Id==id)
{return task.childTask[i];}
else
{if(task.childTask[i].childTask.length>0)
{var cTask=this.searchTaskInTree(task.childTask[i],id);if(cTask)return cTask;}}}}
return null;};GanttProject.prototype.shiftProjectItem=function()
{var posItemL=null;var posItemR=null;var posProjectItemL=parseInt(this.projectItem[0].style.left);var posProjectItemR=parseInt(this.projectItem[0].firstChild.style.width)+parseInt(this.projectItem[0].style.left);var widthProjectItem=parseInt(this.projectItem[0].firstChild.style.width);for(var t=0;t<this.arrTasks.length;t++)
{var tmpPosItemL=parseInt(this.arrTasks[t].cTaskItem[0].style.left);var tmpPosItemR=parseInt(this.arrTasks[t].cTaskItem[0].style.left)+parseInt(this.arrTasks[t].cTaskItem[0].firstChild.firstChild.width);if(!posItemL){posItemL=tmpPosItemL;}
if(!posItemR){posItemR=tmpPosItemR;}
if(posItemL>tmpPosItemL){posItemL=tmpPosItemL;}
if(posItemR<tmpPosItemR){posItemR=tmpPosItemR;}}
if(posItemL!=posProjectItemL)
{this.Project.StartDate=new Date(this.Chart.startDate);this.Project.StartDate.setHours(this.Project.StartDate.getHours()+(posItemL/this.Chart.hourInPixels));}
this.projectItem[0].style.left=posItemL+"px";this.resizeProjectItem(posItemR-posItemL);this.Duration=Math.round(parseInt(this.projectItem[0].firstChild.width)/(this.Chart.hourInPixelsWork));if(this.Chart.isShowDescProject){this.moveDescrProject();}
this.addDayInPanelTime();};GanttProject.prototype.addDayInPanelTime=function()
{var width=parseInt(this.projectItem[0].style.left)+parseInt(this.projectItem[0].firstChild.style.width)+20;if(this.Chart.isShowDescProject){width+=this.descrProject.offsetWidth;}
var table=this.Chart.panelTime.firstChild,tbody=table.firstChild;if(parseInt(tbody.offsetWidth)<width)
{var countDays=Math.round((width-parseInt(tbody.offsetWidth))/this.Chart.dayInPixels);var row=tbody.rows[1];for(var n=0;n<countDays;n++)
{this.Chart.addPointInTimePanel(row,table);this.Chart.addDayInPanelTime(row);}
var w=this.Chart.dayInPixels*(row.cells.length);tbody.style.width=w+"px";this.Chart.panelTasks.style.width=(w-18)+"px";}};GanttProject.prototype.addEvent=function(elm,evType,fn,useCapture)
{if(elm.addEventListener){elm.addEventListener(evType,fn,useCapture);return true;}
else if(elm.attachEvent){return elm.attachEvent('on'+evType,fn);}
else{elm['on'+evType]=fn;}};GanttProject.prototype.getPopUpInfo=function(object,event)
{var posX=object.offsetLeft+((event.layerX==null)?event.offsetX:event.layerX);var posY=object.offsetTop+this.Chart.heightTaskItem+6;var tblInfo=this.Chart.divInfo.lastChild;tblInfo.rows[0].cells[0].innerHTML="<div style='font-family: Arial, Helvetica, Sans-serif; font-size: 12px; font-weight: bold; color: #688060; margin:0 0 4px 0;'>"+this.Project.Name+"</div>";tblInfo.rows[0].cells[0].innerHTML+="<span class='st'>Start Date:&nbsp;</span><span class='ut'>"+this.Project.StartDate.getDate()+"."+(this.Project.StartDate.getMonth()+1)+"."+this.Project.StartDate.getFullYear()+"</span><br/>";tblInfo.rows[0].cells[0].innerHTML+="<span class='st'>Duration:&nbsp;</span><span class='ut'>"+this.Duration+" hours</span><br/>";this.Chart.divInfo.style.cssText="z-index:2;position: absolute;display: inline;";if(posY+this.Chart.divInfo.lastChild.offsetHeight+6>this.Chart.oData.offsetHeight+this.Chart.oData.scrollTop)
{this.Chart.divInfo.style.top=(posY-this.Chart.divInfo.lastChild.offsetHeight-10-this.Chart.heightTaskItem)+"px";}
else{this.Chart.divInfo.style.top=posY+"px";}
if(this.Chart.divInfo.lastChild.offsetWidth+posX+10>this.Chart.oData.offsetWidth+this.Chart.oData.scrollLeft)
{this.Chart.divInfo.style.left=posX-(this.Chart.divInfo.lastChild.offsetWidth+posX+20-(this.Chart.oData.offsetWidth+this.Chart.oData.scrollLeft))+"px";}else{this.Chart.divInfo.style.left=posX+"px";}};GanttProject.prototype.closePopUpInfo=function()
{this.Chart.divInfo.style.display="none";};GanttProject.prototype.resizeProjectItem=function(width)
{var percentCompleted=this.percentCompleted;if(percentCompleted>0&&percentCompleted<100)
{this.projectItem[0].firstChild.style.width=width+"px";this.projectItem[0].firstChild.width=width+"px";this.projectItem[0].style.width=width+"px";this.projectItem[0].firstChild.rows[0].cells[0].firstChild.style.width=Math.round(width*percentCompleted/100)+"px";this.projectItem[0].firstChild.rows[0].cells[1].firstChild.style.width=Math.round(width*(100-percentCompleted)/100)+"px";this.projectItem[0].lastChild.firstChild.width=width+"px";}else if(percentCompleted==0||percentCompleted==100)
{this.projectItem[0].firstChild.style.width=width+"px";this.projectItem[0].firstChild.width=width+"px";this.projectItem[0].style.width=width+"px";this.projectItem[0].firstChild.rows[0].cells[0].firstChild.style.width=width+"px";this.projectItem[0].lastChild.firstChild.width=width+"px";}};GanttTask.prototype.moveCurrentTaskItem=function(width,moveChild)
{var taskItem=this.cTaskItem[0];this.TaskInfo.EST=new Date(this.Chart.startDate);this.TaskInfo.EST.setHours(this.TaskInfo.EST.getHours()+(parseInt(taskItem.style.left)/this.Chart.hourInPixels));if(this.Chart.isShowDescTask){this.showDescTask();}
if(this.cTaskItem[1].length>0){this.cTaskItem[1][2].style.width=parseInt(this.cTaskItem[1][2].style.width)+width+"px";this.cTaskItem[1][1].style.left=parseInt(this.cTaskItem[1][1].style.left)+width+"px";}
for(var i=0;i<this.childTask.length;i++){if(!this.childTask[i].predTask){this.moveChildTaskItems(this.childTask[i],width,moveChild);}}
for(var i=0;i<this.childPredTask.length;i++){this.moveChildTaskItems(this.childPredTask[i],width,moveChild);}};GanttTask.prototype.moveChildTaskItems=function(task,width,moveChild)
{var taskItem=task.cTaskItem[0];if(moveChild)
{taskItem.style.left=parseInt(taskItem.style.left)+width+"px";task.addDayInPanelTime();task.TaskInfo.EST=new Date(this.Chart.startDate);task.TaskInfo.EST.setHours(task.TaskInfo.EST.getHours()+(parseInt(taskItem.style.left)/this.Chart.hourInPixels));for(var n=0;n<task.cTaskItem[1].length;n++){task.cTaskItem[1][n].style.left=parseInt(task.cTaskItem[1][n].style.left)+width+"px";}
for(var i=0;i<task.childTask.length;i++){if(!task.childTask[i].predTask){this.moveChildTaskItems(task.childTask[i],width,moveChild);}}
for(var i=0;i<task.childPredTask.length;i++){this.moveChildTaskItems(task.childPredTask[i],width,moveChild);}}
else
{if(task.cTaskItem[1].length>0)
{task.cTaskItem[1][2].style.left=parseInt(task.cTaskItem[1][2].style.left)+width+"px";task.cTaskItem[1][2].style.width=parseInt(task.cTaskItem[1][2].style.width)-width+"px";task.cTaskItem[1][0].style.left=parseInt(task.cTaskItem[1][0].style.left)+width+"px";}}
if(this.Chart.isShowDescTask){task.moveDescTask();}};GanttTask.prototype.addDayInPanelTime=function()
{var taskItem=this.cTaskItem[0];var width=parseInt(taskItem.style.left)+parseInt(taskItem.firstChild.firstChild.width)+20;if(this.Chart.isShowDescTask){width+=this.descrTask.offsetWidth;}
var table=this.Chart.panelTime.firstChild,tbody=table.firstChild;if(parseInt(tbody.offsetWidth)<width)
{var row=tbody.rows[1];var countDays=Math.round((width+20-parseInt(tbody.offsetWidth))/this.Chart.dayInPixels);for(var n=0;n<countDays;n++)
{this.Chart.addPointInTimePanel(row,table);this.Chart.addDayInPanelTime(row);}
var w=this.Chart.dayInPixels*(row.cells.length);tbody.style.width=w+"px";this.Chart.panelTasks.style.width=(w-18)+"px";}};GanttTask.prototype.getDateOnPosition=function(position)
{var date=new Date(this.Chart.startDate);date.setHours(date.getHours()+(position/this.Chart.hourInPixels));return date;};GanttTask.prototype.moveItem=function(event)
{var pageX=event.screenX;var posTaskItem=(this.posX+(pageX-this.MouseX));var widthTaskItem=parseInt(this.cTaskItem[0].childNodes[0].firstChild.width);var posTaskItemR=posTaskItem+widthTaskItem;if(this.checkMove)
{var date=this.getDateOnPosition(posTaskItem);var res=this.Chart.callEvent("onTaskDragging",[this,date])!==false;if(res&&((this.minPosXMove<=posTaskItem))&&((posTaskItemR<=this.maxPosXMove)||(this.maxPosXMove==-1)))
{this.moveTaskItem(posTaskItem);}}};GanttTask.prototype.moveTaskItem=function(posX)
{this.addDayInPanelTime();this.cTaskItem[0].style.left=posX+"px";var date=this.getDateOnPosition(posX);this.cTaskItem[0].childNodes[1].firstChild.rows[0].cells[0].innerHTML=date.getDate()+'.'+(date.getMonth()+1)+'.'+date.getUTCFullYear();};GanttTask.prototype.resizeItem=function(event)
{if(this.checkResize)
{var MouseX=event.screenX;var widthTaskItem=this.taskItemWidth+(MouseX-this.MouseX);var countHours=Math.round(widthTaskItem/this.Chart.hourInPixelsWork);if(this.Chart.callEvent("onTaskResizing",[this,countHours])===false)return;if(widthTaskItem>=this.taskItemWidth)
{if((widthTaskItem<=this.maxWidthResize)||(this.maxWidthResize==-1))
{this.resizeTaskItem(widthTaskItem);this.addDayInPanelTime();}else if((this.maxWidthResize!=-1)&&(widthTaskItem>this.maxWidthResize))
{this.resizeTaskItem(this.maxWidthResize);}}else if(widthTaskItem<=this.taskItemWidth)
{if(widthTaskItem>=this.minWidthResize)
{this.resizeTaskItem(widthTaskItem);}
else if(widthTaskItem<this.minWidthResize)
{this.resizeTaskItem(this.minWidthResize);}}}};GanttTask.prototype.resizeTaskItem=function(width)
{var taskItem=this.cTaskItem[0];var countHours=Math.round(width/this.Chart.hourInPixelsWork);var c=taskItem.childNodes[0].firstChild.rows[0].cells[0];if(c)
{c.firstChild.style.width=parseInt(c.width)*width/100+"px";}
c=taskItem.childNodes[0].firstChild.rows[0].cells[1];if(c)
{c.firstChild.style.width=parseInt(c.width)*width/100+"px";}
taskItem.childNodes[0].firstChild.width=width+"px";taskItem.childNodes[1].firstChild.width=width+"px";this.cTaskItem[0].childNodes[1].firstChild.rows[0].cells[0].innerHTML=countHours;taskItem.childNodes[2].childNodes[0].style.width=width+"px";taskItem.childNodes[2].childNodes[1].style.left=width-10+"px";};GanttTask.prototype.endResizeItem=function()
{var taskItem=this.cTaskItem[0];this.wasResized=this.taskItemWidth!=parseInt(taskItem.childNodes[0].firstChild.width);if(this.wasResized)
{var posXL=taskItem.offsetLeft;var posXR=taskItem.offsetLeft+parseInt(taskItem.childNodes[0].firstChild.width);this.TaskInfo.Duration=Math.round((posXR-posXL)/this.Chart.hourInPixelsWork);if(this.childPredTask.length>0)
{for(var j=0;j<this.childPredTask.length;j++)
{this.childPredTask[j].cTaskItem[1][2].style.width=parseInt(this.childPredTask[j].cTaskItem[1][2].style.width)-(parseInt(taskItem.childNodes[0].firstChild.width)-this.taskItemWidth)+"px";this.childPredTask[j].cTaskItem[1][2].style.left=parseInt(this.childPredTask[j].cTaskItem[1][2].style.left)+(parseInt(taskItem.childNodes[0].firstChild.width)-this.taskItemWidth)+"px";this.childPredTask[j].cTaskItem[1][0].style.left=parseInt(this.childPredTask[j].cTaskItem[1][0].style.left)+(parseInt(taskItem.childNodes[0].firstChild.width)-this.taskItemWidth)+"px";}}}
this.cTaskItem[0].childNodes[1].firstChild.rows[0].cells[0].innerHTML="";this.checkResize=false;this.taskItemWidth=0;this.MouseX=0;if(this.Chart.isShowDescTask){this.showDescTask();}
this.Project.shiftProjectItem();if(this.Chart._isFF)document.body.style.cursor="";};GanttProject.prototype.moveDescrProject=function()
{this.descrProject.style.left=(parseInt(this.projectItem[0].style.left)+this.Duration*this.Chart.hourInPixelsWork+10);this.descrProject.innerHTML=this.getDescStr();};GanttProject.prototype.showDescrProject=function()
{var posX=(parseInt(this.projectItem[0].style.left)+this.Duration*this.Chart.hourInPixelsWork+10);this.descrProject.style.left=posX+"px";this.descrProject.style.visibility='visible';this.descrProject.innerHTML=this.getDescStr();};GanttProject.prototype.hideDescrProject=function()
{this.descrProject.style.visibility='hidden';};GanttProject.prototype.getDescStr=function()
{var str='',delim=", ";for(var i=0;i<this.Chart.paramShowProject.length;i++){switch(this.Chart.paramShowProject[i]){case"Name":if(str!="")str+=delim;str+=this.Project[this.Chart.paramShowProject[i]];break;case"StartDate":if(str!="")str+=delim;var d=this.Project[this.Chart.paramShowProject[i]];str+=d.getDate()+"."+(d.getMonth()+1)+"."+d.getFullYear();break;case"Duration":if(str!="")str+=delim;str+=this[this.Chart.paramShowProject[i]]+"h";break;case"percentCompleted":if(str!="")str+=delim;str+=this[this.Chart.paramShowProject[i]]+"%";break;default:break;}}
return str;};GanttProject.prototype.createDescrProject=function()
{var posX=(this.posX+this.Duration*this.Chart.hourInPixelsWork+10);var divDesc=document.createElement("div");divDesc.style.cssText+=";z-index:1;position:absolute;left:"+posX+"px;top:"+this.posY+"px;";divDesc.innerHTML=this.getDescStr();divDesc.className="descProject";this.descrProject=divDesc;if(this.Project.ParentTasks.length==0){this.descrProject.style.visibility='hidden';}
if(this.Chart._showTooltip)
{var self=this;var getPopUpInfo=function(e){if((!self.Chart._isMove)&&(!self.Chart._isResize))self.getPopUpInfo(self.descrProject,e);};var closePopUpInfo=function(){self.closePopUpInfo();};this.addEvent(divDesc,'mouseover',getPopUpInfo,false);this.addEvent(divDesc,'mouseout',closePopUpInfo,false);}
return divDesc;};GanttProject.prototype.createProjectItem=function()
{var self=this;this.percentCompleted=this.getPercentCompleted();this.Duration=this.getDuration();var projectItem=document.createElement("div");projectItem.id=this.Project.Id;projectItem.style.cssText=";z-index:1;position: absolute;left:"+this.posX+"px;top:"+this.posY+"px;";projectItem.style.width=this.Duration*this.Chart.hourInPixelsWork+"px";var tblProjectItem=document.createElement("table");projectItem.appendChild(tblProjectItem);tblProjectItem.cellPadding="0";tblProjectItem.cellSpacing="0";tblProjectItem.style.cssText="border: solid 1px #BC810D;";var width=this.Duration*this.Chart.hourInPixelsWork;tblProjectItem.width=((width==0)?1:width)+"px";tblProjectItem.style.width=((width==0)?1:width)+"px";var rowprojectItem=tblProjectItem.insertRow(tblProjectItem.rows.length);if(this.percentCompleted!=-1)
{if(this.percentCompleted!=0)
{var cellprojectItem=document.createElement("TD");rowprojectItem.appendChild(cellprojectItem);cellprojectItem.width=this.percentCompleted+"%";cellprojectItem.style.lineHeight="1px";var imgPr=document.createElement("img");imgPr.style.width=(this.percentCompleted*this.Duration*this.Chart.hourInPixelsWork)/100+"px";imgPr.style.height=this.Chart.heightTaskItem+"px";cellprojectItem.appendChild(imgPr);imgPr.src=this.Chart.imgs+"parentnode_filled.png";}
if(this.percentCompleted!=100)
{var cellprojectItem=document.createElement("TD");rowprojectItem.appendChild(cellprojectItem);cellprojectItem.width=(100-this.percentCompleted)+"%";cellprojectItem.style.lineHeight="1px";var imgPr=document.createElement("img");imgPr.style.width=((100-this.percentCompleted)*this.Duration*this.Chart.hourInPixelsWork)/100+"px";imgPr.style.height=this.Chart.heightTaskItem+"px";cellprojectItem.appendChild(imgPr);imgPr.src=this.Chart.imgs+"progress_bg.png";}}else
{var cellprojectItem=document.createElement("TD");rowprojectItem.appendChild(cellprojectItem);cellprojectItem.width="1px";cellprojectItem.style.lineHeight="1px";var imgPr=document.createElement("img");imgPr.style.width="1px";imgPr.style.height=this.Chart.heightTaskItem;cellprojectItem.appendChild(imgPr);imgPr.src=this.Chart.imgs+"progress_bg.png";}
var divTaskInfo=document.createElement("div");divTaskInfo.style.cssText="text-align:center;z-index:2;position:absolute;left:0px;top:0px;";var tblTaskInfo=document.createElement("table");divTaskInfo.appendChild(tblTaskInfo);tblTaskInfo.cellPadding="0";tblTaskInfo.cellSpacing="0";tblTaskInfo.height=this.Chart.heightTaskItem+"px";tblTaskInfo.width=((this.Duration*this.Chart.hourInPixelsWork==0)?1:this.Duration*this.Chart.hourInPixelsWork)+"px";var rowTaskInfo=tblTaskInfo.insertRow(0);var cellTaskInfo=document.createElement("td");cellTaskInfo.align="center";cellTaskInfo.vAlign="top";cellTaskInfo.height=this.Chart.heightTaskItem+"px";cellTaskInfo.className="moveInfo";cellTaskInfo.style.cssText=";white-space:nowrap;";rowTaskInfo.appendChild(cellTaskInfo);projectItem.appendChild(divTaskInfo);if(this.Project.ParentTasks.length==0)
{projectItem.style.display="none";}
if(this.Chart._showTooltip)
{var getPopUpInfo=function(e){if((!self.Chart._isMove)&&(!self.Chart._isResize))self.getPopUpInfo(self.projectItem[0],e);};var closePopUpInfo=function(){self.closePopUpInfo();};this.addEvent(divTaskInfo,'mouseover',getPopUpInfo,false);this.addEvent(divTaskInfo,'mouseout',closePopUpInfo,false);}
return projectItem;};GanttProject.prototype.createProjectNameItem=function()
{var self=this;var divName=document.createElement("div");divName.style.cssText="cursor:pointer;color:#003366;font-weight:bold;font-size:12px;font-family:Tahoma,Arial;white-space:nowrap;height:15px;z-index:1;position:absolute;left:"+5+"px;top:"+this.posY+"px;";divName.innerHTML=this.Project.Name;divName.title=this.Project.Name;if(this.Chart.isShowConMenu)
{var showContMenu=function(event){if(self.Chart.contextMenu.clear)self.Chart.contextMenu.clear();var hideContMenu=null;if(!self.Chart._isIE)
{hideContMenu=function(){self.Chart.contextMenu.hideContextMenu();self.Chart.content.removeEventListener("mousedown",hideContMenu,false);};}else
{hideContMenu=function(){self.Chart.contextMenu.hideContextMenu();self.Chart.content.detachEvent("mousedown",hideContMenu);};}
self.Chart.content.onmousedown=hideContMenu;if(!self.Chart._isIE)
{event.stopPropagation();}else
{event.cancelBubble=true;}
self.Chart._showContextMenu(event,self);};if(this.Chart._isIE)
{this.addEvent(divName,"contextmenu",function(e){showContMenu(e);return false;},false);}else
{this.addEvent(divName,"contextmenu",function(e){e.preventDefault();showContMenu(e);},false);}}
return divName;};GanttProject.prototype.getPercentCompleted=function()
{var sum=0;var percentCompleted=0;for(var i=0;i<this.Project.ParentTasks.length;i++){sum+=parseInt(this.Project.ParentTasks[i].PercentCompleted);}
if(this.Project.ParentTasks.length!=0){return percentCompleted=Math.round(sum/this.Project.ParentTasks.length);}
else{return percentCompleted=-1;}};GanttProject.prototype.getDuration=function()
{var duration=0;var tmpDuration=0;if(this.Project.ParentTasks.length>0)
{for(var i=0;i<this.Project.ParentTasks.length;i++)
{tmpDuration=this.Project.ParentTasks[i].Duration*24/this.Chart.hoursInDay+(this.Project.ParentTasks[i].EST-this.Chart.startDate)/(60*60*1000);if(tmpDuration>duration)
{duration=tmpDuration;}}
return((duration-this.posX)/24)*this.Chart.hoursInDay;}else
{return 0;}};GanttProject.prototype.getId=function()
{return this.Project.Id;};GanttProject.prototype.getName=function()
{return this.Project.Name;};GanttProject.prototype.getStartDate=function()
{return this.Project.StartDate;};GanttTask.prototype.addEvent=function(elm,evType,fn,useCapture)
{if(elm.addEventListener){elm.addEventListener(evType,fn,useCapture);return true;}
else if(elm.attachEvent){return elm.attachEvent('on'+evType,fn);}
else{elm['on'+evType]=fn;}};GanttTask.prototype.startMove=function(event)
{this.moveChild=event.ctrlKey;this.MouseX=event.screenX;this.getMoveInfo();this.checkMove=true;if(this.Chart.isShowDescTask){this.hideDescTask();}
if(this.Chart._isFF)document.body.style.cursor="move";if(this.Chart._isIE)event.srcElement.style.cursor="move";};GanttTask.prototype.showDescTask=function()
{var posX=(parseInt(this.cTaskItem[0].style.left)+this.TaskInfo.Duration*this.Chart.hourInPixelsWork+10);this.descrTask.style.left=posX+"px";this.descrTask.innerHTML=this.getDescStr();this.descrTask.style.visibility='visible';};GanttTask.prototype.hideDescTask=function()
{this.descrTask.style.visibility='hidden';};GanttTask.prototype.getDescStr=function()
{var str='',delim=", ";for(var i=0;i<this.Chart.paramShowTask.length;i++){var prop=this.Chart.paramShowTask[i],propValue=this.TaskInfo[prop];switch(prop){case"Name":if(str!="")str+=delim;str+=propValue;break;case"EST":if(str!="")str+=delim;str+=propValue.getDate()+"."+(propValue.getMonth()+1)+"."+propValue.getFullYear();break;case"S-F":if(str!="")str+=delim;propValue=this.TaskInfo["EST"];str+=propValue.getDate()+"."+(propValue.getMonth()+1)+"."+propValue.getFullYear()+" - ";propValue=this.getFinishDate();str+=propValue.getDate()+"."+(propValue.getMonth()+1)+"."+propValue.getFullYear();break;case"Duration":if(str!="")str+=delim;str+=propValue+"h";break;case"PercentCompleted":if(str!="")str+=delim;str+=propValue+"%";break;default:break;}}
return str;};GanttTask.prototype.getId=function()
{return this.TaskInfo.Id;};GanttTask.prototype.getName=function()
{return this.TaskInfo.Name;};GanttTask.prototype.getDuration=function()
{return this.TaskInfo.Duration;};GanttTask.prototype.getEST=function()
{return this.TaskInfo.EST;};GanttTask.prototype.getFinishDate=function()
{var date=new Date(this.TaskInfo.EST);date.setDate(date.getDate()+parseInt((this.TaskInfo["Duration"]-1)/this.Chart.hoursInDay+1)-1);return date;};GanttTask.prototype.getPercentCompleted=function()
{return this.TaskInfo.PercentCompleted;};GanttTask.prototype.getPredecessorTaskId=function()
{return this.TaskInfo.PredecessorTaskId?this.TaskInfo.PredecessorTaskId:null;};GanttTask.prototype.getParentTaskId=function()
{return this.parentTask?this.parentTask.getId():null;};GanttTask.prototype.moveDescTask=function()
{var posX=(parseInt(this.cTaskItem[0].style.left)+this.TaskInfo.Duration*this.Chart.hourInPixelsWork+10);this.descrTask.style.left=posX+"px";};GanttTask.prototype.getMoveInfo=function()
{this.posX=parseInt(this.cTaskItem[0].style.left);var widthTaskItem=parseInt(this.cTaskItem[0].childNodes[0].firstChild.width);var posParentTaskItem=(this.parentTask==null)?0:parseInt(this.parentTask.cTaskItem[0].style.left);var posPredTaskItem=(this.predTask==null)?0:parseInt(this.predTask.cTaskItem[0].style.left)+parseInt(this.predTask.cTaskItem[0].childNodes[0].firstChild.width);var widthParentTaskItem=(this.parentTask==null)?0:parseInt(this.parentTask.cTaskItem[0].childNodes[0].firstChild.width);var childPredPosX=0;var childParentPosX=0;var childParentPosXR=0;if(this.childPredTask.length>0)
{var posChildTaskItem=null;for(var n=0;n<this.childPredTask.length;n++)
{if((!posChildTaskItem)||((posChildTaskItem)&&(posChildTaskItem>parseInt(this.childPredTask[n].cTaskItem[0].style.left))))
{posChildTaskItem=parseInt(this.childPredTask[n].cTaskItem[0].style.left);}}
childPredPosX=posChildTaskItem;}
if(this.childTask.length>0)
{var posChildTaskItemR=null;for(var n=0;n<this.childTask.length;n++)
{if((!posChildTaskItemR)||((posChildTaskItemR)&&(posChildTaskItemR>(parseInt(this.childTask[n].cTaskItem[0].style.left)))))
{posChildTaskItemR=parseInt(this.childTask[n].cTaskItem[0].style.left);}}
childParentPosXR=posChildTaskItemR;var posChildTaskItem=null;for(var n=0;n<this.childTask.length;n++)
{if((!posChildTaskItem)||((posChildTaskItem)&&(posChildTaskItem<(parseInt(this.childTask[n].cTaskItem[0].style.left)+parseInt(this.childTask[n].cTaskItem[0].firstChild.firstChild.width)))))
{posChildTaskItem=parseInt(this.childTask[n].cTaskItem[0].style.left)+parseInt(this.childTask[n].cTaskItem[0].firstChild.firstChild.width);}}
childParentPosX=posChildTaskItem;}
if(!this.moveChild)
{if(this.childPredTask.length>0){if(this.maxPosXMove<childPredPosX)this.maxPosXMove=childPredPosX;}
if(this.childTask.length>0){if((this.childPredTask.length>0)&&(this.maxPosXMove-widthTaskItem)>childParentPosXR)this.maxPosXMove=this.maxPosXMove-((this.maxPosXMove-widthTaskItem)-childParentPosXR);if(!(this.childPredTask.length>0))this.maxPosXMove=childParentPosXR+widthTaskItem;this.minPosXMove=(childParentPosX-widthTaskItem);}
if(posParentTaskItem>0)
{if((!(this.childPredTask.length>0))&&(this.childTask.length>0)){if(this.maxPosXMove>posParentTaskItem+widthParentTaskItem){this.maxPosXMove=posParentTaskItem+widthParentTaskItem;}}
if(this.minPosXMove<=posParentTaskItem){this.minPosXMove=posParentTaskItem;}
if((!(this.childTask.length>0))&&(!(this.childPredTask.length>0))){this.maxPosXMove=posParentTaskItem+widthParentTaskItem;}else if((!(this.childTask.length>0))&&(this.childPredTask.length>0)){if((posParentTaskItem+widthParentTaskItem)>posPredTaskItem){this.maxPosXMove=childPredPosX;}}}
if(posPredTaskItem>0){if(this.minPosXMove<=posPredTaskItem){this.minPosXMove=posPredTaskItem;}}
if((posPredTaskItem==0)&&(posParentTaskItem==0)){if(this.minPosXMove<=this.Chart.initialPos){this.minPosXMove=this.Chart.initialPos;}}}else
{if((posParentTaskItem>0)&&(posPredTaskItem==0))
{this.minPosXMove=posParentTaskItem;this.maxPosXMove=posParentTaskItem+widthParentTaskItem;}else if((posParentTaskItem==0)&&(posPredTaskItem==0))
{this.minPosXMove=this.Chart.initialPos;this.maxPosXMove=-1;}else if((posParentTaskItem>0)&&(posPredTaskItem>0))
{this.minPosXMove=posPredTaskItem;this.maxPosXMove=posParentTaskItem+widthParentTaskItem;}else if((posParentTaskItem==0)&&(posPredTaskItem>0))
{this.minPosXMove=posPredTaskItem;this.maxPosXMove=-1;}
if((this.parentTask)&&(this.childPredTask.length>0))
{var posChildTaskItem=this.getMaxPosPredChildTaskItem(this);var posParentTaskItem=parseInt(this.parentTask.cTaskItem[0].style.left)+parseInt(this.parentTask.cTaskItem[0].firstChild.firstChild.width);this.maxPosXMove=this.posX+widthTaskItem+posParentTaskItem-posChildTaskItem;}}};GanttTask.prototype.startResize=function(event)
{this.MouseX=event.screenX;this.getResizeInfo();if(this.Chart.isShowDescTask){this.hideDescTask();}
this.checkResize=true;this.taskItemWidth=parseInt(this.cTaskItem[0].firstChild.firstChild.width);if(this.Chart._isFF)document.body.style.cursor="e-resize";};GanttTask.prototype.getResizeInfo=function()
{var taskItem=this.cTaskItem[0];var posParentTaskItem=(this.parentTask==null)?0:parseInt(this.parentTask.cTaskItem[0].style.left);var widthParentTaskItem=(this.parentTask==null)?0:parseInt(this.parentTask.cTaskItem[0].childNodes[0].firstChild.width);var posTaskItem=parseInt(this.cTaskItem[0].style.left);var childPredPosX=0;var childParentPosX=0;if(this.childPredTask.length>0)
{var posChildTaskItem=null;for(var n=0;n<this.childPredTask.length;n++)
{if((!posChildTaskItem)||((posChildTaskItem)&&(posChildTaskItem>parseInt(this.childPredTask[n].cTaskItem[0].style.left))))
{posChildTaskItem=parseInt(this.childPredTask[n].cTaskItem[0].style.left);}}
childPredPosX=posChildTaskItem;}
if(this.childTask.length>0)
{var posChildTaskItem=null;for(var n=0;n<this.childTask.length;n++)
{if((!posChildTaskItem)||((posChildTaskItem)&&(posChildTaskItem<(parseInt(this.childTask[n].cTaskItem[0].style.left)+parseInt(this.childTask[n].cTaskItem[0].firstChild.firstChild.width)))))
{posChildTaskItem=parseInt(this.childTask[n].cTaskItem[0].style.left)+parseInt(this.childTask[n].cTaskItem[0].firstChild.firstChild.width);}}
childParentPosX=posChildTaskItem;}
this.minWidthResize=this.Chart.dayInPixels;if(this.childTask.length>0)
{this.minWidthResize=childParentPosX-posTaskItem;}
if((this.childPredTask.length>0)&&(!this.parentTask))
{this.maxWidthResize=childPredPosX-posTaskItem;}else if((this.childPredTask.length>0)&&(this.parentTask))
{var w1=posParentTaskItem+widthParentTaskItem-posTaskItem;var w2=childPredPosX-posTaskItem;this.maxWidthResize=Math.min(w1,w2);}else if((this.childPredTask.length==0)&&(this.parentTask))
{this.maxWidthResize=posParentTaskItem+widthParentTaskItem-posTaskItem;}};GanttTask.prototype.createTaskItem=function()
{var self=this;this.posX=this.Chart.getPosOnDate(this.TaskInfo.EST);var itemControl=document.createElement("div");itemControl.id=this.TaskInfo.Id;itemControl.style.cssText=";z-index:1;position:absolute;left:"+this.posX+"px;top:"+this.posY+"px;";var divTaskItem=document.createElement("div");itemControl.appendChild(divTaskItem);divTaskItem.style.cssText="z-index:1;position: absolute;left:0px;top:0px;";var tblTaskItem=document.createElement("table");divTaskItem.appendChild(tblTaskItem);tblTaskItem.cellPadding="0";tblTaskItem.cellSpacing="0";tblTaskItem.width=this.TaskInfo.Duration*this.Chart.hourInPixelsWork+"px";tblTaskItem.style.cssText="border: solid 1px #6589A9;";var rowTblTask=tblTaskItem.insertRow(tblTaskItem.rows.length);if(this.TaskInfo.PercentCompleted!=0)
{var cellTblTask=document.createElement("td");rowTblTask.appendChild(cellTblTask);cellTblTask.height=this.Chart.heightTaskItem+"px";cellTblTask.width=this.TaskInfo.PercentCompleted+"%";cellTblTask.style.lineHeight="1px";var imgPr=document.createElement("img");imgPr.style.width=(this.TaskInfo.PercentCompleted*this.TaskInfo.Duration*this.Chart.hourInPixelsWork)/100+"px";imgPr.style.height=this.Chart.heightTaskItem+"px";cellTblTask.appendChild(imgPr);imgPr.src=this.Chart.imgs+"progress_filled.png";}
if(this.TaskInfo.PercentCompleted!=100)
{var cellTblTask=document.createElement("td");rowTblTask.appendChild(cellTblTask);cellTblTask.height=this.Chart.heightTaskItem+"px";cellTblTask.width=(100-this.TaskInfo.PercentCompleted)+"%";cellTblTask.style.lineHeight="1px";var imgPrF=document.createElement("img");imgPrF.style.width=((100-this.TaskInfo.PercentCompleted)*this.TaskInfo.Duration*this.Chart.hourInPixelsWork)/100+"px";imgPrF.style.height=this.Chart.heightTaskItem+"px";cellTblTask.appendChild(imgPrF);imgPrF.src=this.Chart.imgs+"progress_bg.png";}
if(this.Chart.isEditable)
{var divTaskInfo=document.createElement("div");divTaskInfo.style.cssText="text-align:center;font-size:9px;z-index:2;position: absolute;left:0px;top:0px;";var tblTaskInfo=document.createElement("table");divTaskInfo.appendChild(tblTaskInfo);tblTaskInfo.cellPadding="0";tblTaskInfo.cellSpacing="0";tblTaskInfo.height=this.Chart.heightTaskItem+"px";tblTaskInfo.width=this.TaskInfo.Duration*this.Chart.hourInPixelsWork+"px";var rowTaskInfo=tblTaskInfo.insertRow(0);var cellTaskInfo=document.createElement("TD");cellTaskInfo.align="center";cellTaskInfo.vAlign="top";cellTaskInfo.height=this.Chart.heightTaskItem+"px";cellTaskInfo.className="moveInfo";cellTaskInfo.style.cssText=";white-space:nowrap;font-size:9px";rowTaskInfo.appendChild(cellTaskInfo);itemControl.appendChild(divTaskInfo);}
var divTaskName=document.createElement("div");itemControl.appendChild(divTaskName);divTaskName.style.cssText=";z-index:2;position: absolute;left:0px;top:0px;";var divMove=document.createElement("div");divMove.innerHTML="<input type='text' style='visibility:hidden;width:1px;height:1px;'/>";if(this.Chart._isIE)
{divMove.style.background="#000000";divMove.style.filter="alpha(opacity=0)";}
divMove.style.height=this.Chart.heightTaskItem+"px";divMove.style.width=this.TaskInfo.Duration*this.Chart.hourInPixelsWork+"px";divTaskName.appendChild(divMove);if(this.Chart._showTooltip)
{var getPopUpInfo=function(e){if((!self.Chart._isMove)&&(!self.Chart._isResize))self.getPopUpInfo(self.cTaskItem[0],e);};var closePopUpInfo=function(){self.closePopUpInfo();};this.addEvent(divMove,'mouseover',getPopUpInfo,false);this.addEvent(divMove,'mouseout',closePopUpInfo,false);}
var taskClick=function(){self.Chart.callEvent("onTaskClick",[self]);};this.addEvent(divMove,'click',taskClick,false);if(this.Chart.isEditable)
{var divResize=document.createElement("div");divResize.style.cssText=";z-index:10;position: absolute;left:"+(this.TaskInfo.Duration*this.Chart.hourInPixelsWork-10)+"px;top:0px;";divResize.style.height=this.Chart.heightTaskItem+"px";divResize.style.width="10px";divResize.innerHTML="<input type='text' style='visibility:hidden;width:1px;height:1px;'/>";divTaskName.appendChild(divResize);var startMove=function(e){if(self.Chart.callEvent("onTaskStartDrag",[self])===false)return;var moveItem=function(e1){if(self.checkMove)self.moveItem(e1);};var endMove=function(){if(self.checkMove){self.endMove();self.Chart._isMove=false;if(self.Chart._isIE)
{document.body.releaseCapture();document.detachEvent("onmousemove",moveItem);document.detachEvent("onmouseup",endMove);}else{document.removeEventListener("mousemove",moveItem,true);document.removeEventListener("mouseup",endMove,true);}
if(self.wasMoved)self.Chart.callEvent("onTaskEndDrag",[self]);}};self.addEvent(document,'mousemove',moveItem,true);self.addEvent(document,'mouseup',endMove,true);if(self.Chart._showTooltip)self.closePopUpInfo();self.startMove(e);self.Chart._isMove=true;if(self.Chart._isIE)document.body.setCapture(false);};var startResize=function(e){if(self.Chart.callEvent("onTaskStartResize",[self])===false)return;var resizeItem=function(e1){if(self.checkResize)self.resizeItem(e1);};var endResizeItem=function(){if(self.checkResize){self.endResizeItem();self.Chart._isResize=false;if(self.Chart._isIE)
{document.body.releaseCapture();document.detachEvent("onmousemove",resizeItem);document.detachEvent("onmouseup",endResizeItem);}else{document.removeEventListener("mousemove",resizeItem,true);document.removeEventListener("mouseup",endResizeItem,true);}
if(self.wasResized)self.Chart.callEvent("onTaskEndResize",[self]);}};self.addEvent(document,'mousemove',resizeItem,false);self.addEvent(document,'mouseup',endResizeItem,false);self.startResize(e);if(self.Chart._isIE)document.body.setCapture(false);self.Chart._isResize=true;};this.addEvent(divMove,'mousedown',startMove,false);this.addEvent(divResize,'mousedown',startResize,false);var setCursorResize=function(e2){if(!self.Chart._isMove)(e2.srcElement?e2.srcElement:e2.target).style.cursor="e-resize";};var setCursorStandart=function(e3){if(!self.checkResize)(e3.srcElement?e3.srcElement:e3.target).style.cursor="";};this.addEvent(divResize,'mouseover',setCursorResize,false);this.addEvent(divResize,'mouseout',setCursorStandart,false);}
return itemControl;};GanttTask.prototype.createTaskNameItem=function(hasChildren)
{var self=this;var divName=document.createElement("div");divName.id=this.TaskInfo.Id;divName.style.cssText="cursor:pointer;white-space:nowrap;height:15px;z-index:1;position:absolute;left:20px;top: "+this.posY+"px;";if(hasChildren)divName.style.fontWeight="bold";divName.className="taskNameItem";divName.title=this.TaskInfo.Name;divName.innerHTML=this.TaskInfo.Name;if(this.Chart.isShowConMenu)
{var showContMenu=function(event){if(self.Chart.contextMenu.clear)self.Chart.contextMenu.clear();var hideContMenu=function(){self.Chart.contextMenu.hideContextMenu();if(self.Chart._isIE)
self.Chart.content.detachEvent("mousedown",hideContMenu);else
self.Chart.content.removeEventListener("mousedown",hideContMenu,false);};self.Chart.content.onmousedown=hideContMenu;if(!self.Chart._isIE)
{event.stopPropagation();}else
{event.cancelBubble=true;}
self.Chart._showContextMenu(event,self);};if(this.Chart._isIE)
{this.addEvent(divName,"contextmenu",function(e){showContMenu(e);return false;},false);}else
{this.addEvent(divName,"contextmenu",function(e){e.preventDefault();showContMenu(e);},false);}}
return divName;};GanttTask.prototype.createTaskDescItem=function()
{var posX=(this.posX+this.TaskInfo.Duration*this.Chart.hourInPixelsWork+10);var divDesc=document.createElement("div");divDesc.style.cssText+=";z-index:1;position:absolute;left:"+posX+"px;top:"+this.posY+"px;";divDesc.innerHTML=this.getDescStr();divDesc.className="descTask";this.descrTask=divDesc;if(this.Chart._showTooltip)
{var self=this;var getPopUpInfo=function(e){if((!self.Chart._isMove)&&(!self.Chart._isResize))self.getPopUpInfo(self.descrTask,e);};var closePopUpInfo=function(){self.closePopUpInfo();};this.addEvent(divDesc,'mouseover',getPopUpInfo,false);this.addEvent(divDesc,'mouseout',closePopUpInfo,false);}
return divDesc;};GanttTask.prototype.checkWidthTaskNameItem=function()
{if(this.cTaskNameItem[0].offsetWidth+this.cTaskNameItem[0].offsetLeft>this.Chart.maxWidthPanelNames)
{var width=this.cTaskNameItem[0].offsetWidth+this.cTaskNameItem[0].offsetLeft-this.Chart.maxWidthPanelNames;var countChar=Math.round(width/(this.cTaskNameItem[0].offsetWidth/this.cTaskNameItem[0].firstChild.length));var tName=this.TaskInfo.Name.substring(0,this.cTaskNameItem[0].firstChild.length-countChar-3);tName+="...";this.cTaskNameItem[0].innerHTML=tName;}};GanttTask.prototype.create=function()
{var containerTasks=this.Chart.oData.firstChild;var containerNames=null;if(this.Chart._showTreePanel)containerNames=this.Chart.panelNames.firstChild;var predecessorTask=this.TaskInfo.PredecessorTask;var parentTask=this.TaskInfo.ParentTask;var isCParentTask=(this.TaskInfo.ChildTasks.length>0);var self=this;this.cTaskItem=[];this.cTaskNameItem=[];if(!parentTask)
{if(this.TaskInfo.previousParentTask){this.previousParentTask=this.Project.getTaskById(this.TaskInfo.previousParentTask.Id);var lastChildTask=this.Chart.getLastChildTask(this.previousParentTask);this.posY=parseInt(lastChildTask.cTaskItem[0].style.top)+this.Chart.heightTaskItem+11;this.previousParentTask.nextParentTask=this;}else{this.posY=parseInt(this.Project.projectItem[0].style.top)+this.Chart.heightTaskItem+11;}}
if(parentTask){var task=this.Project.getTaskById(this.TaskInfo.ParentTask.Id);this.parentTask=task;if(this.TaskInfo.previousChildTask){this.previousChildTask=this.Project.getTaskById(this.TaskInfo.previousChildTask.Id);var lastChildTask=this.Chart.getLastChildTask(this.previousChildTask);this.posY=parseInt(lastChildTask.cTaskItem[0].style.top)+this.Chart.heightTaskItem+11;this.previousChildTask.nextChildTask=this;}else{this.posY=parseInt(task.cTaskItem[0].style.top)+this.Chart.heightTaskItem+11;}
task.childTask.push(this);}
if(predecessorTask){var task=this.Project.getTaskById(predecessorTask.Id);this.predTask=task;task.childPredTask.push(this);}
this.cTaskItem.push(this.createTaskItem());containerTasks.appendChild(this.cTaskItem[0]);if(this.Chart.panelNames){this.cTaskNameItem.push(this.createTaskNameItem(isCParentTask));this.Chart.panelNames.firstChild.appendChild(this.cTaskNameItem[0]);}
if(this.Chart.isShowDescTask){containerTasks.appendChild(this.createTaskDescItem());}
var arrConnectingLines=[];if(predecessorTask)arrConnectingLines=this.createConnectingLinesDS();this.cTaskItem.push(arrConnectingLines);if(this.Chart.panelNames)
{var arrConnectingLinesNames=[];if(parentTask)
{this.cTaskNameItem[0].style.left=parseInt(this.parentTask.cTaskNameItem[0].style.left)+15+"px";arrConnectingLinesNames=this.createConnectingLinesPN();}
this.checkWidthTaskNameItem();var treeImg=null;if(isCParentTask)treeImg=this.createTreeImg();this.cTaskNameItem.push(arrConnectingLinesNames);this.cTaskNameItem.push(treeImg);}
this.addDayInPanelTime();return this;};GanttTask.prototype.createTreeImg=function()
{var self=this;var treeImg=new Image();treeImg.src=this.Chart.imgs+"minus.gif";treeImg.id=this.TaskInfo.Id;treeImg.onclick=function()
{if(self._isOpen)
{this.src=self.Chart.imgs+"plus.gif";self._isOpen=false;self.hideChildTasks(self);self.shiftCurrentTasks(self,-self._heightHideTasks);}
else
{this.src=self.Chart.imgs+"minus.gif";self._isOpen=true;self.shiftCurrentTasks(self,self._heightHideTasks);self.showChildTasks(self,true);self._heightHideTasks=0;}};this.Chart.panelNames.firstChild.appendChild(treeImg);treeImg.style.cssText="cursor:pointer;left:"+(parseInt(this.cTaskNameItem[0].style.left)-12)+"px;top:"+(parseInt(this.cTaskNameItem[0].style.top)+3)+"px;z-index:12;position:absolute;";return treeImg;};GanttChart.prototype.getLastChildTask=function(task)
{if(task.childTask.length>0)
{return this.getLastChildTask(task.childTask[task.childTask.length-1]);}else
{return task;}};dhtmlXMLSenderObject=function(ganttChart)
{this.xmlHttp=this.createXMLHttpRequest();this.isProcessed=false;this.path=null;this.filename=null;this.Chart=ganttChart;};dhtmlXMLSenderObject.prototype.createXMLHttpRequest=function()
{if(window.XMLHttpRequest){return new XMLHttpRequest();}
else if(window.ActiveXObject){return new ActiveXObject("Microsoft.XMLHTTP");}};dhtmlXMLSenderObject.prototype.sendData=function(filename,path,xmlData)
{var self=this;this.path=path;this.filename=filename;if((this.path==null)||(this.path==""))
{this.Chart.Error.throwError("DATA_SEND_ERROR",3,null);return;}
if((this.filename==null)||(this.filename==""))
{this.Chart.Error.throwError("DATA_SEND_ERROR",4,null);return;}
this.isProcessed=true;this.xmlHttp.open("POST",this.path,true);if(this.Chart._isFF)
{this.xmlHttp.onerror=function(){self.xmlHttp.onreadystatechange=null;self.xmlHttp.abort();self.isProcessed=false;}}
this.xmlHttp.onreadystatechange=function(){self.getStatus();};this.xmlHttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");this.xmlHttp.send("data="+encodeURI(xmlData)+"&filename="+filename);};dhtmlXMLSenderObject.prototype.getStatus=function()
{if(this.xmlHttp.readyState==4)
{var _status="";try{_status=this.xmlHttp.status;}catch(e){this.Chart.Error.throwError("DATA_SEND_ERROR",1,null);return 0;}
switch(_status){case 0:this.Chart.Error.throwError("DATA_SEND_ERROR",1,null);break;case 404:this.Chart.Error.throwError("DATA_SEND_ERROR",5,[this.path]);break;case 500:this.Chart.Error.throwError("DATA_SEND_ERROR",2,null);break;case 12029:this.Chart.Error.throwError("DATA_SEND_ERROR",1,null);break;default:if(!(_status>=200&&_status<300||_status==304))
{this.Chart.Error.throwError("DATA_SEND_ERROR",0,null);}
break;}
this.isProcessed=false;}};function GanttError(){this.catches=[];this._errors=[];this._init();return this;}
GanttError.prototype._init=function()
{this._errors[0]="Connection error";this._errors[1]="Cannot connect";this._errors[2]="Server error";this._errors[3]="Path is null or empty";this._errors[4]="Filename is null or empty";this._errors[5]="File (%0) is not found";this._errors[6]="Percent Complete  should be a number";this._errors[7]="Percent Complete should be <= 100";this._errors[8]="Percent Complete should be >= 0";this._errors[9]="Increase duration of task(%0)";this._errors[10]="Reduce duration of task(%0)";this._errors[11]="Increase  EST of child task (%0)";this._errors[12]="Reduce EST of task (%0)";this._errors[13]="The project (%0) is added";this._errors[14]="Start Date of the project < start Date of the control";this._errors[15]="Task (%0) cannot be the child of predecessor task(%1)";this._errors[16]="Time of the termination of predecessor task(%0) > EST of child task(%1)";this._errors[17]="The Predecessor (%0) task  does not exist";this._errors[18]="The EST of task (%0) < start date of the control";this._errors[19]="Time of the termination of parent task (%0) < time of the termination of child task(%1)";this._errors[20]="The EST of task (%0) < EST of parent task(%1)";this._errors[21]="The parent task (%0) does not exist";this._errors[22]="The task (%0) is added";this._errors[23]="The project (%0) is added";this._errors[24]="Task (%0) EST < project (%1) startDate";this._errors[25]="Parent task (%0) EST cannot be null";this._errors[26]="Predecessor task (%0) position error. Reduce duration of predecessor task (%0) or increase EST of child task (%1)";this._errors[27]="Predecessor task (%0) does not exist";this._errors[28]="Increase duration of parent task (%0) or reduce EST of child task (%1) or reduce duration of child task(%1)";this._errors[29]="Reduce EST of parent task (%0) or increase  EST of child task (%1)";this._errors[30]="The  task(%0) does not exist";this._errors[31]="The project(%0) does not exist";this._errors[32]="Predecessor task(%0) and child task(%1) should have the same parent";this._errors[33]="Reduce EST of parent task (%0) or increase  EST of child task (%1)";this._errors[34]="EST of task(%0) < start date of the project(%1)";this._errors[35]="Percent Complete should be <= 100 and >= 0";this._errors[36]="You may not connect a task to itself.";this._errors[37]="Cannot parse this XML string.";};GanttError.prototype.catchError=function(type,handler){this.catches[type]=handler;};GanttError.prototype.getErrorString=function(str,params)
{if(!params){return str;}else{for(var i=0;i<params.length;i++){var re=new RegExp("%"+i,"gi");str=str.replace(re,params[i]);}
return str;}};GanttError.prototype.throwError=function(type,description,params){if(this.catches[type])
{var index=parseInt(description);var errorStr=this.getErrorString(this._errors[index],params);return this.catches[type](type,errorStr,params);}
return null;};function contextMenu(chart)
{this.Chart=chart;this.TabContainer=null;this.MenuPanel=null;this.tabPanel=null;this.arrTabs=[];this.isShow=false;this.hideDiv=null;this._init();}
contextMenu.prototype._init=function()
{this.createMenuPanel();this.createHideDiv();this.createTabContainer();this.createTabPanel();var self=this;var arrItems=[];var tab1=this.createTab(1,"Rename task","t",true,this);tab1.addItem(1,"New name",document.createElement("input"),"text",function(){tab1.arrItems[0].control.focus();});tab1.addItem(2,"Rename",document.createElement("input"),"button",function(){var name=tab1.arrItems[0].control.value;try{tab1.object.setName(name);tab1.hide();}catch(e){}});var tab2=this.createTab(2,"Delete task","t",true,this);tab2.addItem(1,"Delete",document.createElement("input"),"button",function()
{try{tab2.object.Project.deleteTask(tab2.object.TaskInfo.Id);tab2.hide();}
catch(e){}});var tab3=this.createTab(3,"Set EST","t",true,this);tab3.addItem(1,"EST",document.createElement("input"),"text",function(){tab3.arrItems[0].control.focus();});tab3.addItem(2,"Move children",document.createElement("input"),"checkbox",function(){tab3.arrItems[1].control.focus();});tab3.addItem(3,"Update",document.createElement("input"),"button",function(){var isMoveChild=tab3.arrItems[1].control.checked;var arr=tab3.arrItems[0].control.value.split(".");var est=(arr.length<3)?null:(new Date(arr[2],parseInt(arr[1])-1,arr[0]));try{if(tab3.object.setEST(est,isMoveChild))tab3.hide();}catch(e){}});var tab4=this.createTab(4,"Set duration","t",true,this);tab4.addItem(1,"Duration",document.createElement("input"),"text",function(){tab4.arrItems[0].control.focus();});tab4.addItem(2,"Update",document.createElement("input"),"button",function(){var d=tab4.arrItems[0].control.value;try{if(tab4.object.setDuration(d))tab4.hide();}catch(e){}});var tab5=this.createTab(5,"Set % complete","t",true,this);tab5.addItem(1,"Percent Complete",document.createElement("input"),"text",function(){tab5.arrItems[0].control.focus();});tab5.addItem(2,"Update",document.createElement("input"),"button",function(){var p=tab5.arrItems[0].control.value;try{if(tab5.object.setPercentCompleted(p))tab5.hide();}catch(e){}});var tab13=this.createTab(13,"Set predecessor","t",true,this);tab13.addItem(1,"Predecessor",document.createElement("input"),"text",function(){tab13.arrItems[0].control.focus();});tab13.addItem(2,"Update",document.createElement("input"),"button",function(){var p=tab13.arrItems[0].control.value;try{if(tab13.object.setPredecessor(p))tab13.hide();}catch(e){}});var tab6=this.createTab(6,"Rename project","p",true,this);tab6.addItem(1,"New name",document.createElement("input"),"text",function(){tab6.arrItems[0].control.focus();});tab6.addItem(2,"Rename",document.createElement("input"),"button",function(){var name=tab6.arrItems[0].control.value;try{tab6.object.setName(name);tab6.hide();}catch(e){}});var tab7=this.createTab(7,"Delete project","p",true,this);tab7.addItem(1,"Delete",document.createElement("input"),"button",function(){try{tab7.object.Chart.deleteProject(tab7.object.Project.Id);tab7.hide();}catch(e){}});var tab8=this.createTab(8,"Set % complete","p",true,this);tab8.addItem(1,"Percent Complete",document.createElement("input"),"text",function(){tab8.arrItems[0].control.focus();});tab8.addItem(2,"Update",document.createElement("input"),"button",function(){var p=tab8.arrItems[0].control.value;try{if(tab8.object.setPercentCompleted(p))tab8.hide();}catch(e){}});var tab9=this.createTab(9,"Add new task","p",true,this);tab9.addItem(1,"Id",document.createElement("input"),"text",function(){tab9.arrItems[0].control.focus();});tab9.addItem(2,"Name",document.createElement("input"),"text",function(){tab9.arrItems[1].control.focus();});tab9.addItem(3,"EST",document.createElement("input"),"text",function(){tab9.arrItems[2].control.focus();});tab9.addItem(4,"Duration",document.createElement("input"),"text",function(){tab9.arrItems[3].control.focus();});tab9.addItem(5,"Percent complete",document.createElement("input"),"text",function(){tab9.arrItems[4].control.focus();});tab9.addItem(6,"Parent task id",document.createElement("input"),"text",function(){tab9.arrItems[5].control.focus();});tab9.addItem(7,"Pred task id",document.createElement("input"),"text",function(){tab9.arrItems[6].control.focus();});tab9.addItem(9,"Insert",document.createElement("input"),"button",function(){try{var id=tab9.arrItems[0].control.value;var name=tab9.arrItems[1].control.value;var arr=tab9.arrItems[2].control.value.split(".");var est=(arr.length<3)?null:(new Date(arr[2],parseInt(arr[1])-1,arr[0]));var duration=tab9.arrItems[3].control.value;var pc=tab9.arrItems[4].control.value;var parentTaskId=tab9.arrItems[5].control.value;var predTaskId=tab9.arrItems[6].control.value;if(tab9.object.insertTask(id,name,est,duration,pc,predTaskId,parentTaskId))tab9.hide();}catch(e){}});var tab11=this.createTab(11,"Add successor task","t",true,this);tab11.addItem(1,"Id",document.createElement("input"),"text",function(){tab11.arrItems[0].control.focus();});tab11.addItem(2,"Name",document.createElement("input"),"text",function(){tab11.arrItems[1].control.focus();});tab11.addItem(3,"EST",document.createElement("input"),"text",function(){tab11.arrItems[2].control.focus();});tab11.addItem(4,"Duration",document.createElement("input"),"text",function(){tab11.arrItems[3].control.focus();});tab11.addItem(5,"Percent complete",document.createElement("input"),"text",function(){tab11.arrItems[4].control.focus();});tab11.addItem(6,"Insert",document.createElement("input"),"button",function(){try{var pr=tab11.object.Project;var id=tab11.arrItems[0].control.value;var name=tab11.arrItems[1].control.value;var arr=tab11.arrItems[2].control.value.split(".");var est=(arr.length<3)?null:(new Date(arr[2],parseInt(arr[1])-1,arr[0]));var duration=tab11.arrItems[3].control.value;var pc=tab11.arrItems[4].control.value;var parentTaskId=(tab11.object.parentTask==null)?"":tab11.object.parentTask.TaskInfo.Id;var predTaskId=tab11.object.TaskInfo.Id;if(pr.insertTask(id,name,est,duration,pc,predTaskId,parentTaskId))tab11.hide();}catch(e){}});var tab10=this.createTab(10,"Add child task","t",true,this);tab10.addItem(1,"Id",document.createElement("input"),"text",function(){tab10.arrItems[0].control.focus();});tab10.addItem(2,"Name",document.createElement("input"),"text",function(){tab10.arrItems[1].control.focus();});tab10.addItem(3,"EST",document.createElement("input"),"text",function(){tab10.arrItems[2].control.focus();});tab10.addItem(4,"Duration",document.createElement("input"),"text",function(){tab10.arrItems[3].control.focus();});tab10.addItem(5,"Percent complete",document.createElement("input"),"text",function(){tab10.arrItems[4].control.focus();});tab10.addItem(6,"Insert",document.createElement("input"),"button",function(){try{var pr=tab10.object.Project;var id=tab10.arrItems[0].control.value;var name=tab10.arrItems[1].control.value;var arr=tab10.arrItems[2].control.value.split(".");var est=(arr.length<3)?null:(new Date(arr[2],parseInt(arr[1])-1,arr[0]));var duration=tab10.arrItems[3].control.value;var pc=tab10.arrItems[4].control.value;var parentTaskId=tab10.object.TaskInfo.Id;var predTaskId="";if(pr.insertTask(id,name,est,duration,pc,predTaskId,parentTaskId))tab10.hide();}catch(e){}});var tab12=this.createTab(12,"-Insert new project-","p",false,this);tab12.addItem(1,"Id",document.createElement("input"),"text",function(){tab12.arrItems[0].control.focus();});tab12.addItem(2,"Name",document.createElement("input"),"text",function(){tab12.arrItems[1].control.focus();});tab12.addItem(3,"Start date",document.createElement("input"),"text",function(){tab12.arrItems[2].control.focus();});tab12.addItem(4,"Insert",document.createElement("input"),"button",function(){try{var id=tab12.arrItems[0].control.value;var namePr=tab12.arrItems[1].control.value;var arr=tab12.arrItems[2].control.value.split(".");var startDatePr=(arr.length<3)?null:(new Date(arr[2],parseInt(arr[1])-1,arr[0]));if(self.Chart.insertProject(id,namePr,startDatePr))tab12.hide();}catch(e){}});};contextMenu.prototype.createHideDiv=function()
{this.hideDiv=document.createElement("div");this.hideDiv.style.position="absolute";this.hideDiv.style.left="0px";this.hideDiv.style.top="0px";this.Chart.content.appendChild(this.hideDiv);this.hideDiv.style.zIndex=12;this.hideDiv.style.display="none";this.hideDiv.style.background="#7D7E7D";this.hideDiv.style.cssText+=";-moz-opacity: 0.5;filter: alpha(opacity=50);opacity:.50;";this.hideDiv.style.width=this.Chart.content.offsetWidth+2+"px";this.hideDiv.style.height=this.Chart.content.offsetHeight+2+"px";};contextMenu.prototype.createMenuPanel=function()
{this.MenuPanel=document.createElement("div");this.MenuPanel.style.visibility="hidden";this.MenuPanel.style.cssText+=";z-index:10;";this.MenuPanel.style.position="absolute";this.Chart.content.appendChild(this.MenuPanel);this.MenuPanel.innerHTML="<table></table>";this.MenuPanel.firstChild.className="contextMenu";this.MenuPanel.firstChild.cellPadding=0;this.MenuPanel.firstChild.cellSpacing=0;this.MenuPanel.firstChild.style.cssText+=";background:url("+this.Chart.imgs+"menu/menu_bg.png);";};contextMenu.prototype.createTabPanel=function()
{this.tabPanel=document.createElement("div");this.tabPanel.style.visibility="hidden";this.tabPanel.style.zIndex="30";this.TabContainer.firstChild.rows[0].cells[0].appendChild(this.tabPanel);this.tabPanel.style.width="385px";this.tabPanel.style.height="290px";this.tabPanel.innerHTML="<table><tr><td></td></tr><tr><td></td></tr></table>";this.tabPanel.firstChild.cellPadding=0;this.tabPanel.firstChild.cellSpacing=0;this.tabPanel.firstChild.style.cssText="width:385px;border: 1px solid #808080;";this.tabPanel.firstChild.rows[0].cells[0].style.cssText=";height:26px;background:url("+this.Chart.imgs+"/menu/window_tr.png);background-repeat: no-repeat;color:#fff;font-size:14px;font-weight: bold;font-family: Tahoma, Arial";this.tabPanel.firstChild.rows[0].cells[0].align="center";this.tabPanel.firstChild.rows[1].cells[0].style.cssText=";height:270px;background:#F7F7F7;";this.tabPanel.firstChild.rows[1].cells[0].innerHTML="<table></table>";this.tabPanel.firstChild.rows[1].cells[0].firstChild.style.cssText="width:250px;font-size:11px;font-family:Tahoma,Arial;";this.tabPanel.firstChild.rows[1].cells[0].align="center";};contextMenu.prototype.addItemMenuPanel=function(tab)
{var self=this;var row=this.MenuPanel.firstChild.insertRow(this.MenuPanel.firstChild.rows.length);var cell=document.createElement('td');cell.innerHTML=tab.Description;cell.style.cssText="padding-left:10px;height:18px;";this.addEvent(cell,"mousedown",function(){tab.show();},false);cell.onmouseover=function(){this.style.background="url("+self.Chart.imgs+"menu/menu_selection.png)";};cell.onmouseout=function(){this.style.background="";};row.appendChild(cell);};contextMenu.prototype.showContextMenu=function(x,y,object)
{if(object.constructor==GanttTask)
{for(var i=0;i<this.arrTabs.length;i++){if(this.arrTabs[i].type=="t")
{this.arrTabs[i].object=object;this.addItemMenuPanel(this.arrTabs[i]);}}}else if(object.constructor==GanttProject)
{for(var i=0;i<this.arrTabs.length;i++){if(this.arrTabs[i].type=="p")
{this.arrTabs[i].object=object;this.addItemMenuPanel(this.arrTabs[i]);}}}
this.isShow=true;this.MenuPanel.style.cssText+=";z-index:15;";this.MenuPanel.style.visibility="visible";this.MenuPanel.style.top=parseInt(y)+this.Chart.heightTaskItem-this.Chart.oData.scrollTop+5+"px";this.MenuPanel.style.left=x;};contextMenu.prototype.hideContextMenu=function()
{this.isShow=false;this.MenuPanel.style.visibility="hidden";};contextMenu.prototype.clear=function()
{this.MenuPanel.removeChild(this.MenuPanel.firstChild);this.MenuPanel.innerHTML="<table></table>";this.MenuPanel.firstChild.className="contextMenu";this.MenuPanel.firstChild.cellPadding=0;this.MenuPanel.firstChild.cellSpacing=0;this.MenuPanel.firstChild.style.cssText+=";background:url("+this.Chart.imgs+"menu/menu_bg.png);";};contextMenu.prototype.createTab=function(id,desc,type,showOInfo,menu)
{var tab=new contextMenuTab(id,desc,type,showOInfo,menu);this.arrTabs.push(tab);return tab;};contextMenu.prototype.createTabContainer=function()
{this.TabContainer=document.createElement("div");this.TabContainer.style.position="absolute";this.TabContainer.style.top="0px";this.TabContainer.style.left="0px";this.TabContainer.style.visibility="hidden";this.TabContainer.style.zIndex="50";this.Chart.content.appendChild(this.TabContainer);this.TabContainer.innerHTML="<table><tr><td></td></tr></table>";this.TabContainer.firstChild.style.cssText=";width:100%;height:100%;";this.TabContainer.firstChild.rows[0].cells[0].align="center";this.TabContainer.style.width=this.Chart.content.offsetWidth+2+"px";this.TabContainer.style.height=this.Chart.content.offsetHeight+2+"px";};contextMenu.prototype.getTabById=function(id)
{for(var i=0;i<this.arrTabs.length;i++){if(this.arrTabs[i].Id==id){return this.arrTabs[i];}}
return null;};function contextMenuTab(id,description,type,showOInfo,contextMenu)
{this.Id=id;this.arrItems=[];this.TabItemContainer=null;this.Description=description;this.contextMenu=contextMenu;this.type=type;this.object=null;this.showObjectInfo=showOInfo;}
contextMenu.prototype.addEvent=function(elm,evType,fn,useCapture)
{if(elm.addEventListener){elm.addEventListener(evType,fn,useCapture);return true;}
else if(elm.attachEvent){return elm.attachEvent('on'+evType,fn);}
else{elm['on'+evType]=fn;}};contextMenuTab.prototype.addItem=function(id,name,control,type,handler)
{if(handler){control.onclick=handler;}
control.type=type;if(type=="button")
{control.value=name;}
var tabItem=new contextMenuTabItem(id,name,control,this);this.arrItems.push(tabItem);};contextMenuTab.prototype.show=function()
{this.contextMenu.hideDiv.style.display="inline";this.contextMenu.TabContainer.style.visibility="visible";var self=this;this.contextMenu.tabPanel.firstChild.rows[0].cells[0].innerHTML=this.Description;this.contextMenu.tabPanel.style.visibility="visible";var t=this.contextMenu.tabPanel.firstChild.rows[1].cells[0].firstChild;var c,c2,r=null;if(this.showObjectInfo)
{if(this.object){if(this.object.constructor==GanttTask){this.insertData(t,"Id",this.object.TaskInfo.Id);this.insertData(t,"Name",this.object.TaskInfo.Name);this.insertData(t,"Duration",this.object.TaskInfo.Duration+" hrs");this.insertData(t,"Percent complete",this.object.TaskInfo.PercentCompleted+"%");this.insertData(t,"EST",this.object.TaskInfo.EST.getDate()+"."+(this.object.TaskInfo.EST.getMonth()+1)+"."+this.object.TaskInfo.EST.getFullYear());this.insertData(t,"Predecessor",this.object.TaskInfo.PredecessorTaskId);}else
{this.insertData(t,"Id",this.object.Project.Id);this.insertData(t,"Name",this.object.Project.Name);this.insertData(t,"Start date",this.object.Project.StartDate.getDate()+"."+(this.object.Project.StartDate.getMonth()+1)+"."+this.object.Project.StartDate.getFullYear());}}}
var btnCell=null;for(var i=0;i<this.arrItems.length;i++){if(this.arrItems[i].control.type=="button")
{r=t.insertRow(t.rows.length);c=r.insertCell(r.cells.length);btnCell=r.insertCell(r.cells.length);btnCell.appendChild(this.arrItems[i].control);}else
{r=t.insertRow(t.rows.length);c=r.insertCell(r.cells.length);c2=r.insertCell(r.cells.length);c.innerHTML=this.arrItems[i].Name;c2.appendChild(this.arrItems[i].control);}}
var b=document.createElement("input");b.type="button";b.value="Cancel";b.onclick=function()
{self.hide();};if(!btnCell){r=t.insertRow(t.rows.length);c=r.insertCell(r.cells.length);btnCell=r.insertCell(r.cells.length);}else{b.style.marginLeft="10px";}
btnCell.appendChild(b);};contextMenuTab.prototype.hide=function()
{this.contextMenu.tabPanel.style.visibility="hidden";var t=this.contextMenu.tabPanel.firstChild.rows[1].cells[0].firstChild;t.parentNode.removeChild(t);this.contextMenu.tabPanel.firstChild.rows[1].cells[0].innerHTML="<table></table>";this.contextMenu.tabPanel.firstChild.rows[1].cells[0].firstChild.style.cssText="width:250px;font-size:11px;font-family:Tahoma,Arial;";this.contextMenu.hideDiv.style.display="none";this.contextMenu.TabContainer.style.visibility="hidden";};contextMenuTab.prototype.insertData=function(t,name,value)
{var c,c2,r=null;r=t.insertRow(t.rows.length);c=r.insertCell(r.cells.length);c.style.cssText="width:100px";c.innerHTML=name;c2=r.insertCell(r.cells.length);c2.innerHTML=value;};contextMenuTab.prototype.insertControl=function(t,name,value)
{var c,c2,r=null;r=t.insertRow(t.rows.length);c=r.insertCell(r.cells.length);c.innerHTML=name;c2=r.insertCell(r.cells.length);c2.appendChild(value);};function contextMenuTabItem(id,name,control,tab)
{this.Id=id;this.Name=name;this.control=control;this.tab=tab;};openerp.web_gantt=function(instance){var _t=instance.web._t,_lt=instance.web._lt;var QWeb=instance.web.qweb;instance.web.views.add('gantt','instance.web_gantt.GanttView');instance.web_gantt.GanttView=instance.web.View.extend({display_name:_lt('Gantt'),template:"GanttView",view_type:"gantt",init:function(){var self=this;this._super.apply(this,arguments);this.has_been_loaded=$.Deferred();this.chart_id=_.uniqueId();},view_loading:function(r){return this.load_gantt(r);},load_gantt:function(fields_view_get,fields_get){var self=this;this.fields_view=fields_view_get;this.$el.addClass(this.fields_view.arch.attrs['class']);return new instance.web.Model(this.dataset.model).call('fields_get').then(function(fields){self.fields=fields;self.has_been_loaded.resolve();});},do_search:function(domains,contexts,group_bys){var self=this;self.last_domains=domains;self.last_contexts=contexts;self.last_group_bys=group_bys;var n_group_bys=[];if(this.fields_view.arch.attrs.default_group_by){n_group_bys=this.fields_view.arch.attrs.default_group_by.split(',');}
if(group_bys.length){n_group_bys=group_bys;}
var fields=_.compact(_.map(["date_start","date_delay","date_stop"],function(key){return self.fields_view.arch.attrs[key]||'';}));fields=_.uniq(fields.concat(n_group_bys));return $.when(this.has_been_loaded).then(function(){return self.dataset.read_slice(fields,{domain:domains,context:contexts}).then(function(data){return self.on_data_loaded(data,n_group_bys);});});},reload:function(){if(this.last_domains!==undefined)
return this.do_search(this.last_domains,this.last_contexts,this.last_group_bys);},on_data_loaded:function(tasks,group_bys){var self=this;var ids=_.pluck(tasks,"id");return this.dataset.name_get(ids).then(function(names){var ntasks=_.map(tasks,function(task){return _.extend({__name:_.detect(names,function(name){return name[0]==task.id;})[1]},task);});return self.on_data_loaded_2(ntasks,group_bys);});},on_data_loaded_2:function(tasks,group_bys){var self=this;$(".oe_gantt",this.$el).html("");if(group_bys.length>0){group_bys=[group_bys[0]];}
if(group_bys.length==0){group_bys=["_pseudo_group_by"];_.each(tasks,function(el){el._pseudo_group_by="Gantt View";});this.fields._pseudo_group_by={type:"string"};}
var split_groups=function(tasks,group_bys){if(group_bys.length===0)
return tasks;var groups=[];_.each(tasks,function(task){var group_name=task[_.first(group_bys)];var group=_.find(groups,function(group){return _.isEqual(group.name,group_name);});if(group===undefined){group={name:group_name,tasks:[],__is_group:true};groups.push(group);}
group.tasks.push(task);});_.each(groups,function(group){group.tasks=split_groups(group.tasks,_.rest(group_bys));});return groups;}
var groups=split_groups(tasks,group_bys);var task_ids={};var generate_task_info=function(task,plevel){var level=plevel||0;if(task.__is_group){var task_infos=_.compact(_.map(task.tasks,function(sub_task){return generate_task_info(sub_task,level+1);}));if(task_infos.length==0)
return;var task_start=_.reduce(_.pluck(task_infos,"task_start"),function(date,memo){return memo===undefined||date<memo?date:memo;},undefined);var task_stop=_.reduce(_.pluck(task_infos,"task_stop"),function(date,memo){return memo===undefined||date>memo?date:memo;},undefined);var duration=(task_stop.getTime()-task_start.getTime())/(1000*60*60);var group_name=instance.web.format_value(task.name,self.fields[group_bys[level]]);if(level==0){var group=new GanttProjectInfo(_.uniqueId("gantt_project_"),group_name,task_start);_.each(task_infos,function(el){group.addTask(el.task_info);});return group;}else{var group=new GanttTaskInfo(_.uniqueId("gantt_project_task_"),group_name,task_start,duration||1,100);_.each(task_infos,function(el){group.addChildTask(el.task_info);});return{task_info:group,task_start:task_start,task_stop:task_stop};}}else{var task_name=task.__name;var task_start=instance.web.auto_str_to_date(task[self.fields_view.arch.attrs.date_start]);if(!task_start)
return;var task_stop;if(self.fields_view.arch.attrs.date_stop){task_stop=instance.web.auto_str_to_date(task[self.fields_view.arch.attrs.date_stop]);if(!task_stop)
return;}else{var tmp=instance.web.format_value(task[self.fields_view.arch.attrs.date_delay],self.fields[self.fields_view.arch.attrs.date_delay]);if(!tmp)
return;task_stop=task_start.clone().addMilliseconds(tmp*60*60*1000);}
var duration=(task_stop.getTime()-task_start.getTime())/(1000*60*60);var id=_.uniqueId("gantt_task_");var task_info=new GanttTaskInfo(id,task_name,task_start,((duration/24)*8)||1,100);task_info.internal_task=task;task_ids[id]=task_info;return{task_info:task_info,task_start:task_start,task_stop:task_stop};}}
var gantt=new GanttChart();_.each(_.compact(_.map(groups,function(e){return generate_task_info(e,0);})),function(project){gantt.addProject(project);});gantt.setEditable(true);gantt.setImagePath("/web_gantt/static/lib/dhtmlxGantt/codebase/imgs/");gantt.attachEvent("onTaskEndDrag",function(task){self.on_task_changed(task);});gantt.attachEvent("onTaskEndResize",function(task){self.on_task_changed(task);});gantt.create(this.chart_id);$(".taskNameItem",self.$el).click(function(event){var task_info=task_ids[event.target.id];if(task_info){self.on_task_display(task_info.internal_task);}});if(this.is_action_enabled('create')){var td=$($("table td",self.$el)[0]);var rendered=QWeb.render("GanttView-create-button");$(rendered).prependTo(td);$(".oe_gantt_button_create",this.$el).click(this.on_task_create);}
this.$el.find(".oe_gantt td:first > div, .oe_gantt td:eq(1) > div > div").css("overflow","");},on_task_changed:function(task_obj){var self=this;var itask=task_obj.TaskInfo.internal_task;var start=task_obj.getEST();var duration=(task_obj.getDuration()/8)*24;var end=start.clone().addMilliseconds(duration*60*60*1000);var data={};data[self.fields_view.arch.attrs.date_start]=instance.web.auto_date_to_str(start,self.fields[self.fields_view.arch.attrs.date_start].type);if(self.fields_view.arch.attrs.date_stop){data[self.fields_view.arch.attrs.date_stop]=instance.web.auto_date_to_str(end,self.fields[self.fields_view.arch.attrs.date_stop].type);}else{data[self.fields_view.arch.attrs.date_delay]=duration;}
this.dataset.write(itask.id,data);},on_task_display:function(task){var self=this;var pop=new instance.web.form.FormOpenPopup(self);pop.on('write_completed',self,self.reload);pop.show_element(self.dataset.model,task.id,null,{});},on_task_create:function(){var self=this;var pop=new instance.web.form.SelectCreatePopup(this);pop.on("elements_selected",self,function(){self.reload();});pop.select_element(self.dataset.model,{initial_view:"form",});},});};